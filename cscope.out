cscope 15 $HOME/test/zach               0002161278
	@benchmark/DB_index.cc

1 
	~"DB_šdex.hh
"

3 vŞ©
mrcu_•och_ty³
 
	gaùive_•och
 = 1;

4 vŞ©
ušt64_t
 
	gglob®•och
 = 1;

5 vŞ©
boŞ
 
	g»cov”šg
 = 
çl£
;

	@benchmark/DB_index.hh

1 #´agm¨
Úû


2 
	~"cÚfig.h
"

3 
	~"comp”.hh
"

5 
	~"Sto.hh
"

7 
	~"mas¡»e.hh
"

8 
	~"kvth»ad.hh
"

9 
	~"mas¡»e_tcursÜ.hh
"

10 
	~"mas¡»e_š£¹.hh
"

11 
	~"mas¡»e_´št.hh
"

12 
	~"mas¡»e_»move.hh
"

13 
	~"mas¡»e_sÿn.hh
"

14 
	~"¡ršg.hh
"

16 
	~<veùÜ
>

17 
	~"V”siÚS–eùÜ.hh
"

19 
Çme¥aû
 
	gb’ch
 {

21 şas 
	cv”siÚ_ad­‹r
 {

22 
	gpublic
:

23 
‹m¶©e
 <
boŞ
 
Ad­tive
>

24 
boŞ
 
£Ëù_fÜ_upd©e
(
T¿nsProxy
& 
™em
, 
TLockV”siÚ
<
Ad­tive
>& 
v”s
) {

25  
	g™em
.
acquœe_wr™e
(
v”s
);

27 
boŞ
 
£Ëù_fÜ_upd©e
(
T¿nsProxy
& 
™em
, 
TV”siÚ
& 
v”s
) {

28 ià(!
	g™em
.
ob£rve
(
v”s
))

29  
	gçl£
;

30 
	g™em
.
add_wr™e
();

31  
	gŒue
;

33 
boŞ
 
£Ëù_fÜ_upd©e
(
T¿nsProxy
& 
™em
, 
TNÚİaqueV”siÚ
& 
v”s
) {

34 ià(!
	g™em
.
ob£rve
(
v”s
))

35  
	gçl£
;

36 
	g™em
.
add_wr™e
();

37  
	gŒue
;

39 
	g‹m¶©e
 <
boŞ
 
	gO·que
>

40 
boŞ
 
£Ëù_fÜ_upd©e
(
T¿nsProxy
& 
™em
, 
TSwissV”siÚ
<
O·que
>& 
v”s
) {

41  
	g™em
.
acquœe_wr™e
(
v”s
);

44 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>

45 
boŞ
 
£Ëù_fÜ_upd©e
(
T¿nsProxy
& 
™em
, 
TicTocV”siÚ
<
O·que
, 
Ex‹nd
>& 
v”s
) {

46 ià(!
	g™em
.
ob£rve
(
v”s
))

47  
	gçl£
;

48 
	g™em
.
acquœe_wr™e
(
v”s
);

49  
	gŒue
;

52 
	g‹m¶©e
 <
boŞ
 
	gAd­tive
, 
ty³Çme
 
	gT
>

53 
boŞ
 
£Ëù_fÜ_ov”wr™e
(
T¿nsProxy
& 
™em
, 
TLockV”siÚ
<
Ad­tive
>& 
v”s
, cÚ¡ 
T
& 
v®
) {

54  
	g™em
.
acquœe_wr™e
(
v”s
, 
v®
);

56 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

57 
boŞ
 
£Ëù_fÜ_ov”wr™e
(
T¿nsProxy
& 
™em
, 
TV”siÚ
& 
v”s
, cÚ¡ 
T
& 
v®
) {

58 ()
	gv”s
;

59 
	g™em
.
add_wr™e
(
v®
);

60  
	gŒue
;

62 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

63 
boŞ
 
£Ëù_fÜ_ov”wr™e
(
T¿nsProxy
& 
™em
, 
TNÚİaqueV”siÚ
& 
v”s
, cÚ¡ 
T
& 
v®
) {

64 ()
	gv”s
;

65 
	g™em
.
add_wr™e
(
v®
);

66  
	gŒue
;

68 
	g‹m¶©e
 <
boŞ
 
	gO·que
, 
ty³Çme
 
	gT
>

69 
boŞ
 
£Ëù_fÜ_ov”wr™e
(
T¿nsProxy
& 
™em
, 
TSwissV”siÚ
<
O·que
>& 
v”s
, cÚ¡ 
T
& 
v®
) {

70  
	g™em
.
acquœe_wr™e
(
v”s
, 
v®
);

72 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
, 
ty³Çme
 
	gT
>

73 
boŞ
 
£Ëù_fÜ_ov”wr™e
(
T¿nsProxy
& 
™em
, 
TicTocV”siÚ
<
O·que
, 
Ex‹nd
>& 
v”s
, cÚ¡ 
T
& 
v®
) {

74  
	g™em
.
acquœe_wr™e
(
v”s
, 
v®
);

78 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

79 
	sg‘_occ_v”siÚ
 {

80 
ty³Çme
 
	t¡d
::
	tcÚd™iÚ®
<
	tDBP¬ams
::
	tO·que
, 
	tTV”siÚ
, 
	tTNÚİaqueV”siÚ
>::
	tty³
ype;

83 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

84 
	sg‘_v”siÚ
 {

85 
ty³Çme
 
	t¡d
::
	tcÚd™iÚ®
<
	tDBP¬ams
::
	tTicToc
, 
	tTicTocV”siÚ
<>,

86 
	tty³Çme
 
	t¡d
::
	tcÚd™iÚ®
<
	tDBP¬ams
::
	tAd­tive
, 
	tTLockV”siÚ
<
	tŒue
 >,

87 
	tty³Çme
 
	t¡d
::
	tcÚd™iÚ®
<
	tDBP¬ams
::
	tTwoPha£Lock
, 
	tTLockV”siÚ
<
	tçl£
>,

88 
	tty³Çme
 
	t¡d
::
	tcÚd™iÚ®
<
	tDBP¬ams
::
	tSwiss
, 
	tTSwissV”siÚ
<DBP¬ams::
	tO·que
>,

89 
	tty³Çme
 
	tg‘_occ_v”siÚ
<
	tDBP¬ams
>::
	tty³
>::type>::type>::type>::typeype;

92 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

93 şas 
	cš‹g”_box
 : 
public
 
TObjeù
 {

94 
public
:

95 
št64_t
 
	tšt_ty³
;

96 
TNÚİaqueV”siÚ
 
	tv”siÚ_ty³
;

98 
š‹g”_box
()

99 : 
v”s
(
Sto
::
š™Ÿlized_tid
(è| 
T¿n§ùiÚTid
::
nÚİaque_b™
),

100 
v®ue
() {}

102 
	gš‹g”_box
& 
	gİ”©Ü
=(
št_ty³
 
x
) {

103 
v®ue
 = 
x
;

104  *
	gthis
;

107 
	g¡d
::
·œ
<
boŞ
, 
	gšt_ty³
> 
Œªs_»ad
() {

108 autØ
	g™em
 = 
Sto
::
™em
(
this
, 0);

109 
boŞ
 
	gok
 = 
™em
.
ob£rve
(
v”s
);

110 ià(
	gok
)

111  {
	gŒue
, 
	gv®ue
};

113  {
	gçl£
, 0};

116 
Œªs_šüem’t
(
št_ty³
 
i
) {

117 autØ
	g™em
 = 
Sto
::
™em
(
this
, 0);

118 
	g™em
.
add_wr™e
(
i
);

121 
boŞ
 
lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
	gov”ride
 {

122  
	gtxn
.
Œy_lock
(
™em
, 
v”s
);

124 
boŞ
 
check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
	gov”ride
 {

125  
	gv”s
.
ı_check_v”siÚ
(
txn
, 
™em
);

127 
š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
	gov”ride
 {

128 
	gv®ue
 +ğ
™em
.
wr™e_v®ue
<
št_ty³
>();

129 
	gtxn
.
£t_v”siÚ_uÆock
(
v”s
, 
™em
);

131 
uÆock
(
T¿nsI‹m
& 
™em
è
	gov”ride
 {

132 
	gv”s
.
ı_uÆock
(
™em
);

135 
	g´iv©e
:

137 
v”siÚ_ty³
 
v”s
;

138 
št_ty³
 
	gv®ue
;

142 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gV
,y³Çm
	gDBP¬ams
>

143 şas 
	cunÜd”ed_šdex
 : 
public
 
TObjeù
 {

144 
public
:

145 
K
 
	tkey_ty³
;

146 
V
 
	tv®ue_ty³
;

148 
ty³Çme
 
	tg‘_occ_v”siÚ
<
	tDBP¬ams
>::
	tty³
 
	tbuck‘_v”siÚ_ty³
;

149 
ty³Çme
 
	tg‘_v”siÚ
<
	tDBP¬ams
>::
	tty³
 
	tv”siÚ_ty³
;

151 
	g¡d
::
	thash
<
	tK
> 
	tHash
;

152 
	g¡d
::
	tequ®_to
<
	tK
> 
	tP»d
;

154 
cÚ¡ex´
 
ty³Çme
 
	gv”siÚ_ty³
::
ty³
 
šv®id_b™
 = 
T¿n§ùiÚTid
::
u£r_b™
;

156 
cÚ¡ex´
 
boŞ
 
	gšdex_»ad_my_wr™e
 = 
DBP¬ams
::
RdMyWr
;

158 
	g´iv©e
:

161 
	sš‹º®_–em
 {

162 
š‹º®_–em
 *
Ãxt
;

163 
key_ty³
 
	gkey
;

164 
v”siÚ_ty³
 
	gv”siÚ
;

165 
v®ue_ty³
 
	gv®ue
;

166 
boŞ
 
	gd–‘ed
;

168 
š‹º®_–em
(cÚ¡ 
key_ty³
& 
k
, cÚ¡ 
v®ue_ty³
& 
v®
, 
boŞ
 
m¬k_v®id
)

169 : 
Ãxt
(
nuÎ±r
), 
key
(
k
),

170 
v”siÚ
(
Sto
::
š™Ÿlized_tid
(è| (
m¬k_v®id
 ? 0 : 
šv®id_b™
), !mark_valid),

171 
v®ue
(
v®
), 
d–‘ed
(
çl£
) {}

173 
boŞ
 
v®id
() const {

174  !(
	gv”siÚ
.
v®ue
(è& 
	gšv®id_b™
);

178 
	sbuck‘_’Œy
 {

179 
š‹º®_–em
 *
	gh—d
;

184 
buck‘_v”siÚ_ty³
 
	gv”siÚ
;

185 
buck‘_’Œy
(è: 
h—d
(
nuÎ±r
), 
v”siÚ
(0) {}

188 
	g¡d
::
	tveùÜ
<
	tbuck‘_’Œy
> 
	tM­Ty³
;

190 
M­Ty³
 
	gm­_
;

191 
Hash
 
	ghash”_
;

192 
P»d
 
	g´ed_
;

194 
ušt64_t
 
	gkey_g’_
;

198 
cÚ¡ex´
 
ušŒ_t
 
	gbuck‘_b™
 = 1U<<0;

200 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
š£¹_b™
 = 
T¿nsI‹m
::
u£r0_b™
;

201 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
d–‘e_b™
 = 
T¿nsI‹m
::
u£r0_b™
<<1;

203 
	gpublic
:

204 
¡d
::
	ttu¶e
<
	tboŞ
, boŞ, 
	tušŒ_t
, cÚ¡ 
	tv®ue_ty³
*> 
	t£l_»tuº_ty³
;

205 
	g¡d
::
	ttu¶e
<
	tboŞ
, boŞ> 
	tšs_»tuº_ty³
;

206 
	g¡d
::
	ttu¶e
<
	tboŞ
, boŞ> 
	td–_»tuº_ty³
;

208 
unÜd”ed_šdex
(
size_t
 
size
, 
Hash
 
h
 = Hash(), 
P»d
 
p
 = Pred()) :

209 
m­_
(), 
hash”_
(
h
), 
´ed_
(
p
), 
key_g’_
(0) {

210 
	gm­_
.
»size
(
size
);

213 
šlše
 
size_t
 
hash
(cÚ¡ 
key_ty³
& 
k
) const {

214  
hash”_
(
k
);

216 
šlše
 
size_t
 
nbuck‘s
() const {

217  
	gm­_
.
size
();

219 
šlše
 
size_t
 
fšd_buck‘_idx
(cÚ¡ 
key_ty³
& 
k
) const {

220  
hash
(
k
è% 
nbuck‘s
();

223 
ušt64_t
 
g’_key
() {

224  
ãtch_ªd_add
(&
key_g’_
, 1);

229 
£l_»tuº_ty³


230 
£Ëù_row
(cÚ¡ 
key_ty³
& 
k
, 
boŞ
 
fÜ_upd©e
 = 
çl£
) {

231 
buck‘_’Œy
& 
buck
 = 
m­_
[
fšd_buck‘_idx
(
k
)];

232 
buck‘_v”siÚ_ty³
 
	gbuck_v”s
 = 
buck
.
v”siÚ
;

233 
ãnû
();

234 
š‹º®_–em
 *
	ge
 = 
fšd_š_buck‘
(
buck
, 
k
);

236 ià(
	ge
) {

238 autØ
	g™em
 = 
Sto
::
™em
(
this
, 
e
);

239 ià(
is_phªtom
(
e
, 
™em
))

240 
	gabÜt
;

242 ià(
	gšdex_»ad_my_wr™e
) {

243 ià(
has_d–‘e
(
™em
))

244  
£l_»tuº_ty³
(
Œue
, 
çl£
, 0, 
nuÎ±r
);

245 ià(
	g™em
.
has_wr™e
())

246  
£l_»tuº_ty³
(
Œue
,rue, 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
e
), &((
™em
.
‹m¶©e
 
wr™e_v®ue
<
š‹º®_–em
 *>())->
v®ue
));

249 ià(
	gfÜ_upd©e
) {

250 ià(!
	gv”siÚ_ad­‹r
::
£Ëù_fÜ_upd©e
(
™em
, 
e
->
v”siÚ
))

251 
	gabÜt
;

253 ià(!
	g™em
.
ob£rve
(
e
->
v”siÚ
))

254 
	gabÜt
;

257  
£l_»tuº_ty³
(
Œue
,rue, 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
e
), &e->
v®ue
);

260 
boŞ
 
	gok
 = 
Sto
::
™em
(
this
, 
make_buck‘_key
(
buck
)).
ob£rve
(
buck_v”s
);

261 ià(!
	gok
)

262 
	gabÜt
;

263  
£l_»tuº_ty³
(
Œue
, 
çl£
, 0, 
nuÎ±r
);

266 
	gabÜt
:

267  
£l_»tuº_ty³
(
çl£
, f®£, 0, 
nuÎ±r
);

276 
upd©e_row
(
ušŒ_t
 
rid
, 
v®ue_ty³
 *
Ãw_row
) {

277 autØ
	g™em
 = 
Sto
::
™em
(
this
, 
»š‹½»t_ÿ¡
<
š‹º®_–em
 *>(
rid
));

278 
as£¹
(
™em
.
has_wr™e
(è&& !
has_š£¹
(item));

279 
	g™em
.
add_wr™e
(
Ãw_row
);

286 
šs_»tuº_ty³


287 
š£¹_row
(cÚ¡ 
key_ty³
& 
k
, 
v®ue_ty³
 *
v±r
, 
boŞ
 
ov”wr™e
 = 
çl£
) {

288 
buck‘_’Œy
& 
buck
 = 
m­_
[
fšd_buck‘_idx
(
k
)];

290 
	gbuck
.
	gv”siÚ
.
lock_exşusive
();

291 
š‹º®_–em
 *
	ge
 = 
fšd_š_buck‘
(
buck
, 
k
);

293 ià(
	ge
) {

294 
	gbuck
.
	gv”siÚ
.
uÆock_exşusive
();

295 autØ
	g™em
 = 
Sto
::
™em
(
this
, 
e
);

296 ià(
is_phªtom
(
e
, 
™em
))

297 
	gabÜt
;

299 ià(
	gšdex_»ad_my_wr™e
) {

300 ià(
has_d–‘e
(
™em
)) {

301 
	g™em
.
ş—r_æags
(
d–‘e_b™
).
ş—r_wr™e
().
‹m¶©e
 
	gadd_wr™e
<
	gv®ue_ty³
 *>(
	gv±r
);

302  
šs_»tuº_ty³
(
Œue
, 
çl£
);

310 ià(
	gov”wr™e
) {

311 ià(!
	gv”siÚ_ad­‹r
::
£Ëù_fÜ_ov”wr™e
(
™em
, 
e
->
v”siÚ
, 
v±r
))

312 
	gabÜt
;

313 ià(
	gšdex_»ad_my_wr™e
) {

314 ià(
has_š£¹
(
™em
)) {

315 
cİy_row
(
e
, 
v±r
);

319 ià(!
	g™em
.
ob£rve
(
e
->
v”siÚ
))

320 
	gabÜt
;

323  
šs_»tuº_ty³
(
Œue
,rue);

326 autØ
	gbuck_v”s_0
 = 
buck‘_v”siÚ_ty³
(
buck
.
v”siÚ
.
uÆocked_v®ue
());

327 
š£¹_š_buck‘
(
buck
, 
k
, 
v±r
, 
çl£
);

328 
š‹º®_–em
 *
	gÃw_h—d
 = 
buck
.
h—d
;

329 autØ
	gbuck_v”s_1
 = 
buck‘_v”siÚ_ty³
(
buck
.
v”siÚ
.
uÆocked_v®ue
());

331 
	gbuck
.
	gv”siÚ
.
uÆock_exşusive
();

334 autØ
	gbuck‘_™em
 = 
Sto
::
™em
(
this
, 
make_buck‘_key
(
buck
));

335 ià(
	gbuck‘_™em
.
has_»ad
())

336 
	gbuck‘_™em
.
upd©e_»ad
(
buck_v”s_0
, 
buck_v”s_1
);

338 autØ
	g™em
 = 
Sto
::
™em
(
this
, 
Ãw_h—d
);

340 
	g™em
.
‹m¶©e
 
	gadd_wr™e
<
	gv®ue_ty³
 *>(
	gv±r
);

341 
	g™em
.
add_æags
(
š£¹_b™
);

343  
šs_»tuº_ty³
(
Œue
, 
çl£
);

346 
	gabÜt
:

347  
šs_»tuº_ty³
(
çl£
, false);

353 
d–_»tuº_ty³


354 
d–‘e_row
(cÚ¡ 
key_ty³
& 
k
) {

355 
	gbuck‘_’Œy
& 
	gbuck
 = 
m­_
[
fšd_buck‘_idx
(
k
)];

356 
buck‘_v”siÚ_ty³
 
	gbuck_v”s
 = 
buck
.
v”siÚ
;

357 
ãnû
();

359 
š‹º®_–em
 *
	ge
 = 
fšd_š_buck‘
(
buck
, 
k
);

360 ià(
	ge
) {

361 autØ
	g™em
 = 
Sto
::
™em
(
this
, 
e
);

362 
boŞ
 
	gv®id
 = 
e
->
v®id
();

363 ià(
is_phªtom
(
e
, 
™em
))

364 
	gabÜt
;

365 ià(
	gšdex_»ad_my_wr™e
) {

366 ià(!
	gv®id
 && 
has_š£¹
(
™em
)) {

368 
_»move
(
e
);

369 
	g™em
.
»move_»ad
().
»move_wr™e
().
ş—r_æags
(
š£¹_b™
 | 
d–‘e_b™
);

370 
	gSto
::
™em
(
this
, 
make_buck‘_key
(
buck
)).
ob£rve
(
buck_v”s
);

371  
d–_»tuº_ty³
(
Œue
,rue);

373 
as£¹
(
v®id
);

374 ià(
has_d–‘e
(
™em
))

375  
d–_»tuº_ty³
(
Œue
, 
çl£
);

379 ià(!
	gv”siÚ_ad­‹r
::
£Ëù_fÜ_upd©e
(
™em
, 
e
->
v”siÚ
))

380 
	gabÜt
;

381 
ãnû
();

383 ià(
	ge
->
	gd–‘ed
)

384 
	gabÜt
;

385 
	g™em
.
add_æags
(
d–‘e_b™
);

387  
d–_»tuº_ty³
(
Œue
,rue);

390 
boŞ
 
	gok
 = 
Sto
::
™em
(
this
, 
make_buck‘_key
(
buck
)).
ob£rve
(
buck_v”s
);

391 ià(!
	gok
)

392 
	gabÜt
;

393  
d–_»tuº_ty³
(
Œue
, 
çl£
);

396 
	gabÜt
:

397  
d–_»tuº_ty³
(
çl£
, false);

401 
boŞ
 
lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
	gov”ride
 {

402 
as£¹
(!
is_buck‘
(
™em
));

403 
š‹º®_–em
 *
	g–
 = 
™em
.
key
<internal_elem *>();

404  
	gtxn
.
Œy_lock
(
™em
, 
–
->
v”siÚ
);

407 
boŞ
 
check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
	gov”ride
 {

408 ià(
is_buck‘
(
™em
)) {

409 
	gbuck‘_’Œy
 &
	gbuck
 = *
buck‘_add»ss
(
™em
);

410  
	gbuck
.
	gv”siÚ
.
ı_check_v”siÚ
(
txn
, 
™em
);

412 
š‹º®_–em
 *
	g–
 = 
™em
.
key
<internal_elem *>();

413  
	g–
->
	gv”siÚ
.
ı_check_v”siÚ
(
txn
, 
™em
);

417 
š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
	gov”ride
 {

418 
as£¹
(!
is_buck‘
(
™em
));

419 
š‹º®_–em
 *
	g–
 = 
™em
.
key
<internal_elem*>();

420 ià(
has_d–‘e
(
™em
)) {

421 
	g–
->
	gd–‘ed
 = 
Œue
;

422 
ãnû
();

423 
	gtxn
.
£t_v”siÚ
(
–
->
v”siÚ
);

426 ià(!
has_š£¹
(
™em
)) {

428 autØ
	gv±r
 = 
™em
.
wr™e_v®ue
<
v®ue_ty³
 *>();

429 
cİy_row
(
–
, 
v±r
);

435 
	gtxn
.
£t_v”siÚ_uÆock
(
–
->
v”siÚ
, 
™em
);

438 
uÆock
(
T¿nsI‹m
& 
™em
è
	gov”ride
 {

439 
as£¹
(!
is_buck‘
(
™em
));

440 
š‹º®_–em
 *
	g–
 = 
™em
.
key
<internal_elem *>();

441 
	g–
->
	gv”siÚ
.
ı_uÆock
(
™em
);

444 
ş—nup
(
T¿nsI‹m
& 
™em
, 
boŞ
 
comm™‹d
è
	gov”ride
 {

445 ià(
	gcomm™‹d
 ? 
has_d–‘e
(
™em
è: 
has_š£¹
(item)) {

446 
as£¹
(!
is_buck‘
(
™em
));

447 
š‹º®_–em
 *
	g–
 = 
™em
.
key
<internal_elem *>();

448 
as£¹
(!
–
->
v®id
(è||ƒl->
d–‘ed
);

449 
_»move
(
–
);

450 
	g™em
.
ş—r_Ãeds_uÆock
();

455 
v®ue_ty³
* 
nÚŒªs_g‘
(cÚ¡ 
key_ty³
& 
k
) {

456 
	gbuck‘_’Œy
& 
	gbuck
 = 
m­_
[
fšd_buck‘_idx
(
k
)];

457 
š‹º®_–em
 *
	g–
 = 
fšd_š_buck‘
(
buck
, 
k
);

458 ià(
	g–
 =ğ
nuÎ±r
)

459  
nuÎ±r
;

460  &
	g–
->
	gv®ue
;

462 
nÚŒªs_put
(cÚ¡ 
key_ty³
& 
k
, cÚ¡ 
v®ue_ty³
& 
v
) {

463 
	gbuck‘_’Œy
& 
	gbuck
 = 
m­_
[
fšd_buck‘_idx
(
k
)];

464 
	gbuck
.
	gv”siÚ
.
lock_exşusive
();

465 
š‹º®_–em
 *
	g–
 = 
fšd_š_buck‘
(
buck
, 
k
);

466 ià(
	g–
 =ğ
nuÎ±r
) {

467 
š‹º®_–em
 *
Ãw_h—d
 = 
Ãw
 iÁ”Çl_–em(
k
, 
v
, 
Œue
);

468 
	gÃw_h—d
->
	gÃxt
 = 
buck
.
h—d
;

469 
	gbuck
.
	gh—d
 = 
Ãw_h—d
;

471 
cİy_row
(
–
, &
v
);

473 
	gbuck
.
	gv”siÚ
.
uÆock_exşusive
();

476 
	g´iv©e
:

478 
_»move
(
š‹º®_–em
 *
–
) {

479 
buck‘_’Œy
& 
buck
 = 
m­_
[
fšd_buck‘_idx
(
–
->
key
)];

480 
	gbuck
.
	gv”siÚ
.
lock_exşusive
();

481 
š‹º®_–em
 *
	g´ev
 = 
nuÎ±r
;

482 
š‹º®_–em
 *
	gcu¼
 = 
buck
.
h—d
;

483 
	gcu¼
 !ğ
nuÎ±r
 && 
cu¼
 !ğ
–
) {

484 
´ev
 = 
cu¼
;

485 
	gcu¼
 = 
cu¼
->
Ãxt
;

487 
as£¹
(
cu¼
);

488 ià(
	g´ev
 !ğ
nuÎ±r
)

489 
´ev
->
Ãxt
 = 
cu¼
->next;

491 
	gbuck
.
	gh—d
 = 
cu¼
->
Ãxt
;

492 
	gbuck
.
	gv”siÚ
.
uÆock_exşusive
();

493 
	gT¿n§ùiÚ
::
rcu_d–‘e
(
cu¼
);

496 
boŞ
 
»move
(cÚ¡ 
key_ty³
& 
k
) {

497 
	gbuck‘_’Œy
& 
	gbuck
 = 
m­_
[
fšd_buck‘_idx
(
k
)];

498 
	gbuck
.
	gv”siÚ
.
lock_exşusive
();

499 
š‹º®_–em
 *
	g´ev
 = 
nuÎ±r
;

500 
š‹º®_–em
 *
	gcu¼
 = 
buck
.
h—d
;

501 
	gcu¼
 !ğ
nuÎ±r
 && !
´ed_
(
cu¼
->
key
, 
k
)) {

502 
	g´ev
 = 
cu¼
;

503 
	gcu¼
 = 
cu¼
->
Ãxt
;

505 ià(
	gcu¼
 =ğ
nuÎ±r
) {

506 
buck
.
v”siÚ
.
uÆock_exşusive
();

507  
	gçl£
;

509 ià(
	g´ev
 !ğ
nuÎ±r
)

510 
´ev
->
Ãxt
 = 
cu¼
->next;

512 
	gbuck
.
	gh—d
 = 
cu¼
->
Ãxt
;

513 
	gbuck
.
	gv”siÚ
.
uÆock_exşusive
();

514 
d–‘e
 
	gcu¼
;

515  
	gŒue
;

518 
š£¹_š_buck‘
(
buck‘_’Œy
& 
buck
, cÚ¡ 
key_ty³
& 
k
, cÚ¡ 
v®ue_ty³
 *
v
, 
boŞ
 
v®id
) {

519 
as£¹
(
buck
.
v”siÚ
.
is_locked
());

521 
š‹º®_–em
 *
	gÃw_h—d
 = 
Ãw
 iÁ”Çl_–em(
k
, 
v
 ? *v : 
v®ue_ty³
(), 
v®id
);

522 
š‹º®_–em
 *
	gcu¼_h—d
 = 
buck
.
h—d
;

524 
	gÃw_h—d
->
	gÃxt
 = 
cu¼_h—d
;

525 
	gbuck
.
	gh—d
 = 
Ãw_h—d
;

527 
	gbuck
.
	gv”siÚ
.
šc_nÚİaque
();

530 
š‹º®_–em
 *
fšd_š_buck‘
(cÚ¡ 
buck‘_’Œy
& 
buck
, cÚ¡ 
key_ty³
& 
k
) {

531 
š‹º®_–em
 *
	gcu¼
 = 
buck
.
h—d
;

532 
	gcu¼
 && !
´ed_
(
cu¼
->
key
, 
k
))

533 
	gcu¼
 = 
cu¼
->
Ãxt
;

534  
	gcu¼
;

537 
boŞ
 
has_d–‘e
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

538  
	g™em
.
æags
(è& 
	gd–‘e_b™
;

540 
boŞ
 
has_š£¹
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

541  
	g™em
.
æags
(è& 
	gš£¹_b™
;

543 
boŞ
 
is_phªtom
(
š‹º®_–em
 *
e
, cÚ¡ 
T¿nsI‹m
& 
™em
) {

544  (!
	ge
->
v®id
(è&& !
has_š£¹
(
™em
));

548 
boŞ
 
is_buck‘
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

549  
	g™em
.
	gkey
<
	gušŒ_t
>(è& 
	gbuck‘_b™
;

551 
ušŒ_t
 
make_buck‘_key
(cÚ¡ 
buck‘_’Œy
& 
buck‘
) {

552  (
	g»š‹½»t_ÿ¡
<
	gušŒ_t
>(&
	gbuck‘
è| 
	gbuck‘_b™
);

554 
buck‘_’Œy
 *
buck‘_add»ss
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

555 
ušŒ_t
 
	gbuck‘_key
 = 
™em
.
key
<uintptr_t>();

556  
	g»š‹½»t_ÿ¡
<
	gbuck‘_’Œy
*>(
	gbuck‘_key
 & ~
	gbuck‘_b™
);

559 
cİy_row
(
š‹º®_–em
 *
bË_row
, cÚ¡ 
v®ue_ty³
 *
v®ue
) {

560 ià(
	gv®ue
 =ğ
nuÎ±r
)

562 
	gbË_row
->
	gv®ue
 = *
v®ue
;

566 şas 
	cRowAcûss
 : { 
NÚe
 = 0, 
	gOb£rveExi¡s
, 
	gOb£rveV®ue
, 
	gUpd©eV®ue
 };

568 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gV
,y³Çm
	gDBP¬ams
>

569 şas 
	cÜd”ed_šdex
 : 
public
 
TObjeù
 {

570 
public
:

571 
K
 
	tkey_ty³
;

572 
V
 
	tv®ue_ty³
;

575 
ty³Çme
 
	tg‘_v”siÚ
<
	tDBP¬ams
>::
	tty³
 
	tv”siÚ_ty³
;

577 
cÚ¡ex´
 
ty³Çme
 
	gv”siÚ_ty³
::
ty³
 
šv®id_b™
 = 
T¿n§ùiÚTid
::
u£r_b™
;

578 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
š£¹_b™
 = 
T¿nsI‹m
::
u£r0_b™
;

579 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
d–‘e_b™
 = 
T¿nsI‹m
::
u£r0_b™
 << 1u;

580 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
row_upd©e_b™
 = 
T¿nsI‹m
::
u£r0_b™
 << 2u;

581 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
row_ûÎ_b™
 = 
T¿nsI‹m
::
u£r0_b™
 << 3u;

582 
cÚ¡ex´
 
ušŒ_t
 
	gš‹ºode_b™
 = 1;

584 
ty³Çme
 
	tv®ue_ty³
::
	tNamedCŞumn
 NamedColumn;

585 
	gIndexV®ueCÚš”
<
	tV
, 
	tv”siÚ_ty³
> 
	tv®ue_cÚš”_ty³
;

587 
cÚ¡ex´
 
boŞ
 
	gv®ue_is_sm®l
 = 
is_sm®l
<
V
>::
v®ue
;

589 
cÚ¡ex´
 
boŞ
 
	gšdex_»ad_my_wr™e
 = 
DBP¬ams
::
RdMyWr
;

591 
	sš‹º®_–em
 {

592 
key_ty³
 
	gkey
;

593 
v®ue_cÚš”_ty³
 
	grow_cÚš”
;

594 
boŞ
 
	gd–‘ed
;

596 
š‹º®_–em
(cÚ¡ 
key_ty³
& 
k
, cÚ¡ 
v®ue_ty³
& 
v
, 
boŞ
 
v®id
)

597 : 
key
(
k
),

598 
row_cÚš”
((
v®id
 ? 
Sto
::
š™Ÿlized_tid
(è: (Sto::š™Ÿlized_tid(è| 
šv®id_b™
)),

599 !
v®id
, 
v
),

600 
d–‘ed
(
çl£
) {}

602 
	gv”siÚ_ty³
& 
v”siÚ
() {

603  
	grow_cÚš”
.
row_v”siÚ
();

606 
boŞ
 
v®id
() {

607  !(
v”siÚ
().
v®ue
(è& 
	gšv®id_b™
);

611 
	scŞumn_acûss_t
 {

612 
	gcŞ_id
;

613 
boŞ
 
	gupd©e
;

615 
cŞumn_acûss_t
(
NamedCŞumn
 
cŞumn
, 
boŞ
 
fÜ_upd©e
)

616 : 
cŞ_id
(
¡©ic_ÿ¡
<>(
cŞumn
)), 
upd©e
(
fÜ_upd©e
) {}

619 
	sûÎ_acûss_t
 {

620 
	gûÎ_id
;

621 
boŞ
 
	gupd©e
;

623 
ûÎ_acûss_t
(
cid
, 
boŞ
 
fÜ_upd©e
)

624 : 
ûÎ_id
(
cid
), 
upd©e
(
fÜ_upd©e
) {}

635 şas 
	c™em_key_t
 {

636 
ušŒ_t
 
	tty³
;

637 
cÚ¡ex´
 
	gshiá
 = 16u;

638 
cÚ¡ex´
 
ty³
 
	gûÎ_mask
 =ype(0xfffe);

639 
ty³
 
	gkey_
;

641 
	gpublic
:

642 
™em_key_t
(è: 
key_
() {};

643 
™em_key_t
(
š‹º®_–em
 *
e
, 
ûÎ_num
è: 
key_
((
»š‹½»t_ÿ¡
<
ty³
>Óè<< 
shiá
)

644 | ((
¡©ic_ÿ¡
<
ty³
>(
ûÎ_num
è<< 1uè& 
ûÎ_mask
)) {};

646 
™em_key_t
 
row_™em_key
(
š‹º®_–em
 *
e
) {

647  
™em_key_t
(
e
, 0);

650 
š‹º®_–em
 *
š‹º®_–em_±r
() const {

651  
	g»š‹½»t_ÿ¡
<
	gš‹º®_–em
 *>(
	gkey_
 >> 
	gshiá
);

654 
ûÎ_num
() const {

655  
	g¡©ic_ÿ¡
<>((
	gkey_
 & 
	gûÎ_mask
) >> 1);

658 
boŞ
 
is_row_™em
() const {

659  (
ûÎ_num
() == 0);

663 
	g¡d
::
veùÜ
<
ûÎ_acûss_t
>

664 
cŞumn_to_ûÎ_acûs£s
(
¡d
::
funùiÚ
<()> 
c_c_m­
, std::
š™Ÿliz”_li¡
<
cŞumn_acûss_t
> 
acûs£s
) {

666 
¡d
::
veùÜ
<¡d::
·œ
<
boŞ
, 
	gboŞ
>> 
®l_ûÎs
(
v®ue_cÚš”_ty³
::
num_v”siÚs
, {
çl£
, false});

668 
	g¡d
::
veùÜ
<
ûÎ_acûss_t
> 
ûÎ_acûs£s
;

670 autØ
	gÿ
 : 
acûs£s
) {

671 
ûÎ_id
 = 
c_c_m­
(
ÿ
.
cŞ_id
);

672 
	g®l_ûÎs
[
ûÎ_id
].
	gfœ¡
 = 
Œue
;

673 
	g®l_ûÎs
[
ûÎ_id
].
	g£cÚd
 |ğ
ÿ
.
upd©e
;

676 autØ
	g™
 = 
®l_ûÎs
.
begš
(); iˆ!ğ®l_ûÎs.
’d
(); ++it) {

677 ià(
	g™
->
	gfœ¡
)

678 
	gûÎ_acûs£s
.
em¶aû_back
(
¡©ic_ÿ¡
<>(
™
-
®l_ûÎs
.
begš
()), it->
£cÚd
);

680  
	gûÎ_acûs£s
;

683 
	gbË_·¿ms
 : 
public
 
Mas¡»e
::
nod•¬ams
<15,15> {

684 
š‹º®_–em
* 
	tv®ue_ty³
;

685 
	gMas¡»e
::
	tv®ue_´št
<
	tv®ue_ty³
> 
	tv®ue_´št_ty³
;

686 
th»adšfo
 
	tth»adšfo_ty³
;

689 
	gMas¡»e
::
	tSŒ
 Str;

690 
	gMas¡»e
::
	tbasic_bË
<
	tbË_·¿ms
> 
	tbË_ty³
;

691 
	gMas¡»e
::
	tuÆocked_tcursÜ
<
	tbË_·¿ms
> 
	tuÆocked_cursÜ_ty³
;

692 
	gMas¡»e
::
	ttcursÜ
<
	tbË_·¿ms
> 
	tcursÜ_ty³
;

693 
	gMas¡»e
::
	tËaf
<
	tbË_·¿ms
> 
	tËaf_ty³
;

695 
ty³Çme
 
	tbË_ty³
::
	tnode_ty³
‚ode_type;

696 
ty³Çme
 
	tuÆocked_cursÜ_ty³
::
	tnodev”siÚ_v®ue_ty³
‚odeversion_value_type;

698 
	g¡d
::
	ttu¶e
<
	tboŞ
, boŞ, 
	tušŒ_t
, cÚ¡ 
	tv®ue_ty³
*> 
	t£l_»tuº_ty³
;

699 
	g¡d
::
	ttu¶e
<
	tboŞ
, boŞ> 
	tšs_»tuº_ty³
;

700 
	g¡d
::
	ttu¶e
<
	tboŞ
, boŞ> 
	td–_»tuº_ty³
;

702 
__th»ad
 
ty³Çme
 
	gbË_·¿ms
::
th»adšfo_ty³
 *
ti
;

704 
Üd”ed_šdex
(
size_t
 
š™_size
) {

705 
	gthis
->
bË_š™
();

706 ()
	gš™_size
;

708 
Üd”ed_šdex
() {

709 
	gthis
->
bË_š™
();

712 
bË_š™
() {

713 ià(
	gti
 =ğ
nuÎ±r
)

714 
ti
 = 
th»adšfo
::
make
Ñh»adšfo::
TI_MAIN
, -1);

715 
	gbË_
.
š™Ÿlize
(*
ti
);

716 
	gkey_g’_
 = 0;

719 
th»ad_š™
() {

720 ià(
	gti
 =ğ
nuÎ±r
)

721 
ti
 = 
th»adšfo
::
make
Ñh»adšfo::
TI_PROCESS
, 
TTh»ad
::
id
());

722 
	gT¿n§ùiÚ
::
tšfo
[
TTh»ad
::
id
()].
Œªs_¡¬t_ÿÎback
 = []() {

723 
ti
->
rcu_¡¬t
();

725 
	gT¿n§ùiÚ
::
tšfo
[
TTh»ad
::
id
()].
Œªs_’d_ÿÎback
 = []() {

726 
ti
->
rcu_¡İ
();

730 
ušt64_t
 
g’_key
() {

731  
ãtch_ªd_add
(&
key_g’_
, 1);

734 
£l_»tuº_ty³


735 
£Ëù_row
(cÚ¡ 
key_ty³
& 
key
, 
RowAcûss
 
acc
) {

736 
uÆocked_cursÜ_ty³
 
Í
(
bË_
, 
key
);

737 
boŞ
 
	gfound
 = 
Í
.
fšd_uÆocked
(*
ti
);

738 
š‹º®_–em
 *
	ge
 = 
Í
.
v®ue
();

739 ià(
	gfound
) {

740  
£Ëù_row
(
»š‹½»t_ÿ¡
<
ušŒ_t
>(
e
), 
acc
);

742 ià(!
»gi¡”_š‹ºode_v”siÚ
(
Í
.
node
(),†p.
fuÎ_v”siÚ_v®ue
()))

743 
	gabÜt
;

744  
£l_»tuº_ty³
(
Œue
, 
çl£
, 0, 
nuÎ±r
);

747 
	gabÜt
:

748  
£l_»tuº_ty³
(
çl£
, f®£, 0, 
nuÎ±r
);

751 
£l_»tuº_ty³


752 
£Ëù_row
(cÚ¡ 
key_ty³
& 
key
, 
¡d
::
š™Ÿliz”_li¡
<
cŞumn_acûss_t
> 
acûs£s
) {

753 
uÆocked_cursÜ_ty³
 
Í
(
bË_
, 
key
);

754 
boŞ
 
	gfound
 = 
Í
.
fšd_uÆocked
(*
ti
);

755 
š‹º®_–em
 *
	ge
 = 
Í
.
v®ue
();

756 ià(
	gfound
) {

757  
£Ëù_row
(
»š‹½»t_ÿ¡
<
ušŒ_t
>(
e
), 
acûs£s
);

759 ià(!
»gi¡”_š‹ºode_v”siÚ
(
Í
.
node
(),†p.
fuÎ_v”siÚ_v®ue
()))

760 
	gabÜt
;

761  
£l_»tuº_ty³
(
Œue
, 
çl£
, 0, 
nuÎ±r
);

764 
	gabÜt
:

765  
£l_»tuº_ty³
(
çl£
, f®£, 0, 
nuÎ±r
);

768 
£l_»tuº_ty³


769 
£Ëù_row
(
ušŒ_t
 
rid
, 
RowAcûss
 
acûss
) {

770 autØ
	ge
 = 
»š‹½»t_ÿ¡
<
š‹º®_–em
 *>(
rid
);

771 
boŞ
 
	gok
 = 
Œue
;

772 
T¿nsProxy
 
	grow_™em
 = 
Sto
::
™em
(
this
, 
™em_key_t
::
row_™em_key
(
e
));

774 ià(
is_phªtom
(
e
, 
row_™em
))

775 
	gabÜt
;

777 ià(
	gšdex_»ad_my_wr™e
) {

778 ià(
has_d–‘e
(
row_™em
)) {

779  
£l_»tuº_ty³
(
Œue
, 
çl£
, 0, 
nuÎ±r
);

781 ià(
has_row_upd©e
(
row_™em
)) {

782 
v®ue_ty³
 *
	gv±r
;

783 ià(
has_š£¹
(
row_™em
))

784 
	gv±r
 = &
e
->
row_cÚš”
.
row
;

786 
	gv±r
 = 
row_™em
.
‹m¶©e
 
¿w_wr™e_v®ue
<
v®ue_ty³
 *>();

787  
£l_»tuº_ty³
(
Œue
,rue, 
rid
, 
v±r
);

791 
	gacûss
) {

792 
	gRowAcûss
::
Upd©eV®ue
:

793 
ok
 = 
v”siÚ_ad­‹r
::
£Ëù_fÜ_upd©e
(
row_™em
, 
e
->
v”siÚ
());

794 
	grow_™em
.
add_æags
(
row_upd©e_b™
);

796 
	gRowAcûss
::
Ob£rveExi¡s
:

797 
RowAcûss
::
Ob£rveV®ue
:

798 
ok
 = 
row_™em
.
ob£rve
(
e
->
v”siÚ
());

804 ià(!
	gok
)

805 
	gabÜt
;

807  
£l_»tuº_ty³
(
Œue
,rue, 
rid
, &(
e
->
row_cÚš”
.
row
));

809 
	gabÜt
:

810  
£l_»tuº_ty³
(
çl£
, f®£, 0, 
nuÎ±r
);

813 
£l_»tuº_ty³


814 
£Ëù_row
(
ušŒ_t
 
rid
, 
¡d
::
š™Ÿliz”_li¡
<
cŞumn_acûss_t
> 
acûs£s
) {

815 autØ
e
 = 
»š‹½»t_ÿ¡
<
š‹º®_–em
 *>(
rid
);

816 
T¿nsProxy
 
	grow_™em
 = 
Sto
::
™em
(
this
, 
™em_key_t
::
row_™em_key
(
e
));

820 autØ
	gûÎ_acûs£s
 = 
cŞumn_to_ûÎ_acûs£s
(
v®ue_cÚš”_ty³
::
m­
, 
acûs£s
);

822 
	g¡d
::
veùÜ
<
T¿nsProxy
> 
ûÎ_™ems
;

823 
boŞ
 
	gªy_has_wr™e
;

824 
boŞ
 
	gok
;

825 
	g¡d
::
t›
(
ªy_has_wr™e
, 
ûÎ_™ems
èğ
exŒaù_™em_li¡
(
ûÎ_acûs£s
, 
e
);

827 ià(
is_phªtom
(
e
, 
row_™em
))

828 
	gabÜt
;

830 ià(
	gšdex_»ad_my_wr™e
) {

831 ià(
has_d–‘e
(
row_™em
)) {

832  
£l_»tuº_ty³
(
Œue
, 
çl£
, 0, 
nuÎ±r
);

834 ià(
	gªy_has_wr™e
 || 
has_row_upd©e
(
row_™em
)) {

835 
v®ue_ty³
 *
	gv±r
;

836 ià(
has_š£¹
(
row_™em
))

837 
	gv±r
 = &
e
->
row_cÚš”
.
row
;

839 
	gv±r
 = 
row_™em
.
‹m¶©e
 
¿w_wr™e_v®ue
<
v®ue_ty³
 *>();

840  
£l_»tuº_ty³
(
Œue
,rue, 
rid
, 
v±r
);

844 
	gok
 = 
acûss_®l
(
ûÎ_acûs£s
, 
ûÎ_™ems
, 
e
);

845 ià(!
	gok
)

846 
	gabÜt
;

848  
£l_»tuº_ty³
(
Œue
,rue, 
rid
, &(
e
->
row_cÚš”
.
row
));

850 
	gabÜt
:

851  
£l_»tuº_ty³
(
çl£
, f®£, 0, 
nuÎ±r
);

854 
upd©e_row
(
ušŒ_t
 
rid
, 
v®ue_ty³
 *
Ãw_row
) {

855 autØ
	grow_™em
 = 
Sto
::
™em
(
this
, 
™em_key_t
::
row_™em_key
(
»š‹½»t_ÿ¡
<
š‹º®_–em
 *>(
rid
)));

856 ià(
	gv®ue_is_sm®l
) {

857 
	grow_™em
.
add_wr™e
(*
Ãw_row
);

859 
	grow_™em
.
add_wr™e
(
Ãw_row
);

868 
šs_»tuº_ty³


869 
š£¹_row
(cÚ¡ 
key_ty³
& 
key
, 
v®ue_ty³
 *
v±r
, 
boŞ
 
ov”wr™e
 = 
çl£
) {

870 
cursÜ_ty³
 
Í
(
bË_
, 
key
);

871 
boŞ
 
	gfound
 = 
Í
.
fšd_š£¹
(*
ti
);

872 ià(
	gfound
) {

882 
š‹º®_–em
 *
	ge
 = 
Í
.
v®ue
();

883 
	gÍ
.
fšish
(0, *
ti
);

885 
T¿nsProxy
 
	grow_™em
 = 
Sto
::
™em
(
this
, 
™em_key_t
::
row_™em_key
(
e
));

887 ià(
is_phªtom
(
e
, 
row_™em
))

888 
	gabÜt
;

890 ià(
	gšdex_»ad_my_wr™e
) {

891 ià(
has_d–‘e
(
row_™em
)) {

892 autØ
	g´oxy
 = 
row_™em
.
ş—r_æags
(
d–‘e_b™
).
ş—r_wr™e
();

894 ià(
	gv®ue_is_sm®l
)

895 
	g´oxy
.
add_wr™e
(*
v±r
);

897 
	g´oxy
.
add_wr™e
(
v±r
);

899  
šs_»tuº_ty³
(
Œue
, 
çl£
);

903 ià(
	gov”wr™e
) {

904 
boŞ
 
	gok
;

905 ià(
	gv®ue_is_sm®l
)

906 
	gok
 = 
v”siÚ_ad­‹r
::
£Ëù_fÜ_ov”wr™e
(
row_™em
, 
e
->
v”siÚ
(), *
v±r
);

908 
	gok
 = 
v”siÚ_ad­‹r
::
£Ëù_fÜ_ov”wr™e
(
row_™em
, 
e
->
v”siÚ
(), 
v±r
);

909 ià(!
	gok
)

910 
	gabÜt
;

911 ià(
	gšdex_»ad_my_wr™e
) {

912 ià(
has_š£¹
(
row_™em
)) {

913 
cİy_row
(
e
, 
v±r
);

918 ià(!
	grow_™em
.
ob£rve
(
e
->
v”siÚ
()))

919 
	gabÜt
;

923 autØ
	ge
 = 
Ãw
 
š‹º®_–em
(
key
, 
v±r
 ? *v±¸: 
v®ue_ty³
(),

924 
çl£
 );

925 
	gÍ
.
v®ue
(èğ
e
;

927 
node_ty³
 *
	gnode
;

928 
nodev”siÚ_v®ue_ty³
 
	gÜig_nv
;

929 
nodev”siÚ_v®ue_ty³
 
	gÃw_nv
;

931 
boŞ
 
	g¥l™_right
 = (
Í
.
node
(è!ğÍ.
Üigš®_node
());

932 ià(
	g¥l™_right
) {

933 
	gnode
 = 
Í
.
Üigš®_node
();

934 
	gÜig_nv
 = 
Í
.
Üigš®_v”siÚ_v®ue
();

935 
	gÃw_nv
 = 
Í
.
upd©ed_v”siÚ_v®ue
();

937 
	gnode
 = 
Í
.
node
();

938 
	gÜig_nv
 = 
Í
.
´evious_fuÎ_v”siÚ_v®ue
();

939 
	gÃw_nv
 = 
Í
.
Ãxt_fuÎ_v”siÚ_v®ue
(1);

942 
ãnû
();

943 
	gÍ
.
fšish
(1, *
ti
);

946 
T¿nsProxy
 
	grow_™em
 = 
Sto
::
™em
(
this
, 
™em_key_t
::
row_™em_key
(
e
));

951 
	grow_™em
.
add_wr™e
();

952 
	grow_™em
.
add_æags
(
š£¹_b™
);

955 ià(!
upd©e_š‹ºode_v”siÚ
(
node
, 
Üig_nv
, 
Ãw_nv
))

956 
	gabÜt
;

959  
šs_»tuº_ty³
(
Œue
, 
found
);

961 
	gabÜt
:

962  
šs_»tuº_ty³
(
çl£
, false);

965 
d–_»tuº_ty³


966 
d–‘e_row
(cÚ¡ 
key_ty³
& 
key
) {

967 
uÆocked_cursÜ_ty³
 
Í
(
bË_
, 
key
);

968 
boŞ
 
	gfound
 = 
Í
.
fšd_uÆocked
(*
ti
);

969 ià(
	gfound
) {

970 
š‹º®_–em
 *
	ge
 = 
Í
.
v®ue
();

971 
T¿nsProxy
 
	grow_™em
 = 
Sto
::
™em
(
this
, 
™em_key_t
::
row_™em_key
(
e
));

973 ià(
is_phªtom
(
e
, 
row_™em
))

974 
	gabÜt
;

976 ià(
	gšdex_»ad_my_wr™e
) {

977 ià(
has_d–‘e
(
row_™em
))

978  
d–_»tuº_ty³
(
Œue
, 
çl£
);

979 ià(!
	ge
->
v®id
(è&& 
has_š£¹
(
row_™em
)) {

980 
	grow_™em
.
add_æags
(
d–‘e_b™
);

981  
d–_»tuº_ty³
(
Œue
,rue);

987 ià(!
	gv”siÚ_ad­‹r
::
£Ëù_fÜ_upd©e
(
row_™em
, 
e
->
v”siÚ
()))

988 
	gabÜt
;

989 
ãnû
();

990 ià(
	ge
->
	gd–‘ed
)

991 
	gabÜt
;

992 
	grow_™em
.
add_æags
(
d–‘e_b™
);

994 ià(!
»gi¡”_š‹ºode_v”siÚ
(
Í
.
node
(),†p.
fuÎ_v”siÚ_v®ue
()))

995 
	gabÜt
;

998  
d–_»tuº_ty³
(
Œue
, 
found
);

1000 
	gabÜt
:

1001  
d–_»tuº_ty³
(
çl£
, false);

1004 
	g‹m¶©e
 <
ty³Çme
 
	gC®lback
, 
boŞ
 
	gRev”£
>

1005 
boŞ
 
¿nge_sÿn
(cÚ¡ 
key_ty³
& 
begš
, cÚ¡ key_ty³& 
’d
, 
C®lback
 
ÿÎback
,

1006 
¡d
::
š™Ÿliz”_li¡
<
cŞumn_acûss_t
> 
acûs£s
, 
boŞ
 
phªtom_´ÙeùiÚ
 = 
Œue
, 
lim™
 = -1) {

1007 
as£¹
((
lim™
 == -1) || (limit > 0));

1008 autØ
	gnode_ÿÎback
 = [&] (
Ëaf_ty³
* 
node
,

1009 
ty³Çme
 
	guÆocked_cursÜ_ty³
::
nodev”siÚ_v®ue_ty³
 
v”siÚ
) {

1010  ((!
phªtom_´ÙeùiÚ
è|| 
»gi¡”_š‹ºode_v”siÚ
(
node
, 
v”siÚ
));

1013 autØ
	gûÎ_acûs£s
 = 
cŞumn_to_ûÎ_acûs£s
(
v®ue_cÚš”_ty³
::
m­
, 
acûs£s
);

1015 autØ
	gv®ue_ÿÎback
 = [&] (cÚ¡ 
lcdf
::
SŒ
& 
key
, 
š‹º®_–em
 *
	ge
, 
	gboŞ
& 
	g»t
) {

1016 
T¿nsProxy
 
	grow_™em
 = 
šdex_»ad_my_wr™e
 ? 
Sto
::
™em
(
this
, 
™em_key_t
::
row_™em_key
(
e
))

1017 : 
Sto
::
äesh_™em
(
this
, 
™em_key_t
::
row_™em_key
(
e
));

1019 
boŞ
 
	gªy_has_wr™e
;

1020 
	g¡d
::
veùÜ
<
T¿nsProxy
> 
ûÎ_™ems
;

1021 
	g¡d
::
t›
(
ªy_has_wr™e
, 
ûÎ_™ems
èğ
exŒaù_™em_li¡
(
ûÎ_acûs£s
, 
e
);

1023 ià(
	gšdex_»ad_my_wr™e
) {

1024 ià(
has_d–‘e
(
row_™em
)) {

1025 
	g»t
 = 
Œue
;

1026  
	gŒue
;

1028 ià(
	gªy_has_wr™e
) {

1029 ià(
has_š£¹
(
row_™em
))

1030 
	g»t
 = 
ÿÎback
(
key_ty³
(
key
), 
e
->
row_cÚš”
.
row
);

1032 
	g»t
 = 
ÿÎback
(
key_ty³
(
key
), *(
row_™em
.
‹m¶©e
 
¿w_wr™e_v®ue
<
v®ue_ty³
 *>()));

1033  
	gŒue
;

1037 
boŞ
 
	gok
 = 
acûss_®l
(
ûÎ_acûs£s
, 
ûÎ_™ems
, 
e
);

1038 ià(!
	gok
)

1039  
	gçl£
;

1048 ià(!
	ge
->
v®id
()) {

1049 
	g»t
 = 
Œue
;

1050  
	gŒue
;

1053 
	g»t
 = 
ÿÎback
(
key_ty³
(
key
), 
e
->
row_cÚš”
.
row
);

1054  
	gŒue
;

1057 
	g¿nge_sÿÂ”
<
deşty³
(
node_ÿÎback
), deşty³(
v®ue_ÿÎback
), 
	gRev”£
>

1058 
sÿÂ”
(
’d
, 
node_ÿÎback
, 
v®ue_ÿÎback
);

1059 ià(
	gRev”£
)

1060 
	gbË_
.
rsÿn
(
begš
, 
Œue
, 
sÿÂ”
, 
lim™
, *
ti
);

1062 
	gbË_
.
sÿn
(
begš
, 
Œue
, 
sÿÂ”
, 
lim™
, *
ti
);

1063  
	gsÿÂ”
.
	gsÿn_sucûeded_
;

1066 
	g‹m¶©e
 <
ty³Çme
 
	gC®lback
, 
boŞ
 
	gRev”£
>

1067 
boŞ
 
¿nge_sÿn
(cÚ¡ 
key_ty³
& 
begš
, cÚ¡ key_ty³& 
’d
, 
C®lback
 
ÿÎback
,

1068 
RowAcûss
 
acûss
, 
boŞ
 
phªtom_´ÙeùiÚ
 = 
Œue
, 
lim™
 = -1) {

1069 
as£¹
((
lim™
 == -1) || (limit > 0));

1070 autØ
	gnode_ÿÎback
 = [&] (
Ëaf_ty³
* 
node
,

1071 
ty³Çme
 
	guÆocked_cursÜ_ty³
::
nodev”siÚ_v®ue_ty³
 
v”siÚ
) {

1072  ((!
phªtom_´ÙeùiÚ
è|| 
»gi¡”_š‹ºode_v”siÚ
(
node
, 
v”siÚ
));

1075 autØ
	gv®ue_ÿÎback
 = [&] (cÚ¡ 
lcdf
::
SŒ
& 
key
, 
š‹º®_–em
 *
	ge
, 
	gboŞ
& 
	g»t
) {

1076 
T¿nsProxy
 
	grow_™em
 = 
šdex_»ad_my_wr™e
 ? 
Sto
::
™em
(
this
, 
™em_key_t
::
row_™em_key
(
e
))

1077 : 
Sto
::
äesh_™em
(
this
, 
™em_key_t
::
row_™em_key
(
e
));

1079 ià(
	gšdex_»ad_my_wr™e
) {

1080 ià(
has_d–‘e
(
row_™em
)) {

1081 
	g»t
 = 
Œue
;

1082  
	gŒue
;

1084 ià(
has_row_upd©e
(
row_™em
)) {

1085 ià(
has_š£¹
(
row_™em
))

1086 
	g»t
 = 
ÿÎback
(
key_ty³
(
key
), 
e
->
row_cÚš”
.
row
);

1088 
	g»t
 = 
ÿÎback
(
key_ty³
(
key
), *(
row_™em
.
‹m¶©e
 
¿w_wr™e_v®ue
<
v®ue_ty³
 *>()));

1089  
	gŒue
;

1093 
boŞ
 
	gok
 = 
Œue
;

1094 
	gacûss
) {

1095 
	gRowAcûss
::
Ob£rveV®ue
:

1096 
RowAcûss
::
Ob£rveExi¡s
:

1097 
ok
 = 
row_™em
.
ob£rve
(
e
->
v”siÚ
());

1099 
	gRowAcûss
::
NÚe
:

1102 
®ways_as£¹
(
çl£
, "unsupported‡ccessype in„ange_scan");

1106 ià(!
	gok
)

1107  
	gçl£
;

1110 ià(!
	ge
->
v®id
()) {

1111 
	g»t
 = 
Œue
;

1112  
	gŒue
;

1115 
	g»t
 = 
ÿÎback
(
key_ty³
(
key
), 
e
->
row_cÚš”
.
row
);

1116  
	gŒue
;

1119 
	g¿nge_sÿÂ”
<
deşty³
(
node_ÿÎback
), deşty³(
v®ue_ÿÎback
), 
	gRev”£
>

1120 
sÿÂ”
(
’d
, 
node_ÿÎback
, 
v®ue_ÿÎback
);

1121 ià(
	gRev”£
)

1122 
	gbË_
.
rsÿn
(
begš
, 
Œue
, 
sÿÂ”
, 
lim™
, *
ti
);

1124 
	gbË_
.
sÿn
(
begš
, 
Œue
, 
sÿÂ”
, 
lim™
, *
ti
);

1125  
	gsÿÂ”
.
	gsÿn_sucûeded_
;

1128 
v®ue_ty³
 *
nÚŒªs_g‘
(cÚ¡ 
key_ty³
& 
k
) {

1129 
uÆocked_cursÜ_ty³
 
Í
(
bË_
, 
k
);

1130 
boŞ
 
	gfound
 = 
Í
.
fšd_uÆocked
(*
ti
);

1131 ià(
	gfound
) {

1132 
š‹º®_–em
 *
	ge
 = 
Í
.
v®ue
();

1133  &(
	ge
->
	grow_cÚš”
.
	grow
);

1135  
	gnuÎ±r
;

1138 
nÚŒªs_put
(cÚ¡ 
key_ty³
& 
k
, cÚ¡ 
v®ue_ty³
& 
v
) {

1139 
cursÜ_ty³
 
Í
(
bË_
, 
k
);

1140 
boŞ
 
	gfound
 = 
Í
.
fšd_š£¹
(*
ti
);

1141 ià(
	gfound
) {

1142 
š‹º®_–em
 *
	ge
 = 
Í
.
v®ue
();

1143 ià(
	gv®ue_is_sm®l
)

1144 
	ge
->
	grow_cÚš”
.
	grow
 = 
v
;

1146 
cİy_row
(
e
, &
v
);

1147 
	gÍ
.
fšish
(0, *
ti
);

1149 
š‹º®_–em
 *
	ge
 = 
Ãw
 iÁ”Çl_–em(
k
, 
v
, 
Œue
);

1150 
	gÍ
.
v®ue
(èğ
e
;

1151 
	gÍ
.
fšish
(1, *
ti
);

1156 
boŞ
 
lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
 &
txn
è
	gov”ride
 {

1157 
as£¹
(!
is_š‹ºode
(
™em
));

1158 autØ
	gkey
 = 
™em
.
key
<
™em_key_t
>();

1159 autØ
	ge
 = 
key
.
š‹º®_–em_±r
();

1160 ià(
	gkey
.
is_row_™em
())

1161  
	gtxn
.
Œy_lock
(
™em
, 
e
->
v”siÚ
());

1163  
	gtxn
.
Œy_lock
(
™em
, 
e
->
row_cÚš”
.
v”siÚ_©
(
key
.
ûÎ_num
()));

1166 
boŞ
 
check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
	gov”ride
 {

1167 ià(
is_š‹ºode
(
™em
)) {

1168 
node_ty³
 *
	gn
 = 
g‘_š‹ºode_add»ss
(
™em
);

1169 autØ
	gcu¼_nv
 = 
¡©ic_ÿ¡
<
Ëaf_ty³
 *>(
n
)->
fuÎ_v”siÚ_v®ue
();

1170 autØ
	g»ad_nv
 = 
™em
.
‹m¶©e
 
»ad_v®ue
<
deşty³
(
cu¼_nv
)>();

1171  (
	gcu¼_nv
 =ğ
»ad_nv
);

1173 autØ
	gkey
 = 
™em
.
key
<
™em_key_t
>();

1174 autØ
	ge
 = 
key
.
š‹º®_–em_±r
();

1175 ià(
	gkey
.
is_row_™em
())

1176  
	ge
->
v”siÚ
().
ı_check_v”siÚ
(
txn
, 
™em
);

1178  
	ge
->
	grow_cÚš”
.
v”siÚ_©
(
key
.
ûÎ_num
()).
ı_check_v”siÚ
(
txn
, 
™em
);

1182 
š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
	gov”ride
 {

1183 
as£¹
(!
is_š‹ºode
(
™em
));

1184 autØ
	gkey
 = 
™em
.
key
<
™em_key_t
>();

1185 autØ
	ge
 = 
key
.
š‹º®_–em_±r
();

1187 ià(
	gkey
.
is_row_™em
()) {

1189 ià(
has_d–‘e
(
™em
)) {

1190 ià(!
has_š£¹
(
™em
)) {

1191 
as£¹
(
e
->
v®id
(è&& !e->
d–‘ed
);

1192 
	gtxn
.
£t_v”siÚ
(
e
->
v”siÚ
());

1193 
	ge
->
	gd–‘ed
 = 
Œue
;

1194 
ãnû
();

1199 
v®ue_ty³
 *
	gv±r
;

1200 ià(
	gv®ue_is_sm®l
) {

1201 
	gv±r
 = &(
™em
.
wr™e_v®ue
<
v®ue_ty³
>());

1203 
	gv±r
 = 
™em
.
wr™e_v®ue
<
v®ue_ty³
 *>();

1206 ià(!
has_š£¹
(
™em
)) {

1207 ià(
has_row_upd©e
(
™em
)) {

1208 ià(
	gv®ue_is_sm®l
) {

1209 
	ge
->
	grow_cÚš”
.
	grow
 = *
v±r
;

1211 
cİy_row
(
e
, 
v±r
);

1213 } ià(
has_row_ûÎ
(
™em
)) {

1217 
	ge
->
	grow_cÚš”
.
š¡®l_ûÎ
(0, 
v±r
);

1223 
	gtxn
.
£t_v”siÚ_uÆock
(
e
->
v”siÚ
(), 
™em
);

1226 autØ
	grow_™em
 = 
Sto
::
™em
(
this
, 
™em_key_t
::
row_™em_key
(
e
));

1227 ià(!
has_row_upd©e
(
row_™em
)) {

1228 
v®ue_ty³
 *
	gv±r
;

1229 ià(
	gv®ue_is_sm®l
)

1230 
	gv±r
 = &(
row_™em
.
‹m¶©e
 
¿w_wr™e_v®ue
<
v®ue_ty³
>());

1232 
	gv±r
 = 
row_™em
.
‹m¶©e
 
¿w_wr™e_v®ue
<
v®ue_ty³
 *>();

1234 
	ge
->
	grow_cÚš”
.
š¡®l_ûÎ
(
key
.
ûÎ_num
(), 
v±r
);

1237 
	gtxn
.
£t_v”siÚ_uÆock
(
e
->
row_cÚš”
.
v”siÚ_©
(
key
.
ûÎ_num
()), 
™em
);

1241 
uÆock
(
T¿nsI‹m
& 
™em
è
	gov”ride
 {

1242 
as£¹
(!
is_š‹ºode
(
™em
));

1243 autØ
	gkey
 = 
™em
.
key
<
™em_key_t
>();

1244 autØ
	ge
 = 
key
.
š‹º®_–em_±r
();

1245 ià(
	gkey
.
is_row_™em
())

1246 
	ge
->
v”siÚ
().
ı_uÆock
(
™em
);

1248 
	ge
->
	grow_cÚš”
.
v”siÚ_©
(
key
.
ûÎ_num
()).
ı_uÆock
(
™em
);

1251 
ş—nup
(
T¿nsI‹m
& 
™em
, 
boŞ
 
comm™‹d
è
	gov”ride
 {

1252 ià(
	gcomm™‹d
 ? 
has_d–‘e
(
™em
è: 
has_š£¹
(item)) {

1253 autØ
key
 = 
™em
.key<
™em_key_t
>();

1254 
as£¹
(
key
.
is_row_™em
());

1255 
š‹º®_–em
 *
	ge
 = 
key
.
š‹º®_–em_±r
();

1256 
boŞ
 
	gok
 = 
_»move
(
e
->
key
);

1257 ià(!
	gok
) {

1258 
	g¡d
::
cout
 << 
comm™‹d
 << "," << 
has_d–‘e
(
™em
è<< "," << 
has_š£¹
(™emè<< 
¡d
::
’dl
;

1259 
®ways_as£¹
(
çl£
, "insert-bitƒxclusive ownership violated");

1261 
	g™em
.
ş—r_Ãeds_uÆock
();

1265 
	g´Ùeùed
:

1266 
‹m¶©e
 <
ty³Çme
 
NodeC®lback
,y³Çm
	gV®ueC®lback
, 
boŞ
 
	gRev”£
>

1267 şas 
	c¿nge_sÿÂ”
 {

1268 
	gpublic
:

1269 
¿nge_sÿÂ”
(cÚ¡ 
SŒ
 
uµ”
, 
NodeC®lback
 
ncb
, 
V®ueC®lback
 
vcb
) :

1270 
bound¬y_
(
uµ”
), 
bound¬y_com·r_
(
çl£
), 
sÿn_sucûeded_
(
Œue
),

1271 
node_ÿÎback_
(
ncb
), 
v®ue_ÿÎback_
(
vcb
) {}

1273 
	g‹m¶©e
 <
ty³Çme
 
	gITER
,y³Çm
	gKEY
>

1274 
check
(cÚ¡ 
ITER
& 
™”
, cÚ¡ 
KEY
& 
key
) {

1275 
	gmš
 = 
¡d
::
mš
(
bound¬y_
.
Ëngth
(), 
key
.
´efix_Ëngth
());

1276 
	gcmp
 = 
memcmp
(
bound¬y_
.
d©a
(), 
key
.
fuÎ_¡ršg
().d©a(), 
mš
);

1277 ià(!
	gRev”£
) {

1278 ià(
	gcmp
 < 0 || (cm°=ğ0 && 
bound¬y_
.
Ëngth
(è<ğ
key
.
´efix_Ëngth
()))

1279 
bound¬y_com·r_
 = 
Œue
;

1280 ià(
	gcmp
 == 0) {

1281 
ušt64_t
 
Ï¡_ikey
 = 
™”
.
node
()->
ikey0_
[™”.
³rmutiÚ
()[™”.³rmutiÚ().
size
() - 1]];

1282 
ušt64_t
 
	g¦iû
 = 
¡ršg_¦iû
<ušt64_t>::
make_com·¿bË
(
bound¬y_
.
d©a
(è+ 
key
.
´efix_Ëngth
(),

1283 
¡d
::
mš
(
bound¬y_
.
Ëngth
(è- 
key
.
´efix_Ëngth
(), 8));

1284 
	gbound¬y_com·r_
 = (
¦iû
 <ğ
Ï¡_ikey
);

1287 ià(
	gcmp
 >= 0)

1288 
bound¬y_com·r_
 = 
Œue
;

1292 
	g‹m¶©e
 <
ty³Çme
 
	gITER
>

1293 
vis™_Ëaf
(cÚ¡ 
ITER
& 
™”
, cÚ¡ 
Mas¡»e
::
key
<
ušt64_t
>& key, 
th»adšfo
&) {

1294 ià(!
node_ÿÎback_
(
™”
.
node
(), i‹r.
fuÎ_v”siÚ_v®ue
())) {

1295 
	gsÿn_sucûeded_
 = 
çl£
;

1297 ià(
	gthis
->
	gbound¬y_
) {

1298 
check
(
™”
, 
key
);

1302 
boŞ
 
vis™_v®ue
(cÚ¡ 
Mas¡»e
::
key
<
ušt64_t
>& key, 
š‹º®_–em
 *
e
, 
th»adšfo
&) {

1303 ià(
	gthis
->
	gbound¬y_com·r_
) {

1304 ià((
	gRev”£
 && (
	gbound¬y_
 >ğ
key
.
fuÎ_¡ršg
())) ||

1305 (!
Rev”£
 && (
bound¬y_
 <ğ
key
.
fuÎ_¡ršg
())))

1306  
çl£
;

1308 
boŞ
 
	gvis™ed
 = 
çl£
;

1309 ià(!
v®ue_ÿÎback_
(
key
.
fuÎ_¡ršg
(), 
e
, 
vis™ed
)) {

1310 
	gsÿn_sucûeded_
 = 
çl£
;

1311  
	gçl£
;

1313 ià(!
	gvis™ed
)

1314 
	gsÿn_sucûeded_
 = 
çl£
;

1315  
	gvis™ed
;

1319 
SŒ
 
	gbound¬y_
;

1320 
boŞ
 
	gbound¬y_com·r_
;

1321 
boŞ
 
	gsÿn_sucûeded_
;

1323 
NodeC®lback
 
	gnode_ÿÎback_
;

1324 
V®ueC®lback
 
	gv®ue_ÿÎback_
;

1327 
	g´iv©e
:

1328 
bË_ty³
 
bË_
;

1329 
ušt64_t
 
	gkey_g’_
;

1331 
	g¡d
::
·œ
<
boŞ
, std::
veùÜ
<
T¿nsProxy
>>

1332 
exŒaù_™em_li¡
(cÚ¡ 
¡d
::
veùÜ
<
ûÎ_acûss_t
>& 
ûÎ_acûs£s
, 
š‹º®_–em
 *
e
) {

1333 
boŞ
 
	gªy_has_wr™e
 = 
çl£
;

1334 
	g¡d
::
veùÜ
<
T¿nsProxy
> 
ûÎ_™ems
;

1335 
	gûÎ_™ems
.
»£rve
(
ûÎ_acûs£s
.
size
());

1336 auto& 
	gÿ
 : 
ûÎ_acûs£s
) {

1337 autØ
™em
 = 
Sto
::™em(
this
, 
™em_key_t
(
e
, 
ÿ
.
ûÎ_id
));

1338 ià(
	gšdex_»ad_my_wr™e
 && !
	gªy_has_wr™e
 && 
	g™em
.
has_wr™e
())

1339 
	gªy_has_wr™e
 = 
Œue
;

1340 
	gûÎ_™ems
.
push_back
(
¡d
::
move
(
™em
));

1342  {
	gªy_has_wr™e
, 
	gûÎ_™ems
};

1345 
boŞ


1346 
acûss_®l
(
¡d
::
veùÜ
<
ûÎ_acûss_t
>& 
ûÎ_acûs£s
, std::veùÜ<
T¿nsProxy
>& 
ûÎ_™ems
, 
š‹º®_–em
 *
e
) {

1347 autØ
	g™
 = 
ûÎ_™ems
.
begš
(); iˆ!ğûÎ_™ems.
’d
(); ++it) {

1348 autØ
	gidx
 = 
™
 - 
ûÎ_™ems
.
begš
();

1349 auto& 
	gacûss
 = 
ûÎ_acûs£s
[
idx
];

1350 ià(
	gacûss
.
	gupd©e
) {

1351 ià(!
	gv”siÚ_ad­‹r
::
£Ëù_fÜ_upd©e
(*
™
, 
e
->
row_cÚš”
.
v”siÚ_©
(
acûss
.
ûÎ_id
)))

1352  
	gçl£
;

1353 ià(
	g™
->
™em
().
	gkey
<
	g™em_key_t
>().
is_row_™em
()) {

1354 
	g™
->
™em
().
add_æags
(
row_ûÎ_b™
);

1357 ià(!
	g™
->
ob£rve
(
e
->
row_cÚš”
.
v”siÚ_©
(
acûss
.
ûÎ_id
)))

1358  
	gçl£
;

1361  
	gŒue
;

1364 
boŞ
 
has_š£¹
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

1365  (
	g™em
.
æags
(è& 
	gš£¹_b™
) != 0;

1367 
boŞ
 
has_d–‘e
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

1368  (
	g™em
.
æags
(è& 
	gd–‘e_b™
) != 0;

1370 
boŞ
 
has_row_upd©e
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

1371  (
	g™em
.
æags
(è& 
	grow_upd©e_b™
) != 0;

1373 
boŞ
 
has_row_ûÎ
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

1374  (
	g™em
.
æags
(è& 
	grow_ûÎ_b™
) != 0;

1376 
boŞ
 
is_phªtom
(
š‹º®_–em
 *
e
, cÚ¡ 
T¿nsI‹m
& 
™em
) {

1377  (!
	ge
->
v®id
(è&& !
has_š£¹
(
™em
));

1380 
boŞ
 
»gi¡”_š‹ºode_v”siÚ
(
node_ty³
 *
node
, 
nodev”siÚ_v®ue_ty³
 
nodev”siÚ
) {

1381 
T¿nsProxy
 
	g™em
 = 
Sto
::
™em
(
this
, 
g‘_š‹ºode_key
(
node
));

1382 ià(
	gDBP¬ams
::
O·que
)

1383  
™em
.
add_»ad_İaque
(
nodev”siÚ
);

1385  
	g™em
.
add_»ad
(
nodev”siÚ
);

1387 
boŞ
 
upd©e_š‹ºode_v”siÚ
(
node_ty³
 *
node
,

1388 
nodev”siÚ_v®ue_ty³
 
´ev_nv
,‚odev”siÚ_v®ue_ty³ 
Ãw_nv
) {

1389 
T¿nsProxy
 
	g™em
 = 
Sto
::
™em
(
this
, 
g‘_š‹ºode_key
(
node
));

1390 ià(!
	g™em
.
has_»ad
()) {

1391  
	gŒue
;

1393 ià(
	g´ev_nv
 =ğ
™em
.
‹m¶©e
 
»ad_v®ue
<
nodev”siÚ_v®ue_ty³
>()) {

1394 
™em
.
upd©e_»ad
(
´ev_nv
, 
Ãw_nv
);

1395  
	gŒue
;

1397  
	gçl£
;

1400 
boŞ
 
_»move
(cÚ¡ 
key_ty³
& 
key
) {

1401 
cursÜ_ty³
 
Í
(
bË_
, 
key
);

1402 
boŞ
 
	gfound
 = 
Í
.
fšd_locked
(*
ti
);

1403 ià(
	gfound
) {

1404 
š‹º®_–em
 *
	g–
 = 
Í
.
v®ue
();

1405 
	gÍ
.
fšish
(-1, *
ti
);

1406 
	gT¿n§ùiÚ
::
rcu_d–‘e
(
–
);

1409 
	gÍ
.
fšish
(0, *
ti
);

1411  
	gfound
;

1414 
ušŒ_t
 
g‘_š‹ºode_key
(
node_ty³
* 
node
) {

1415  
	g»š‹½»t_ÿ¡
<
	gušŒ_t
>(
	gnode
è| 
	gš‹ºode_b™
;

1417 
boŞ
 
is_š‹ºode
(
T¿nsI‹m
& 
™em
) {

1418  (
	g™em
.
	gkey
<
	gušŒ_t
>(è& 
	gš‹ºode_b™
) != 0;

1420 
node_ty³
 *
g‘_š‹ºode_add»ss
(
T¿nsI‹m
& 
™em
) {

1421 
as£¹
(
is_š‹ºode
(
™em
));

1422  
	g»š‹½»t_ÿ¡
<
	gnode_ty³
 *>(
	g™em
.
	gkey
<
	gušŒ_t
>(è& ~
	gš‹ºode_b™
);

1425 
cİy_row
(
š‹º®_–em
 *
e
, cÚ¡ 
v®ue_ty³
 *
Ãw_row
) {

1426 ià(
	gÃw_row
 =ğ
nuÎ±r
)

1428 
	ge
->
	grow_cÚš”
.
	grow
 = *
Ãw_row
;

1432 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gV
,y³Çm
	gDBP¬ams
>

1433 
__th»ad
 
ty³Çme
 
	gÜd”ed_šdex
<
	gK
, 
	gV
, 
	gDBP¬ams
>::
bË_·¿ms
::
th»adšfo_ty³


1434 *
Üd”ed_šdex
<
K
, 
	gV
, 
	gDBP¬ams
>::
ti
;

	@benchmark/DB_params.hh

1 #´agm¨
Úû


3 
Çme¥aû
 
	gdb_·¿ms
 {

6 
cÚ¡ex´
 cÚ¡ *
	gdb_·¿ms_id_Çmes
[] = {"none", "default", "opaque", "2pl", "adaptive", "swiss", "tictoc"};

8 şas 
	cdb_·¿ms_id
 : {

9 
NÚe
 = 0, 
	gDeçuÉ
, 
	gO·que
, 
	gTwoPL
, 
	gAd­tive
, 
	gSwiss
, 
	gTicToc


12 
šlše
 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(
¡d
::o¡»am &
os
, cÚ¡ 
	gdb_·¿ms_id
 &
	gid
) {

13 
	gos
 << 
	gdb_·¿ms_id_Çmes
[
¡©ic_ÿ¡
<>(
id
)];

14  
	gos
;

17 
šlše
 
db_·¿ms_id
 
	$·r£_dbid
(cÚ¡ *
id_¡ršg
) {

18 ià(
id_¡ršg
 =ğ
nuÎ±r
)

19  
db_·¿ms_id
::
NÚe
;

20 
size_t
 
i
 = 0; i < (
db_·¿ms_id_Çmes
); ++i) {

21 ià(
	`¡rcmp
(
id_¡ršg
, 
db_·¿ms_id_Çmes
[
i
]) == 0) {

22 autØ
£Ëùed
 = 
¡©ic_ÿ¡
<
db_·¿ms_id
>(
i
);

23 
¡d
::
cout
 << "S–eùed \"" << 
£Ëùed
 << "\"‡ DB cÚcu¼’cy cÚŒŞ." << std::
’dl
;

24  
£Ëùed
;

27  
db_·¿ms_id
::
NÚe
;

28 
	}
}

30 şas 
	cdb_deçuÉ_·¿ms
 {

31 
	gpublic
:

32 
cÚ¡ex´
 
db_·¿ms_id
 
Id
 = db_·¿ms_id::
DeçuÉ
;

33 
cÚ¡ex´
 
boŞ
 
	gRdMyWr
 = 
çl£
;

34 
cÚ¡ex´
 
boŞ
 
	gTwoPha£Lock
 = 
çl£
;

35 
cÚ¡ex´
 
boŞ
 
	gAd­tive
 = 
çl£
;

36 
cÚ¡ex´
 
boŞ
 
	gO·que
 = 
çl£
;

37 
cÚ¡ex´
 
boŞ
 
	gSwiss
 = 
çl£
;

38 
cÚ¡ex´
 
boŞ
 
	gTicToc
 = 
çl£
;

41 şas 
	cdb_İaque_·¿ms
 : 
public
 
db_deçuÉ_·¿ms
 {

42 
public
:

43 
cÚ¡ex´
 
db_·¿ms_id
 
Id
 = db_·¿ms_id::
O·que
;

44 
cÚ¡ex´
 
boŞ
 
	gO·que
 = 
Œue
;

47 şas 
	cdb_2¶_·¿ms
 : 
public
 
db_deçuÉ_·¿ms
 {

48 
public
:

49 
cÚ¡ex´
 
db_·¿ms_id
 
Id
 = db_·¿ms_id::
TwoPL
;

50 
cÚ¡ex´
 
boŞ
 
	gTwoPha£Lock
 = 
Œue
;

53 şas 
	cdb_ad­tive_·¿ms
 : 
public
 
db_deçuÉ_·¿ms
 {

54 
public
:

55 
cÚ¡ex´
 
db_·¿ms_id
 
Id
 = db_·¿ms_id::
Ad­tive
;

56 
cÚ¡ex´
 
boŞ
 
	gAd­tive
 = 
Œue
;

59 şas 
	cdb_swiss_·¿ms
 : 
public
 
db_deçuÉ_·¿ms
 {

60 
public
:

61 
cÚ¡ex´
 
db_·¿ms_id
 
Id
 = db_·¿ms_id::
Swiss
;

62 
cÚ¡ex´
 
boŞ
 
	gSwiss
 = 
Œue
;

65 şas 
	cdb_tiùoc_·¿ms
 : 
public
 
db_deçuÉ_·¿ms
 {

66 
public
:

67 
cÚ¡ex´
 
db_·¿ms_id
 
Id
 = db_·¿ms_id::
TicToc
;

68 
cÚ¡ex´
 
boŞ
 
	gTicToc
 = 
Œue
;

71 şas 
	ccÚ¡ªts
 {

72 
	gpublic
:

73 
cÚ¡ex´
 
mliÚ
 = 1000000.0;

74 
cÚ¡ex´
 
	gbliÚ
 = 1000.0 * 
mliÚ
;

75 
	g´oûssÜ_tsc_äequ’cy
;

	@benchmark/DB_profiler.hh

1 #´agm¨
Úû


3 
	~"Sy¡emProf”.hh
"

4 
	~"T¿n§ùiÚ.hh
"

5 
	~"DB_·¿ms.hh
"

7 
Çme¥aû
 
	gb’ch
 {

9 şas 
	cdb_´of”
 {

10 
	gpublic
:

11 
usšg
 
cÚ¡ªts
 = 
db_·¿ms
::constants;

12 
ex¶ic™
 
db_´of”
(
boŞ
 
¥awn_³rf
)

13 : 
¥awn_³rf_
(
¥awn_³rf
), 
³rf_pid_
(),

14 
¡¬t_tsc_
(), 
’d_tsc_
() {}

16 
¡¬t
(
Prof”
::
³rf_mode
 
mode
) {

17 ià(
¥awn_³rf_
)

18 
³rf_pid_
 = 
Prof”
::
¥awn
("³rf", 
mode
);

19 
	g¡¬t_tsc_
 = 
»ad_tsc
();

22 
ušt64_t
 
¡¬t_time¡amp
() const {

23  
	g¡¬t_tsc_
;

26 
fšish
(
size_t
 
num_txns
) {

27 
	g’d_tsc_
 = 
»ad_tsc
();

28 ià(
	g¥awn_³rf_
) {

29 
boŞ
 
	gok
 = 
Prof”
::
¡İ
(
³rf_pid_
);

30 
®ways_as£¹
(
ok
, "killing…rofiler");

33 
ušt64_t
 
	g–­£d_tsc
 = 
’d_tsc_
 - 
¡¬t_tsc_
;

34 
	g–­£d_time
 = (è
–­£d_tsc
 / 
cÚ¡ªts
::
mliÚ
 / cÚ¡ªts::
´oûssÜ_tsc_äequ’cy
;

35 
	g¡d
::
cout
 << "EÏp£dime: " << 
–­£d_tsc
 << "icks" << 
¡d
::
’dl
;

36 
	g¡d
::
cout
 << "R—Ètime: " << 
–­£d_time
 << " ms" << 
¡d
::
’dl
;

37 
	g¡d
::
cout
 << "Throughput: " << (è
num_txns
 / (
–­£d_time
 / 1000.0è<< "xns/£c" << 
¡d
::
’dl
;

40 
	gT¿n§ùiÚ
::
´št_¡©s
();

43 
	g´iv©e
:

44 
boŞ
 
¥awn_³rf_
;

45 
pid_t
 
	g³rf_pid_
;

46 
ušt64_t
 
	g¡¬t_tsc_
;

47 
ušt64_t
 
	g’d_tsc_
;

	@benchmark/DB_structs.hh

1 #´agm¨
Úû


3 
	~"cÚfig.h
"

5 
	~<¡ršg
>

6 
	~<c¡ršg
>

7 
	~<by‹sw­.h
>

9 
	~"¡r.hh
"

11 
Çme¥aû
 
	gb’ch
 {

13 
	g‹m¶©e
<
size_t
 
	gML
>

14 şas 
	c__©Œibu‹__
((
·cked
)è
	gv¬_¡ršg
 {

15 
	gpublic
:

16 
cÚ¡ex´
 
size_t
 
max_Ëngth
 = 
ML
;

18 
v¬_¡ršg
() {

19 
bz”o
(
s_
, 
ML
 + 1);

22 
v¬_¡ršg
(cÚ¡ *
c_¡r
) {

23 
š™Ÿlize_äom
(
c_¡r
);

26 
v¬_¡ršg
(cÚ¡ 
¡d
::
¡ršg
 &
¡r
) {

27 
š™Ÿlize_äom
(
¡r
);

30 
v¬_¡ršg
(cÚ¡ v¬_¡ršg &
v¡r
) {

31 
š™Ÿlize_äom
(
v¡r
);

34 
boŞ
 
	gİ”©Ü
==(cÚ¡ *
c_¡r
) const {

35  !
¡ºcmp
(
s_
, 
c_¡r
, 
ML
);

38 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
¡d
::
¡ršg
 &
¡r
) const {

39  !
¡ºcmp
(
s_
, 
¡r
.
c_¡r
(), 
ML
);

42 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
v¬_¡ršg
 &
rhs
) const {

43  !
¡ºcmp
(
s_
, 
rhs
.s_, 
ML
);

46 
	gİ”©Ü
[](
size_t
 
	gidx
) const {

47  
	gs_
[
idx
];

50 
	gv¬_¡ršg
 &
	gİ”©Ü
=(cÚ¡ 
v¬_¡ršg
 &
rhs
) {

51 
š™Ÿlize_äom
(
rhs
);

52  *
	gthis
;

55 
	gv¬_¡ršg
 &
	gİ”©Ü
=(cÚ¡ 
v¬_¡ršg
 &
rhs
) volatile {

56 
š™Ÿlize_äom
(
rhs
);

57  *
	gcÚ¡_ÿ¡
<
	gv¬_¡ršg
 *>(
	gthis
);

60 
ex¶ic™
 
İ”©Ü
 
	g¡d
::
¡ršg
() {

61  
¡d
::
¡ršg
(
s_
);

64 
boŞ
 
cÚšs
(cÚ¡ *
sub¡r
) const {

65  (
¡r¡r
(
s_
, 
sub¡r
è!ğ
nuÎ±r
);

68 
size_t
 
Ëngth
() const {

69  
¡¾’
(
s_
);

72 
boŞ
 
¶aû
(cÚ¡ *
¡r
, 
size_t
 
pos
) {

73 
size_t
 
	gš_Ën
 = 
¡¾’
(
¡r
);

74 ià(
	gpos
 + 
	gš_Ën
 > 
Ëngth
())

75  
	gçl£
;

76 
memıy
(
s_
 + 
pos
, 
¡r
, 
š_Ën
);

77  
	gŒue
;

80 cÚ¡ *
c_¡r
() const {

81  
	gs_
;

84 *
c_¡r
() {

85  
	gs_
;

88 cÚ¡ *
c_¡r
() const volatile {

89  
	gs_
;

92 *
c_¡r
() volatile {

93  
	gcÚ¡_ÿ¡
<*>(
	gs_
);

96 
	gä›nd
 ::
¡d
::
hash
<
v¬_¡ršg
>;

98 
	g´iv©e
:

99 
š™Ÿlize_äom
(cÚ¡ *
c_¡r
) {

100 
bz”o
(
s_
, 
ML
 + 1);

101 
¡ºıy
(
s_
, 
c_¡r
, 
ML
);

104 
š™Ÿlize_äom
(cÚ¡ 
¡d
::
¡ršg
 &
¡r
) {

105 
š™Ÿlize_äom
(
¡r
.
c_¡r
());

108 
š™Ÿlize_äom
(cÚ¡ 
v¬_¡ršg
 &
v¡r
) {

109 
memıy
(
s_
, 
v¡r
.s_, 
ML
 + 1);

112 
š™Ÿlize_äom
(cÚ¡ 
v¬_¡ršg
 &
v¡r
) volatile {

113 
memıy
(
cÚ¡_ÿ¡
<*>(
s_
), 
v¡r
.s_, 
ML
 + 1);

116 
	gs_
[
ML
 + 1];

119 
	g‹m¶©e
<
size_t
 
	gFL
>

120 şas 
	c__©Œibu‹__
((
·cked
)è
	gfix_¡ršg
 {

121 
	gpublic
:

122 
fix_¡ršg
() {

123 
mem£t
(
s_
, ' ', 
FL
);

126 
fix_¡ršg
(cÚ¡ *
c_¡r
) {

127 
mem£t
(
s_
, ' ', 
FL
);

128 
¡ºıy
(
s_
, 
c_¡r
, 
FL
);

131 
fix_¡ršg
(cÚ¡ 
¡d
::
¡ršg
 &
¡r
) {

132 
mem£t
(
s_
, ' ', 
FL
);

133 
¡ºıy
(
s_
, 
¡r
.
c_¡r
(), 
FL
);

136 
boŞ
 
	gİ”©Ü
==(cÚ¡ *
c_¡r
) const {

137  
¡¾’
(
c_¡r
è=ğ
FL
 && !
memcmp
(
s_
, c_str, FL);

140 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
fix_¡ršg
 &
rhs
) const {

141  !
memcmp
(
s_
, 
rhs
.s_, 
FL
);

144 &
	gİ”©Ü
[](
size_t
 
	gidx
) {

145  
	gs_
[
idx
];

148 
	gİ”©Ü
[](
size_t
 
	gidx
) const {

149  
	gs_
[
idx
];

152 
	gfix_¡ršg
 &
	gİ”©Ü
=(cÚ¡ 
fix_¡ršg
 &
rhs
) {

153 
š™Ÿlize_äom
(
rhs
);

154  *
	gthis
;

157 
	gfix_¡ršg
 &
	gİ”©Ü
=(cÚ¡ 
fix_¡ršg
 &
rhs
) volatile {

158 
š™Ÿlize_äom
(
rhs
);

159  
	gcÚ¡_ÿ¡
<
	gfix_¡ršg
 &>(*
	gthis
);

162 
ex¶ic™
 
İ”©Ü
 
	g¡d
::
¡ršg
() {

163  
¡d
::
¡ršg
(
s_
, 
FL
);

166 
š£¹_Ëá
(cÚ¡ *
buf
, 
size_t
 
út
) {

167 
memmove
(
s_
 + 
út
, s_, 
FL
 - cnt);

168 
memıy
(
s_
, 
buf
, 
út
);

171 
	gä›nd
 ::
¡d
::
hash
<
fix_¡ršg
>;

173 
	g´iv©e
:

174 
š™Ÿlize_äom
(cÚ¡ *
c_¡r
) {

175 
mem£t
(
s_
, ' ', 
FL
);

176 
size_t
 
	gËn
 = 
¡¾’
(
c_¡r
);

177 
size_t
 
	gi
 = 0; i < 
	gËn
 && i < 
	gFL
; ++i)

178 
	gs_
[
i
] = 
c_¡r
[i];

181 
š™Ÿlize_äom
(cÚ¡ 
¡d
::
¡ršg
 &
¡r
) {

182 
š™Ÿlize_äom
(
¡r
);

185 
š™Ÿlize_äom
(cÚ¡ 
fix_¡ršg
 &
f¡r
) {

186 
memıy
(
s_
, 
f¡r
.s_, 
FL
);

189 
š™Ÿlize_äom
(cÚ¡ 
fix_¡ršg
 &
f¡r
) volatile {

190 
memıy
(
cÚ¡_ÿ¡
<*>(
s_
), 
f¡r
.s_, 
FL
);

193 
	gs_
[
FL
];

197 
	g‹m¶©e
<
ty³Çme
 
	gIÁTy³
>

198 
šlše
 
IÁTy³
 
	$bsw­
(
IÁTy³
 
x
) {

199 ià((
IÁTy³
) == 4)

200  
	`__bsw­_32
(
x
);

201 ià((
IÁTy³
) == 8)

202  
	`__bsw­_64
(
x
);

204 
	`®ways_as£¹
(
çl£
);

205 
	}
}

207 
	sdummy_row
 {

208 şas 
	cNamedCŞumn
 : { 
dummy
 = 0 };

209 
ušŒ_t
 
	gdummy
;

212 
	g‹m¶©e
 <
ty³Çme
 
	gK
>

213 
	gmas¡»e_key_ad­‹r
 : 
public
 
K
 {

215 
ex¶ic™
 
mas¡»e_key_ad­‹r
(cÚ¡ 
lcdf
::
SŒ
& 
mt_key
) {

216 
as£¹
(
mt_key
.
Ëngth
(è=ğ(*
this
));

217 
memıy
(
this
, 
mt_key
.
d©a
(), (*this));

220 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

221 
ex¶ic™
 
mas¡»e_key_ad­‹r
(
Args
&&... 
¬gs
)

222 : 
K
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {}

224 
İ”©Ü
 
lcdf
::
SŒ
() const {

225  
lcdf
::
SŒ
((cÚ¡ *)
this
, (*this));

	@benchmark/MicroBenchmarks.cc

1 
	~<şp.h
>

2 
	~"TPCC_b’ch.hh
"

3 
	~"MiüoB’chm¬ks.hh
"

4 
	~"şp.h
"

7 
	gub’ch
::
UB’chP¬ams
 
ub’ch
::
·¿ms
;

10 
	gcc
::
cÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
;

13 
	mİt_ccid
 = 1,

14 
	mİt_ty³
,

15 
	mİt_keysz
,

16 
	mİt_Á¿ns
,

17 
	mİt_Áhrs
,

18 
	mİt_İ¥tx
,

19 
	mİt_İ¥ro
,

20 
	mİt_skew
,

21 
	mİt_rİù
,

22 
	mİt_w½ù
,

23 
	mİt_time
,

24 
	mİt_³rf
,

25 
	mİt_dump
,

26 
	mİt_g¿n
,

27 
	mİt_šsm


30 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

31 { "ccid", 'i', 
İt_ccid
, 
CÍ_V®SŒšg
, 
CÍ_O±iÚ®
 },

32 { "d©©y³", 't', 
İt_ty³
, 
CÍ_V®SŒšg
, 
CÍ_O±iÚ®
 },

33 { "keysize", 'k', 
İt_keysz
, 
CÍ_V®UnsigÃdLÚg
, 
CÍ_O±iÚ®
 },

34 { "Á¿ns", 'x', 
İt_Á¿ns
, 
CÍ_V®UnsigÃd
, 
CÍ_O±iÚ®
 },

35 { "Áh»ads", 'j', 
İt_Áhrs
, 
CÍ_V®UnsigÃd
, 
CÍ_O±iÚ®
 },

36 { "İ¥”Œªs", 0, 
İt_İ¥tx
, 
CÍ_V®UnsigÃd
, 
CÍ_O±iÚ®
 },

37 { "İ¥”ro", 0, 
İt_İ¥ro
, 
CÍ_V®UnsigÃd
, 
CÍ_O±iÚ®
 },

38 { "skew", 's', 
İt_skew
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

39 { "»adÚly", 0, 
İt_rİù
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

40 { "wr™”©io", 0, 
İt_w½ù
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

41 { "time", 'l', 
İt_time
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

42 { "³rf", 'p', 
İt_³rf
, 
CÍ_NoV®
, 
CÍ_Neg©e
 | 
CÍ_O±iÚ®
 },

43 { "dump", 'd', 
İt_dump
, 
CÍ_NoV®
, 
CÍ_Neg©e
 | 
CÍ_O±iÚ®
 },

44 { "g¿nuË", 'g', 
İt_g¿n
, 
CÍ_V®UnsigÃd
, 
CÍ_O±iÚ®
 },

45 { "m—su»", 'm', 
İt_šsm
, 
CÍ_NoV®
, 
CÍ_Neg©e
 | 
CÍ_O±iÚ®
 }

48 
šlše
 
	$´št_u§ge
(cÚ¡ *
´og
) {

49 
¡d
::
¡ršg¡»am
 
ss
;

50 
ss
 << "U§ge: " << 
¡d
::
	`¡ršg
(
´og
è<< " [·¿m‘”s...]" << std::
’dl


51 << "Li¡ oàacû±ed…¬am‘”s:" << 
¡d
::
’dl


52 << " --ccid=STRING (-i), cÚcu¼’cy cÚŒŞ…Şicy. Acû±ed o±iÚ ¬e:" << 
¡d
::
’dl


53 << " deçuÉ, o·que, 2¶,‡d­tive, swiss,iùoc" << 
¡d
::
’dl


54 << " --d©©y³=STRING (-t), d©¨¡ruùu» u£dØruÀb’chm¬k. (Now oÆy suµÜt mas¡»e.)" << 
¡d
::
’dl


55 << " --keysize=NUMBER (-k), sizoàkey s·û u£d iÀthb’chm¬k (likARRAY_SZ), deçuÉ 10 mliÚ" << 
¡d
::
’dl


56 << " --Á¿ns=NUMBER (-x),‚umb” oà´e-g’”©ed¿n§ùiÚ Öoİ ov” onû„un out), deçuÉ 2 mliÚ" << 
¡d
::
’dl


57 << " --Áh»ads=NUMBER (-j),‚umb” oàcÚcu¼’ˆth»ads, deçuÉ 4" << 
¡d
::
’dl


58 << " --İ¥”Œªs=NUMBER,‚umb” oàİ”©iÚ ³¸Œª§ùiÚ, deçuÉ 20" << 
¡d
::
’dl


59 << " --İ¥”ro=NUMBER,‚umb” oàİ”©iÚ š„—d-Úly¿n§ùiÚs, deçuÉ tØİ¥”Œª v®ue" << 
¡d
::
’dl


60 << " --skew=FLOAT, Zàskew (th‘aè·¿m‘” u£dØg’”©wÜklßd, deçuÉ 0.8" << 
¡d
::
’dl


61 << " --»adÚly=FRACTION, f¿ùiÚ oàŒª§ùiÚ th©‡»„—d-Úly, deçuÉ 0.8" << 
¡d
::
’dl


62 << " --wr™”©io=FRACTION, f¿ùiÚ oàİ”©iÚ š‚Ú-»ad-Úly¿n§ùiÚ th©‡» wr™es, deçuÉ 0.2" << 
¡d
::
’dl


63 << " --time=FLOAT (-l), du¿tiÚ (š secÚdsèfÜ whichhb’chm¬k i run, deçuÉ 5.0" << 
¡d
::
’dl


64 << " --³rà(-p), s·wÀ³rà´of”‡á”hb’chm¬k s¹ executšg, deçuÉ off" << 
¡d
::
’dl


65 << " --dum°(-d), dum°thŒaû oà®Èg’”©ed¿n§ùiÚ ÒÙ funùiÚ® fÜ‚ow)" << 
¡d
::
’dl


66 << " --g¿nuË (-gè£Ëùhg¿nuÏr™y oàcÚcu¼’cy cÚŒŞ" << 
¡d
::
’dl


67 << " --m—su» (-m),ƒÇbË in¡ªÃou m—su»m’t oàthroughpuˆªd o±imi¡iø»ad„©es, deçuÉ off" << 
¡d
::
’dl
;

69 
¡d
::
cout
 << 
ss
.
	`¡r
(è<< std::
æush
;

70 
	}
}

72 
	g‹m¶©e
 <
	gG
, 
ty³Çme
 
	gP
, 
boŞ
 
	gInsM—su»
>

73 
usšg
 
	g‹¡”
 = 
ty³Çme
 
¡d
::
cÚd™iÚ®
<
InsM—su»
,

74 
	gub’ch
::
MtZfTe¡”M—su»
<
G
, 
	gP
>,

75 
	gub’ch
::
MtZfTe¡”DeçuÉ
<
G
, 
	gP
>>::
ty³
;

77 
	g‹m¶©e
 <
	gG
, 
boŞ
 
	gInsM—su»
>

78 
šlše
 
	$š¡ªtŸ‹_ªd_execu‹_‹¡”s
() {

79 
usšg
 
ub’ch
::
MtZfTe¡”DeçuÉ
;

80 
usšg
 
ub’ch
::
MtZfTe¡”M—su»
;

81 
usšg
 
ub’ch
::
·¿ms
;

82 
usšg
 
cc
::
db_·¿ms_id
;

84 
·¿ms
.
dbid
) {

85 
db_·¿ms_id
::
DeçuÉ
: {

86 
ty³Çme
 
‹¡”
<
G
, 
cc
::
db_deçuÉ_·¿ms
, 
InsM—su»
>::
ty³
 
	`t
(
·¿ms
.
Áh»ads
);

87 
t
.
	`execu‹
();

90 
db_·¿ms_id
::
O·que
: {

91 
ty³Çme
 
‹¡”
<
G
, 
cc
::
db_İaque_·¿ms
, 
InsM—su»
>::
ty³
 
	`t
(
·¿ms
.
Áh»ads
);

92 
t
.
	`execu‹
();

95 
db_·¿ms_id
::
TwoPL
: {

96 
ty³Çme
 
‹¡”
<
G
, 
cc
::
db_2¶_·¿ms
, 
InsM—su»
>::
ty³
 
	`t
(
·¿ms
.
Áh»ads
);

97 
t
.
	`execu‹
();

100 
db_·¿ms_id
::
Ad­tive
: {

101 
ty³Çme
 
‹¡”
<
G
, 
cc
::
db_ad­tive_·¿ms
, 
InsM—su»
>::
ty³
 
	`t
(
·¿ms
.
Áh»ads
);

102 
t
.
	`execu‹
();

105 
db_·¿ms_id
::
Swiss
: {

106 
ty³Çme
 
‹¡”
<
G
, 
cc
::
db_swiss_·¿ms
, 
InsM—su»
>::
ty³
 
	`t
(
·¿ms
.
Áh»ads
);

107 
t
.
	`execu‹
();

110 
db_·¿ms_id
::
TicToc
: {

111 
ty³Çme
 
‹¡”
<
G
, 
cc
::
db_tiùoc_·¿ms
, 
InsM—su»
>::
ty³
 
	`t
(
·¿ms
.
Áh»ads
);

112 
t
.
	`execu‹
();

116 
¡d
::
û¼
 << "šv®id ccid" << std::
’dl
;

117 
	`abÜt
();

119 
	}
}

121 
	g‹m¶©e
 <
	gG
>

122 
šlše
 
	$š¡ªtŸ‹_ªd_exec_ou‹r
(
boŞ
 
šs_m—su»
) {

123 ià(
šs_m—su»
)

124 
š¡ªtŸ‹_ªd_execu‹_‹¡”s
<
G
, 
Œue
>();

126 
š¡ªtŸ‹_ªd_execu‹_‹¡”s
<
G
, 
çl£
>();

127 
	}
}

129 
	$maš
(
¬gc
, cÚ¡ *
¬gv
[]) {

130 
usšg
 
ub’ch
::
·¿ms
;

131 
usšg
 
cc
::
db_·¿ms_id
;

134 
·¿ms
.
dbid
 = 
db_·¿ms_id
::
DeçuÉ
;

135 
·¿ms
.
d©©y³
 = 
ub’ch
::
DsTy³
::
mas¡»e
;

136 
·¿ms
.
time_lim™
 = 5.0;

137 
·¿ms
.
zf_skew
 = 0.8;

138 
·¿ms
.
key_sz
 = 10000000;

139 
·¿ms
.
»adÚly_³rûÁ
 = 0.8;

140 
·¿ms
.
wr™e_³rûÁ
 = 0.2;

141 
·¿ms
.
İ¥”Œªs
 = 20;

142 
·¿ms
.
İ¥”Œªs_ro
 =…¬ams.
İ¥”Œªs
;

143 
·¿ms
.
Á¿ns
 = 2000000;

144 
·¿ms
.
Áh»ads
 = 4;

145 
·¿ms
.
´oc_äequ’cy_hz
 = 0;

146 
·¿ms
.
dump_Œaû
 = 
çl£
;

147 
·¿ms
.
´of”
 = 
çl£
;

148 
·¿ms
.
g¿nuËs
 = 1;

149 
·¿ms
.
šs_m—su»
 = 
çl£
;

151 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
	`¬¿ysize
(
İtiÚs
), options);

153 
İt
;

154 
»t
 = 0;

155 
boŞ
 
şp_¡İ
 = 
çl£
;

156 
boŞ
 
ro_¥ecif›d
 = 
çl£
;

157 !
şp_¡İ
 && ((
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
)) {

158 
İt
) {

159 
İt_ccid
:

160 
·¿ms
.
dbid
 = 
cc
::
	`·r£_dbid
(
şp
->
v®
.
s
);

162 
İt_ty³
:

163 
·¿ms
.
d©©y³
 = 
ub’ch
::
	`·r£_d©©y³
(
şp
->
v®
.
s
);

165 
İt_keysz
:

166 
·¿ms
.
key_sz
 = 
şp
->
v®
.
ul
;

168 
İt_Á¿ns
:

169 
·¿ms
.
Á¿ns
 = 
şp
->
v®
.
u
;

171 
İt_Áhrs
:

172 
·¿ms
.
Áh»ads
 = 
şp
->
v®
.
u
;

174 
İt_İ¥tx
:

175 
·¿ms
.
İ¥”Œªs
 = 
şp
->
v®
.
u
;

177 
İt_İ¥ro
:

178 
·¿ms
.
İ¥”Œªs_ro
 = 
şp
->
v®
.
u
;

179 
ro_¥ecif›d
 = 
Œue
;

181 
İt_skew
:

182 
·¿ms
.
zf_skew
 = 
şp
->
v®
.
d
;

184 
İt_rİù
: {

185 autØ
d
 = 
şp
->
v®
.d;

186 
	`®ways_as£¹
(
d
 <= 1.0 && d >= 0.0, "invalid„eadonly„atio");

187 
·¿ms
.
»adÚly_³rûÁ
 = 
d
;}

189 
İt_w½ù
: {

190 autØ
d
 = 
şp
->
v®
.d;

191 
	`®ways_as£¹
(
d
 <= 1.0 && d >= 0.0, "invalid write„atio");

192 
·¿ms
.
wr™e_³rûÁ
 = 
d
;}

194 
İt_time
: {

195 autØ
d
 = 
şp
->
v®
.d;

196 
	`®ways_as£¹
(
d
 > 0.0, "invalidime†imit");

197 
·¿ms
.
time_lim™
 = 
d
;}

199 
İt_³rf
:

200 
·¿ms
.
´of”
 = !
şp
->
Ãg©ed
;

202 
İt_dump
:

203 
·¿ms
.
dump_Œaû
 = !
şp
->
Ãg©ed
;

205 
İt_g¿n
:

206 
·¿ms
.
g¿nuËs
 = 
şp
->
v®
.
u
;

208 
İt_šsm
:

209 
·¿ms
.
šs_m—su»
 = !
şp
->
Ãg©ed
;

212 
	`´št_u§ge
(
¬gv
[0]);

213 
»t
 = 1;

214 
şp_¡İ
 = 
Œue
;

218 ià(!
ro_¥ecif›d
)

219 
·¿ms
.
İ¥”Œªs_ro
 =…¬ams.
İ¥”Œªs
;

221 
	`CÍ_D–‘eP¬£r
(
şp
);

223 ià(
»t
 != 0)

224  
»t
;

226 autØ
äeq
 = 
	`d‘”mše_ıu_äeq
();

227 ià(
äeq
 == 0.0)

229 
cc
::
cÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
 = 
äeq
;

230 
·¿ms
.
´oc_äequ’cy_hz
 = (
ušt64_t
)(
äeq
 * 
cc
::
cÚ¡ªts
::
bliÚ
);

232 
	`®ways_as£¹
(
·¿ms
.
d©©y³
 =ğ
ub’ch
::
DsTy³
::
mas¡»e
, "Only Masstree is currently supported");

234 
·¿ms
.
g¿nuËs
) {

236 
š¡ªtŸ‹_ªd_exec_ou‹r
<1>(
·¿ms
.
šs_m—su»
);

239 
š¡ªtŸ‹_ªd_exec_ou‹r
<2>(
·¿ms
.
šs_m—su»
);

242 
š¡ªtŸ‹_ªd_exec_ou‹r
<4>(
·¿ms
.
šs_m—su»
);

245 
š¡ªtŸ‹_ªd_exec_ou‹r
<8>(
·¿ms
.
šs_m—su»
);

248 
¡d
::
û¼
 << "E¼Ü: g¿nuÏr™y=" << 
·¿ms
.
g¿nuËs
 << "‚Ù suµÜ‹d." << std::
’dl
;

249 
	`abÜt
();

252 
¡d
::
cout
 << 
·¿ms
 << std::
’dl
;

253 
T¿n§ùiÚ
::
	`´št_¡©s
();

256 
	}
}

	@benchmark/MicroBenchmarks.hh

1 #´agm¨
Úû


3 
	~<io¡»am
>

4 
	~<veùÜ
>

5 
	~<¡ršg
>

6 
	~<£t
>

7 
	~<th»ad
>

9 
	~"Sto.hh
"

10 
	~"DB_´of”.hh
"

11 
	~"DB_¡ruùs.hh
"

12 
	~"DB_šdex.hh
"

13 
	~"DB_·¿ms.hh
"

15 
	~"Miüo_¡ruùs.hh
"

17 
	~"§m¶šg.hh
"

18 
	~"PÏtfÜmF—tu»s.hh
"

20 
Çme¥aû
 
	gub’ch
 {

22 
usšg
 
Çme¥aû
 
	gdb_·¿ms
;

23 
usšg
 
	gb’ch
::
db_´of”
;

25 şas 
	cDsTy³
 : {
nÚe
, 
	gmas¡»e
};

27 cÚ¡ *
	gd©©y³_Çmes
[] = {"none", "masstree"};

29 
šlše
 
DsTy³
 
	$·r£_d©©y³
(cÚ¡ *
s
) {

30 ià(
s
 =ğ
nuÎ±r
)

31  
DsTy³
::
nÚe
;

33 
size_t
 
i
 = 0; i < (
d©©y³_Çmes
); ++i) {

34 ià(
¡d
::
	`¡ršg
(
d©©y³_Çmes
[
i
]è=ğ¡d::¡ršg(
s
))

35  
¡©ic_ÿ¡
<
DsTy³
>(
i
);

37  
DsTy³
::
nÚe
;

38 
	}
}

40 
	sUB’chP¬ams
 {

41 
db_·¿ms_id
 
	gdbid
;

42 
DsTy³
 
	gd©©y³
;

43 
ušt32_t
 
	gÁ¿ns
;

44 
ušt32_t
 
	gÁh»ads
;

45 
ušt32_t
 
	gİ¥”Œªs
;

46 
ušt32_t
 
	gİ¥”Œªs_ro
;

47 
ušt64_t
 
	gkey_sz
;

48 
	gtime_lim™
;

49 
	gzf_skew
;

50 
	g»adÚly_³rûÁ
;

51 
	gwr™e_³rûÁ
;

52 
ušt64_t
 
	g´oc_äequ’cy_hz
;

53 
boŞ
 
	gdump_Œaû
;

54 
boŞ
 
	g´of”
;

55 
ušt32_t
 
	gg¿nuËs
;

56 
boŞ
 
	gšs_m—su»
;

59 
šlše
 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
os
, cÚ¡ 
	gUB’chP¬ams
& 
	gp
) {

60 
	gos
 << "B’chm¬k fšished usšg CC=" << 
	gcc
::
db_·¿ms_id_Çmes
[
¡©ic_ÿ¡
<>(
p
.
dbid
)] << ", ";

61 
	gos
 << "d©©y³=" << 
	gd©©y³_Çmes
[
¡©ic_ÿ¡
<>(
p
.
d©©y³
)] << " with "

62 << 
	gp
.
	gÁh»ads
 << "h»ads" << 
	g¡d
::
’dl
;

63 
	gos
 << 
	gp
.
	gÁ¿ns
 << "xns, " <<….
	gİ¥”Œªs
 << " ops/txÀ(" <<….
	gİ¥”Œªs_ro


64 << " iÀ»ad-Úlyxns)" << 
	g¡d
::
’dl
;

65 
	gos
 << "R—d-Úly f¿ùiÚ = " << 
	gp
.
	g»adÚly_³rûÁ
 << ", wr™¿tiØğ" <<….
	gwr™e_³rûÁ
 << 
	g¡d
::
’dl
;

66 
	gos
 << "zàskew = " << 
	gp
.
	gzf_skew
 << ", " << "key s·û sizğ" <<….
	gkey_sz
 << 
	g¡d
::
’dl
;

67  
	gos
;

70 
UB’chP¬ams
 
·¿ms
;

72 şas 
	cOpTy³
 : {
»ad
, 
	gwr™e
, 
	gšc
};

74 
	sRWO³¿tiÚ
 {

75 
št64_t
 
	tv®ue_ty³
;

76 
RWO³¿tiÚ
(è: 
ty³
(
OpTy³
::
»ad
), 
key
(), 
v®ue
() {}

77 
RWO³¿tiÚ
(
OpTy³
 
t
, 
§m¶šg
::
šdex_t
 
k
, 
v®ue_ty³
 
v
 = value_type())

78 : 
ty³
(
t
), 
key
(
k
), 
v®ue
(
v
) {}

80 
OpTy³
 
	gty³
;

81 
	g§m¶šg
::
šdex_t
 
key
;

82 
v®ue_ty³
 
	gv®ue
;

85 
šlše
 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
os
, cÚ¡ 
	gRWO³¿tiÚ
& 
	gİ
) {

86 
	gos
 << "[";

87 ià(
	gİ
.
	gty³
 =ğ
OpTy³
::
»ad
) {

88 
os
 << "r,k=" << 
İ
.
key
;

89 } ià(
	gİ
.
	gty³
 =ğ
OpTy³
::
wr™e
) {

90 
os
 << "w,k=" << 
İ
.
key
 << ",v=" << op.
v®ue
;

92 
as£¹
(
İ
.
ty³
 =ğ
OpTy³
::
šc
);

93 
	gos
 << "šc,k=" << 
	gİ
.
	gkey
;

95 
	gos
 << "]";

96  
	gos
;

99 
	g‹m¶©e
 <
	gG¿nuËs
>

100 
	swl_deçuÉ_·¿ms
 {

101 
cÚ¡ex´
 
boŞ
 
	gš¡ªÃous_m—su»m’ts
 = 
çl£
;

102 
cÚ¡ex´
 
	gg¿nuËs
 = 
G¿nuËs
;

105 
	g‹m¶©e
 <
	gG¿nuËs
>

106 
	gwl_m—su»m’t_·¿ms
 : 
public
 
wl_deçuÉ_·¿ms
<
G¿nuËs
> {

107 
cÚ¡ex´
 
boŞ
 
š¡ªÃous_m—su»m’ts
 = 
Œue
;

110 
	g‹m¶©e
 <>

111 
	scompu‹_v®ue_ty³
 {

114 
	g‹m¶©e
 <>

115 
	gcompu‹_v®ue_ty³
<1> {

116 
Úe_v”siÚ_row
 
	tty³
;

119 
	g‹m¶©e
 <>

120 
	gcompu‹_v®ue_ty³
<2> {

121 
two_v”siÚ_row
 
	tty³
;

124 
	g‹m¶©e
 <>

125 
	gcompu‹_v®ue_ty³
<4> {

126 
four_v”siÚ_row
 
	tty³
;

129 
	g‹m¶©e
 <>

130 
	gcompu‹_v®ue_ty³
<8> {

131 
eight_v”siÚ_row
 
	tty³
;

134 
	g‹m¶©e
 <
ty³Çme
 
	gWLIm¶
>

135 şas 
	cWÜklßdG’”©Ü
 {

136 
	gpublic
:

137 
¡d
::
	tveùÜ
<
	tRWO³¿tiÚ
> 
	tqu”y_ty³
;

138 
	g¡d
::
	tveùÜ
<
	tqu”y_ty³
> 
	twÜklßd_ty³
;

140 
ex¶ic™
 
WÜklßdG’”©Ü
(
size_t
 
num_th»ads
) {

141 
	gwÜklßds
.
»size
(
num_th»ads
);

144 
wÜklßd_š™
(
th»ad_id
) {

145 
im¶
().
wÜklßd_š™_im¶
(
th»ad_id
);

148 
	g¡d
::
veùÜ
<
wÜklßd_ty³
> 
wÜklßds
;

150 
	g´Ùeùed
:

151 
WLIm¶
& 
im¶
() {

152  
¡©ic_ÿ¡
<
WLIm¶
&>(*
this
);

156 
	g‹m¶©e
 <
ty³Çme
 
	gDSIm¶
,y³Çm
	gWLIm¶
>

157 şas 
	cTe¡”
 {

158 
	gpublic
:

159 
¡d
::
	tveùÜ
<
	t¡d
::
	t·œ
<
	tušt64_t
, >> 
	tm—su»m’t_ty³
;

162 
cÚ¡ex´
 
boŞ
 
	gšs_m—su»
 = 
WLIm¶
::
RTP¬ams
::
š¡ªÃous_m—su»m’ts
;

164 
ex¶ic™
 
Te¡”
(
size_t
 
num_th»ads
è: 
wl_g’
(num_threads) {

165 
m—su»m’ts
.
»size
(
num_th»ads
);

166 auto& 
	gm
 : 
m—su»m’ts
) {

167 
m
.
»£rve
(10000);

171 
šlše
 
execu‹
();

172 
šlše
 
ušt64_t
 
run_b’chm¬k
(ušt64_ˆ
¡¬t_tsc
);

174 
wÜklßd_š™
(
th»ad_id
) {

175 
	gwl_g’
.
wÜklßd_š™
(
th»ad_id
);

177 
´•İuÏ‹
() {

178 
ds_im¶
().
´•İuÏ‹_im¶
();

180 
ds_th»ad_š™
() {

181 
ds_im¶
().
th»ad_š™_im¶
();

183 
šlše
 
run_th»ad
(
th»ad_id
, 
ušt64_t
 
¡¬t_tsc
, ušt64_t& 
txn_út
);

185 
boŞ
 
do_İ
(cÚ¡ 
RWO³¿tiÚ
& 
İ
) {

186  
ds_im¶
().
do_İ_im¶
(
İ
);

189 
	g´Ùeùed
:

190 
DSIm¶
& 
ds_im¶
() {

191  
¡©ic_ÿ¡
<
DSIm¶
&>(*
this
);

193 cÚ¡ 
	gDSIm¶
& 
ds_im¶
() const {

194  
	g¡©ic_ÿ¡
<cÚ¡ 
	gDSIm¶
&>(*
	gthis
);

197 
	gWÜklßdG’”©Ü
<
	gWLIm¶
> 
	gwl_g’
;

198 
	g¡d
::
veùÜ
<
m—su»m’t_ty³
> 
m—su»m’ts
;

201 
	g‹m¶©e
 <
ty³Çme
 
	gDSIm¶
,y³Çm
	gWLIm¶
>

202 
	gTe¡”
<
	gDSIm¶
, 
	gWLIm¶
>::
	$execu‹
() {

203 
db_´of”
 
	`´of”
(
·¿ms
.
´of”
);

204 
¡d
::
veùÜ
<¡d::
th»ad
> 
th»ad_poŞ
;

206 
¡d
::
cout
 << "G’”©šg wÜklßd..." << std::
’dl
;

207 autØ
i
 = 0u; i < 
·¿ms
.
Áh»ads
; ++i)

208 
th»ad_poŞ
.
	`em¶aû_back
(&
Te¡”
<
DSIm¶
, 
WLIm¶
>::
wÜklßd_š™
,

209 
this
, ()
i
);

210 auto& 
t
 : 
th»ad_poŞ
)

211 
t
.
	`još
();

212 
th»ad_poŞ
.
	`ş—r
();

213 
¡d
::
cout
 << "P»pİuÏtšg..." << std::
’dl
;

214 
	`´•İuÏ‹
();

215 
¡d
::
cout
 << "RuÂšg" << std::
’dl
;

217 
´of”
.
	`¡¬t
(
Prof”
::
³rf_mode
::
»cÜd
);

218 autØ
num_comm™s
 = 
	`run_b’chm¬k
(
´of”
.
	`¡¬t_time¡amp
());

219 
´of”
.
	`fšish
(
num_comm™s
);

220 
	}
}

222 
	g‹m¶©e
 <
ty³Çme
 
	gDSIm¶
,y³Çm
	gWLIm¶
>

223 
ušt64_t
 
	gTe¡”
<
	gDSIm¶
, 
	gWLIm¶
>::
	$run_b’chm¬k
(
ušt64_t
 
¡¬t_tsc
) {

224 
¡d
::
veùÜ
<¡d::
th»ad
> 
th»ad_poŞ
;

225 
ušt64_t
 
tÙ®_txns
 = 0;

227 
ušt64_t
 *
txn_úts
 = 
Ãw
 ušt64_t[
·¿ms
.
Áh»ads
];

228 autØ
i
 = 0u; i < 
·¿ms
.
Áh»ads
; ++i) {

229 
txn_úts
[
i
] = 0;

230 
th»ad_poŞ
.
	`em¶aû_back
(&
Te¡”
<
DSIm¶
, 
WLIm¶
>::
run_th»ad
,

231 
this
, ()
i
, 
¡¬t_tsc
, 
¡d
::
	`»f
(
txn_úts
[i]));

233 autØ
™
 = 
th»ad_poŞ
.
	`begš
(); iˆ!ğth»ad_poŞ.
	`’d
(); ++it) {

234 
™
->
	`još
();

235 
tÙ®_txns
 +ğ
txn_úts
[
™
 - 
th»ad_poŞ
.
	`begš
()];

237 
d–‘e
[] 
txn_úts
;

238  
tÙ®_txns
;

239 
	}
}

241 
	g‹m¶©e
 <
ty³Çme
 
	gDSIm¶
,y³Çm
	gWLIm¶
>

242 
	gTe¡”
<
	gDSIm¶
, 
	gWLIm¶
>::
	$run_th»ad
(
th»ad_id
, 
ušt64_t
 
¡¬t_tsc
, ušt64_t& 
txn_út
) {

243 
TTh»ad
::
	`£t_id
(
th»ad_id
);

244 
	`£t_affš™y
(
th»ad_id
);

245 
	`ds_th»ad_š™
();

248 auto& 
twl
 = 
wl_g’
.
wÜklßds
[
th»ad_id
];

250 
ušt64_t
 
loÿl_txn_út
 = 0;

252 
ušt64_t
 
š‹rv®
;

253 
ušt64_t
 
tÙ®_d–
;

254 
ty³Çme
 
WLIm¶
::
wÜklßd_ty³
::
cÚ¡_™”©Ü
 
™_´ev
;

255 
ušt64_t
 
´ev_tÙ®_»ads
;

256 
ušt64_t
 
´ev_tÙ®_İt_»ads
;

258 
ušt64_t
 
ticks_to_wa™
 = (ušt64_t)(
·¿ms
.
time_lim™
 * ()Õ¬ams.
´oc_äequ’cy_hz
));

260 ià(
šs_m—su»
) {

261 
š‹rv®
 = 10 * 
·¿ms
.
´oc_äequ’cy_hz
 / 1000;

262 
tÙ®_d–
 = 
š‹rv®
;

263 
™_´ev
 = 
twl
.
	`begš
();

264 
´ev_tÙ®_»ads
 = 0;

265 
´ev_tÙ®_İt_»ads
 = 0;

267 ()
š‹rv®
;

268 ()
tÙ®_d–
;

269 ()
™_´ev
;

270 ()
´ev_tÙ®_»ads
;

271 ()
´ev_tÙ®_İt_»ads
;

274 
boŞ
 
¡İ
 = 
çl£
;

275 !
¡İ
) {

276 autØ
txn_™
 = 
twl
.
	`begš
();xn_™ !ğtwl.
	`’d
(); ++txn_it) {

277 
TRANSACTION
 {

278 autØ&
»q
 : *
txn_™
) {

279 
boŞ
 
ok
 = 
	`do_İ
(
»q
);

280 
	`TXN_DO
(
ok
);

282 } 
	`RETRY
(
Œue
);

284 ++
loÿl_txn_út
;

285 
ušt64_t
 
now
 = 
	`»ad_tsc
();

288 ià(
šs_m—su»
) {

289 ià((
now
 - 
¡¬t_tsc
è>ğ
tÙ®_d–
) {

290 
tÙ®_d–
 +ğ
š‹rv®
;

291 autØ
Áxns
 = 
txn_™
 - 
™_´ev
;

292 
™_´ev
 = 
txn_™
;

294 autØ
tÙ®_»ads
 = 
	`TXP_INSPECT
(
txp_tÙ®_r
);

295 autØ
tÙ®_İt_»ads
 = 
	`TXP_INSPECT
(
txp_tÙ®_ad­tive_İt
);

297 
İt_¿‹
 =

298 (è(
tÙ®_İt_»ads
 - 
´ev_tÙ®_İt_»ads
è/ (
tÙ®_»ads
 - 
´ev_tÙ®_»ads
);

300 
´ev_tÙ®_»ads
 = 
tÙ®_»ads
;

301 
´ev_tÙ®_İt_»ads
 = 
tÙ®_İt_»ads
;

303 
m—su»m’ts
[
th»ad_id
].
	`em¶aû_back
(
Áxns
, 
İt_¿‹
);

307 ià((
now
 - 
¡¬t_tsc
è>ğ
ticks_to_wa™
) {

308 
¡İ
 = 
Œue
;

314 
txn_út
 = 
loÿl_txn_út
;

315 
	}
}

317 
	g‹m¶©e
 <
ty³Çme
 
	gP¬ams
>

318 
şass
 
	gWLZfRW
 : 
public
 
WÜklßdG’”©Ü
<
WLZfRW
<
P¬ams
>> {

319 
public
:

320 
WÜklßdG’”©Ü
<
	tWLZfRW
> 
	tWG
;

321 
P¬ams
 
	tRTP¬ams
;

323 
ex¶ic™
 
WLZfRW
(
size_t
 
num_th»ads
è: 
WG
(num_threads) {}

325 
wÜklßd_š™_im¶
(
th»ad_id
) {

326 
§m¶šg
::
	tStoRªdomDi¡ributiÚ
<>::
	tºg_ty³
„ng_type;

327 
ºg_ty³
 
ºg
(
th»ad_id
);

329 
	g§m¶šg
::
StoUnifÜmDi¡ributiÚ
<> 
ud
(
ºg
, 0, 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
max
());

330 
	g§m¶šg
::
StoRªdomDi¡ributiÚ
<> *
dd
 = 
nuÎ±r
;

332 ià(
	g·¿ms
.
	gzf_skew
 == 0.0)

333 
dd
 = 
Ãw
 
§m¶šg
::
StoUnifÜmDi¡ributiÚ
<>(
ºg
, 0, 
	g·¿ms
.
	gkey_sz
 - 1);

335 
	gdd
 = 
Ãw
 
§m¶šg
::
StoZfDi¡ributiÚ
<>(
ºg
, 0, 
	g·¿ms
.
	gkey_sz
 - 1,…¬ams.
	gzf_skew
);

337 autØ
	gro_th»shŞd
 = (
ušt32_t
)(
¡d
::
num”ic_lim™s
<ušt32_t>::
max
(è* 
·¿ms
.
»adÚly_³rûÁ
);

338 autØ
	gwr™e_th»shŞd
 = (
ušt32_t
)(
¡d
::
num”ic_lim™s
<ušt32_t>::
max
(è* 
·¿ms
.
wr™e_³rûÁ
);

340 auto& 
	gth»ad_wÜklßd
 = 
this
->
wÜklßds
[
th»ad_id
];

341 
ušt64_t
 
	gŒªs_³r_th»ad
 = 
·¿ms
.
Á¿ns
 /…¬ams.
Áh»ads
;

343 
ušt64_t
 
	gi
 = 0; i < 
	gŒªs_³r_th»ad
; ++i) {

344 
ty³Çme
 
	gWG
::
qu”y_ty³
 
qu”y
;

345 
boŞ
 
	g»ad_Úly
 = 
ud
.
§m¶e
(è< 
ro_th»shŞd
;

346 
	gnİs
 = 
»ad_Úly
 ? 
·¿ms
.
İ¥”Œªs_ro
 :…¬ams.
İ¥”Œªs
;

348 
	g¡d
::
£t
<
§m¶šg
::
šdex_t
> 
idx_£t
;

349 
	gidx_£t
.
size
(è!ğ(
size_t
)
nİs
) {

350 
idx_£t
.
š£¹
(
dd
->
§m¶e
());

353 autØ
	gidx
 : 
idx_£t
) {

354 ià(
»ad_Úly
)

355 
qu”y
.
em¶aû_back
(
OpTy³
::
»ad
, 
idx
);

357 ià(
	gud
.
§m¶e
(è< 
	gwr™e_th»shŞd
)

358 
	gqu”y
.
em¶aû_back
(
OpTy³
::
wr™e
, 
idx
, idx + 1);

360 
	gqu”y
.
em¶aû_back
(
OpTy³
::
»ad
, 
idx
);

363 
	gth»ad_wÜklßd
.
em¶aû_back
(
¡d
::
move
(
qu”y
));

366 ià(
	g·¿ms
.
	gdump_Œaû
)

367 
dump_th»ad_Œaû
(
th»ad_id
, 
th»ad_wÜklßd
);

369 
d–‘e
 
	gdd
;

373 
	g‹m¶©e
 <
ty³Çme
 
	gIÁTy³
>

374 
	sMas¡»eIÁKey
 {

375 
ex¶ic™
 
Mas¡»eIÁKey
(
IÁTy³
 
k
è: 
k_
(
cc
::
bsw­
(k)) {}

377 
İ”©Ü
 
lcdf
::
SŒ
() const {

378  
lcdf
::
SŒ
((cÚ¡ *)
this
, (*this));

381 
IÁTy³
 
	gk_
;

384 
	g‹m¶©e
 <
ty³Çme
 
	gWLIm¶
,y³Çm
	gDBP¬ams
>

385 
şass
 
	gMas¡»eTe¡”
 : 
public
 
Te¡”
<
Mas¡»eTe¡”
<
WLIm¶
, 
	gDBP¬ams
>, 
	gWLIm¶
> {

386 
	gpublic
:

387 
Te¡”
<
	tMas¡»eTe¡”
<
	tWLIm¶
, 
	tDBP¬ams
>, WLIm¶> 
	tBa£
;

388 
	gMas¡»eIÁKey
<
	t§m¶šg
::
	tšdex_t
> 
	tkey_ty³
;

389 
ty³Çme
 
	tcompu‹_v®ue_ty³
<
	tWLIm¶
::
	tRTP¬ams
::
	tg¿nuËs
>::
	tty³
 
	tv®ue_ty³
;

390 
ty³Çme
 
	tv®ue_ty³
::
	tNamedCŞumn
 
	tnc
;

391 
ty³Çme
 
	tcc
::
	tÜd”ed_šdex
<
	tkey_ty³
, 
	tv®ue_ty³
, 
	tDBP¬ams
> 
	tšdex_ty³
;

392 
ty³Çme
 
	tšdex_ty³
::
	tcŞumn_acûss_t
 column_access_t;

394 
ex¶ic™
 
Mas¡»eTe¡”
(
size_t
 
num_th»ads
è: 
Ba£
Òum_th»ads), 
mt_
() {}

396 
´•İuÏ‹_im¶
() {

397 
	gi
 = 0; i < 
	g·¿ms
.
	gkey_sz
; ++i)

398 
	gmt_
.
nÚŒªs_put
(
key_ty³
(
i
), {i, i, i, i, i, i, i, i});

401 
th»ad_š™_im¶
() {

402 
	gmt_
.
th»ad_š™
();

405 
boŞ
 
do_İ_im¶
(cÚ¡ 
RWO³¿tiÚ
& 
İ
) {

407 
boŞ
 
	gsucûss
;

408 
	gİ
.
	gty³
) {

409 
	gOpTy³
::
»ad
:

410 
¡d
::
t›
(
sucûss
, std::
ignÜe
, std::ignore, std::ignore)

411 ğ
mt_
.
£Ëù_row
(
key_ty³
(
İ
.
key
),

412 {{
nc
::
f1
, 
çl£
}, {nc::
f3
, f®£}, {nc::
f5
, f®£}, {nc::
f7
, false}});

414 
	gOpTy³
::
wr™e
: {

415 autØ
v
 = 
Sto
::
tx_®loc
<
v®ue_ty³
>();

416 *
	gv
 = {
İ
.
v®ue
, op.value, op.value, op.value, op.value, op.value, op.value, op.value};

417 
	g¡d
::
t›
(
sucûss
, 
¡d
::
ignÜe
èğ
mt_
.
š£¹_row
(
key_ty³
(
İ
.
key
), 
v
, 
Œue
);

420 
	gOpTy³
::
šc
: {

421 
ušŒ_t
 
rid
;

422 cÚ¡ 
v®ue_ty³
* 
	gv®ue
;

423 
	g¡d
::
t›
(
sucûss
, 
¡d
::
ignÜe
, 
rid
, 
v®ue
)

424 ğ
mt_
.
£Ëù_row
(
key_ty³
(
İ
.
key
),

425 {{
nc
::
f1
, 
Œue
}, {nc::
f3
,rue}, {nc::
f5
,rue}, {nc::
f7
,rue}});

426 ià(!
	gsucûss
)

428 
v®ue_ty³
 *
	gÃw_v
 = 
Sto
::
tx_®loc
(
v®ue
);

429 
	gÃw_v
->
	gf1
 += 1;

430 
	gÃw_v
->
	gf3
 += 1;

431 
	gÃw_v
->
	gf5
 += 1;

432 
	gÃw_v
->
	gf7
 += 1;

433 
	gmt_
.
upd©e_row
(
rid
, 
Ãw_v
);

437  
	gsucûss
;

440 
	g´iv©e
:

441 
šdex_ty³
 
mt_
;

444 
	g‹m¶©e
 <
DsTy³
 
	gDS
, 
ty³Çme
 
	gWLIm¶
,y³Çm
	gDBP¬ams
>

445 
	sTe¡”S–eùÜ
 {};

447 
	g‹m¶©e
 <
ty³Çme
 
	gWLIm¶
,y³Çm
	gDBP¬ams
>

448 
	gTe¡”S–eùÜ
<
	gDsTy³
::
mas¡»e
, 
	gWLIm¶
, 
	gDBP¬ams
> {

449 
	gMas¡»eTe¡”
<
	tWLIm¶
, 
	tDBP¬ams
> 
	tty³
;

452 
	g‹m¶©e
 <
	gG
, 
ty³Çme
 
	gDBP¬ams
>

453 
usšg
 
	gMtZfTe¡”DeçuÉ
 = 
Te¡”S–eùÜ
<
DsTy³
::
mas¡»e
, 
	gWLZfRW
<
	gwl_deçuÉ_·¿ms
<
	gG
>>, 
	gDBP¬ams
>;

455 
	g‹m¶©e
 <
	gG
, 
ty³Çme
 
	gDBP¬ams
>

456 
usšg
 
	gMtZfTe¡”M—su»
 = 
Te¡”S–eùÜ
<
DsTy³
::
mas¡»e
, 
	gWLZfRW
<
	gwl_m—su»m’t_·¿ms
<
	gG
>>, 
	gDBP¬ams
>;

	@benchmark/Micro_structs.hh

1 #´agm¨
Úû


7 
	sÚe_v”siÚ_row
 {

9 şas 
	cNamedCŞumn
 : { 
f1
 = 0, 
	mf2
, 
	mf3
, 
	mf4
, 
	mf5
, 
	mf6
, 
	mf7
, 
	mf8
 };

11 
št64_t
 
	gf1
;

12 
št64_t
 
	gf2
;

13 
št64_t
 
	gf3
;

14 
št64_t
 
	gf4
;

15 
št64_t
 
	gf5
;

16 
št64_t
 
	gf6
;

17 
št64_t
 
	gf7
;

18 
št64_t
 
	gf8
;

23 
	stwo_v”siÚ_row
 {

25 şas 
	cNamedCŞumn
 : { 
f1
 = 0, 
	mf2
, 
	mf3
, 
	mf4
, 
	mf5
, 
	mf6
, 
	mf7
, 
	mf8
 };

27 
št64_t
 
	gf1
;

28 
št64_t
 
	gf2
;

29 
št64_t
 
	gf3
;

30 
št64_t
 
	gf4
;

31 
št64_t
 
	gf5
;

32 
št64_t
 
	gf6
;

33 
št64_t
 
	gf7
;

34 
št64_t
 
	gf8
;

39 
	sfour_v”siÚ_row
 {

41 şas 
	cNamedCŞumn
 : { 
f1
 = 0, 
	mf2
, 
	mf3
, 
	mf4
, 
	mf5
, 
	mf6
, 
	mf7
, 
	mf8
 };

43 
št64_t
 
	gf1
;

44 
št64_t
 
	gf2
;

45 
št64_t
 
	gf3
;

46 
št64_t
 
	gf4
;

47 
št64_t
 
	gf5
;

48 
št64_t
 
	gf6
;

49 
št64_t
 
	gf7
;

50 
št64_t
 
	gf8
;

55 
	seight_v”siÚ_row
 {

57 şas 
	cNamedCŞumn
 : { 
f1
 = 0, 
	mf2
, 
	mf3
, 
	mf4
, 
	mf5
, 
	mf6
, 
	mf7
, 
	mf8
 };

59 
št64_t
 
	gf1
;

60 
št64_t
 
	gf2
;

61 
št64_t
 
	gf3
;

62 
št64_t
 
	gf4
;

63 
št64_t
 
	gf5
;

64 
št64_t
 
	gf6
;

65 
št64_t
 
	gf7
;

66 
št64_t
 
	gf8
;

71 
Çme¥aû
 
	gv”_£l
 {

73 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

74 
şass
 
	gV”S–
<
	gÚe_v”siÚ_row
, 
	gV”sIm¶
> : 
public
 
V”S–Ba£
<
V”S–
<
Úe_v”siÚ_row
, VersImpl>, VersImpl> {

75 
	gpublic
:

76 
V”sIm¶
 
	tv”siÚ_ty³
;

77 
cÚ¡ex´
 
size_t
 
	gnum_v”siÚs
 = 1;

79 
ex¶ic™
 
V”S–
(
ty³
 
v
è: 
v”s_
() { ()v; }

80 
V”S–
(
ty³
 
v
, 
boŞ
 
š£¹
è: 
v”s_
(è{ ()v; ()
	gš£¹
; }

82 
m­_im¶
(
cŞ_n
) {

83 
ušt64_t
 
	gmask
 = ~(~0uÈ<< 
vidx_width
) ;

84 
	gshiá
 = 
cŞ_n
 * 
vidx_width
;

85  ((
	gcŞ_ûÎ_m­
 & (
	gmask
 << 
	gshiá
)) >> shift);

88 
	gv”siÚ_ty³
& 
v”siÚ_©_im¶
(
ûÎ
) {

89  
	gv”s_
[
ûÎ
];

92 
š¡®l_by_ûÎ_im¶
(
Úe_v”siÚ_row
 *
d¡
, cÚ¡ oÃ_v”siÚ_row *
¤c
, 
ûÎ
) {

93 
	gûÎ
) {

95 
d¡
->
f1
 = 
¤c
->f1;

96 
	gd¡
->
	gf2
 = 
¤c
->
f2
;

97 
	gd¡
->
	gf3
 = 
¤c
->
f3
;

98 
	gd¡
->
	gf4
 = 
¤c
->
f4
;

99 
	gd¡
->
	gf5
 = 
¤c
->
f5
;

100 
	gd¡
->
	gf6
 = 
¤c
->
f6
;

101 
	gd¡
->
	gf7
 = 
¤c
->
f7
;

102 
	gd¡
->
	gf8
 = 
¤c
->
f8
;

105 
®ways_as£¹
(
çl£
, "cell id out of bound\n");

110 
	g´iv©e
:

111 
v”siÚ_ty³
 
v”s_
[
num_v”siÚs
];

112 
cÚ¡ex´
 
	gvidx_width
 = 0u;

113 
cÚ¡ex´
 
ušt64_t
 
	gcŞ_ûÎ_m­
 = 0ul;

117 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

118 
şass
 
	gV”S–
<
	gtwo_v”siÚ_row
, 
	gV”sIm¶
> : 
public
 
V”S–Ba£
<
V”S–
<
two_v”siÚ_row
, VersImpl>, VersImpl> {

119 
	gpublic
:

120 
V”sIm¶
 
	tv”siÚ_ty³
;

121 
cÚ¡ex´
 
size_t
 
	gnum_v”siÚs
 = 2;

123 
ex¶ic™
 
V”S–
(
ty³
 
v
è: 
v”s_
() { ()v; }

124 
V”S–
(
ty³
 
v
, 
boŞ
 
š£¹
è: 
v”s_
(è{ ()v; ()
	gš£¹
; }

126 
m­_im¶
(
cŞ_n
) {

127 
ušt64_t
 
	gmask
 = ~(~0uÈ<< 
vidx_width
) ;

128 
	gshiá
 = 
cŞ_n
 * 
vidx_width
;

129  ((
	gcŞ_ûÎ_m­
 & (
	gmask
 << 
	gshiá
)) >> shift);

132 
	gv”siÚ_ty³
& 
v”siÚ_©_im¶
(
ûÎ
) {

133  
	gv”s_
[
ûÎ
];

136 
š¡®l_by_ûÎ_im¶
(
two_v”siÚ_row
 *
d¡
, cÚ¡wo_v”siÚ_row *
¤c
, 
ûÎ
) {

137 
	gûÎ
) {

139 
d¡
->
f1
 = 
¤c
->f1;

140 
	gd¡
->
	gf2
 = 
¤c
->
f2
;

141 
	gd¡
->
	gf3
 = 
¤c
->
f3
;

142 
	gd¡
->
	gf4
 = 
¤c
->
f4
;

145 
d¡
->
f5
 = 
¤c
->f5;

146 
	gd¡
->
	gf6
 = 
¤c
->
f6
;

147 
	gd¡
->
	gf7
 = 
¤c
->
f7
;

148 
	gd¡
->
	gf8
 = 
¤c
->
f8
;

151 
®ways_as£¹
(
çl£
, "cell id out of bound\n");

156 
	g´iv©e
:

157 
v”siÚ_ty³
 
v”s_
[
num_v”siÚs
];

158 
cÚ¡ex´
 
	gvidx_width
 = 1u;

159 
cÚ¡ex´
 
ušt64_t
 
	gcŞ_ûÎ_m­
 = 240ul;

163 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

164 
şass
 
	gV”S–
<
	gfour_v”siÚ_row
, 
	gV”sIm¶
> : 
public
 
V”S–Ba£
<
V”S–
<
four_v”siÚ_row
, VersImpl>, VersImpl> {

165 
	gpublic
:

166 
V”sIm¶
 
	tv”siÚ_ty³
;

167 
cÚ¡ex´
 
size_t
 
	gnum_v”siÚs
 = 4;

169 
ex¶ic™
 
V”S–
(
ty³
 
v
è: 
v”s_
() { ()v; }

170 
V”S–
(
ty³
 
v
, 
boŞ
 
š£¹
è: 
v”s_
(è{ ()v; ()
	gš£¹
; }

172 
m­_im¶
(
cŞ_n
) {

173 
ušt64_t
 
	gmask
 = ~(~0uÈ<< 
vidx_width
) ;

174 
	gshiá
 = 
cŞ_n
 * 
vidx_width
;

175  ((
	gcŞ_ûÎ_m­
 & (
	gmask
 << 
	gshiá
)) >> shift);

178 
	gv”siÚ_ty³
& 
v”siÚ_©_im¶
(
ûÎ
) {

179  
	gv”s_
[
ûÎ
];

182 
š¡®l_by_ûÎ_im¶
(
four_v”siÚ_row
 *
d¡
, cÚ¡ four_v”siÚ_row *
¤c
, 
ûÎ
) {

183 
	gûÎ
) {

185 
d¡
->
f1
 = 
¤c
->f1;

186 
	gd¡
->
	gf2
 = 
¤c
->
f2
;

189 
d¡
->
f3
 = 
¤c
->f3;

190 
	gd¡
->
	gf4
 = 
¤c
->
f4
;

193 
d¡
->
f5
 = 
¤c
->f5;

194 
	gd¡
->
	gf6
 = 
¤c
->
f6
;

197 
d¡
->
f7
 = 
¤c
->f7;

198 
	gd¡
->
	gf8
 = 
¤c
->
f8
;

201 
®ways_as£¹
(
çl£
, "cell id out of bound\n");

206 
	g´iv©e
:

207 
v”siÚ_ty³
 
v”s_
[
num_v”siÚs
];

208 
cÚ¡ex´
 
	gvidx_width
 = 2u;

209 
cÚ¡ex´
 
ušt64_t
 
	gcŞ_ûÎ_m­
 = 64080ul;

213 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

214 
şass
 
	gV”S–
<
	geight_v”siÚ_row
, 
	gV”sIm¶
> : 
public
 
V”S–Ba£
<
V”S–
<
eight_v”siÚ_row
, VersImpl>, VersImpl> {

215 
	gpublic
:

216 
V”sIm¶
 
	tv”siÚ_ty³
;

217 
cÚ¡ex´
 
size_t
 
	gnum_v”siÚs
 = 8;

219 
ex¶ic™
 
V”S–
(
ty³
 
v
è: 
v”s_
() { ()v; }

220 
V”S–
(
ty³
 
v
, 
boŞ
 
š£¹
è: 
v”s_
(è{ ()v; ()
	gš£¹
; }

222 
m­_im¶
(
cŞ_n
) {

223 
ušt64_t
 
	gmask
 = ~(~0uÈ<< 
vidx_width
) ;

224 
	gshiá
 = 
cŞ_n
 * 
vidx_width
;

225  ((
	gcŞ_ûÎ_m­
 & (
	gmask
 << 
	gshiá
)) >> shift);

228 
	gv”siÚ_ty³
& 
v”siÚ_©_im¶
(
ûÎ
) {

229  
	gv”s_
[
ûÎ
];

232 
š¡®l_by_ûÎ_im¶
(
eight_v”siÚ_row
 *
d¡
, cÚ¡ƒight_v”siÚ_row *
¤c
, 
ûÎ
) {

233 
	gûÎ
) {

235 
d¡
->
f1
 = 
¤c
->f1;

238 
d¡
->
f2
 = 
¤c
->f2;

241 
d¡
->
f3
 = 
¤c
->f3;

244 
d¡
->
f4
 = 
¤c
->f4;

247 
d¡
->
f5
 = 
¤c
->f5;

250 
d¡
->
f6
 = 
¤c
->f6;

253 
d¡
->
f7
 = 
¤c
->f7;

256 
d¡
->
f8
 = 
¤c
->f8;

259 
®ways_as£¹
(
çl£
, "cell id out of bound\n");

264 
	g´iv©e
:

265 
v”siÚ_ty³
 
v”s_
[
num_v”siÚs
];

266 
cÚ¡ex´
 
	gvidx_width
 = 3u;

267 
cÚ¡ex´
 
ušt64_t
 
	gcŞ_ûÎ_m­
 = 16434824ul;

	@benchmark/Predicate_bench.cc

1 
	~"şp.h
"

3 
	~"DB_´of”.hh
"

4 
	~"PÏtfÜmF—tu»s.hh
"

5 
	~"P»diÿ‹_b’ch.hh
"

7 
	gdb_·¿ms
::
cÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
;

9 ’um { 
	mİt_Áhrs
 = 1, 
	mİt_time
, 
	mİt_rw
 };

11 
	scmd_·¿ms
 {

12 
	mnum_th»ads
;

13 
	mtime_lim™
;

14 
boŞ
 
	m»ad_wr™e
;

16 
cmd_·¿ms
(è: 
num_th»ads
(1), 
time_lim™
(10.0), 
»ad_wr™e
(
çl£
) {}

19 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

20 { "Áh»ads", 't', 
İt_Áhrs
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

21 { "time", 'l', 
İt_time
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

22 { "»adwr™e", 'w', 
İt_rw
, 
CÍ_NoV®
, 
CÍ_Neg©e
 | 
CÍ_O±iÚ®
 }

25 
	$maš
(
¬gc
, cÚ¡ * cÚ¡ *
¬gv
) {

26 
db_·¿ms
::
	tdb_deçuÉ_·¿ms
 
	t·¿ms
;

27 
TCouÁ”
<, 
	tTNÚİaqueW¿µed
<>> 
	tw_´ed
;

28 
TBox
<, 
	tTNÚİaqueW¿µed
<>> 
	tno_´ed
;

29 
´ediÿ‹_b’ch
::
	t´ediÿ‹_ruÂ”
<
	t·¿ms
, 
	tw_´ed
> 
	tr_ty³_w´ed
;

30 
´ediÿ‹_b’ch
::
	t´ediÿ‹_ruÂ”
<
	t·¿ms
, 
	tno_´ed
> 
	tr_ty³_nİ»d
;

31 
´ediÿ‹_b’ch
::
	t´ediÿ‹_db
<
	t·¿ms
, 
	tw_´ed
> 
	tdb_ty³_w´ed
;

32 
´ediÿ‹_b’ch
::
	t´ediÿ‹_db
<
	t·¿ms
, 
	tno_´ed
> 
	tdb_ty³_nİ»d
;

34 
usšg
 
´ediÿ‹_b’ch
::
š™Ÿlize_db
;

36 
cmd_·¿ms
 
p
;

38 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
	`¬¿ysize
(
İtiÚs
), options);

39 
»t_code
 = 0;

40 
İt
;

41 
boŞ
 
şp_¡İ
 = 
çl£
;

42 !
şp_¡İ
 && ((
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
)) {

43 
İt
) {

44 
İt_Áhrs
:

45 
p
.
num_th»ads
 = 
şp
->
v®
.
i
;

47 
İt_time
:

48 
p
.
time_lim™
 = 
şp
->
v®
.
d
;

50 
İt_rw
:

51 
p
.
»ad_wr™e
 = !
şp
->
Ãg©ed
;

54 
»t_code
 = 1;

55 
şp_¡İ
 = 
Œue
;

59 
	`CÍ_D–‘eP¬£r
(
şp
);

60 ià(
»t_code
 != 0)

61  
»t_code
;

63 autØ
äeq
 = 
	`d‘”mše_ıu_äeq
();

64 ià(
äeq
 == 0.0)

66 
db_·¿ms
::
cÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
 = 
äeq
;

68 
db_ty³_w´ed
 
db_w´ed
;

69 
db_ty³_nİ»d
 
db_nİ»d
;

70 cÚ¡ 
size_t
 
db_size
 = 256;

71 
	`š™Ÿlize_db
(
db_w´ed
, 
db_size
);

72 
	`š™Ÿlize_db
(
db_nİ»d
, 
db_size
);

74 
b’ch
::
db_´of”
 
	`´of
(
çl£
 );

75 autØ
Áh»ads
 = 
p
.
num_th»ads
;

76 autØ
time_lim™
 = 
p
.time_limit;

77 
¡d
::
cout
 << "Numb” oàth»ads: " << 
Áh»ads
 << std::
’dl
;

79 
r_ty³_w´ed
 
	`r_w´ed
(
Áh»ads
, 
time_lim™
, 
db_w´ed
);

80 
r_ty³_nİ»d
 
	`r_nİ»d
(
Áh»ads
, 
time_lim™
, 
db_nİ»d
);

82 
size_t
 
ncomm™s
;

84 
´of
.
	`¡¬t
(
Prof”
::
³rf_mode
::
»cÜd
);

85 
ncomm™s
 = 
r_w´ed
.
	`run
(!
p
.
»ad_wr™e
);

86 
´of
.
	`fšish
(
ncomm™s
);

88 
´of
.
	`¡¬t
(
Prof”
::
³rf_mode
::
»cÜd
);

89 
ncomm™s
 = 
r_nİ»d
.
	`run
(!
p
.
»ad_wr™e
);

90 
´of
.
	`fšish
(
ncomm™s
);

93 
	}
}

	@benchmark/Predicate_bench.hh

1 
	~<th»ad
>

3 
	~"DB_šdex.hh
"

4 
	~"TBox.hh
"

5 
	~"TCouÁ”.hh
"

6 
	~"DB_·¿ms.hh
"

8 
Çme¥aû
 
	g´ediÿ‹_b’ch
 {

10 
	g‹m¶©e
 <
ty³Çme
 
	gDBRow
> 
	s´ediÿ‹_row
 {

11 şas 
	cNamedCŞumn
 : { 
b®ªû
 = 0 };

12 
DBRow
 
	gb®ªû
;

14 
´ediÿ‹_row
() {}

15 
ex¶ic™
 
´ediÿ‹_row
(
v
è: 
b®ªû
(v) {}

18 
	s´ediÿ‹_key
 {

19 
ušt64_t
 
	gk
;

21 
ex¶ic™
 
´ediÿ‹_key
(
ušt64_t
 
p_k
è: 
k
(p_k) {}

22 
ex¶ic™
 
´ediÿ‹_key
(
lcdf
::
SŒ
& 
mt_key
) {

23 
as£¹
(
mt_key
.
Ëngth
(è=ğ(*
this
));

24 
memıy
(
this
, 
mt_key
.
d©a
(), mt_key.
Ëngth
());

26 
İ”©Ü
 
	glcdf
::
SŒ
() const {

27  
lcdf
::
SŒ
((*)
this
, (*this));

31 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
,y³Çm
	gDBRow
>

32 şas 
	c´ediÿ‹_db
 {

33 
	gpublic
:

34 
‹m¶©e
 <
ty³Çme
 
K
,y³Çm
	gV
>

35 
usšg
 
	gOIndex
 = 
b’ch
::
Üd”ed_šdex
<
K
, 
	gV
, 
	gDBP¬ams
>;

36 
	gOIndex
<
	t´ediÿ‹_key
, 
	t´ediÿ‹_row
<
	tDBRow
>> 
	tbË_ty³
;

38 
	gbË_ty³
& 
bË
() {

39  
	gtbl_
;

41 
size_t
 
size
() const {

42  
	gsize_
;

44 
	gsize_t
& 
size
() {

45  
	gsize_
;

47 
	g´iv©e
:

48 
size_t
 
size_
;

49 
bË_ty³
 
	gtbl_
;

52 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
,y³Çm
	gDBRow
>

53 
š™Ÿlize_db
(
´ediÿ‹_db
<
DBP¬ams
, 
DBRow
>& 
db
, 
size_t
 
db_size
) {

54 
	gdb
.
bË
().
th»ad_š™
();

55 
size_t
 
	gi
 = 0; i < 
	gdb_size
; ++i)

56 
	gdb
.
bË
().
nÚŒªs_put
(
´ediÿ‹_key
(
i
), 
´ediÿ‹_row
<
DBRow
>(1000));

57 
	gdb
.
size
(èğ
db_size
;

60 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
,y³Çm
	gDBRow
>

61 şas 
	c´ediÿ‹_ruÂ”
 {

62 
	gpublic
:

63 
usšg
 
RowAcûss
 = 
b’ch
::RowAccess;

64 
run_txn
(
size_t
 
key
) {

65 
	gTRANSACTION_E
 {

66 
boŞ
 
	gabÜt
, 
	g»suÉ
;

67 cÚ¡ *
	gv®ue
;

68 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
¡d
::
ignÜe
, 
v®ue
èğ
db
.
bË
().
£Ëù_row
(
´ediÿ‹_key
(
key
), 
RowAcûss
::
Ob£rveV®ue
);

69 autØ
	gr
 = 
»š‹½»t_ÿ¡
<
´ediÿ‹_row
<
DBRow
> *>(
cÚ¡_ÿ¡
<*>(
v®ue
));

70 ià(
	gr
->
	gb®ªû
 > 10) {

71 
	gr
->
	gb®ªû
 = 
r
->
b®ªû
 - 1;

73 
	gr
->
	gb®ªû
 = 
r
->
b®ªû
 + 1000;

75 } 
RETRY_E
(
Œue
);

78 
run_ro_txn
(
size_t
 
key
) {

79 
	gTRANSACTION_E
 {

80 
boŞ
 
	gabÜt
, 
	g»suÉ
;

81 cÚ¡ *
	gv®ue
;

82 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
¡d
::
ignÜe
, 
v®ue
èğ
db
.
bË
().
£Ëù_row
(
´ediÿ‹_key
(
key
), 
RowAcûss
::
Ob£rveV®ue
);

83 autØ
	gr
 = 
»š‹½»t_ÿ¡
<
´ediÿ‹_row
<
DBRow
> *>(
cÚ¡_ÿ¡
<*>(
v®ue
));

84 vŞ©autØ
	gs
 = 
r
->
b®ªû
 + 1000;

85 ()
	gs
;

86 } 
RETRY_E
(
Œue
);

90 
size_t
 
run
(cÚ¡ 
boŞ
 
»adÚly
) {

91 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
thrs
;

92 
	g¡d
::
veùÜ
<
size_t
> 
txn_úts
((size_t)
num_ruÂ”s
, 0);

93 
	gi
 = 0; i < 
	gnum_ruÂ”s
; ++i)

94 
	gthrs
.
em¶aû_back
(

95 &
´ediÿ‹_ruÂ”
::
ruÂ”_th»ad
, 
this
, 
i
, 
¡d
::
»f
(
txn_úts
[i]),

96 
»adÚly
);

97 auto& 
	gt
 : 
thrs
)

98 
t
.
još
();

99 
size_t
 
	gcombšed_txn_couÁ
 = 0;

100 autØ
	gc
 : 
txn_úts
)

101 
combšed_txn_couÁ
 +ğ
c
;

102  
	gcombšed_txn_couÁ
;

105 
´ediÿ‹_ruÂ”
(
Áh»ads
, 
time_lim™
, 
´ediÿ‹_db
<
DBP¬ams
, 
DBRow
>& 
d©aba£
)

106 : 
num_ruÂ”s
(
Áh»ads
), 
tsc_–­£_lim™
(), 
db
(
d©aba£
) {

107 
usšg
 
	gdb_·¿ms
::
cÚ¡ªts
;

108 
	gtsc_–­£_lim™
 = (
ušt64_t
)(
time_lim™
 * 
cÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
 * cÚ¡ªts::
bliÚ
);

111 
	g´iv©e
:

112 
ruÂ”_th»ad
(
ruÂ”_id
, 
size_t
& 
comm™‹d_txns
, 
boŞ
 
»adÚly
) {

113 ::
TTh»ad
::
£t_id
(
ruÂ”_id
);

114 
	gdb
.
bË
().
th»ad_š™
();

115 
	g¡d
::
mt19937
 
g’
(
ruÂ”_id
);

116 
	g¡d
::
unifÜm_št_di¡ributiÚ
<
ušt64_t
> 
di¡
(0, 
db
.
size
() - 1);

118 
size_t
 
	gth»ad_txn_couÁ
 = 0;

119 autØ
	gtsc_begš
 = 
»ad_tsc
();

120 
	gŒue
) {

121 ià(
	g»adÚly
) {

122 
run_ro_txn
(
di¡
(
g’
));

124 
run_txn
(
di¡
(
g’
));

126 ++
	gth»ad_txn_couÁ
;

127 ià((
	gth»ad_txn_couÁ
 & 0xfful) == 0) {

128 ià(
»ad_tsc
(è- 
tsc_begš
 >ğ
tsc_–­£_lim™
)

133 
	gcomm™‹d_txns
 = 
th»ad_txn_couÁ
;

136 
	gnum_ruÂ”s
;

137 
ušt64_t
 
	gtsc_–­£_lim™
;

138 
	g´ediÿ‹_db
<
	gDBP¬ams
, 
	gDBRow
> 
	gdb
;

	@benchmark/TPCC_bench.cc

1 
	~<s¡»am
>

2 
	~<iomª
>

3 
	~<io¡»am
>

4 
	~<®gÜ™hm
>

5 
	~<th»ad
>

7 
	~"TPCC_b’ch.hh
"

8 
	~"TPCC_txns.hh
"

9 
	~"PÏtfÜmF—tu»s.hh
"

10 
	~"DB_´of”.hh
"

12 
šlše
 
´št_u§ge
(const *);

14 
Çme¥aû
 
	gcc
 {

16 
usšg
 
	gb’ch
::
db_´of”
;

18 cÚ¡ *
	gcc_šput_g’”©Ü
::
Ï¡_Çmes
[] = {

22 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

23 
	gcc_db
<
	gDBP¬ams
>::
cc_db
(
num_whs
è: 
oid_g’_
() {

27 
tbl_™s_
 = 
Ãw
 
™_bË_ty³
(999983 );

28 autØ
	gi
 = 0; i < 
	gnum_whs
; ++i) {

29 
	gtbl_whs_
.
em¶aû_back
();

30 
	gtbl_dts_
.
em¶aû_back
(999983 );

31 
	gtbl_úi_
.
em¶aû_back
(999983 );

32 
	gtbl_cus_
.
em¶aû_back
(999983 );

33 
	gtbl_oci_
.
em¶aû_back
(999983 );

34 
	gtbl_ods_
.
em¶aû_back
(999983 );

35 
	gtbl_Şs_
.
em¶aû_back
(999983 );

36 
	gtbl_nos_
.
em¶aû_back
(999983 );

37 
	gtbl_¡s_
.
em¶aû_back
(999983 );

38 
	gtbl_hts_
.
em¶aû_back
(999983 );

42 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

43 
	gcc_db
<
	gDBP¬ams
>::~
cc_db
() {

44 
d–‘e
 
tbl_™s_
;

47 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

48 
	gcc_db
<
	gDBP¬ams
>::
th»ad_š™_®l
() {

49 
tbl_™s_
->
th»ad_š™
();

50 auto& 
	gt
 : 
tbl_dts_
)

51 
t
.
th»ad_š™
();

52 auto& 
	gt
 : 
tbl_úi_
)

53 
t
.
th»ad_š™
();

54 auto& 
	gt
 : 
tbl_cus_
)

55 
t
.
th»ad_š™
();

56 auto& 
	gt
 : 
tbl_oci_
)

57 
t
.
th»ad_š™
();

58 auto& 
	gt
 : 
tbl_ods_
)

59 
t
.
th»ad_š™
();

60 auto& 
	gt
 : 
tbl_Şs_
)

61 
t
.
th»ad_š™
();

62 auto& 
	gt
 : 
tbl_nos_
)

63 
t
.
th»ad_š™
();

64 auto& 
	gt
 : 
tbl_¡s_
)

65 
t
.
th»ad_š™
();

66 auto& 
	gt
 : 
tbl_hts_
)

67 
t
.
th»ad_š™
();

71 
	g‹m¶©e
<
ty³Çme
 
	gDBP¬ams
>

72 
	gcc_´•İuÏtÜ
<
	gDBP¬ams
>::
fl_™ems
(
ušt64_t
 
iid_begš
, ušt64_ˆ
iid_x’d
) {

73 autØ
	giid
 = 
iid_begš
; iid < 
	giid_x’d
; ++iid) {

74 
™em_key
 
ik
(
iid
);

75 
™em_v®ue
 
	giv
;

77 
	giv
.
	gi_im_id
 = 
ig
.
¿ndom
(1, 10000);

78 
	giv
.
	gi_´iû
 = 
ig
.
¿ndom
(100, 10000);

79 
	giv
.
	gi_Çme
 = 
¿ndom_a_¡ršg
(14, 24);

80 
	giv
.
	gi_d©a
 = 
¿ndom_a_¡ršg
(26, 50);

81 ià(
	gig
.
¿ndom
(1, 100) <= 10) {

82 autØ
pos
 = 
ig
.
¿ndom
(0, 
iv
.
i_d©a
.
Ëngth
() - 8);

83 autØ
	g¶aûd
 = 
iv
.
i_d©a
.
¶aû
("ORIGINAL", 
pos
);

84 
as£¹
(
¶aûd
);

85 ()
	g¶aûd
;

88 
	gdb
.
tbl_™ems
().
nÚŒªs_put
(
ik
, 
iv
);

92 
	g‹m¶©e
<
ty³Çme
 
	gDBP¬ams
>

93 
	gcc_´•İuÏtÜ
<
	gDBP¬ams
>::
fl_w¬ehou£s
() {

94 
ušt64_t
 
wid
 = 1; 
	gwid
 <ğ
ig
.
num_w¬ehou£s
(); ++wid) {

95 autØ&
	gwv
 = 
db
.
g‘_w¬ehou£
(
wid
);

97 
	gwv
.
	gcv
.
	gw_Çme
 = 
¿ndom_a_¡ršg
(6, 10);

98 
	gwv
.
	gcv
.
	gw_¡»‘_1
 = 
¿ndom_a_¡ršg
(10, 20);

99 
	gwv
.
	gcv
.
	gw_¡»‘_2
 = 
¿ndom_a_¡ršg
(10, 20);

100 
	gwv
.
	gcv
.
	gw_c™y
 = 
¿ndom_a_¡ršg
(10, 20);

101 
	gwv
.
	gcv
.
	gw_¡©e
 = 
¿ndom_¡©e_Çme
();

102 
	gwv
.
	gcv
.
	gw_z
 = 
¿ndom_z_code
();

103 
	gwv
.
	gcv
.
	gw_x
 = 
ig
.
¿ndom
(0, 2000);

104 
	gwv
.
	gytd
 = 30000000;

108 
	g‹m¶©e
<
ty³Çme
 
	gDBP¬ams
>

109 
	gcc_´•İuÏtÜ
<
	gDBP¬ams
>::
ex·nd_w¬ehou£
(
ušt64_t
 
wid
) {

110 
ušt64_t
 
iid
 = 1; 
	giid
 <ğ
NUM_ITEMS
; ++iid) {

111 
¡ock_key
 
sk
(
wid
, 
iid
);

112 
¡ock_v®ue
 
	gsv
;

114 
	gsv
.
	gs_quªt™y
 = 
ig
.
¿ndom
(10, 100);

115 autØ
	gi
 = 0; i < 
	gNUM_DISTRICTS_PER_WAREHOUSE
; ++i)

116 
	gsv
.
	gs_di¡s
[
i
] = 
¿ndom_a_¡ršg
(24, 24);

117 
	gsv
.
	gs_ytd
 = 0;

118 
	gsv
.
	gs_Üd”_út
 = 0;

119 
	gsv
.
	gs_»mÙe_út
 = 0;

120 
	gsv
.
	gs_d©a
 = 
¿ndom_a_¡ršg
(26, 50);

121 ià(
	gig
.
¿ndom
(1, 100) <= 10) {

122 autØ
pos
 = 
ig
.
¿ndom
(0, 
sv
.
s_d©a
.
Ëngth
() - 8);

123 autØ
	g¶aûd
 = 
sv
.
s_d©a
.
¶aû
("ORIGINAL", 
pos
);

124 
as£¹
(
¶aûd
);

125 ()
	g¶aûd
;

128 
	gdb
.
tbl_¡ocks
(
wid
).
nÚŒªs_put
(
sk
, 
sv
);

131 
ušt64_t
 
	gdid
 = 1; did <ğ
NUM_DISTRICTS_PER_WAREHOUSE
; ++did) {

132 
di¡riù_key
 
dk
(
wid
, 
did
);

133 
di¡riù_v®ue
 
	gdv
;

135 
	gdv
.
	gd_Çme
 = 
¿ndom_a_¡ršg
(6, 10);

136 
	gdv
.
	gd_¡»‘_1
 = 
¿ndom_a_¡ršg
(10, 20);

137 
	gdv
.
	gd_¡»‘_2
 = 
¿ndom_a_¡ršg
(10, 20);

138 
	gdv
.
	gd_c™y
 = 
¿ndom_a_¡ršg
(10, 20);

139 
	gdv
.
	gd_¡©e
 = 
¿ndom_¡©e_Çme
();

140 
	gdv
.
	gd_z
 = 
¿ndom_z_code
();

141 
	gdv
.
	gd_x
 = 
ig
.
¿ndom
(0, 2000);

142 
	gdv
.
	gd_ytd
 = 3000000;

145 
	gdb
.
tbl_di¡riùs
(
wid
).
nÚŒªs_put
(
dk
, 
dv
);

150 
	g‹m¶©e
<
ty³Çme
 
	gDBP¬ams
>

151 
	gcc_´•İuÏtÜ
<
	gDBP¬ams
>::
ex·nd_di¡riùs
(
ušt64_t
 
wid
) {

152 
ušt64_t
 
did
 = 1; 
	gdid
 <ğ
NUM_DISTRICTS_PER_WAREHOUSE
; ++did) {

153 
ušt64_t
 
	gcid
 = 1; cid <ğ
NUM_CUSTOMERS_PER_DISTRICT
; ++cid) {

154 
cu¡om”_key
 
ck
(
wid
, 
did
, 
cid
);

155 
cu¡om”_v®ue
 
	gcv
;

157 
	gÏ¡_Çme_num
 = (
cid
 <= 1000) ? (cid - 1)

158 : 
ig
.
g’_cu¡om”_Ï¡_Çme_num
(
çl£
 );

159 
	gcv
.
	gc_Ï¡
 = 
ig
.
to_Ï¡_Çme
(
Ï¡_Çme_num
);

160 
	gcv
.
	gc_middË
 = "OE";

161 
	gcv
.
	gc_fœ¡
 = 
¿ndom_a_¡ršg
(8, 16);

162 
	gcv
.
	gc_¡»‘_1
 = 
¿ndom_a_¡ršg
(10, 20);

163 
	gcv
.
	gc_¡»‘_2
 = 
¿ndom_a_¡ršg
(10, 20);

164 
	gcv
.
	gc_c™y
 = 
¿ndom_a_¡ršg
(10, 20);

165 
	gcv
.
	gc_z
 = 
¿ndom_z_code
();

166 
	gcv
.
	gc_phÚe
 = 
¿ndom_n_¡ršg
(16, 16);

167 
	gcv
.
	gc_sšû
 = 
ig
.
g’_d©e
();

168 
	gcv
.
	gc_üed™
 = (
ig
.
¿ndom
(1, 100) <= 10) ? "BC" : "GC";

169 
	gcv
.
	gc_üed™_lim
 = 5000000;

170 
	gcv
.
	gc_discouÁ
 = 
ig
.
¿ndom
(0, 5000);

171 
	gcv
.
	gc_b®ªû
 = -1000;

172 
	gcv
.
	gc_ytd_·ym’t
 = 1000;

173 
	gcv
.
	gc_·ym’t_út
 = 1;

174 
	gcv
.
	gc_d–iv”y_út
 = 0;

175 
	gcv
.
	gc_d©a
 = 
¿ndom_a_¡ršg
(300, 500);

177 
	gdb
.
tbl_cu¡om”s
(
wid
).
nÚŒªs_put
(
ck
, 
cv
);

179 
cu¡om”_idx_key
 
cik
(
wid
, 
did
, 
cv
.
c_Ï¡
, cv.
c_fœ¡
);

180 
cu¡om”_idx_v®ue
 
civ
(
cid
);

182 
	gdb
.
tbl_cu¡om”_šdex
(
wid
).
nÚŒªs_put
(
cik
, 
civ
);

187 
	g‹m¶©e
<
ty³Çme
 
	gDBP¬ams
>

188 
	gcc_´•İuÏtÜ
<
	gDBP¬ams
>::
ex·nd_cu¡om”s
(
ušt64_t
 
wid
) {

189 
ušt64_t
 
did
 = 1; 
	gdid
 <ğ
NUM_DISTRICTS_PER_WAREHOUSE
; ++did) {

190 
ušt64_t
 
	gcid
 = 1; cid <ğ
NUM_CUSTOMERS_PER_DISTRICT
; ++cid) {

191 
hi¡Üy_v®ue
 
	ghv
;

193 
	ghv
.
	gh_c_id
 = 
cid
;

194 
	ghv
.
	gh_c_d_id
 = 
did
;

195 
	ghv
.
	gh_c_w_id
 = 
wid
;

196 
	ghv
.
	gh_d©e
 = 
ig
.
g’_d©e
();

197 
	ghv
.
	gh_amouÁ
 = 1000;

198 
	ghv
.
	gh_d©a
 = 
¿ndom_a_¡ršg
(12, 24);

200 
hi¡Üy_key
 
hk
(
db
.
tbl_hi¡Ü›s
(
wid
).
g’_key
());

201 
	gdb
.
tbl_hi¡Ü›s
(
wid
).
nÚŒªs_put
(
hk
, 
hv
);

205 
ušt64_t
 
	gdid
 = 1; did <ğ
NUM_DISTRICTS_PER_WAREHOUSE
; ++did) {

206 
	g¡d
::
veùÜ
<
ušt64_t
> 
cid_³rm
;

207 
ušt64_t
 
	gn
 = 1;‚ <ğ
NUM_CUSTOMERS_PER_DISTRICT
; ++n)

208 
	gcid_³rm
.
push_back
(
n
);

209 
¿ndom_shufæe
(
cid_³rm
);

211 
ušt64_t
 
	gi
 = 1; i <ğ
NUM_CUSTOMERS_PER_DISTRICT
; ++i) {

212 
ušt64_t
 
	goid
 = 
i
;

213 
Üd”_key
 
ok
(
wid
, 
did
, 
oid
);

214 
Üd”_v®ue
 
	gov
;

216 
	gov
.
	go_c_id
 = 
cid_³rm
[
i
 - 1];

217 
	gov
.
	go_ÿ¼›r_id
 = (
oid
 < 2101è? 
ig
.
¿ndom
(1, 10) : 0;

218 
	gov
.
	go_’Œy_d
 = 
ig
.
g’_d©e
();

219 
	gov
.
	go_Ş_út
 = (
ušt32_t
è
ig
.
¿ndom
(5, 15);

220 
	gov
.
	go_®l_loÿl
 = 1;

222 
Üd”_cidx_key
 
ock
(
wid
, 
did
, 
ov
.
o_c_id
, 
oid
);

224 
	gdb
.
tbl_Üd”s
(
wid
).
nÚŒªs_put
(
ok
, 
ov
);

225 
	gdb
.
tbl_Üd”_cu¡om”_šdex
(
wid
).
nÚŒªs_put
(
ock
, {});

227 
ušt64_t
 
	gÚ
 = 1; oÀ<ğ
ov
.
o_Ş_út
; ++on) {

228 
Üd”lše_key
 
Şk
(
wid
, 
did
, 
oid
, 
Ú
);

229 
Üd”lše_v®ue
 
	gŞv
;

231 
	gŞv
.
	gŞ_i_id
 = 
ig
.
¿ndom
(1, 100000);

232 
	gŞv
.
	gŞ_suµly_w_id
 = 
wid
;

233 
	gŞv
.
	gŞ_d–iv”y_d
 = (
oid
 < 2101è? 
ov
.
o_’Œy_d
 : 0;

234 
	gŞv
.
	gŞ_quªt™y
 = 5;

235 
	gŞv
.
	gŞ_amouÁ
 = (
oid
 < 2101è? 0 : (è
ig
.
¿ndom
(1, 999999);

236 
	gŞv
.
	gŞ_di¡_šfo
 = 
¿ndom_a_¡ršg
(24, 24);

238 
	gdb
.
tbl_Üd”lšes
(
wid
).
nÚŒªs_put
(
Şk
, 
Şv
);

241 ià(
	goid
 >= 2101) {

242 
Üd”_key
 
nok
(
wid
, 
did
, 
oid
);

243 
	gdb
.
tbl_ÃwÜd”s
(
wid
).
nÚŒªs_put
(
nok
, {});

250 
	g‹m¶©e
<
ty³Çme
 
	gDBP¬ams
>

251 
	gcc_´•İuÏtÜ
<
	gDBP¬ams
>::
run
() {

252 
r
;

254 
®ways_as£¹
(
wÜk”_id
 >= 1, "prepopulator worker id„angeƒrror");

256 
£t_affš™y
(
wÜk”_id
 - 1);

258 ià(
	gwÜk”_id
 == 1) {

259 
fl_™ems
(1, 100001);

260 
fl_w¬ehou£s
();

264 
	gr
 = 
±h»ad_b¬r›r_wa™
(&
sync_b¬r›r
);

265 
®ways_as£¹
(
r
 =ğ
PTHREAD_BARRIER_SERIAL_THREAD
 ||„ == 0, "pthread_barrier_wait");

267 
ex·nd_w¬ehou£
((
ušt64_t
è
wÜk”_id
);

270 
	gr
 = 
±h»ad_b¬r›r_wa™
(&
sync_b¬r›r
);

271 
®ways_as£¹
(
r
 =ğ
PTHREAD_BARRIER_SERIAL_THREAD
 ||„ == 0, "pthread_barrier_wait");

273 
ex·nd_di¡riùs
((
ušt64_t
è
wÜk”_id
);

276 
	gr
 = 
±h»ad_b¬r›r_wa™
(&
sync_b¬r›r
);

277 
®ways_as£¹
(
r
 =ğ
PTHREAD_BARRIER_SERIAL_THREAD
 ||„ == 0, "pthread_barrier_wait");

279 
ex·nd_cu¡om”s
((
ušt64_t
è
wÜk”_id
);

283 
	g‹m¶©e
<
ty³Çme
 
	gDBP¬ams
>

284 
	g¡d
::
¡ršg
 
cc_´•İuÏtÜ
<
DBP¬ams
>::
¿ndom_a_¡ršg
(
x
, 
y
) {

285 
size_t
 
	gËn
 = 
ig
.
¿ndom
(
x
, 
y
);

286 
	g¡d
::
¡ršg
 
¡r
;

287 
	g¡r
.
»£rve
(
Ën
);

289 autØ
	gi
 = 0u; i < 
	gËn
; ++i) {

290 autØ
	gn
 = 
ig
.
¿ndom
(0, 61);

291 
	gc
 = (
n
 < 26) ? ('a' +‚) :

292 ((
n
 < 52) ? ('A' + (n - 26)) : ('0' + (n - 52)));

293 
	g¡r
.
push_back
(
c
);

295  
	g¡r
;

298 
	g‹m¶©e
<
ty³Çme
 
	gDBP¬ams
>

299 
	g¡d
::
¡ršg
 
cc_´•İuÏtÜ
<
DBP¬ams
>::
¿ndom_n_¡ršg
(
x
, 
y
) {

300 
size_t
 
	gËn
 = 
ig
.
¿ndom
(
x
, 
y
);

301 
	g¡d
::
¡ršg
 
¡r
;

302 
	g¡r
.
»£rve
(
Ën
);

304 autØ
	gi
 = 0u; i < 
	gËn
; ++i) {

305 autØ
	gn
 = 
ig
.
¿ndom
(0, 9);

306 
	g¡r
.
push_back
(('0' + 
n
));

308  
	g¡r
;

311 
	g‹m¶©e
<
ty³Çme
 
	gDBP¬ams
>

312 
	g¡d
::
¡ršg
 
cc_´•İuÏtÜ
<
DBP¬ams
>::
¿ndom_¡©e_Çme
() {

313 
¡d
::
¡ršg
 
¡r
 = "AA";

314 autØ&
	gc
 : 
¡r
)

315 
c
 +ğ
ig
.
¿ndom
(0, 25);

316  
	g¡r
;

319 
	g‹m¶©e
<
ty³Çme
 
	gDBP¬ams
>

320 
	g¡d
::
¡ršg
 
cc_´•İuÏtÜ
<
DBP¬ams
>::
¿ndom_z_code
() {

321 
¡d
::
¡ršg¡»am
 
ss
;

322 
	gss
 << 
	g¡d
::
£tfl
('0'è<< 
¡d
::
£tw
(4è<< 
ig
.
¿ndom
(0, 9999);

323  
	gss
.
¡r
() + "11111";

326 
	g‹m¶©e
<
ty³Çme
 
	gDBP¬ams
>

327 
	gcc_´•İuÏtÜ
<
	gDBP¬ams
>::
¿ndom_shufæe
(
¡d
::
veùÜ
<
ušt64_t
> &
v
) {

328 
¡d
::
shufæe
(
v
.
begš
(), v.
’d
(), 
ig
.
¿ndom_g’”©Ü
());

334 
	gİt_dbid
 = 1, 
	gİt_nwhs
, 
	gİt_Áhrs
, 
	gİt_time
, 
	gİt_³rf
, 
	gİt_pfút


337 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

338 { "dbid", 'i', 
İt_dbid
, 
CÍ_V®SŒšg
, 
CÍ_O±iÚ®
 },

339 { "nw¬ehou£s", 'w', 
İt_nwhs
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

340 { "Áh»ads", 't', 
İt_Áhrs
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

341 { "time", 'l', 
İt_time
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

342 { "³rf", 'p', 
İt_³rf
, 
CÍ_NoV®
, 
CÍ_O±iÚ®
 },

343 { "³rf-couÁ”", 'c', 
İt_pfút
, 
CÍ_NoV®
, 
CÍ_Neg©e
| 
CÍ_O±iÚ®
 }

348 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

349 şas 
	ccc_acûss
 {

350 
	gpublic
:

351 
´•İuÏtiÚ_wÜk”
(
cc_db
<
DBP¬ams
> &
db
, 
wÜk”_id
) {

352 
	gcc_´•İuÏtÜ
<
	gDBP¬ams
> 
pİ
(
wÜk”_id
, 
db
);

353 
	gdb
.
th»ad_š™_®l
();

354 
	gpİ
.
run
();

357 
´•İuÏ‹_db
(
cc_db
<
DBP¬ams
> &
db
) {

358 
	gr
;

359 
	gr
 = 
±h»ad_b¬r›r_š™
(&
cc_´•İuÏtÜ
<
DBP¬ams
>::
sync_b¬r›r
, 
nuÎ±r
, 
db
.
num_w¬ehou£s
());

360 
®ways_as£¹
(
r
 == 0, "pthread_barrier_init failed");

362 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
´•İ_thrs
;

363 
	gi
 = 1; i <ğ
db
.
num_w¬ehou£s
(); ++i)

364 
	g´•İ_thrs
.
em¶aû_back
(
´•İuÏtiÚ_wÜk”
, 
¡d
::
»f
(
db
), 
i
);

365 autØ&
	gt
 : 
´•İ_thrs
)

366 
t
.
još
();

368 
	gr
 = 
±h»ad_b¬r›r_de¡roy
(&
cc_´•İuÏtÜ
<
DBP¬ams
>::
sync_b¬r›r
);

369 
®ways_as£¹
(
r
 == 0, "pthread_barrier_destroy failed");

372 
cc_ruÂ”_th»ad
(
cc_db
<
DBP¬ams
>& 
db
, 
db_´of”
& 
´of
, 
ruÂ”_id
, 
ušt64_t
 
w_¡¬t
,

373 
ušt64_t
 
w_’d
, 
time_lim™
, ušt64_t& 
txn_út
) {

374 
	gcc_ruÂ”
<
	gDBP¬ams
> 
ruÂ”
(
ruÂ”_id
, 
db
, 
w_¡¬t
, 
w_’d
);

375 
ty³Çme
 
	tcc_ruÂ”
<
	tDBP¬ams
>::
	ttxn_ty³
xn_type;

377 
ušt64_t
 
	gloÿl_út
 = 0;

379 ::
TTh»ad
::
£t_id
(
ruÂ”_id
);

380 
£t_affš™y
(
ruÂ”_id
);

381 
	gdb
.
th»ad_š™_®l
();

383 
ušt64_t
 
	gtsc_diff
 = (ušt64_t)(
time_lim™
 * 
cÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
 * cÚ¡ªts::
bliÚ
);

384 autØ
	g¡¬t_t
 = 
´of
.
¡¬t_time¡amp
();

386 
	gŒue
) {

387 autØ
	gcu¼_t
 = 
»ad_tsc
();

388 ià((
	gcu¼_t
 - 
	g¡¬t_t
è>ğ
tsc_diff
)

391 
txn_ty³
 
	gt
 = 
ruÂ”
.
Ãxt_Œª§ùiÚ
();

392 
	gt
) {

393 
	gtxn_ty³
::
Ãw_Üd”
:

394 
ruÂ”
.
run_txn_ÃwÜd”
();

396 
	gtxn_ty³
::
·ym’t
:

397 
ruÂ”
.
run_txn_·ym’t
();

399 
	gtxn_ty³
::
Üd”_¡©us
:

400 
ruÂ”
.
run_txn_Üd”¡©us
();

403 
årštf
(
¡d”r
, "r:%d unknowÀtxÀty³\n", 
ruÂ”_id
);

404 
as£¹
(
çl£
);

408 ++
	gloÿl_út
;

411 
	gtxn_út
 = 
loÿl_út
;

414 
ušt64_t
 
run_b’chm¬k
(
cc_db
<
DBP¬ams
>& 
db
, 
db_´of”
& 
´of
, 
num_ruÂ”s
, 
time_lim™
) {

415 
	gq
 = 
db
.
num_w¬ehou£s
(è/ 
num_ruÂ”s
;

416 
	gr
 = 
db
.
num_w¬ehou£s
(è% 
num_ruÂ”s
;

418 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
ruÂ”_thrs
;

419 
	g¡d
::
veùÜ
<
ušt64_t
> 
txn_úts
(
size_t
(
num_ruÂ”s
), 0);

421 ià(
	gq
 == 0) {

422 
q
 = 
num_ruÂ”s
 / 
db
.
num_w¬ehou£s
();

423 
	gqq
 = 
q
;

424 
	gwid
 = 1;

425 
	gi
 = 0; i < 
	gnum_ruÂ”s
; ++i) {

426 ià((
	gqq
--) == 0) {

427 ++
wid
;

428 
	gqq
 +ğ
q
;

430 
årštf
(
¡dout
, "ruÂ” %d: [%d, %d]\n", 
i
, 
wid
, wid);

431 
	gruÂ”_thrs
.
em¶aû_back
(
cc_ruÂ”_th»ad
, 
¡d
::
»f
(
db
), std::»f(
´of
),

432 
i
, 
wid
, wid, 
time_lim™
, 
¡d
::
»f
(
txn_úts
[i]));

435 
	gÏ¡_x’d
 = 1;

437 
	gi
 = 0; i < 
	gnum_ruÂ”s
; ++i) {

438 
	gÃxt_x’d
 = 
Ï¡_x’d
 + 
q
;

439 ià(
	gr
 > 0) {

440 ++
	gÃxt_x’d
;

441 --
	gr
;

443 
årštf
(
¡dout
, "ruÂ” %d: [%d, %d]\n", 
i
, 
Ï¡_x’d
, 
Ãxt_x’d
 - 1);

444 
	gruÂ”_thrs
.
em¶aû_back
(
cc_ruÂ”_th»ad
, 
¡d
::
»f
(
db
), std::»f(
´of
),

445 
i
, 
Ï¡_x’d
, 
Ãxt_x’d
 - 1, 
time_lim™
, 
¡d
::
»f
(
txn_úts
[i]));

446 
	gÏ¡_x’d
 = 
Ãxt_x’d
;

449 
®ways_as£¹
(
Ï¡_x’d
 =ğ
db
.
num_w¬ehou£s
() + 1, "warehouse distributionƒrror");

452 autØ&
	gt
 : 
ruÂ”_thrs
)

453 
t
.
još
();

455 
ušt64_t
 
	gtÙ®_txn_út
 = 0;

456 auto& 
	gút
 : 
txn_úts
)

457 
tÙ®_txn_út
 +ğ
út
;

458  
	gtÙ®_txn_út
;

461 
execu‹
(
¬gc
, cÚ¡ *cÚ¡ *
¬gv
) {

462 
	g»t
 = 0;

464 
boŞ
 
	g¥awn_³rf
 = 
çl£
;

465 
boŞ
 
	gcouÁ”_mode
 = 
çl£
;

466 
	gnum_w¬ehou£s
 = 1;

467 
	gnum_th»ads
 = 1;

468 
	gtime_lim™
 = 10.0;

470 
CÍ_P¬£r
 *
	gşp
 = 
CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
¬¿ysize
(
İtiÚs
), options);

472 
	gİt
;

473 
boŞ
 
	gşp_¡İ
 = 
çl£
;

474 !
	gşp_¡İ
 && ((
	gİt
 = 
CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
)) {

475 
İt
) {

476 
İt_dbid
:

478 
	gİt_nwhs
:

479 
num_w¬ehou£s
 = 
şp
->
v®
.
i
;

481 
	gİt_Áhrs
:

482 
num_th»ads
 = 
şp
->
v®
.
i
;

484 
	gİt_time
:

485 
time_lim™
 = 
şp
->
v®
.
d
;

487 
	gİt_³rf
:

488 
¥awn_³rf
 = !
şp
->
Ãg©ed
;

490 
	gİt_pfút
:

491 
couÁ”_mode
 = !
şp
->
Ãg©ed
;

494 
´št_u§ge
(
¬gv
[0]);

495 
	g»t
 = 1;

496 
	gşp_¡İ
 = 
Œue
;

501 
CÍ_D–‘eP¬£r
(
şp
);

502 ià(
	g»t
 != 0)

503  
»t
;

505 autØ
	g´of”_mode
 = 
couÁ”_mode
 ?

506 
Prof”
::
³rf_mode
::
couÁ”s
 : Prof”::³rf_mode::
»cÜd
;

508 ià(
	gcouÁ”_mode
 && !
	g¥awn_³rf
) {

510 
	g¥awn_³rf
 = 
Œue
;

513 ià(
	g¥awn_³rf
) {

514 
	g¡d
::
cout
 << "Info: Spawning…erf…rofiler in "

515 << (
couÁ”_mode
 ? "couÁ”" : "»cÜd"è<< " mode" << 
¡d
::
’dl
;

518 
db_´of”
 
´of
(
¥awn_³rf
);

519 
	gcc_db
<
	gDBP¬ams
> 
db
(
num_w¬ehou£s
);

521 
	g¡d
::
cout
 << "P»pİuÏtšg d©aba£..." << 
¡d
::
’dl
;

522 
´•İuÏ‹_db
(
db
);

523 
	g¡d
::
cout
 << "P»pİuÏtiÚ com¶‘e." << 
¡d
::
’dl
;

525 
	g´of
.
¡¬t
(
´of”_mode
);

526 autØ
	gnum_Œªs
 = 
run_b’chm¬k
(
db
, 
´of
, 
num_th»ads
, 
time_lim™
);

527 
	g´of
.
fšish
(
num_Œªs
);

535 
usšg
 
Çme¥aû
 
	gcc
;

536 
usšg
 
Çme¥aû
 
	gdb_·¿ms
;

538 
šlše
 
	$´št_u§ge
(cÚ¡ *
¬gv_0
) {

539 
¡d
::
¡ršg¡»am
 
ss
;

540 
ss
 << "U§goà" << 
¡d
::
	`¡ršg
(
¬gv_0
è<< ":" << std::
’dl


541 << " --dbid=<STRING> (Ü -i<STRING>)" << 
¡d
::
’dl


542 << " S³cifyhty³ oàDB cÚcu¼’cy cÚŒŞ u£d. Cª bÚoàthfŞlowšgs:" << 
¡d
::
’dl


543 << " deçuÉ, o·que, 2¶,‡d­tive, swiss,iùoc" << 
¡d
::
’dl


544 << " --nw¬ehou£s=<NUM> (Ü -w<NUM>)" << 
¡d
::
’dl


545 << " S³cifyhnumb” oàw¬ehou£ (deçuÉ 1)." << 
¡d
::
’dl


546 << " --Áh»ads=<NUM> (Ü -t<NUM>)" << 
¡d
::
’dl


547 << " S³cifyhnumb” oàth»ad (Ü TPCC wÜk”s/‹rmš®s, deçuÉ 1)." << 
¡d
::
’dl


548 << " --time=<NUM> (Ü -l<NUM>)" << 
¡d
::
’dl


549 << " S³cifyhtim(du¿tiÚèfÜ whichhb’chm¬k i ruÀ(deçuÉ 10 secÚds)." << 
¡d
::
’dl


550 << " --³rà(Ü -p)" << 
¡d
::
’dl


551 << " S·wn ³rà´of” iÀ»cÜd modfÜhdu¿tiÚ oàthb’chm¬k„un." << 
¡d
::
’dl


552 << " --³rf-couÁ” (Ü -c)" << 
¡d
::
’dl


553 << " S·wn ³rà´of” iÀcouÁ” modfÜhdu¿tiÚ oàthb’chm¬k„un." << 
¡d
::
’dl
;

554 
¡d
::
cout
 << 
ss
.
	`¡r
(è<< std::
æush
;

555 
	}
}

557 
	gcÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
;

559 
	$maš
(
¬gc
, cÚ¡ *cÚ¡ *
¬gv
) {

560 
db_·¿ms_id
 
dbid
 = db_·¿ms_id::
DeçuÉ
;

561 
»t_code
 = 0;

563 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
	`¬¿ysize
(
İtiÚs
), options);

565 
İt
;

566 
boŞ
 
şp_¡İ
 = 
çl£
;

567 !
şp_¡İ
 && ((
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
)) {

568 
İt
) {

569 
İt_dbid
:

570 
dbid
 = 
	`·r£_dbid
(
şp
->
v®
.
s
);

571 ià(
dbid
 =ğ
db_·¿ms_id
::
NÚe
) {

572 
¡d
::
cout
 << "Unsupported DB CC id: "

573 << ((
şp
->
v®
.
s
 =ğ
nuÎ±r
è? "" : 
¡d
::
	`¡ršg
(şp->v®.s)è<< std::
’dl
;

574 
	`´št_u§ge
(
¬gv
[0]);

575 
»t_code
 = 1;

576 
şp_¡İ
 = 
Œue
;

584 
	`CÍ_D–‘eP¬£r
(
şp
);

585 ià(
»t_code
 != 0)

586  
»t_code
;

588 autØ
ıu_äeq
 = 
	`d‘”mše_ıu_äeq
();

589 ià(
ıu_äeq
 == 0.0)

592 
cÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
 = 
ıu_äeq
;

594 
dbid
) {

595 
db_·¿ms_id
::
DeçuÉ
:

596 
»t_code
 = 
cc_acûss
<
db_deçuÉ_·¿ms
>::
	`execu‹
(
¬gc
, 
¬gv
);

598 
db_·¿ms_id
::
O·que
:

599 
»t_code
 = 
cc_acûss
<
db_İaque_·¿ms
>::
	`execu‹
(
¬gc
, 
¬gv
);

601 
db_·¿ms_id
::
TwoPL
:

602 
»t_code
 = 
cc_acûss
<
db_2¶_·¿ms
>::
	`execu‹
(
¬gc
, 
¬gv
);

604 
db_·¿ms_id
::
Ad­tive
:

605 
»t_code
 = 
cc_acûss
<
db_ad­tive_·¿ms
>::
	`execu‹
(
¬gc
, 
¬gv
);

607 
db_·¿ms_id
::
Swiss
:

608 
»t_code
 = 
cc_acûss
<
db_swiss_·¿ms
>::
	`execu‹
(
¬gc
, 
¬gv
);

610 
db_·¿ms_id
::
TicToc
:

611 
»t_code
 = 
cc_acûss
<
db_tiùoc_·¿ms
>::
	`execu‹
(
¬gc
, 
¬gv
);

614 
¡d
::
û¼
 << "unknowÀdb cÚfig…¬am‘” id" << std::
’dl
;

615 
»t_code
 = 1;

619  
»t_code
;

620 
	}
}

	@benchmark/TPCC_bench.hh

1 #´agm¨
Úû


3 
	~<io¡»am
>

4 
	~<¿ndom
>

5 
	~<¡ršg
>

7 
	~<±h»ad.h
>

9 
	~"comp”.hh
"

10 
	~"şp.h
"

11 
	~"Sy¡emProf”.hh
"

12 
	~"DB_¡ruùs.hh
"

13 
	~"TPCC_¡ruùs.hh
"

15 #ià
TABLE_FINE_GRAINED


16 
	~"TPCC_£ËùÜs.hh
"

19 
	~"DB_šdex.hh
"

20 
	~"DB_·¿ms.hh
"

22 
	#A_GEN_CUSTOMER_ID
 1023

	)

23 
	#A_GEN_ITEM_ID
 8191

	)

25 
	#C_GEN_CUSTOMER_ID
 259

	)

26 
	#C_GEN_ITEM_ID
 7911

	)

28 
Çme¥aû
 
	gcc
 {

30 
usšg
 
Çme¥aû
 
	gdb_·¿ms
;

32 şas 
	ccc_šput_g’”©Ü
 {

33 
	gpublic
:

34 cÚ¡ * 
Ï¡_Çmes
[];

36 
cc_šput_g’”©Ü
(
id
, 
num_whs
)

37 : 
g’
(
id
), 
num_whs_
(
ušt64_t
(
num_whs
)) {}

38 
ex¶ic™
 
cc_šput_g’”©Ü
(
num_whs
)

39 : 
g’
(0), 
num_whs_
(
ušt64_t
(
num_whs
)) {}

41 
ušt64_t
 
nu¿nd
(ušt64_ˆ
a
, ušt64_ˆ
c
, ušt64_ˆ
x
, ušt64_ˆ
y
) {

42 
ušt64_t
 
	gr1
 = (
¿ndom
(0, 
a
è|„ªdom(
x
, 
y
)è+ 
	gc
;

43  (
	gr1
 % (
	gy
 - 
	gx
 + 1)) + x;

45 
ušt64_t
 
¿ndom
(ušt64_ˆ
x
, ušt64_ˆ
y
) {

46 
	g¡d
::
unifÜm_št_di¡ributiÚ
<
ušt64_t
> 
di¡
(
x
, 
y
);

47  
di¡
(
g’
);

49 
ušt64_t
 
num_w¬ehou£s
() const {

50  
	gnum_whs_
;

53 
ušt64_t
 
g’_w¬ehou£_id
() {

54  
¿ndom
(1, 
num_whs_
);

56 
ušt64_t
 
g’_cu¡om”_id
() {

57  
nu¿nd
(
A_GEN_CUSTOMER_ID
, 
C_GEN_CUSTOMER_ID
, 1, 
NUM_CUSTOMERS_PER_DISTRICT
);

60 
g’_cu¡om”_Ï¡_Çme_num
(
boŞ
 
run
) {

61  ()
nu¿nd
(255,

62 
run
 ? 223 : 157 ,

66 
	g¡d
::
¡ršg
 
to_Ï¡_Çme
(
g’_n
) {

67 
as£¹
(
g’_n
 <= 999 && gen_n >= 0);

68 
	g¡d
::
¡ršg
 
¡r
;

70 
	gq
 = 
g’_n
 / 100;

71 
	gr
 = 
g’_n
 % 100;

72 
as£¹
(
q
 < 10);

73 
	g¡r
 +ğ
¡d
::
¡ršg
(
Ï¡_Çmes
[
q
]);

75 
	gq
 = 
r
 / 10;

76 
	gr
 = 
r
 % 10;

77 
as£¹
(
r
 < 10 && 
q
 < 10);

78 
	g¡r
 +ğ
¡d
::
¡ršg
(
Ï¡_Çmes
[
q
]è+ std::¡ršgÖa¡_Çmes[
r
]);

80  
	g¡r
;

83 
	g¡d
::
¡ršg
 
g’_cu¡om”_Ï¡_Çme_run
() {

84  
to_Ï¡_Çme
(
g’_cu¡om”_Ï¡_Çme_num
(
Œue
));

87 
ušt64_t
 
g’_™em_id
() {

88  
nu¿nd
(
A_GEN_ITEM_ID
, 
C_GEN_ITEM_ID
, 1, 
NUM_ITEMS
);

90 
ušt32_t
 
g’_d©e
() {

91  (
	gušt32_t
)
¿ndom
(1505244122, 1599938522);

93 
	g¡d
::
mt19937
& 
¿ndom_g’”©Ü
() {

94  
g’
;

97 
	g´iv©e
:

98 
¡d
::
mt19937
 
g’
;

99 
ušt64_t
 
	gnum_whs_
;

102 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

103 
şass
 
	gcc_acûss
;

105 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

106 şas 
	ccc_db
 {

107 
	gpublic
:

108 
	sw¬ehou£_v®ue
 {

109 
w¬ehou£_v®ue
(è: 
cv
(), 
ytd
() {}

110 
w¬ehou£_cÚ¡_v®ue
 
	gcv
;

111 
	gš‹g”_box
<
	gDBP¬ams
> 
	gytd
;

114 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gV
>

115 
usšg
 
	gUIndex
 = 
unÜd”ed_šdex
<
K
, 
	gV
, 
	gDBP¬ams
>;

117 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gV
>

118 
usšg
 
	gOIndex
 = 
Üd”ed_šdex
<
K
, 
	gV
, 
	gDBP¬ams
>;

121 
	g¡d
::
	tveùÜ
<
	tw¬ehou£_v®ue
> 
	twh_bË_ty³
;

122 
	gOIndex
<
	tdi¡riù_key
, 
	tdi¡riù_v®ue
> 
	tdt_bË_ty³
;

123 
	gOIndex
<
	tcu¡om”_idx_key
, 
	tcu¡om”_idx_v®ue
> 
	tci_bË_ty³
;

124 
	gOIndex
<
	tcu¡om”_key
, 
	tcu¡om”_v®ue
> 
	tcu_bË_ty³
;

125 
	gOIndex
<
	tÜd”_cidx_key
, 
	tb’ch
::
	tdummy_row
> 
	toi_bË_ty³
;

126 
	gOIndex
<
	tÜd”_key
, 
	tÜd”_v®ue
> 
	tod_bË_ty³
;

127 
	gOIndex
<
	tÜd”lše_key
, 
	tÜd”lše_v®ue
> 
	tŞ_bË_ty³
;

128 
	gOIndex
<
	tÜd”_key
, 
	tb’ch
::
	tdummy_row
> 
	tno_bË_ty³
;

129 
	gOIndex
<
	t™em_key
, 
	t™em_v®ue
> 
	t™_bË_ty³
;

130 
	gOIndex
<
	t¡ock_key
, 
	t¡ock_v®ue
> 
	t¡_bË_ty³
;

131 
	gOIndex
<
	thi¡Üy_key
, 
	thi¡Üy_v®ue
> 
	tht_bË_ty³
;

133 
ex¶ic™
 
šlše
 
cc_db
(
num_whs
);

134 
ex¶ic™
 
šlše
 
cc_db
(cÚ¡ 
¡d
::
¡ršg
& 
db_fe_Çme
èğ
d–‘e
;

135 
	gšlše
 ~
cc_db
();

136 
th»ad_š™_®l
();

138 
num_w¬ehou£s
() const {

139  (
	gtbl_whs_
.
size
());

141 
	gw¬ehou£_v®ue
& 
g‘_w¬ehou£
(
ušt64_t
 
w_id
) {

142  
	gtbl_whs_
[
w_id
 - 1];

144 
	gdt_bË_ty³
& 
tbl_di¡riùs
(
ušt64_t
 
w_id
) {

145  
	gtbl_dts_
[
w_id
 - 1];

147 
	gci_bË_ty³
& 
tbl_cu¡om”_šdex
(
ušt64_t
 
w_id
) {

148  
	gtbl_úi_
[
w_id
 - 1];

150 
	gcu_bË_ty³
& 
tbl_cu¡om”s
(
ušt64_t
 
w_id
) {

151  
	gtbl_cus_
[
w_id
 - 1];

153 
	goi_bË_ty³
& 
tbl_Üd”_cu¡om”_šdex
(
ušt64_t
 
w_id
) {

154  
	gtbl_oci_
[
w_id
 - 1];

156 
	god_bË_ty³
& 
tbl_Üd”s
(
ušt64_t
 
w_id
) {

157  
	gtbl_ods_
[
w_id
 - 1];

159 
	gŞ_bË_ty³
& 
tbl_Üd”lšes
(
ušt64_t
 
w_id
) {

160  
	gtbl_Şs_
[
w_id
 - 1];

162 
	gno_bË_ty³
& 
tbl_ÃwÜd”s
(
ušt64_t
 
w_id
) {

163  
	gtbl_nos_
[
w_id
 - 1];

165 
	g™_bË_ty³
& 
tbl_™ems
() {

166  *
	gtbl_™s_
;

168 
	g¡_bË_ty³
& 
tbl_¡ocks
(
ušt64_t
 
w_id
) {

169  
	gtbl_¡s_
[
w_id
 - 1];

171 
	ght_bË_ty³
& 
tbl_hi¡Ü›s
(
ušt64_t
 
w_id
) {

172  
	gtbl_hts_
[
w_id
 - 1];

174 
	gcc_oid_g’”©Ü
& 
oid_g’”©Ü
() {

175  
	goid_g’_
;

178 
	g´iv©e
:

179 
wh_bË_ty³
 
tbl_whs_
;

180 
™_bË_ty³
 *
	gtbl_™s_
;

182 
	g¡d
::
veùÜ
<
dt_bË_ty³
> 
tbl_dts_
;

183 
	g¡d
::
veùÜ
<
ci_bË_ty³
> 
tbl_úi_
;

184 
	g¡d
::
veùÜ
<
cu_bË_ty³
> 
tbl_cus_
;

186 
	g¡d
::
veùÜ
<
oi_bË_ty³
> 
tbl_oci_
;

187 
	g¡d
::
veùÜ
<
od_bË_ty³
> 
tbl_ods_
;

188 
	g¡d
::
veùÜ
<
Ş_bË_ty³
> 
tbl_Şs_
;

189 
	g¡d
::
veùÜ
<
no_bË_ty³
> 
tbl_nos_
;

190 
	g¡d
::
veùÜ
<
¡_bË_ty³
> 
tbl_¡s_
;

191 
	g¡d
::
veùÜ
<
ht_bË_ty³
> 
tbl_hts_
;

193 
cc_oid_g’”©Ü
 
	goid_g’_
;

195 
ä›nd
 
şass
 
	gcc_acûss
<
	gDBP¬ams
>;

198 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

199 şas 
	ccc_ruÂ”
 {

200 
	gpublic
:

201 şas 
	ctxn_ty³
 : {

202 
Ãw_Üd”
 = 1,

203 
	g·ym’t
,

204 
	gÜd”_¡©us
,

205 
	gd–iv”y
,

206 
	g¡ock_Ëv–


209 
cc_ruÂ”
(
id
, 
cc_db
<
DBP¬ams
>& 
d©aba£
, 
ušt64_t
 
w_¡¬t
, ušt64_ˆ
w_’d
)

210 : 
ig
(
id
, 
d©aba£
.
num_w¬ehou£s
()), 
db
(d©aba£), 
ruÂ”_id
(id),

211 
w_id_¡¬t
(
w_¡¬t
), 
w_id_’d
(
w_’d
) {}

213 
šlše
 
txn_ty³
 
Ãxt_Œª§ùiÚ
() {

214 
ušt64_t
 
	gx
 = 
ig
.
¿ndom
(1, 100);

215 ià(
	gx
 <= 49)

216  
txn_ty³
::
Ãw_Üd”
;

217 ià(
	gx
 <= 96)

218  
txn_ty³
::
·ym’t
;

220  
	gtxn_ty³
::
Üd”_¡©us
;

223 
šlše
 
run_txn_ÃwÜd”
();

224 
šlše
 
run_txn_·ym’t
();

225 
šlše
 
run_txn_Üd”¡©us
();

227 
	g´iv©e
:

228 
cc_šput_g’”©Ü
 
ig
;

229 
	gcc_db
<
	gDBP¬ams
>& 
	gdb
;

230 
	gruÂ”_id
;

231 
ušt64_t
 
	gw_id_¡¬t
;

232 
ušt64_t
 
	gw_id_’d
;

235 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

236 şas 
	ccc_´•İuÏtÜ
 {

237 
	gpublic
:

238 
±h»ad_b¬r›r_t
 
sync_b¬r›r
;

240 
cc_´•İuÏtÜ
(
id
, 
cc_db
<
DBP¬ams
>& 
d©aba£
)

241 : 
ig
(
id
, 
d©aba£
.
num_w¬ehou£s
()), 
db
(d©aba£), 
wÜk”_id
(id) {}

243 
šlše
 
fl_™ems
(
ušt64_t
 
iid_begš
, ušt64_ˆ
iid_x’d
);

244 
šlše
 
fl_w¬ehou£s
();

245 
šlše
 
ex·nd_w¬ehou£
(
ušt64_t
 
wid
);

246 
šlše
 
ex·nd_di¡riùs
(
ušt64_t
 
wid
);

247 
šlše
 
ex·nd_cu¡om”s
(
ušt64_t
 
wid
);

249 
šlše
 
run
();

251 
	g´iv©e
:

252 
šlše
 
¡d
::
¡ršg
 
¿ndom_a_¡ršg
(
x
, 
y
);

253 
šlše
 
	g¡d
::
¡ršg
 
¿ndom_n_¡ršg
(
x
, 
y
);

254 
šlše
 
	g¡d
::
¡ršg
 
¿ndom_¡©e_Çme
();

255 
šlše
 
	g¡d
::
¡ršg
 
¿ndom_z_code
();

256 
šlše
 
¿ndom_shufæe
(
¡d
::
veùÜ
<
ušt64_t
>& 
v
);

258 
cc_šput_g’”©Ü
 
	gig
;

259 
	gcc_db
<
	gDBP¬ams
>& 
	gdb
;

260 
	gwÜk”_id
;

263 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

264 
±h»ad_b¬r›r_t
 
	gcc_´•İuÏtÜ
<
	gDBP¬ams
>::
sync_b¬r›r
;

	@benchmark/TPCC_selectors.hh

1 #´agm¨
Úû


3 
	~"Sto.hh
"

4 
	~"V”siÚS–eùÜ.hh
"

5 
	~"TPCC_¡ruùs.hh
"

7 
Çme¥aû
 
	gv”_£l
 {

9 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

10 
şass
 
	gV”S–
<
	gcc
::
di¡riù_v®ue
, 
	gV”sIm¶
> : 
public
 
V”S–Ba£
<
V”S–
<
cc
::district_value, VersImpl>, VersImpl> {

11 
	gpublic
:

12 
V”sIm¶
 
	tv”siÚ_ty³
;

13 
cÚ¡ex´
 
size_t
 
	gnum_v”siÚs
 = 2;

15 
ex¶ic™
 
V”S–
(
ty³
 
v
è: 
v”s_
() {

16 
Ãw
 (&
v”s_
[0]è
v”siÚ_ty³
(
v
);

18 
V”S–
(
ty³
 
v
, 
boŞ
 
š£¹
è: 
v”s_
() {

19 
Ãw
 (&
v”s_
[0]è
v”siÚ_ty³
(
v
, 
š£¹
);

22 
m­_im¶
(
cŞ_n
) {

23 
	gcc
::
	tdi¡riù_v®ue
::
	tNamedCŞumn
 
	tnc
;

24 autØ
	gcŞ_Çme
 = 
¡©ic_ÿ¡
<
nc
>(
cŞ_n
);

25 ià(
	gcŞ_Çme
 =ğ
nc
::
d_ytd
)

31 
	gv”siÚ_ty³
& 
v”siÚ_©_im¶
(
ûÎ
) {

32  
	gv”s_
[
ûÎ
];

35 
š¡®l_by_ûÎ_im¶
(
cc
::
di¡riù_v®ue
 *
d¡
, cÚ¡pcc::di¡riù_v®u*
¤c
, 
ûÎ
) {

36 
	gûÎ
) {

38 
d¡
->
d_ytd
 = 
¤c
->d_ytd;

41 
d¡
->
d_Çme
 = 
¤c
->d_name;

42 
	gd¡
->
	gd_¡»‘_1
 = 
¤c
->
d_¡»‘_1
;

43 
	gd¡
->
	gd_¡»‘_2
 = 
¤c
->
d_¡»‘_2
;

44 
	gd¡
->
	gd_c™y
 = 
¤c
->
d_c™y
;

45 
	gd¡
->
	gd_¡©e
 = 
¤c
->
d_¡©e
;

46 
	gd¡
->
	gd_z
 = 
¤c
->
d_z
;

47 
	gd¡
->
	gd_x
 = 
¤c
->
d_x
;

50 
®ways_as£¹
(
çl£
, "cell id out of bound\n");

55 
	g´iv©e
:

56 
v”siÚ_ty³
 
v”s_
[
num_v”siÚs
];

59 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

60 
şass
 
	gV”S–
<
	gcc
::
cu¡om”_v®ue
, 
	gV”sIm¶
> : 
public
 
V”S–Ba£
<
V”S–
<
cc
::customer_value, VersImpl>, VersImpl> {

61 
	gpublic
:

62 
V”sIm¶
 
	tv”siÚ_ty³
;

63 
cÚ¡ex´
 
size_t
 
	gnum_v”siÚs
 = 2;

65 
ex¶ic™
 
V”S–
(
ty³
 
v
è: 
v”s_
() {

66 
Ãw
 (&
v”s_
[0]è
v”siÚ_ty³
(
v
);

68 
V”S–
(
ty³
 
v
, 
boŞ
 
š£¹
è: 
v”s_
() {

69 
Ãw
 (&
v”s_
[0]è
v”siÚ_ty³
(
v
, 
š£¹
);

72 
m­_im¶
(
cŞ_n
) {

73 
ušt64_t
 
	gmask
 = ~(~0uÈ<< 
vidx_width
) ;

74 
	gshiá
 = 
cŞ_n
 * 
vidx_width
;

75  ((
	gcŞ_ûÎ_m­
 & (
	gmask
 << 
	gshiá
)) >> shift);

78 
	gv”siÚ_ty³
& 
v”siÚ_©_im¶
(
ûÎ
) {

79  
	gv”s_
[
ûÎ
];

82 
š¡®l_by_ûÎ_im¶
(
cc
::
cu¡om”_v®ue
 *
d¡
, cÚ¡pcc::cu¡om”_v®u*
¤c
, 
ûÎ
) {

83 
	gûÎ
) {

85 
d¡
->
c_b®ªû
 = 
¤c
->c_balance;

86 
	gd¡
->
	gc_ytd_·ym’t
 = 
¤c
->
c_ytd_·ym’t
;

87 
	gd¡
->
	gc_·ym’t_út
 = 
¤c
->
c_·ym’t_út
;

88 
	gd¡
->
	gc_d©a
 = 
¤c
->
c_d©a
;

91 
d¡
->
c_fœ¡
 = 
¤c
->c_first;

92 
	gd¡
->
	gc_middË
 = 
¤c
->
c_middË
;

93 
	gd¡
->
	gc_Ï¡
 = 
¤c
->
c_Ï¡
;

94 
	gd¡
->
	gc_¡»‘_1
 = 
¤c
->
c_¡»‘_1
;

95 
	gd¡
->
	gc_¡»‘_2
 = 
¤c
->
c_¡»‘_2
;

96 
	gd¡
->
	gc_c™y
 = 
¤c
->
c_c™y
;

97 
	gd¡
->
	gc_¡©e
 = 
¤c
->
c_¡©e
;

98 
	gd¡
->
	gc_z
 = 
¤c
->
c_z
;

99 
	gd¡
->
	gc_phÚe
 = 
¤c
->
c_phÚe
;

100 
	gd¡
->
	gc_sšû
 = 
¤c
->
c_sšû
;

101 
	gd¡
->
	gc_üed™
 = 
¤c
->
c_üed™
;

102 
	gd¡
->
	gc_üed™_lim
 = 
¤c
->
c_üed™_lim
;

103 
	gd¡
->
	gc_discouÁ
 = 
¤c
->
c_discouÁ
;

104 
	gd¡
->
	gc_d–iv”y_út
 = 
¤c
->
c_d–iv”y_út
;

107 
®ways_as£¹
(
çl£
, "cell id out of bound\n");

112 
	g´iv©e
:

113 
v”siÚ_ty³
 
v”s_
[
num_v”siÚs
];

114 
cÚ¡ex´
 
	gvidx_width
 = 1u;

115 
cÚ¡ex´
 
ušt64_t
 
	gcŞ_ûÎ_m­
 = 73727ul;

	@benchmark/TPCC_structs.hh

1 #´agm¨
Úû


3 
	~<¡ršg
>

4 
	~<ÿs£¹
>

6 
	~"DB_¡ruùs.hh
"

7 
	~"xxhash.h
"

8 
	~"¡r.hh
"

10 
	#NUM_DISTRICTS_PER_WAREHOUSE
 10

	)

11 
	#NUM_CUSTOMERS_PER_DISTRICT
 3000

	)

12 
	#NUM_ITEMS
 100000

	)

14 #iâdeà
TABLE_FINE_GRAINED


15 
	#TABLE_FINE_GRAINED
 0

	)

18 
Çme¥aû
 
	gcc
 {

24 
usšg
 
Çme¥aû
 
	gb’ch
;

26 şas 
	ccc_oid_g’”©Ü
 {

27 
	gpublic
:

28 
cÚ¡ex´
 
size_t
 
max_whs
 = 32;

29 
cÚ¡ex´
 
size_t
 
	gmax_dts
 = 16;

31 
cc_oid_g’”©Ü
() {

32 autØ&
	goid_g’
 : 
oid_g’s
) {

33 
ušt64_t
 &
j
 : 
oid_g’
) {

34 
j
 = 3001;

39 
ušt64_t
 
Ãxt
(ušt64_ˆ
wid
, ušt64_ˆ
did
) {

40  
ãtch_ªd_add
(&(
oid_g’s
[
wid
 % 
max_whs
][
did
 % 
max_dts
]), 1);

43 
	g´iv©e
:

44 
ušt64_t
 
oid_g’s
[
max_whs
][
max_dts
];

49 
	sw¬ehou£_key
 {

50 
w¬ehou£_key
(
ušt64_t
 
id
) {

51 
	gw_id
 = 
bsw­
(
id
);

53 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
w¬ehou£_key
& 
Ùh”
) const {

54  
w_id
 =ğ
Ùh”
.w_id;

56 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
w¬ehou£_key
& 
Ùh”
) const {

57  !(*
this
 =ğ
Ùh”
);

59 
İ”©Ü
 
	glcdf
::
SŒ
() const {

60  
lcdf
::
SŒ
((cÚ¡ *)
this
, (*this));

63 
ušt64_t
 
	gw_id
;

66 
	sw¬ehou£_cÚ¡_v®ue
 {

67 şas 
	cNamedCŞumn
 : { 
w_Çme
 = 0,

68 
	gw_¡»‘_1
,

69 
	gw_¡»‘_2
,

70 
	gw_c™y
,

71 
	gw_¡©e
,

72 
	gw_z
,

73 
	gw_x
 };

75 
	gv¬_¡ršg
<10> 
	gw_Çme
;

76 
	gv¬_¡ršg
<20> 
	gw_¡»‘_1
;

77 
	gv¬_¡ršg
<20> 
	gw_¡»‘_2
;

78 
	gv¬_¡ršg
<20> 
	gw_c™y
;

79 
	gfix_¡ršg
<2> 
	gw_¡©e
;

80 
	gfix_¡ršg
<9> 
	gw_z
;

81 
št64_t
 
	gw_x
;

87 
	sdi¡riù_key
 {

88 
di¡riù_key
(
ušt64_t
 
wid
, ušt64_ˆ
did
) {

89 
	gd_w_id
 = 
bsw­
(
wid
);

90 
	gd_id
 = 
bsw­
(
did
);

92 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
di¡riù_key
& 
Ùh”
) const {

93  (
d_w_id
 =ğ
Ùh”
.d_w_idè&& (
d_id
 == other.d_id);

95 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
di¡riù_key
& 
Ùh”
) const {

96  !(*
this
 =ğ
Ùh”
);

98 
İ”©Ü
 
	glcdf
::
SŒ
() const {

99  
lcdf
::
SŒ
((cÚ¡ *)
this
, (*this));

102 
ušt64_t
 
	gd_w_id
;

103 
ušt64_t
 
	gd_id
;

106 
	sdi¡riù_v®ue
 {

107 şas 
	cNamedCŞumn
 : { 
d_Çme
 = 0,

108 
	gd_¡»‘_1
,

109 
	gd_¡»‘_2
,

110 
	gd_c™y
,

111 
	gd_¡©e
,

112 
	gd_z
,

113 
	gd_x
,

114 
	gd_ytd
 };

116 
	gv¬_¡ršg
<10> 
	gd_Çme
;

117 
	gv¬_¡ršg
<20> 
	gd_¡»‘_1
;

118 
	gv¬_¡ršg
<20> 
	gd_¡»‘_2
;

119 
	gv¬_¡ršg
<20> 
	gd_c™y
;

120 
	gfix_¡ršg
<2> 
	gd_¡©e
;

121 
	gfix_¡ršg
<9> 
	gd_z
;

122 
št64_t
 
	gd_x
;

123 
št64_t
 
	gd_ytd
;

131 
	scu¡om”_idx_key
 {

132 
cu¡om”_idx_key
(
ušt64_t
 
wid
, ušt64_ˆ
did
, cÚ¡ 
v¬_¡ršg
<16>& 
Ï¡
, cÚ¡ v¬_¡ršg<16>& 
fœ¡
) {

133 
	gc_w_id
 = 
bsw­
(
wid
);

134 
	gc_d_id
 = 
bsw­
(
did
);

135 
memıy
(
c_Ï¡
, 
Ï¡
.
c_¡r
(), (c_last));

136 
memıy
(
c_fœ¡
, 
fœ¡
.
c_¡r
(), (c_first));

139 
cu¡om”_idx_key
(
ušt64_t
 
wid
, ušt64_ˆ
did
, cÚ¡ 
¡d
::
¡ršg
& 
Ï¡
, 
fœ¡_fl
) {

140 
	gc_w_id
 = 
bsw­
(
wid
);

141 
	gc_d_id
 = 
bsw­
(
did
);

142 
mem£t
(
c_Ï¡
, 0x00, (c_last));

143 
memıy
(
c_Ï¡
, 
Ï¡
.
c_¡r
(),†a¡.
Ëngth
());

144 
mem£t
(
c_fœ¡
, 
fœ¡_fl
, (c_first));

147 
cu¡om”_idx_key
(cÚ¡ 
lcdf
::
SŒ
& 
mt_key
) {

148 
as£¹
(
mt_key
.
Ëngth
(è=ğ(*
this
));

149 
memıy
(
this
, 
mt_key
.
d©a
(), (*this));

152 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
cu¡om”_idx_key
& 
Ùh”
) const {

153  !
memcmp
(
this
, &
Ùh”
, (*this));

155 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
cu¡om”_idx_key
& 
Ùh”
) const {

156  !((*
this
è=ğ
Ùh”
);

158 
İ”©Ü
 
	glcdf
::
SŒ
() const {

159  
lcdf
::
SŒ
((cÚ¡ *)
this
, (*this));

162 
ušt64_t
 
	gc_w_id
;

163 
ušt64_t
 
	gc_d_id
;

164 
	gc_Ï¡
[16];

165 
	gc_fœ¡
[16];

168 
	scu¡om”_idx_v®ue
 {

169 şas 
	cNamedCŞumn
 : { 
c_id
 = 0 };

171 
cu¡om”_idx_v®ue
(
ušt64_t
 
cid
è: 
c_id
(cid) {};

172 
ušt64_t
 
	gc_id
;

175 
	scu¡om”_key
 {

176 
cu¡om”_key
(
ušt64_t
 
wid
, ušt64_ˆ
did
, ušt64_ˆ
cid
) {

177 
	gc_w_id
 = 
bsw­
(
wid
);

178 
	gc_d_id
 = 
bsw­
(
did
);

179 
	gc_id
 = 
bsw­
(
cid
);

181 
cu¡om”_key
(cÚ¡ 
lcdf
::
SŒ
& 
mt_key
) {

182 
as£¹
(
mt_key
.
Ëngth
(è=ğ(*
this
));

183 
memıy
(
this
, 
mt_key
.
d©a
(), (*this));

186 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
cu¡om”_key
& 
Ùh”
) const {

187  (
c_w_id
 =ğ
Ùh”
.c_w_idè&& (
c_d_id
 =ğÙh”.c_d_idè&& (
c_id
 == other.c_id);

189 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
cu¡om”_key
& 
Ùh”
) const {

190  !(*
this
 =ğ
Ùh”
);

192 
İ”©Ü
 
	glcdf
::
SŒ
() const {

193  
lcdf
::
SŒ
((cÚ¡ *)
this
, (*this));

196 
ušt64_t
 
g‘_c_id
() const {

197  
bsw­
(
c_id
);

200 
ušt64_t
 
	gc_w_id
;

201 
ušt64_t
 
	gc_d_id
;

202 
ušt64_t
 
	gc_id
;

205 
	scu¡om”_v®ue
 {

206 şas 
	cNamedCŞumn
 : { 
c_fœ¡
 = 0,

207 
	gc_middË
,

208 
	gc_Ï¡
,

209 
	gc_¡»‘_1
,

210 
	gc_¡»‘_2
,

211 
	gc_c™y
,

212 
	gc_¡©e
,

213 
	gc_z
,

214 
	gc_phÚe
,

215 
	gc_sšû
,

216 
	gc_üed™
,

217 
	gc_üed™_lim
,

218 
	gc_discouÁ
,

219 
	gc_b®ªû
,

220 
	gc_ytd_·ym’t
,

221 
	gc_·ym’t_út
,

222 
	gc_d–iv”y_út
,

223 
	gc_d©a
 };

225 
	gv¬_¡ršg
<16> 
	gc_fœ¡
;

226 
	gfix_¡ršg
<2> 
	gc_middË
;

227 
	gv¬_¡ršg
<16> 
	gc_Ï¡
;

228 
	gv¬_¡ršg
<20> 
	gc_¡»‘_1
;

229 
	gv¬_¡ršg
<20> 
	gc_¡»‘_2
;

230 
	gv¬_¡ršg
<20> 
	gc_c™y
;

231 
	gfix_¡ršg
<2> 
	gc_¡©e
;

232 
	gfix_¡ršg
<9> 
	gc_z
;

233 
	gfix_¡ršg
<16> 
	gc_phÚe
;

234 
ušt32_t
 
	gc_sšû
;

235 
	gfix_¡ršg
<2> 
	gc_üed™
;

236 
št64_t
 
	gc_üed™_lim
;

237 
št64_t
 
	gc_discouÁ
;

238 
št64_t
 
	gc_b®ªû
;

239 
št64_t
 
	gc_ytd_·ym’t
;

240 
ušt16_t
 
	gc_·ym’t_út
;

241 
ušt16_t
 
	gc_d–iv”y_út
;

242 
	gfix_¡ršg
<500> 
	gc_d©a
;

247 
	shi¡Üy_key
 {

248 
hi¡Üy_key
(
ušt64_t
 
id
è: 
h_id
(
bsw­
(id)) {}

249 
boŞ
 
İ”©Ü
==(cÚ¡ 
hi¡Üy_key
& 
Ùh”
) const {

250  
h_id
 =ğ
Ùh”
.h_id;

252 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
hi¡Üy_key
& 
Ùh”
) const {

253  
h_id
 !ğ
Ùh”
.h_id;

255 
İ”©Ü
 
	glcdf
::
SŒ
() const {

256  
lcdf
::
SŒ
((cÚ¡ *)
this
, (*this));

259 
ušt64_t
 
	gh_id
;

262 
	shi¡Üy_v®ue
 {

263 şas 
	cNamedCŞumn
 : { 
h_c_id
 = 0,

264 
	gh_c_d_id
,

265 
	gh_c_w_id
,

266 
	gh_d_id
,

267 
	gh_w_id
,

268 
	gh_d©e
,

269 
	gh_amouÁ
,

270 
	gh_d©a
 };

272 
ušt64_t
 
	gh_c_id
;

273 
ušt64_t
 
	gh_c_d_id
;

274 
ušt64_t
 
	gh_c_w_id
;

275 
ušt64_t
 
	gh_d_id
;

276 
ušt64_t
 
	gh_w_id
;

277 
ušt32_t
 
	gh_d©e
;

278 
št64_t
 
	gh_amouÁ
;

279 
	gv¬_¡ršg
<24> 
	gh_d©a
;

284 
	sÜd”_cidx_key
 {

285 
Üd”_cidx_key
(
ušt64_t
 
wid
, ušt64_ˆ
did
, ušt64_ˆ
cid
, ušt64_ˆ
oid
) {

286 
	go_w_id
 = 
bsw­
(
wid
);

287 
	go_d_id
 = 
bsw­
(
did
);

288 
	go_c_id
 = 
bsw­
(
cid
);

289 
	go_id
 = 
bsw­
(
oid
);

292 
Üd”_cidx_key
(cÚ¡ 
lcdf
::
SŒ
& 
mt_key
) {

293 
as£¹
(
mt_key
.
Ëngth
(è=ğ(*
this
));

294 
memıy
(
this
, 
mt_key
.
d©a
(), (*this));

297 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Üd”_cidx_key
& 
Ùh”
) const {

298  !
memcmp
(
this
, &
Ùh”
, (*this));

300 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
Üd”_cidx_key
& 
Ùh”
) const {

301  !((*
this
è=ğ
Ùh”
);

304 
İ”©Ü
 
	glcdf
::
SŒ
() const {

305  
lcdf
::
SŒ
((cÚ¡ *)
this
, (*this));

308 
ušt64_t
 
	go_w_id
;

309 
ušt64_t
 
	go_d_id
;

310 
ušt64_t
 
	go_c_id
;

311 
ušt64_t
 
	go_id
;

314 
	sÜd”_key
 {

315 
Üd”_key
(
ušt64_t
 
wid
, ušt64_ˆ
did
, ušt64_ˆ
oid
) {

316 
	go_w_id
 = 
bsw­
(
wid
);

317 
	go_d_id
 = 
bsw­
(
did
);

318 
	go_id
 = 
bsw­
(
oid
);

321 
Üd”_key
(cÚ¡ 
lcdf
::
SŒ
& 
mt_key
) {

322 
as£¹
(
mt_key
.
Ëngth
(è=ğ(*
this
));

323 
memıy
(
this
, 
mt_key
.
d©a
(), (*this));

325 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Üd”_key
& 
Ùh”
) const {

326  (
o_w_id
 =ğ
Ùh”
.o_w_idè&& (
o_d_id
 =ğÙh”.o_d_idè&& (
o_id
 == other.o_id);

328 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
Üd”_key
& 
Ùh”
) const {

329  !(*
this
 =ğ
Ùh”
);

331 
İ”©Ü
 
	glcdf
::
SŒ
() const {

332  
lcdf
::
SŒ
((cÚ¡ *)
this
, (*this));

335 
ušt64_t
 
	go_w_id
;

336 
ušt64_t
 
	go_d_id
;

337 
ušt64_t
 
	go_id
;

340 
	sÜd”_v®ue
{

341 şas 
	cNamedCŞumn
 : { 
o_c_id
 = 0,

342 
	go_ÿ¼›r_id
,

343 
	go_’Œy_d
,

344 
	go_Ş_út
,

345 
	go_®l_loÿl
 };

347 
ušt64_t
 
	go_c_id
;

348 
ušt64_t
 
	go_ÿ¼›r_id
;

349 
ušt32_t
 
	go_’Œy_d
;

350 
ušt32_t
 
	go_Ş_út
;

351 
ušt32_t
 
	go_®l_loÿl
;

356 
	sÜd”lše_key
 {

357 
Üd”lše_key
(
ušt64_t
 
w
, ušt64_ˆ
d
, ušt64_ˆ
o
, ušt64_ˆ
n
) {

358 
	gŞ_w_id
 = 
bsw­
(
w
);

359 
	gŞ_d_id
 = 
bsw­
(
d
);

360 
	gŞ_o_id
 = 
bsw­
(
o
);

361 
	gŞ_numb”
 = 
bsw­
(
n
);

364 
Üd”lše_key
(cÚ¡ 
lcdf
::
SŒ
& 
mt_key
) {

365 
as£¹
(
mt_key
.
Ëngth
(è=ğ(*
this
));

366 
memıy
(
this
, 
mt_key
.
d©a
(), (*this));

368 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Üd”lše_key
& 
Ùh”
) const {

369  (
Ş_w_id
 =ğ
Ùh”
.Ş_w_idè&& (
Ş_d_id
 == other.ol_d_id) &&

370 (
Ş_o_id
 =ğ
Ùh”
.Ş_o_idè&& (
Ş_numb”
 == other.ol_number);

372 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
Üd”lše_key
& 
Ùh”
) const {

373  !(*
this
 =ğ
Ùh”
);

375 
İ”©Ü
 
	glcdf
::
SŒ
() const {

376  
lcdf
::
SŒ
((cÚ¡ *)
this
, (*this));

379 
ušt64_t
 
	gŞ_w_id
;

380 
ušt64_t
 
	gŞ_d_id
;

381 
ušt64_t
 
	gŞ_o_id
;

382 
ušt64_t
 
	gŞ_numb”
;

385 
	sÜd”lše_v®ue
 {

386 şas 
	cNamedCŞumn
 : { 
Ş_i_id
 = 0,

387 
	gŞ_suµly_w_id
,

388 
	gŞ_d–iv”y_d
,

389 
	gŞ_quªt™y
,

390 
	gŞ_amouÁ
,

391 
	gŞ_di¡_šfo
 };

393 
ušt64_t
 
	gŞ_i_id
;

394 
ušt64_t
 
	gŞ_suµly_w_id
;

395 
ušt32_t
 
	gŞ_d–iv”y_d
;

396 
ušt32_t
 
	gŞ_quªt™y
;

397 
št32_t
 
	gŞ_amouÁ
;

398 
	gfix_¡ršg
<24> 
	gŞ_di¡_šfo
;

403 
	s™em_key
 {

404 
™em_key
(
ušt64_t
 
id
) {

405 
	gi_id
 = 
bsw­
(
id
);

408 
™em_key
(cÚ¡ 
lcdf
::
SŒ
& 
mt_key
) {

409 
as£¹
(
mt_key
.
Ëngth
(è=ğ(*
this
));

410 
memıy
(
this
, 
mt_key
.
d©a
(), (*this));

412 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
™em_key
& 
Ùh”
) const {

413  
i_id
 =ğ
Ùh”
.i_id;

415 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
™em_key
& 
Ùh”
) const {

416  
i_id
 !ğ
Ùh”
.i_id;

418 
İ”©Ü
 
	glcdf
::
SŒ
() const {

419  
lcdf
::
SŒ
((cÚ¡ *)
this
, (*this));

422 
ušt64_t
 
	gi_id
;

425 
	s™em_v®ue
 {

426 şas 
	cNamedCŞumn
 : { 
i_im_id
 = 0,

427 
	gi_´iû
,

428 
	gi_Çme
,

429 
	gi_d©a
 };

431 
ušt64_t
 
	gi_im_id
;

432 
ušt32_t
 
	gi_´iû
;

433 
	gv¬_¡ršg
<24> 
	gi_Çme
;

434 
	gv¬_¡ršg
<50> 
	gi_d©a
;

439 
	s¡ock_key
 {

440 
¡ock_key
(
ušt64_t
 
w
, ušt64_ˆ
i
) {

441 
	gs_w_id
 = 
bsw­
(
w
);

442 
	gs_i_id
 = 
bsw­
(
i
);

445 
¡ock_key
(cÚ¡ 
lcdf
::
SŒ
& 
mt_key
) {

446 
as£¹
(
mt_key
.
Ëngth
(è=ğ(*
this
));

447 
memıy
(
this
, 
mt_key
.
d©a
(), (*this));

449 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
¡ock_key
& 
Ùh”
) const {

450  (
s_w_id
 =ğ
Ùh”
.s_w_idè&& (
s_i_id
 == other.s_i_id);

452 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
¡ock_key
& 
Ùh”
) const {

453  !(*
this
 =ğ
Ùh”
);

455 
İ”©Ü
 
	glcdf
::
SŒ
() const {

456  
lcdf
::
SŒ
((cÚ¡ *)
this
, (*this));

459 
ušt64_t
 
	gs_w_id
;

460 
ušt64_t
 
	gs_i_id
;

463 
	s¡ock_v®ue
 {

464 şas 
	cNamedCŞumn
 : { 
s_quªt™y
,

465 
	gs_ytd
,

466 
	gs_Üd”_út
,

467 
	gs_»mÙe_út
,

468 
	gs_di¡s
,

469 
	gs_d©a
 };

471 
št32_t
 
	gs_quªt™y
;

472 
ušt32_t
 
	gs_ytd
;

473 
ušt32_t
 
	gs_Üd”_út
;

474 
ušt32_t
 
	gs_»mÙe_út
;

475 
	gfix_¡ršg
<24> 
	gs_di¡s
[
NUM_DISTRICTS_PER_WAREHOUSE
];

476 
	gv¬_¡ršg
<50> 
	gs_d©a
;

481 
Çme¥aû
 
	g¡d
 {

483 
cÚ¡ex´
 
size_t
 
	gxxh_£ed
 = 0xdeadbeefdeadbeef;

485 
usšg
 
	gb’ch
::
v¬_¡ršg
;

486 
usšg
 
	gb’ch
::
fix_¡ršg
;

487 
usšg
 
	gb’ch
::
bsw­
;

489 
	g‹m¶©e
 <
size_t
 
	gML
>

490 
	ghash
<
	gv¬_¡ršg
<
	gML
>> {

491 
size_t
 
İ”©Ü
()(cÚ¡ 
	gv¬_¡ršg
<
	gML
>& 
	g¬g
) const {

492  
XXH64
(
¬g
.
s_
, 
ML
 + 1, 
xxh_£ed
);

496 
	g‹m¶©e
 <
size_t
 
	gFL
>

497 
	ghash
<
	gfix_¡ršg
<
	gFL
>> {

498 
size_t
 
İ”©Ü
()(cÚ¡ 
	gfix_¡ršg
<
	gFL
>& 
	g¬g
) const {

499  
XXH64
(
¬g
.
s_
, 
FL
, 
xxh_£ed
);

503 
	g‹m¶©e
 <>

504 
	ghash
<
	gcc
::
w¬ehou£_key
> {

505 
size_t
 
İ”©Ü
()(cÚ¡ 
cc
::
w¬ehou£_key
& 
¬g
) const {

506  
¬g
.
w_id
;

510 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gos
, cÚ¡ 
	gcc
::
w¬ehou£_key
& 
wk
) {

511 
os
 << "w¬ehou£_key:" << 
bsw­
(
wk
.
w_id
);

512  
	gos
;

515 
	g‹m¶©e
 <>

516 
	ghash
<
	gcc
::
di¡riù_key
> {

517 
size_t
 
İ”©Ü
()(cÚ¡ 
cc
::
di¡riù_key
& 
¬g
) const {

518  
XXH64
(&
¬g
, (
cc
::
di¡riù_key
), 
xxh_£ed
);

522 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gos
, cÚ¡ 
	gcc
::
di¡riù_key
& 
dk
) {

523 
os
 << "district_key:w="

524 << 
bsw­
(
dk
.
d_w_id
) << ",d="

525 << 
bsw­
(
dk
.
d_id
);

526  
	gos
;

529 
	g‹m¶©e
 <>

530 
	ghash
<
	gcc
::
cu¡om”_key
> {

531 
size_t
 
İ”©Ü
()(cÚ¡ 
cc
::
cu¡om”_key
& 
¬g
) const {

532  
XXH64
(&
¬g
, (
cc
::
cu¡om”_key
), 
xxh_£ed
);

536 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gos
, cÚ¡ 
	gcc
::
cu¡om”_key
& 
ck
) {

537 
os
 << "customer_key:w="

538 << 
bsw­
(
ck
.
c_w_id
) << ",d="

539 << 
bsw­
(
ck
.
c_d_id
) << ",c="

540 << 
bsw­
(
ck
.
c_id
);

541  
	gos
;

544 
	g‹m¶©e
 <>

545 
	ghash
<
	gcc
::
hi¡Üy_key
> {

546 
size_t
 
İ”©Ü
()(cÚ¡ 
cc
::
hi¡Üy_key
& 
¬g
) const {

547  
¬g
.
h_id
;

551 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gos
, cÚ¡ 
	gcc
::
hi¡Üy_key
& 
hk
) {

552 
os
 << "hi¡Üy_key:" << 
bsw­
(
hk
.
h_id
);

553  
	gos
;

556 
	g‹m¶©e
 <>

557 
	ghash
<
	gcc
::
Üd”_key
> {

558 
size_t
 
İ”©Ü
()(cÚ¡ 
cc
::
Üd”_key
& 
¬g
) const {

559  
XXH64
(&
¬g
, (
cc
::
Üd”_key
), 
xxh_£ed
);

563 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gos
, cÚ¡ 
	gcc
::
Üd”_key
& 
ok
) {

564 
os
 << "order_key";

565 ()
	gok
;

566  
	gos
;

569 
	g‹m¶©e
 <>

570 
	ghash
<
	gcc
::
Üd”lše_key
> {

571 
size_t
 
İ”©Ü
()(cÚ¡ 
cc
::
Üd”lše_key
& 
¬g
) const {

572  
XXH64
(&
¬g
, (
cc
::
Üd”lše_key
), 
xxh_£ed
);

576 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gos
, cÚ¡ 
	gcc
::
Üd”lše_key
& 
Şk
) {

577 
os
 << "orderline_key";

578 ()
	gŞk
;

579  
	gos
;

582 
	g‹m¶©e
 <>

583 
	ghash
<
	gcc
::
™em_key
> {

584 
size_t
 
İ”©Ü
()(cÚ¡ 
cc
::
™em_key
& 
¬g
) const {

585  
¬g
.
i_id
;

589 
	g‹m¶©e
 <>

590 
	ghash
<
	gcc
::
¡ock_key
> {

591 
size_t
 
İ”©Ü
()(cÚ¡ 
cc
::
¡ock_key
& 
¬g
) const {

592  
XXH64
(&
¬g
, (
cc
::
¡ock_key
), 
xxh_£ed
);

596 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gos
, cÚ¡ 
	gcc
::
cu¡om”_idx_key
& 
cik
) {

597 
os
 << "customer_idx_key";

598 ()
	gcik
;

599  
	gos
;

602 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gos
, cÚ¡ 
	gcc
::
Üd”_cidx_key
& 
oik
) {

603 
os
 << "order_cidx_key";

604 ()
	goik
;

605  
	gos
;

	@benchmark/TPCC_txns.hh

1 #´agm¨
Úû


3 
	~"TPCC_b’ch.hh
"

5 
Çme¥aû
 
	gcc
 {

7 
	sc_d©a_šfo
 {

8 
c_d©a_šfo
 (
ušt64_t
 
c
, ušt64_ˆ
cd
, ušt64_ˆ
cw
, ušt64_ˆ
d
, ušt64_ˆ
w
, 
št64_t
 
hm
)

9 : 
cid
(
c
), 
cdid
(
cd
), 
cwid
(
cw
), 
did
(
d
), 
wid
(
w
), 
h_amouÁ
(
hm
) {}

10 cÚ¡ *
buf
() const {

11  
	g»š‹½»t_ÿ¡
<cÚ¡ *>(&
	gcid
);

14 
cÚ¡ex´
 
size_t
 
	gËn
 = (
ušt64_t
)*6;

16 
ušt64_t
 
	gcid
, 
	gcdid
, 
	gcwid
;

17 
ušt64_t
 
	gdid
, 
	gwid
;

18 
št64_t
 
	gh_amouÁ
;

21 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

22 
	gcc_ruÂ”
<
	gDBP¬ams
>::
run_txn_ÃwÜd”
() {

25 
di¡riù_v®ue
::
	tNamedCŞumn
 
	tdt_nc
;

26 
	gcu¡om”_v®ue
::
	tNamedCŞumn
 
	tcu_nc
;

27 
	g¡ock_v®ue
::
	tNamedCŞumn
 
	t¡_nc
;

29 
ušt64_t
 
	gq_w_id
 = 
ig
.
¿ndom
(
w_id_¡¬t
, 
w_id_’d
);

30 
ušt64_t
 
	gq_d_id
 = 
ig
.
¿ndom
(1, 10);

31 
ušt64_t
 
	gq_c_id
 = 
ig
.
g’_cu¡om”_id
();

32 
ušt64_t
 
	gnum_™ems
 = 
ig
.
¿ndom
(5, 15);

35 
ušt64_t
 
	gŞ_i_ids
[15];

36 
ušt64_t
 
	gŞ_suµly_w_ids
[15];

37 
ušt64_t
 
	gŞ_quªt™›s
[15];

39 
ušt32_t
 
	go_’Œy_d
 = 
ig
.
g’_d©e
();

41 
boŞ
 
	g®l_loÿl
 = 
Œue
;

43 
ušt64_t
 
	gi
 = 0; i < 
	gnum_™ems
; ++i) {

44 
ušt64_t
 
	gŞ_i_id
 = 
ig
.
g’_™em_id
();

49 
	gŞ_i_ids
[
i
] = 
Ş_i_id
;

51 
boŞ
 
	gsuµly_äom_»mÙe
 = (
ig
.
num_w¬ehou£s
(è> 1è&& (ig.
¿ndom
(1, 100) == 1);

52 
ušt64_t
 
	gŞ_s_w_id
 = 
q_w_id
;

53 ià(
	gsuµly_äom_»mÙe
) {

55 
	gŞ_s_w_id
 = 
ig
.
¿ndom
(1, ig.
num_w¬ehou£s
());

56 } 
	gŞ_s_w_id
 =ğ
q_w_id
);

57 
	g®l_loÿl
 = 
çl£
;

59 
	gŞ_suµly_w_ids
[
i
] = 
Ş_s_w_id
;

61 
	gŞ_quªt™›s
[
i
] = 
ig
.
¿ndom
(1, 10);

65 vŞ©
	gv¬_¡ršg
<16> 
	gout_cus_Ï¡
;

66 vŞ©
	gfix_¡ršg
<2> 
	gout_cus_üed™
;

67 vŞ©
	gv¬_¡ršg
<24> 
	gout_™em_Çmes
[15];

68 vŞ©
	gout_tÙ®_amouÁ
 = 0.0;

69 vŞ©
	gout_b¿nd_g’”ic
[15];

70 (è
	gout_b¿nd_g’”ic
;

73 
	gTRANSACTION
 {

75 
boŞ
 
	gabÜt
, 
	g»suÉ
;

76 
ušŒ_t
 
	grow
;

77 cÚ¡ *
	gv®ue
;

79 
št64_t
 
	gwh_x_¿‹
, 
	gdt_x_¿‹
;

80 
ušt64_t
 
	gdt_Ãxt_oid
;

82 auto& 
	gwv
 = 
db
.
g‘_w¬ehou£
(
q_w_id
);

83 
	gwh_x_¿‹
 = 
wv
.
cv
.
w_x
;

85 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
row
, 
v®ue
èğ
db
.
tbl_di¡riùs
(
q_w_id
).
£Ëù_row
(
di¡riù_key
(q_w_id, 
q_d_id
), {{
dt_nc
::
d_x
, 
çl£
}});

86 
TXN_DO
(
abÜt
);

87 
as£¹
(
»suÉ
);

88 autØ
	gdv
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
di¡riù_v®ue
 *>(
v®ue
);

89 
	gdt_x_¿‹
 = 
dv
->
d_x
;

90 
	gdt_Ãxt_oid
 = 
db
.
oid_g’”©Ü
().
Ãxt
(
q_w_id
, 
q_d_id
);

94 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
¡d
::
ignÜe
, 
v®ue
èğ
db
.
tbl_cu¡om”s
(
q_w_id
).
£Ëù_row
(
cu¡om”_key
(q_w_id, 
q_d_id
, 
q_c_id
), {{
cu_nc
::
c_discouÁ
, 
çl£
}, {cu_nc::
c_Ï¡
, f®£}, {cu_nc::
c_üed™
, false}});

95 
TXN_DO
(
abÜt
);

96 
as£¹
(
»suÉ
);

98 autØ
	gcus_discouÁ
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
cu¡om”_v®ue
 *>(
v®ue
)->
c_discouÁ
;

99 
	gout_cus_Ï¡
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
cu¡om”_v®ue
 *>(
v®ue
)->
c_Ï¡
;

100 
	gout_cus_üed™
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
cu¡om”_v®ue
 *>(
v®ue
)->
c_üed™
;

102 
Üd”_key
 
ok
(
q_w_id
, 
q_d_id
, 
dt_Ãxt_oid
);

103 
Üd”_v®ue
* 
	gov
 = 
Sto
::
tx_®loc
<order_value>();

104 
	gov
->
	go_c_id
 = 
q_c_id
;

105 
	gov
->
	go_ÿ¼›r_id
 = 0;

106 
	gov
->
	go_®l_loÿl
 = 
®l_loÿl
 ? 1 : 0;

107 
	gov
->
	go_’Œy_d
 = 
o_’Œy_d
;

108 
	gov
->
	go_Ş_út
 = 
num_™ems
;

110 
Üd”_cidx_key
 
ock
(
q_w_id
, 
q_d_id
, 
q_c_id
, 
dt_Ãxt_oid
);

112 
	g¡d
::
t›
(
abÜt
, 
»suÉ
èğ
db
.
tbl_Üd”s
(
q_w_id
).
š£¹_row
(
ok
, 
ov
, 
çl£
);

113 
TXN_DO
(
abÜt
);

114 
as£¹
(!
»suÉ
);

115 
	g¡d
::
t›
(
abÜt
, 
»suÉ
èğ
db
.
tbl_ÃwÜd”s
(
q_w_id
).
š£¹_row
(
ok
, 
nuÎ±r
, 
çl£
);

116 
TXN_DO
(
abÜt
);

117 
as£¹
(!
»suÉ
);

118 
	g¡d
::
t›
(
abÜt
, 
»suÉ
èğ
db
.
tbl_Üd”_cu¡om”_šdex
(
q_w_id
).
š£¹_row
(
ock
, 
nuÎ±r
, 
çl£
);

119 
TXN_DO
(
abÜt
);

120 
as£¹
(!
»suÉ
);

122 
ušt64_t
 
	gi
 = 0; i < 
	gnum_™ems
; ++i) {

123 
ušt64_t
 
	giid
 = 
Ş_i_ids
[
i
];

124 
ušt64_t
 
	gwid
 = 
Ş_suµly_w_ids
[
i
];

125 
ušt64_t
 
	gqty
 = 
Ş_quªt™›s
[
i
];

127 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
¡d
::
ignÜe
, 
v®ue
èğ
db
.
tbl_™ems
().
£Ëù_row
(
™em_key
(
iid
), 
RowAcûss
::
Ob£rveV®ue
);

128 
TXN_DO
(
abÜt
);

129 
as£¹
(
»suÉ
);

130 
ušt64_t
 
	goid
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
™em_v®ue
 *>(
v®ue
)->
i_im_id
;

131 
TXN_DO
(
oid
 != 0);

132 
ušt32_t
 
	gi_´iû
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
™em_v®ue
 *>(
v®ue
)->
i_´iû
;

133 
	gout_™em_Çmes
[
i
] = 
»š‹½»t_ÿ¡
<cÚ¡ 
™em_v®ue
 *>(
v®ue
)->
i_Çme
;

134 autØ
	gi_d©a
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
™em_v®ue
 *>(
v®ue
)->
i_d©a
;

136 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
row
, 
v®ue
èğ
db
.
tbl_¡ocks
(
wid
).
£Ëù_row
(
¡ock_key
(wid, 
iid
), {{
¡_nc
::
s_quªt™y
, 
Œue
}, {¡_nc::
s_di¡s
, 
çl£
}, {¡_nc::
s_d©a
, f®£}, {¡_nc::
s_ytd
,rue}, {¡_nc::
s_Üd”_út
,rue}, {¡_nc::
s_»mÙe_út
,rue}});

137 
TXN_DO
(
abÜt
);

138 
as£¹
(
»suÉ
);

139 
¡ock_v®ue
 *
	gÃw_sv
 = 
Sto
::
tx_®loc
(
»š‹½»t_ÿ¡
<cÚ¡ stock_v®u*>(
v®ue
));

140 
št32_t
 
	gs_quªt™y
 = 
Ãw_sv
->
s_quªt™y
;

141 autØ
	gs_di¡
 = 
Ãw_sv
->
s_di¡s
[
q_d_id
 - 1];

142 autØ
	gs_d©a
 = 
Ãw_sv
->
s_d©a
;

144 ià(
	gi_d©a
.
cÚšs
("ORIGINAL"è&& 
	gs_d©a
.contains("ORIGINAL"))

145 
	gout_b¿nd_g’”ic
[
i
] = 'B';

147 
	gout_b¿nd_g’”ic
[
i
] = 'G';

149 ià((
	gs_quªt™y
 - 10è>ğ(
št32_t
)
qty
)

150 
Ãw_sv
->
s_quªt™y
 -ğ
qty
;

152 
	gÃw_sv
->
	gs_quªt™y
 +ğ(91 - (
št32_t
)
qty
);

153 
	gÃw_sv
->
	gs_ytd
 +ğ
qty
;

154 
	gÃw_sv
->
	gs_Üd”_út
 += 1;

155 ià(
	gwid
 !ğ
q_w_id
)

156 
Ãw_sv
->
s_»mÙe_út
 += 1;

157 
	gdb
.
tbl_¡ocks
(
wid
).
upd©e_row
(
row
, 
Ãw_sv
);

159 
	gŞ_amouÁ
 = 
qty
 * 
i_´iû
/100.0;

161 
Üd”lše_key
 
Şk
(
q_w_id
, 
q_d_id
, 
dt_Ãxt_oid
, 
i
);

162 
Üd”lše_v®ue
 *
	gŞv
 = 
Sto
::
tx_®loc
<orderline_value>();

163 
	gŞv
->
	gŞ_i_id
 = 
iid
;

164 
	gŞv
->
	gŞ_suµly_w_id
 = 
wid
;

165 
	gŞv
->
	gŞ_d–iv”y_d
 = 0;

166 
	gŞv
->
	gŞ_quªt™y
 = 
qty
;

167 
	gŞv
->
	gŞ_amouÁ
 = 
Ş_amouÁ
;

168 
	gŞv
->
	gŞ_di¡_šfo
 = 
s_di¡
;

170 
	g¡d
::
t›
(
abÜt
, 
»suÉ
èğ
db
.
tbl_Üd”lšes
(
q_w_id
).
š£¹_row
(
Şk
, 
Şv
, 
çl£
);

171 
TXN_DO
(
abÜt
);

172 
as£¹
(!
»suÉ
);

174 
	gout_tÙ®_amouÁ
 +ğ
Ş_amouÁ
 * (1.0 - 
cus_discouÁ
/100.0è* (1.0 + (
wh_x_¿‹
 + 
dt_x_¿‹
)/100.0);

179 } 
RETRY
(
Œue
);

182 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

183 
	gcc_ruÂ”
<
	gDBP¬ams
>::
run_txn_·ym’t
() {

185 
di¡riù_v®ue
::
	tNamedCŞumn
 
	tdt_nc
;

186 
	gcu¡om”_v®ue
::
	tNamedCŞumn
 
	tcu_nc
;

189 
ušt64_t
 
	gq_w_id
 = 
ig
.
¿ndom
(
w_id_¡¬t
, 
w_id_’d
);

190 
ušt64_t
 
	gq_d_id
 = 
ig
.
¿ndom
(1, 10);

192 
ušt64_t
 
	gq_c_w_id
, 
	gq_c_d_id
, 
	gq_c_id
;

193 
	g¡d
::
¡ršg
 
Ï¡_Çme
;

194 autØ
	gx
 = 
ig
.
¿ndom
(1, 100);

195 autØ
	gy
 = 
ig
.
¿ndom
(1, 100);

197 
boŞ
 
	gis_home
 = (
ig
.
num_w¬ehou£s
(è=ğ1è|| (
x
 <= 85);

198 
boŞ
 
	gby_Çme
 = (
y
 <= 60);

200 ià(
	gis_home
) {

201 
	gq_c_w_id
 = 
q_w_id
;

202 
	gq_c_d_id
 = 
q_d_id
;

205 
	gq_c_w_id
 = 
ig
.
¿ndom
(1, ig.
num_w¬ehou£s
());

206 } 
	gq_c_w_id
 =ğ
q_w_id
);

207 
	gq_c_d_id
 = 
ig
.
¿ndom
(1, 10);

210 ià(
	gby_Çme
) {

211 
	gÏ¡_Çme
 = 
ig
.
g’_cu¡om”_Ï¡_Çme_run
();

212 
	gq_c_id
 = 0;

214 
	gq_c_id
 = 
ig
.
g’_cu¡om”_id
();

217 
št64_t
 
	gh_amouÁ
 = 
ig
.
¿ndom
(100, 500000);

218 
ušt32_t
 
	gh_d©e
 = 
ig
.
g’_d©e
();

221 vŞ©
	gv¬_¡ršg
<10> 
	gout_w_Çme
, 
	gout_d_Çme
;

222 vŞ©
	gv¬_¡ršg
<20> 
	gout_w_¡»‘_1
, 
	gout_w_¡»‘_2
, 
	gout_w_c™y
;

223 vŞ©
	gv¬_¡ršg
<20> 
	gout_d_¡»‘_1
, 
	gout_d_¡»‘_2
, 
	gout_d_c™y
;

224 vŞ©
	gfix_¡ršg
<2> 
	gout_w_¡©e
, 
	gout_d_¡©e
;

225 vŞ©
	gfix_¡ršg
<9> 
	gout_w_z
, 
	gout_d_z
;

226 vŞ©
	gv¬_¡ršg
<16> 
	gout_c_fœ¡
, 
	gout_c_Ï¡
;

227 vŞ©
	gfix_¡ršg
<2> 
	gout_c_middË
;

228 vŞ©
	gv¬_¡ršg
<20> 
	gout_c_¡»‘_1
, 
	gout_c_¡»‘_2
, 
	gout_c_c™y
;

229 vŞ©
	gfix_¡ršg
<2> 
	gout_c_¡©e
;

230 vŞ©
	gfix_¡ršg
<9> 
	gout_c_z
;

231 vŞ©
	gfix_¡ršg
<16> 
	gout_c_phÚe
;

232 vŞ©
	gfix_¡ršg
<2> 
	gout_c_üed™
;

233 vŞ©
ušt32_t
 
	gout_c_sšû
;

234 vŞ©
št64_t
 
	gout_c_üed™_lim
;

235 vŞ©
št64_t
 
	gout_c_discouÁ
;

236 vŞ©
št64_t
 
	gout_c_b®ªû
;

237 ()
	gout_c_sšû
;

238 ()
	gout_c_üed™_lim
;

239 ()
	gout_c_discouÁ
;

240 ()
	gout_c_b®ªû
;

243 
	gTRANSACTION
 {

245 
boŞ
 
	gsucûss
, 
	g»suÉ
;

246 
ušŒ_t
 
	grow
;

247 cÚ¡ *
	gv®ue
;

250 
w¬ehou£_key
 
wk
(
q_w_id
);

251 auto& 
	gwv
 = 
db
.
g‘_w¬ehou£
(
q_w_id
);

253 
	gout_w_Çme
 = 
wv
.
cv
.
w_Çme
;

254 
	gout_w_¡»‘_1
 = 
wv
.
cv
.
w_¡»‘_1
;

255 
	gout_w_¡»‘_2
 = 
wv
.
cv
.
w_¡»‘_2
;

256 
	gout_w_c™y
 = 
wv
.
cv
.
w_c™y
;

257 
	gout_w_¡©e
 = 
wv
.
cv
.
w_¡©e
;

258 
	gout_w_z
 = 
wv
.
cv
.
w_z
;

261 
	gwv
.
	gytd
.
Œªs_šüem’t
(
h_amouÁ
);

264 
di¡riù_key
 
dk
(
q_w_id
, 
q_d_id
);

265 
	g¡d
::
t›
(
sucûss
, 
»suÉ
, 
row
, 
v®ue
èğ
db
.
tbl_di¡riùs
(
q_w_id
).
£Ëù_row
(
dk
, {{
dt_nc
::
d_Çme
, 
çl£
}, {dt_nc::
d_¡»‘_1
, f®£}, {dt_nc::
d_¡»‘_2
, f®£}, {dt_nc::
d_c™y
, f®£}, {dt_nc::
d_¡©e
, f®£}, {dt_nc::
d_z
, f®£}, {dt_nc::
d_ytd
, 
Œue
}}

267 
TXN_DO
(
sucûss
);

268 
as£¹
(
»suÉ
);

270 autØ
	gdv
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
di¡riù_v®ue
 *>(
v®ue
);

272 autØ
	gÃw_dv
 = 
Sto
::
tx_®loc
<
di¡riù_v®ue
>(
dv
);

273 
	gout_d_Çme
 = 
Ãw_dv
->
d_Çme
;

274 
	gout_d_¡»‘_1
 = 
Ãw_dv
->
d_¡»‘_1
;

275 
	gout_d_¡»‘_2
 = 
Ãw_dv
->
d_¡»‘_2
;

276 
	gout_d_c™y
 = 
Ãw_dv
->
d_c™y
;

277 
	gout_d_¡©e
 = 
Ãw_dv
->
d_¡©e
;

278 
	gout_d_z
 = 
Ãw_dv
->
d_z
;

280 
	gÃw_dv
->
	gd_ytd
 +ğ
h_amouÁ
;

281 
	gdb
.
tbl_di¡riùs
(
q_w_id
).
upd©e_row
(
row
, 
Ãw_dv
);

284 ià(
	gby_Çme
) {

285 
	g¡d
::
veùÜ
<
ušt64_t
> 
m©ches
;

286 autØ
	gsÿn_ÿÎback
 = [&] (cÚ¡ 
cu¡om”_idx_key
& 
key
, cÚ¡ 
	gcu¡om”_idx_v®ue
& 
	gciv
è-> 
	gboŞ
 {

287 ()
	gkey
;

288 
	gm©ches
.
em¶aû_back
(
civ
.
c_id
);

289  
	gŒue
;

292 
cu¡om”_idx_key
 
ck0
(
q_c_w_id
, 
q_c_d_id
, 
Ï¡_Çme
, 0x00 );

293 
cu¡om”_idx_key
 
ck1
(
q_c_w_id
, 
q_c_d_id
, 
Ï¡_Çme
, 0xff);

295 
	gsucûss
 = 
db
.
tbl_cu¡om”_šdex
(
q_c_w_id
)

296 .
‹m¶©e
 
¿nge_sÿn
<
deşty³
(
sÿn_ÿÎback
), 
	gçl£
 >(
	gck0
, 
	gck1
, 
	gsÿn_ÿÎback
, 
	gRowAcûss
::
Ob£rveV®ue
);

297 
TXN_DO
(
sucûss
);

299 
size_t
 
	gn
 = 
m©ches
.
size
();

300 
®ways_as£¹
(
n
 > 0, "match size invalid");

301 
size_t
 
	gidx
 = 
n
 / 2;

302 ià(
	gn
 % 2 == 0)

303 
idx
 -= 1;

304 
	gq_c_id
 = 
m©ches
[
idx
];

307 
®ways_as£¹
(
q_c_id
 != 0, "q_c_id invalid when selecting customer by c_id");

310 
cu¡om”_key
 
ck
(
q_c_w_id
, 
q_c_d_id
, 
q_c_id
);

311 
	g¡d
::
t›
(
sucûss
, 
»suÉ
, 
row
, 
v®ue
èğ
db
.
tbl_cu¡om”s
(
q_c_w_id
).
£Ëù_row
(
ck
, {{
cu_nc
::
c_b®ªû
, 
Œue
}, {cu_nc::
c_ytd_·ym’t
,rue}, {cu_nc::
c_·ym’t_út
,rue}, {cu_nc::
c_sšû
, 
çl£
}, {cu_nc::
c_üed™_lim
, f®£}, {cu_nc::
c_discouÁ
, f®£}, {cu_nc::
c_d©a
,rue}});

312 
TXN_DO
(
sucûss
);

313 
as£¹
(
»suÉ
);

315 autØ
	gcv
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
cu¡om”_v®ue
 *>(
v®ue
);

316 
cu¡om”_v®ue
 *
	gÃw_cv
 = 
Sto
::
tx_®loc
(
cv
);

318 
	gÃw_cv
->
	gc_b®ªû
 -ğ
h_amouÁ
;

319 
	gÃw_cv
->
	gc_ytd_·ym’t
 +ğ
h_amouÁ
;

320 
	gÃw_cv
->
	gc_·ym’t_út
 += 1;

322 
	gout_c_sšû
 = 
Ãw_cv
->
c_sšû
;

323 
	gout_c_üed™_lim
 = 
Ãw_cv
->
c_üed™_lim
;

324 
	gout_c_discouÁ
 = 
Ãw_cv
->
c_discouÁ
;

325 
	gout_c_b®ªû
 = 
Ãw_cv
->
c_b®ªû
;

327 ià(
	gÃw_cv
->
	gc_üed™
 == "BC") {

328 autØ
šfo
 = 
c_d©a_šfo
(
q_c_id
, 
q_c_d_id
, 
q_c_w_id
, 
q_d_id
, 
q_w_id
, 
h_amouÁ
);

329 
	gÃw_cv
->
	gc_d©a
.
š£¹_Ëá
(
šfo
.
buf
(), info.
Ën
);

332 
	gdb
.
tbl_cu¡om”s
(
q_c_w_id
).
upd©e_row
(
row
, 
Ãw_cv
);

335 
hi¡Üy_v®ue
 *
	ghv
 = 
Sto
::
tx_®loc
<history_value>();

336 
	ghv
->
	gh_c_id
 = 
q_c_id
;

337 
	ghv
->
	gh_c_d_id
 = 
q_c_d_id
;

338 
	ghv
->
	gh_c_w_id
 = 
q_c_w_id
;

339 
	ghv
->
	gh_d_id
 = 
q_d_id
;

340 
	ghv
->
	gh_w_id
 = 
q_w_id
;

341 
	ghv
->
	gh_d©e
 = 
h_d©e
;

342 
	ghv
->
	gh_amouÁ
 = 
h_amouÁ
;

343 
	ghv
->
	gh_d©a
 = 
¡d
::
¡ršg
(
out_w_Çme
.
c_¡r
()è+ " " + std::¡ršg(
out_d_Çme
.c_str());

345 
hi¡Üy_key
 
hk
(
db
.
tbl_hi¡Ü›s
(
q_c_w_id
).
g’_key
());

346 
	g¡d
::
t›
(
sucûss
, 
»suÉ
èğ
db
.
tbl_hi¡Ü›s
(
q_c_w_id
).
š£¹_row
(
hk
, 
hv
);

347 
as£¹
(
sucûss
);

348 
as£¹
(!
»suÉ
);

352 } 
RETRY
(
Œue
);

355 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

356 
	gcc_ruÂ”
<
	gDBP¬ams
>::
run_txn_Üd”¡©us
() {

358 
cu¡om”_v®ue
::
	tNamedCŞumn
 
	tcu_nc
;

359 
	gÜd”_v®ue
::
	tNamedCŞumn
 
	tod_nc
;

361 
ušt64_t
 
	gq_w_id
 = 
ig
.
¿ndom
(
w_id_¡¬t
, 
w_id_’d
);

362 
ušt64_t
 
	gq_d_id
 = 
ig
.
¿ndom
(1, 10);

364 
	g¡d
::
¡ršg
 
Ï¡_Çme
;

365 
ušt64_t
 
	gq_c_id
;

367 autØ
	gx
 = 
ig
.
¿ndom
(1, 100);

368 
boŞ
 
	gby_Çme
 = (
x
 <= 60);

369 ià(
	gby_Çme
) {

370 
	gÏ¡_Çme
 = 
ig
.
g’_cu¡om”_Ï¡_Çme_run
();

371 
	gq_c_id
 = 0;

373 
	gq_c_id
 = 
ig
.
g’_cu¡om”_id
();

377 vŞ©
	gv¬_¡ršg
<16> 
	gout_c_fœ¡
, 
	gout_c_Ï¡
;

378 vŞ©
	gfix_¡ršg
<2> 
	gout_c_middË
;

379 vŞ©
št64_t
 
	gout_c_b®ªû
;

380 vŞ©
ušt64_t
 
	gout_o_ÿ¼›r_id
;

381 vŞ©
ušt32_t
 
	gout_o_’Œy_d©e
;

382 vŞ©
ušt64_t
 
	gout_Ş_i_id
;

383 vŞ©
ušt64_t
 
	gout_Ş_suµly_w_id
;

384 vŞ©
ušt32_t
 
	gout_Ş_quªt™y
;

385 vŞ©
ušt32_t
 
	gout_Ş_d–iv”y_d
;

386 vŞ©
št32_t
 
	gout_Ş_amouÁ
;

387 ()
	gout_c_b®ªû
;

388 ()
	gout_o_ÿ¼›r_id
;

389 ()
	gout_o_’Œy_d©e
;

391 
	gTRANSACTION
 {

393 
boŞ
 
	gsucûss
, 
	g»suÉ
;

394 
ušŒ_t
 
	grow
;

395 cÚ¡ *
	gv®ue
;

397 ià(
	gby_Çme
) {

398 
	g¡d
::
veùÜ
<
ušt64_t
> 
m©ches
;

399 autØ
	gsÿn_ÿÎback
 = [&] (cÚ¡ 
cu¡om”_idx_key
& 
key
, cÚ¡ 
	gcu¡om”_idx_v®ue
& 
	gciv
è-> 
	gboŞ
 {

400 ()
	gkey
;

401 
	gm©ches
.
em¶aû_back
(
civ
.
c_id
);

402  
	gŒue
;

405 
cu¡om”_idx_key
 
ck0
(
q_w_id
, 
q_d_id
, 
Ï¡_Çme
, 0x00);

406 
cu¡om”_idx_key
 
ck1
(
q_w_id
, 
q_d_id
, 
Ï¡_Çme
, 0xff);

408 
	gsucûss
 = 
db
.
tbl_cu¡om”_šdex
(
q_w_id
)

409 .
‹m¶©e
 
¿nge_sÿn
<
deşty³
(
sÿn_ÿÎback
), 
	gçl£
 >(
	gck0
, 
	gck1
, 
	gsÿn_ÿÎback
, 
	gRowAcûss
::
Ob£rveV®ue
);

410 
TXN_DO
(
sucûss
);

412 
size_t
 
	gn
 = 
m©ches
.
size
();

413 
®ways_as£¹
(
n
 > 0, "match size invalid");

414 
size_t
 
	gidx
 = 
n
 / 2;

415 ià(
	gn
 % 2 == 0)

416 
idx
 -= 1;

417 
	gq_c_id
 = 
m©ches
[
idx
];

419 
®ways_as£¹
(
q_c_id
 != 0, "q_c_id invalid when selecting customer by c_id");

422 
cu¡om”_key
 
ck
(
q_w_id
, 
q_d_id
, 
q_c_id
);

423 
	g¡d
::
t›
(
sucûss
, 
»suÉ
, 
row
, 
v®ue
èğ
db
.
tbl_cu¡om”s
(
q_w_id
).
£Ëù_row
(
ck
, {{
cu_nc
::
c_b®ªû
, 
çl£
}, {cu_nc::
c_fœ¡
, f®£}, {cu_nc::
c_Ï¡
, f®£}, {cu_nc::
c_middË
, false}});

424 
TXN_DO
(
sucûss
);

425 
as£¹
(
»suÉ
);

427 autØ
	gcv
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
cu¡om”_v®ue
 *>(
v®ue
);

430 
	gout_c_b®ªû
 = 
cv
->
c_b®ªû
;

431 
	gout_c_fœ¡
 = 
cv
->
c_fœ¡
;

432 
	gout_c_Ï¡
 = 
cv
->
c_Ï¡
;

433 
	gout_c_middË
 = 
cv
->
c_middË
;

436 
ušt64_t
 
	gcus_o_id
 = 0;

437 autØ
	gsÿn_ÿÎback
 = [&] (cÚ¡ 
Üd”_cidx_key
& 
key
, cÚ¡ 
	gb’ch
::
dummy_row
& 
dummy
è-> 
boŞ
 {

438 ()
dummy
;

439 
	gcus_o_id
 = 
key
.
o_id
;

440  
	gŒue
;

443 
Üd”_cidx_key
 
k0
(
q_w_id
, 
q_d_id
, 
q_c_id
, 0);

444 
Üd”_cidx_key
 
k1
(
q_w_id
, 
q_d_id
, 
q_c_id
, 
¡d
::
num”ic_lim™s
<
ušt64_t
>::
max
());

446 
	gsucûss
 = 
db
.
tbl_Üd”_cu¡om”_šdex
(
q_w_id
)

447 .
‹m¶©e
 
¿nge_sÿn
<
deşty³
(
sÿn_ÿÎback
), 
	gŒue
 >(
	gk0
, 
	gk1
, 
	gsÿn_ÿÎback
, 
	gRowAcûss
::
Ob£rveExi¡s
, 
	gçl£
, 1 );

448 
TXN_DO
(
sucûss
);

450 ià(
	gcus_o_id
 > 0) {

451 
Üd”_key
 
ok
(
q_w_id
, 
q_d_id
, 
cus_o_id
);

452 
	g¡d
::
t›
(
sucûss
, 
»suÉ
, 
row
, 
v®ue
èğ
db
.
tbl_Üd”s
(
q_w_id
).
£Ëù_row
(
ok
, {{
od_nc
::
o_’Œy_d
, 
çl£
}, {od_nc::
o_ÿ¼›r_id
, false}});

453 
TXN_DO
(
sucûss
);

454 
as£¹
(
»suÉ
);

456 autØ
	gov
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
Üd”_v®ue
 *>(
v®ue
);

457 
	gout_o_’Œy_d©e
 = 
ov
->
o_’Œy_d
;

458 
	gout_o_ÿ¼›r_id
 = 
ov
->
o_ÿ¼›r_id
;

460 autØ
	gŞ_sÿn_ÿÎback
 = [&] (cÚ¡ 
Üd”lše_key
& 
Şk
, cÚ¡ 
	gÜd”lše_v®ue
& 
	gŞv
è-> 
	gboŞ
 {

461 ()
	gŞk
;

462 
	gout_Ş_i_id
 = 
Şv
.
Ş_i_id
;

463 
	gout_Ş_suµly_w_id
 = 
Şv
.
Ş_suµly_w_id
;

464 
	gout_Ş_quªt™y
 = 
Şv
.
Ş_quªt™y
;

465 
	gout_Ş_amouÁ
 = 
Şv
.
Ş_amouÁ
;

466 
	gout_Ş_d–iv”y_d
 = 
Şv
.
Ş_d–iv”y_d
;

467  
	gŒue
;

470 
Üd”lše_key
 
Şk0
(
q_w_id
, 
q_d_id
, 
cus_o_id
, 0);

471 
Üd”lše_key
 
Şk1
(
q_w_id
, 
q_d_id
, 
cus_o_id
, 
¡d
::
num”ic_lim™s
<
ušt64_t
>::
max
());

473 
	gsucûss
 = 
db
.
tbl_Üd”lšes
(
q_w_id
)

474 .
‹m¶©e
 
¿nge_sÿn
<
deşty³
(
Ş_sÿn_ÿÎback
), 
	gŒue
 >(
	gŞk0
, 
	gŞk1
, 
	gŞ_sÿn_ÿÎback
, 
	gRowAcûss
::
Ob£rveV®ue
);

475 
TXN_DO
(
sucûss
);

482 } 
RETRY
(
Œue
);

	@benchmark/TPCE_structs.hh

1 #´agm¨
Úû


3 
	~<¡ršg
>

4 
	~<ÿs£¹
>

5 
	~"DB_¡ruùs.hh
"

6 
	~"¡r.hh
"

8 
Çme¥aû
 
	gû
 {

10 
usšg
 
Çme¥aû
 
	gb’ch
;

12 
	sz_code_key
 {

13 
	gfix_¡ršg
<12> 
	gzc_code
;

16 
	sz_code_row
 {

17 
	gv¬_¡ršg
<80> 
	gzc_town
;

18 
	gv¬_¡ršg
<80> 
	gzc_div
;

21 
	sadd»ss_key
 {

22 
št64_t
 
	gad_id
;

25 
	sadd»ss_row
 {

26 
	gv¬_¡ršg
<80> 
	gad_lše1
;

27 
	gv¬_¡ršg
<80> 
	gad_lše2
;

28 
	gfix_¡ršg
<12> 
	gad_zc_code
;

29 
	gv¬_¡ršg
<80> 
	gad_ùry
;

32 
	s¡©us_ty³_key
 {

33 
	gfix_¡ršg
<4> 
	g¡_id
;

36 
	s¡©us_ty³_row
 {

37 
	gfix_¡ršg
<10> 
	g¡_Çme
;

40 
	sx¿‹_key
 {

41 
	gfix_¡ršg
<4> 
	gtx_id
;

44 
	sx¿‹_row
 {

45 
	gv¬_¡ršg
<50> 
	gtx_Çme
;

46 
	gtx_¿‹
;

49 
	scu¡om”_key
 {

50 
št64_t
 
	gc_id
;

53 
	scu¡om”_row
 {

54 
	gv¬_¡ršg
<20> 
	gc_x_id
;

55 
	gfix_¡ršg
<4> 
	gc_¡_id
;

56 
	gv¬_¡ršg
<30> 
	gc_l_Çme
;

57 
	gv¬_¡ršg
<30> 
	gc_f_Çme
;

58 
	gfix_¡ršg
<1> 
	gc_m_Çme
;

59 
	gfix_¡ršg
<1> 
	gc_gndr
;

60 
št32_t
 
	gc_t›r
;

61 
ušt32_t
 
	gc_dob
;

62 
št64_t
 
	gc_ad_id
;

63 
	gfix_¡ršg
<3> 
	gc_ùry_1
;

64 
	gfix_¡ršg
<3> 
	gc_¬—_1
;

65 
	gfix_¡ršg
<10> 
	gc_loÿl_1
;

66 
	gfix_¡ršg
<5> 
	gc_ext_1
;

67 
	gfix_¡ršg
<3> 
	gc_ùry_2
;

68 
	gfix_¡ršg
<3> 
	gc_¬—_2
;

69 
	gfix_¡ršg
<10> 
	gc_loÿl_2
;

70 
	gfix_¡ršg
<5> 
	gc_ext_2
;

71 
	gfix_¡ršg
<3> 
	gc_ùry_3
;

72 
	gfix_¡ršg
<3> 
	gc_¬—_3
;

73 
	gfix_¡ršg
<10> 
	gc_loÿl_3
;

74 
	gfix_¡ršg
<5> 
	gc_ext_3
;

75 
	gv¬_¡ršg
<50> 
	gc_ema_1
;

76 
	gv¬_¡ršg
<50> 
	gc_ema_2
;

81 
	sexchªge_key
 {

82 
	gfix_¡ršg
<6> 
	gex_id
;

85 
	sexchªge_row
 {

86 
	gv¬_¡ršg
<100> 
	gex_Çme
;

87 
št32_t
 
	gex_num_symb
;

88 
št32_t
 
	gex_İ’
;

89 
št32_t
 
	gex_şo£
;

90 
	gv¬_¡ršg
<150> 
	gex_desc
;

91 
št64_t
 
	gex_ad_id
;

94 
	s£ùÜ_key
 {

95 
	gfix_¡ršg
<2> 
	gsc_id
;

98 
	s£ùÜ_row
 {

99 
	gv¬_¡ršg
<30> 
	gsc_Çme
;

102 
	sšdu¡ry_key
 {

103 
	gfix_¡ršg
<2> 
	gš_id
;

106 
	sšdu¡ry_row
 {

107 
	gv¬_¡ršg
<50> 
	gš_Çme
;

108 
	gfix_¡ršg
<2> 
	gš_sc_id
;

111 
	scom·ny_key
 {

112 
št64_t
 
	gco_id
;

115 
	scom·ny_row
 {

116 
	gfix_¡ršg
<4> 
	gco_¡_id
;

117 
	gv¬_¡ršg
<60> 
	gco_Çme
;

118 
	gfix_¡ršg
<2> 
	gco_š_id
;

119 
	gfix_¡ršg
<4> 
	gco_¥_¿‹
;

120 
	gv¬_¡ršg
<100> 
	gco_ûo
;

121 
št64_t
 
	gco_ad_id
;

122 
	gv¬_¡ršg
<150> 
	gco_desc
;

123 
ušt32_t
 
	gco_İ’_d©e
;

126 
	scom·ny_com³t™Ü_key
 {

127 
št64_t
 
	gı_co_id
;

128 
št64_t
 
	gı_comp_co_id
;

129 
	gfix_¡ršg
<2> 
	gı_š_id
;

132 
	s£cur™y_key
 {

133 
	gfix_¡ršg
<15> 
	gs_symb
;

136 
	s£cur™y_row
 {

137 
	gfix_¡ršg
<6> 
	gs_issue
;

138 
	gfix_¡ršg
<4> 
	gs_¡_id
;

139 
	gv¬_¡ršg
<70> 
	gs_Çme
;

140 
	gfix_¡ršg
<6> 
	gs_ex_id
;

141 
št64_t
 
	gs_co_id
;

142 
št64_t
 
	gs_num_out
;

143 
ušt32_t
 
	gs_¡¬t_d©e
;

144 
ušt32_t
 
	gs_exch_d©e
;

145 
	gs_³
;

146 
	gs_52wk_high
;

147 
ušt32_t
 
	gs_52wk_high_d©e
;

148 
	gs_52wk_low
;

149 
ušt32_t
 
	gs_52wk_low_d©e
;

150 
	gs_divid’d
;

151 
	gs_y›ld
;

154 
	sday_m¬k‘_key
 {

155 
ušt32_t
 
	gdm_d©e
;

156 
	gfix_¡ršg
<15> 
	gdm_s_symb
;

159 
	sday_m¬k‘_row
 {

160 
	gdm_şo£
;

161 
	gdm_high
;

162 
	gdm_low
;

163 
št64_t
 
	gdm_vŞ
;

166 
	sfšªcŸl_key
 {

167 
št64_t
 
	gfi_co_id
;

168 
št32_t
 
	gfi_y—r
;

169 
št32_t
 
	gfi_qŒ
;

172 
	sfšªcŸl_row
 {

173 
ušt32_t
 
	gfi_qŒ_¡¬t_d©e
;

174 
	gfi_»v’ue
;

175 
	gfi_Ãt_—º
;

176 
	gfi_basic_•s
;

177 
	gfi_dut_•s
;

178 
	gfi_m¬gš
;

179 
	gfi_šv’tÜy
;

180 
	gfi_as£ts
;

181 
	gfi_lŸb™y
;

182 
št64_t
 
	gfi_out_basic
;

183 
št64_t
 
	gfi_out_dut
;

186 
	sÏ¡_Œade_key
 {

187 
	gfix_¡ršg
<15> 
	gÉ_s_symb
;

190 
	sÏ¡_Œade_row
 {

191 
ušt32_t
 
	gÉ_dts
;

192 
	gÉ_´iû
;

193 
	gÉ_İ’_´iû
;

194 
št64_t
 
	gÉ_vŞ
;

197 
	sÃws_™em_key
 {

198 
št64_t
 
	gni_id
;

201 
	sÃws_™em_row
 {

202 
	gv¬_¡ršg
<80> 
	gni_h—dlše
;

203 
	gv¬_¡ršg
<225> 
	gni_summ¬y
;

204 
	gv¬_¡ršg
<1024> 
	gni_™em
;

205 
ušt32_t
 
	gni_dts
;

206 
	gv¬_¡ršg
<30> 
	gni_sourû
;

207 
	gv¬_¡ršg
<30> 
	gni_authÜ
;

210 
	sÃws_x»f_key
 {

211 
št64_t
 
	gnx_ni_id
;

212 
št64_t
 
	gnx_co_id
;

217 
	sbrok”_key
 {

218 
št64_t
 
	gb_id
;

221 
	sbrok”_row
 {

222 
	gfix_¡ršg
<4> 
	gb_¡_id
;

223 
	gv¬_¡ršg
<100> 
	gb_Çme
;

224 
št32_t
 
	gb_num_Œades
;

225 
	gb_comm_tÙ®
;

230 
	scu¡om”_accouÁ_key
 {

231 
št64_t
 
	gÿ_id
;

234 
	scu¡om”_accouÁ_row
 {

235 
št64_t
 
	gÿ_b_id
;

236 
št64_t
 
	gÿ_c_id
;

237 
	gv¬_¡ršg
<50> 
	gÿ_Çme
;

238 
št32_t
 
	gÿ_x_¡
;

239 
	gÿ_b®
;

242 
	saccouÁ_³rmissiÚ_key
 {

243 
št64_t
 
	g­_ÿ_id
;

244 
	gfix_¡ršg
<4> 
	g­_aş
;

247 
	saccouÁ_³rmissiÚ_row
 {

248 
	gv¬_¡ršg
<20> 
	g­_x_id
;

249 
	gv¬_¡ršg
<30> 
	g­_l_Çme
;

250 
	gv¬_¡ršg
<30> 
	g­_f_Çme
;

253 
	scu¡om”_x¿‹_key
 {

254 
	gfix_¡ršg
<4> 
	gcx_tx_id
;

255 
št64_t
 
	gcx_c_id
;

256 } 
__©Œibu‹__
((
·cked
));

260 
	sŒade_ty³_key
 {

261 
	gfix_¡ršg
<3> 
	g‰_id
;

264 
	sŒade_ty³_row
 {

265 
	gfix_¡ršg
<12> 
	g‰_Çme
;

266 
št32_t
 
	g‰_is_£Î
;

267 
št32_t
 
	g‰_is_mrkt
;

270 
	sŒade_key
 {

271 
št64_t
 
	gt_id
;

274 
	sŒade_row
 {

275 
ušt32_t
 
	gt_dts
;

276 
	gfix_¡ršg
<4> 
	gt_¡_id
;

277 
	gfix_¡ršg
<3> 
	gt_‰_id
;

278 
št32_t
 
	gt_is_ÿsh
;

279 
	gfix_¡ršg
<15> 
	gt_s_symb
;

280 
št32_t
 
	gt_qty
;

281 
	gt_bid_´iû
;

282 
št64_t
 
	gt_ÿ_id
;

283 
	gv¬_¡ršg
<64> 
	gt_exec_Çme
;

284 
	gt_Œade_´iû
;

285 
	gt_chrg
;

286 
	gt_comm
;

287 
	gt_x
;

288 
št32_t
 
	gt_lifo
;

291 
	s£‰Ëm’t_key
 {

292 
št64_t
 
	g£_t_id
;

295 
	s£‰Ëm’t_row
 {

296 
	gv¬_¡ršg
<40> 
	g£_ÿsh_ty³
;

297 
ušt32_t
 
	g£_ÿsh_due_d©e
;

298 
	g£_amt
;

301 
	sŒade_hi¡Üy_key
 {

302 
št64_t
 
	gth_t_id
;

303 
	gfix_¡ršg
<4> 
	gth_¡_id
;

306 
	sŒade_hi¡Üy_row
 {

307 
ušt32_t
 
	gth_dts
;

310 
	shŞdšg_summ¬y_key
 {

311 
št64_t
 
	ghs_ÿ_id
;

312 
	gfix_¡ršg
<15> 
	ghs_s_symb
;

315 
	shŞdšg_summ¬y_row
 {

316 
št32_t
 
	ghs_qty
;

319 
	shŞdšg_key
 {

320 
št64_t
 
	gh_t_id
;

323 
	shŞdšg_row
 {

324 
št64_t
 
	gh_ÿ_id
;

325 
	gfix_¡ršg
<15> 
	gh_s_symb
;

326 
ušt32_t
 
	gh_dts
;

327 
	gh_´iû
;

328 
št32_t
 
	gh_qty
;

331 
	shŞdšg_hi¡Üy_key
 {

332 
št64_t
 
	ghh_h_t_id
;

333 
št64_t
 
	ghh_t_id
;

336 
	shŞdšg_hi¡Üy_row
 {

337 
št32_t
 
	ghh_befÜe_qty
;

338 
št32_t
 
	ghh_aá”_qty
;

341 
	sw©ch_li¡_key
 {

342 
št64_t
 
	gwl_id
;

345 
	sw©ch_li¡_row
 {

346 
št64_t
 
	gwl_c_id
;

349 
	sw©ch_™em_key
 {

350 
št64_t
 
	gwi_wl_id
;

351 
	gfix_¡ršg
<15> 
	gwi_s_symb
;

356 
	sÿsh_Œª§ùiÚ_key
 {

357 
št64_t
 
	gù_t_id
;

360 
	sÿsh_Œª§ùiÚ_row
 {

361 
ušt32_t
 
	gù_dts
;

362 
	gù_amt
;

363 
	gv¬_¡ršg
<100> 
	gù_Çme
;

366 
	sch¬ge_key
 {

367 
	gfix_¡ršg
<3> 
	gch_‰_id
;

368 
št32_t
 
	gch_c_t›r
;

369 } 
__©Œibu‹__
((
·cked
));

371 
	sch¬ge_row
 {

372 
	gch_chrg
;

375 
	scommissiÚ_¿‹_key
 {

376 
št32_t
 
	gü_c_t›r
;

377 
št32_t
 
	gü_äom_qty
;

378 
	gfix_¡ršg
<3> 
	gü_‰_id
;

379 
	gfix_¡ršg
<6> 
	gü_ex_id
;

382 
	scommissiÚ_¿‹_row
 {

383 
št32_t
 
	gü_to_qty
;

384 
	gü_¿‹
;

387 
	sŒade_»que¡_key
 {

388 
št64_t
 
	gŒ_t_id
;

391 
	sŒade_»que¡_row
 {

392 
	gfix_¡ršg
<3> 
	gŒ_‰_id
;

393 
	gfix_¡ršg
<15> 
	gŒ_s_symb
;

394 
št32_t
 
	gŒ_qty
;

395 
	gŒ_bid_´iû
;

396 
št64_t
 
	gŒ_ÿ_id
;

	@benchmark/Voter_bench.cc

1 
	~<th»ad
>

3 
	~"VÙ”_b’ch.hh
"

4 
	~"VÙ”_txns.hh
"

6 
	~"şp.h
"

7 
	~"DB_´of”.hh
"

9 
usšg
 
	gdb_·¿ms
::
cÚ¡ªts
;

10 
usšg
 
	gdb_·¿ms
::
db_·¿ms_id
;

11 
usšg
 
	gdb_·¿ms
::
db_deçuÉ_·¿ms
;

12 
usšg
 
	gdb_·¿ms
::
db_ad­tive_·¿ms
;

13 
usšg
 
	gdb_·¿ms
::
db_tiùoc_·¿ms
;

14 
usšg
 
	gdb_·¿ms
::
db_2¶_·¿ms
;

15 
usšg
 
	gdb_·¿ms
::
db_swiss_·¿ms
;

16 
usšg
 
	gdb_·¿ms
::
db_İaque_·¿ms
;

17 
usšg
 
	gdb_·¿ms
::
·r£_dbid
;

21 
	mİt_dbid
 = 1, 
	mİt_Áhrs
, 
	mİt_time
, 
	mİt_³rf
, 
	mİt_pfút


24 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

25 { "dbid", 'i', 
İt_dbid
, 
CÍ_V®SŒšg
, 
CÍ_O±iÚ®
 },

26 { "Áh»ads", 't', 
İt_Áhrs
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

27 { "time", 'l', 
İt_time
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

28 { "³rf", 'p', 
İt_³rf
, 
CÍ_NoV®
, 
CÍ_O±iÚ®
 },

29 { "³rf-couÁ”", 'c', 
İt_pfút
, 
CÍ_NoV®
, 
CÍ_Neg©e
| 
CÍ_O±iÚ®
 }

32 
šlše
 
	$´št_u§ge
(cÚ¡ *
¬gv_0
) {

33 
¡d
::
¡ršg¡»am
 
ss
;

34 
ss
 << "U§goà" << 
¡d
::
	`¡ršg
(
¬gv_0
è<< ":" << std::
’dl


35 << " --dbid=<STRING> (Ü -i<STRING>)" << 
¡d
::
’dl


36 << " S³cifyhty³ oàDB cÚcu¼’cy cÚŒŞ u£d. Cª bÚoàthfŞlowšgs:" << 
¡d
::
’dl


37 << " deçuÉ, o·que, 2¶,‡d­tive, swiss,iùoc" << 
¡d
::
’dl


38 << " --Áh»ads=<NUM> (Ü -t<NUM>)" << 
¡d
::
’dl


39 << " S³cifyhnumb” oà·¿Î– wÜk”h»ad (deçuÉ 1)." << 
¡d
::
’dl


40 << " --time=<NUM> (Ü -l<NUM>)" << 
¡d
::
’dl


41 << " S³cifyhtim(du¿tiÚèfÜ whichhb’chm¬k i ruÀ(deçuÉ 10 secÚds)." << 
¡d
::
’dl


42 << " --³rà(Ü -p)" << 
¡d
::
’dl


43 << " S·wn ³rà´of” iÀ»cÜd modfÜhdu¿tiÚ oàthb’chm¬k„un." << 
¡d
::
’dl


44 << " --³rf-couÁ” (Ü -c)" << 
¡d
::
’dl


45 << " S·wn ³rà´of” iÀcouÁ” modfÜhdu¿tiÚ oàthb’chm¬k„un." << 
¡d
::
’dl
;

46 
¡d
::
cout
 << 
ss
.
	`¡r
(è<< std::
æush
;

47 
	}
}

49 
	scmd_·¿ms
 {

50 
	mdb_·¿ms
::
db_·¿ms_id
 
db_id
;

51 
	mnum_th»ads
;

52 
	mtime
;

53 
boŞ
 
	m¥wª_³rf
;

54 
boŞ
 
	m³rf_couÁ”_mode
;

56 
ex¶ic™
 
cmd_·¿ms
()

57 : 
db_id
(
db_·¿ms
::
db_·¿ms_id
::
DeçuÉ
),

58 
num_th»ads
(1), 
time
(10.0),

59 
¥wª_³rf
(
çl£
), 
³rf_couÁ”_mode
(false) {}

64 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

65 şas 
	cb’ch_acûss
 {

66 
	mpublic
:

67 
usšg
 
db_ty³
 = 
vÙ”
::
vÙ”_db
<
DBP¬ams
>;

68 
usšg
 
	mlßd”_ty³
 = 
vÙ”
::
vÙ”_lßd”
<
DBP¬ams
>;

69 
usšg
 
	mruÂ”_ty³
 = 
vÙ”
::
vÙ”_ruÂ”
<
DBP¬ams
>;

70 
usšg
 
	m´of”_ty³
 = 
b’ch
::
db_´of”
;

72 
	$ruÂ”_th»ad
(
ruÂ”_ty³
& 
r
, 
size_t
& 
txn_út
) {

73 
r
.
	`run
();

74 
txn_út
 = 
r
.
	`comm™‹d_txns
();

77 
	$execu‹
(
cmd_·¿ms
 
p
) {

79 auto& 
db
 = *(
Ãw
 
	`db_ty³
());

82 
lßd”_ty³
 
	`lßd”
(
db
);

83 
lßd”
.
	`lßd
();

86 
¡d
::
veùÜ
<
ruÂ”_ty³
> 
ruÂ”s
;

87 
¡d
::
veùÜ
<¡d::
th»ad
> 
ruÂ”_th»ads
;

88 
¡d
::
veùÜ
<
size_t
> 
	`comm™‹d_txn_úts
((size_t)
p
.
num_th»ads
, 0);

90 
id
 = 0; id < 
p
.
num_th»ads
; ++id)

91 
ruÂ”s
.
	`push_back
(
	`ruÂ”_ty³
(
id
, 
db
, 
p
.
time
));

93 
´of”_ty³
 
	`´of”
(
p
.
¥wª_³rf
);

94 
´of”
.
	`¡¬t
(
p
.
³rf_couÁ”_mode
 ? 
Prof”
::
³rf_mode
::
couÁ”s
 : Prof”::³rf_mode::
»cÜd
);

96 
t
 = 0; < 
p
.
num_th»ads
; ++t)

97 
ruÂ”_th»ads
.
	`push_back
(

98 
¡d
::
	`th»ad
(
ruÂ”_th»ad
, std::
	`»f
(
ruÂ”s
[
t
]), std::»f(
comm™‹d_txn_úts
[t]))

100 auto& 
t
 : 
ruÂ”_th»ads
)

101 
t
.
	`još
();

103 
size_t
 
tÙ®_comm™_txns
 = 0;

104 autØ
c
 : 
comm™‹d_txn_úts
)

105 
tÙ®_comm™_txns
 +ğ
c
;

107 
´of”
.
	`fšish
(
tÙ®_comm™_txns
);

109 
	`d–‘e
 (&
db
);

111 
	}
}

114 
	gcÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
;

116 
	$maš
(
¬gc
, cÚ¡ * cÚ¡ *
¬gv
) {

117 
cmd_·¿ms
 
·¿ms
;

119 
¡d
::
cout
 << "In™Ÿlizšg cÚ¡ªts." << std::
’dl
;

120 
vÙ”
::
	`š™Ÿlize_d©a
();

122 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
	`¬¿ysize
(
İtiÚs
), options);

124 
»t_code
 = 0;

125 
İt
;

126 
boŞ
 
şp_¡İ
 = 
çl£
;

127 !
şp_¡İ
 && ((
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
)) {

128 
İt
) {

129 
İt_dbid
:

130 
·¿ms
.
db_id
 = 
	`·r£_dbid
(
şp
->
v®
.
s
);

131 ià(
·¿ms
.
db_id
 =ğ
db_·¿ms
::
db_·¿ms_id
::
NÚe
) {

132 
¡d
::
cout
 << "Unsupported DB CC id: "

133 << ((
şp
->
v®
.
s
 =ğ
nuÎ±r
è? "" : 
¡d
::
	`¡ršg
(şp->v®.s)è<< std::
’dl
;

134 
	`´št_u§ge
(
¬gv
[0]);

135 
»t_code
 = 1;

136 
şp_¡İ
 = 
Œue
;

139 
İt_Áhrs
:

140 
·¿ms
.
num_th»ads
 = 
şp
->
v®
.
i
;

142 
İt_time
:

143 
·¿ms
.
time
 = 
şp
->
v®
.
d
;

145 
İt_³rf
:

146 
·¿ms
.
¥wª_³rf
 = !
şp
->
Ãg©ed
;

148 
İt_pfút
:

149 
·¿ms
.
³rf_couÁ”_mode
 = !
şp
->
Ãg©ed
;

152 
	`´št_u§ge
(
¬gv
[0]);

153 
»t_code
 = 1;

154 
şp_¡İ
 = 
Œue
;

159 
	`CÍ_D–‘eP¬£r
(
şp
);

160 ià(
»t_code
 != 0)

161  
»t_code
;

163 autØ
ıu_äeq
 = 
	`d‘”mše_ıu_äeq
();

164 ià(
ıu_äeq
 == 0.0)

167 
cÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
 = 
ıu_äeq
;

169 
·¿ms
.
db_id
) {

170 
db_·¿ms_id
::
DeçuÉ
:

171 
»t_code
 = 
b’ch_acûss
<
db_deçuÉ_·¿ms
>::
	`execu‹
(
·¿ms
);

173 
db_·¿ms_id
::
O·que
:

174 
»t_code
 = 
b’ch_acûss
<
db_İaque_·¿ms
>::
	`execu‹
(
·¿ms
);

176 
db_·¿ms_id
::
TwoPL
:

177 
»t_code
 = 
b’ch_acûss
<
db_2¶_·¿ms
>::
	`execu‹
(
·¿ms
);

179 
db_·¿ms_id
::
Ad­tive
:

180 
»t_code
 = 
b’ch_acûss
<
db_ad­tive_·¿ms
>::
	`execu‹
(
·¿ms
);

182 
db_·¿ms_id
::
Swiss
:

183 
»t_code
 = 
b’ch_acûss
<
db_swiss_·¿ms
>::
	`execu‹
(
·¿ms
);

185 
db_·¿ms_id
::
TicToc
:

186 
»t_code
 = 
b’ch_acûss
<
db_tiùoc_·¿ms
>::
	`execu‹
(
·¿ms
);

189 
¡d
::
û¼
 << "unknowÀdb cÚfig…¬am‘” id" << std::
’dl
;

190 
»t_code
 = 1;

194  
»t_code
;

195 
	}
}

	@benchmark/Voter_bench.hh

1 #´agm¨
Úû


3 
	~<iomª
>

4 
	~<PÏtfÜmF—tu»s.hh
>

5 
	~"§m¶šg.hh
"

6 
	~"VÙ”_¡ruùs.hh
"

7 
	~"DB_šdex.hh
"

8 
	~"DB_·¿ms.hh
"

10 
Çme¥aû
 
	gvÙ”
 {

12 
	scÚ¡ªts
 {

13 
cÚ¡ex´
 
	gnum_cÚ‹¡ªts
 = 6;

14 
cÚ¡ex´
 
št64_t
 
	gmax_vÙes_³r_phÚe_numb”
 = 1000;

17 
	g‹m¶©e
<
ty³Çme
 
	gDBP¬ams
>

18 şas 
	cvÙ”_db
 {

19 
	gpublic
:

20 
‹m¶©e
<
ty³Çme
 
K
,y³Çm
	gV
>

21 
usšg
 
	gOIndex
 = 
Üd”ed_šdex
<
K
, 
	gV
, 
	gDBP¬ams
>;

23 
	gOIndex
<
	tcÚ‹¡ªt_key
, 
	tcÚ‹¡ªt_row
> 
	tcÚ‹¡ªt_tbl_ty³
;

24 
	gOIndex
<
	t¬—_code_¡©e_key
, 
	t¬—_code_¡©e_row
> 
	t¬—code¡©e_tbl_ty³
;

25 
	gOIndex
<
	tvÙes_key
, 
	tvÙes_row
> 
	tvÙes_tbl_ty³
;

26 
	gOIndex
<
	tv_vÙes_phÚe_key
, 
	tv_vÙes_phÚe_row
> 
	tv_vÙe¥hÚe_idx_ty³
;

27 
	gOIndex
<
	tv_vÙes_id_¡©e_key
, 
	tv_vÙes_id_¡©e_row
> 
	tv_vÙesid¡_idx_ty³
;

29 
ex¶ic™
 
vÙ”_db
()

30 : 
tbl_cÚ‹¡ªt_
(),

31 
tbl_¬—code¡©e_
(),

32 
tbl_vÙes_
(),

33 
idx_vÙe¥hÚe_
(),

34 
idx_vÙesid¡_
() {}

36 
	gcÚ‹¡ªt_tbl_ty³
& 
tbl_cÚ‹¡ªt
() {

37  
	gtbl_cÚ‹¡ªt_
;

39 
	g¬—code¡©e_tbl_ty³
& 
tbl_¬—code_¡©e
() {

40  
	gtbl_¬—code¡©e_
;

42 
	gvÙes_tbl_ty³
& 
tbl_vÙes
() {

43  
	gtbl_vÙes_
;

45 
	gv_vÙe¥hÚe_idx_ty³
& 
v›w_vÙes_by_phÚe
() {

46  
	gidx_vÙe¥hÚe_
;

48 
	gv_vÙesid¡_idx_ty³
& 
v›w_vÙes_by_id_¡©e
() {

49  
	gidx_vÙesid¡_
;

52 
th»ad_š™_®l
() {

53 
	gtbl_cÚ‹¡ªt_
.
th»ad_š™
();

54 
	gtbl_¬—code¡©e_
.
th»ad_š™
();

55 
	gtbl_vÙes_
.
th»ad_š™
();

56 
	gidx_vÙe¥hÚe_
.
th»ad_š™
();

57 
	gidx_vÙesid¡_
.
th»ad_š™
();

60 
	g´iv©e
:

61 
cÚ‹¡ªt_tbl_ty³
 
tbl_cÚ‹¡ªt_
;

62 
¬—code¡©e_tbl_ty³
 
	gtbl_¬—code¡©e_
;

63 
vÙes_tbl_ty³
 
	gtbl_vÙes_
;

64 
v_vÙe¥hÚe_idx_ty³
 
	gidx_vÙe¥hÚe_
;

65 
v_vÙesid¡_idx_ty³
 
	gidx_vÙesid¡_
;

68 
¡d
::
veùÜ
<¡d::
¡ršg
> 
¬—_codes
;

69 
¡d
::
veùÜ
<¡d::
¡ršg
> 
¬—_code_¡©e_m­
;

70 
¡d
::
veùÜ
<¡d::
¡ršg
> 
cÚ‹¡ªt_Çmes
;

72 
š™Ÿlize_d©a
();

74 
ty³Çme
 
	t§m¶šg
::
	tStoRªdomDi¡ributiÚ
<>::
	tºg_ty³
„ng_type;

76 
	sbasic_di¡s
 {

78 
ºg_ty³
 
	gth»ad_ºg
;

79 
	g¡d
::
unifÜm_št_di¡ributiÚ
<
size_t
> 
¬—_code_id_di¡
;

80 
	g¡d
::
unifÜm_št_di¡ributiÚ
<
št32_t
> 
cÚ‹¡ªt_num_di¡
;

81 
	g¡d
::
unifÜm_št_di¡ributiÚ
<
ušt32_t
> 
phÚe_num_di¡
;

82 
	g¡d
::
unifÜm_št_di¡ributiÚ
<> 
coš_æ
;

83 
	g¡d
::
unifÜm_št_di¡ributiÚ
<> 
³rûÁ_§m¶”
;

85 
ex¶ic™
 
basic_di¡s
(
£ed
)

86 : 
th»ad_ºg
(
£ed
),

87 
¬—_code_id_di¡
(0ul, 
¬—_codes
.
size
() - 1ul),

88 
cÚ‹¡ªt_num_di¡
(1, 
cÚ¡ªts
::
num_cÚ‹¡ªts
),

89 
phÚe_num_di¡
(0u, 9999999u),

90 
coš_æ
(0, 1), 
³rûÁ_§m¶”
(0, 99) {}

93 şas 
	cšput_g’”©Ü
 {

94 
	gpublic
:

95 
ex¶ic™
 
šput_g’”©Ü
(
ºg_£ed
è: 
di¡s
(rng_seed) {

96 
cÚ¡ex´
 
num_cÚts
 = 
cÚ¡ªts
::
num_cÚ‹¡ªts
;

97 
size_t
 
	gi
 = 0; i < 
	g¬—_codes
.
size
(); ++i) {

98 
št32_t
 
	gcÚ‹¡ªt_choiû
 = 1;

99 ià(
	gdi¡s
.
³rûÁ_§m¶”
(
di¡s
.
th»ad_ºg
) < 30) {

100 
	gcÚ‹¡ªt_choiû
 = (
¡d
::
abs
(()(¡d::
sš
(()
i
è* 
num_cÚts
)) %‚um_conts) + 1;

102 
	gcÚ‹¡ªt_h—t_m­
.
push_back
(
cÚ‹¡ªt_choiû
);

107 
	g¡d
::
·œ
<
št32_t
, 
	gphÚe_numb”_¡r
> 
g’”©e_phÚe_ÿÎ
() {

108 
phÚe_numb”_¡r
 
	g‹l
;

109 
	g¡d
::
¡ršg¡»am
 
ss
;

111 autØ
	gidx
 = 
di¡s
.
¬—_code_id_di¡
(di¡s.
th»ad_ºg
);

112 
št32_t
 
	gcÚ‹¡ªt_n
 = 
cÚ‹¡ªt_h—t_m­
[
idx
];

113 ià(
	gdi¡s
.
coš_æ
(
di¡s
.
th»ad_ºg
) == 0) {

114 
cÚ‹¡ªt_n
 = 
di¡s
.
cÚ‹¡ªt_num_di¡
(di¡s.
th»ad_ºg
);

116 ià(
	gdi¡s
.
³rûÁ_§m¶”
(
di¡s
.
th»ad_ºg
) == 0) {

117 
cÚ‹¡ªt_n
 = 999;

120 
	g‹l
.
	g¬—_code
 = 
¬—_codes
[
idx
];

121 
	gss
 << 
	g¡d
::
£tw
(7è<< 
¡d
::
£tfl
('0'è<< 
di¡s
.
phÚe_num_di¡
(di¡s.
th»ad_ºg
);

122 
	g‹l
.
	gnumb”
 = 
ss
.
¡r
();

124  {
	gcÚ‹¡ªt_n
, 
	g‹l
};

127 
	g´iv©e
:

128 
basic_di¡s
 
di¡s
;

129 
	g¡d
::
veùÜ
<
št32_t
> 
cÚ‹¡ªt_h—t_m­
;

132 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

133 şas 
	cvÙ”_ruÂ”
 {

134 
	gpublic
:

135 
vÙ”_db
<
	tDBP¬ams
> 
	tdb_ty³
;

137 
ex¶ic™
 
vÙ”_ruÂ”
(
rid
, 
db_ty³
& 
d©aba£
, 
time_lim™
)

138 : 
id
(
rid
), 
db
(
d©aba£
), 
ig
Ôid+1040), 
tsc_–­£_lim™
(),

139 
¡©_comm™‹d_txns
() {

140 
	gtsc_–­£_lim™
 = 
¡©ic_ÿ¡
<
ušt64_t
>(
time_lim™


141 * 
db_·¿ms
::
cÚ¡ªts
::
´oûssÜ_tsc_äequ’cy


142 * 
db_·¿ms
::
cÚ¡ªts
::
bliÚ
);

145 
run
();

147 
size_t
 
comm™‹d_txns
() const {

148  
	g¡©_comm™‹d_txns
;

151 
	g´iv©e
:

152 
run_txn_vÙe
(cÚ¡ 
phÚe_numb”_¡r
& 
‹l
, 
št32_t
 
cÚ‹¡ªt_numb”
);

153 
boŞ
 
vÙe_šÃr
(cÚ¡ 
phÚe_numb”_¡r
& 
‹l
, 
št32_t
 
cÚ‹¡ªt_numb”
);

155 
	gid
;

156 
	gdb_ty³
& 
	gdb
;

157 
šput_g’”©Ü
 
	gig
;

158 
ušt64_t
 
	gtsc_–­£_lim™
;

160 
size_t
 
	g¡©_comm™‹d_txns
;

163 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

164 şas 
	cvÙ”_lßd”
 {

165 
	gpublic
:

166 
vÙ”_db
<
	tDBP¬ams
> 
	tdb_ty³
;

167 
ex¶ic™
 
vÙ”_lßd”
(
db_ty³
& 
d©aba£
è: 
db
(database) {}

169 
lßd
() {

170 
¡d
::
cout
 << "Lßdšg..." << std::
’dl
;

171 
®ways_as£¹
(!
¬—_codes
.
em±y
());

172 
®ways_as£¹
(
¬—_codes
.
size
(è=ğ
¬—_code_¡©e_m­
.size());

174 
	gi
 = 0; i < 
	gcÚ¡ªts
::
num_cÚ‹¡ªts
; ++i) {

175 
cÚ‹¡ªt_key
 
ck
(
i
);

176 
cÚ‹¡ªt_row
 
	gü
;

177 
	gü
.
	gÇme
 = 
cÚ‹¡ªt_Çmes
[
i
];

178 
	gdb
.
tbl_cÚ‹¡ªt
().
nÚŒªs_put
(
ck
, 
ü
);

181 
size_t
 
	gi
 = 0; i < 
	g¬—_codes
.
size
(); ++i) {

182 
¬—_code_¡©e_key
 
acs_k
(
¬—_codes
[
i
]);

183 
¬—_code_¡©e_row
 
	gacs_r
;

184 
	gacs_r
.
	g¡©e
 = 
¬—_code_¡©e_m­
[
i
];

185 
	gdb
.
tbl_¬—code_¡©e
().
nÚŒªs_put
(
acs_k
, 
acs_r
);

187 
	g¡d
::
cout
 << "Lßded." << 
¡d
::
’dl
;

190 
	g´iv©e
:

191 
db_ty³
& 
db
;

194 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

195 
	gvÙ”_ruÂ”
<
	gDBP¬ams
>::
	$run
() {

196 ::
TTh»ad
::
	`£t_id
(
id
);

197 
	`£t_affš™y
(
id
);

198 
db
.
	`th»ad_š™_®l
();

199 
size_t
 
út
 = 0;

201 autØ
begš_tsc
 = 
	`»ad_tsc
();

203 
Œue
) {

204 
št32_t
 
ú
;

205 
phÚe_numb”_¡r
 
‹l
;

206 
¡d
::
	`t›
(
ú
, 
‹l
èğ
ig
.
	`g’”©e_phÚe_ÿÎ
();

208 
	`run_txn_vÙe
(
‹l
, 
ú
);

210 ++
út
;

211 ià(((
út
 & 0xfffuè=ğ0è&& ((
	`»ad_tsc
(è- 
begš_tsc
è>ğ
tsc_–­£_lim™
))

214 
¡©_comm™‹d_txns
 = 
út
;

215 
	}
}

	@benchmark/Voter_data.cc

1 
	~"VÙ”_b’ch.hh
"

3 
Çme¥aû
 
	gvÙ”
 {

5 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
¬—_codes
;

6 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
¬—_code_¡©e_m­
;

7 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
cÚ‹¡ªt_Çmes
;

9 
š™Ÿlize_d©a
() {

10 
	g¬—_codes
 = {

34 
	g¬—_code_¡©e_m­
 = {

58 
	gcÚ‹¡ªt_Çmes
 = {

	@benchmark/Voter_structs.hh

1 #´agm¨
Úû


3 
	~<¡ršg
>

4 
	~"DB_¡ruùs.hh
"

5 
	~"¡r.hh
"

7 
Çme¥aû
 
	gvÙ”
 {

9 
usšg
 
Çme¥aû
 
	gb’ch
;

13 
	sphÚe_numb”_¡r
 {

14 
	g¡d
::
¡ršg
 
¬—_code
;

15 
	g¡d
::
¡ršg
 
numb”
;

18 
	sphÚe_numb”
 {

19 
	gfix_¡ršg
<3> 
	g¬—_code
;

20 
	gfix_¡ršg
<7> 
	gnumb”
;

22 
phÚe_numb”
() = ;

23 
ex¶ic™
 
phÚe_numb”
(cÚ¡ 
phÚe_numb”_¡r
& 
phs
)

24 : 
¬—_code
(
phs
.¬—_code), 
numb”
(phs.number) {}

32 
	scÚ‹¡ªt_key_b¬e
 {

33 
št32_t
 
	gnumb”
;

35 
ex¶ic™
 
cÚ‹¡ªt_key_b¬e
(
št32_t
 
id
è: 
numb”
(
bsw­
(id)) {}

38 
	gmas¡»e_key_ad­‹r
<
	tcÚ‹¡ªt_key_b¬e
> 
	tcÚ‹¡ªt_key
;

40 
	scÚ‹¡ªt_row
 {

41 şas 
	cNamedCŞumn
 : {
Çme
 = 0};

42 
	gv¬_¡ršg
<50> 
	gÇme
;

47 
	s¬—_code_¡©e_key_b¬e
 {

48 
	gfix_¡ršg
<3> 
	g¬—_code
;

50 
ex¶ic™
 
¬—_code_¡©e_key_b¬e
(cÚ¡ 
¡d
::
¡ršg
& 
a
)

51 : 
¬—_code
(
a
) {}

54 
	gmas¡»e_key_ad­‹r
<
	t¬—_code_¡©e_key_b¬e
> 
	t¬—_code_¡©e_key
;

56 
	s¬—_code_¡©e_row
 {

57 şas 
	cNamedCŞumn
 : {
¡©e
 = 0};

59 
	gfix_¡ršg
<2> 
	g¡©e
;

64 
	svÙes_key_b¬e
 {

65 
št32_t
 
	gvÙe_id
;

67 
ex¶ic™
 
vÙes_key_b¬e
(
št32_t
 
id
è: 
vÙe_id
(
bsw­
(id)) {}

70 
	gmas¡»e_key_ad­‹r
<
	tvÙes_key_b¬e
> 
	tvÙes_key
;

72 
	svÙes_row
 {

73 şas 
	cNamedCŞumn
 : { 
‹l
 = 0,

74 
	g¡©e
,

75 
	gcÚ‹¡ªt_numb”
,

76 
	gü—‹d
 };

77 
phÚe_numb”
 
	g‹l
;

78 
	gfix_¡ršg
<2> 
	g¡©e
;

79 
št32_t
 
	gcÚ‹¡ªt_numb”
;

80 
	gv¬_¡ršg
<14> 
	gü—‹d
;

87 
	sv_vÙes_phÚe_key_b¬e
 {

88 
phÚe_numb”
 
	g‹l
;

90 
ex¶ic™
 
v_vÙes_phÚe_key_b¬e
(cÚ¡ 
phÚe_numb”_¡r
& 
ph
)

91 : 
‹l
(
ph
) {}

93 
ä›nd
 
mas¡»e_key_ad­‹r
<
v_vÙes_phÚe_key_b¬e
>;

94 
	g´iv©e
:

95 
v_vÙes_phÚe_key_b¬e
() = ;

98 
	gmas¡»e_key_ad­‹r
<
	tv_vÙes_phÚe_key_b¬e
> 
	tv_vÙes_phÚe_key
;

100 
	sv_vÙes_phÚe_row
 {

101 şas 
	cNamedCŞumn
 : {
couÁ
 = 0};

102 
št64_t
 
	gcouÁ
;

107 
__©Œibu‹__
((
·cked
)è
	gv_vÙes_id_¡©e_key_b¬e
 {

108 
št32_t
 
	gnumb”
;

109 
	gfix_¡ršg
<2> 
	g¡©e
;

111 
ex¶ic™
 
v_vÙes_id_¡©e_key_b¬e
(
št32_t
 
id
, cÚ¡ 
fix_¡ršg
<2>& 
¡
)

112 : 
numb”
(
bsw­
(
id
)), 
¡©e
(
¡
) {}

113 
ä›nd
 
	gmas¡»e_key_ad­‹r
<
	gv_vÙes_id_¡©e_key_b¬e
>;

114 
	g´iv©e
:

115 
v_vÙes_id_¡©e_key_b¬e
() = ;

118 
	gmas¡»e_key_ad­‹r
<
	tv_vÙes_id_¡©e_key_b¬e
> 
	tv_vÙes_id_¡©e_key
;

120 
	sv_vÙes_id_¡©e_row
 {

121 şas 
	cNamedCŞumn
 : {
couÁ
 = 0};

122 
št64_t
 
	gcouÁ
;

	@benchmark/Voter_txns.hh

1 #´agm¨
Úû


3 
	~"VÙ”_b’ch.hh
"

5 
Çme¥aû
 
	gvÙ”
 {

7 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

8 
	gvÙ”_ruÂ”
<
	gDBP¬ams
>::
run_txn_vÙe
(cÚ¡ 
phÚe_numb”_¡r
& 
‹l
, 
št32_t
 
cÚ‹¡ªt_numb”
) {

9 
	gTRANSACTION
 {

10 
boŞ
 
	gsucûss
 = 
vÙe_šÃr
(
‹l
, 
cÚ‹¡ªt_numb”
);

11 
TXN_DO
(
sucûss
);

12 } 
RETRY
(
Œue
);

15 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

16 
boŞ
 
	gvÙ”_ruÂ”
<
	gDBP¬ams
>::
vÙe_šÃr
(cÚ¡ 
phÚe_numb”_¡r
& 
‹l
, 
št32_t
 
id
) {

17 
boŞ
 
	gsucûss
, 
	g»suÉ
;

18 
ušŒ_t
 
	grow
;

19 cÚ¡ *
	gv®ue
;

22 
	g¡d
::
t›
(
sucûss
, 
»suÉ
, 
¡d
::
ignÜe
, std::ignÜeèğ
db
.
tbl_cÚ‹¡ªt
().
£Ëù_row
(
cÚ‹¡ªt_key
(
id
), 
RowAcûss
::
NÚe
);

23 ià(!
	gsucûss
)

24  
	gçl£
;

25 ià(!
	g»suÉ
)

26  
	gŒue
;

29 
	g¡d
::
t›
(
sucûss
, 
»suÉ
, 
row
, 
v®ue
èğ
db
.
v›w_vÙes_by_phÚe
().
£Ëù_row
(
v_vÙes_phÚe_key
(
‹l
), 
RowAcûss
::
Upd©eV®ue
);

30 ià(!
	gsucûss
)

31  
	gçl£
;

32 ià(
	g»suÉ
) {

33 autØ
	gv_ph_row
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
v_vÙes_phÚe_row
 *>(
v®ue
);

34 autØ
	gÃw_row
 = 
Sto
::
tx_®loc
(
v_ph_row
);

35 ià(
	gÃw_row
->
	gcouÁ
 >ğ
cÚ¡ªts
::
max_vÙes_³r_phÚe_numb”
) {

36 
db
.
v›w_vÙes_by_phÚe
().
upd©e_row
(
row
, 
Ãw_row
);

37  
	gŒue
;

39 
	gÃw_row
->
	gcouÁ
 += 1;

40 
	gdb
.
v›w_vÙes_by_phÚe
().
upd©e_row
(
row
, 
Ãw_row
);

43 autØ
	g‹mp_row
 = 
Sto
::
tx_®loc
<
v_vÙes_phÚe_row
>();

44 
	g‹mp_row
->
	gcouÁ
 = 0;

45 
	g¡d
::
t›
(
sucûss
, 
»suÉ
èğ
db
.
v›w_vÙes_by_phÚe
().
š£¹_row
(
v_vÙes_phÚe_key
(
‹l
), 
‹mp_row
);

46 ià(!
	gsucûss
)

47  
	gçl£
;

48 
as£¹
(!
»suÉ
);

52 
	g¡d
::
t›
(
sucûss
, 
»suÉ
, 
¡d
::
ignÜe
, 
v®ue
èğ
db
.
tbl_¬—code_¡©e
().
£Ëù_row
(
¬—_code_¡©e_key
(
‹l
.
¬—_code
), 
RowAcûss
::
NÚe
);

53 ià(!
	gsucûss
)

54  
	gçl£
;

55 
as£¹
(
»suÉ
);

56 autØ
	g¡_row
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
¬—_code_¡©e_row
 *>(
v®ue
);

60 autØ
	gvÙe_id
 = (
št32_t
)
db
.
tbl_vÙes
().
g’_key
();

61 
vÙes_key
 
vk
(
vÙe_id
);

62 autØ
	gvr
 = 
Sto
::
tx_®loc
<
vÙes_row
>();

63 
	gvr
->
	g¡©e
 = 
¡_row
->
¡©e
;

64 
	gvr
->
	g‹l
.
	g¬—_code
 = 
‹l
.
¬—_code
;

65 
	gvr
->
	g‹l
.
	gnumb”
 = 
‹l
.
numb”
;

66 
	gvr
->
	gcÚ‹¡ªt_numb”
 = 
id
;

67 
	gvr
->
	gü—‹d
 = "null";

69 
	g¡d
::
t›
(
sucûss
, 
»suÉ
èğ
db
.
tbl_vÙes
().
š£¹_row
(
vk
, 
vr
);

70 ià(!
	gsucûss
)

71  
	gçl£
;

72 
as£¹
(!
»suÉ
);

75 
	g¡d
::
t›
(
sucûss
, 
»suÉ
, 
row
, 
v®ue
èğ
db
.
v›w_vÙes_by_id_¡©e
().
£Ëù_row
(
v_vÙes_id_¡©e_key
(
id
, 
vr
->
¡©e
), 
RowAcûss
::
Upd©eV®ue
);

76 ià(!
	gsucûss
)

77  
	gçl£
;

78 ià(
	g»suÉ
) {

79 autØ
	gÃw_row
 = 
Sto
::
tx_®loc
(
»š‹½»t_ÿ¡
<cÚ¡ 
v_vÙes_id_¡©e_row
 *>(
v®ue
));

80 
	gÃw_row
->
	gcouÁ
 += 1;

81 
	gdb
.
v›w_vÙes_by_id_¡©e
().
upd©e_row
(
row
, 
Ãw_row
);

83 autØ
	gÃw_row
 = 
Sto
::
tx_®loc
<
v_vÙes_id_¡©e_row
>();

84 
	g¡d
::
t›
(
sucûss
, 
»suÉ
èğ
db
.
v›w_vÙes_by_id_¡©e
().
š£¹_row
(
v_vÙes_id_¡©e_key
(
id
, 
vr
->
¡©e
), 
Ãw_row
);

85 ià(!
	gsucûss
)

86  
	gçl£
;

87 
as£¹
(!
»suÉ
);

90  
	gŒue
;

	@benchmark/Wikipedia_bench.cc

1 
	~<th»ad
>

3 
	~"WikedŸ_b’ch.hh
"

4 
	~"WikedŸ_lßd”.hh
"

5 
	~"WikedŸ_txns.hh
"

7 
	~"DB_´of”.hh
"

8 
	~"şp.h
"

10 
usšg
 
	gdb_·¿ms
::
cÚ¡ªts
;

11 
usšg
 
	gdb_·¿ms
::
db_·¿ms_id
;

12 
usšg
 
	gdb_·¿ms
::
db_deçuÉ_·¿ms
;

13 
usšg
 
	gdb_·¿ms
::
db_ad­tive_·¿ms
;

14 
usšg
 
	gdb_·¿ms
::
db_tiùoc_·¿ms
;

15 
usšg
 
	gdb_·¿ms
::
db_2¶_·¿ms
;

16 
usšg
 
	gdb_·¿ms
::
db_swiss_·¿ms
;

17 
usšg
 
	gdb_·¿ms
::
db_İaque_·¿ms
;

18 
usšg
 
	gdb_·¿ms
::
·r£_dbid
;

20 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

21 * 
	gwikedŸ
::
wikedŸ_lßd”
<
DBP¬ams
>::
u£r_»visiÚ_úts
 = 
nuÎ±r
;

22 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

23 * 
	gwikedŸ
::
wikedŸ_lßd”
<
DBP¬ams
>::
·ge_Ï¡_»v_ids
 = 
nuÎ±r
;

24 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

25 * 
	gwikedŸ
::
wikedŸ_lßd”
<
DBP¬ams
>::
·ge_Ï¡_»v_Ëns
 = 
nuÎ±r
;

29 
	mİt_dbid
 = 1, 
	mİt_Áhrs
, 
	mİt_u£rs
, 
	mİt_·ges
, 
	mİt_time
, 
	mİt_³rf
, 
	mİt_pfút


32 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

33 { "dbid", 'i', 
İt_dbid
, 
CÍ_V®SŒšg
, 
CÍ_O±iÚ®
 },

34 { "Áh»ads", 't', 
İt_Áhrs
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

35 { "sÿËu£rs", 'u', 
İt_u£rs
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

36 { "sÿË·ges", 'g', 
İt_·ges
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

37 { "time", 'l', 
İt_time
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

38 { "³rf", 'p', 
İt_³rf
, 
CÍ_NoV®
, 
CÍ_O±iÚ®
 },

39 { "³rf-couÁ”", 'c', 
İt_pfút
, 
CÍ_NoV®
, 
CÍ_Neg©e
| 
CÍ_O±iÚ®
 }

42 
šlše
 
	$´št_u§ge
(cÚ¡ *
¬gv_0
) {

43 
¡d
::
¡ršg¡»am
 
ss
;

44 
ss
 << "U§goà" << 
¡d
::
	`¡ršg
(
¬gv_0
è<< ":" << std::
’dl


45 << " --dbid=<STRING> (Ü -i<STRING>)" << 
¡d
::
’dl


46 << " S³cifyhty³ oàDB cÚcu¼’cy cÚŒŞ u£d. Cª bÚoàthfŞlowšgs:" << 
¡d
::
’dl


47 << " deçuÉ, o·que, 2¶,‡d­tive, swiss,iùoc" << 
¡d
::
’dl


48 << " --Áh»ads=<NUM> (Ü -t<NUM>)" << 
¡d
::
’dl


49 << " S³cifyhnumb” oà·¿Î– wÜk”h»ad (deçuÉ 1)." << 
¡d
::
’dl


50 << " --sÿËu£rs=<NUM> (Ü -u<NUM>)" << 
¡d
::
’dl


51 << " S³cifyhsÿË faùÜ oàthnumb” oàu£r (deçuÉ 10)." << 
¡d
::
’dl


52 << " --sÿË·ges=<NUM> (Ü -g<NUM>)" << 
¡d
::
’dl


53 << " S³cifyhsÿË faùÜ oàthnumb” oà·ge (deçuÉ 10)." << 
¡d
::
’dl


54 << " --time=<NUM> (Ü -l<NUM>)" << 
¡d
::
’dl


55 << " S³cifyhtim(du¿tiÚèfÜ whichhb’chm¬k i ruÀ(deçuÉ 10 secÚds)." << 
¡d
::
’dl


56 << " --³rà(Ü -p)" << 
¡d
::
’dl


57 << " S·wn ³rà´of” iÀ»cÜd modfÜhdu¿tiÚ oàthb’chm¬k„un." << 
¡d
::
’dl


58 << " --³rf-couÁ” (Ü -c)" << 
¡d
::
’dl


59 << " S·wn ³rà´of” iÀcouÁ” modfÜhdu¿tiÚ oàthb’chm¬k„un." << 
¡d
::
’dl
;

60 
¡d
::
cout
 << 
ss
.
	`¡r
(è<< std::
æush
;

61 
	}
}

63 
	scmd_·¿ms
 {

64 
	mdb_·¿ms
::
db_·¿ms_id
 
db_id
;

65 
	mnum_th»ads
;

66 
	msÿË_u£r
;

67 
	msÿË_·ge
;

68 
	mtime
;

69 
boŞ
 
	m¥wª_³rf
;

70 
boŞ
 
	m³rf_couÁ”_mode
;

72 
ex¶ic™
 
cmd_·¿ms
()

73 : 
db_id
(
db_·¿ms
::
db_·¿ms_id
::
DeçuÉ
),

74 
num_th»ads
(1), 
sÿË_u£r
(10), 
sÿË_·ge
(10),

75 
time
(10.0), 
¥wª_³rf
(
çl£
), 
³rf_couÁ”_mode
(false) {}

80 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

81 şas 
	cb’ch_acûss
 {

82 
	mpublic
:

83 
usšg
 
db_ty³
 = 
wikedŸ
::
wikedŸ_db
<
DBP¬ams
>;

84 
usšg
 
	mlßd”_ty³
 = 
wikedŸ
::
wikedŸ_lßd”
<
DBP¬ams
>;

85 
usšg
 
	mruÂ”_ty³
 = 
wikedŸ
::
wikedŸ_ruÂ”
<
DBP¬ams
>;

86 
usšg
 
	m´of”_ty³
 = 
b’ch
::
db_´of”
;

88 
	$ruÂ”_th»ad
(
ruÂ”_ty³
& 
r
, 
size_t
& 
txn_út
) {

89 
r
.
	`run
();

90 
txn_út
 = 
r
.
	`tÙ®_comm™s
();

93 
	$execu‹
(
cmd_·¿ms
 
p
) {

94 
size_t
 
num_u£rs
 = 
wikedŸ
::
cÚ¡ªts
::
u£rs
 * (size_t)
p
.
sÿË_u£r
;

95 
size_t
 
num_·ges
 = 
wikedŸ
::
cÚ¡ªts
::
·ges
 * (size_t)
p
.
sÿË_·ge
;

96 
wikedŸ
::
lßd_·¿ms
 
Í
 = {
num_u£rs
, 
num_·ges
};

97 
wikedŸ
::
run_·¿ms
 
	`½
(
num_u£rs
, 
num_·ges
, 
p
.
time
, wikedŸ::
wÜklßd_weightg¿m
);

100 auto& 
db
 = *(
Ãw
 
	`db_ty³
());

103 
lßd”_ty³
 
	`lßd”
(
db
, 
Í
);

104 
lßd”
.
	`lßd
();

107 
¡d
::
veùÜ
<
ruÂ”_ty³
> 
ruÂ”s
;

108 
¡d
::
veùÜ
<¡d::
th»ad
> 
ruÂ”_th»ads
;

109 
¡d
::
veùÜ
<
size_t
> 
	`comm™‹d_txn_úts
((size_t)
p
.
num_th»ads
, 0);

111 
id
 = 0; id < 
p
.
num_th»ads
; ++id)

112 
ruÂ”s
.
	`push_back
(
	`ruÂ”_ty³
(
id
, 
db
, 
½
));

114 
´of”_ty³
 
	`´of”
(
p
.
¥wª_³rf
);

115 
´of”
.
	`¡¬t
(
p
.
³rf_couÁ”_mode
 ? 
Prof”
::
³rf_mode
::
couÁ”s
 : Prof”::³rf_mode::
»cÜd
);

117 
t
 = 0; < 
p
.
num_th»ads
; ++t)

118 
ruÂ”_th»ads
.
	`push_back
(

119 
¡d
::
	`th»ad
(
ruÂ”_th»ad
, std::
	`»f
(
ruÂ”s
[
t
]), std::»f(
comm™‹d_txn_úts
[t]))

121 auto& 
t
 : 
ruÂ”_th»ads
)

122 
t
.
	`još
();

124 
size_t
 
tÙ®_comm™_txns
 = 0;

125 autØ
c
 : 
comm™‹d_txn_úts
)

126 
tÙ®_comm™_txns
 +ğ
c
;

128 
´of”
.
	`fšish
(
tÙ®_comm™_txns
);

130 
	`´št_abÜt_hi¡og¿m
(
ruÂ”s
);

132 
	`d–‘e
 (&
db
);

134 
	}
}

136 
´št_abÜt_hi¡og¿m
(
¡d
::
veùÜ
<
ruÂ”_ty³
>& 
ruÂ”s
) {

137 
¡d
::
¡ršg¡»am
 
ss
;

138 
	g¡d
::
veùÜ
<
size_t
> 
ov”®l_hi¡og¿m
(
wikedŸ
::
wÜklßd_weightg¿m
.
size
(), 0ul);

139 
	gidx
;

140 
	gruÂ”_ty³
& 
	gr
 : 
ruÂ”s
) {

141 
idx
 = 0;

142 
size_t
 
	gn
 : 
r
.
abÜts_by_txn
()) {

143 
ov”®l_hi¡og¿m
[
idx
] +ğ
n
;

144 ++
	gidx
;

148 
	gidx
 = 0;

149 
	gss
 << "AbÜˆª®ysis:" << 
	g¡d
::
’dl
;

150 
	gss
 << '{';

151 
size_t
 
	gn
 : 
ov”®l_hi¡og¿m
) {

152 
ss
 << 
¡©ic_ÿ¡
<
wikedŸ
::
TxnTy³
>(
idx
è<< ":" << 
n
;

153 ià((
	gsize_t
)
	gidx
 !ğ(
ov”®l_hi¡og¿m
.
size
() - 1))

154 
ss
 << ", ";

155 ++
	gidx
;

157 
	gss
 << '}';

159 
	g¡d
::
cout
 << 
ss
.
¡r
(è<< 
¡d
::
’dl
;

163 
	gcÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
;

165 
	$maš
(
¬gc
, cÚ¡ * cÚ¡ *
¬gv
) {

166 
cmd_·¿ms
 
·¿ms
;

168 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
	`¬¿ysize
(
İtiÚs
), options);

170 
»t_code
 = 0;

171 
İt
;

172 
boŞ
 
şp_¡İ
 = 
çl£
;

173 !
şp_¡İ
 && ((
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
)) {

174 
İt
) {

175 
İt_dbid
:

176 
·¿ms
.
db_id
 = 
	`·r£_dbid
(
şp
->
v®
.
s
);

177 ià(
·¿ms
.
db_id
 =ğ
db_·¿ms
::
db_·¿ms_id
::
NÚe
) {

178 
¡d
::
cout
 << "Unsupported DB CC id: "

179 << ((
şp
->
v®
.
s
 =ğ
nuÎ±r
è? "" : 
¡d
::
	`¡ršg
(şp->v®.s)è<< std::
’dl
;

180 
	`´št_u§ge
(
¬gv
[0]);

181 
»t_code
 = 1;

182 
şp_¡İ
 = 
Œue
;

185 
İt_Áhrs
:

186 
·¿ms
.
num_th»ads
 = 
şp
->
v®
.
i
;

188 
İt_u£rs
:

189 
·¿ms
.
sÿË_u£r
 = 
şp
->
v®
.
i
;

191 
İt_·ges
:

192 
·¿ms
.
sÿË_·ge
 = 
şp
->
v®
.
i
;

194 
İt_time
:

195 
·¿ms
.
time
 = 
şp
->
v®
.
d
;

197 
İt_³rf
:

198 
·¿ms
.
¥wª_³rf
 = !
şp
->
Ãg©ed
;

200 
İt_pfút
:

201 
·¿ms
.
³rf_couÁ”_mode
 = !
şp
->
Ãg©ed
;

204 
	`´št_u§ge
(
¬gv
[0]);

205 
»t_code
 = 1;

206 
şp_¡İ
 = 
Œue
;

211 
	`CÍ_D–‘eP¬£r
(
şp
);

212 ià(
»t_code
 != 0)

213  
»t_code
;

215 autØ
ıu_äeq
 = 
	`d‘”mše_ıu_äeq
();

216 ià(
ıu_äeq
 == 0.0)

219 
cÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
 = 
ıu_äeq
;

221 
·¿ms
.
db_id
) {

222 
db_·¿ms_id
::
DeçuÉ
:

223 
»t_code
 = 
b’ch_acûss
<
db_deçuÉ_·¿ms
>::
	`execu‹
(
·¿ms
);

225 
db_·¿ms_id
::
O·que
:

226 
»t_code
 = 
b’ch_acûss
<
db_İaque_·¿ms
>::
	`execu‹
(
·¿ms
);

228 
db_·¿ms_id
::
TwoPL
:

229 
»t_code
 = 
b’ch_acûss
<
db_2¶_·¿ms
>::
	`execu‹
(
·¿ms
);

231 
db_·¿ms_id
::
Ad­tive
:

232 
»t_code
 = 
b’ch_acûss
<
db_ad­tive_·¿ms
>::
	`execu‹
(
·¿ms
);

234 
db_·¿ms_id
::
Swiss
:

235 
»t_code
 = 
b’ch_acûss
<
db_swiss_·¿ms
>::
	`execu‹
(
·¿ms
);

237 
db_·¿ms_id
::
TicToc
:

238 
»t_code
 = 
b’ch_acûss
<
db_tiùoc_·¿ms
>::
	`execu‹
(
·¿ms
);

241 
¡d
::
û¼
 << "unknowÀdb cÚfig…¬am‘” id" << std::
’dl
;

242 
»t_code
 = 1;

246  
»t_code
;

247 
	}
}

	@benchmark/Wikipedia_bench.hh

1 #´agm¨
Úû


3 
	~<io¡»am
>

4 
	~<iomª
>

5 
	~<ùime
>

6 
	~<s¡»am
>

7 
	~<§m¶šg.hh
>

8 
	~<PÏtfÜmF—tu»s.hh
>

10 
	~"comp”.hh
"

11 
	~"WikedŸ_¡ruùs.hh
"

13 #ià
TABLE_FINE_GRAINED


14 
	~"WikedŸ_£ËùÜs.hh
"

17 
	~"DB_šdex.hh
"

18 
	~"DB_·¿ms.hh
"

20 
Çme¥aû
 
	gwikedŸ
 {

22 
	scÚ¡ªts
 {

23 
cÚ¡ex´
 
	gªÚymous_·ge_upd©e_´ob
 = 26;

24 
cÚ¡ex´
 
	gªÚymous_u£r_id
 = 0;

25 
cÚ¡ex´
 
	gtok’_Ëngth
 = 32;

26 
cÚ¡ex´
 
	g·ges
 = 1000;

27 
cÚ¡ex´
 
	gu£rs
 = 2000;

28 
cÚ¡ex´
 
	gmax_w©ches_³r_u£r
 = 1000;

29 
cÚ¡ex´
 
	gb©ch_size
 = 1000;

31 
cÚ¡ex´
 
	gnum_w©ches_³r_u£r_sigma
 = 1.75;

32 
cÚ¡ex´
 
	g·ge_id_sigma
 = 1.0001;

33 
cÚ¡ex´
 
	gw©chli¡_·ge_sigma
 = 1.0001;

34 
cÚ¡ex´
 
	g»visiÚ_u£r_sigma
 = 1.0001;

37 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

38 şas 
	cwikedŸ_db
 {

39 
	gpublic
:

40 
‹m¶©e
 <
ty³Çme
 
K
,y³Çm
	gV
>

41 
usšg
 
	gOIndex
 = 
Üd”ed_šdex
<
K
, 
	gV
, 
	gDBP¬ams
>;

46 
	gOIndex
<
	tloggšg_key
, 
	tloggšg_row
> 
	tlog_tbl_ty³
;

47 
	gOIndex
<
	t·ge_key
, 
	t·ge_row
> 
	t·ge_tbl_ty³
;

48 
	gOIndex
<
	t·ge_idx_key
, 
	t·ge_idx_row
> 
	t·ge_idx_ty³
;

51 
	gOIndex
<
	t»ûÁchªges_key
, 
	t»ûÁchªges_row
> 
	trc_tbl_ty³
;

52 
	gOIndex
<
	t»visiÚ_key
, 
	t»visiÚ_row
> 
	t»v_tbl_ty³
;

53 
	gOIndex
<
	t‹xt_key
, 
	t‹xt_row
> 
	t‹xt_tbl_ty³
;

54 
	gOIndex
<
	tu£¿cù_key
, 
	tu£¿cù_row
> 
	tu£r_tbl_ty³
;

55 
	gOIndex
<
	tu£¿cù_idx_key
, 
	tu£¿cù_idx_row
> 
	tu£r_idx_ty³
;

57 
	gOIndex
<
	tw©chli¡_key
, 
	tw©chli¡_row
> 
	twl_tbl_ty³
;

58 
	gOIndex
<
	tw©chli¡_idx_key
, 
	tw©chli¡_idx_row
> 
	twl_idx_ty³
;

60 
ex¶ic™
 
wikedŸ_db
() :

64 
tbl_log_
(),

65 
tbl_·ge_
(),

66 
idx_·ge_
(),

69 
tbl_rc_
(),

70 
tbl_»v_
(),

71 
tbl_‹xt_
(),

72 
tbl_u£r_
(),

73 
idx_u£r_
(),

75 
tbl_wl_
(),

76 
idx_wl_
() {}

89 
	glog_tbl_ty³
& 
tbl_loggšg
() {

90  
	gtbl_log_
;

92 
	g·ge_tbl_ty³
& 
tbl_·ge
() {

93  
	gtbl_·ge_
;

95 
	g·ge_idx_ty³
& 
idx_·ge
() {

96  
	gidx_·ge_
;

106 
	grc_tbl_ty³
& 
tbl_»ûÁchªges
() {

107  
	gtbl_rc_
;

109 
	g»v_tbl_ty³
& 
tbl_»visiÚ
() {

110  
	gtbl_»v_
;

112 
	g‹xt_tbl_ty³
& 
tbl_‹xt
() {

113  
	gtbl_‹xt_
;

115 
	gu£r_tbl_ty³
& 
tbl_u£¿cù
() {

116  
	gtbl_u£r_
;

118 
	gu£r_idx_ty³
& 
idx_u£¿cù
() {

119  
	gidx_u£r_
;

126 
	gwl_tbl_ty³
& 
tbl_w©chli¡
() {

127  
	gtbl_wl_
;

129 
	gwl_idx_ty³
& 
idx_w©chli¡
() {

130  
	gidx_wl_
;

133 
th»ad_š™_®l
() {

137 
	gtbl_log_
.
th»ad_š™
();

138 
	gtbl_·ge_
.
th»ad_š™
();

139 
	gidx_·ge_
.
th»ad_š™
();

142 
	gtbl_rc_
.
th»ad_š™
();

143 
	gtbl_»v_
.
th»ad_š™
();

144 
	gtbl_‹xt_
.
th»ad_š™
();

145 
	gtbl_u£r_
.
th»ad_š™
();

146 
	gidx_u£r_
.
th»ad_š™
();

148 
	gtbl_wl_
.
th»ad_š™
();

149 
	gidx_wl_
.
th»ad_š™
();

152 
	g´iv©e
:

156 
log_tbl_ty³
 
tbl_log_
;

157 
·ge_tbl_ty³
 
	gtbl_·ge_
;

158 
·ge_idx_ty³
 
	gidx_·ge_
;

161 
rc_tbl_ty³
 
	gtbl_rc_
;

162 
»v_tbl_ty³
 
	gtbl_»v_
;

163 
‹xt_tbl_ty³
 
	gtbl_‹xt_
;

164 
u£r_tbl_ty³
 
	gtbl_u£r_
;

165 
u£r_idx_ty³
 
	gidx_u£r_
;

167 
wl_tbl_ty³
 
	gtbl_wl_
;

168 
wl_idx_ty³
 
	gidx_wl_
;

171 cÚ¡ *
txn_Çmes
[6];

173 şas 
	cTxnTy³
 : { 
AddW©chLi¡
 = 0, 
	gG‘PageAnÚ
, 
	gG‘PageAuth
, 
	gRemoveW©chLi¡
, 
	gLi¡PageNameS·û
, 
	gUpd©ePage
 };

175 
šlše
 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
os
, cÚ¡ 
	gTxnTy³
& 
	gt
) {

176 
	gos
 << 
	gtxn_Çmes
[
¡©ic_ÿ¡
<>(
t
)];

177  
	gos
;

180 
	g§m¶šg
::
	tStoCu¡omDi¡ributiÚ
<
	tTxnTy³
>::
	tweightg¿m_ty³
 
	twÜklßd_mix_ty³
;

182 
	srun_·¿ms
 {

183 
ušt64_t
 
	gnum_u£rs
;

184 
ušt64_t
 
	gnum_·ges
;

185 
	gtime_lim™
;

186 
wÜklßd_mix_ty³
 
	gwÜklßd_mix
;

188 
run_·¿ms
(
size_t
 
nu
, size_ˆ
Å
, 
t
, cÚ¡ 
wÜklßd_mix_ty³
& 
wl
) :

189 
num_u£rs
(
nu
), 
num_·ges
(
Å
), 
time_lim™
(
t
), 
wÜklßd_mix
(
wl
) {}

192 
	slßd_·¿ms
 {

193 
ušt64_t
 
	gnum_u£rs
;

194 
ušt64_t
 
	gnum_·ges
;

199 
usšg
 
	gºg_ty³
 = 
§m¶šg
::
StoRªdomDi¡ributiÚ
<>::
ºg_ty³
;

201 
	g‹m¶©e
 <
ty³Çme
 
	gTy³
>

202 
usšg
 
	ghdi¡_ty³
 = 
§m¶šg
::
StoCu¡omDi¡ributiÚ
<
Ty³
>;

204 
usšg
 
	gui_hdi¡_ty³
 = 
hdi¡_ty³
<
ušt64_t
>;

205 
usšg
 
	gsi_hdi¡_ty³
 = 
hdi¡_ty³
<
št64_t
>;

206 
usšg
 
	gtxn_di¡_ty³
 = 
hdi¡_ty³
<
TxnTy³
>;

207 
usšg
 
	g¡r_hdi¡_ty³
 = 
hdi¡_ty³
<
¡d
::
¡ršg
>;

209 
usšg
 
	gunif_di¡_ty³
 = 
§m¶šg
::
StoUnifÜmDi¡ributiÚ
<>;

210 
usšg
 
	gzf_di¡_ty³
 = 
§m¶šg
::
StoZfDi¡ributiÚ
<>;

212 
usšg
 
	gui_hi¡_ty³
 = 
ui_hdi¡_ty³
::
hi¡og¿m_ty³
;

213 
usšg
 
	gsi_hi¡_ty³
 = 
si_hdi¡_ty³
::
hi¡og¿m_ty³
;

214 
usšg
 
	g¡r_hi¡_ty³
 = 
¡r_hdi¡_ty³
::
hi¡og¿m_ty³
;

216 cÚ¡ 
wÜklßd_mix_ty³
 
wÜklßd_weightg¿m
;

218 cÚ¡ 
ui_hi¡_ty³
 
·ge_t™Ë_Ën_hi¡
;

219 cÚ¡ 
ui_hi¡_ty³
 
»visiÚs_³r_·ge_hi¡
;

220 cÚ¡ 
ui_hi¡_ty³
 
·ge_Çme¥aû_hi¡
;

221 cÚ¡ 
¡r_hi¡_ty³
 
·ge_»¡riùiÚs_hi¡
;

222 cÚ¡ 
ui_hi¡_ty³
 
»v_comm’t_Ën_hi¡
;

223 cÚ¡ 
¡d
::
veùÜ
<
size_t
> 
»v_d–_sizes
;

224 cÚ¡ 
¡d
::
veùÜ
<
si_hi¡_ty³
> 
»v_d–s
;

225 cÚ¡ 
ui_hi¡_ty³
 
»v_mšÜ_ed™_hi¡
;

226 cÚ¡ 
ui_hi¡_ty³
 
‹xt_Ën_hi¡
;

227 cÚ¡ 
ui_hi¡_ty³
 
u£r_Çme_Ën_hi¡
;

228 cÚ¡ 
ui_hi¡_ty³
 
u£r_»®_Çme_Ën_hi¡
;

229 cÚ¡ 
ui_hi¡_ty³
 
u£r_»v_couÁ_hi¡
;

231 
	sbasic_di¡s
 {

232 
ºg_ty³
 
	gth»ad_ºg
;

234 
ui_hdi¡_ty³
 
	g·ge_t™Ë_Ën_di¡
;

235 
ui_hdi¡_ty³
 
	g·ge_Çme¥aû_di¡
;

236 
ui_hdi¡_ty³
 
	g»v_mšÜ_ed™_di¡
;

237 
	g¡d
::
veùÜ
<
si_hdi¡_ty³
> 
»v_d–s_di¡s
;

238 
zf_di¡_ty³
 
	g·ge_id_di¡
;

239 
	g¡d
::
unifÜm_št_di¡ributiÚ
<> 
¡d_u£r_id_di¡
;

240 
	g¡d
::
unifÜm_št_di¡ributiÚ
<> 
¡d_v4_di¡
;

241 
	g¡d
::
unifÜm_št_di¡ributiÚ
<> 
¡d_ch¬_di¡
;

243 
basic_di¡s
(
id
, 
ušt64_t
 
num_u£rs
, ušt64_ˆ
num_·ges
)

244 : 
th»ad_ºg
(
id
),

245 
·ge_t™Ë_Ën_di¡
(
th»ad_ºg
, 
·ge_t™Ë_Ën_hi¡
),

246 
·ge_Çme¥aû_di¡
(
th»ad_ºg
, 
·ge_Çme¥aû_hi¡
),

247 
»v_mšÜ_ed™_di¡
(
th»ad_ºg
, 
»v_mšÜ_ed™_hi¡
),

248 
»v_d–s_di¡s
(),

249 
·ge_id_di¡
(
th»ad_ºg
, 1, 
num_·ges
, 
cÚ¡ªts
::
·ge_id_sigma
),

250 
¡d_u£r_id_di¡
(1, 
¡©ic_ÿ¡
<>(
num_u£rs
)),

251 
¡d_v4_di¡
(0, 255),

252 
¡d_ch¬_di¡
(32, 126) {

253 auto& 
	gh
 : 
»v_d–s
) {

254 
»v_d–s_di¡s
.
em¶aû_back
(
th»ad_ºg
, 
h
);

259 
	sruÁime_di¡s
 {

260 
txn_di¡_ty³
 
	gtxn_di¡
;

262 
ruÁime_di¡s
(
ºg_ty³
& 
th»ad_ºg
, cÚ¡ 
wÜklßd_mix_ty³
& 
wÜklßd_mix
)

263 : 
txn_di¡
(
th»ad_ºg
, 
wÜklßd_mix
) {}

266 
	slßdtime_di¡s
 {

267 
¡r_hdi¡_ty³
 
	g·ge_»¡riùiÚs_di¡
;

268 
ui_hdi¡_ty³
 
	gu£r_Çme_Ën_di¡
;

269 
ui_hdi¡_ty³
 
	gu£r_»®_Çme_Ën_di¡
;

270 
ui_hdi¡_ty³
 
	gu£r_»vcouÁ_di¡
;

271 
ui_hdi¡_ty³
 
	g»visiÚs_³r_·ge_di¡
;

272 
ui_hdi¡_ty³
 
	g‹xt_Ën_di¡
;

273 
zf_di¡_ty³
 
	gu£r_w©ch_di¡
;

274 
	g¡d
::
unifÜm_»®_di¡ributiÚ
<> 
¡d_pg_ºd_di¡
;

276 
lßdtime_di¡s
(
ºg_ty³
& 
th»ad_ºg
, 
size_t
 
num_·ges
)

277 : 
·ge_»¡riùiÚs_di¡
(
th»ad_ºg
, 
·ge_»¡riùiÚs_hi¡
),

278 
u£r_Çme_Ën_di¡
(
th»ad_ºg
, 
u£r_Çme_Ën_hi¡
),

279 
u£r_»®_Çme_Ën_di¡
(
th»ad_ºg
, 
u£r_»®_Çme_Ën_hi¡
),

280 
u£r_»vcouÁ_di¡
(
th»ad_ºg
, 
u£r_»v_couÁ_hi¡
),

281 
»visiÚs_³r_·ge_di¡
(
th»ad_ºg
, 
»visiÚs_³r_·ge_hi¡
),

282 
‹xt_Ën_di¡
(
th»ad_ºg
, 
‹xt_Ën_hi¡
),

283 
u£r_w©ch_di¡
(
th»ad_ºg
,

284 0, 
¡d
::
mš
(
num_·ges
, 
¡©ic_ÿ¡
<
ušt64_t
>(
cÚ¡ªts
::
max_w©ches_³r_u£r
)),

285 
cÚ¡ªts
::
num_w©ches_³r_u£r_sigma
),

286 
¡d_pg_ºd_di¡
(0.0, 100.0) {}

289 şas 
	cšput_g’”©Ü
 {

290 
	gpublic
:

291 
ty³Çme
 
	t§m¶šg
::
	tStoRªdomDi¡ributiÚ
<>::
	tºg_ty³
„ng_type;

293 
	g¡d
::
¡ršg
 
cu¼_time¡amp_¡ršg
() {

294 autØ
t
 = 
¡d
::
time
(
nuÎ±r
);

295 autØ
	gtm
 = *
¡d
::
loÿÉime
(&
t
);

296 
	g¡d
::
¡ršg¡»am
 
ss
;

297 
	gss
 << 
	g¡d
::
put_time
(&
tm
, "%d%m%Y%H-%M");

298  
	gss
.
¡r
();

301 
	g¡d
::
¡ršg
 
g’”©e__add»ss
() {

302 
¡d
::
¡ršg¡»am
 
ss
;

303 
	gi
 = 0; i < 4; ++i) {

304 
	gss
 << 
	gdi¡s
.
¡d_v4_di¡
(
di¡s
.
th»ad_ºg
);

305 ià(
	gi
 != 3)

306 
ss
 << '.';

308  
	gss
.
¡r
();

311 
št32_t
 
g’”©e_u£r_id
() {

312  
	gdi¡s
.
¡d_u£r_id_di¡
(
di¡s
.
th»ad_ºg
);

314 
št32_t
 
g’”©e_·ge_id
() {

315  (
	gšt32_t
)
	gdi¡s
.
	g·ge_id_di¡
.
§m¶e
();

317 
št32_t
 
g’”©e_·ge_Çme¥aû
(
·ge_id
) {

318 
ºg_ty³
 
g
(
·ge_id
);

319  (
	gšt32_t
)
	gdi¡s
.
	g·ge_Çme¥aû_di¡
.
§m¶e
(
g
);

321 
št32_t
 
g’”©e_»v_mšÜ_ed™
() {

322  (
	gšt32_t
)
	gdi¡s
.
	g»v_mšÜ_ed™_di¡
.
§m¶e
();

324 
	g¡d
::
¡ršg
 
g’”©e_»v_comm’t
() {

328 
	g¡d
::
¡ršg
 
g’”©e_»v_‹xt
(cÚ¡ 
¡d
::¡ršg& 
Şd_‹xt
) {

329 
¡d
::
¡ršg
 
¡r
;

330 
	g»v_d–_id
 = 0;

331 autØ
	gsz
 : 
»v_d–_sizes
) {

332 ià(
Şd_‹xt
.
Ëngth
(è<ğ
sz
)

334 ++
	g»v_d–_id
;

336 ià(
	g»v_d–_id
 =ğ()
»v_d–_sizes
.
size
())

337 --
»v_d–_id
;

338 
as£¹
((
»v_d–_id
 >ğ0è&& (»v_d–_id < ()
»v_d–_sizes
.
size
()));

340 auto& 
	gd
 = 
di¡s
.
»v_d–s_di¡s
[
»v_d–_id
];

341 
št64_t
 
	gd–
 = 
d
.
§m¶e
();

342 ià((
	gšt64_t
)
	gŞd_‹xt
.
Ëngth
(è+ 
	gd–
 <= 0) {

343 
d–
 = -1È* 
¡d
::
Ìound
(()
Şd_‹xt
.
Ëngth
() / 1.5);

344 ià((
	g¡d
::
abs
(
d–
è=ğ(
št64_t
)
Şd_‹xt
.
Ëngth
()) && delta < 0) {

345 
d–
 /= 2;

349 ià(
	gd–
 != 0) {

350 
¡r
 = 
»size_‹xt
(
Şd_‹xt
, 
d–
);

352 
	g¡r
 = 
Şd_‹xt
;

355  
³rmu‹_‹xt
(
¡d
::
move
(
¡r
));

357 
	g¡d
::
¡ršg
 
g’”©e_·ge_t™Ë
(
·ge_id
) {

358 
ºg_ty³
 
g
(
·ge_id
);

359 autØ
	gt™Ë_Ën
 = 
di¡s
.
·ge_t™Ë_Ën_di¡
.
§m¶e
(
g
);

361 
	g¡d
::
¡ršg¡»am
 
ss
;

362 
	gss
 << 
¿ndom_¡ršg
(
g
, 
t™Ë_Ën
);

363 
	gss
 << '[' << 
	g·ge_id
 << ']';

365  
	gss
.
¡r
();

368 
	g´Ùeùed
:

369 
šput_g’”©Ü
(
ruÂ”_id
, 
size_t
 
num_u£rs
, size_ˆ
num_·ges
)

370 : 
di¡s
(
ruÂ”_id
, 
num_u£rs
, 
num_·ges
) {}

372 
	g¡d
::
¡ršg
 
¿ndom_¡ršg
(
ºg_ty³
& 
ºg
, 
size_t
 
Ën
) {

373 
	g¡d
::
¡ršg
 
rs
;

374 
	grs
.
»size
(
Ën
);

375 
size_t
 
	gi
 = 0; i < 
	gËn
; ++i)

376 
	grs
[
i
] = ()
di¡s
.
¡d_ch¬_di¡
(
ºg
);

377  
	grs
;

379 
	g¡d
::
¡ršg
 
¿ndom_¡ršg
(
size_t
 
Ën
) {

380 
¡d
::
¡ršg
 
rs
;

381 
	grs
.
»size
(
Ën
);

382 
size_t
 
	gi
 = 0; i < 
	gËn
; ++i)

383 
	grs
[
i
] = ()
di¡s
.
¡d_ch¬_di¡
(di¡s.
th»ad_ºg
);

384  
	grs
;

387 
	g¡d
::
¡ršg
 
»size_‹xt
(cÚ¡ 
¡d
::¡ršg& 
Şd_‹xt
, 
št64_t
 
d–
) {

388 
št64_t
 
	gÃw_Ën
 = (št64_t)
Şd_‹xt
.
Ëngth
(è+ 
d–
;

389 
as£¹
(
Ãw_Ën
 > 0);

391 
	g¡d
::
¡ršg
 
rs
;

392 
	grs
.
»size
((
size_t
)
Ãw_Ën
);

394 
size_t
 
	gi
 = 0; i < (
	gsize_t
)
	gÃw_Ën
; ++i) {

395 
	grs
[
i
] = (˜< 
Şd_‹xt
.
Ëngth
()) ? old_text[i]

396 :()
di¡s
.
¡d_ch¬_di¡
(di¡s.
th»ad_ºg
);

398  
	grs
;

400 
	g¡d
::
¡ršg
 
³rmu‹_‹xt
(
¡d
::¡ršg&& 
Üig_‹xt
) {

402  
Üig_‹xt
;

405 
basic_di¡s
 
	gdi¡s
;

408 şas 
	cruÁime_šput_g’”©Ü
 : 
public
 
šput_g’”©Ü
 {

409 
public
:

410 
ruÁime_šput_g’”©Ü
(
ruÂ”_id
, 
size_t
 
num_u£rs
, size_ˆ
num_·ges
, cÚ¡ 
wÜklßd_mix_ty³
& 
wÜklßd_mix
)

411 : 
šput_g’”©Ü
(
ruÂ”_id
+1040, 
num_u£rs
, 
num_·ges
),

412 
r_di¡s
(
di¡s
.
th»ad_ºg
, 
wÜklßd_mix
) {}

414 
TxnTy³
 
Ãxt_Œª§ùiÚ
() {

415  
	gr_di¡s
.
	gtxn_di¡
.
§m¶e
();

418 
	g´iv©e
:

419 
ruÁime_di¡s
 
r_di¡s
;

422 şas 
	clßdtime_šput_g’”©Ü
 : 
public
 
šput_g’”©Ü
 {

423 
public
:

424 
lßdtime_šput_g’”©Ü
(
ruÂ”_id
, 
size_t
 
num_u£rs
, size_ˆ
num_·ges
)

425 : 
šput_g’”©Ü
(
ruÂ”_id
, 
num_u£rs
, 
num_·ges
),

426 
l_di¡s
(
di¡s
.
th»ad_ºg
, 
num_·ges
) {}

428 
g’”©e_·ge_¿ndom
() {

429  
	gl_di¡s
.
¡d_pg_ºd_di¡
(
di¡s
.
th»ad_ºg
);

431 
	g¡d
::
¡ršg
 
g’”©e_·ge_»¡riùiÚs
() {

432  
l_di¡s
.
·ge_»¡riùiÚs_di¡
.
§m¶e
();

434 
	g¡d
::
¡ršg
 
g’”©e_u£r_Çme
() {

435  
¿ndom_¡ršg
(
l_di¡s
.
u£r_Çme_Ën_di¡
.
§m¶e
());

437 
	g¡d
::
¡ršg
 
g’”©e_u£r_»®_Çme
() {

438  
¿ndom_¡ršg
(
l_di¡s
.
u£r_»®_Çme_Ën_di¡
.
§m¶e
());

440 
	g¡d
::
¡ršg
 
g’”©e_u£r_tok’
() {

441  
¿ndom_¡ršg
(
cÚ¡ªts
::
tok’_Ëngth
);

443 
	g¡d
::
¡ršg
 
g’”©e_¿ndom_Şd_‹xt
() {

444 autØ
Şd_‹xt_Ën
 = 
l_di¡s
.
‹xt_Ën_di¡
.
§m¶e
();

445  
¿ndom_¡ršg
(
Şd_‹xt_Ën
);

447 
g’”©e_u£r_ed™couÁ
() {

448  ()
	gl_di¡s
.
	gu£r_»vcouÁ_di¡
.
§m¶e
();

450 
g’”©e_num_»visiÚs
() {

451  ()
	gl_di¡s
.
	g»visiÚs_³r_·ge_di¡
.
§m¶e
();

453 
g’”©e_num_w©ches
() {

454  ()
	gl_di¡s
.
	gu£r_w©ch_di¡
.
§m¶e
();

457 
	g´iv©e
:

459 
lßdtime_di¡s
 
l_di¡s
;

462 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

463 şas 
	cwikedŸ_ruÂ”
 {

464 
	gpublic
:

465 
wikedŸ_db
<
	tDBP¬ams
> 
	tdb_ty³
;

467 
wikedŸ_ruÂ”
(
ruÂ”_id
, 
db_ty³
& 
d©aba£
, cÚ¡ 
run_·¿ms
& 
·¿ms
)

468 : 
id
(
ruÂ”_id
), 
db
(
d©aba£
),

469 
ig
(
ruÂ”_id
, 
·¿ms
.
num_u£rs
,…¬ams.
num_·ges
,…¬ams.
wÜklßd_mix
),

470 
tsc_–­£_lim™
(), 
¡©s_abÜts_by_txn
(
wÜklßd_weightg¿m
.
size
(), 0ul) {

471 
	gtsc_–­£_lim™
 =

472 (
ušt64_t
)(
·¿ms
.
time_lim™
 * 
db_·¿ms
::
cÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
 * db_·¿ms::cÚ¡ªts::
bliÚ
);

475 
size_t
 
run_txn_addW©chLi¡
(
u£r_id
, 
Çme_¥aû
, cÚ¡ 
¡d
::
¡ršg
& 
·ge_t™Ë
);

476 
	g¡d
::
·œ
<
size_t
, 
	g¬tişe_ty³
> 
run_txn_g‘PageAnÚymous
(
boŞ
 
fÜ_£Ëù
, cÚ¡ 
¡d
::
¡ršg
& 
u£r_
,

477 
Çme_¥aû
, cÚ¡ 
¡d
::
¡ršg
& 
·ge_t™Ë
);

478 
	g¡d
::
·œ
<
size_t
, 
	g¬tişe_ty³
> 
run_txn_g‘PageAuth’tiÿ‹d
(
boŞ
 
fÜ_£Ëù
, cÚ¡ 
¡d
::
¡ršg
& 
u£r_
,

479 
u£r_id
, 
Çme_¥aû
, cÚ¡ 
¡d
::
¡ršg
& 
·ge_t™Ë
);

480 
size_t
 
run_txn_»moveW©chLi¡
(
u£r_id
, 
Çme_¥aû
, cÚ¡ 
¡d
::
¡ršg
& 
·ge_t™Ë
);

481 
size_t
 
run_txn_li¡PageNameS·û
(
Çme_¥aû
);

482 
size_t
 
run_txn_upd©ePage
(
‹xt_id
, 
·ge_id
, cÚ¡ 
¡d
::
¡ršg
& 
·ge_t™Ë
,

483 cÚ¡ 
¡d
::
¡ršg
& 
·ge_‹xt
, 
·ge_Çme_¥aû
, 
u£r_id
,

484 cÚ¡ 
¡d
::
¡ršg
& 
u£r_
, cÚ¡ std::¡ršg& 
u£r_‹xt
,

485 
»v_id
, cÚ¡ 
¡d
::
¡ršg
& 
»v_comm’t
, 
»v_mšÜ_ed™
);

488 
run
();

490 
size_t
 
tÙ®_comm™s
() const {

491  
	g¡©s_tÙ®_comm™s
;

494 cÚ¡ 
	g¡d
::
veùÜ
<
size_t
>& 
abÜts_by_txn
() const {

495  
¡©s_abÜts_by_txn
;

498 
	g´iv©e
:

499 
boŞ
 
txn_upd©ePage_šÃr
(
‹xt_id
, 
·ge_id
, cÚ¡ 
¡d
::
¡ršg
& 
·ge_t™Ë
,

500 cÚ¡ 
¡d
::
¡ršg
& 
·ge_‹xt
, 
·ge_Çme_¥aû
, 
u£r_id
,

501 cÚ¡ 
¡d
::
¡ršg
& 
u£r_
, cÚ¡ std::¡ršg& 
u£r_‹xt
,

502 
»v_id
, cÚ¡ 
¡d
::
¡ršg
& 
»v_comm’t
, 
»v_mšÜ_ed™
,

503 
size_t
& 
n¡¬ts
);

504 
	gid
;

505 
	gdb_ty³
& 
	gdb
;

506 
ruÁime_šput_g’”©Ü
 
	gig
;

507 
ušt64_t
 
	gtsc_–­£_lim™
;

508 
size_t
 
	g¡©s_tÙ®_comm™s
;

509 
	g¡d
::
veùÜ
<
size_t
> 
¡©s_abÜts_by_txn
;

512 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

513 şas 
	cwikedŸ_lßd”
 {

514 
	gpublic
:

515 *
u£r_»visiÚ_úts
;

516 *
	g·ge_Ï¡_»v_ids
;

517 *
	g·ge_Ï¡_»v_Ëns
;

519 
ex¶ic™
 
wikedŸ_lßd”
(
wikedŸ_db
<
DBP¬ams
>& 
wdb
, cÚ¡ 
lßd_·¿ms
& 
·¿ms
)

520 : 
num_u£rs
(()
·¿ms
.num_u£rs), 
num_·ges
(()params.num_pages),

521 
db
(
wdb
), 
ig
(6332, 
·¿ms
.
num_u£rs
,…¬ams.
num_·ges
) {}

523 
lßd
();

525 
š™Ÿlize_sü©ch_¥aû
(
size_t
 
num_u£rs
, size_ˆ
num_·ges
) {

526 
as£¹
(
u£r_»visiÚ_úts
 =ğ
nuÎ±r
);

527 
	gu£r_»visiÚ_úts
 = 
Ãw
 [
num_u£rs
];

528 
	g·ge_Ï¡_»v_ids
 = 
Ãw
 [
num_·ges
];

529 
	g·ge_Ï¡_»v_Ëns
 = 
Ãw
 [
num_·ges
];

531 
size_t
 
	gi
 = 0; i < 
	gnum_u£rs
; ++i)

532 
	gu£r_»visiÚ_úts
[
i
] = 0;

533 
size_t
 
	gi
 = 0; i < 
	gnum_·ges
; ++i) {

534 
	g·ge_Ï¡_»v_ids
[
i
] = 0;

535 
	g·ge_Ï¡_»v_Ëns
[
i
] = 0;

539 
ä“_sü©ch_¥aû
() {

540 
	gd–‘e
[] 
	gu£r_»visiÚ_úts
;

541 
	gd–‘e
[] 
	g·ge_Ï¡_»v_ids
;

542 
	gd–‘e
[] 
	g·ge_Ï¡_»v_Ëns
;

544 
	gu£r_»visiÚ_úts
 = 
nuÎ±r
;

545 
	g·ge_Ï¡_»v_ids
 = 
nuÎ±r
;

546 
	g·ge_Ï¡_»v_Ëns
 = 
nuÎ±r
;

549 
	g´iv©e
:

550 
lßd_u£¿cù
();

551 
lßd_·ge
();

552 
lßd_w©chli¡
();

553 
lßd_»visiÚ
();

555 
	gnum_u£rs
;

556 
	gnum_·ges
;

557 
	gwikedŸ_db
<
	gDBP¬ams
>& 
	gdb
;

558 
lßdtime_šput_g’”©Ü
 
	gig
;

561 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

562 
	gwikedŸ_ruÂ”
<
	gDBP¬ams
>::
	$run
() {

563 ::
TTh»ad
::
	`£t_id
(
id
);

564 
	`£t_affš™y
(
id
);

565 
db
.
	`th»ad_š™_®l
();

567 autØ
tsc_begš
 = 
	`»ad_tsc
();

568 
size_t
 
út
 = 0;

569 
Œue
) {

570 autØ
t_ty³
 = 
ig
.
	`Ãxt_Œª§ùiÚ
();

571 autØ
u£r_id
 = 
ig
.
	`g’”©e_u£r_id
();

572 autØ
·ge_id
 = 
ig
.
	`g’”©e_·ge_id
();

573 autØ
·ge_ns
 = 
ig
.
	`g’”©e_·ge_Çme¥aû
(
·ge_id
);

574 autØ
·ge_t™Ë
 = 
ig
.
	`g’”©e_·ge_t™Ë
(
·ge_id
);

575 
size_t
 
»Œ›s
 = 0;

576 
t_ty³
) {

577 
TxnTy³
::
AddW©chLi¡
:

578 
»Œ›s
 = 
	`run_txn_addW©chLi¡
(
u£r_id
, 
·ge_ns
, 
·ge_t™Ë
);

580 
TxnTy³
::
RemoveW©chLi¡
:

581 
»Œ›s
 = 
	`run_txn_»moveW©chLi¡
(
u£r_id
, 
·ge_ns
, 
·ge_t™Ë
);

583 
TxnTy³
::
G‘PageAnÚ
:

584 
¡d
::
	`t›
(
»Œ›s
, std::
ignÜe
èğ
	`run_txn_g‘PageAnÚymous
(
çl£
, 
ig
.
	`g’”©e__add»ss
(), 
·ge_ns
, 
·ge_t™Ë
);

586 
TxnTy³
::
G‘PageAuth
:

587 
¡d
::
	`t›
(
»Œ›s
, std::
ignÜe
èğ
	`run_txn_g‘PageAuth’tiÿ‹d
(
çl£
, 
ig
.
	`g’”©e__add»ss
(), 
u£r_id
, 
·ge_ns
, 
·ge_t™Ë
);

589 
TxnTy³
::
Li¡PageNameS·û
:

590 
»Œ›s
 = 
	`run_txn_li¡PageNameS·û
(
·ge_ns
);

592 
TxnTy³
::
Upd©ePage
: {

593 autØ
addr
 = 
ig
.
	`g’”©e__add»ss
();

594 
size_t
 
¹1
;

595 
¬tişe_ty³
 
¬tişe
;

596 
¡d
::
	`t›
(
¹1
, 
¬tişe
èğ
	`run_txn_g‘PageAnÚymous
(
çl£
, 
addr
, 
·ge_ns
, 
·ge_t™Ë
);

597 ià(
¬tişe
.
‹xt_id
 =ğ0 ||‡¹işe.
·ge_id
 == 0)

599 
»Œ›s
 = 
	`run_txn_upd©ePage
(
¬tişe
.
‹xt_id
,‡¹işe.
·ge_id
, 
·ge_t™Ë
, 
ig
.
	`g’”©e_»v_‹xt
×¹işe.
Şd_‹xt
),

600 
·ge_ns
, 
u£r_id
, 
addr
, 
¬tişe
.
u£r_‹xt
,‡¹işe.
»v_id
,

601 
ig
.
	`g’”©e_»v_comm’t
(), ig.
	`g’”©e_»v_mšÜ_ed™
());

602 
»Œ›s
 +ğ
¹1
;

606 
	`®ways_as£¹
(
çl£
, "unknownransactionype");

610 
¡©s_abÜts_by_txn
.
	`©
(
¡©ic_ÿ¡
<
size_t
>(
t_ty³
)è+ğ
»Œ›s
;

612 ++
út
;

613 ià((
	`»ad_tsc
(è- 
tsc_begš
è>ğ
tsc_–­£_lim™
)

616 
¡©s_tÙ®_comm™s
 = 
út
;

617 
	}
}

	@benchmark/Wikipedia_data.cc

1 
	~"§m¶šg.hh
"

2 
	~"WikedŸ_b’ch.hh
"

4 
Çme¥aû
 
	gwikedŸ
 {

6 cÚ¡ *
	gtxn_Çmes
[6] = {"AddWatchList", "GetPageAnon", "GetPageAuth", "RemoveWatchList", "ListPageNameSpace", "UpdatePage"};

8 cÚ¡ 
	gtxn_di¡_ty³
::
weightg¿m_ty³
 
wÜklßd_weightg¿m
 = {

9 {
TxnTy³
::
AddW©chLi¡
, 0.07},

10 {
TxnTy³
::
RemoveW©chLi¡
, 0.07},

11 {
TxnTy³
::
Upd©ePage
, 4.6725},

12 {
TxnTy³
::
Li¡PageNameS·û
, 47.4218},

13 {
TxnTy³
::
G‘PageAnÚ
, 46.8438},

14 {
TxnTy³
::
G‘PageAuth
, 0.9219}};

16 cÚ¡ 
ui_hi¡_ty³
 
	g·ge_t™Ë_Ën_hi¡
 = {

128 cÚ¡ 
ui_hi¡_ty³
 
	g»visiÚs_³r_·ge_hi¡
 = {

320 cÚ¡ 
ui_hi¡_ty³
 
	g·ge_Çme¥aû_hi¡
 = {

341 cÚ¡ 
ui_hi¡_ty³
 
	g»v_comm’t_Ën_hi¡
 = {

600 cÚ¡ 
	g¡d
::
veùÜ
<
size_t
> 
»v_d–_sizes
 = { 1000, 10000, 100000 };

602 cÚ¡ 
	g¡d
::
veùÜ
<
si_hi¡_ty³
> 
»v_d–s
 = {

1624 cÚ¡ 
ui_hi¡_ty³
 
	g»v_mšÜ_ed™_hi¡
 = {

1629 cÚ¡ 
ui_hi¡_ty³
 
	g‹xt_Ën_hi¡
 = {

2632 cÚ¡ 
ui_hi¡_ty³
 
	gu£r_Çme_Ën_hi¡
 = {

2688 cÚ¡ 
ui_hi¡_ty³
 
	gu£r_»®_Çme_Ën_hi¡
 = {

2744 cÚ¡ 
ui_hi¡_ty³
 
	gu£r_»v_couÁ_hi¡
 = {

3311 cÚ¡ 
¡r_hi¡_ty³
 
	g·ge_»¡riùiÚs_hi¡
 = {

	@benchmark/Wikipedia_loader.hh

1 #´agm¨
Úû


3 
	~<£t
>

4 
	~"WikedŸ_b’ch.hh
"

6 
Çme¥aû
 
	gwikedŸ
 {

8 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

9 
	gwikedŸ_lßd”
<
	gDBP¬ams
>::
lßd
() {

10 
¡d
::
cout
 << "Lßdšg d©aba£..." << std::
’dl
;

12 
	gwikedŸ_lßd”
::
š™Ÿlize_sü©ch_¥aû
((
size_t
)
num_u£rs
, (size_t)
num_·ges
);

13 
lßd_»visiÚ
();

14 
lßd_u£¿cù
();

15 
lßd_·ge
();

16 
lßd_w©chli¡
();

17 
	gwikedŸ_lßd”
::
ä“_sü©ch_¥aû
();

19 
	g¡d
::
cout
 << "Lßded." << 
¡d
::
’dl
;

22 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

23 
	gwikedŸ_lßd”
<
	gDBP¬ams
>::
lßd_u£¿cù
() {

24 
uid
 = 1; 
	guid
 <ğ
num_u£rs
; ++uid) {

25 
u£¿cù_row
 
	gu_r
;

26 
	gu_r
.
	gu£r_Çme
 = 
ig
.
g’”©e_u£r_Çme
();

27 
	gu_r
.
	gu£r_»®_Çme
 = 
ig
.
g’”©e_u£r_»®_Çme
();

28 
	gu_r
.
	gu£r_·sswÜd
 = "password";

29 
	gu_r
.
	gu£r_Ãw·sswÜd
 = "newpassword";

30 
	gu_r
.
	gu£r_Ãw·ss_time
 = 
ig
.
cu¼_time¡amp_¡ršg
();

31 
	gu_r
.
	gu£r_ema
 = "user@example.com";

32 
	gu_r
.
	gu£r_İtiÚs
 = "fake_longoptionslist";

33 
	gu_r
.
	gu£r_touched
 = 
ig
.
cu¼_time¡amp_¡ršg
();

34 
	gu_r
.
	gu£r_tok’
 = 
ig
.
g’”©e_u£r_tok’
();

35 
	gu_r
.
	gu£r_ema_auth’tiÿ‹d
 = "null";

36 
	gu_r
.
	gu£r_ema_tok’
 = "null";

37 
	gu_r
.
	gu£r_ema_tok’_expœes
 = "null";

38 
	gu_r
.
	gu£r_»gi¡¿tiÚ
 = "null";

39 
	gu_r
.
	gu£r_ed™couÁ
 = 
u£r_»visiÚ_úts
[
uid
 - 1];

41 
	gdb
.
tbl_u£¿cù
().
nÚŒªs_put
(
u£¿cù_key
(
uid
), 
u_r
);

45 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

46 
	gwikedŸ_lßd”
<
	gDBP¬ams
>::
lßd_·ge
() {

47 
pid
 = 1; 
	gpid
 <ğ
num_·ges
; ++pid) {

48 
	g·ge_ns
 = 
ig
.
g’”©e_·ge_Çme¥aû
(
pid
);

49 autØ
	g·ge_t™Ë
 = 
ig
.
g’”©e_·ge_t™Ë
(
pid
);

50 autØ
	g·ge_»¡riùiÚs
 = 
ig
.
g’”©e_·ge_»¡riùiÚs
();

51 
·ge_row
 
	gpg_r
;

52 
	gpg_r
.
	g·ge_Çme¥aû
 = 
·ge_ns
;

53 
	gpg_r
.
	g·ge_t™Ë
 = 
·ge_t™Ë
;

54 
	gpg_r
.
	g·ge_»¡riùiÚs
 = 
·ge_»¡riùiÚs
;

55 
	gpg_r
.
	g·ge_couÁ”
 = 0;

56 
	gpg_r
.
	g·ge_is_»dœeù
 = 0;

57 
	gpg_r
.
	g·ge_is_Ãw
 = 0;

58 
	gpg_r
.
	g·ge_¿ndom
 = 
ig
.
g’”©e_·ge_¿ndom
();

59 
	gpg_r
.
	g·ge_touched
 = 
ig
.
cu¼_time¡amp_¡ršg
();

60 
	gpg_r
.
	g·ge_Ï‹¡
 = 
·ge_Ï¡_»v_ids
[
pid
 - 1];

61 
	gpg_r
.
	g·ge_Ën
 = 
·ge_Ï¡_»v_Ëns
[
pid
 - 1];

63 
	gdb
.
tbl_·ge
().
nÚŒªs_put
(
·ge_key
(
pid
), 
pg_r
);

65 
·ge_idx_row
 
	gpi_r
{};

66 
	gpi_r
.
	g·ge_id
 = 
pid
;

67 
	gdb
.
idx_·ge
().
nÚŒªs_put
(
·ge_idx_key
(
·ge_ns
, 
·ge_t™Ë
), 
pi_r
);

71 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

72 
	gwikedŸ_lßd”
<
	gDBP¬ams
>::
lßd_w©chli¡
() {

73 
¡d
::
£t
<> 
u£r_·ges
;

74 
	guid
 = 1; uid <ğ
num_u£rs
; ++uid) {

75 
	gu£r_·ges
.
ş—r
();

76 autØ
	gnum_w©ches
 = 
ig
.
g’”©e_num_w©ches
();

77 
	gwid
 = 1; wid <ğ
num_w©ches
; ++wid) {

78 
	g·ge_id
;

79 ià(
	gnum_w©ches
 =ğ
cÚ¡ªts
::
max_w©ches_³r_u£r
) {

80 
·ge_id
 = 
wid
 + 1;

82 
	gŒue
) {

83 
	g·ge_id
 = 
ig
.
g’”©e_·ge_id
();

84 ià(
	gu£r_·ges
.
fšd
(
·ge_id
è=ğ
u£r_·ges
.
’d
()) {

90 
	gu£r_·ges
.
š£¹
(
·ge_id
);

92 autØ
	gns
 = 
ig
.
g’”©e_·ge_Çme¥aû
(
·ge_id
);

93 autØ
	gt™Ë
 = 
ig
.
g’”©e_·ge_t™Ë
(
·ge_id
);

94 
w©chli¡_key
 
wl_k
(
uid
, 
ns
, 
t™Ë
);

95 
w©chli¡_idx_key
 
wl_i_k
(
ns
, 
t™Ë
, 
uid
);

96 
w©chli¡_row
 
	gwl_r
;

97 
	gwl_r
.
	gwl_nÙifiÿtiÚtime¡amp
 = "null";

99 
	gdb
.
tbl_w©chli¡
().
nÚŒªs_put
(
wl_k
, 
wl_r
);

100 
	gdb
.
idx_w©chli¡
().
nÚŒªs_put
(
wl_i_k
, 
w©chli¡_idx_row
());

105 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

106 
	gwikedŸ_lßd”
<
	gDBP¬ams
>::
lßd_»visiÚ
() {

108 
pid
 = 1; 
	gpid
 <ğ
num_·ges
; ++pid) {

109 autØ
	gnum_»vs
 = 
ig
.
g’”©e_num_»visiÚs
();

110 autØ
	gŞd_‹xt
 = 
ig
.
g’”©e_¿ndom_Şd_‹xt
();

111 autØ
	gŞd_‹xt_Ën
 = 
Şd_‹xt
.
Ëngth
();

113 
	gi
 = 0; i < 
	gnum_»vs
; ++i) {

114 autØ
	gŒ_id
 = ()
db
.
tbl_»visiÚ
().
g’_key
();

115 autØ
	gtx_id
 = ()
db
.
tbl_‹xt
().
g’_key
();

116 
®ways_as£¹
(
tx_id
 =ğ
Œ_id
, "text_id‡nd„ev_id should behe same‡t†oadime");

118 autØ
	guid
 = 
ig
.
g’”©e_u£r_id
();

119 ++
	gu£r_»visiÚ_úts
[
uid
 - 1];

120 ià(
	gi
 > 0) {

121 
	gŞd_‹xt
 = 
ig
.
g’”©e_»v_‹xt
(
Şd_‹xt
);

122 
	gŞd_‹xt_Ën
 = 
Şd_‹xt
.
Ëngth
();

125 
‹xt_key
 
t_k
(
tx_id
);

126 
‹xt_row
 
	gt_r
;

127 
	gt_r
.
	gŞd_‹xt
 = 
Ãw
 [
Şd_‹xt_Ën
 + 1];

128 
memıy
(
t_r
.
Şd_‹xt
, old_‹xt.
c_¡r
(), 
Şd_‹xt_Ën
 + 1);

129 
	gt_r
.
	gŞd_æags
 = "utf-8";

130 
	gt_r
.
	gŞd_·ge
 = 
pid
;

131 
	gdb
.
tbl_‹xt
().
nÚŒªs_put
(
t_k
, 
t_r
);

133 
»visiÚ_key
 
r_k
(
Œ_id
);

134 
»visiÚ_row
 
	gr_r
;

135 
	gr_r
.
	g»v_·ge
 = 
pid
;

136 
	gr_r
.
	g»v_‹xt_id
 = 
Œ_id
;

137 
	gr_r
.
	g»v_comm’t
 = 
ig
.
g’”©e_»v_comm’t
();

138 
	gr_r
.
	g»v_u£r
 = 
uid
;

139 
	gr_r
.
	g»v_u£r_‹xt
 = "I‡m‡ good user";

140 
	gr_r
.
	g»v_time¡amp
 = 
ig
.
cu¼_time¡amp_¡ršg
();

141 
	gr_r
.
	g»v_mšÜ_ed™
 = 
ig
.
g’”©e_»v_mšÜ_ed™
();

142 
	gr_r
.
	g»v_d–‘ed
 = 0;

143 
	gr_r
.
	g»v_Ën
 = ()
Şd_‹xt_Ën
;

144 
	gr_r
.
	g»v_·»Á_id
 = 0;

146 
	gdb
.
tbl_»visiÚ
().
nÚŒªs_put
(
r_k
, 
r_r
);

148 
	g·ge_Ï¡_»v_ids
[
pid
 - 1] = 
Œ_id
;

149 
	g·ge_Ï¡_»v_Ëns
[
pid
 - 1] = 
Œ_id
;

	@benchmark/Wikipedia_selectors.hh

1 #´agm¨
Úû


3 
	~"Sto.hh
"

4 
	~"V”siÚS–eùÜ.hh
"

5 
	~"WikedŸ_¡ruùs.hh
"

7 
Çme¥aû
 
	gv”_£l
 {

9 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

10 
şass
 
	gV”S–
<
	gwikedŸ
::
·ge_row
, 
	gV”sIm¶
> : 
public
 
V”S–Ba£
<
V”S–
<
wikedŸ
::page_row, VersImpl>, VersImpl> {

11 
	gpublic
:

12 
V”sIm¶
 
	tv”siÚ_ty³
;

13 
cÚ¡ex´
 
size_t
 
	gnum_v”siÚs
 = 2;

15 
ex¶ic™
 
V”S–
(
ty³
 
v
è: 
v”s_
() {

16 
Ãw
 (&
v”s_
[0]è
v”siÚ_ty³
(
v
);

18 
V”S–
(
ty³
 
v
, 
boŞ
 
š£¹
è: 
v”s_
() {

19 
Ãw
 (&
v”s_
[0]è
v”siÚ_ty³
(
v
, 
š£¹
);

22 
m­_im¶
(
cŞ_n
) {

23 
	gwikedŸ
::
	t·ge_row
::
	tNamedCŞumn
 
	tnc
;

24 autØ
	gcŞ_Çme
 = 
¡©ic_ÿ¡
<
nc
>(
cŞ_n
);

25 ià(
	gcŞ_Çme
 =ğ
nc
::
·ge_Çme¥aû
 || 
cŞ_Çme
 =ğnc::
·ge_t™Ë


26 || 
cŞ_Çme
 =ğ
nc
::
·ge_»¡riùiÚs
 || cŞ_Çm=ğnc::
·ge_¿ndom
) {

32 
	gv”siÚ_ty³
& 
v”siÚ_©_im¶
(
ûÎ
) {

33  
	gv”s_
[
ûÎ
];

36 
š¡®l_by_ûÎ_im¶
(
wikedŸ
::
·ge_row
 *
d¡
, cÚ¡ wikedŸ::·ge_row *
¤c
, 
ûÎ
) {

37 
	gûÎ
) {

39 
d¡
->
·ge_couÁ”
 = 
¤c
->page_counter;

40 
	gd¡
->
	g·ge_is_»dœeù
 = 
¤c
->
·ge_is_»dœeù
;

41 
	gd¡
->
	g·ge_is_Ãw
 = 
¤c
->
·ge_is_Ãw
;

42 
	gd¡
->
	g·ge_touched
 = 
¤c
->
·ge_touched
;

43 
	gd¡
->
	g·ge_Ï‹¡
 = 
¤c
->
·ge_Ï‹¡
;

44 
	gd¡
->
	g·ge_Ën
 = 
¤c
->
·ge_Ën
;

47 
d¡
->
·ge_Çme¥aû
 = 
¤c
->page_namespace;

48 
	gd¡
->
	g·ge_t™Ë
 = 
¤c
->
·ge_t™Ë
;

49 
	gd¡
->
	g·ge_»¡riùiÚs
 = 
¤c
->
·ge_»¡riùiÚs
;

50 
	gd¡
->
	g·ge_¿ndom
 = 
¤c
->
·ge_¿ndom
;

53 
®ways_as£¹
(
çl£
, "cell id out of bound\n");

58 
	g´iv©e
:

59 
v”siÚ_ty³
 
v”s_
[
num_v”siÚs
];

62 
	g‹m¶©e
<
ty³Çme
 
	gV”sIm¶
>

63 
şass
 
	gV”S–
<
	gwikedŸ
::
u£¿cù_row
, 
	gV”sIm¶
> : 
public
 
V”S–Ba£
<
V”S–
<
wikedŸ
::useracct_row, VersImpl>, VersImpl> {

64 
	gpublic
:

65 
V”sIm¶
 
	tv”siÚ_ty³
;

66 
cÚ¡ex´
 
size_t
 
	gnum_v”siÚs
 = 2;

68 
ex¶ic™
 
V”S–
(
ty³
 
v
è: 
v”s_
() {

69 
Ãw
 (&
v”s_
[0]è
v”siÚ_ty³
(
v
);

72 
V”S–
(
ty³
 
v
, 
boŞ
 
š£¹
è: 
v”s_
() {

73 
Ãw
 (&
v”s_
[0]è
v”siÚ_ty³
(
v
, 
š£¹
);

76 
m­_im¶
(
cŞ_n
) {

77 
	gwikedŸ
::
	tu£¿cù_row
::
	tNamedCŞumn
 
	tnc
;

78 autØ
	gcŞ_Çme
 = 
¡©ic_ÿ¡
<
nc
>(
cŞ_n
);

79 ià(
	gcŞ_Çme
 =ğ
nc
::
u£r_touched
 || 
cŞ_Çme
 =ğnc::
u£r_ed™couÁ
)

85 
	gv”siÚ_ty³
 &
v”siÚ_©_im¶
(
ûÎ
) {

86  
	gv”s_
[
ûÎ
];

89 
š¡®l_by_ûÎ_im¶
(
wikedŸ
::
u£¿cù_row
 *
d¡
, cÚ¡ wikedŸ::u£¿cù_row *
¤c
, 
ûÎ
) {

90 
	gûÎ
) {

92 
d¡
->
u£r_touched
 = 
¤c
->user_touched;

93 
	gd¡
->
	gu£r_ed™couÁ
 = 
¤c
->
u£r_ed™couÁ
;

96 
d¡
->
u£r_Çme
 = 
¤c
->user_name;

97 
	gd¡
->
	gu£r_»®_Çme
 = 
¤c
->
u£r_»®_Çme
;

98 
	gd¡
->
	gu£r_·sswÜd
 = 
¤c
->
u£r_·sswÜd
;

99 
	gd¡
->
	gu£r_Ãw·sswÜd
 = 
¤c
->
u£r_Ãw·sswÜd
;

100 
	gd¡
->
	gu£r_Ãw·ss_time
 = 
¤c
->
u£r_Ãw·ss_time
;

101 
	gd¡
->
	gu£r_ema
 = 
¤c
->
u£r_ema
;

102 
	gd¡
->
	gu£r_İtiÚs
 = 
¤c
->
u£r_İtiÚs
;

103 
	gd¡
->
	gu£r_tok’
 = 
¤c
->
u£r_tok’
;

104 
	gd¡
->
	gu£r_ema_auth’tiÿ‹d
 = 
¤c
->
u£r_ema_auth’tiÿ‹d
;

105 
	gd¡
->
	gu£r_ema_tok’
 = 
¤c
->
u£r_ema_tok’
;

106 
	gd¡
->
	gu£r_ema_tok’_expœes
 = 
¤c
->
u£r_ema_tok’_expœes
;

107 
	gd¡
->
	gu£r_»gi¡¿tiÚ
 = 
¤c
->
u£r_»gi¡¿tiÚ
;

110 
®ways_as£¹
(
çl£
, "cell id out of bound\n");

115 
	g´iv©e
:

116 
v”siÚ_ty³
 
v”s_
[
num_v”siÚs
];

	@benchmark/Wikipedia_structs.hh

1 #´agm¨
Úû


3 
	~<¡ršg
>

4 
	~<ÿs£¹
>

5 
	~"DB_¡ruùs.hh
"

6 
	~"¡r.hh
"

8 
Çme¥aû
 
	gwikedŸ
 {

10 
usšg
 
Çme¥aû
 
	gb’ch
;

14 
__©Œibu‹__
((
·cked
)è
	gblocks_key_b¬e
 {

15 
št32_t
 
	gb_id
;

16 
ex¶ic™
 
blocks_key_b¬e
(
št32_t
 
p_b_id
)

17 : 
b_id
(
bsw­
(
p_b_id
)) {}

19 
ä›nd
 
mas¡»e_key_ad­‹r
<
blocks_key_b¬e
>;

20 
	g´iv©e
:

21 
blocks_key_b¬e
() = ;

24 
	gmas¡»e_key_ad­‹r
<
	tblocks_key_b¬e
> 
	tblocks_key
;

26 
	sblocks_row
 {

27 şas 
	cNamedCŞumn
 : { 
b_add»ss
 = 0,

28 
	gb_u£r
,

29 
	gb_by
,

30 
	gb_by_‹xt
,

31 
	gb_»asÚ
,

32 
	gb_time¡amp
,

33 
	gb_auto
,

34 
	gb_ªÚ_Úly
,

35 
	gb_ü—‹_accouÁ
,

36 
	gb_’abË_autoblock
,

37 
	gb_expœy
,

38 
	gb_¿nge_¡¬t
,

39 
	gb_¿nge_’d
,

40 
	gb_d–‘ed
,

41 
	gb_block_ema
,

42 
	gb_®low_u£¹®k
 };

44 
	gv¬_¡ršg
<255> 
	gb_add»ss
;

45 
št32_t
 
	gb_u£r
;

46 
št32_t
 
	gb_by
;

47 
	gv¬_¡ršg
<255> 
	gb_by_‹xt
;

48 
	gv¬_¡ršg
<255> 
	gb_»asÚ
;

49 
	gv¬_¡ršg
<14> 
	gb_time¡amp
;

50 
št32_t
 
	gb_auto
;

51 
št32_t
 
	gb_ªÚ_Úly
;

52 
št32_t
 
	gb_ü—‹_accouÁ
;

53 
št32_t
 
	gb_’abË_autoblock
;

54 
	gv¬_¡ršg
<14> 
	gb_expœy
;

55 
	gv¬_¡ršg
<8> 
	gb_¿nge_¡¬t
;

56 
	gv¬_¡ršg
<8> 
	gb_¿nge_’d
;

57 
št32_t
 
	gb_d–‘ed
;

58 
št32_t
 
	gb_block_ema
;

59 
št32_t
 
	gb_®low_u£¹®k
;

62 
__©Œibu‹__
((
·cked
)è
	gblocks_addr_idx_key_b¬e
 {

63 
	gv¬_¡ršg
<255> 
	gb_add»ss
;

64 
št32_t
 
	gb_u£r
;

65 
št32_t
 
	gb_auto
;

66 
št32_t
 
	gb_ªÚ_Úly
;

67 
št32_t
 
	gb_id
;

69 
ex¶ic™
 
blocks_addr_idx_key_b¬e
(cÚ¡ 
¡d
::
¡ršg
& 
p_b_add»ss
,

70 
št32_t
 
p_b_u£r
,

71 
št32_t
 
p_b_auto
,

72 
št32_t
 
p_b_ªÚ_Úly
,

73 
št32_t
 
p_b_id
)

74 : 
b_add»ss
(
p_b_add»ss
), 
b_u£r
(
bsw­
(
p_b_u£r
)),

75 
b_auto
(
bsw­
(
p_b_auto
)), 
b_ªÚ_Úly
(bsw­(
p_b_ªÚ_Úly
)), 
b_id
(
p_b_id
) {}

77 
ä›nd
 
	gmas¡»e_key_ad­‹r
<
	gblocks_addr_idx_key_b¬e
>;

78 
	g´iv©e
:

79 
blocks_addr_idx_key_b¬e
() = ;

82 
	gmas¡»e_key_ad­‹r
<
	tblocks_addr_idx_key_b¬e
> 
	tblocks_addr_idx_key
;

84 
usšg
 
	gblocks_addr_idx_row
 = 
dummy_row
;

86 
__©Œibu‹__
((
·cked
)è
	gblocks_u£r_idx_key_b¬e
 {

87 
št32_t
 
	gb_u£r
;

88 
	gv¬_¡ršg
<255> 
	gb_add»ss
;

89 
št32_t
 
	gb_auto
;

90 
št32_t
 
	gb_ªÚ_Úly
;

91 
št32_t
 
	gb_id
;

93 
ex¶ic™
 
blocks_u£r_idx_key_b¬e
(
št32_t
 
p_b_u£r
,

94 cÚ¡ 
¡d
::
¡ršg
& 
p_b_add»ss
,

95 
št32_t
 
p_b_auto
,

96 
št32_t
 
p_b_ªÚ_Úly
,

97 
št32_t
 
p_b_id
)

98 : 
b_u£r
(
bsw­
(
p_b_u£r
)), 
b_add»ss
(
p_b_add»ss
),

99 
b_auto
(
bsw­
(
p_b_auto
)), 
b_ªÚ_Úly
(bsw­(
p_b_ªÚ_Úly
)), 
b_id
(
p_b_id
) {}

101 
ä›nd
 
	gmas¡»e_key_ad­‹r
<
	gblocks_u£r_idx_key_b¬e
>;

102 
	g´iv©e
:

103 
blocks_u£r_idx_key_b¬e
() = ;

106 
	gmas¡»e_key_ad­‹r
<
	tblocks_u£r_idx_key_b¬e
> 
	tblocks_u£r_idx_key
;

108 
usšg
 
	gblocks_u£r_idx_row
 = 
dummy_row
;

112 
__©Œibu‹__
((
·cked
)è
	gloggšg_key_b¬e
 {

113 
št32_t
 
	glog_id
;

114 
ex¶ic™
 
loggšg_key_b¬e
(
št32_t
 
p_log_id
)

115 : 
log_id
(
bsw­
(
p_log_id
)) {}

118 
	gmas¡»e_key_ad­‹r
<
	tloggšg_key_b¬e
> 
	tloggšg_key
;

120 
	sloggšg_row
 {

121 şas 
	cNamedCŞumn
 : { 
log_ty³
 = 0,

122 
	glog_aùiÚ
,

123 
	glog_time¡amp
,

124 
	glog_u£r
,

125 
	glog_Çme¥aû
,

126 
	glog_t™Ë
,

127 
	glog_comm’t
,

128 
	glog_·¿ms
,

129 
	glog_d–‘ed
,

130 
	glog_u£r_‹xt
,

131 
	glog_·ge
 };

133 
	gv¬_¡ršg
<32> 
	glog_ty³
;

134 
	gv¬_¡ršg
<32> 
	glog_aùiÚ
;

135 
	gv¬_¡ršg
<14> 
	glog_time¡amp
;

136 
št32_t
 
	glog_u£r
;

137 
št32_t
 
	glog_Çme¥aû
;

138 
	gv¬_¡ršg
<255> 
	glog_t™Ë
;

139 
	gv¬_¡ršg
<255> 
	glog_comm’t
;

140 
	gv¬_¡ršg
<255> 
	glog_·¿ms
;

141 
št32_t
 
	glog_d–‘ed
;

142 
	gv¬_¡ršg
<255> 
	glog_u£r_‹xt
;

143 
št32_t
 
	glog_·ge
;

148 
__©Œibu‹__
((
·cked
)è
	g·ge_key_b¬e
 {

149 
št32_t
 
	g·ge_id
;

150 
ex¶ic™
 
·ge_key_b¬e
(
št32_t
 
p_·ge_id
)

151 : 
·ge_id
(
bsw­
(
p_·ge_id
)) {}

154 
	gmas¡»e_key_ad­‹r
<
	t·ge_key_b¬e
> 
	t·ge_key
;

156 
	s·ge_row
 {

157 şas 
	cNamedCŞumn
 : { 
·ge_Çme¥aû
 = 0,

158 
	g·ge_t™Ë
,

159 
	g·ge_»¡riùiÚs
,

160 
	g·ge_couÁ”
,

161 
	g·ge_is_»dœeù
,

162 
	g·ge_is_Ãw
,

163 
	g·ge_¿ndom
,

164 
	g·ge_touched
,

165 
	g·ge_Ï‹¡
,

166 
	g·ge_Ën
 };

168 
št32_t
 
	g·ge_Çme¥aû
;

169 
	gv¬_¡ršg
<255> 
	g·ge_t™Ë
;

170 
	gv¬_¡ršg
<255> 
	g·ge_»¡riùiÚs
;

171 
št64_t
 
	g·ge_couÁ”
;

172 
št32_t
 
	g·ge_is_»dœeù
;

173 
št32_t
 
	g·ge_is_Ãw
;

174 
	g·ge_¿ndom
;

175 
	gv¬_¡ršg
<14> 
	g·ge_touched
;

176 
št32_t
 
	g·ge_Ï‹¡
;

177 
št32_t
 
	g·ge_Ën
;

180 
__©Œibu‹__
((
·cked
)è
	g·ge_idx_key_b¬e
 {

181 
št32_t
 
	g·ge_Çme¥aû
;

182 
	gv¬_¡ršg
<255> 
	g·ge_t™Ë
;

184 
ex¶ic™
 
·ge_idx_key_b¬e
(
št32_t
 
p_·ge_Çme¥aû
,

185 cÚ¡ 
¡d
::
¡ršg
& 
p_·ge_t™Ë
)

186 : 
·ge_Çme¥aû
(
bsw­
(
p_·ge_Çme¥aû
)), 
·ge_t™Ë
(
p_·ge_t™Ë
) {}

188 
ä›nd
 
	gmas¡»e_key_ad­‹r
<
	g·ge_idx_key_b¬e
>;

189 
	g´iv©e
:

190 
·ge_idx_key_b¬e
() = ;

193 
	gmas¡»e_key_ad­‹r
<
	t·ge_idx_key_b¬e
> 
	t·ge_idx_key
;

195 
	s·ge_idx_row
 {

196 şas 
	cNamedCŞumn
 : { 
·ge_id
 = 0 };

197 
št32_t
 
	g·ge_id
;

202 
__©Œibu‹__
((
·cked
)è
	g·ge_»¡riùiÚs_key_b¬e
 {

203 
št32_t
 
	g´_id
;

204 
ex¶ic™
 
·ge_»¡riùiÚs_key_b¬e
(
št32_t
 
p_´_id
)

205 : 
´_id
(
bsw­
(
p_´_id
)) {}

208 
	gmas¡»e_key_ad­‹r
<
	t·ge_»¡riùiÚs_key_b¬e
> 
	t·ge_»¡riùiÚs_key
;

210 
	s·ge_»¡riùiÚs_row
 {

211 şas 
	cNamedCŞumn
 : { 
´_·ge
 = 0,

212 
	g´_ty³
,

213 
	g´_Ëv–
,

214 
	g´_ÿsÿde
,

215 
	g´_u£r
,

216 
	g´_expœy
 };

217 
št32_t
 
	g´_·ge
;

218 
	gv¬_¡ršg
<60> 
	g´_ty³
;

219 
	gv¬_¡ršg
<60> 
	g´_Ëv–
;

220 
št32_t
 
	g´_ÿsÿde
;

221 
št32_t
 
	g´_u£r
;

222 
	gv¬_¡ršg
<14> 
	g´_expœy
;

225 
__©Œibu‹__
((
·cked
)è
	g·ge_»¡riùiÚs_idx_key_b¬e
 {

226 
št32_t
 
	g´_·ge
;

227 
	gv¬_¡ršg
<60> 
	g´_ty³
;

228 
ex¶ic™
 
·ge_»¡riùiÚs_idx_key_b¬e
(
št32_t
 
p_´_·ge
,

229 cÚ¡ 
¡d
::
¡ršg
& 
p_´_ty³
)

230 : 
´_·ge
(
bsw­
(
p_´_·ge
)), 
´_ty³
(
p_´_ty³
) {}

232 
ä›nd
 
	gmas¡»e_key_ad­‹r
<
	g·ge_»¡riùiÚs_idx_key_b¬e
>;

233 
	g´iv©e
:

234 
·ge_»¡riùiÚs_idx_key_b¬e
() = ;

237 
	gmas¡»e_key_ad­‹r
<
	t·ge_»¡riùiÚs_idx_key_b¬e
> 
	t·ge_»¡riùiÚs_idx_key
;

239 
	s·ge_»¡riùiÚs_idx_row
 {

240 şas 
	cNamedCŞumn
 : { 
´_id
 = 0 };

241 
št32_t
 
	g´_id
;

246 
__©Œibu‹__
((
·cked
)è
	g»ûÁchªges_key_b¬e
 {

247 
št32_t
 
	grc_id
;

248 
ex¶ic™
 
»ûÁchªges_key_b¬e
(
št32_t
 
p_rc_id
)

249 : 
rc_id
(
bsw­
(
p_rc_id
)) {}

252 
	gmas¡»e_key_ad­‹r
<
	t»ûÁchªges_key_b¬e
> 
	t»ûÁchªges_key
;

254 
	s»ûÁchªges_row
 {

255 şas 
	cNamedCŞumn
 : { 
rc_time¡amp
 = 0,

256 
	grc_cur_time
,

257 
	grc_u£r
,

258 
	grc_u£r_‹xt
,

259 
	grc_Çme¥aû
,

260 
	grc_t™Ë
,

261 
	grc_comm’t
,

262 
	grc_mšÜ
,

263 
	grc_bÙ
,

264 
	grc_Ãw
,

265 
	grc_cur_id
,

266 
	grc_this_Şdid
,

267 
	grc_Ï¡_Şdid
,

268 
	grc_ty³
,

269 
	grc_moved_to_ns
,

270 
	grc_moved_to_t™Ë
,

271 
	grc_·ŒŞËd
,

272 
	grc_
,

273 
	grc_Şd_Ën
,

274 
	grc_Ãw_Ën
,

275 
	grc_d–‘ed
,

276 
	grc_logid
,

277 
	grc_log_ty³
,

278 
	grc_log_aùiÚ
,

279 
	grc_·¿ms
 };

281 
	gv¬_¡ršg
<14> 
	grc_time¡amp
;

282 
	gv¬_¡ršg
<14> 
	grc_cur_time
;

283 
št32_t
 
	grc_u£r
;

284 
	gv¬_¡ršg
<255> 
	grc_u£r_‹xt
;

285 
št32_t
 
	grc_Çme¥aû
;

286 
	gv¬_¡ršg
<255> 
	grc_t™Ë
;

287 
	gv¬_¡ršg
<255> 
	grc_comm’t
;

288 
št32_t
 
	grc_mšÜ
;

289 
št32_t
 
	grc_bÙ
;

290 
št32_t
 
	grc_Ãw
;

291 
št32_t
 
	grc_cur_id
;

292 
št32_t
 
	grc_this_Şdid
;

293 
št32_t
 
	grc_Ï¡_Şdid
;

294 
št32_t
 
	grc_ty³
;

295 
št32_t
 
	grc_moved_to_ns
;

296 
	gv¬_¡ršg
<255> 
	grc_moved_to_t™Ë
;

297 
št32_t
 
	grc_·ŒŞËd
;

298 
	gv¬_¡ršg
<40> 
	grc_
;

299 
št32_t
 
	grc_Şd_Ën
;

300 
št32_t
 
	grc_Ãw_Ën
;

301 
št32_t
 
	grc_d–‘ed
;

302 
št32_t
 
	grc_logid
;

303 
	gv¬_¡ršg
<255> 
	grc_log_ty³
;

304 
	gv¬_¡ršg
<255> 
	grc_log_aùiÚ
;

305 
	gv¬_¡ršg
<255> 
	grc_·¿ms
;

310 
__©Œibu‹__
((
·cked
)è
	g»visiÚ_key_b¬e
 {

311 
št32_t
 
	g»v_id
;

312 
ex¶ic™
 
»visiÚ_key_b¬e
(
št32_t
 
p_»v_id
)

313 : 
»v_id
(
bsw­
(
p_»v_id
)) {}

316 
	gmas¡»e_key_ad­‹r
<
	t»visiÚ_key_b¬e
> 
	t»visiÚ_key
;

318 
	s»visiÚ_row
 {

319 şas 
	cNamedCŞumn
 : { 
»v_·ge
 = 0,

320 
	g»v_‹xt_id
,

321 
	g»v_comm’t
,

322 
	g»v_u£r
,

323 
	g»v_u£r_‹xt
,

324 
	g»v_time¡amp
,

325 
	g»v_mšÜ_ed™
,

326 
	g»v_d–‘ed
,

327 
	g»v_Ën
,

328 
	g»v_·»Á_id
 };

330 
št32_t
 
	g»v_·ge
;

331 
št32_t
 
	g»v_‹xt_id
;

332 
	gv¬_¡ršg
<1024> 
	g»v_comm’t
;

333 
št32_t
 
	g»v_u£r
;

334 
	gv¬_¡ršg
<255> 
	g»v_u£r_‹xt
;

335 
	gv¬_¡ršg
<14> 
	g»v_time¡amp
;

336 
št32_t
 
	g»v_mšÜ_ed™
;

337 
št32_t
 
	g»v_d–‘ed
;

338 
št32_t
 
	g»v_Ën
;

339 
št32_t
 
	g»v_·»Á_id
;

344 
__©Œibu‹__
((
·cked
)è
	g‹xt_key_b¬e
 {

345 
št32_t
 
	gŞd_id
;

346 
ex¶ic™
 
‹xt_key_b¬e
(
št32_t
 
p_Şd_id
)

347 : 
Şd_id
(
bsw­
(
p_Şd_id
)) {}

350 
	gmas¡»e_key_ad­‹r
<
	t‹xt_key_b¬e
> 
	t‹xt_key
;

352 
	s‹xt_row
 {

353 şas 
	cNamedCŞumn
 : { 
Şd_‹xt
 = 0,

354 
	gŞd_æags
,

355 
	gŞd_·ge
 };

357 * 
	gŞd_‹xt
;

358 
	gv¬_¡ršg
<30> 
	gŞd_æags
;

359 
št32_t
 
	gŞd_·ge
;

364 
__©Œibu‹__
((
·cked
)è
	gu£¿cù_key_b¬e
 {

365 
št32_t
 
	gu£r_id
;

366 
ex¶ic™
 
u£¿cù_key_b¬e
(
št32_t
 
p_u£r_id
)

367 : 
u£r_id
(
bsw­
(
p_u£r_id
)) {}

370 
	gmas¡»e_key_ad­‹r
<
	tu£¿cù_key_b¬e
> 
	tu£¿cù_key
;

372 
	su£¿cù_row
 {

373 şas 
	cNamedCŞumn
 : { 
u£r_Çme
 = 0,

374 
	gu£r_»®_Çme
,

375 
	gu£r_·sswÜd
,

376 
	gu£r_Ãw·sswÜd
,

377 
	gu£r_Ãw·ss_time
,

378 
	gu£r_ema
,

379 
	gu£r_İtiÚs
,

380 
	gu£r_touched
,

381 
	gu£r_tok’
,

382 
	gu£r_ema_auth’tiÿ‹d
,

383 
	gu£r_ema_tok’
,

384 
	gu£r_ema_tok’_expœes
,

385 
	gu£r_»gi¡¿tiÚ
,

386 
	gu£r_ed™couÁ
 };

388 
	gv¬_¡ršg
<255> 
	gu£r_Çme
;

389 
	gv¬_¡ršg
<255> 
	gu£r_»®_Çme
;

390 
	gv¬_¡ršg
<32> 
	gu£r_·sswÜd
;

391 
	gv¬_¡ršg
<32> 
	gu£r_Ãw·sswÜd
;

392 
	gv¬_¡ršg
<14> 
	gu£r_Ãw·ss_time
;

393 
	gv¬_¡ršg
<40> 
	gu£r_ema
;

394 
	gv¬_¡ršg
<255> 
	gu£r_İtiÚs
;

395 
	gv¬_¡ršg
<14> 
	gu£r_touched
;

396 
	gv¬_¡ršg
<32> 
	gu£r_tok’
;

397 
	gv¬_¡ršg
<32> 
	gu£r_ema_auth’tiÿ‹d
;

398 
	gv¬_¡ršg
<32> 
	gu£r_ema_tok’
;

399 
	gv¬_¡ršg
<14> 
	gu£r_ema_tok’_expœes
;

400 
	gv¬_¡ršg
<14> 
	gu£r_»gi¡¿tiÚ
;

401 
št32_t
 
	gu£r_ed™couÁ
;

404 
__©Œibu‹__
((
·cked
)è
	gu£¿cù_idx_key_b¬e
 {

405 
	gv¬_¡ršg
<255> 
	gu£r_Çme
;

406 
ex¶ic™
 
u£¿cù_idx_key_b¬e
(cÚ¡ 
¡d
::
¡ršg
& 
p_u£r_Çme
)

407 : 
u£r_Çme
(
p_u£r_Çme
) {}

410 
	gmas¡»e_key_ad­‹r
<
	tu£¿cù_idx_key_b¬e
> 
	tu£¿cù_idx_key
;

412 
	su£¿cù_idx_row
 {

413 şas 
	cNamedCŞumn
 : { 
u£r_id
 = 0 };

414 
št32_t
 
	gu£r_id
;

419 
__©Œibu‹__
((
·cked
)è
	gu£r_groups_key_b¬e
 {

420 
št32_t
 
	gug_u£r
;

421 
ex¶ic™
 
u£r_groups_key_b¬e
(
št32_t
 
p_ug_u£r
)

422 : 
ug_u£r
(
bsw­
(
p_ug_u£r
)) {}

425 
	gmas¡»e_key_ad­‹r
<
	tu£r_groups_key_b¬e
> 
	tu£r_groups_key
;

427 
	su£r_groups_row
 {

428 şas 
	cNamedCŞumn
 : { 
ug_group
 = 0 };

429 
	gv¬_¡ršg
<16> 
	gug_group
;

434 
__©Œibu‹__
((
·cked
)è
	gw©chli¡_key_b¬e
 {

435 
št32_t
 
	gwl_u£r
;

436 
št32_t
 
	gwl_Çme¥aû
;

437 
	gv¬_¡ršg
<255> 
	gwl_t™Ë
;

438 
ex¶ic™
 
w©chli¡_key_b¬e
(
št32_t
 
p_wl_u£r
,

439 
št32_t
 
p_wl_Çme¥aû
,

440 cÚ¡ 
¡d
::
¡ršg
& 
p_wl_t™Ë
)

441 : 
wl_u£r
(
bsw­
(
p_wl_u£r
)), 
wl_Çme¥aû
(bsw­(
p_wl_Çme¥aû
)),

442 
wl_t™Ë
(
p_wl_t™Ë
) {}

445 
	gmas¡»e_key_ad­‹r
<
	tw©chli¡_key_b¬e
> 
	tw©chli¡_key
;

447 
	sw©chli¡_row
 {

448 şas 
	cNamedCŞumn
 : { 
wl_nÙifiÿtiÚtime¡amp
 = 0 };

450 
	gv¬_¡ršg
<14> 
	gwl_nÙifiÿtiÚtime¡amp
;

453 
__©Œibu‹__
((
·cked
)è
	gw©chli¡_idx_key_b¬e
 {

454 
št32_t
 
	gwl_Çme¥aû
;

455 
	gv¬_¡ršg
<255> 
	gwl_t™Ë
;

456 
št32_t
 
	gwl_u£r
;

457 
ex¶ic™
 
w©chli¡_idx_key_b¬e
(
št32_t
 
p_wl_Çme¥aû
,

458 cÚ¡ 
¡d
::
¡ršg
& 
p_wl_t™Ë
,

459 
št32_t
 
p_wl_u£r
)

460 : 
wl_Çme¥aû
(
bsw­
(
p_wl_Çme¥aû
)), 
wl_t™Ë
(
p_wl_t™Ë
),

461 
wl_u£r
(
bsw­
(
p_wl_u£r
)) {}

463 
ä›nd
 
	gmas¡»e_key_ad­‹r
<
	gw©chli¡_idx_key_b¬e
>;

464 
	g´iv©e
:

465 
w©chli¡_idx_key_b¬e
() = ;

468 
	gmas¡»e_key_ad­‹r
<
	tw©chli¡_idx_key_b¬e
> 
	tw©chli¡_idx_key
;

470 
usšg
 
	gw©chli¡_idx_row
 = 
dummy_row
;

474 
	s¬tişe_ty³
 {

475 
št32_t
 
	g‹xt_id
;

476 
št32_t
 
	g·ge_id
;

477 
št32_t
 
	g»v_id
;

478 
	g¡d
::
¡ršg
 
Şd_‹xt
;

479 
	g¡d
::
¡ršg
 
u£r_‹xt
;

	@benchmark/Wikipedia_txns.hh

1 #´agm¨
Úû


3 
	~"WikedŸ_b’ch.hh
"

5 
	#INTERACTIVE_TXN_START
 
Sto
::
	`¡¬t_Œª§ùiÚ
()

	)

7 
	#INTERACTIVE_TXN_COMMIT
 \

8 
	`®ways_as£¹
(
Sto
::
	`Œª§ùiÚ
()->
	`š_´og»ss
(), "transaction‚ot in…rogress"); \

9 ià(!
Sto
::
	`Œª§ùiÚ
()->
	`Œy_comm™
()) { \

10  
çl£
; \

11 }

	)

13 
	#TXN_CHECK
(
İ
) \

14 ià(!(
İ
)) { \

15 
Sto
::
	`Œª§ùiÚ
()->
	`s’t_abÜt
(); \

16  
çl£
; \

17 }

	)

19 
Çme¥aû
 
	gwikedŸ
 {

21 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

22 
size_t
 
	gwikedŸ_ruÂ”
<
	gDBP¬ams
>::
run_txn_addW©chLi¡
(
u£r_id
,

23 
Çme_¥aû
,

24 cÚ¡ 
¡d
::
¡ršg
& 
·ge_t™Ë
) {

25 
u£¿cù_row
::
	tNamedCŞumn
 
	tnc
;

26 
size_t
 
	gÃxecs
 = 0;

28 
	gTRANSACTION
 {

30 
boŞ
 
	gabÜt
, 
	g»suÉ
;

31 
ušŒ_t
 
	grow
;

32 cÚ¡ *
	gv®ue
;

34 ++
	gÃxecs
;

36 autØ
	gwv
 = 
Sto
::
tx_®loc
<
w©chli¡_row
>();

37 autØ
	gwiv
 = 
Sto
::
tx_®loc
<
w©chli¡_idx_row
>();

38 
bz”o
(
wv
, (
w©chli¡_row
));

39 
bz”o
(
wiv
, (
w©chli¡_idx_row
));

40 
	g¡d
::
t›
(
abÜt
, 
»suÉ
èğ
db
.
tbl_w©chli¡
().
š£¹_row
(
w©chli¡_key
(
u£r_id
, 
Çme_¥aû
, 
·ge_t™Ë
), 
wv
);

41 
TXN_DO
(
abÜt
);

43 
	g¡d
::
t›
(
abÜt
, 
»suÉ
èğ
db
.
idx_w©chli¡
().
š£¹_row
(
w©chli¡_idx_key
(
Çme_¥aû
, 
·ge_t™Ë
, 
u£r_id
), 
wiv
);

44 
TXN_DO
(
abÜt
);

46 ià(
	gÇme_¥aû
 == 0) {

47 
¡d
::
t›
(
abÜt
, std::
ignÜe
èğ
db
.
tbl_w©chli¡
().
š£¹_row
(
w©chli¡_key
(
u£r_id
, 1, 
·ge_t™Ë
), 
wv
);

48 
TXN_DO
(
abÜt
);

50 
	g¡d
::
t›
(
abÜt
, 
¡d
::
ignÜe
èğ
db
.
idx_w©chli¡
().
š£¹_row
(
w©chli¡_idx_key
(
Çme_¥aû
, 
·ge_t™Ë
, 
u£r_id
), 
wiv
);

51 
TXN_DO
(
abÜt
);

54 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
row
, 
v®ue
èğ
db
.
tbl_u£¿cù
().
£Ëù_row
(
u£¿cù_key
(
u£r_id
), {{
nc
::
u£r_touched
, 
Œue
}});

55 
TXN_DO
(
abÜt
);

56 
as£¹
(
»suÉ
);

57 autØ
	gÃw_uv
 = 
Sto
::
tx_®loc
(
»š‹½»t_ÿ¡
<cÚ¡ 
u£¿cù_row
 *>(
v®ue
));

58 
	gÃw_uv
->
	gu£r_touched
 = 
ig
.
cu¼_time¡amp_¡ršg
();

59 
	gdb
.
tbl_u£¿cù
().
upd©e_row
(
row
, 
Ãw_uv
);

61 } 
RETRY
(
Œue
);

63  (
	gÃxecs
 - 1);

66 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

67 
size_t
 
	gwikedŸ_ruÂ”
<
	gDBP¬ams
>::
run_txn_»moveW©chLi¡
(
u£r_id
,

68 
Çme_¥aû
,

69 cÚ¡ 
¡d
::
¡ršg
& 
·ge_t™Ë
) {

70 
u£¿cù_row
::
	tNamedCŞumn
 
	tnc
;

71 
size_t
 
	gÃxecs
 = 0;

73 
	gTRANSACTION
 {

75 
boŞ
 
	gabÜt
, 
	g»suÉ
;

76 
ušŒ_t
 
	grow
;

77 cÚ¡ *
	gv®ue
;

79 ++
	gÃxecs
;

81 
	g¡d
::
t›
(
abÜt
, 
»suÉ
èğ
db
.
tbl_w©chli¡
().
d–‘e_row
(
w©chli¡_key
(
u£r_id
, 
Çme_¥aû
, 
·ge_t™Ë
));

82 
TXN_DO
(
abÜt
);

85 
	g¡d
::
t›
(
abÜt
, 
»suÉ
èğ
db
.
idx_w©chli¡
().
d–‘e_row
(
w©chli¡_idx_key
(
Çme_¥aû
, 
·ge_t™Ë
, 
u£r_id
));

86 
TXN_DO
(
abÜt
);

89 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
row
, 
v®ue
èğ
db
.
tbl_u£¿cù
().
£Ëù_row
(
u£¿cù_key
(
u£r_id
), {{
nc
::
u£r_touched
, 
Œue
}});

90 
TXN_DO
(
abÜt
);

91 
as£¹
(
»suÉ
);

92 autØ
	gÃw_uv
 = 
Sto
::
tx_®loc
(
»š‹½»t_ÿ¡
<cÚ¡ 
u£¿cù_row
 *>(
v®ue
));

93 
	gÃw_uv
->
	gu£r_touched
 = 
ig
.
cu¼_time¡amp_¡ršg
();

94 
	gdb
.
tbl_u£¿cù
().
upd©e_row
(
row
, 
Ãw_uv
);

96 } 
RETRY
(
Œue
);

98  (
	gÃxecs
 - 1);

101 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

102 
	g¡d
::
·œ
<
size_t
, 
	g¬tişe_ty³
> 
	gwikedŸ_ruÂ”
<
	gDBP¬ams
>::
run_txn_g‘PageAnÚymous
(
boŞ
 
fÜ_£Ëù
,

103 cÚ¡ 
¡d
::
¡ršg
& 
u£r_
,

104 
Çme_¥aû
,

105 cÚ¡ 
¡d
::
¡ršg
& 
·ge_t™Ë
) {

106 
·ge_row
::
	tNamedCŞumn
 
	t·ge_nc
;

109 
	g»visiÚ_row
::
	tNamedCŞumn
 
	t»v_nc
;

110 
	g‹xt_row
::
	tNamedCŞumn
 
	t‹xt_nc
;

112 ()
	gfÜ_£Ëù
;

113 
size_t
 
	gÃxecs
 = 0;

114 
¬tişe_ty³
 
	g¬t
;

116 
	gTRANSACTION
 {

118 
boŞ
 
	gabÜt
, 
	g»suÉ
;

119 cÚ¡ *
	gv®ue
;

121 ++
	gÃxecs
;

123 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
¡d
::
ignÜe
, 
v®ue
èğ
db
.
idx_·ge
().
£Ëù_row
(
·ge_idx_key
(
Çme_¥aû
, 
·ge_t™Ë
), 
RowAcûss
::
Ob£rveV®ue
);

124 
TXN_DO
(
abÜt
);

125 
as£¹
(
»suÉ
);

126 autØ
	g·ge_id
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
·ge_idx_row
 *>(
v®ue
)->
·ge_id
;

128 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
¡d
::
ignÜe
, 
v®ue
èğ
db
.
tbl_·ge
().
£Ëù_row
(
·ge_key
(
·ge_id
),

129 {{
·ge_nc
::
·ge_t™Ë
, 
çl£
},

130 {
·ge_nc
::
·ge_Çme¥aû
, 
çl£
},

131 {
·ge_nc
::
·ge_Ï‹¡
, 
çl£
}});

132 
TXN_DO
(
abÜt
);

133 
as£¹
(
»suÉ
);

134 autØ
	g·ge_v
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
·ge_row
 *>(
v®ue
);

173 autØ
	g»v_id
 = 
·ge_v
->
·ge_Ï‹¡
;

174 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
¡d
::
ignÜe
, 
v®ue
èğ
db
.
tbl_»visiÚ
().
£Ëù_row
(
»visiÚ_key
(
»v_id
), {{
»v_nc
::
»v_‹xt_id
, 
çl£
}});

175 
TXN_DO
(
abÜt
);

176 
as£¹
(
»suÉ
);

177 autØ
	g»v_‹xt_id
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
»visiÚ_row
 *>(
v®ue
)->
»v_‹xt_id
;

179 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
¡d
::
ignÜe
, 
v®ue
èğ
db
.
tbl_‹xt
().
£Ëù_row
(
‹xt_key
(
»v_‹xt_id
), {{
‹xt_nc
::
Şd_‹xt
, 
çl£
}, {‹xt_nc::
Şd_æags
, false}});

180 
TXN_DO
(
abÜt
);

181 
as£¹
(
»suÉ
);

183 
	g¬t
.
	g‹xt_id
 = 
»v_‹xt_id
;

184 
	g¬t
.
	g·ge_id
 = 
·ge_id
;

185 
	g¬t
.
	g»v_id
 = 
»v_id
;

186 
	g¬t
.
	gŞd_‹xt
 = 
¡d
::
¡ršg
(
»š‹½»t_ÿ¡
<cÚ¡ 
‹xt_row
 *>(
v®ue
)->
Şd_‹xt
);

187 
	g¬t
.
	gu£r_‹xt
 = 
u£r_
;

189 } 
RETRY
(
Œue
);

191  {
	gÃxecs
 - 1, 
	g¬t
};

194 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

195 
	g¡d
::
·œ
<
size_t
, 
	g¬tişe_ty³
> 
	gwikedŸ_ruÂ”
<
	gDBP¬ams
>::
run_txn_g‘PageAuth’tiÿ‹d
(
boŞ
 
fÜ_£Ëù
,

196 cÚ¡ 
¡d
::
¡ršg
& 
u£r_
,

197 
u£r_id
,

198 
Çme_¥aû
,

199 cÚ¡ 
¡d
::
¡ršg
& 
·ge_t™Ë
) {

200 
u£¿cù_row
::
	tNamedCŞumn
 
	tu£r_nc
;

201 
	g·ge_row
::
	tNamedCŞumn
 
	t·ge_nc
;

204 
	g»visiÚ_row
::
	tNamedCŞumn
 
	t»v_nc
;

205 
	g‹xt_row
::
	tNamedCŞumn
 
	t‹xt_nc
;

207 ()
	gfÜ_£Ëù
;

208 
size_t
 
	gÃxecs
 = 0;

209 
¬tişe_ty³
 
	g¬t
;

211 
	gTRANSACTION
 {

213 
boŞ
 
	gabÜt
, 
	g»suÉ
;

214 cÚ¡ *
	gv®ue
;

216 ++
	gÃxecs
;

218 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
¡d
::
ignÜe
, std::ignÜeèğ
db
.
tbl_u£¿cù
().
£Ëù_row
(
u£¿cù_key
(
u£r_id
), {{
u£r_nc
::
u£r_Çme
, 
çl£
}});

219 
TXN_DO
(
abÜt
);

220 
as£¹
(
»suÉ
);

228 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
¡d
::
ignÜe
, 
v®ue
èğ
db
.
idx_·ge
().
£Ëù_row
(
·ge_idx_key
(
Çme_¥aû
, 
·ge_t™Ë
), 
RowAcûss
::
Ob£rveV®ue
);

229 
TXN_DO
(
abÜt
);

230 
as£¹
(
»suÉ
);

231 autØ
	g·ge_id
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
·ge_idx_row
 *>(
v®ue
)->
·ge_id
;

233 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
¡d
::
ignÜe
, 
v®ue
èğ
db
.
tbl_·ge
().
£Ëù_row
(
·ge_key
(
·ge_id
), {{
·ge_nc
::
·ge_Ï‹¡
, 
çl£
}});

234 
TXN_DO
(
abÜt
);

235 
as£¹
(
»suÉ
);

236 autØ
	g·ge_v
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
·ge_row
 *>(
v®ue
);

275 autØ
	g»v_id
 = 
·ge_v
->
·ge_Ï‹¡
;

276 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
¡d
::
ignÜe
, 
v®ue
èğ
db
.
tbl_»visiÚ
().
£Ëù_row
(
»visiÚ_key
(
»v_id
), {{
»v_nc
::
»v_‹xt_id
, 
çl£
}});

277 
TXN_DO
(
abÜt
);

278 
as£¹
(
»suÉ
);

279 autØ
	g»v_‹xt_id
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
»visiÚ_row
 *>(
v®ue
)->
»v_‹xt_id
;

281 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
¡d
::
ignÜe
, 
v®ue
èğ
db
.
tbl_‹xt
().
£Ëù_row
(
‹xt_key
(
»v_‹xt_id
), {{
‹xt_nc
::
Şd_‹xt
, 
çl£
}, {‹xt_nc::
Şd_æags
, false}});

282 
TXN_DO
(
abÜt
);

283 
as£¹
(
»suÉ
);

285 
	g¬t
.
	g‹xt_id
 = 
»v_‹xt_id
;

286 
	g¬t
.
	g·ge_id
 = 
·ge_id
;

287 
	g¬t
.
	g»v_id
 = 
»v_id
;

288 
	g¬t
.
	gŞd_‹xt
 = 
¡d
::
¡ršg
(
»š‹½»t_ÿ¡
<cÚ¡ 
‹xt_row
 *>(
v®ue
)->
Şd_‹xt
);

289 
	g¬t
.
	gu£r_‹xt
 = 
u£r_
;

291 } 
RETRY
(
Œue
);

293  {
	gÃxecs
 - 1, 
	g¬t
};

296 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

297 
size_t
 
	gwikedŸ_ruÂ”
<
	gDBP¬ams
>::
run_txn_li¡PageNameS·û
(
Çme_¥aû
) {

298 
·ge_row
::
	tNamedCŞumn
 
	t·ge_nc
;

299 
size_t
 
	gÃxecs
 = 0;

301 
	gTRANSACTION
 {

303 
boŞ
 
	gabÜt
, 
	g»suÉ
;

304 cÚ¡ *
	gv®ue
;

306 ++
	gÃxecs
;

308 
	g¡d
::
veùÜ
<
¡d
::
·œ
<, std::
¡ršg
>> 
·ges
;

310 autØ
	gsÿn_ÿÎback
 = [&](cÚ¡ 
·ge_idx_key
& 
key
, cÚ¡ 
	g·ge_idx_row
& 
	grow
) {

311 
	g·ges
.
push_back
({
row
.
·ge_id
, 
¡d
::
¡ršg
(
key
.
·ge_t™Ë
.
c_¡r
())});

312  
	gŒue
;

315 
·ge_idx_key
 
pk0
(
Çme_¥aû
, 
¡d
::
¡ršg
());

316 
·ge_idx_key
 
pk1
(
Çme_¥aû
, 
¡d
::
¡ršg
(255, ()0xff));

317 
	gabÜt
 = 
db
.
idx_·ge
().
‹m¶©e
 
¿nge_sÿn
<
deşty³
(
sÿn_ÿÎback
), 
	gçl£
>(
	gpk0
, 
	gpk1
, 
	gsÿn_ÿÎback
, 
	gRowAcûss
::
Ob£rveV®ue
, false, 500 );

318 
TXN_DO
(
abÜt
);

320 autØ
	g·œ
 : 
·ges
) {

321 
¡d
::
t›
(
abÜt
, 
»suÉ
, std::
ignÜe
, 
v®ue
)

322 ğ
db
.
tbl_·ge
().
£Ëù_row
(
·ge_key
(
·œ
.
fœ¡
), {{
·ge_nc
::
·ge_t™Ë
, 
çl£
}});

323 
TXN_DO
(
abÜt
);

324 
as£¹
(
»suÉ
);

325 autØ
	g´
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
·ge_row
 *>(
v®ue
);

326 
®ways_as£¹
(
·œ
.
£cÚd
 =ğ
¡d
::
¡ršg
(
´
->
·ge_t™Ë
.
c_¡r
()));

329 } 
RETRY
(
Œue
);

331  (
	gÃxecs
 - 1);

334 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

335 
boŞ
 
	gwikedŸ_ruÂ”
<
	gDBP¬ams
>::
txn_upd©ePage_šÃr
(
‹xt_id
,

336 
·ge_id
,

337 cÚ¡ 
¡d
::
¡ršg
& 
·ge_t™Ë
,

338 cÚ¡ 
¡d
::
¡ršg
& 
·ge_‹xt
,

339 
·ge_Çme_¥aû
,

340 
u£r_id
,

341 cÚ¡ 
¡d
::
¡ršg
& 
u£r_
,

342 cÚ¡ 
¡d
::
¡ršg
& 
u£r_‹xt
,

343 
»v_id
,

344 cÚ¡ 
¡d
::
¡ršg
& 
»v_comm’t
,

345 
»v_mšÜ_ed™
,

346 
size_t
& 
n¡¬ts
) {

347 
	g·ge_row
::
	tNamedCŞumn
 
	t·ge_nc
;

348 
	gu£¿cù_row
::
	tNamedCŞumn
 
	tu£r_nc
;

350 
	gINTERACTIVE_TXN_START
;

352 
boŞ
 
	gabÜt
, 
	g»suÉ
;

353 
ušŒ_t
 
	grow
;

354 cÚ¡ *
	gv®ue
;

356 ++
	gn¡¬ts
;

358 autØ
	gtime¡amp_¡r
 = 
ig
.
cu¼_time¡amp_¡ršg
();

361 
‹xt_key
 
Ãw_‹xt_k
((
št32_t
)(
db
.
tbl_‹xt
().
g’_key
()));

363 autØ
	g‹xt_v
 = 
Sto
::
tx_®loc
<
‹xt_row
>();

364 
	g‹xt_v
->
	gŞd_·ge
 = 
·ge_id
;

365 
	g‹xt_v
->
	gŞd_æags
 = 
¡d
::
¡ršg
("utf-8");

366 
	g‹xt_v
->
	gŞd_‹xt
 = 
Ãw
 [
·ge_‹xt
.
Ëngth
() + 1];

367 
memıy
(
‹xt_v
->
Şd_‹xt
, 
·ge_‹xt
.
c_¡r
(),…age_‹xt.
Ëngth
() + 1);

369 
	g¡d
::
t›
(
abÜt
,
»suÉ
èğ
db
.
tbl_‹xt
().
š£¹_row
(
Ãw_‹xt_k
, 
‹xt_v
);

370 
TXN_CHECK
(
abÜt
);

371 
as£¹
(!
»suÉ
);

374 
»visiÚ_key
 
Ãw_»v_k
((
št32_t
)(
db
.
tbl_»visiÚ
().
g’_key
()));

376 autØ
	g»v_v
 = 
Sto
::
tx_®loc
<
»visiÚ_row
>();

377 
	g»v_v
->
	g»v_·ge
 = 
·ge_id
;

378 
	g»v_v
->
	g»v_‹xt_id
 = 
bsw­
(
Ãw_‹xt_k
.
Şd_id
);

379 
	g»v_v
->
	g»v_comm’t
 = 
»v_comm’t
;

380 
	g»v_v
->
	g»v_mšÜ_ed™
 = 
»v_mšÜ_ed™
;

381 
	g»v_v
->
	g»v_u£r
 = 
u£r_id
;

382 
	g»v_v
->
	g»v_u£r_‹xt
 = 
u£r_‹xt
;

383 
	g»v_v
->
	g»v_time¡amp
 = 
time¡amp_¡r
;

384 
	g»v_v
->
	g»v_d–‘ed
 = 0;

385 
	g»v_v
->
	g»v_Ën
 = (
št32_t
)
·ge_‹xt
.
Ëngth
();

386 
	g»v_v
->
	g»v_·»Á_id
 = 
»v_id
;

388 
	g¡d
::
t›
(
abÜt
, 
»suÉ
èğ
db
.
tbl_»visiÚ
().
š£¹_row
(
Ãw_»v_k
, 
»v_v
);

389 
TXN_CHECK
(
abÜt
);

390 
as£¹
(!
»suÉ
);

393 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
row
, 
v®ue
) =

394 
db
.
tbl_·ge
().
£Ëù_row
(
·ge_key
(
·ge_id
),

395 {{
·ge_nc
::
·ge_Ï‹¡
, 
Œue
},

396 {
·ge_nc
::
·ge_touched
, 
Œue
},

397 {
·ge_nc
::
·ge_is_Ãw
, 
Œue
},

398 {
·ge_nc
::
·ge_is_»dœeù
, 
Œue
},

399 {
·ge_nc
::
·ge_Ën
, 
Œue
}});

400 
TXN_CHECK
(
abÜt
);

401 
as£¹
(
»suÉ
);

403 autØ
	gÃw_pv
 = 
Sto
::
tx_®loc
(
»š‹½»t_ÿ¡
<cÚ¡ 
·ge_row
 *>(
v®ue
));

404 
	gÃw_pv
->
	g·ge_Ï‹¡
 = 
bsw­
(
Ãw_»v_k
.
»v_id
);

405 
	gÃw_pv
->
	g·ge_touched
 = 
time¡amp_¡r
;

406 
	gÃw_pv
->
	g·ge_is_Ãw
 = 0;

407 
	gÃw_pv
->
	g·ge_is_»dœeù
 = 0;

408 
	gÃw_pv
->
	g·ge_Ën
 = (
št32_t
)
·ge_‹xt
.
Ëngth
();

410 
	gdb
.
tbl_·ge
().
upd©e_row
(
row
, 
Ãw_pv
);

413 
»ûÁchªges_key
 
rc_k
((
št32_t
)(
db
.
tbl_»ûÁchªges
().
g’_key
()));

415 autØ
	grc_v
 = 
Sto
::
tx_®loc
<
»ûÁchªges_row
>();

416 
bz”o
(
rc_v
, (
»ûÁchªges_row
));

417 
	grc_v
->
	grc_time¡amp
 = 
time¡amp_¡r
;

418 
	grc_v
->
	grc_cur_time
 = 
time¡amp_¡r
;

419 
	grc_v
->
	grc_Çme¥aû
 = 
·ge_Çme_¥aû
;

420 
	grc_v
->
	grc_t™Ë
 = 
·ge_t™Ë
;

421 
	grc_v
->
	grc_ty³
 = 0;

422 
	grc_v
->
	grc_mšÜ
 = 0;

423 
	grc_v
->
	grc_cur_id
 = 
·ge_id
;

424 
	grc_v
->
	grc_u£r
 = 
u£r_id
;

425 
	grc_v
->
	grc_u£r_‹xt
 = 
u£r_‹xt
;

426 
	grc_v
->
	grc_comm’t
 = 
»v_comm’t
;

427 
	grc_v
->
	grc_this_Şdid
 = 
bsw­
(
Ãw_‹xt_k
.
Şd_id
);

428 
	grc_v
->
	grc_Ï¡_Şdid
 = 
‹xt_id
;

429 
	grc_v
->
	grc_bÙ
 = 0;

430 
	grc_v
->
	grc_moved_to_ns
 = 0;

431 
	grc_v
->
	grc_moved_to_t™Ë
 = 
¡d
::
¡ršg
();

432 
	grc_v
->
	grc_
 = 
u£r_
;

433 
	grc_v
->
	grc_Şd_Ën
 = (
št32_t
)
·ge_‹xt
.
Ëngth
();

434 
	grc_v
->
	grc_Ãw_Ën
 = (
št32_t
)
·ge_‹xt
.
Ëngth
();

436 
	g¡d
::
t›
(
abÜt
, 
»suÉ
èğ
db
.
tbl_»ûÁchªges
().
š£¹_row
(
rc_k
, 
rc_v
);

437 
TXN_CHECK
(
abÜt
);

438 
as£¹
(!
»suÉ
);

441 
w©chli¡_idx_key
 
k0
(
·ge_Çme_¥aû
, 
·ge_t™Ë
, 0);

442 
w©chli¡_idx_key
 
k1
(
·ge_Çme_¥aû
, 
·ge_t™Ë
, 
¡d
::
num”ic_lim™s
<
št32_t
>::
max
());

444 
	g¡d
::
veùÜ
<
št32_t
> 
w©chšg_u£rs
;

445 autØ
	gsÿn_cb
 = [&](cÚ¡ 
w©chli¡_idx_key
& 
key
, cÚ¡ 
	gw©chli¡_idx_row
&) {

446 
	gw©chšg_u£rs
.
push_back
(
bsw­
(
key
.
wl_u£r
));

447  
	gŒue
;

450 
	gabÜt
 = 
db
.
idx_w©chli¡
().
‹m¶©e
 
¿nge_sÿn
<
deşty³
(
sÿn_cb
), 
	gçl£
>(
	gk0
, 
	gk1
, 
	gsÿn_cb
, 
	gRowAcûss
::
NÚe
, false );

451 
TXN_CHECK
(
abÜt
);

453 ià(!
	gw©chšg_u£rs
.
em±y
()) {

455 
	gINTERACTIVE_TXN_COMMIT
;

457 
	gTRANSACTION
 {

459 ++
	gn¡¬ts
;

461 auto& 
	gu
 : 
w©chšg_u£rs
) {

462 
¡d
::
t›
(
abÜt
, 
»suÉ
, 
row
, 
v®ue
èğ
db
.
tbl_w©chli¡
().
£Ëù_row
(
w©chli¡_key
(
u
, 
·ge_Çme_¥aû
, 
·ge_t™Ë
), 
RowAcûss
::
Upd©eV®ue
);

463 
TXN_DO
(
abÜt
);

465 ià(
	g»suÉ
) {

466 autØ
	gÃw_wlv
 = 
Sto
::
tx_®loc
(
»š‹½»t_ÿ¡
<cÚ¡ 
w©chli¡_row
 *>(
v®ue
));

467 
	gÃw_wlv
->
	gwl_nÙifiÿtiÚtime¡amp
 = 
time¡amp_¡r
;

468 
	gdb
.
tbl_w©chli¡
().
upd©e_row
(
row
, 
Ãw_wlv
);

472 } 
RETRY
(
Œue
);

474 
	gTRANSACTION
 {

476 ++
	gn¡¬ts
;

479 
loggšg_key
 
lg_k
(
db
.
tbl_loggšg
().
g’_key
());

481 autØ
	glg_v
 = 
Sto
::
tx_®loc
<
loggšg_row
>();

482 
	glg_v
->
	glog_ty³
 = 
¡d
::
¡ršg
("patrol");

483 
	glg_v
->
	glog_aùiÚ
 = 
¡d
::
¡ršg
("patrol");

484 
	glg_v
->
	glog_time¡amp
 = 
time¡amp_¡r
;

485 
	glg_v
->
	glog_u£r
 = 
u£r_id
;

486 
	glg_v
->
	glog_Çme¥aû
 = 
·ge_Çme_¥aû
;

487 
	glg_v
->
	glog_t™Ë
 = 
·ge_t™Ë
;

488 
	glg_v
->
	glog_comm’t
 = 
»v_comm’t
;

489 
	glg_v
->
	glog_·¿ms
 = 
¡d
::
¡ršg
();

490 
	glg_v
->
	glog_d–‘ed
 = 0;

491 
	glg_v
->
	glog_u£r_‹xt
 = 
u£r_‹xt
;

492 
	glg_v
->
	glog_·ge
 = 
·ge_id
;

494 
	g¡d
::
t›
(
abÜt
, 
»suÉ
èğ
db
.
tbl_loggšg
().
š£¹_row
(
lg_k
, 
lg_v
);

495 
TXN_DO
(
abÜt
);

496 
as£¹
(!
»suÉ
);

499 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
row
, 
v®ue
èğ
db
.
tbl_u£¿cù
().
£Ëù_row
(
u£¿cù_key
(
u£r_id
),

500 {{
u£r_nc
::
u£r_ed™couÁ
, 
Œue
},

501 {
u£r_nc
::
u£r_touched
, 
Œue
}});

502 
TXN_DO
(
abÜt
);

503 
as£¹
(
»suÉ
);

504 autØ
	gÃw_uv
 = 
Sto
::
tx_®loc
(
»š‹½»t_ÿ¡
<cÚ¡ 
u£¿cù_row
 *>(
v®ue
));

505 
	gÃw_uv
->
	gu£r_ed™couÁ
 += 1;

506 
	gÃw_uv
->
	gu£r_touched
 = 
time¡amp_¡r
;

507 
	gdb
.
tbl_u£¿cù
().
upd©e_row
(
row
, 
Ãw_uv
);

509 } 
RETRY
(
Œue
);

511  
	gŒue
;

515 
loggšg_key
 
lg_k
(
db
.
tbl_loggšg
().
g’_key
());

517 autØ
	glg_v
 = 
Sto
::
tx_®loc
<
loggšg_row
>();

518 
	glg_v
->
	glog_ty³
 = 
¡d
::
¡ršg
("patrol");

519 
	glg_v
->
	glog_aùiÚ
 = 
¡d
::
¡ršg
("patrol");

520 
	glg_v
->
	glog_time¡amp
 = 
time¡amp_¡r
;

521 
	glg_v
->
	glog_u£r
 = 
u£r_id
;

522 
	glg_v
->
	glog_Çme¥aû
 = 
·ge_Çme_¥aû
;

523 
	glg_v
->
	glog_t™Ë
 = 
·ge_t™Ë
;

524 
	glg_v
->
	glog_comm’t
 = 
»v_comm’t
;

525 
	glg_v
->
	glog_·¿ms
 = 
¡d
::
¡ršg
();

526 
	glg_v
->
	glog_d–‘ed
 = 0;

527 
	glg_v
->
	glog_u£r_‹xt
 = 
u£r_‹xt
;

528 
	glg_v
->
	glog_·ge
 = 
·ge_id
;

530 
	g¡d
::
t›
(
abÜt
, 
»suÉ
èğ
db
.
tbl_loggšg
().
š£¹_row
(
lg_k
, 
lg_v
);

531 
TXN_CHECK
(
abÜt
);

532 
as£¹
(!
»suÉ
);

535 
	g¡d
::
t›
(
abÜt
, 
»suÉ
, 
row
, 
v®ue
èğ
db
.
tbl_u£¿cù
().
£Ëù_row
(
u£¿cù_key
(
u£r_id
),

536 {{
u£r_nc
::
u£r_ed™couÁ
, 
Œue
},

537 {
u£r_nc
::
u£r_touched
, 
Œue
}});

538 
TXN_CHECK
(
abÜt
);

539 
as£¹
(
»suÉ
);

540 autØ
	gÃw_uv
 = 
Sto
::
tx_®loc
(
»š‹½»t_ÿ¡
<cÚ¡ 
u£¿cù_row
 *>(
v®ue
));

541 
	gÃw_uv
->
	gu£r_ed™couÁ
 += 1;

542 
	gÃw_uv
->
	gu£r_touched
 = 
time¡amp_¡r
;

543 
	gdb
.
tbl_u£¿cù
().
upd©e_row
(
row
, 
Ãw_uv
);

545 
	gINTERACTIVE_TXN_COMMIT
;

547  
	gŒue
;

550 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

551 
size_t
 
	gwikedŸ_ruÂ”
<
	gDBP¬ams
>::
run_txn_upd©ePage
(
‹xt_id
,

552 
·ge_id
,

553 cÚ¡ 
¡d
::
¡ršg
& 
·ge_t™Ë
,

554 cÚ¡ 
¡d
::
¡ršg
& 
·ge_‹xt
,

555 
·ge_Çme_¥aû
,

556 
u£r_id
,

557 cÚ¡ 
¡d
::
¡ršg
& 
u£r_
,

558 cÚ¡ 
¡d
::
¡ršg
& 
u£r_‹xt
,

559 
»v_id
,

560 cÚ¡ 
¡d
::
¡ršg
& 
»v_comm’t
,

561 
»v_mšÜ_ed™
) {

562 
size_t
 
	gÃxecs
 = 0;

563 
	gŒue
) {

564 
boŞ
 
	gsucûss
 =

565 
txn_upd©ePage_šÃr
(
‹xt_id
, 
·ge_id
, 
·ge_t™Ë
, 
·ge_‹xt
,

566 
·ge_Çme_¥aû
, 
u£r_id
, 
u£r_
, 
u£r_‹xt
,

567 
»v_id
, 
»v_comm’t
, 
»v_mšÜ_ed™
, 
Ãxecs
);

568 ià(
	gsucûss
)

571  (
	gÃxecs
 - 1);

	@benchmark/YCSB_bench.cc

1 
	~<s¡»am
>

2 
	~<io¡»am
>

3 
	~<th»ad
>

5 
	~"YCSB_b’ch.hh
"

6 
	~"YCSB_txns.hh
"

7 
	~"PÏtfÜmF—tu»s.hh
"

8 
	~"DB_´of”.hh
"

10 
Çme¥aû
 
	gycsb
 {

12 
usšg
 
Çme¥aû
 
	gdb_·¿ms
;

13 
usšg
 
	gb’ch
::
db_´of”
;

16 
	gİt_dbid
 = 1, 
	gİt_Áhrs
, 
	gİt_mode
, 
	gİt_time
, 
	gİt_³rf
, 
	gİt_pfút


19 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

20 { "dbid", 'i', 
İt_dbid
, 
CÍ_V®SŒšg
, 
CÍ_O±iÚ®
 },

21 { "Áh»ads", 't', 
İt_Áhrs
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

22 { "mode", 'm', 
İt_mode
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

23 { "time", 'l', 
İt_time
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

24 { "³rf", 'p', 
İt_³rf
, 
CÍ_NoV®
, 
CÍ_O±iÚ®
 },

25 { "³rf-couÁ”", 'c', 
İt_pfút
, 
CÍ_NoV®
, 
CÍ_Neg©e
| 
CÍ_O±iÚ®
 }

28 
´št_u§ge
(cÚ¡ *
´og_Çme
) {

29 ()
	g´og_Çme
;

30 
	g¡d
::
cout
 << ":)" << 
¡d
::
’dl
;

33 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

34 
ycsb_´•İuÏtiÚ_th»ad
(
th»ad_id
, 
ycsb_db
<
DBP¬ams
>& 
db
, 
ušt64_t
 
key_begš
, ušt64_ˆ
key_’d
) {

35 
£t_affš™y
(
th»ad_id
);

36 
	gycsb_šput_g’”©Ü
<
	gDBP¬ams
> 
ig
(
th»ad_id
);

37 
	gdb
.
bË_th»ad_š™
();

38 
ušt64_t
 
	gi
 = 
key_begš
; i < 
	gkey_’d
; ++i) {

39 
	gdb
.
ycsb_bË
().
nÚŒªs_put
(
ycsb_key
(
i
), 
ig
.
¿ndom_ycsb_v®ue
());

43 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

44 
	gycsb_db
<
	gDBP¬ams
>::
´•İuÏ‹
() {

45 
cÚ¡ex´
 
ušt64_t
 
Áh»ads
 = 32;

46 
ušt64_t
 
	gkey_begš
, 
	gkey_’d
;

47 
ušt64_t
 
	g£gm’t_size
 = 
ycsb_bË_size
 / 
Áh»ads
;

48 
	gkey_begš
 = 0;

49 
	gkey_’d
 = 
£gm’t_size
;

51 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
´•İuÏtÜs
;

53 
ušt64_t
 
	gtid
 = 0;id < 
	gÁh»ads
; ++tid) {

54 
	g´•İuÏtÜs
.
em¶aû_back
(
ycsb_´•İuÏtiÚ_th»ad
<
DBP¬ams
>, ()
tid
, 
¡d
::
»f
(*
this
), 
key_begš
, 
key_’d
);

55 
	gkey_begš
 +ğ
£gm’t_size
;

56 
	gkey_’d
 +ğ
£gm’t_size
;

59 auto& 
	gt
 : 
´•İuÏtÜs
)

60 
t
.
još
();

63 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

64 şas 
	cycsb_acûss
 {

65 
	gpublic
:

66 
ycsb_ruÂ”_th»ad
(
ycsb_db
<
DBP¬ams
>& 
db
, 
db_´of”
& 
´of
, 
ycsb_ruÂ”
<DBP¬ams>& 
ruÂ”
, 
time_lim™
, 
ušt64_t
& 
txn_út
) {

67 
ušt64_t
 
	gloÿl_út
 = 0;

68 
	gdb
.
bË_th»ad_š™
();

70 ::
TTh»ad
::
£t_id
(
ruÂ”
.
id
());

71 
£t_affš™y
(
ruÂ”
.
id
());

73 
ušt64_t
 
	gtsc_diff
 = (ušt64_t)(
time_lim™
 * 
cÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
 * cÚ¡ªts::
bliÚ
);

74 autØ
	g¡¬t_t
 = 
´of
.
¡¬t_time¡amp
();

76 autØ
	g™
 = 
ruÂ”
.
wÜklßd
.
begš
();

78 
	gŒue
) {

79 autØ
	gcu¼_t
 = 
»ad_tsc
();

80 ià((
	gcu¼_t
 - 
	g¡¬t_t
è>ğ
tsc_diff
)

83 
	gruÂ”
.
run_txn
(*
™
);

84 ++
	g™
;

85 ià(
	g™
 =ğ
ruÂ”
.
wÜklßd
.
’d
())

86 
™
 = 
ruÂ”
.
wÜklßd
.
begš
();

88 ++
	gloÿl_út
;

91 
	gtxn_út
 = 
loÿl_út
;

94 
wÜklßd_g’”©iÚ
(
¡d
::
veùÜ
<
ycsb_ruÂ”
<
DBP¬ams
>>& 
ruÂ”s
, 
mode
) {

95 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
thrs
;

96 
	gtsize
 = (
mode
 =ğ
¡©ic_ÿ¡
<>(
mode_id
::
R—dOÆy
)) ? 2 : 16;

97 auto& 
	gr
 : 
ruÂ”s
) {

98 
thrs
.
em¶aû_back
(&
ycsb_ruÂ”
<
DBP¬ams
>::
g’_wÜklßd
, &
r
, 
tsize
);

100 auto& 
	gt
 : 
thrs
)

101 
t
.
još
();

104 
ušt64_t
 
run_b’chm¬k
(
ycsb_db
<
DBP¬ams
>& 
db
, 
db_´of”
& 
´of
, 
¡d
::
veùÜ
<
ycsb_ruÂ”
<DBP¬ams>>& 
ruÂ”s
, 
time_lim™
) {

105 
	gnum_ruÂ”s
 = 
ruÂ”s
.
size
();

106 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
ruÂ”_thrs
;

107 
	g¡d
::
veùÜ
<
ušt64_t
> 
txn_úts
(
size_t
(
num_ruÂ”s
), 0);

109 
	gi
 = 0; i < 
	gnum_ruÂ”s
; ++i) {

110 
årštf
(
¡dout
, "ruÂ” %d c»©ed\n", 
i
);

111 
	gruÂ”_thrs
.
em¶aû_back
(
ycsb_ruÂ”_th»ad
, 
¡d
::
»f
(
db
), std::»f(
´of
),

112 
¡d
::
»f
(
ruÂ”s
[
i
]), 
time_lim™
, std::»f(
txn_úts
[i]));

115 autØ&
	gt
 : 
ruÂ”_thrs
)

116 
t
.
još
();

118 
ušt64_t
 
	gtÙ®_txn_út
 = 0;

119 auto& 
	gút
 : 
txn_úts
)

120 
tÙ®_txn_út
 +ğ
út
;

121  
	gtÙ®_txn_út
;

125 
execu‹
(
¬gc
, cÚ¡ *cÚ¡ *
¬gv
) {

126 
	g»t
 = 0;

128 
boŞ
 
	g¥awn_³rf
 = 
çl£
;

129 
boŞ
 
	gcouÁ”_mode
 = 
çl£
;

130 
	gnum_th»ads
 = 1;

131 
	gmode
 = 
¡©ic_ÿ¡
<>(
mode_id
::
R—dOÆy
);

132 
	gtime_lim™
 = 10.0;

134 
CÍ_P¬£r
 *
	gşp
 = 
CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
¬¿ysize
(
İtiÚs
), options);

136 
	gİt
;

137 
boŞ
 
	gşp_¡İ
 = 
çl£
;

138 !
	gşp_¡İ
 && ((
	gİt
 = 
CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
)) {

139 
İt
) {

140 
İt_dbid
:

142 
	gİt_Áhrs
:

143 
num_th»ads
 = 
şp
->
v®
.
i
;

145 
	gİt_mode
:

146 
mode
 = 
şp
->
v®
.
i
;

148 
	gİt_time
:

149 
time_lim™
 = 
şp
->
v®
.
d
;

151 
	gİt_³rf
:

152 
¥awn_³rf
 = !
şp
->
Ãg©ed
;

154 
	gİt_pfút
:

155 
couÁ”_mode
 = !
şp
->
Ãg©ed
;

158 
´št_u§ge
(
¬gv
[0]);

159 
	g»t
 = 1;

160 
	gşp_¡İ
 = 
Œue
;

165 
CÍ_D–‘eP¬£r
(
şp
);

166 ià(
	g»t
 != 0)

167  
»t
;

169 autØ
	g´of”_mode
 = 
couÁ”_mode
 ?

170 
Prof”
::
³rf_mode
::
couÁ”s
 : Prof”::³rf_mode::
»cÜd
;

172 ià(
	gcouÁ”_mode
 && !
	g¥awn_³rf
) {

174 
	g¥awn_³rf
 = 
Œue
;

177 ià(
	g¥awn_³rf
) {

178 
	g¡d
::
cout
 << "Info: Spawning…erf…rofiler in "

179 << (
couÁ”_mode
 ? "couÁ”" : "»cÜd"è<< " mode" << 
¡d
::
’dl
;

182 
db_´of”
 
´of
(
¥awn_³rf
);

183 
	gycsb_db
<
	gDBP¬ams
> 
	gdb
;

185 
	g¡d
::
cout
 << "P»pİuÏtšg d©aba£..." << 
¡d
::
’dl
;

186 
	gdb
.
´•İuÏ‹
();

187 
	g¡d
::
cout
 << "P»pİuÏtiÚ com¶‘e." << 
¡d
::
’dl
;

189 
	g¡d
::
veùÜ
<
ycsb_ruÂ”
<
DBP¬ams
>> 
ruÂ”s
;

190 
	gi
 = 0; i < 
	gnum_th»ads
; ++i) {

191 
	gruÂ”s
.
em¶aû_back
(
i
, 
db
, 
¡©ic_ÿ¡
<
mode_id
>(
mode
));

194 
	g¡d
::
cout
 << "G’”©šg wÜklßd..." << 
¡d
::
’dl
;

195 
wÜklßd_g’”©iÚ
(
ruÂ”s
, 
mode
);

196 
	g¡d
::
cout
 << "DÚe." << 
¡d
::
’dl
;

198 
	g´of
.
¡¬t
(
´of”_mode
);

199 autØ
	gnum_Œªs
 = 
run_b’chm¬k
(
db
, 
´of
, 
ruÂ”s
, 
time_lim™
);

200 
	g´of
.
fšish
(
num_Œªs
);

209 
usšg
 
Çme¥aû
 
	gycsb
;

210 
usšg
 
Çme¥aû
 
	gdb_·¿ms
;

212 
	gcÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
;

214 
	$maš
(
¬gc
, cÚ¡ *cÚ¡ *
¬gv
) {

215 
db_·¿ms_id
 
dbid
 = db_·¿ms_id::
DeçuÉ
;

216 
»t_code
 = 0;

218 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
	`¬¿ysize
(
İtiÚs
), options);

220 
İt
;

221 
boŞ
 
şp_¡İ
 = 
çl£
;

222 !
şp_¡İ
 && ((
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
)) {

223 
İt
) {

224 
İt_dbid
:

225 
dbid
 = 
	`·r£_dbid
(
şp
->
v®
.
s
);

226 ià(
dbid
 =ğ
db_·¿ms_id
::
NÚe
) {

227 
¡d
::
cout
 << "Unsupported DB CC id: "

228 << ((
şp
->
v®
.
s
 =ğ
nuÎ±r
è? "" : 
¡d
::
	`¡ršg
(şp->v®.s)è<< std::
’dl
;

229 
	`´št_u§ge
(
¬gv
[0]);

230 
»t_code
 = 1;

231 
şp_¡İ
 = 
Œue
;

239 
	`CÍ_D–‘eP¬£r
(
şp
);

240 ià(
»t_code
 != 0)

241  
»t_code
;

243 autØ
ıu_äeq
 = 
	`d‘”mše_ıu_äeq
();

244 ià(
ıu_äeq
 == 0.0)

247 
cÚ¡ªts
::
´oûssÜ_tsc_äequ’cy
 = 
ıu_äeq
;

249 
dbid
) {

250 
db_·¿ms_id
::
DeçuÉ
:

251 
»t_code
 = 
ycsb_acûss
<
db_deçuÉ_·¿ms
>::
	`execu‹
(
¬gc
, 
¬gv
);

253 
db_·¿ms_id
::
O·que
:

254 
»t_code
 = 
ycsb_acûss
<
db_İaque_·¿ms
>::
	`execu‹
(
¬gc
, 
¬gv
);

256 
db_·¿ms_id
::
TwoPL
:

257 
»t_code
 = 
ycsb_acûss
<
db_2¶_·¿ms
>::
	`execu‹
(
¬gc
, 
¬gv
);

259 
db_·¿ms_id
::
Ad­tive
:

260 
»t_code
 = 
ycsb_acûss
<
db_ad­tive_·¿ms
>::
	`execu‹
(
¬gc
, 
¬gv
);

262 
db_·¿ms_id
::
Swiss
:

263 
»t_code
 = 
ycsb_acûss
<
db_swiss_·¿ms
>::
	`execu‹
(
¬gc
, 
¬gv
);

265 
db_·¿ms_id
::
TicToc
:

266 
»t_code
 = 
ycsb_acûss
<
db_tiùoc_·¿ms
>::
	`execu‹
(
¬gc
, 
¬gv
);

269 
¡d
::
û¼
 << "unknowÀdb cÚfig…¬am‘” id" << std::
’dl
;

270 
»t_code
 = 1;

274  
»t_code
;

276 
	}
}

	@benchmark/YCSB_bench.hh

1 #´agm¨
Úû


3 
	~<io¡»am
>

4 
	~<¡ršg
>

6 
	~"comp”.hh
"

7 
	~"şp.h
"

8 
	~"§m¶šg.hh
"

9 
	~"Sy¡emProf”.hh
"

10 
	~"YCSB_¡ruùs.hh
"

11 
	~"DB_šdex.hh
"

12 
	~"DB_·¿ms.hh
"

14 
Çme¥aû
 
	gycsb
 {

16 
usšg
 
	gb’ch
::
Üd”ed_šdex
;

17 
usšg
 
	gb’ch
::
unÜd”ed_šdex
;

19 
cÚ¡ex´
 
ušt64_t
 
	gycsb_bË_size
 = 10000000;

21 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

22 şas 
	cycsb_db
 {

23 
	gpublic
:

24 
‹m¶©e
 <
ty³Çme
 
K
,y³Çm
	gV
>

25 
usšg
 
	gOIndex
 = 
Üd”ed_šdex
<
K
, 
	gV
, 
	gDBP¬ams
>;

26 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gV
>

27 
usšg
 
	gUIndex
 = 
unÜd”ed_šdex
<
K
, 
	gV
, 
	gDBP¬ams
>;

29 
	gUIndex
<
	tycsb_key
, 
	tycsb_v®ue
<
	tDBP¬ams
>> 
	tycsb_bË_ty³
;

31 
ex¶ic™
 
ycsb_db
(è: 
ycsb_bË_
(
ycsb_bË_size
) {}

33 
ycsb_bË_ty³
& 
ycsb_bË
() {

34  
ycsb_bË_
;

37 
bË_th»ad_š™
() {

41 
´•İuÏ‹
();

43 
	g´iv©e
:

44 
ycsb_bË_ty³
 
ycsb_bË_
;

47 
	sycsb_İ_t
 {

48 
ycsb_İ_t
(è: 
is_wr™e
(), 
key
(), 
cŞ_n
() {}

49 
ycsb_İ_t
(
boŞ
 
w
, 
ušt32_t
 
k
, 
št32_t
 
c
)

50 : 
is_wr™e
(
w
), 
key
(
k
), 
cŞ_n
(
c
) {}

51 
boŞ
 
	gis_wr™e
;

52 
ušt32_t
 
	gkey
;

53 
št32_t
 
	gcŞ_n
;

56 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

57 şas 
	cycsb_ruÂ”
 {

58 
	gpublic
:

59 
¡d
::
	tveùÜ
<
	tycsb_İ_t
> 
	tycsb_txn_t
;

61 
ycsb_ruÂ”
(
tid
, 
ycsb_db
<
DBP¬ams
>& 
d©aba£
, 
mode_id
 
mid
)

62 : 
db
(
d©aba£
), 
ig
(
tid
), 
ruÂ”_id
Ñid), 
mode
(
mid
),

63 
ud
(), 
dd
(), 
wr™e_th»shŞd
() {}

65 
šlše
 
di¡_š™
() {

66 
	gud
 = 
Ãw
 
§m¶šg
::
StoUnifÜmDi¡ributiÚ
<>(
ig
.
g’”©Ü
(), 0, 
	g¡d
::
num”ic_lim™s
<
ušt32_t
>::
max
());

67 
	gmode
) {

68 
	gmode_id
::
R—dOÆy
:

69 
dd
 = 
Ãw
 
§m¶šg
::
StoUnifÜmDi¡ributiÚ
<>(
ig
.
g’”©Ü
(), 0, 
	gycsb_bË_size
 - 1);

70 
	gwr™e_th»shŞd
 = 0;

72 
	gmode_id
::
MediumCÚ‹ÁiÚ
:

73 
dd
 = 
Ãw
 
§m¶šg
::
StoZfDi¡ributiÚ
<>(
ig
.
g’”©Ü
(), 0, 
	gycsb_bË_size
 - 1, 0.8);

74 
	gwr™e_th»shŞd
 = (
ušt32_t
è(
¡d
::
num”ic_lim™s
<ušt32_t>::
max
()/10);

76 
	gmode_id
::
HighCÚ‹ÁiÚ
:

77 
dd
 = 
Ãw
 
§m¶šg
::
StoZfDi¡ributiÚ
<>(
ig
.
g’”©Ü
(), 0, 
	gycsb_bË_size
 - 1, 0.9);

78 
	gwr™e_th»shŞd
 = (
ušt32_t
è(
¡d
::
num”ic_lim™s
<ušt32_t>::
max
()/2);

85 
šlše
 
g’_wÜklßd
(
txn_size
);

87 
id
() const {

88  
	gruÂ”_id
;

91 
šlše
 
run_txn
(cÚ¡ 
ycsb_txn_t
& 
txn
);

93 
	g¡d
::
veùÜ
<
ycsb_txn_t
> 
wÜklßd
;

95 
	g´iv©e
:

96 
ycsb_db
<
DBP¬ams
>& 
db
;

97 
	gycsb_šput_g’”©Ü
<
	gDBP¬ams
> 
	gig
;

98 
	gruÂ”_id
;

99 
mode_id
 
	gmode
;

101 
	g§m¶šg
::
StoUnifÜmDi¡ributiÚ
<> *
ud
;

102 
	g§m¶šg
::
StoRªdomDi¡ributiÚ
<> *
dd
;

104 
ušt32_t
 
	gwr™e_th»shŞd
;

	@benchmark/YCSB_structs.hh

1 #´agm¨
Úû


3 
	~<¡ršg
>

4 
	~<¿ndom
>

6 
	~"DB_¡ruùs.hh
"

7 
	~"¡r.hh
"

8 
	~"IÁ”çû.hh
"

9 
	~"DB_šdex.hh
"

11 
Çme¥aû
 
	gycsb
 {

13 
usšg
 
	gb’ch
::
fix_¡ršg
;

14 
usšg
 
	gb’ch
::
g‘_v”siÚ
;

15 
usšg
 
	gb’ch
::
v”siÚ_ad­‹r
;

17 şas 
	cmode_id
 : { 
R—dOÆy
 = 0, 
	gMediumCÚ‹ÁiÚ
, 
	gHighCÚ‹ÁiÚ
 };

19 
	sycsb_key
 {

20 
ycsb_key
(
ušt64_t
 
id
) {

23 
	gw_id
 = 
id
;

25 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
ycsb_key
& 
Ùh”
) const {

26  
w_id
 =ğ
Ùh”
.w_id;

28 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
ycsb_key
& 
Ùh”
) const {

29  !(*
this
 =ğ
Ùh”
);

31 
İ”©Ü
 
	glcdf
::
SŒ
() const {

32  
lcdf
::
SŒ
((cÚ¡ *)
this
, (*this));

35 
ušt64_t
 
	gw_id
;

39 
	sycsb_v®ue
 {

41 
	gcc
::
fix_¡ršg
<
ycsb_cŞ_size
> 
cŞ
;

45 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

46 şas 
	cycsb_v®ue
 : 
TObjeù
 {

47 
public
:

48 
cÚ¡ex´
 
size_t
 
cŞ_width
 = 10;

49 
cÚ¡ex´
 
size_t
 
	gnum_cŞs
 = 10;

50 
	gfix_¡ršg
<
	tcŞ_width
> 
	tcŞ_ty³
;

51 
ty³Çme
 
	tg‘_v”siÚ
<
	tDBP¬ams
>::
	tty³
 
	tv”siÚ_ty³
;

53 
ycsb_v®ue
(è: 
cŞs
(), 
v0
(
Sto
::
š™Ÿlized_tid
(), 
çl£
)

54 #ià
TABLE_FINE_GRAINED


55 , 
v1
(
Sto
::
š™Ÿlized_tid
(), 
çl£
)

59 
	gcŞ_ty³
& 
cŞ_acûss
(
cŞ_n
) {

60  
	gcŞs
[
cŞ_n
];

62 cÚ¡ 
	gcŞ_ty³
& 
cŞ_acûss
(
cŞ_n
) const {

63  
	gcŞs
[
cŞ_n
];

67 
boŞ
 
Œªs_cŞ_upd©e
(
cŞ_n
, cÚ¡ 
cŞ_ty³
& 
Ãw_cŞ
) {

68 
®ways_as£¹
((
size_t
)
cŞ_n
 < 
num_cŞs
, "column index out of bound");

69 #ià
TABLE_FINE_GRAINED


70 autØ
	g™em
 = 
Sto
::
™em
(
this
, 
cŞ_n
);

71 auto& 
	gv
 = (
cŞ_n
 % 2 =ğ0è? 
v0
 : 
v1
;

72 ià(!
	gv”siÚ_ad­‹r
::
£Ëù_fÜ_ov”wr™e
(
™em
, 
v
, &
Ãw_cŞ
))

73  
	gçl£
;

75 autØ
	g™em
 = 
Sto
::
™em
(
this
, 
cŞ_n
);

76 ià(!
	gv”siÚ_ad­‹r
::
£Ëù_fÜ_ov”wr™e
(
™em
, 
v0
, &
Ãw_cŞ
))

77  
	gçl£
;

79  
	gŒue
;

83 
	g¡d
::
·œ
<
boŞ
, cÚ¡ 
	gcŞ_ty³
 *> 
Œªs_cŞ_»ad
(
cŞ_n
) {

84 
®ways_as£¹
((
size_t
)
cŞ_n
 < 
num_cŞs
, "column index out of bound");

85 #ià
TABLE_FINE_GRAINED


86 autØ
	g™em
 = 
Sto
::
™em
(
this
, 
cŞ_n
);

87 ià(!
	g™em
.
ob£rve
((
cŞ_n
 % 2 =ğ0è? 
v0
 : 
v1
))

88  {
çl£
, 
nuÎ±r
};

90 autØ
	g™em
 = 
Sto
::
™em
(
this
, 
cŞ_n
);

91 ià(!
	g™em
.
ob£rve
(
v0
))

92  {
	gçl£
, 
	gnuÎ±r
};

94  {
	gŒue
, &
	gcŞs
[
cŞ_n
]};

98 
boŞ
 
lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
	gov”ride
 {

99 #ià
TABLE_FINE_GRAINED


100 
	gv”siÚ_ty³
& 
	gv
 = (
™em
.
key
<>()%2 =ğ0è? 
v0
 : 
v1
;

102 
	gv”siÚ_ty³
& 
	gv
 = 
v0
;

104  
	gtxn
.
Œy_lock
(
™em
, 
v
);

107 
boŞ
 
check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
	gov”ride
 {

108 #ià
TABLE_FINE_GRAINED


109 
	gv”siÚ_ty³
& 
	gv
 = (
™em
.
key
<>()%2 =ğ0è? 
v0
 : 
v1
;

111 
	gv”siÚ_ty³
& 
	gv
 = 
v0
;

113  
	gv
.
ı_check_v”siÚ
(
txn
, 
™em
);

116 
š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
	gov”ride
 {

117 #ià
TABLE_FINE_GRAINED


118 
	gv”siÚ_ty³
& 
	gv
 = (
™em
.
key
<>()%2 =ğ0è? 
v0
 : 
v1
;

120 
	gv”siÚ_ty³
& 
	gv
 = 
v0
;

122 autØ
	gÃw_cŞ
 = 
™em
.
wr™e_v®ue
<
cŞ_ty³
 *>();

123 
	gcŞs
[
™em
.
key
<>()] = *
Ãw_cŞ
;

124 
	gtxn
.
£t_v”siÚ_uÆock
(
v
, 
™em
);

127 
uÆock
(
T¿nsI‹m
& 
™em
è
	gov”ride
 {

128 #ià
TABLE_FINE_GRAINED


129 
	gv”siÚ_ty³
& 
	gv
 = (
™em
.
key
<>()%2 =ğ0è? 
v0
 : 
v1
;

131 
	gv”siÚ_ty³
& 
	gv
 = 
v0
;

133 
	gv
.
ı_uÆock
(
™em
);

136 
	g´iv©e
:

137 
cŞ_ty³
 
cŞs
[
num_cŞs
];

138 
v”siÚ_ty³
 
	gv0
;

139 #ià
TABLE_FINE_GRAINED


140 
v”siÚ_ty³
 
	gv1
;

144 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

145 şas 
	cycsb_šput_g’”©Ü
 {

146 
	gpublic
:

147 
usšg
 
v®ue_ty³
 = 
ycsb_v®ue
<
DBP¬ams
>;

148 
ycsb_šput_g’”©Ü
(
th»ad_id
)

149 : 
g’
(
th»ad_id
), 
dis
(0, 61) {}

151 
v®ue_ty³
 
¿ndom_ycsb_v®ue
() {

152 
v®ue_ty³
 
	g»t
;

153 
size_t
 
	gi
 = 0; i < 
	gv®ue_ty³
::
num_cŞs
; i++) {

154 
	g»t
.
cŞ_acûss
(
i
èğ
¿ndom_a_¡ršg
(
v®ue_ty³
::
cŞ_width
);

156  
	g»t
;

159 
	g¡d
::
mt19937
& 
g’”©Ü
() {

160  
g’
;

163 
¿ndom_ycsb_cŞ_v®ue_š¶aû
(
ty³Çme
 
v®ue_ty³
::
cŞ_ty³
 *
d¡
) {

164 
size_t
 
i
 = 0; 
	gi
 < 
	gv®ue_ty³
::
cŞ_width
; ++i)

165 (*
	gd¡
)[
i
] = 
¿ndom_ch¬
();

168 
	g´iv©e
:

169 
¡d
::
¡ršg
 
¿ndom_a_¡ršg
(
size_t
 
Ën
) {

170 
¡d
::
¡ršg
 
¡r
;

171 
	g¡r
.
»£rve
(
Ën
);

172 autØ
	gi
 = 0u; i < 
	gËn
; ++i) {

173 
	g¡r
.
push_back
(
¿ndom_ch¬
());

175  
	g¡r
;

178 
¿ndom_ch¬
() {

179 autØ
	gn
 = 
dis
(
g’
);

180 
	gc
 = (
n
 < 26) ? ('a' +‚) :

181 ((
n
 < 52) ? ('A' + (n - 26)) : ('0' + (n - 52)));

182  
	gc
;

185 
	g¡d
::
mt19937
 
g’
;

186 
	g¡d
::
unifÜm_št_di¡ributiÚ
<> 
dis
;

191 
Çme¥aû
 
	g¡d
 {

193 
	g‹m¶©e
 <>

194 
	ghash
<
	gycsb
::
ycsb_key
> {

195 
size_t
 
İ”©Ü
(è(cÚ¡ 
ycsb
::
ycsb_key
& 
¬g
) const {

196  
¬g
.
w_id
;

	@benchmark/YCSB_txns.hh

1 #´agm¨
Úû


4 
	~<£t
>

5 
	~"YCSB_b’ch.hh
"

7 
Çme¥aû
 
	gycsb
 {

9 
cÚ¡ex´
 
ušt64_t
 
	gmax_txns
 = 1000000;

11 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

12 
	gycsb_ruÂ”
<
	gDBP¬ams
>::
g’_wÜklßd
(
txn_size
) {

13 
di¡_š™
();

14 
ušt64_t
 
	gi
 = 0; i < 
	gmax_txns
; ++i) {

15 
ycsb_txn_t
 
	gtxn
;

16 
	gtxn
.
»£rve
(
txn_size
);

17 
	g¡d
::
£t
<
ušt32_t
> 
key_£t
;

18 
	gj
 = 0; j < 
	gtxn_size
; ++j) {

19 
ušt32_t
 
	gkey
;

21 
	gkey
 = 
dd
->
§m¶e
();

22 } 
	gkey_£t
.
fšd
(
key
è!ğ
key_£t
.
’d
());

23 
	gkey_£t
.
š£¹
(
key
);

25 autØ
	g™
 = 
key_£t
.
begš
(); iˆ!ğkey_£t.
’d
(); ++it) {

26 
boŞ
 
	gis_wr™e
 = 
ud
->
§m¶e
(è< 
wr™e_th»shŞd
;

27 
	gtxn
.
em¶aû_back
(
is_wr™e
, *
™
, 
ud
->
§m¶e
() % 10 );

29 
	gwÜklßd
.
push_back
(
¡d
::
move
(
txn
));

33 
	g‹m¶©e
 <
ty³Çme
 
	gDBP¬ams
>

34 
	gycsb_ruÂ”
<
	gDBP¬ams
>::
run_txn
(cÚ¡ 
ycsb_txn_t
& 
txn
) {

35 
TRANSACTION
 {

36 
boŞ
 
sucûss
;

37 auto& 
	gİ
 : 
txn
) {

38 ià(
İ
.
is_wr™e
) {

39 
ycsb_key
 
key
(
İ
.key);

40 autØ
	gv®ue
 = 
db
.
ycsb_bË
().
nÚŒªs_g‘
(
key
);

41 
as£¹
(
v®ue
);

43 autØ
	gÃw_cŞ
 = 
Sto
::
tx_®loc
<
ty³Çme
 
ycsb_v®ue
<
DBP¬ams
>::
cŞ_ty³
>();

44 
	gig
.
¿ndom_ycsb_cŞ_v®ue_š¶aû
(
Ãw_cŞ
);

45 
	gsucûss
 = 
v®ue
->
Œªs_cŞ_upd©e
(
İ
.
cŞ_n
, *
Ãw_cŞ
);

46 
TXN_DO
(
sucûss
);

48 autØ
	gv®ue
 = 
db
.
ycsb_bË
().
nÚŒªs_g‘
(
ycsb_key
(
İ
.
key
));

49 
as£¹
(
v®ue
);

51 
	g¡d
::
t›
(
sucûss
, 
¡d
::
ignÜe
èğ
v®ue
->
Œªs_cŞ_»ad
(
İ
.
cŞ_n
);

52 
TXN_DO
(
sucûss
);

55 } 
RETRY
(
Œue
);

	@config.h

4 #iâdeà
MASSTREE_CONFIG_H_INCLUDED


5 
	#MASSTREE_CONFIG_H_INCLUDED
 1

	)

11 
	#CACHE_LINE_SIZE
 64

	)

14 
	#ENABLE_ASSERTIONS
 1

	)

23 
	#HAVE_CLOCK_GETTIME
 1

	)

26 
	#HAVE_CXX_AUTO
 1

	)

29 
	#HAVE_CXX_CONSTEXPR
 1

	)

32 
	#HAVE_CXX_RVALUE_REFERENCES
 1

	)

35 
	#HAVE_CXX_STATIC_ASSERT
 1

	)

38 
	#HAVE_CXX_TEMPLATE_ALIAS
 1

	)

42 
	#HAVE_DECL_CLOCK_GETTIME
 1

	)

46 
	#HAVE_DECL_GETLINE
 1

	)

49 
	#HAVE_EXECINFO_H
 1

	)

58 
	#HAVE_INT64_T_IS_LONG
 1

	)

64 
	#HAVE_INTTYPES_H
 1

	)

67 
	#HAVE_JEMALLOC
 1

	)

73 
	#HAVE_LONG_LONG
 1

	)

76 
	#HAVE_MADV_HUGEPAGE
 1

	)

79 
	#HAVE_MAP_HUGETLB
 1

	)

85 
	#HAVE_MEMORY_H
 1

	)

91 
	#HAVE_OFF_T_IS_LONG
 1

	)

100 
	#HAVE_SIZE_T_IS_UNSIGNED_LONG
 1

	)

109 
	#HAVE_STDINT_H
 1

	)

112 
	#HAVE_STDLIB_H
 1

	)

115 
	#HAVE_STD_HASH
 1

	)

118 
	#HAVE_STD_IS_RVALUE_REFERENCE
 1

	)

121 
	#HAVE_STD_IS_TRIVIALLY_COPYABLE
 1

	)

124 
	#HAVE_STRINGS_H
 1

	)

127 
	#HAVE_STRING_H
 1

	)

130 
	#HAVE_SUPERPAGE
 1

	)

133 
	#HAVE_SYS_EPOLL_H
 1

	)

136 
	#HAVE_SYS_STAT_H
 1

	)

139 
	#HAVE_SYS_TYPES_H
 1

	)

145 
	#HAVE_TIME_H
 1

	)

148 
	#HAVE_TYPE_TRAITS
 1

	)

151 
	#HAVE_UNALIGNED_ACCESS
 1

	)

154 
	#HAVE_UNISTD_H
 1

	)

157 
	#HAVE___BUILTIN_CLZ
 1

	)

160 
	#HAVE___BUILTIN_CLZL
 1

	)

163 
	#HAVE___BUILTIN_CLZLL
 1

	)

166 
	#HAVE___BUILTIN_CTZ
 1

	)

169 
	#HAVE___BUILTIN_CTZL
 1

	)

172 
	#HAVE___BUILTIN_CTZLL
 1

	)

175 
	#HAVE___HAS_TRIVIAL_COPY
 1

	)

178 
	#HAVE___SYNC_ADD_AND_FETCH
 1

	)

181 
	#HAVE___SYNC_ADD_AND_FETCH_8
 1

	)

184 
	#HAVE___SYNC_BOOL_COMPARE_AND_SWAP
 1

	)

187 
	#HAVE___SYNC_BOOL_COMPARE_AND_SWAP_8
 1

	)

190 
	#HAVE___SYNC_FETCH_AND_ADD
 1

	)

193 
	#HAVE___SYNC_FETCH_AND_ADD_8
 1

	)

196 
	#HAVE___SYNC_FETCH_AND_OR
 1

	)

199 
	#HAVE___SYNC_FETCH_AND_OR_8
 1

	)

202 
	#HAVE___SYNC_LOCK_RELEASE_SET
 1

	)

205 
	#HAVE___SYNC_LOCK_TEST_AND_SET
 1

	)

208 
	#HAVE___SYNC_LOCK_TEST_AND_SET_VAL
 1

	)

211 
	#HAVE___SYNC_OR_AND_FETCH
 1

	)

214 
	#HAVE___SYNC_OR_AND_FETCH_8
 1

	)

217 
	#HAVE___SYNC_SYNCHRONIZE
 1

	)

220 
	#HAVE___SYNC_VAL_COMPARE_AND_SWAP
 1

	)

223 
	#HAVE___SYNC_VAL_COMPARE_AND_SWAP_8
 1

	)

226 
	#MASSTREE_MAXKEYLEN
 511

	)

235 
	#MASSTREE_ROW_TYPE_BAG
 1

	)

241 
	#PACKAGE_BUGREPORT
 ""

	)

244 
	#PACKAGE_NAME
 "¡o"

	)

247 
	#PACKAGE_STRING
 "¡Ø0.1"

	)

250 
	#PACKAGE_TARNAME
 "¡o"

	)

253 
	#PACKAGE_URL
 ""

	)

256 
	#PACKAGE_VERSION
 "0.1"

	)

259 
	#SIZEOF_INT
 4

	)

262 
	#SIZEOF_LONG
 8

	)

265 
	#SIZEOF_LONG_LONG
 8

	)

268 
	#SIZEOF_SHORT
 2

	)

271 
	#SIZEOF_VOID_P
 8

	)

274 
	#STDC_HEADERS
 1

	)

278 #ià
defšed
 
AC_APPLE_UNIVERSAL_BUILD


279 #ià
defšed
 
__BIG_ENDIAN__


280 
	#WORDS_BIGENDIAN
 1

	)

283 #iâdeà
WORDS_BIGENDIAN


289 
	#WORDS_BIGENDIAN_SET
 1

	)

291 #ià!
FORCE_ENABLE_ASSERTIONS
 && !
ENABLE_ASSERTIONS


292 
	#NDEBUG
 1

	)

296 
	$ç_®ways_as£¹
(cÚ¡ * 
fe
, 
lše
, cÚ¡ * 
as£¹iÚ
, cÚ¡ * 
mes§ge
 = 0è
	`__©Œibu‹__
((
nÜ‘uº
));

297 
	#®ways_as£¹
(
x
, ...èdØ{ ià(!(x)è
	`ç_®ways_as£¹
(
__FILE__
, 
__LINE__
, #x, ## 
__VA_ARGS__
); 
	}
} 
çl£
)

	)

298 
	#mªd©Üy_as£¹
 
®ways_as£¹


	)

304 
	$ç_mas¡»e_šv¬ŸÁ
(cÚ¡ * 
fe
, 
lše
, cÚ¡ * 
as£¹iÚ
, cÚ¡ * 
mes§ge
 = 0è
	`__©Œibu‹__
((
nÜ‘uº
));

305 #ià
FORCE_ENABLE_ASSERTIONS
 || (!
	`defšed
(
ENABLE_INVARIANTS
è&& 
ENABLE_ASSERTIONS
) || ENABLE_INVARIANTS

306 
	#mas¡»e_šv¬ŸÁ
(
x
, ...èdØ{ ià(!(x)è
	`ç_mas¡»e_šv¬ŸÁ
(
__FILE__
, 
__LINE__
, #x, ## 
__VA_ARGS__
); 
	}
} 
çl£
)

	)

308 
	#mas¡»e_šv¬ŸÁ
(
x
, ...èdØ{ } 
çl£
)

	)

315 
	$ç_mas¡»e_´ecÚd™iÚ
(cÚ¡ * 
fe
, 
lše
, cÚ¡ * 
as£¹iÚ
, cÚ¡ * 
mes§ge
 = 0è
	`__©Œibu‹__
((
nÜ‘uº
));

316 #ià
FORCE_ENABLE_ASSERTIONS
 || (!
	`defšed
(
ENABLE_PRECONDITIONS
è&& 
ENABLE_ASSERTIONS
) || ENABLE_PRECONDITIONS

317 
	#mas¡»e_´ecÚd™iÚ
(
x
, ...èdØ{ ià(!(x)è
	`ç_mas¡»e_´ecÚd™iÚ
(
__FILE__
, 
__LINE__
, #x, ## 
__VA_ARGS__
); 
	}
} 
çl£
)

	)

319 
	#mas¡»e_´ecÚd™iÚ
(
x
, ...èdØ{ } 
çl£
)

	)

322 #iâdeà
šv¬ŸÁ


323 
	#šv¬ŸÁ
 
mas¡»e_šv¬ŸÁ


	)

325 #iâdeà
´ecÚd™iÚ


326 
	#´ecÚd™iÚ
 
mas¡»e_´ecÚd™iÚ


	)

329 #ià!
HAVE_SRANDOMDEV


330 #ià
__ılu¥lus


333 
¤ªdomdev
();

334 #ià
__ılu¥lus


	@datatype/ART.hh

30 
	~<¡dšt.h
>

31 
	~"Sto.hh
"

32 #iâdeà
ART_H


33 
	#ART_H


	)

35 
	#NODE4
 1

	)

36 
	#NODE16
 2

	)

37 
	#NODE48
 3

	)

38 
	#NODE256
 4

	)

40 
	#MAX_PREFIX_LEN
 10

	)

42 #ià
defšed
(
__GNUC__
è&& !defšed(
__şªg__
)

43 #ià
__STDC_VERSION__
 >ğ199901L && 402 =ğ(
__GNUC__
 * 100 + 
__GNUC_MINOR__
)

49 
	#BROKEN_GCC_C99_INLINE


	)

53 vŞ©
size_t
 
	gsome_couÁ”
 = 0;

55 (*
	t¬t_ÿÎback
)(*
	td©a
, cÚ¡ *
	tkey
, 
	tušt32_t
 
	tkey_Ën
, *
	tv®ue
);

62 
TV”siÚ
 
nv”s_
;

63 
ušt8_t
 
ty³
;

64 
ušt8_t
 
num_chd»n
;

65 
ušt32_t
 
·¹Ÿl_Ën
;

66 
·¹Ÿl
[
MAX_PREFIX_LEN
];

67 } 
	t¬t_node
;

73 
¬t_node
 
n
;

74 
keys
[4];

75 
¬t_node
 *
chd»n
[4];

76 } 
	t¬t_node4
;

82 
¬t_node
 
n
;

83 
keys
[16];

84 
¬t_node
 *
chd»n
[16];

85 } 
	t¬t_node16
;

92 
¬t_node
 
n
;

93 
keys
[256];

94 
¬t_node
 *
chd»n
[48];

95 } 
	t¬t_node48
;

101 
¬t_node
 
n
;

102 
¬t_node
 *
chd»n
[256];

103 } 
	t¬t_node256
;

110 
TV”siÚ
 
v”s
;

111 *
v®ue
;

112 
ušt32_t
 
key_Ën
;

113 
key
[];

114 } 
	t¬t_Ëaf
;

120 
¬t_node
 *
roÙ
;

121 
ušt64_t
 
size
;

122 } 
	t¬t_Œ“
;

128 
	`¬t_Œ“_š™
(
¬t_Œ“
 *
t
);

135 
	#š™_¬t_Œ“
(...è
	`¬t_Œ“_š™
(
__VA_ARGS__
)

	)

141 
	`¬t_Œ“_de¡roy
(
¬t_Œ“
 *
t
);

148 
	#de¡roy_¬t_Œ“
(...è
	`¬t_Œ“_de¡roy
(
__VA_ARGS__
)

	)

153 #ifdeà
BROKEN_GCC_C99_INLINE


154 
	#¬t_size
(
t
è(Ñ)->
size
)

	)

156 
šlše
 
ušt64_t
 
	$¬t_size
(
¬t_Œ“
 *
t
) {

157  
t
->
size
;

158 
	}
}

170 
¬t_Ëaf
* 
¬t_š£¹
(
¬t_Œ“
 *
t
, cÚ¡ *
key
, 
key_Ën
, *
v®ue
, 
boŞ
* 
Ãw_š£¹
);

180 * 
¬t_d–‘e
(
¬t_Œ“
 *
t
, cÚ¡ *
key
, 
key_Ën
);

190 
¬t_Ëaf
* 
¬t_£¬ch
(cÚ¡ 
¬t_Œ“
 *
t
, cÚ¡ *
key
, 
key_Ën
);

196 
¬t_Ëaf
* 
¬t_mšimum
(
¬t_Œ“
 *
t
);

202 
¬t_Ëaf
* 
¬t_maximum
(
¬t_Œ“
 *
t
);

214 
¬t_™”
(
¬t_Œ“
 *
t
, 
¬t_ÿÎback
 
cb
, *
d©a
);

228 
¬t_™”_´efix
(
¬t_Œ“
 *
t
, cÚ¡ *
´efix
, 
´efix_Ën
, 
¬t_ÿÎback
 
cb
, *
d©a
);

233 
	~<¡dlib.h
>

234 
	~<¡ršg.h
>

235 
	~<¡ršgs.h
>

236 
	~<¡dio.h
>

237 
	~<as£¹.h
>

239 #ifdeà
__i386__


240 
	~<emmšŒš.h
>

242 #ifdeà
__amd64__


243 
	~<emmšŒš.h
>

250 
	#IS_LEAF
(
x
è(((
ušŒ_t
)x & 1))

	)

251 
	#SET_LEAF
(
x
è((*)((
ušŒ_t
)x | 1))

	)

252 
	#LEAF_RAW
(
x
è((
¬t_Ëaf
*)((*)((
ušŒ_t
)x & ~1)))

	)

258 
¬t_node
* 
	$®loc_node
(
ušt8_t
 
ty³
) {

259 
¬t_node
* 
n
;

260 
ty³
) {

261 
NODE4
:

262 
n
 = (
¬t_node
*)
	`ÿÎoc
(1, (
¬t_node4
));

264 
NODE16
:

265 
n
 = (
¬t_node
*)
	`ÿÎoc
(1, (
¬t_node16
));

267 
NODE48
:

268 
n
 = (
¬t_node
*)
	`ÿÎoc
(1, (
¬t_node48
));

270 
NODE256
:

271 
n
 = (
¬t_node
*)
	`ÿÎoc
(1, (
¬t_node256
));

274 
	`abÜt
();

276 
n
->
ty³
 =ype;

277 
n
->
nv”s_
 = 
	`TV”siÚ
();

278  
n
;

279 
	}
}

285 
	$¬t_Œ“_š™
(
¬t_Œ“
 *
t
) {

286 
t
->
roÙ
 = 
NULL
;

287 
t
->
size
 = 0;

289 
	}
}

292 
	$de¡roy_node
(
¬t_node
 *
n
) {

294 ià(!
n
) ;

297 ià(
	`IS_LEAF
(
n
)) {

298 
	`ä“
(
	`LEAF_RAW
(
n
));

303 
i
, 
idx
;

305 
¬t_node4
 *
p1
;

306 
¬t_node16
 *
p2
;

307 
¬t_node48
 *
p3
;

308 
¬t_node256
 *
p4
;

309 } 
p
;

310 
n
->
ty³
) {

311 
NODE4
:

312 
p
.
p1
 = (
¬t_node4
*)
n
;

313 
i
=0;i<
n
->
num_chd»n
;i++) {

314 
	`de¡roy_node
(
p
.
p1
->
chd»n
[
i
]);

318 
NODE16
:

319 
p
.
p2
 = (
¬t_node16
*)
n
;

320 
i
=0;i<
n
->
num_chd»n
;i++) {

321 
	`de¡roy_node
(
p
.
p2
->
chd»n
[
i
]);

325 
NODE48
:

326 
p
.
p3
 = (
¬t_node48
*)
n
;

327 
i
=0;i<256;i++) {

328 
idx
 = ((
¬t_node48
*)
n
)->
keys
[
i
];

329 ià(!
idx
) ;

330 
	`de¡roy_node
(
p
.
p3
->
chd»n
[
idx
-1]);

334 
NODE256
:

335 
p
.
p4
 = (
¬t_node256
*)
n
;

336 
i
=0;i<256;i++) {

337 ià(
p
.
p4
->
chd»n
[
i
])

338 
	`de¡roy_node
(
p
.
p4
->
chd»n
[
i
]);

343 
	`abÜt
();

347 
	`ä“
(
n
);

348 
	}
}

354 
	$¬t_Œ“_de¡roy
(
¬t_Œ“
 *
t
) {

355 
	`de¡roy_node
(
t
->
roÙ
);

357 
	}
}

364 #iâdeà
BROKEN_GCC_C99_INLINE


365 
šlše
 
ušt64_t
 
¬t_size
(
¬t_Œ“
 *
t
);

369 
¬t_node
** 
	$fšd_chd
(
¬t_node
 *
n
, 
c
) {

370 
i
, 
mask
, 
b™f›ld
;

372 
¬t_node4
 *
p1
;

373 
¬t_node16
 *
p2
;

374 
¬t_node48
 *
p3
;

375 
¬t_node256
 *
p4
;

376 } 
p
;

377 
n
->
ty³
) {

378 
NODE4
:

379 
p
.
p1
 = (
¬t_node4
*)
n
;

380 
n
->
nv”s_
.
	`lock_exşusive
();

381 
i
=0 ; i < 
n
->
num_chd»n
; i++) {

385 ià(((*)
p
.
p1
->
keys
)[
i
] =ğ
c
) {

386 autØ
»t
 = &
p
.
p1
->
chd»n
[
i
];

387 
n
->
nv”s_
.
	`uÆock_exşusive
();

388  
»t
;

391 
n
->
nv”s_
.
	`uÆock_exşusive
();

395 
NODE16
:

396 
p
.
p2
 = (
¬t_node16
*)
n
;

397 
n
->
nv”s_
.
	`lock_exşusive
();

400 #ifdeà
__i386__


402 
__m128i
 
cmp
;

403 
cmp
 = 
	`_mm_cm³q_•i8
(
	`_mm_£t1_•i8
(
c
),

404 
	`_mm_lßdu_si128
((
__m128i
*)
p
.
p2
->
keys
));

407 
mask
 = (1 << 
n
->
num_chd»n
) - 1;

408 
b™f›ld
 = 
	`_mm_movemask_•i8
(
cmp
è& 
mask
;

410 #ifdeà
__amd64__


412 
__m128i
 
cmp
;

413 
cmp
 = 
	`_mm_cm³q_•i8
(
	`_mm_£t1_•i8
(
c
),

414 
	`_mm_lßdu_si128
((
__m128i
*)
p
.
p2
->
keys
));

417 
mask
 = (1 << 
n
->
num_chd»n
) - 1;

418 
b™f›ld
 = 
	`_mm_movemask_•i8
(
cmp
è& 
mask
;

421 
b™f›ld
 = 0;

422 
i
 = 0; i < 16; ++i) {

423 ià(
p
.
p2
->
keys
[
i
] =ğ
c
)

424 
b™f›ld
 |ğ(1 << 
i
);

428 
mask
 = (1 << 
n
->
num_chd»n
) - 1;

429 
b™f›ld
 &ğ
mask
;

438 ià(
b™f›ld
) {

439 autØ
»t
 = &
p
.
p2
->
chd»n
[
	`__butš_ùz
(
b™f›ld
)];

440 
n
->
nv”s_
.
	`uÆock_exşusive
();

441  
»t
;

443 
n
->
nv”s_
.
	`uÆock_exşusive
();

447 
NODE48
:

448 
p
.
p3
 = (
¬t_node48
*)
n
;

449 
n
->
nv”s_
.
	`lock_exşusive
();

450 
i
 = 
p
.
p3
->
keys
[
c
];

451 ià(
i
) {

452 autØ
»t
 = &
p
.
p3
->
chd»n
[
i
-1];

453 
n
->
nv”s_
.
	`uÆock_exşusive
();

454  
»t
;

456 
n
->
nv”s_
.
	`uÆock_exşusive
();

459 
NODE256
:

460 
p
.
p4
 = (
¬t_node256
*)
n
;

461 
n
->
nv”s_
.
	`lock_exşusive
();

462 ià(
p
.
p4
->
chd»n
[
c
]) {

463 autØ
»t
 = &
p
.
p4
->
chd»n
[
c
];

464 
n
->
nv”s_
.
	`uÆock_exşusive
();

465  
»t
;

467 
n
->
nv”s_
.
	`uÆock_exşusive
();

471 
	`abÜt
();

473  
NULL
;

474 
	}
}

478 
¬t_node
** 
	$fšd_chd_unsynch
(
¬t_node
 *
n
, 
c
) {

479 
i
, 
mask
, 
b™f›ld
;

481 
¬t_node4
 *
p1
;

482 
¬t_node16
 *
p2
;

483 
¬t_node48
 *
p3
;

484 
¬t_node256
 *
p4
;

485 } 
p
;

486 
n
->
ty³
) {

487 
NODE4
:

488 
p
.
p1
 = (
¬t_node4
*)
n
;

489 
i
=0 ; i < 
n
->
num_chd»n
; i++) {

493 ià(((*)
p
.
p1
->
keys
)[
i
] =ğ
c
) {

494 autØ
»t
 = &
p
.
p1
->
chd»n
[
i
];

495  
»t
;

501 
NODE16
:

502 
p
.
p2
 = (
¬t_node16
*)
n
;

505 #ifdeà
__i386__


507 
__m128i
 
cmp
;

508 
cmp
 = 
	`_mm_cm³q_•i8
(
	`_mm_£t1_•i8
(
c
),

509 
	`_mm_lßdu_si128
((
__m128i
*)
p
.
p2
->
keys
));

512 
mask
 = (1 << 
n
->
num_chd»n
) - 1;

513 
b™f›ld
 = 
	`_mm_movemask_•i8
(
cmp
è& 
mask
;

515 #ifdeà
__amd64__


517 
__m128i
 
cmp
;

518 
cmp
 = 
	`_mm_cm³q_•i8
(
	`_mm_£t1_•i8
(
c
),

519 
	`_mm_lßdu_si128
((
__m128i
*)
p
.
p2
->
keys
));

522 
mask
 = (1 << 
n
->
num_chd»n
) - 1;

523 
b™f›ld
 = 
	`_mm_movemask_•i8
(
cmp
è& 
mask
;

526 
b™f›ld
 = 0;

527 
i
 = 0; i < 16; ++i) {

528 ià(
p
.
p2
->
keys
[
i
] =ğ
c
)

529 
b™f›ld
 |ğ(1 << 
i
);

533 
mask
 = (1 << 
n
->
num_chd»n
) - 1;

534 
b™f›ld
 &ğ
mask
;

543 ià(
b™f›ld
) {

544 autØ
»t
 = &
p
.
p2
->
chd»n
[
	`__butš_ùz
(
b™f›ld
)];

545  
»t
;

550 
NODE48
:

551 
p
.
p3
 = (
¬t_node48
*)
n
;

552 
i
 = 
p
.
p3
->
keys
[
c
];

553 ià(
i
) {

554 autØ
»t
 = &
p
.
p3
->
chd»n
[
i
-1];

555  
»t
;

559 
NODE256
:

560 
p
.
p4
 = (
¬t_node256
*)
n
;

561 ià(
p
.
p4
->
chd»n
[
c
]) {

562 autØ
»t
 = &
p
.
p4
->
chd»n
[
c
];

563  
»t
;

568 
	`abÜt
();

570  
NULL
;

571 
	}
}

574 
šlše
 
	$mš
(
a
, 
b
) {

575  (
a
 < 
b
) ?‡ : b;

576 
	}
}

583 
	$check_´efix
(cÚ¡ 
¬t_node
 *
n
, cÚ¡ *
key
, 
key_Ën
, 
d•th
) {

590 
max_cmp
 = 
	`mš
(mš(
n
->
·¹Ÿl_Ën
, 
MAX_PREFIX_LEN
), 
key_Ën
 - 
d•th
);

591 
idx
;

592 
idx
=0; idx < 
max_cmp
; idx++) {

593 ià(
n
->
·¹Ÿl
[
idx
] !ğ
key
[
d•th
+idx])

594  
idx
;

596  
idx
;

597 
	}
}

605 
	$Ëaf_m©ches
(cÚ¡ 
¬t_Ëaf
 *
n
, cÚ¡ *
key
, 
key_Ën
, 
d•th
) {

606 ()
d•th
;

613 ià(
n
->
key_Ën
 !ğ(
ušt32_t
)key_len)  1;

616  
	`memcmp
(
n
->
key
, key, 
key_Ën
);

617 
	}
}

627 
¬t_Ëaf
* 
	$¬t_£¬ch
(cÚ¡ 
¬t_Œ“
 *
t
, cÚ¡ *
key
, 
key_Ën
) {

628 
	`´štf
("COUNTER %02zu TID %d‡¹ s—rchƒÁ”ed\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
());

629 
¬t_node
 **
chd
;

630 
	`´štf
("COUNTER %02zu TID %d„oÙ i %p\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
t
->
roÙ
);

631 
	`´štf
("COUNTER %02zu TID %d„oÙ†ock i %p\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
t
->
roÙ
->
nv”s_
);

632 ((
¬t_node
*)
	`LEAF_RAW
(
t
->
roÙ
))->
nv”s_
.
	`lock_exşusive
();

633 
	`¦“p
(1);

634 
	`´štf
("COUNTER %02zu TID %d„oÙ†ocked i %p\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
t
->
roÙ
->
nv”s_
);

635 ((
¬t_node
*)
	`LEAF_RAW
(
t
->
roÙ
))->
nv”s_
.
	`uÆock_exşusive
();

636 
	`´štf
("COUNTER %02zu TID %d„oÙ uÆocked i %p\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
t
->
roÙ
->
nv”s_
);

637 
¬t_node
 *
n
 = 
t
->
roÙ
;

639 
	`´štf
("COUNTER %02zu TID %d„oÙ†ocked\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
());

640 
´efix_Ën
, 
d•th
 = 0;

641 
n
) {

643 ià(
	`IS_LEAF
(
n
)) {

644 autØ
nŞd
 = 
n
;

645 
n
 = (
¬t_node
*)
	`LEAF_RAW
(n);

646 
	`´štf
("COUNTER %02zu TID %d old‚ i %p,‚ew‚ i %p\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
nŞd
, 
n
);

648 ià(!
	`Ëaf_m©ches
((
¬t_Ëaf
*)
n
, 
key
, 
key_Ën
, 
d•th
)) {

650 
	`´štf
("COUNTER %02zu TID %d 0 uÆocked‚\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
());

651  ((
¬t_Ëaf
*)
n
);

654 
	`´štf
("COUNTER %02zu TID %d 1 uÆocked‚\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
());

655  
NULL
;

659 ià(
n
->
·¹Ÿl_Ën
) {

660 
´efix_Ën
 = 
	`check_´efix
(
n
, 
key
, 
key_Ën
, 
d•th
);

661 ià(
´efix_Ën
 !ğ
	`mš
(
MAX_PREFIX_LEN
, 
n
->
·¹Ÿl_Ën
)) {

662 
	`´štf
("COUNTER %02zu TID %d 2 uÆocked‚\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
());

664  
NULL
;

666 
d•th
 = d•th + 
n
->
·¹Ÿl_Ën
;

670 
chd
 = 
	`fšd_chd_unsynch
(
n
, 
key
[
d•th
]);

671 if(
chd
) {

672 autØ
‹mp
 = *
chd
;

673 
	`´štf
("COUNTER %02zu TID %d‚exˆlocked\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
());

675 
	`´štf
("COUNTER %02zu TID %d 3 uÆocked‚\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
());

677 
n
 = 
‹mp
;

679 
	`´štf
("COUNTER %02zu TID %d 4 uÆocked‚\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
());

682 
n
 = 
NULL
;

684 
d•th
++;

686  
NULL
;

687 
	}
}

694 
¬t_Ëaf
* 
	$mšimum
(
¬t_node
 *
n
,‡¹_nod*
´ev
 = 
NULL
) {

696 ià(!
n
) {

697 ià(
´ev
) {

698 
´ev
->
nv”s_
.
	`uÆock_exşusive
();

700  
NULL
;

702 ià(
	`IS_LEAF
(
n
)) {

703 ià(
´ev
) {

704 
´ev
->
nv”s_
.
	`uÆock_exşusive
();

706  
	`LEAF_RAW
(
n
);

709 
n
->
nv”s_
.
	`lock_exşusive
();

710 ià(
´ev
) {

711 
´ev
->
nv”s_
.
	`uÆock_exşusive
();

714 
idx
;

715 
n
->
ty³
) {

716 
NODE4
:

717  
	`mšimum
(((
¬t_node4
*)
n
)->
chd»n
[0],‚);

718 
NODE16
:

719  
	`mšimum
(((
¬t_node16
*)
n
)->
chd»n
[0],‚);

720 
NODE48
:

721 
idx
=0;

722 !((
¬t_node48
*)
n
)->
keys
[
idx
]) idx++;

723 
idx
 = ((
¬t_node48
*)
n
)->
keys
[idx] - 1;

724  
	`mšimum
(((
¬t_node48
*)
n
)->
chd»n
[
idx
],‚);

725 
NODE256
:

726 
idx
=0;

727 !((
¬t_node256
*)
n
)->
chd»n
[
idx
]) idx++;

728  
	`mšimum
(((
¬t_node256
*)
n
)->
chd»n
[
idx
],‚);

730 
	`abÜt
();

732 
	}
}

736 
¬t_Ëaf
* 
	$maximum
(
¬t_node
 *
n
,‡¹_nod*
´ev
 = 
NULL
) {

738 ià(!
n
) {

739 ià(
´ev
) {

740 
´ev
->
nv”s_
.
	`uÆock_exşusive
();

742  
NULL
;

744 ià(
	`IS_LEAF
(
n
)) {

745 ià(
´ev
) {

746 
´ev
->
nv”s_
.
	`uÆock_exşusive
();

748  
	`LEAF_RAW
(
n
);

751 
n
->
nv”s_
.
	`lock_exşusive
();

752 ià(
´ev
) {

753 
´ev
->
nv”s_
.
	`uÆock_exşusive
();

756 
idx
;

757 
n
->
ty³
) {

758 
NODE4
:

760  
	`maximum
(((
¬t_node4
*)
n
)->
chd»n
[n->
num_chd»n
-1],‚);

761 
NODE16
:

762  
	`maximum
(((
¬t_node16
*)
n
)->
chd»n
[n->
num_chd»n
-1],‚);

763 
NODE48
:

764 
idx
=255;

765 !((
¬t_node48
*)
n
)->
keys
[
idx
]) idx--;

766 
idx
 = ((
¬t_node48
*)
n
)->
keys
[idx] - 1;

767  
	`maximum
(((
¬t_node48
*)
n
)->
chd»n
[
idx
],‚);

768 
NODE256
:

769 
idx
=255;

770 !((
¬t_node256
*)
n
)->
chd»n
[
idx
]) idx--;

771  
	`maximum
(((
¬t_node256
*)
n
)->
chd»n
[
idx
],‚);

773 
	`abÜt
();

775 
	}
}

780 
¬t_Ëaf
* 
	$¬t_mšimum
(
¬t_Œ“
 *
t
) {

781  
	`mšimum
((
¬t_node
*)
t
->
roÙ
);

782 
	}
}

787 
¬t_Ëaf
* 
	$¬t_maximum
(
¬t_Œ“
 *
t
) {

788  
	`maximum
((
¬t_node
*)
t
->
roÙ
);

789 
	}
}

792 
¬t_Ëaf
* 
	$make_Ëaf
(cÚ¡ *
key
, 
key_Ën
, *
v®ue
) {

793 
¬t_Ëaf
 *
l
 = (¬t_Ëaf*)
	`ÿÎoc
(1, ×¹_Ëaf)+
key_Ën
);

794 
l
->
v”s
 = 
	`TV”siÚ
();

795 
l
->
v®ue
 = value;

796 
l
->
key_Ën
 = key_len;

797 
	`memıy
(
l
->
key
, key, 
key_Ën
);

798  
l
;

799 
	}
}

803 
	$lÚge¡_commÚ_´efix
(
¬t_Ëaf
 *
l1
,‡¹_Ëaà*
l2
, 
d•th
) {

804 
max_cmp
 = 
	`mš
(
l1
->
key_Ën
, 
l2
->key_Ënè- 
d•th
;

805 
idx
;

806 
idx
=0; idx < 
max_cmp
; idx++) {

807 ià(
l1
->
key
[
d•th
+
idx
] !ğ
l2
->key[depth+idx])

808  
idx
;

810  
idx
;

811 
	}
}

813 
	$cİy_h—d”
(
¬t_node
 *
de¡
,‡¹_nod*
¤c
) {

814 
de¡
->
num_chd»n
 = 
¤c
->num_children;

815 
de¡
->
·¹Ÿl_Ën
 = 
¤c
->partial_len;

816 
	`memıy
(
de¡
->
·¹Ÿl
, 
¤c
->·¹Ÿl, 
	`mš
(
MAX_PREFIX_LEN
, src->
·¹Ÿl_Ën
));

817 
	}
}

819 
	$add_chd256
(
¬t_node256
 *
n
, 
¬t_node
 **
»f
, 
c
, *
chd
) {

820 ()
»f
;

821 
n
->n.
num_chd»n
++;

822 
n
->
chd»n
[
c
] = (
¬t_node
*)
chd
;

823 
	}
}

825 
	$add_chd48
(
¬t_node48
 *
n
, 
¬t_node
 **
»f
, 
c
, *
chd
) {

826 ià(
n
->n.
num_chd»n
 < 48) {

827 
pos
 = 0;

828 
n
->
chd»n
[
pos
])…os++;

829 
n
->
chd»n
[
pos
] = (
¬t_node
*)
chd
;

830 
n
->
keys
[
c
] = 
pos
 + 1;

831 
n
->n.
num_chd»n
++;

833 
¬t_node256
 *
Ãw_node
 = (¬t_node256*)
	`®loc_node
(
NODE256
);

834 
i
=0;i<256;i++) {

835 ià(
n
->
keys
[
i
]) {

836 
Ãw_node
->
chd»n
[
i
] = 
n
->chd»n[n->
keys
[i] - 1];

839 
	`cİy_h—d”
((
¬t_node
*)
Ãw_node
, (¬t_node*)
n
);

840 *
»f
 = (
¬t_node
*)
Ãw_node
;

841 
	`ä“
(
n
);

842 
	`add_chd256
(
Ãw_node
, 
»f
, 
c
, 
chd
);

844 
	}
}

846 
	$add_chd16
(
¬t_node16
 *
n
, 
¬t_node
 **
»f
, 
c
, *
chd
) {

847 ià(
n
->n.
num_chd»n
 < 16) {

848 
mask
 = (1 << 
n
->n.
num_chd»n
) - 1;

851 #ifdeà
__i386__


852 
__m128i
 
cmp
;

855 
cmp
 = 
	`_mm_cm¶t_•i8
(
	`_mm_£t1_•i8
(
c
),

856 
	`_mm_lßdu_si128
((
__m128i
*)
n
->
keys
));

859 
b™f›ld
 = 
	`_mm_movemask_•i8
(
cmp
è& 
mask
;

861 #ifdeà
__amd64__


862 
__m128i
 
cmp
;

865 
cmp
 = 
	`_mm_cm¶t_•i8
(
	`_mm_£t1_•i8
(
c
),

866 
	`_mm_lßdu_si128
((
__m128i
*)
n
->
keys
));

869 
b™f›ld
 = 
	`_mm_movemask_•i8
(
cmp
è& 
mask
;

872 
b™f›ld
 = 0;

873 
i
 = 0; i < 16; ++i) {

874 ià(
c
 < 
n
->
keys
[
i
])

875 
b™f›ld
 |ğ(1 << 
i
);

879 
b™f›ld
 &ğ
mask
;

884 
idx
;

885 ià(
b™f›ld
) {

886 
idx
 = 
	`__butš_ùz
(
b™f›ld
);

887 
	`memmove
(
n
->
keys
+
idx
+1,n->keys+idx,n->n.
num_chd»n
-idx);

888 
	`memmove
(
n
->
chd»n
+
idx
+1,n->children+idx,

889 (
n
->n.
num_chd»n
-
idx
)*(*));

891 
idx
 = 
n
->n.
num_chd»n
;

894 
n
->
keys
[
idx
] = 
c
;

895 
n
->
chd»n
[
idx
] = (
¬t_node
*)
chd
;

896 
n
->n.
num_chd»n
++;

899 
¬t_node48
 *
Ãw_node
 = (¬t_node48*)
	`®loc_node
(
NODE48
);

902 
	`memıy
(
Ãw_node
->
chd»n
, 
n
->children,

903 (*)*
n
->n.
num_chd»n
);

904 
i
=0;i<
n
->n.
num_chd»n
;i++) {

905 
Ãw_node
->
keys
[
n
->keys[
i
]] = i + 1;

907 
	`cİy_h—d”
((
¬t_node
*)
Ãw_node
, (¬t_node*)
n
);

908 *
»f
 = (
¬t_node
*)
Ãw_node
;

909 
	`ä“
(
n
);

910 
	`add_chd48
(
Ãw_node
, 
»f
, 
c
, 
chd
);

912 
	}
}

914 
	$add_chd4
(
¬t_node4
 *
n
, 
¬t_node
 **
»f
, 
c
, *
chd
) {

915 ià(
n
->n.
num_chd»n
 < 4) {

916 
idx
;

917 
idx
=0; idx < 
n
->n.
num_chd»n
; idx++) {

918 ià(
c
 < 
n
->
keys
[
idx
]) ;

922 
	`memmove
(
n
->
keys
+
idx
+1,‚->keys+idx,‚->n.
num_chd»n
 - idx);

923 
	`memmove
(
n
->
chd»n
+
idx
+1,‚->children+idx,

924 (
n
->n.
num_chd»n
 - 
idx
)*(*));

927 
n
->
keys
[
idx
] = 
c
;

928 
n
->
chd»n
[
idx
] = (
¬t_node
*)
chd
;

929 
n
->n.
num_chd»n
++;

932 
¬t_node16
 *
Ãw_node
 = (¬t_node16*)
	`®loc_node
(
NODE16
);

935 
	`memıy
(
Ãw_node
->
chd»n
, 
n
->children,

936 (*)*
n
->n.
num_chd»n
);

937 
	`memıy
(
Ãw_node
->
keys
, 
n
->keys,

938 ()*
n
->n.
num_chd»n
);

939 
	`cİy_h—d”
((
¬t_node
*)
Ãw_node
, (¬t_node*)
n
);

940 *
»f
 = (
¬t_node
*)
Ãw_node
;

941 
	`ä“
(
n
);

942 
	`add_chd16
(
Ãw_node
, 
»f
, 
c
, 
chd
);

944 
	}
}

946 
	$add_chd
(
¬t_node
 *
n
,‡¹_nod**
»f
, 
c
, *
chd
) {

947 
n
->
ty³
) {

948 
NODE4
:

949  
	`add_chd4
((
¬t_node4
*)
n
, 
»f
, 
c
, 
chd
);

950 
NODE16
:

951  
	`add_chd16
((
¬t_node16
*)
n
, 
»f
, 
c
, 
chd
);

952 
NODE48
:

953  
	`add_chd48
((
¬t_node48
*)
n
, 
»f
, 
c
, 
chd
);

954 
NODE256
:

955  
	`add_chd256
((
¬t_node256
*)
n
, 
»f
, 
c
, 
chd
);

957 
	`abÜt
();

959 
	}
}

964 
	$´efix_mism©ch
(cÚ¡ 
¬t_node
 *
n
, cÚ¡ *
key
, 
key_Ën
, 
d•th
) {

965 
max_cmp
 = 
	`mš
(mš(
MAX_PREFIX_LEN
, 
n
->
·¹Ÿl_Ën
), 
key_Ën
 - 
d•th
);

966 
idx
;

967 
idx
=0; idx < 
max_cmp
; idx++) {

968 ià(
n
->
·¹Ÿl
[
idx
] !ğ
key
[
d•th
+idx])

969  
idx
;

973 ià(
n
->
·¹Ÿl_Ën
 > 
MAX_PREFIX_LEN
) {

975 
¬t_Ëaf
 *
l
 = 
	`mšimum
((
¬t_node
*è
n
);

976 
max_cmp
 = 
	`mš
(
l
->
key_Ën
, key_Ën)- 
d•th
;

977 ; 
idx
 < 
max_cmp
; idx++) {

978 ià(
l
->
key
[
idx
+
d•th
] != key[depth+idx])

979  
idx
;

982  
idx
;

983 
	}
}

985 
¬t_Ëaf
* 
	$»cursive_š£¹
(
¬t_node
 *
n
,‡¹_nod**
»f
, cÚ¡ *
key
, 
key_Ën
, *
v®ue
, 
d•th
, *
Şd
) {

987 ià(!
n
) {

988 
¬t_Ëaf
* 
l
 = 
	`make_Ëaf
(
key
, 
key_Ën
, 
v®ue
);

989 *
»f
 = (
¬t_node
*è
	`SET_LEAF
(
l
);

990  
l
;

994 ià(
	`IS_LEAF
(
n
)) {

995 
¬t_Ëaf
 *
l
 = 
	`LEAF_RAW
(
n
);

998 ià(!
	`Ëaf_m©ches
(
l
, 
key
, 
key_Ën
, 
d•th
)) {

999 *
Şd
 = 1;

1000 
l
->
v®ue
 = value;

1001  
l
;

1005 
¬t_node4
 *
Ãw_node
 = (¬t_node4*)
	`®loc_node
(
NODE4
);

1008 
¬t_Ëaf
 *
l2
 = 
	`make_Ëaf
(
key
, 
key_Ën
, 
v®ue
);

1011 
lÚge¡_´efix
 = 
	`lÚge¡_commÚ_´efix
(
l
, 
l2
, 
d•th
);

1012 
Ãw_node
->
n
.
·¹Ÿl_Ën
 = 
lÚge¡_´efix
;

1013 
	`memıy
(
Ãw_node
->
n
.
·¹Ÿl
, 
key
+
d•th
, 
	`mš
(
MAX_PREFIX_LEN
, 
lÚge¡_´efix
));

1015 *
»f
 = (
¬t_node
*)
Ãw_node
;

1016 
	`add_chd4
(
Ãw_node
, 
»f
, 
l
->
key
[
d•th
+
lÚge¡_´efix
], 
	`SET_LEAF
(l));

1017 
	`add_chd4
(
Ãw_node
, 
»f
, 
l2
->
key
[
d•th
+
lÚge¡_´efix
], 
	`SET_LEAF
(l2));

1018  
l
;

1022 ià(
n
->
·¹Ÿl_Ën
) {

1024 
´efix_diff
 = 
	`´efix_mism©ch
(
n
, 
key
, 
key_Ën
, 
d•th
);

1025 ià((
ušt32_t
)
´efix_diff
 >ğ
n
->
·¹Ÿl_Ën
) {

1026 
d•th
 +ğ
n
->
·¹Ÿl_Ën
;

1027 
RECURSE_SEARCH
;

1031 
¬t_node4
 *
Ãw_node
 = (¬t_node4*)
	`®loc_node
(
NODE4
);

1032 *
»f
 = (
¬t_node
*)
Ãw_node
;

1033 
Ãw_node
->
n
.
·¹Ÿl_Ën
 = 
´efix_diff
;

1034 
	`memıy
(
Ãw_node
->
n
.
·¹Ÿl
,‚->·¹Ÿl, 
	`mš
(
MAX_PREFIX_LEN
, 
´efix_diff
));

1037 ià(
n
->
·¹Ÿl_Ën
 <ğ
MAX_PREFIX_LEN
) {

1038 
	`add_chd4
(
Ãw_node
, 
»f
, 
n
->
·¹Ÿl
[
´efix_diff
],‚);

1039 
n
->
·¹Ÿl_Ën
 -ğ(
´efix_diff
+1);

1040 
	`memmove
(
n
->
·¹Ÿl
,‚->·¹Ÿl+
´efix_diff
+1,

1041 
	`mš
(
MAX_PREFIX_LEN
, 
n
->
·¹Ÿl_Ën
));

1043 
n
->
·¹Ÿl_Ën
 -ğ(
´efix_diff
+1);

1044 
¬t_Ëaf
 *
l
 = 
	`mšimum
(
n
);

1045 
	`add_chd4
(
Ãw_node
, 
»f
, 
l
->
key
[
d•th
+
´efix_diff
], 
n
);

1046 
	`memıy
(
n
->
·¹Ÿl
, 
l
->
key
+
d•th
+
´efix_diff
+1,

1047 
	`mš
(
MAX_PREFIX_LEN
, 
n
->
·¹Ÿl_Ën
));

1051 
¬t_Ëaf
 *
l
 = 
	`make_Ëaf
(
key
, 
key_Ën
, 
v®ue
);

1052 
	`add_chd4
(
Ãw_node
, 
»f
, 
key
[
d•th
+
´efix_diff
], 
	`SET_LEAF
(
l
));

1053  
l
;

1056 
RECURSE_SEARCH
:;

1059 
¬t_node
 **
chd
 = 
	`fšd_chd
(
n
, 
key
[
d•th
]);

1060 ià(
chd
) {

1061  
	`»cursive_š£¹
(*
chd
, chd, 
key
, 
key_Ën
, 
v®ue
, 
d•th
+1, 
Şd
);

1065 
¬t_Ëaf
 *
l
 = 
	`make_Ëaf
(
key
, 
key_Ën
, 
v®ue
);

1066 
	`add_chd
(
n
, 
»f
, 
key
[
d•th
], 
	`SET_LEAF
(
l
));

1067  
l
;

1068 
	}
}

1079 
¬t_Ëaf
* 
	$¬t_š£¹
(
¬t_Œ“
 *
t
, cÚ¡ *
key
, 
key_Ën
, *
v®ue
, 
boŞ
* 
Ãw_š£¹
) {

1080 
Şd_v®
 = 0;

1081 
¬t_Ëaf
* 
Ãw_Ëaf
 = 
	`»cursive_š£¹
(
t
->
roÙ
, &t->roÙ, 
key
, 
key_Ën
, 
v®ue
, 0, &
Şd_v®
);

1082 ià(!
Şd_v®
) {

1083 
t
->
size
++;

1084 
	`´štf
("COUNTER %02zu TID %d‚ew in£¹\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
());

1085 *
Ãw_š£¹
 = 
Œue
;

1087 *
Ãw_š£¹
 = 
çl£
;

1089 
	`´štf
("COUNTER %02zu TID %d‡¹ in£¹„‘uºšg %p,‚ew in£¹ i %d\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
Ãw_Ëaf
, *
Ãw_š£¹
);

1090  
Ãw_Ëaf
;

1091 
	}
}

1093 
	$»move_chd256
(
¬t_node256
 *
n
, 
¬t_node
 **
»f
, 
c
) {

1094 
n
->
chd»n
[
c
] = 
NULL
;

1095 
n
->n.
num_chd»n
--;

1099 ià(
n
->n.
num_chd»n
 == 37) {

1100 
¬t_node48
 *
Ãw_node
 = (¬t_node48*)
	`®loc_node
(
NODE48
);

1101 *
»f
 = (
¬t_node
*)
Ãw_node
;

1102 
	`cİy_h—d”
((
¬t_node
*)
Ãw_node
, (¬t_node*)
n
);

1104 
pos
 = 0;

1105 
i
=0;i<256;i++) {

1106 ià(
n
->
chd»n
[
i
]) {

1107 
Ãw_node
->
chd»n
[
pos
] = 
n
->chd»n[
i
];

1108 
Ãw_node
->
keys
[
i
] = 
pos
 + 1;

1109 
pos
++;

1112 
	`ä“
(
n
);

1114 
	}
}

1116 
	$»move_chd48
(
¬t_node48
 *
n
, 
¬t_node
 **
»f
, 
c
) {

1117 
pos
 = 
n
->
keys
[
c
];

1118 
n
->
keys
[
c
] = 0;

1119 
n
->
chd»n
[
pos
-1] = 
NULL
;

1120 
n
->n.
num_chd»n
--;

1122 ià(
n
->n.
num_chd»n
 == 12) {

1123 
¬t_node16
 *
Ãw_node
 = (¬t_node16*)
	`®loc_node
(
NODE16
);

1124 *
»f
 = (
¬t_node
*)
Ãw_node
;

1125 
	`cİy_h—d”
((
¬t_node
*)
Ãw_node
, (¬t_node*)
n
);

1127 
chd
 = 0;

1128 
i
=0;i<256;i++) {

1129 
pos
 = 
n
->
keys
[
i
];

1130 ià(
pos
) {

1131 
Ãw_node
->
keys
[
chd
] = 
i
;

1132 
Ãw_node
->
chd»n
[
chd
] = 
n
->chd»n[
pos
 - 1];

1133 
chd
++;

1136 
	`ä“
(
n
);

1138 
	}
}

1140 
	$»move_chd16
(
¬t_node16
 *
n
, 
¬t_node
 **
»f
,‡¹_nod**
l
) {

1141 
pos
 = 
l
 - 
n
->
chd»n
;

1142 
	`memmove
(
n
->
keys
+
pos
,‚->keys+pos+1,‚->n.
num_chd»n
 - 1 -…os);

1143 
	`memmove
(
n
->
chd»n
+
pos
,‚->chd»n+pos+1, (n->n.
num_chd»n
 - 1 -…os)*(*));

1144 
n
->n.
num_chd»n
--;

1146 ià(
n
->n.
num_chd»n
 == 3) {

1147 
¬t_node4
 *
Ãw_node
 = (¬t_node4*)
	`®loc_node
(
NODE4
);

1148 *
»f
 = (
¬t_node
*)
Ãw_node
;

1149 
	`cİy_h—d”
((
¬t_node
*)
Ãw_node
, (¬t_node*)
n
);

1150 
	`memıy
(
Ãw_node
->
keys
, 
n
->keys, 4);

1151 
	`memıy
(
Ãw_node
->
chd»n
, 
n
->children, 4*(*));

1152 
	`ä“
(
n
);

1154 
	}
}

1156 
	$»move_chd4
(
¬t_node4
 *
n
, 
¬t_node
 **
»f
,‡¹_nod**
l
) {

1157 
pos
 = 
l
 - 
n
->
chd»n
;

1158 
	`memmove
(
n
->
keys
+
pos
,‚->keys+pos+1,‚->n.
num_chd»n
 - 1 -…os);

1159 
	`memmove
(
n
->
chd»n
+
pos
,‚->chd»n+pos+1, (n->n.
num_chd»n
 - 1 -…os)*(*));

1160 
n
->n.
num_chd»n
--;

1163 ià(
n
->n.
num_chd»n
 == 1) {

1164 
¬t_node
 *
chd
 = 
n
->
chd»n
[0];

1165 ià(!
	`IS_LEAF
(
chd
)) {

1167 
´efix
 = 
n
->n.
·¹Ÿl_Ën
;

1168 ià(
´efix
 < 
MAX_PREFIX_LEN
) {

1169 
n
->n.
·¹Ÿl
[
´efix
] =‚->
keys
[0];

1170 
´efix
++;

1172 ià(
´efix
 < 
MAX_PREFIX_LEN
) {

1173 
sub_´efix
 = 
	`mš
(
chd
->
·¹Ÿl_Ën
, 
MAX_PREFIX_LEN
 - 
´efix
);

1174 
	`memıy
(
n
->n.
·¹Ÿl
+
´efix
, 
chd
->·¹Ÿl, 
sub_´efix
);

1175 
´efix
 +ğ
sub_´efix
;

1179 
	`memıy
(
chd
->
·¹Ÿl
, 
n
->n.·¹Ÿl, 
	`mš
(
´efix
, 
MAX_PREFIX_LEN
));

1180 
chd
->
·¹Ÿl_Ën
 +ğ
n
->n.partial_len + 1;

1182 *
»f
 = 
chd
;

1183 
	`ä“
(
n
);

1185 
	}
}

1187 
	$»move_chd
(
¬t_node
 *
n
,‡¹_nod**
»f
, 
c
,‡¹_nod**
l
) {

1188 
n
->
ty³
) {

1189 
NODE4
:

1190  
	`»move_chd4
((
¬t_node4
*)
n
, 
»f
, 
l
);

1191 
NODE16
:

1192  
	`»move_chd16
((
¬t_node16
*)
n
, 
»f
, 
l
);

1193 
NODE48
:

1194  
	`»move_chd48
((
¬t_node48
*)
n
, 
»f
, 
c
);

1195 
NODE256
:

1196  
	`»move_chd256
((
¬t_node256
*)
n
, 
»f
, 
c
);

1198 
	`abÜt
();

1200 
	}
}

1202 
¬t_Ëaf
* 
	$»cursive_d–‘e
(
¬t_node
 *
n
,‡¹_nod**
»f
, cÚ¡ *
key
, 
key_Ën
, 
d•th
) {

1204 ià(!
n
è 
NULL
;

1207 ià(
	`IS_LEAF
(
n
)) {

1208 
¬t_Ëaf
 *
l
 = 
	`LEAF_RAW
(
n
);

1209 ià(!
	`Ëaf_m©ches
(
l
, 
key
, 
key_Ën
, 
d•th
)) {

1210 *
»f
 = 
NULL
;

1211  
l
;

1213  
NULL
;

1217 ià(
n
->
·¹Ÿl_Ën
) {

1218 
´efix_Ën
 = 
	`check_´efix
(
n
, 
key
, 
key_Ën
, 
d•th
);

1219 ià(
´efix_Ën
 !ğ
	`mš
(
MAX_PREFIX_LEN
, 
n
->
·¹Ÿl_Ën
)) {

1220  
NULL
;

1222 
d•th
 = d•th + 
n
->
·¹Ÿl_Ën
;

1226 
¬t_node
 **
chd
 = 
	`fšd_chd
(
n
, 
key
[
d•th
]);

1227 ià(!
chd
è 
NULL
;

1230 ià(
	`IS_LEAF
(*
chd
)) {

1231 
¬t_Ëaf
 *
l
 = 
	`LEAF_RAW
(*
chd
);

1232 ià(!
	`Ëaf_m©ches
(
l
, 
key
, 
key_Ën
, 
d•th
)) {

1233 
	`»move_chd
(
n
, 
»f
, 
key
[
d•th
], 
chd
);

1234  
l
;

1236  
NULL
;

1240  
	`»cursive_d–‘e
(*
chd
, chd, 
key
, 
key_Ën
, 
d•th
+1);

1242 
	}
}

1252 * 
	$¬t_d–‘e
(
¬t_Œ“
 *
t
, cÚ¡ *
key
, 
key_Ën
) {

1253 
¬t_Ëaf
 *
l
 = 
	`»cursive_d–‘e
(
t
->
roÙ
, &t->roÙ, 
key
, 
key_Ën
, 0);

1254 ià(
l
) {

1255 
t
->
size
--;

1256 *
Şd
 = 
l
->
v®ue
;

1257 
	`ä“
(
l
);

1258  
Şd
;

1260  
NULL
;

1261 
	}
}

1264 
	$»cursive_™”
(
¬t_node
 *
n
, 
¬t_ÿÎback
 
cb
, *
d©a
) {

1266 ià(!
n
)  0;

1267 ià(
	`IS_LEAF
(
n
)) {

1268 
¬t_Ëaf
 *
l
 = 
	`LEAF_RAW
(
n
);

1269  
	`cb
(
d©a
, (cÚ¡ *)
l
->
key
,†->
key_Ën
,†->
v®ue
);

1272 
idx
, 
»s
;

1273 
n
->
ty³
) {

1274 
NODE4
:

1275 
i
=0; i < 
n
->
num_chd»n
; i++) {

1276 
»s
 = 
	`»cursive_™”
(((
¬t_node4
*)
n
)->
chd»n
[
i
], 
cb
, 
d©a
);

1277 ià(
»s
) „es;

1281 
NODE16
:

1282 
i
=0; i < 
n
->
num_chd»n
; i++) {

1283 
»s
 = 
	`»cursive_™”
(((
¬t_node16
*)
n
)->
chd»n
[
i
], 
cb
, 
d©a
);

1284 ià(
»s
) „es;

1288 
NODE48
:

1289 
i
=0; i < 256; i++) {

1290 
idx
 = ((
¬t_node48
*)
n
)->
keys
[
i
];

1291 ià(!
idx
) ;

1293 
»s
 = 
	`»cursive_™”
(((
¬t_node48
*)
n
)->
chd»n
[
idx
-1], 
cb
, 
d©a
);

1294 ià(
»s
) „es;

1298 
NODE256
:

1299 
i
=0; i < 256; i++) {

1300 ià(!((
¬t_node256
*)
n
)->
chd»n
[
i
]) ;

1301 
»s
 = 
	`»cursive_™”
(((
¬t_node256
*)
n
)->
chd»n
[
i
], 
cb
, 
d©a
);

1302 ià(
»s
) „es;

1307 
	`abÜt
();

1310 
	}
}

1322 
	$¬t_™”
(
¬t_Œ“
 *
t
, 
¬t_ÿÎback
 
cb
, *
d©a
) {

1323  
	`»cursive_™”
(
t
->
roÙ
, 
cb
, 
d©a
);

1324 
	}
}

1330 
	$Ëaf_´efix_m©ches
(cÚ¡ 
¬t_Ëaf
 *
n
, cÚ¡ *
´efix
, 
´efix_Ën
) {

1332 ià(
n
->
key_Ën
 < (
ušt32_t
)
´efix_Ën
)  1;

1335  
	`memcmp
(
n
->
key
, 
´efix
, 
´efix_Ën
);

1336 
	}
}

1350 
	$¬t_™”_´efix
(
¬t_Œ“
 *
t
, cÚ¡ *
key
, 
key_Ën
, 
¬t_ÿÎback
 
cb
, *
d©a
) {

1351 
¬t_node
 **
chd
;

1352 
¬t_node
 *
n
 = 
t
->
roÙ
;

1353 
´efix_Ën
, 
d•th
 = 0;

1354 
n
) {

1356 ià(
	`IS_LEAF
(
n
)) {

1357 
n
 = (
¬t_node
*)
	`LEAF_RAW
(n);

1359 ià(!
	`Ëaf_´efix_m©ches
((
¬t_Ëaf
*)
n
, 
key
, 
key_Ën
)) {

1360 
¬t_Ëaf
 *
l
 = (¬t_Ëaf*)
n
;

1361  
	`cb
(
d©a
, (cÚ¡ *)
l
->
key
,†->
key_Ën
,†->
v®ue
);

1367 ià(
d•th
 =ğ
key_Ën
) {

1368 
¬t_Ëaf
 *
l
 = 
	`mšimum
(
n
);

1369 ià(!
	`Ëaf_´efix_m©ches
(
l
, 
key
, 
key_Ën
))

1370  
	`»cursive_™”
(
n
, 
cb
, 
d©a
);

1375 ià(
n
->
·¹Ÿl_Ën
) {

1376 
´efix_Ën
 = 
	`´efix_mism©ch
(
n
, 
key
, 
key_Ën
, 
d•th
);

1379 ià((
ušt32_t
)
´efix_Ën
 > 
n
->
·¹Ÿl_Ën
) {

1380 
´efix_Ën
 = 
n
->
·¹Ÿl_Ën
;

1384 ià(!
´efix_Ën
) {

1388 } ià(
d•th
 + 
´efix_Ën
 =ğ
key_Ën
) {

1389  
	`»cursive_™”
(
n
, 
cb
, 
d©a
);

1393 
d•th
 = d•th + 
n
->
·¹Ÿl_Ën
;

1397 
chd
 = 
	`fšd_chd
(
n
, 
key
[
d•th
]);

1398 
n
 = (
chd
è? *chd : 
NULL
;

1399 
d•th
++;

1402 
	}
}

	@datatype/Box.hh

1 #´agm¨
Úû


2 
	~"IÁ”çû.hh
"

3 
	~"v”siÚed_v®ue.hh
"

5 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gG’”icSTM
 = 
çl£
,y³Çm
	gSŒuùu»
 = 
v”siÚed_v®ue_¡ruù
<
T
>>

8 şas 
	cBox
 {

9 
public
:

10 
cÚ¡ex´
 
T¿nsI‹m
::
æags_ty³
 
v®id_Úly_b™
 = T¿nsI‹m::
u£r0_b™
;

12 
	$Box
(è: 
	`s_
(è, 
	$loÿl_lock
(
çl£
) {}

14 
T
 
	$un§ã_»ad
() const {

15  
s_
.
	`»ad_v®ue
();

16 
	}
}

18 
	$wr™e
(
T
 
v
) {

19 
boŞ
 
locked
 = 
	`Œy_lock
();

21 ià(!
locked
è
	`lock_loÿl
();

22 
s_
.
	`£t_v®ue
(
v
);

23 
T¿n§ùiÚTid
::
ty³
 
Ãwv
 = (
s_
.
	`v”siÚ
(è+ T¿n§ùiÚTid::
šüem’t_v®ue
è| T¿n§ùiÚTid::
nÚİaque_b™
;

24 
	`»Ëa£_ãnû
();

25 
s_
.
	`v”siÚ
(èğ
Ãwv
;

26 ià(!
locked
è
	`uÆock_loÿl
();

27 
	`uÆock
();

28 
	}
}

30 
	g´iv©e
:

31 
T¿n§ùiÚTid
::
	tty³
 
	tv”siÚ_ty³
;

33 
šlše
 
	$©omicR—d
(
v”siÚ_ty³
& 
v
, 
T
& 
v®
) {

34 
v”siÚ_ty³
 
v2
;

36 
v2
 = 
s_
.
	`v”siÚ
();

37 ià(
T¿n§ùiÚTid
::
	`is_locked
(
v2
))

38 
Sto
::
	`abÜt
();

39 
	`ãnû
();

40 
v®
 = 
s_
.
	`»ad_v®ue
();

41 
	`ãnû
();

42 
v
 = 
s_
.
	`v”siÚ
();

43 } 
v
 !ğ
v2
);

44 
	}
}

46 
	gpublic
:

47 
T
 
	$ŒªsR—d
(
T¿nsProxy
 
™em
) {

48 ià(
™em
.
	`has_wr™e
())

49  
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

51 
v”siÚ_ty³
 
v
;

52 
T
 
v®
;

53 
	`©omicR—d
(
v
, 
v®
);

54 ià(
G’”icSTM
)

55 
Sto
::
	`check_İac™y
(
v
);

56 ià(
™em
.
	`æags
(è& 
v®id_Úly_b™
) {

57 
™em
.
	`ş—r_»ad
();

58 
™em
.
	`ş—r_æags
(
v®id_Úly_b™
);

60 
™em
.
	`add_»ad
(
v
);

61  
v®
;

63 
	}
}

65 
	$ŒªsWr™e
(
T¿nsProxy
 
™em
, cÚ¡ 
T
& 
v
) {

66 
™em
.
	`add_wr™e
(
v
);

67 ià(!
™em
.
	`has_»ad
()) {

68 
™em
.
	`add_»ad
(
v
).
	`add_æags
(
v®id_Úly_b™
);

70 
	}
}

72 
	$lock
() {

73 
T¿n§ùiÚTid
::
	`lock
(
s_
.
	`v”siÚ
());

74 
	}
}

76 
boŞ
 
	$Œy_lock
() {

77  
T¿n§ùiÚTid
::
	`Œy_lock
(
s_
.
	`v”siÚ
());

78 
	}
}

80 
	$uÆock
() {

81 
	`lock_loÿl
();

82 
T¿n§ùiÚTid
::
	`uÆock
(
s_
.
	`v”siÚ
());

83 
	`uÆock_loÿl
();

84 
	}
}

86 
boŞ
 
	$is_locked_–£wh”e
() const {

87  
T¿n§ùiÚTid
::
	`is_locked_–£wh”e
(
s_
.
	`v”siÚ
());

88 
	}
}

89 
boŞ
 
	$check_v”siÚ
(
v”siÚ_ty³
 
v
) const {

90  
T¿n§ùiÚTid
::
	`check_v”siÚ
(
s_
.
	`v”siÚ
(), 
v
);

91 
	}
}

92 
	$š¡®l
(
T¿nsI‹m
& 
™em
, cÚ¡ 
T¿n§ùiÚ
& 
t
) {

93 
s_
.
	`£t_v®ue
(
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>());

94 ià(
G’”icSTM
) {

95 
T¿n§ùiÚTid
::
	`£t_v”siÚ
(
s_
.
	`v”siÚ
(), 
t
.
	`comm™_tid
());

97 
T¿n§ùiÚTid
::
	`šc_nÚİaque_v”siÚ
(
s_
.
	`v”siÚ
());

99 
	}
}

101 
	$lock_loÿl
() {

103 
boŞ
 
vv
 = 
loÿl_lock
;

104 ià(!
vv
 && 
	`boŞ_cmpxchg
(&
loÿl_lock
, vv, 
Œue
))

106 
	`»Ïx_ãnû
();

108 
	`acquœe_ãnû
();

109 
	}
}

110 
	$uÆock_loÿl
() {

111 
	`as£¹
(
loÿl_lock
 =ğ
Œue
);

112 
loÿl_lock
 = 
çl£
;

113 
	}
}

116 
	g´Ùeùed
:

118 
SŒuùu»
 
s_
;

119 
boŞ
 
	gloÿl_lock
;

	@datatype/Debug_rcu.hh

1 #´agm¨
Úû


5 #ià!
RCU


6 şas 
	cdebug_th»adšfo
 {

7 
	mpublic
:

9 
	$debug_th»adšfo
()

10 : 
	$ts_
(0) {

14 şas 
	crcu_ÿÎback
 {

15 
public
:

16 
vœtu®
 
	`İ”©Ü
()(
debug_th»adšfo
& 
ti
) = 0;

17 
	}
};

19 
	g´iv©e
:

20 
šlše
 
	$rcu_ÿÎback_funùiÚ
(* 
p
) {

21 
debug_th»adšfo
 
ti
;

22 
¡©ic_ÿ¡
<
rcu_ÿÎback
*>(
p
)->
	`İ”©Ü
()(
ti
);

23 
	}
}

26 
	gpublic
:

29 
kvtime¡amp_t
 
	$İ”©iÚ_time¡amp
() const {

31 
	}
}

32 
kvtime¡amp_t
 
	$upd©e_time¡amp
() const {

33  
ts_
;

34 
	}
}

35 
kvtime¡amp_t
 
	$upd©e_time¡amp
(
kvtime¡amp_t
 
x
) const {

36 ià(
cœcuÏr_št
<
kvtime¡amp_t
>::
	`Ëss_equ®
(
ts_
, 
x
))

38 
ts_
 = (
x
 | 1) + 1;

39  
ts_
;

40 
	}
}

41 
kvtime¡amp_t
 
	$upd©e_time¡amp
(
kvtime¡amp_t
 
x
, kvtime¡amp_ˆ
y
) const {

42 ià(
cœcuÏr_št
<
kvtime¡amp_t
>::
	`Ëss
(
x
, 
y
))

43 
x
 = 
y
;

44 ià(
cœcuÏr_št
<
kvtime¡amp_t
>::
	`Ëss_equ®
(
ts_
, 
x
))

46 
ts_
 = (
x
 | 1) + 1;

47  
ts_
;

48 
	}
}

49 
	$šüem’t_time¡amp
() {

50 
ts_
 += 2;

51 
	}
}

52 
	$advªû_time¡amp
(
kvtime¡amp_t
 
x
) {

53 ià(
cœcuÏr_št
<
kvtime¡amp_t
>::
	`Ëss
(
ts_
, 
x
))

54 
ts_
 = 
x
;

55 
	}
}

58 
	$m¬k
(
th»adcouÁ”
) {

59 
	}
}

60 
	$m¬k
(
th»adcouÁ”
, 
št64_t
) {

61 
	}
}

62 
boŞ
 
	$has_couÁ”
(
th»adcouÁ”
) const {

63  
çl£
;

64 
	}
}

65 
ušt64_t
 
	$couÁ”
(
th»adcouÁ”
) const {

67 
	}
}

73 
»Ïx_ãnû_funùiÚ
 
	$accouÁšg_»Ïx_ãnû
(
th»adcouÁ”
) {

74  
	`»Ïx_ãnû_funùiÚ
();

75 
	}
}

77 şas 
	caccouÁšg_»Ïx_ãnû_funùiÚ
 {

78 
	gpublic
:

79 
‹m¶©e
 <
ty³Çme
 
V
>

80 
İ”©Ü
()(
V
) {

81 
»Ïx_ãnû
();

88 
accouÁšg_»Ïx_ãnû_funùiÚ
 
	$¡abË_ãnû
() {

89  
	`accouÁšg_»Ïx_ãnû_funùiÚ
();

90 
	}
}

92 
»Ïx_ãnû_funùiÚ
 
	$lock_ãnû
(
th»adcouÁ”
) {

93  
	`»Ïx_ãnû_funùiÚ
();

94 
	}
}

96 * 
	$®loÿ‹
(
size_t
 
sz
, 
memg
) {

97  
	`m®loc
(
sz
);

98 
	}
}

99 
	$d—Îoÿ‹
(* , 
size_t
 , 
memg
) {

102 
	}
}

103 
	$d—Îoÿ‹_rcu
(*, 
size_t
 , 
memg
) {

104 
	}
}

106 * 
	$poŞ_®loÿ‹
(
size_t
 
sz
, 
memg
) {

107 
Æ
 = (
sz
 + 
CACHE_LINE_SIZE
 - 1) / CACHE_LINE_SIZE;

108  
	`m®loc
(
Æ
 * 
CACHE_LINE_SIZE
);

109 
	}
}

110 
	$poŞ_d—Îoÿ‹
(* , 
size_t
 , 
memg
) {

111 
	}
}

112 
	$poŞ_d—Îoÿ‹_rcu
(* , 
size_t
 , 
memg
) {

113 
	}
}

116 
	$rcu_»gi¡”
(
rcu_ÿÎback
 *) {

119 
	}
}

121 
	g´iv©e
:

122 
mubË
 
kvtime¡amp_t
 
ts_
;

	@datatype/Hashtable.hh

1 #´agm¨
Úû


2 
	~"cÚfig.h
"

3 
	~"comp”.hh
"

5 
	~<veùÜ
>

6 
	~"IÁ”çû.hh
"

7 
	~"T¿n§ùiÚ.hh
"

8 
	~"TW¿µed.hh
"

9 
	~"sim¶e_¡r.hh
"

10 
	~"´št_v®ue.hh
"

12 
	#HASHTABLE_DELETE
 1

	)

14 #iâdeà
READ_MY_WRITES


15 
	#READ_MY_WRITES
 1

	)

18 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gV
, 
boŞ
 
	gO·c™y
 = 
Œue
, 
	gIn™_size
 = 129,y³Çm
	gW
 = 
V
,y³Çm
	gHash
 = 
¡d
::
hash
<
K
>,y³Çm
	gP»d
 = std::
equ®_to
<K>>

19 #ifdeà
STO_NO_STM


20 şas 
	cHashbË
 {

22 şas 
	cHashbË
 : 
public
 
TObjeù
 {

24 
public
:

25 
K
 
	tKey
;

26 
K
 
	tkey_ty³
;

27 
V
 
	tV®ue
;

28 
W
 
	tV®ue_ty³
;

30 
ty³Çme
 
	t¡d
::
	tcÚd™iÚ®
<
	tO·c™y
, 
	tTV”siÚ
, 
	tTNÚİaqueV”siÚ
>::
	tty³
 
	tV”siÚ_ty³
;

31 
ty³Çme
 
	t¡d
::
	tcÚd™iÚ®
<
	tO·c™y
, 
	tTW¿µed
<
	tV®ue
>, 
	tTNÚİaqueW¿µed
<V®ue>>::
	tty³
 
	tw¿µed_ty³
;

33 
V
 
	twr™e_v®ue_ty³
;

35 
cÚ¡ex´
 
ty³Çme
 
	mV”siÚ_ty³
::
ty³
 
šv®id_b™
 = 
T¿n§ùiÚTid
::
u£r_b™
;

36 
	m´iv©e
:

39 
	sš‹º®_–em
 {

42 
Key
 
key
;

43 
š‹º®_–em
 *
	mÃxt
;

44 
V”siÚ_ty³
 
	mv”siÚ
;

45 
w¿µed_ty³
 
	mv®ue
;

46 #iâdeà
STO_NO_STM


47 
š‹º®_–em
(
Key
 
k
, 
V®ue
 
v®
, 
boŞ
 
m¬k_v®id
)

48 : 
key
(
k
), 
Ãxt
(
NULL
), 
v”siÚ
(
Sto
::
š™Ÿlized_tid
(è| (
m¬k_v®id
 ? 0 : 
šv®id_b™
)), 
v®ue
(
v®
) {}

49 
boŞ
 
v®id
() const {

50  !(
	mv”siÚ
.
v®ue
(è& 
	mšv®id_b™
);

53 
š‹º®_–em
(
Key
 
k
, 
V®ue
 
v®
, 
boŞ
)

54 : 
key
(
k
), 
Ãxt
(
NULL
), 
v”siÚ
(
Sto
::
š™Ÿlized_tid
()), 
v®ue
(
v®
) {}

58 
	sbuck‘_’Œy
 {

61 
š‹º®_–em
 *
	gh—d
;

66 
V”siÚ_ty³
 
	gv”siÚ
;

67 
buck‘_’Œy
(è: 
h—d
(
NULL
), 
v”siÚ
(0) {}

70 
	g¡d
::
	tveùÜ
<
	tbuck‘_’Œy
> 
	tM­Ty³
;

72 
M­Ty³
 
	gm­_
;

73 
Hash
 
	ghash”_
;

74 
P»d
 
	g´ed_
;

78 
cÚ¡ex´
 
ušŒ_t
 
	gbuck‘_b™
 = 1U<<0;

80 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
š£¹_b™
 = 
T¿nsI‹m
::
u£r0_b™
;

81 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
d–‘e_b™
 = 
T¿nsI‹m
::
u£r0_b™
<<1;

83 
	gpublic
:

84 
HashbË
(
size
 = 
In™_size
, 
Hash
 
h
 = Hash(), 
P»d
 
p
 = 
	$P»d
()è: 
	`m­_
(), 
	`hash”_
(
h
), 
	$´ed_
(
p
) {

85 
m­_
.
	`»size
(
size
);

86 
	}
}

88 
šlše
 
size_t
 
	$hash
(cÚ¡ 
Key
& 
k
) {

89  
	`hash”_
(
k
);

90 
	}
}

92 
šlše
 
size_t
 
	$nbuck‘s
() {

93  
m­_
.
	`size
();

94 
	}
}

96 
šlše
 
size_t
 
	$buck‘
(cÚ¡ 
Key
& 
k
) {

97  
	`hash
(
k
è% 
	`nbuck‘s
();

98 
	}
}

100 #iâdeà
STO_NO_STM


102 
	g‹m¶©e
 <
ty³Çme
 
	gKT
,y³Çm
	gVT
>

103 
boŞ
 
	$ŒªsG‘
(cÚ¡ 
KT
& 
k
, 
VT
& 
»tv®
) {

104 
buck‘_’Œy
& 
buck
 = 
	`buck_’Œy
(
k
);

105 
V”siÚ_ty³
 
buck_v”siÚ
 = 
buck
.
v”siÚ
;

106 
	`ãnû
();

107 
š‹º®_–em
 *
e
 = 
	`fšd
(
buck
, 
k
);

108 ià(
e
) {

109 autØ
™em
 = 
	`t_»ad_Úly_™em
(
e
);

110 ià(!
	`v®id™y_check
(
™em
, 
e
)) {

111 
Sto
::
	`abÜt
();

112  
çl£
;

114 #ià
READ_MY_WRITES


116 ià(
	`has_d–‘e
(
™em
)) {

117  
çl£
;

119 ià(
™em
.
	`has_wr™e
()) {

120 
»tv®
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
wr™e_v®ue_ty³
>();

121  
Œue
;

131 
»tv®
 = 
e
->
v®ue
.
	`»ad
(
™em
,ƒ->
v”siÚ
);

132  
Œue
;

134 
Sto
::
	`™em
(
this
, 
	`·ck_buck‘
(
	`buck‘
(
k
))).
	`ob£rve
(
	`V”siÚ_ty³
(
buck_v”siÚ
.
	`uÆocked
()));

137  
çl£
;

139 
	}
}

141 #ià
HASHTABLE_DELETE


143 
boŞ
 
	$ŒªsD–‘e
(cÚ¡ 
Key
& 
k
) {

144 
buck‘_’Œy
& 
buck
 = 
	`buck_’Œy
(
k
);

145 
V”siÚ_ty³
 
buck_v”siÚ
 = 
buck
.
v”siÚ
;

146 
	`ãnû
();

147 
š‹º®_–em
 *
e
 = 
	`fšd
(
buck
, 
k
);

148 ià(
e
) {

149 
V”siÚ_ty³
 
–emv”s
 = 
e
->
v”siÚ
;

150 
	`ãnû
();

151 autØ
™em
 = 
	`t_™em
(
e
);

152 
boŞ
 
v®id
 = 
e
->
	`v®id
();

153 #ià
READ_MY_WRITES


154 ià(!
v®id
 && 
	`has_š£¹
(
™em
)) {

156 
	`_»move
(
e
);

159 
™em
.
	`»move_»ad
().
	`»move_wr™e
().
	`ş—r_æags
(
š£¹_b™
 | 
d–‘e_b™
);

161 
Sto
::
	`™em
(
this
, 
	`·ck_buck‘
(
	`buck‘
(
k
))).
	`ob£rve
(
	`V”siÚ_ty³
(
buck_v”siÚ
.
	`uÆocked
()));

162  
Œue
;

165 ià(!
v®id
) {

166 
Sto
::
	`abÜt
();

167  
çl£
;

169 
	`as£¹
(
v®id
);

170 #ià
READ_MY_WRITES


172 ià(
	`has_d–‘e
(
™em
)) {

173  
çl£
;

177 
™em
.
	`ob£rve
(
–emv”s
);

182 
™em
.
	`add_wr™e
().
	`add_æags
(
d–‘e_b™
);

183  
Œue
;

186 
Sto
::
	`™em
(
this
, 
	`·ck_buck‘
(
	`buck‘
(
k
))).
	`ob£rve
(
	`V”siÚ_ty³
(
buck_v”siÚ
.
	`uÆocked
()));

189  
çl£
;

191 
	}
}

194 
	g´iv©e
:

196 
‹m¶©e
 <
boŞ
 
INSERT
, boŞ 
	gSET
, 
ty³Çme
 
	gKT
,y³Çm
	gVT
>

197 
boŞ
 
	$Œªs_wr™e
(cÚ¡ 
KT
& 
k
, cÚ¡ 
VT
& 
v
) {

199 
buck‘_’Œy
& 
buck
 = 
	`buck_’Œy
(
k
);

203 
	`lock
(
buck
.
v”siÚ
);

204 
š‹º®_–em
 *
e
 = 
	`fšd
(
buck
, 
k
);

205 ià(
e
) {

206 
	`uÆock
(
buck
.
v”siÚ
);

207 
V”siÚ_ty³
 
–emv”s
 = 
e
->
v”siÚ
;

208 
	`ãnû
();

209 autØ
™em
 = 
	`t_™em
(
e
);

210 ià(!
	`v®id™y_check
(
™em
, 
e
)) {

211 
Sto
::
	`abÜt
();

213  
çl£
;

215 #ià
READ_MY_WRITES


216 ià(
	`has_d–‘e
(
™em
)) {

219 ià(
INSERT
) {

220 
™em
.
	`ş—r_æags
(
d–‘e_b™
).
	`ş—r_wr™e
().
‹m¶©e
 
add_wr™e
<
wr™e_v®ue_ty³
>(
v
);

225  
çl£
;

229 #ià
HASHTABLE_DELETE


231 
™em
.
	`ob£rve
(
–emv”s
);

235 ià(
SET
) {

236 
™em
.
‹m¶©e
 
add_wr™e
<
wr™e_v®ue_ty³
>(
v
);

237 #ià
READ_MY_WRITES


238 ià(
	`has_š£¹
(
™em
)) {

240 
e
->
v®ue
.
	`wr™e
(
v
);

244  
Œue
;

246 ià(!
INSERT
) {

247 autØ
buck_v”s
 = 
buck
.
v”siÚ
.
	`uÆocked
();

248 
	`ãnû
();

249 
	`uÆock
(
buck
.
v”siÚ
);

250 
Sto
::
	`™em
(
this
, 
	`·ck_buck‘
(
	`buck‘
(
k
))).
	`ob£rve
(
	`V”siÚ_ty³
(
buck_v”s
));

253  
çl£
;

256 autØ
´ev_v”siÚ
 = 
buck
.
v”siÚ
.
	`uÆocked
();

258 
š£¹_locked
<
çl£
>(
buck
, 
k
, 
v
);

259 autØ
Ãw_h—d
 = 
buck
.
h—d
;

260 autØ
Ãw_v”siÚ
 = 
buck
.
v”siÚ
.
	`uÆocked
();

261 
	`ãnû
();

262 
	`uÆock
(
buck
.
v”siÚ
);

264 autØ
buck‘_™em
 = 
Sto
::
	`check_™em
(
this
, 
	`·ck_buck‘
(
	`buck‘
(
k
)));

265 ià(
buck‘_™em
) {

266 
buck‘_™em
->
	`upd©e_»ad
(
	`V”siÚ_ty³
(
´ev_v”siÚ
), V”siÚ_ty³(
Ãw_v”siÚ
));

270 autØ
™em
 = 
Sto
::
	`Ãw_™em
(
this
, 
Ãw_h—d
);

273 
™em
.
‹m¶©e
 
add_wr™e
<
wr™e_v®ue_ty³
>(
v
);

275 
™em
.
	`add_æags
(
š£¹_b™
);

276  
çl£
;

278 
	}
}

280 
	gpublic
:

281 
‹m¶©e
 <
ty³Çme
 
KT
,y³Çm
	gVT
>

282 
boŞ
 
	$ŒªsPut
(cÚ¡ 
KT
& 
k
, cÚ¡ 
VT
& 
v
) {

283  
Œªs_wr™e
< 
Œue
,rue>(
k
, 
v
);

284 
	}
}

287 
	g‹m¶©e
 <
ty³Çme
 
	gKT
,y³Çm
	gVT
>

288 
boŞ
 
	$ŒªsIn£¹
(cÚ¡ 
KT
& 
k
, cÚ¡ 
VT
& 
v
) {

289  !
Œªs_wr™e
< 
Œue
, 
çl£
>(
k
, 
v
);

290 
	}
}

292 
	g‹m¶©e
 <
ty³Çme
 
	gKT
,y³Çm
	gVT
>

293 
boŞ
 
	$ŒªsUpd©e
(cÚ¡ 
KT
& 
k
, cÚ¡ 
VT
& 
v
) {

294  
Œªs_wr™e
< 
çl£
, 
Œue
>(
k
, 
v
);

295 
	}
}

298 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
&è
ov”ride
 {

299 ià(
	`is_buck‘
(
™em
)) {

300 
buck‘_’Œy
& 
buck
 = 
m­_
[
	`buck‘_key
(
™em
)];

301  
buck
.
v”siÚ
.
	`check_v”siÚ
(
™em
.
‹m¶©e
 
»ad_v®ue
<
V”siÚ_ty³
>());

303 autØ
–
 = 
™em
.
key
<
š‹º®_–em
*>();

304 autØ
»ad_v”siÚ
 = 
™em
.
‹m¶©e
 
»ad_v®ue
<
V”siÚ_ty³
>();

309  
–
->
v”siÚ
.
	`check_v”siÚ
(
»ad_v”siÚ
);

310 
	}
}

312 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

313 
	`as£¹
(!
	`is_buck‘
(
™em
));

314 autØ
–
 = 
™em
.
key
<
š‹º®_–em
*>();

315  
txn
.
	`Œy_lock
(
™em
, 
–
->
v”siÚ
);

316 
	}
}

318 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
t
è
ov”ride
 {

319 
	`as£¹
(!
	`is_buck‘
(
™em
));

320 autØ
–
 = 
™em
.
key
<
š‹º®_–em
*>();

321 
	`as£¹
(
	`is_locked
(
–
));

323 ià(
™em
.
	`æags
(è& 
d–‘e_b™
) {

326 
–
->
v”siÚ
.
	`£t_v”siÚ_locked
Ól->v”siÚ.
	`v®ue
(è| 
šv®id_b™
);

331 ià(!(
™em
.
	`æags
(è& 
š£¹_b™
)) {

333 
V®ue
& 
Ãw_v
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
wr™e_v®ue_ty³
>();

334 
–
->
v®ue
.
	`wr™e
(
Ãw_v
);

340 
–
->
v”siÚ
.
	`£t_v”siÚ
(
t
.
	`comm™_tid
());

344 ià(
O·c™y
 && 
	`has_š£¹
(
™em
)) {

345 
buck‘_’Œy
& 
buck
 = 
	`buck_’Œy
(
–
->
key
);

346 
	`lock
(
buck
.
v”siÚ
);

349 ià(
buck
.
v”siÚ
.
	`v®ue
(è& 
T¿n§ùiÚTid
::
nÚİaque_b™
)

350 
buck
.
v”siÚ
.
	`£t_v”siÚ
(
t
.
	`comm™_tid
());

351 
	`uÆock
(
buck
.
v”siÚ
);

354 
	}
}

356 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

357 
	`as£¹
(!
	`is_buck‘
(
™em
));

358 autØ
–
 = 
™em
.
key
<
š‹º®_–em
*>();

359 
	`uÆock
(
–
->
v”siÚ
);

360 
	}
}

362 
	$ş—nup
(
T¿nsI‹m
& 
™em
, 
boŞ
 
comm™‹d
è
ov”ride
 {

363 ià(
comm™‹d
 ? 
	`has_d–‘e
(
™em
è: 
	`has_š£¹
(item)) {

364 autØ
–
 = 
™em
.
key
<
š‹º®_–em
*>();

365 
	`as£¹
(!
–
->
	`v®id
());

366 
	`_»move
(
–
);

368 
	}
}

372 
V®ue
 
	$ŒªsG‘
(
Key
 
k
) {

373 
V®ue
 
v
;

374 
	`ŒªsG‘
(
k
, 
v
);

375  
v
;

376 
	}
}

378 
V®ue
 
	$un§ã_g‘
(
Key
 
k
) {

379 ià(
V®ue
* 
p
 = 
	`»adPŒ
(
k
))

380  *
p
;

382  
	`V®ue
();

383 
	}
}

387 
boŞ
 
	$is_locked
(
š‹º®_–em
 *
–
) {

388  
	`is_locked
(
–
->
v”siÚ
);

389 
	}
}

391 
	$´št_¡©s
() {

392 
tÙ_couÁ
 = 0;

393 
max_chaššg
 = 0;

394 
num_em±y
 = 0;

396 
i
 = 0; i < 
m­_
.
	`size
(); ++i) {

397 
buck‘_’Œy
& 
buck
 = 
m­_
[
i
];

398 ià(!
buck
.
h—d
) {

399 
num_em±y
++;

402 
ù
 = 0;

403 
š‹º®_–em
 * 
li¡
 = 
buck
.
h—d
;

404 
li¡
) {

405 
ù
++;

406 
tÙ_couÁ
++;

407 
li¡
 =†i¡->
Ãxt
;

410 ià(
ù
 > 
max_chaššg
) max_chaining = ct;

413 
	`´štf
("TÙ® couÁ: %d, Em±y buck‘s: %d, Avg chaššg: %f, Max chaššg: %d\n", 
tÙ_couÁ
, 
num_em±y
, (()ÑÙ_couÁ))/(
m­_
.
	`size
(è-‚um_em±y), 
max_chaššg
);

414 
	}
}

416 
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
ècÚ¡ 
ov”ride
 {

417 
w
 << "{HashbË<" << 
	`ty³id
(
K
).
	`Çme
(è<< "," <<y³id(
V
).Çme(è<< "> " << (*è
this
;

418 ià(
	`is_buck‘
(
™em
)) {

419 
w
 << ".b[" << 
	`buck‘_key
(
™em
) << "]";

420 ià(
™em
.
	`has_»ad
())

421 
w
 << " R" << 
™em
.
»ad_v®ue
<
V”siÚ_ty³
>();

423 autØ
–
 = 
™em
.
key
<
š‹º®_–em
*>();

424 
w
 << "[" << 
mass
::
	`´št_v®ue
(
–
->
key
) << "]";

425 ià(
™em
.
	`has_»ad
())

426 
w
 << " R" << 
™em
.
»ad_v®ue
<
V”siÚ_ty³
>();

427 ià(
™em
.
	`has_wr™e
())

428 
w
 << " =" << 
mass
::
	`´št_v®ue
(
™em
.
wr™e_v®ue
<
wr™e_v®ue_ty³
>());

430 
w
 << "}";

431 
	}
}

433 
	$´št
() {

434 
	`´štf
("Hashtable:\n");

435 
i
 = 0; i < 
m­_
.
	`size
(); ++i) {

436 
buck‘_’Œy
& 
buck
 = 
m­_
[
i
];

437 ià(!
buck
.
h—d
)

439 
	`´štf
("buck‘ %d (v”siÚ %d): ", 
i
, 
buck
.
v”siÚ
);

440 
š‹º®_–em
 *
li¡
 = 
buck
.
h—d
;

441 
li¡
) {

442 
	`´štf
("key: %d, v®: %d, v”siÚ: %d, v®id: %d ; ", 
li¡
->
key
,†i¡->
v®ue
,†i¡->
v”siÚ
,†i¡->
	`v®id
());

443 
li¡
 =†i¡->
Ãxt
;

445 
	`´štf
("\n");

447 
	}
}

451 şas 
	ccÚ¡_™”©Ü
 {

452 
	gpublic
:

453 
¡d
::
·œ
<
Key
, 
	gV®ue
> 
	gİ”©Ü
*() const {

454  
	g¡d
::
make_·œ
(
node
->
key
,‚ode->
v®ue
);

457 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
++() {

458 ià(
	gnode
) {

459 
	gnode
 = 
node
->
Ãxt
;

461 !
	gnode
 && 
	gbuck‘
 !ğ
bË
->
m­_
.
size
()) {

462 
node
 = 
bË
->
m­_
[
buck‘
].
h—d
;

463 
	gbuck‘
++;

465  *
	gthis
;

468 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
cÚ¡_™”©Ü
& 
™
) const {

469  
node
 !ğ
™
.nod|| 
buck‘
 != it.bucket;

471 
	g´iv©e
:

472 cÚ¡ 
HashbË
 *
bË
;

473 
	gbuck‘
;

474 
š‹º®_–em
 *
	gnode
;

475 
ä›nd
 
şass
 
	gHashbË
;

478 
cÚ¡_™”©Ü
 
	$begš
() const {

479 
cÚ¡_™”©Ü
 
begš
;

480 
begš
.
bË
 = 
this
;

481 
begš
.
buck‘
 = -1;

482 
begš
.
node
 = 
NULL
;

483  ++
begš
;

484 
	}
}

485 
cÚ¡_™”©Ü
 
	$’d
() const {

486 
cÚ¡_™”©Ü
 
’d
;

487 
’d
.
buck‘
 = 
m­_
.
	`size
();

488 
’d
.
node
 = 
NULL
;

489  
’d
;

490 
	}
}

493 
	$_»move
(
š‹º®_–em
 *
–
) {

494 
buck‘_’Œy
& 
buck
 = 
	`buck_’Œy
(
–
->
key
);

495 
	`lock
(
buck
.
v”siÚ
);

496 
š‹º®_–em
 *
´ev
 = 
NULL
;

497 
š‹º®_–em
 *
cur
 = 
buck
.
h—d
;

498 
cur
 !ğ
NULL
 && cu¸!ğ
–
) {

499 
´ev
 = 
cur
;

500 
cur
 = cur->
Ãxt
;

502 
	`as£¹
(
cur
);

503 ià(
´ev
) {

504 
´ev
->
Ãxt
 = 
cur
->next;

506 
buck
.
h—d
 = 
cur
->
Ãxt
;

508 
	`uÆock
(
buck
.
v”siÚ
);

509 
T¿n§ùiÚ
::
	`rcu_d–‘e
(
cur
);

510 
	}
}

513 
boŞ
 
	$»move
(cÚ¡ 
Key
& 
k
) {

514 
buck‘_’Œy
& 
buck
 = 
	`buck_’Œy
(
k
);

515 
	`lock
(
buck
.
v”siÚ
);

516 
š‹º®_–em
 *
´ev
 = 
NULL
;

517 
š‹º®_–em
 *
cur
 = 
buck
.
h—d
;

518 
cur
 !ğ
NULL
 && !
	`´ed_
(cur->
key
, 
k
)) {

519 
´ev
 = 
cur
;

520 
cur
 = cur->
Ãxt
;

522 ià(!
cur
) {

523 
	`uÆock
(
buck
.
v”siÚ
);

524  
çl£
;

526 ià(
´ev
) {

527 
´ev
->
Ãxt
 = 
cur
->next;

529 
buck
.
h—d
 = 
cur
->
Ãxt
;

531 
	`uÆock
(
buck
.
v”siÚ
);

534  
Œue
;

535 
	}
}

537 
boŞ
 
	$»ad
(cÚ¡ 
Key
& 
k
, 
V®ue
& 
»tv®
) {

538 autØ
e
 = 
	`fšd
(
	`buck_’Œy
(
k
), k);

539 ià(
e
) {

541 
	`assign_v®
(
»tv®
, 
e
->
v®ue
.
	`acûss
());

543  !!
e
;

544 
	}
}

546 
	g‹m¶©e
 <
ty³Çme
 
	gV®Ty³
>

547 
	$assign_v®
(
V®Ty³
& 
v®
, cÚ¡ V®Ty³& 
v®_to_assign
) {

548 
v®
 = 
v®_to_assign
;

549 
	}
}

550 
	$assign_v®
(
¡d
::
¡ršg
& 
v®
, 
sim¶e_¡r
& 
v®_to_assign
) {

551 
v®
.
	`assign
(
v®_to_assign
.
	`d©a
(), v®_to_assign.
	`Ëngth
());

552 
	}
}

554 
V®ue
* 
	$»adPŒ
(cÚ¡ 
Key
& 
k
) {

555 autØ
e
 = 
	`fšd
(
	`buck_’Œy
(
k
), k);

556 ià(
e
) {

557  &
e
->
v®ue
.
	`acûss
();

559  
NULL
;

560 
	}
}

564 
V®ue
* 
	$putIfAb£ÁPŒ
(cÚ¡ 
Key
& 
k
, cÚ¡ 
V®ue
& 
v®
) {

565 
buck‘_’Œy
& 
buck
 = 
	`buck_’Œy
(
k
);

566 
	`lock
(
buck
.
v”siÚ
);

567 
š‹º®_–em
 *
e
 = 
	`fšd
(
buck
, 
k
);

568 ià(!
e
) {

569 
š£¹_locked
<
Œue
>(
buck
, 
k
, 
v®
);

570 
e
 = 
buck
.
h—d
;

572 
V®ue
 *
»t
 = &
e
->
v®ue
.
	`acûss
();

573 
	`uÆock
(
buck
.
v”siÚ
);

574  
»t
;

575 
	}
}

578 
boŞ
 
	$putIfAb£Á
(cÚ¡ 
Key
& 
k
, 
V®ue
& 
v®
) {

579 
boŞ
 
exi¡s
 = 
çl£
;

580 
buck‘_’Œy
& 
buck
 = 
	`buck_’Œy
(
k
);

581 
	`lock
(
buck
.
v”siÚ
);

582 
š‹º®_–em
 *
e
 = 
	`fšd
(
buck
, 
k
);

583 ià(
e
) {

584 
	`assign_v®
(
v®
, 
e
->
v®ue
.
	`acûss
());

585 
exi¡s
 = 
Œue
;

587 
š£¹_locked
<
Œue
>(
buck
, 
k
, 
v®
);

588 
exi¡s
 = 
çl£
;

590 
	`uÆock
(
buck
.
v”siÚ
);

591  
exi¡s
;

592 
	}
}

595 
	g‹m¶©e
 <
boŞ
 
	gIn£¹
 = 
Œue
, boŞ 
	gS‘
 =rue>

596 
boŞ
 
	$put
(cÚ¡ 
Key
& 
k
, cÚ¡ 
V®ue
& 
v®
) {

597 
boŞ
 
exi¡s
 = 
çl£
;

598 
buck‘_’Œy
& 
buck
 = 
	`buck_’Œy
(
k
);

599 
	`lock
(
buck
.
v”siÚ
);

600 
š‹º®_–em
 *
e
 = 
	`fšd
(
buck
, 
k
);

601 ià(
e
) {

603 ià(
S‘
)

604 
	`£t
(
e
, 
v®
);

605 
exi¡s
 = 
Œue
;

607 ià(
In£¹
)

608 
š£¹_locked
<
Œue
>(
buck
, 
k
, 
v®
);

609 
exi¡s
 = 
çl£
;

611 
	`uÆock
(
buck
.
v”siÚ
);

612  
exi¡s
;

613 
	}
}

617 
	g‹m¶©e
 <
boŞ
 
	gIn£¹
 = 
Œue
, boŞ 
	gS‘
 =rue>

618 
boŞ
 
	$put_g‘Şd
(cÚ¡ 
Key
& 
k
, cÚ¡ 
V®ue
& 
v®
, V®ue& 
Şdv®
) {

619 
boŞ
 
exi¡s
 = 
çl£
;

620 
buck‘_’Œy
& 
buck
 = 
	`buck_’Œy
(
k
);

621 
	`lock
(
buck
.
v”siÚ
);

622 
š‹º®_–em
 *
e
 = 
	`fšd
(
buck
, 
k
);

623 ià(
e
) {

624 
	`assign_v®
(
Şdv®
, 
e
->
v®ue
.
	`acûss
());

626 ià(
S‘
)

627 
	`£t
(
e
, 
v®
);

628 
exi¡s
 = 
Œue
;

630 ià(
In£¹
)

631 
š£¹_locked
<
Œue
>(
buck
, 
k
, 
v®
);

632 
exi¡s
 = 
çl£
;

634 
	`uÆock
(
buck
.
v”siÚ
);

635  
exi¡s
;

636 
	}
}

639 
boŞ
 
	$š£¹
(cÚ¡ 
Key
& 
k
, cÚ¡ 
V®ue
& 
v®
) {

640  !
put
<
Œue
, 
çl£
>(
k
, 
v®
);

641 
	}
}

643 
	$£t
(
š‹º®_–em
 *
e
, cÚ¡ 
V®ue
& 
v®
) {

644 
	`as£¹
(
e
);

647 
	`lock
(
e
->
v”siÚ
);

648 
e
->
v®ue
.
	`acûss
(èğ
v®
;

649 #iâdeà
STO_NO_STM


650 
e
->
v”siÚ
.
	`šc_nÚİaque_v”siÚ
();

652 
	`uÆock
(
e
->
v”siÚ
);

653 
	}
}

655 
boŞ
 
	$nÚŒªs_š£¹
(cÚ¡ 
Key
& 
k
, cÚ¡ 
V®ue
& 
v
è{  
	`š£¹
(k, v); 
	}
}

657 
boŞ
 
	$nÚŒªs_fšd
(cÚ¡ 
Key
& 
k
, 
V®ue
& 
v
è{  
	`»ad
(k, v); 
	}
}

659 
boŞ
 
	$nÚŒªs_»move
(cÚ¡ 
Key
& 
k
è{  
	`»move
(k); 
	}
}

662 
boŞ
 
	$nÚŒªs_»move
(cÚ¡ 
Key
& 
k
, 
V®ue
& 
Şdv®
è{ ià(
	`»ad
(k,Şdv®)è 
	`»move
(k);  
çl£
; 
	}
}

664 
	g´iv©e
:

665 
buck‘_’Œy
& 
	$buck_’Œy
(cÚ¡ 
Key
& 
k
) {

666  
m­_
[
	`buck‘
(
k
)];

667 
	}
}

670 
š‹º®_–em
* 
	$fšd
(
buck‘_’Œy
& 
buck
, cÚ¡ 
Key
& 
k
) {

671 
š‹º®_–em
 *
li¡
 = 
buck
.
h—d
;

672 
li¡
 && ! 
	`´ed_
Öi¡->
key
, 
k
)) {

673 
li¡
 =†i¡->
Ãxt
;

675  
li¡
;

676 
	}
}

679 
š‹º®_–em
* 
	$–em
(cÚ¡ 
Key
& 
k
) {

680  
	`fšd
(
	`buck_’Œy
(
k
), k);

681 
	}
}

683 
boŞ
 
	$has_d–‘e
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

684  
™em
.
	`æags
(è& 
d–‘e_b™
;

685 
	}
}

687 
boŞ
 
	$has_š£¹
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

688  
™em
.
	`æags
(è& 
š£¹_b™
;

689 
	}
}

691 
boŞ
 
	$v®id™y_check
(cÚ¡ 
T¿nsI‹m
& 
™em
, 
š‹º®_–em
 *
e
) {

692  
	`has_š£¹
(
™em
è|| 
e
->
	`v®id
();

693 
	}
}

696 
	$check_İac™y
(
V”siÚ
& 
v
) {

697 
	`as£¹
(
O·c™y
);

698 
V”siÚ
 
v2
 = 
v
;

699 
	`ãnû
();

700 
Sto
::
	`check_İac™y
(
v2
);

701 
	}
}

704 
boŞ
 
	$is_buck‘
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

705  
	`is_buck‘
(
™em
.
key
<*>());

706 
	}
}

707 
boŞ
 
	$is_buck‘
(* 
key
) {

708  (
ušŒ_t
)
key
 & 
buck‘_b™
;

709 
	}
}

710 
	$buck‘_key
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

711 
	`as£¹
(
	`is_buck‘
(
™em
));

712  (
ušŒ_t
è
™em
.
key
<*>() >> 1;

713 
	}
}

714 * 
	$·ck_buck‘
(
buck‘
) {

715  (*è((
buck‘
 << 1è| 
buck‘_b™
);

716 
	}
}

718 
boŞ
 
	$is_locked
(
V”siÚ_ty³
 &
v
) {

719  
v
.
	`is_locked
();

720 
	}
}

721 
	$lock
(
V”siÚ_ty³
& 
v
) {

722 
v
.
	`lock
();

723 
	}
}

724 
	$uÆock
(
V”siÚ_ty³
& 
v
) {

725 
v
.
	`uÆock
();

726 
	}
}

728 
	g‹m¶©e
 <
boŞ
 
	gm¬kV®id
>

729 
	$š£¹_locked
(
buck‘_’Œy
& 
buck
, cÚ¡ 
Key
& 
k
, cÚ¡ 
V®ue
& 
v®
) {

730 
	`as£¹
(
	`is_locked
(
buck
.
v”siÚ
));

731 autØ
Ãw_h—d
 = 
Ãw
 
	`š‹º®_–em
(
k
, 
v®
, 
m¬kV®id
);

732 
š‹º®_–em
 *
cur_h—d
 = 
buck
.
h—d
;

733 
Ãw_h—d
->
Ãxt
 = 
cur_h—d
;

734 
buck
.
h—d
 = 
Ãw_h—d
;

737 
buck
.
v”siÚ
.
	`šc_nÚİaque_v”siÚ
();

738 
	}
}

741 
	$©omicR—d
(
š‹º®_–em
 *
e
, 
V”siÚ
& 
v”s
, 
V®ue
& 
v®
) {

742 
V”siÚ
 
v2
;

744 
v2
 = 
e
->
v”siÚ
;

745 ià(
	`is_locked
(
v2
))

746 
Sto
::
	`abÜt
();

747 
	`ãnû
();

748 
	`assign_v®
(
v®
, 
e
->
v®ue
);

749 
	`ãnû
();

750 
v”s
 = 
e
->
v”siÚ
;

751 } 
v”s
 !ğ
v2
);

752 
	}
}

755 
T¿nsProxy
 
	$t_™em
(
š‹º®_–em
* 
e
) {

756  
Sto
::
	`™em
(
this
, 
e
);

757 
	}
}

759 
T¿nsProxy
 
	$t_»ad_Úly_™em
(
š‹º®_–em
* 
e
) {

760 #ià
READ_MY_WRITES


761  
Sto
::
	`»ad_™em
(
this
, 
e
);

763  
Sto
::
	`äesh_™em
(
this
, 
e
);

765 
	}
}

	@datatype/List.hh

1 #´agm¨
Úû


3 
	~"TaggedLow.hh
"

4 
	~"IÁ”çû.hh
"

6 #iâdeà
STO_NO_STM


7 
	~"T¿n§ùiÚ.hh
"

10 
	g‹m¶©e
<
ty³Çme
 
	gT
>

11 şas 
	cDeçuÉCom·»
 {

12 
	mpublic
:

13 
	$İ”©Ü
()(cÚ¡ 
T
& 
t1
, cÚ¡ T& 
t2
) {

14 ià(
t1
 < 
t2
)

16  
t2
 < 
t1
 ? 1 : 0;

18 
	}
};

20 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gDu¶iÿ‹s
 = 
çl£
,y³Çm
	gCom·»
 = 
DeçuÉCom·»
<
T
>, boŞ 
	gSÜ‹d
 = 
Œue
, boŞ 
	gO·c™y
 =rue> 
şass
 
Li¡I‹¿tÜ
;

22 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gDu¶iÿ‹s
 = 
çl£
,y³Çm
	gCom·»
 = 
DeçuÉCom·»
<
T
>, boŞ 
	gSÜ‹d
 = 
Œue
, boŞ 
	gO·c™y
 =rue>

23 
şass
 
Li¡


24 #iâdeà
STO_NO_STM


25 : 
public
 
TObjeù


28 
ä›nd
 
şass
 
Li¡I‹¿tÜ
<
T
, 
Du¶iÿ‹s
, 
Com·»
, 
SÜ‹d
, 
O·c™y
>;

29 
	gLi¡I‹¿tÜ
<
	tT
, 
	tDu¶iÿ‹s
, 
	tCom·»
, 
	tSÜ‹d
, 
	tO·c™y
> 
	t™”©Ü
;

30 
	gpublic
:

31 
Li¡
(
Com·»
 
comp
 = Com·»()è: 
h—d_
(
NULL
), 
li¡size_
(0), 
li¡lock_
(0), 
li¡v”siÚ_
(0), 
comp_
(comp) {

34 
	g´iv©e
:

36 
T¿n§ùiÚTid
::
	tty³
 
	tli¡_lock_ty³
;

37 
TV”siÚ
 
	tnode_v”siÚ_ty³
;

38 
TV”siÚ
 
	tli¡_v”siÚ_ty³
;

40 
	gpublic
:

41 
cÚ¡ex´
 
T¿n§ùiÚTid
::
ty³
 
šv®id_b™
 = T¿n§ùiÚTid::
u£r_b™
;

43 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
š£¹_b™
 = 
T¿nsI‹m
::
u£r0_b™
;

44 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
d–‘e_b™
 = 
T¿nsI‹m
::
u£r0_b™
<<1;

45 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
doupd©e_b™
 = 
T¿nsI‹m
::
u£r0_b™
<<2;

47 
	sli¡_node
 {

48 
li¡_node
(cÚ¡ 
T
& 
v®
,†i¡_nod*
Ãxt
, 
boŞ
 
šv®id
)

49 : 
v®
(v®), 
Ãxt
Òext), 
v”s
(
Sto
::
š™Ÿlized_tid
(è| (
šv®id
 ? (
šv®id_b™
 | 
T¿n§ùiÚTid
::
lock_b™
 | 
TTh»ad
::
id
()) : 0)) {

53 
m¬k_šv®id
(
boŞ
 
TxÇl
) {

54 
as£¹
(!
TxÇl
 || 
v”s
.
is_locked_h”e
());

55 autØ
	gÃw_v”siÚ
 = 
v”s
 | 
šv®id_b™
;

56 
ãnû
();

57 
	gv”s
 = 
Ãw_v”siÚ
;

60 
node_v”siÚ_ty³
 
v”siÚ
() {

61  
	gv”s
;

64 
£t_v”siÚ
(
node_v”siÚ_ty³
 
Ãw_v
) {

65 
	gv”s
.
£t_v”siÚ
(
Ãw_v
);

68 
£t_v”siÚ_uÆock
(
node_v”siÚ_ty³
 
Ãw_v
) {

69 
	gv”s
.
£t_v”siÚ_uÆock
(
Ãw_v
);

72 
boŞ
 
Œy_lock
() {

73  
	gv”s
.
Œy_lock
();

75 
uÆock
() {

76 
	gv”s
.
uÆock
();

79 
boŞ
 
is_v®id
() {

80  !(
	gv”s
.
v®ue
(è& 
	gšv®id_b™
);

83 
T
 
	gv®
;

84 
li¡_node
 *
	gÃxt
;

85 
node_v”siÚ_ty³
 
	gv”s
;

88 
cÚ¡ex´
 
li¡_node
* 
	gli¡_key
 = 
nuÎ±r
;

90 
šlše
 
li¡_node
* 
size_key
(è{  (
	gli¡_node
*)1; }

92 
boŞ
 
fšd
(cÚ¡ 
T
& 
–em
, T& 
v®
) {

93 autØ*
	g»t
 = 
_fšd
(
–em
);

94 ià(
	g»t
) {

95 
	gv®
 = 
»t
->
v®
;

97  !!
	g»t
;

100 
T
* 
fšd
(cÚ¡ T& 
–em
) {

101 autØ*
	g»t
 = 
_fšd
(
–em
);

102 ià(
	g»t
) {

103  &
	g»t
->
	gv®
;

105  
	gNULL
;

108 
li¡_node
* 
_fšd
(cÚ¡ 
T
& 
–em
) {

109 
li¡_node
 *
	gcur
 = 
h—d_
;

110 
	gcur
 !ğ
NULL
) {

111 
c
 = 
comp_
(
cur
->
v®
, 
–em
);

112 ià(
	gc
 == 0) {

113  
cur
;

115 ià(
	gSÜ‹d
 && 
	gc
 > 0) {

116  
	gNULL
;

118 
	gcur
 = 
cur
->
Ãxt
;

120  
	gNULL
;

123 
	g‹m¶©e
 <
boŞ
 
	gTxÇl
 = 
çl£
>

124 
li¡_node
* 
_š£¹
(cÚ¡ 
T
& 
–em
, 
boŞ
 *
š£¹ed
 = 
NULL
) {

125 ià(
š£¹ed
)

126 *
š£¹ed
 = 
Œue
;

127 
lock
(
li¡lock_
);

128 ià(!
	gSÜ‹d
 && !
	gDu¶iÿ‹s
) {

129 
li¡_node
 *
	gÃw_h—d
 = 
Ãw
†i¡_node(
–em
, 
h—d_
, 
TxÇl
);

130 
	gh—d_
 = 
Ãw_h—d
;

131 
uÆock
(
li¡lock_
);

132  
	gÃw_h—d
;

135 
li¡_node
 *
	g´ev
 = 
NULL
;

136 
li¡_node
 *
	gcur
 = 
h—d_
;

137 
	gcur
 !ğ
NULL
) {

138 
c
 = 
comp_
(
cur
->
v®
, 
–em
);

139 ià(!
	gDu¶iÿ‹s
 && 
	gc
 == 0) {

140 
uÆock
(
li¡lock_
);

141 ià(
	gš£¹ed
)

142 *
	gš£¹ed
 = 
çl£
;

143  
	gcur
;

144 } ià(
	gSÜ‹d
 && 
	gc
 >= 0) {

147 
	g´ev
 = 
cur
;

148 
	gcur
 = 
cur
->
Ãxt
;

150 autØ
	g»t
 = 
Ãw
 
li¡_node
(
–em
, 
cur
, 
TxÇl
);

151 ià(
	g´ev
) {

152 
	g´ev
->
	gÃxt
 = 
»t
;

154 
	gh—d_
 = 
»t
;

156 ià(!
	gTxÇl
)

157 
	gli¡size_
++;

158 
uÆock
(
li¡lock_
);

159  
	g»t
;

162 
boŞ
 
š£¹
(cÚ¡ 
T
& 
–em
) {

163 
boŞ
 
	gš£¹ed
;

164 
	g_š£¹
<
	gçl£
>(
	g–em
, &
	gš£¹ed
);

165  
	gš£¹ed
;

168 
	g‹m¶©e
 <
boŞ
 
	gTxÇl
>

169 
boŞ
 
»move
(cÚ¡ 
T
& 
–em
, boŞ 
locked
 = 
çl£
) {

170  
_»move
<
TxÇl
>([&] (
li¡_node
 *
n2
è{  
comp_
Ò2->
v®
, 
–em
è=ğ0; }, 
	glocked
);

173 
	g‹m¶©e
 <
boŞ
 
	gTxÇl
>

174 
boŞ
 
»move
(
li¡_node
 *
n
, boŞ 
locked
 = 
çl£
) {

177  
_»move
<
TxÇl
>([
n
] (
li¡_node
 *
n2
è{ ‚ =ğn2; }, 
	glocked
);

180 
	g‹m¶©e
 <
boŞ
 
	gTxÇl
, 
ty³Çme
 
	gFoundFunc
>

181 
boŞ
 
_»move
(
FoundFunc
 
found_f
, boŞ 
locked
 = 
çl£
) {

182 ià(!
locked
)

183 
lock
(
li¡lock_
);

184 
li¡_node
 *
	g´ev
 = 
NULL
;

185 
li¡_node
 *
	gcur
 = 
h—d_
;

186 
	gcur
 !ğ
NULL
) {

187 ià(
found_f
(
cur
)) {

188 
cur
->
m¬k_šv®id
(
TxÇl
);

189 ià(
	g´ev
) {

190 
	g´ev
->
	gÃxt
 = 
cur
->
Ãxt
;

192 
	gh—d_
 = 
cur
->
Ãxt
;

194 ià(
	gTxÇl
) {

195 
	gT¿n§ùiÚ
::
rcu_d–‘e
(
cur
);

197 
d–‘e
 
	gcur
;

199 ià(!
	gTxÇl
)

200 
	gli¡size_
--;

201 ià(!
	glocked
)

202 
uÆock
(
li¡lock_
);

203  
	gŒue
;

205 
	g´ev
 = 
cur
;

206 
	gcur
 = 
cur
->
Ãxt
;

208 ià(!
	glocked
)

209 
uÆock
(
li¡lock_
);

210  
	gçl£
;

213 #iâdeà
STO_NO_STM


214 
T
* 
ŒªsFšd
(cÚ¡ T& 
–em
) {

215 autØ
	gli¡v
 = 
li¡v”siÚ_
;

216 
ãnû
();

217 autØ*
	gn
 = 
_fšd
(
–em
);

218 ià(
	gn
) {

219 autØ
	gv”siÚ
 = 
n
->
v”siÚ
();

220 
ãnû
();

221 autØ
	g™em
 = 
t_™em
(
n
);

222 ià(!
v®id™yCheck
(
n
, 
™em
)) {

223 
	gSto
::
abÜt
();

224  
	gNULL
;

226 ià(
has_d–‘e
(
™em
)) {

227  
	gNULL
;

229 
	g™em
.
ob£rve
(
v”siÚ
);

232 
v”ify_li¡
(
li¡v
);

233  
	gNULL
;

235  &
	gn
->
	gv®
;

238 
boŞ
 
ŒªsIn£¹
(cÚ¡ 
T
& 
–em
) {

239 
boŞ
 
	gš£¹ed
;

240 autØ*
	gnode
 = 
_š£¹
<
Œue
>(
–em
, &
	gš£¹ed
);

241 autØ
	g™em
 = 
t_™em
(
node
);

242 ià(!
	gš£¹ed
) {

243 autØ
	gv”siÚ
 = 
node
->
v”siÚ
();

244 
ãnû
();

245 ià(!
v®id™yCheck
(
node
, 
™em
)) {

246 
	gSto
::
abÜt
();

247  
	gçl£
;

250 ià(
has_š£¹
(
™em
)) {

251  
	gçl£
;

254 ià(
has_doupd©e
(
™em
)) {

255  
	gçl£
;

258 ià(
has_d–‘e
(
™em
)) {

260 
	g™em
.
ş—r_wr™e
().
add_wr™e
(
–em
);

261 
	g™em
.
assign_æags
(
doupd©e_b™
);

262 
add_Œªs_size_offs
(1);

263  
	gŒue
;

267 
	g™em
.
ob£rve
(
v”siÚ
);

268  
	gçl£
;

270 
add_Œªs_size_offs
(1);

272 
add_lock_li¡_™em
();

273 
	g™em
.
add_wr™e
(0);

274 
	g™em
.
add_æags
(
š£¹_b™
);

275  
	gŒue
;

278 
boŞ
 
ŒªsD–‘e
(cÚ¡ 
T
& 
–em
) {

279 autØ
	gli¡v
 = 
li¡v”siÚ_
;

280 
ãnû
();

281 autØ*
	gn
 = 
_fšd
(
–em
);

282 ià(
	gn
) {

283 autØ
	gv”siÚ
 = 
n
->
v”siÚ
();

284 
ãnû
();

285 autØ
	g™em
 = 
t_™em
(
n
);

286 ià(!
v®id™yCheck
(
n
, 
™em
)) {

287 
	gSto
::
abÜt
();

288  
	gçl£
;

290 ià(
has_d–‘e
(
™em
)) {

292  
	gçl£
;

295 ià(
has_doupd©e
(
™em
)) {

297 
	g™em
.
assign_æags
(
d–‘e_b™
);

298 
add_Œªs_size_offs
(-1);

299  
	gŒue
;

302 ià(
has_š£¹
(
™em
)) {

303 
	g»move
<
	gŒue
>(
	gn
);

304 
	g™em
.
»move_»ad
().
»move_wr™e
().
ş—r_æags
(
š£¹_b™
);

305 
add_Œªs_size_offs
(-1);

308 
v”ify_li¡
(
li¡v
);

309  
	gŒue
;

311 
	g™em
.
assign_æags
(
d–‘e_b™
);

313 
	g™em
.
add_wr™e
(0);

316 
	g™em
.
ob£rve
(
v”siÚ
);

317 
add_lock_li¡_™em
();

318 
add_Œªs_size_offs
(-1);

319  
	gŒue
;

321 
v”ify_li¡
(
li¡v
);

322  
	gçl£
;

326 
šlše
 
li¡_v”siÚ_ty³
 
İac™y_check
() {

329 
as£¹
(
O·c™y
);

330 autØ
	gli¡v
 = 
li¡v”siÚ_
;

331 
ãnû
();

332 ià(
	gli¡v
.
is_locked_–£wh”e
()) {

333 
	gSto
::
abÜt
();

335 
	gSto
::
check_İac™y
(
li¡v
.
v®ue
());

336  
	gli¡v
;

339 
	gLi¡I‹r
;

341 
Li¡I‹r
 
ŒªsI‹r
() {

342 autØ
	gli¡v
 = 
li¡v”siÚ_
;

343 
ãnû
();

344 autØ
	gh—d
 = 
h—d_
;

345 
ãnû
();

346 ià(
	gli¡v
 !ğ
li¡v”siÚ_
)

347 
Sto
::
abÜt
();

348 
v”ify_li¡
(
li¡v
);

349  
Li¡I‹r
(
this
, 
h—d
, 
Œue
);

352 
size_t
 
size
() {

353 autØ
	gli¡v
 = 
li¡v”siÚ_
;

354 
ãnû
();

355 autØ
	gsize
 = 
li¡size_
;

356 
ãnû
();

358 ià(
	gli¡v
 !ğ
li¡v”siÚ_
)

359 
Sto
::
abÜt
();

360 
v”ify_li¡
(
li¡v
);

361  
	gsize
 + 
Œªs_size_offs
();

364 
size_t
 
nÚŒªs_size
() const {

365  
	gli¡size_
;

370 
™”©Ü
 
begš
(è{  i‹¿tÜ(
this
, 
h—d_
); }

371 
™”©Ü
 
’d
(è{  i‹¿tÜ(
this
, 
NULL
); }

373 
	sLi¡I‹r
 {

374 
Li¡I‹r
(è: 
us
(
NULL
), 
cur
(NULL) {}

376 
boŞ
 
v®id
() const {

377  
	gus
 !ğ
NULL
;

380 
boŞ
 
hasNext
() const {

381  !!
	gcur
;

384 
»£t
() {

385 
	gcur
 = 
us
->
h—d_
;

388 
T
* 
Ãxt
() {

389 autØ
	g»t
 = 
cur
 ? &cur->
v®
 : 
NULL
;

390 ià(
	gcur
)

391 
	gcur
 = 
cur
->
Ãxt
;

392  
	g»t
;

395 
boŞ
 
ŒªsHasNext
() const {

396  !!
	gcur
;

399 
ŒªsRe£t
() {

400 
	gcur
 = 
us
->
h—d_
;

401 
’su»V®id
();

404 
T
* 
ŒªsNext
() {

405 autØ
	g»t
 = 
cur
 ? &cur->
v®
 : 
NULL
;

406 ià(
	gcur
)

407 
	gcur
 = 
cur
->
Ãxt
;

408 
’su»V®id
();

409  
	g»t
;

412 
T
* 
ŒªsNthNext
(
n
) {

413 
T
* 
	g»t
 = 
NULL
;

414 
	gn
 > 0 && 
ŒªsHasNext
()) {

415 
	g»t
 = 
ŒªsNext
();

416 
	gn
--;

418 ià(
	gn
 == 0)

419  
»t
;

420  
	gNULL
;

423 
	g´iv©e
:

424 
Li¡I‹r
(
Li¡
 *
us
, 
li¡_node
 *
cur
, 
boŞ
 
Œªs
) : us(us), cur(cur) {

425 ià(
	gŒªs
)

426 
’su»V®id
();

429 
’su»V®id
() {

430 #iâdeà
STO_NO_STM


431 
	gcur
) {

436 autØ
	g™em
 = 
Sto
::
check_™em
(
us
, 
cur
);

437 ià(!
	gcur
->
is_v®id
()) {

438 ià(!
	g™em
 || !
	gus
->
has_š£¹
(*
™em
)) {

439 
	gSto
::
abÜt
();

441 
	gcur
 = 
cur
->
Ãxt
;

445 ià(
	g™em
 && 
	gus
->
has_d–‘e
(*
™em
)) {

446 
	gcur
 = 
cur
->
Ãxt
;

451 
ãnû
();

452 ià(
	gO·c™y
)

453 
	gus
->
İac™y_check
();

457 
ä›nd
 
şass
 
	gLi¡
;

458 
Li¡
 *
	gus
;

459 
li¡_node
 *
	gcur
;

462 
Li¡I‹r
 
™”
() {

463  
Li¡I‹r
(
this
, 
h—d_
, 
çl£
);

466 
size_t
 
un§ã_size
() const {

467  
	gli¡size_
;

470 
ş—r
() {

471 autØ
	g™em
 = 
h—d_
)

472 
»move
<
çl£
>(
h—d_
, 
	gŒue
);

475 
v”ify_li¡
(
li¡_v”siÚ_ty³
 
»adv
) {

476 
t_™em
(
li¡_key
).
ob£rve
(
»adv
);

477 
acquœe_ãnû
();

481 
lock
(
li¡_lock_ty³
& 
v
) {

482 
	gT¿n§ùiÚTid
::
lock
(
v
);

485 
uÆock
(
li¡_lock_ty³
& 
v
) {

486 
	gT¿n§ùiÚTid
::
uÆock
(
v
);

489 
boŞ
 
is_locked
(
li¡_lock_ty³
& 
v
) {

490  
	gT¿n§ùiÚTid
::
is_locked
(
v
);

493 #iâdeà
STO_NO_STM


494 
boŞ
 
lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
&è
	gov”ride
 {

495 
li¡_node
 *
	gn
 = 
™em
.
key
<list_node*>();

496 ià(
	gn
 =ğ
li¡_key
) {

497  
li¡v”siÚ_
.
Œy_lock
();

498 } ià(!
has_š£¹
(
™em
)) {

501  
	gn
->
Œy_lock
();

503  
	gŒue
;

506 
boŞ
 
check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
&è
	gov”ride
 {

507 ià(
	g™em
.
	gkey
<
	gli¡_node
*>(è=ğ
li¡_key
) {

508 autØ
lv
 = 
li¡v”siÚ_
;

509  
	glv
.
check_v”siÚ
(
™em
.
‹m¶©e
 
»ad_v®ue
<
li¡_v”siÚ_ty³
>());

511 autØ
	gn
 = 
™em
.
key
<
li¡_node
*>();

512 ià(!
	gn
->
is_v®id
()) {

513  
has_š£¹
(
™em
);

515  
	gn
->
v”siÚ
().
check_v”siÚ
(
™em
.
‹m¶©e
 
»ad_v®ue
<
node_v”siÚ_ty³
>());

518 
š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
t
è
	gov”ride
 {

521 ià(
	g™em
.
	gkey
<
	gli¡_node
*>(è=ğ
li¡_key
)

523 
li¡_node
 *
	gn
 = 
™em
.
key
<list_node*>();

524 ià(
has_d–‘e
(
™em
)) {

525 
	g»move
<
	gŒue
>(
	gn
,rue);

526 
	gli¡size_
--;

529 ià(
	gO·c™y
) {

530 
	gli¡v”siÚ_
.
£t_v”siÚ
(
t
.
comm™_tid
());

532 
	gli¡v”siÚ_
.
šc_nÚİaque_v”siÚ
();

534 } ià(
has_doupd©e
(
™em
)) {

535 
	gn
->
£t_v”siÚ
(
t
.
comm™_tid
());

536 
	gn
->
	gv®
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

540 
	gn
->
£t_v”siÚ_uÆock
(
t
.
comm™_tid
());

541 
	gli¡size_
++;

542 ià(
	gO·c™y
) {

543 
	gli¡v”siÚ_
.
£t_v”siÚ
(
t
.
comm™_tid
());

545 
	gli¡v”siÚ_
.
šc_nÚİaque_v”siÚ
();

550 
uÆock
(
T¿nsI‹m
& 
™em
è
	gov”ride
 {

551 autØ
	gn
 = 
™em
.
key
<
li¡_node
*>();

552 ià(
	gn
 =ğ
li¡_key
) {

553 
li¡v”siÚ_
.
uÆock
();

554 } ià(!
has_š£¹
(
™em
)) {

555 
	gn
->
uÆock
();

559 
ş—nup
(
T¿nsI‹m
& 
™em
, 
boŞ
 
comm™‹d
è
	gov”ride
 {

560 ià(!
	gcomm™‹d
 && (
	g™em
.
æags
(è& 
	gš£¹_b™
)) {

561 
li¡_node
 *
	gn
 = 
™em
.
key
<list_node*>();

562 
	g»move
<
	gŒue
>(
	gn
);

566 
T¿nsProxy
 
t_™em
(
li¡_node
* 
node
) {

568  
	gSto
::
™em
(
this
, 
node
);

571 
boŞ
 
has_š£¹
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

572  
	g™em
.
has_wr™e
(è&& !
has_d–‘e
(
™em
è&& !
has_doupd©e
(item);

575 
boŞ
 
has_d–‘e
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

576  
	g™em
.
æags
(è& 
	gd–‘e_b™
;

579 
boŞ
 
has_doupd©e
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

580  
	g™em
.
æags
(è& 
	gdoupd©e_b™
;

583 
add_lock_li¡_™em
() {

584 
t_™em
(
li¡_key
).
add_wr™e
(0);

587 
add_Œªs_size_offs
(
size_offs
) {

590 autØ
	g™em
 = 
t_™em
(
size_key
());

591 
	g™em
.
‹m¶©e
 
	g£t_¡ash
<>(™em.‹m¶©
	g¡ash_v®ue
<>(0è+ 
	gsize_offs
);

594 
Œªs_size_offs
() {

595  
t_™em
(
size_key
()).
‹m¶©e
 
	g¡ash_v®ue
<>(0);

599 
boŞ
 
v®id™yCheck
(
li¡_node
 *
n
, 
T¿nsI‹m
& 
™em
) {

600  
	gn
->
is_v®id
(è|| (
	g™em
.
æags
(è& 
	gš£¹_b™
);

603 
li¡_node
 *
	gh—d_
;

604 
	gli¡size_
;

605 
li¡_lock_ty³
 
	gli¡lock_
;

606 
li¡_v”siÚ_ty³
 
	gli¡v”siÚ_
;

607 
Com·»
 
	gcomp_
;

611 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gDu¶iÿ‹s
,y³Çm
	gCom·»
, boŞ 
	gSÜ‹d
, boŞ 
	gO·c™y
>

612 
şass
 
	gLi¡I‹¿tÜ
 : 
public
 
¡d
::
™”©Ü
<¡d::
fÜw¬d_™”©Ü_g
, 
	gT
> {

613 
	gLi¡I‹¿tÜ
<
	tT
, 
	tDu¶iÿ‹s
, 
	tCom·»
, 
	tSÜ‹d
, 
	tO·c™y
> 
	t™”©Ü
;

614 
	gLi¡
<
	tT
, 
	tDu¶iÿ‹s
, 
	tCom·»
, 
	tSÜ‹d
, 
	tO·c™y
> 
	tli¡_ty³
;

615 
ty³Çme
 
	tli¡_ty³
::
	tli¡_node
†ist_node;

616 
	gpublic
:

617 
Li¡I‹¿tÜ
(
li¡_ty³
 * 
li¡
, 
li¡_node
* 
±r
è: 
myLi¡
Öi¡), 
myPŒ
(ptr) {

618 
	gmyLi¡
->
li¡_v”ify
(
myLi¡
->
li¡v”siÚ_
);

620 
Li¡I‹¿tÜ
(cÚ¡ Li¡I‹¿tÜ& 
™r
è: 
myLi¡
(™r.myLi¡), 
myPŒ
(itr.myPtr) {}

622 
	gLi¡I‹¿tÜ
& 
	gİ”©Ü
ğ(cÚ¡ 
Li¡I‹¿tÜ
& 
v
) {

623 
myLi¡
 = 
v
.myList;

624 
	gmyPŒ
 = 
v
.
myPŒ
;

625  *
	gthis
;

628 
boŞ
 
	gİ”©Ü
==(
™”©Ü
 
Ùh”
) const {

629  (
myLi¡
 =ğ
Ùh”
.myLi¡è&& (
myPŒ
 == other.myPtr);

632 
boŞ
 
	gİ”©Ü
!=(
™”©Ü
 
Ùh”
) const {

633  !(
İ”©Ü
==(
Ùh”
));

636 
	gT
& 
	gİ”©Ü
*() {

637  
	gmyPŒ
->
	gv®
;

641 
šüem’t_±r
() {

642 ià(
	gmyPŒ
)

643 
	gmyPŒ
 = 
myPŒ
->
Ãxt
;

644 
	gmyPŒ
) {

646 autØ
	g™em
 = 
Sto
::
check_™em
(
myLi¡
, 
myPŒ
);

647 ià(!
	gmyPŒ
->
is_v®id
()) {

648 ià(!
	g™em
 || !
	gmyLi¡
->
has_š£¹
(*
™em
)) {

649 
	gSto
::
abÜt
();

651 
	gmyPŒ
 = 
myPŒ
->
Ãxt
;

655 ià(
	g™em
 && 
	gmyLi¡
->
has_d–‘e
(*
™em
)) {

656 
	gmyPŒ
 = 
myPŒ
->
Ãxt
;

664 
	g™”©Ü
& 
	gİ”©Ü
++() {

665 
šüem’t_±r
();

666  *
	gthis
;

670 
™”©Ü
 
	gİ”©Ü
++() {

671 
™”©Ü
 
şÚe
(*
this
);

672 
šüem’t_±r
();

673  
	gşÚe
;

676 
	g´iv©e
:

677 
li¡_ty³
 * 
myLi¡
;

678 
li¡_node
 * 
	gmyPŒ
;

	@datatype/List1.hh

1 #´agm¨
Úû


3 
	~"TaggedLow.hh
"

4 
	~"T¿n§ùiÚ.hh
"

5 
	~"Li¡.hh
"

6 
	~"SšgËEËm.hh
"

8 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gDu¶iÿ‹s
 = 
çl£
,y³Çm
	gCom·»
 = 
DeçuÉCom·»
<
T
>, boŞ 
	gSÜ‹d
 = 
Œue
, boŞ 
	gO·c™y
 = f®£,y³Çm
	gEËm
 = 
SšgËEËm
<T>> 
şass
 
Li¡1I‹¿tÜ
;

10 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gDu¶iÿ‹s
 = 
çl£
,y³Çm
	gCom·»
 = 
DeçuÉCom·»
<
T
>, boŞ 
	gSÜ‹d
 = 
Œue
, boŞ 
	gO·c™y
 = f®£,y³Çm
	gEËm
 = 
SšgËEËm
<T>>

11 şas 
	cLi¡1
 : 
public
 
TObjeù
 {

12 
ä›nd
 
şass
 
Li¡1I‹¿tÜ
<
T
, 
Du¶iÿ‹s
, 
Com·»
, 
SÜ‹d
, 
O·c™y
, 
EËm
>;

13 
	mLi¡1I‹¿tÜ
<
	tT
, 
	tDu¶iÿ‹s
, 
	tCom·»
, 
	tSÜ‹d
, 
	tO·c™y
, 
	tEËm
> 
	t™”©Ü
;

14 
	mpublic
:

15 
Li¡1
(
Com·»
 
comp
 = 
	$Com·»
()è: 
	`h—d_
(
NULL
), 
	`li¡size_
(0), 
	`li¡v”siÚ_
(0), 
	$comp_
(
comp
) {

18 
´iv©e
:

19 
T¿n§ùiÚTid
::
	tty³
 
	tv”siÚ_ty³
;

21 
public
:

22 
cÚ¡ex´
 
ušt8_t
 
šv®id_b™
 = 1<<0;

24 
cÚ¡ex´
 
T¿nsI‹m
::
æags_ty³
 
š£¹_b™
 = T¿nsI‹m::
u£r0_b™
;

25 
cÚ¡ex´
 
T¿nsI‹m
::
æags_ty³
 
d–‘e_b™
 = T¿nsI‹m::
u£r0_b™
<<1;

26 
cÚ¡ex´
 
T¿nsI‹m
::
æags_ty³
 
doupd©e_b™
 = T¿nsI‹m::
u£r0_b™
<<2;

28 
cÚ¡ex´
 * 
size_key
 = (*)0;

30 
	sli¡_node
 {

31 
	`li¡_node
(cÚ¡ 
T
& 
v®_
, 
li¡_node
 *
Ãxt
, 
boŞ
 
šv®id
)

32 : 
	`v®
(), 
	`Ãxt
(
Ãxt
, 
šv®id
 ? 
šv®id_b™
 : 0) {

33 
v®
.
	`wr™e
(
v®_
);

36 
	`m¬k_šv®id
() {

37 
Ãxt
.
	`Ü_æags
(
šv®id_b™
);

40 
	`m¬k_v®id
() {

41 
Ãxt
.
	`assign_æags
Òext.
	`æags
(è& ~
šv®id_b™
);

44 
boŞ
 
	`is_v®id
() {

45  !(
Ãxt
.
	`æags
(è& 
šv®id_b™
);

48 
EËm
 
v®
;

49 
TaggedLow
<
li¡_node
> 
Ãxt
;

50 
	}
};

52 
boŞ
 
	$fšd
(cÚ¡ 
T
& 
–em
, T& 
v®
) {

53 autØ*
»t
 = 
	`_fšd
(
–em
);

54 ià(
»t
) {

55 
v®
 = 
»t
->val;

57  !!
»t
;

58 
	}
}

60 
boŞ
 
	$fšd
(cÚ¡ 
T
& 
–em
) {

61 autØ*
»t
 = 
	`_fšd
(
–em
);

62 ià(
»t
) {

63  
Œue
;

65  
çl£
;

66 
	}
}

68 
boŞ
 
	$ŒªsFšd
(cÚ¡ 
T
& 
–em
) {

69 autØ
li¡v
 = 
li¡v”siÚ_
;

70 
	`ãnû
();

71 autØ*
n
 = 
	`_fšd
(
–em
);

72 ià(
n
) {

73 autØ
™em
 = 
	`t_™em
(
n
);

74 ià(!
	`v®id™yCheck
(
n
, 
™em
)) {

75 
Sto
::
	`abÜt
();

76  
çl£
;

78 ià(
	`has_d–‘e
(
™em
)) {

79  
çl£
;

81 
™em
.
	`add_»ad
(0);

84 
	`v”ify_li¡
(
li¡v
);

85  
çl£
;

87  
Œue
;

88 
	}
}

90 
li¡_node
* 
	$_fšd
(cÚ¡ 
T
& 
–em
) {

91 
li¡_node
 *
cur
 = 
h—d_
;

92 
cur
 !ğ
NULL
) {

93 
c
 = 
	`comp_
(
cur
->
v®
, 
–em
);

94 ià(
c
 == 0) {

95  
cur
;

97 ià(
SÜ‹d
 && 
c
 > 0) {

98  
NULL
;

100 
cur
 = cur->
Ãxt
;

102  
NULL
;

103 
	}
}

105 
	g‹m¶©e
 <
boŞ
 
	gTxÇl
 = 
çl£
>

106 
li¡_node
* 
	$_š£¹
(cÚ¡ 
T
& 
–em
, 
boŞ
 *
š£¹ed
 = 
NULL
) {

107 ià(
š£¹ed
)

108 *
š£¹ed
 = 
Œue
;

109 
	`lock
(
li¡v”siÚ_
);

110 ià(!
SÜ‹d
 && !
Du¶iÿ‹s
) {

111 
li¡_node
 *
Ãw_h—d
 = 
Ãw
 
	`li¡_node
(
–em
, 
h—d_
, 
TxÇl
);

112 
h—d_
 = 
Ãw_h—d
;

113 
	`uÆock
(
li¡v”siÚ_
);

114  
Ãw_h—d
;

117 
li¡_node
 *
´ev
 = 
NULL
;

118 
li¡_node
 *
cur
 = 
h—d_
;

119 
cur
 !ğ
NULL
) {

120 
c
 = 
	`comp_
(
cur
->
v®
, 
–em
);

121 ià(!
Du¶iÿ‹s
 && 
c
 == 0) {

122 
	`uÆock
(
li¡v”siÚ_
);

123 ià(
š£¹ed
)

124 *
š£¹ed
 = 
çl£
;

125  
cur
;

126 } ià(
SÜ‹d
 && 
c
 >= 0) {

129 
´ev
 = 
cur
;

130 
cur
 = cur->
Ãxt
;

132 autØ
»t
 = 
Ãw
 
	`li¡_node
(
–em
, 
cur
, 
TxÇl
);

133 ià(
´ev
) {

134 
´ev
->
Ãxt
.
	`assign_±r
(
»t
);

136 
h—d_
 = 
»t
;

138 ià(!
TxÇl
)

139 
li¡size_
++;

140 
	`uÆock
(
li¡v”siÚ_
);

141  
»t
;

142 
	}
}

144 
boŞ
 
	$š£¹
(cÚ¡ 
T
& 
–em
) {

145 
boŞ
 
š£¹ed
;

146 
_š£¹
<
çl£
>(
–em
, &
š£¹ed
);

147  
š£¹ed
;

148 
	}
}

150 
boŞ
 
	$ŒªsIn£¹
(cÚ¡ 
T
& 
–em
) {

151 
boŞ
 
š£¹ed
;

152 autØ*
node
 = 
_š£¹
<
Œue
>(
–em
, &
š£¹ed
);

153 autØ
™em
 = 
	`t_™em
(
node
);

154 ià(!
š£¹ed
) {

155 ià(!
	`v®id™yCheck
(
node
, 
™em
)) {

156 
Sto
::
	`abÜt
();

157  
çl£
;

160 ià(
	`has_š£¹
(
™em
)) {

161  
çl£
;

164 ià(
	`has_doupd©e
(
™em
)) {

165  
çl£
;

168 ià(
	`has_d–‘e
(
™em
)) {

169 
™em
.
	`ş—r_wr™e
().
	`add_wr™e
(
–em
);

170 
™em
.
	`assign_æags
(
doupd©e_b™
);

171 
	`add_Œªs_size_offs
(1);

172  
Œue
;

176 
™em
.
	`add_»ad
(0);

177  
çl£
;

179 
	`add_Œªs_size_offs
(1);

181 
	`add_lock_li¡_™em
();

182 
™em
.
	`add_wr™e
(0);

183 
™em
.
	`add_æags
(
š£¹_b™
);

184  
Œue
;

185 
	}
}

187 
boŞ
 
	$ŒªsD–‘e
(cÚ¡ 
T
& 
–em
) {

188 autØ
li¡v
 = 
li¡v”siÚ_
;

189 
	`ãnû
();

190 autØ*
n
 = 
	`_fšd
(
–em
);

191 ià(
n
) {

192 autØ
™em
 = 
	`t_™em
(
n
);

193 ià(!
	`v®id™yCheck
(
n
, 
™em
)) {

194 
Sto
::
	`abÜt
();

195  
çl£
;

197 ià(
	`has_d–‘e
(
™em
)) {

199  
çl£
;

202 ià(
	`has_doupd©e
(
™em
)) {

204 
™em
.
	`assign_æags
(
d–‘e_b™
);

205 
	`add_Œªs_size_offs
(-1);

206  
Œue
;

209 ià(
	`has_š£¹
(
™em
)) {

210 
»move
<
Œue
>(
n
);

211 
™em
.
	`»move_»ad
().
	`»move_wr™e
().
	`ş—r_æags
(
š£¹_b™
);

212 
	`add_Œªs_size_offs
(-1);

215 
	`v”ify_li¡
(
li¡v
);

216  
Œue
;

218 
™em
.
	`assign_æags
(
d–‘e_b™
);

220 
™em
.
	`add_wr™e
(0);

223 
™em
.
	`add_»ad
(0);

224 
	`add_lock_li¡_™em
();

225 
	`add_Œªs_size_offs
(-1);

226  
Œue
;

228 
	`v”ify_li¡
(
li¡v
);

229  
çl£
;

231 
	}
}

233 
	g‹m¶©e
 <
boŞ
 
	gTxÇl
>

234 
boŞ
 
	$»move
(cÚ¡ 
T
& 
–em
, 
boŞ
 
locked
 = 
çl£
) {

235  
_»move
<
TxÇl
>([&] (
li¡_node
 *
n2
è{  
	`comp_
Ò2->
v®
, 
–em
è=ğ0; }, 
locked
);

236 
	}
}

238 
	g‹m¶©e
 <
boŞ
 
	gTxÇl
>

239 
boŞ
 
	$»move
(
li¡_node
 *
n
, 
boŞ
 
locked
 = 
çl£
) {

242  
_»move
<
TxÇl
>([
n
] (
li¡_node
 *
n2
è{ ‚ =ğn2; }, 
locked
);

243 
	}
}

245 
	g‹m¶©e
 <
boŞ
 
	gTxÇl
, 
ty³Çme
 
	gFoundFunc
>

246 
boŞ
 
	$_»move
(
FoundFunc
 
found_f
, 
boŞ
 
locked
 = 
çl£
) {

247 ià(!
locked
)

248 
	`lock
(
li¡v”siÚ_
);

249 
li¡_node
 *
´ev
 = 
NULL
;

250 
li¡_node
 *
cur
 = 
h—d_
;

251 
cur
 !ğ
NULL
) {

252 ià(
	`found_f
(
cur
)) {

253 
cur
->
	`m¬k_šv®id
();

254 ià(
´ev
) {

255 
´ev
->
Ãxt
.
	`assign_±r
(
cur
->next);

257 
h—d_
 = 
cur
->
Ãxt
;

259 ià(
TxÇl
) {

260 
T¿n§ùiÚ
::
	`rcu_ä“
(
cur
);

262 
	`ä“
(
cur
);

264 ià(!
TxÇl
)

265 
li¡size_
--;

266 ià(!
locked
)

267 
	`uÆock
(
li¡v”siÚ_
);

268  
Œue
;

270 
´ev
 = 
cur
;

271 
cur
 = cur->
Ãxt
;

273 ià(!
locked
)

274 
	`uÆock
(
li¡v”siÚ_
);

275  
çl£
;

276 
	}
}

278 
šlše
 
	$İac™y_check
() {

281 
	`as£¹
(
O·c™y
);

282 autØ
li¡v
 = 
li¡v”siÚ_
;

283 
	`ãnû
();

284 
Sto
::
	`check_İac™y
(
li¡v
);

285 
	}
}

287 
™”©Ü
 
	$begš
(è{  
	`™”©Ü
(
this
, 
h—d_
); 
	}
}

288 
™”©Ü
 
	$’d
(è{  
	`™”©Ü
(
this
, 
NULL
); 
	}
}

290 
	sLi¡I‹r
 {

291 
Li¡I‹r
(è: 
us
(
NULL
), 
cur
(NULL) {}

293 
boŞ
 
v®id
() const {

294  
	gus
 !ğ
NULL
;

297 
boŞ
 
hasNext
() const {

298  !!
	gcur
;

301 
»£t
() {

302 
	gcur
 = 
us
->
h—d_
;

305 
T
* 
Ãxt
() {

306 autØ
	g»t
 = 
cur
 ? &cur->
v®
 : 
NULL
;

307 ià(
	gcur
)

308 
	gcur
 = 
cur
->
Ãxt
;

309  
	g»t
;

312 
boŞ
 
ŒªsHasNext
() const {

313  !!
	gcur
;

316 
ŒªsRe£t
() {

317 
	gcur
 = 
us
->
h—d_
;

318 
’su»V®id
();

321 
T
* 
ŒªsNext
() {

322 autØ
	g»t
 = 
cur
 ? &cur->
v®
 : 
NULL
;

323 ià(
	gcur
)

324 
	gcur
 = 
cur
->
Ãxt
;

325 
’su»V®id
();

326  
	g»t
;

329 
T
* 
ŒªsNthNext
(
n
) {

330 
T
* 
	g»t
 = 
NULL
;

331 
	gn
 > 0 && 
ŒªsHasNext
()) {

332 
	g»t
 = 
ŒªsNext
();

333 
	gn
--;

335 ià(
	gn
 == 0)

336  
»t
;

337  
	gNULL
;

340 
	g´iv©e
:

341 
Li¡I‹r
(
Li¡1
 *
us
, 
li¡_node
 *
cur
, 
boŞ
 
Œªs
) : us(us), cur(cur) {

342 ià(
	gŒªs
)

343 
’su»V®id
();

346 
’su»V®id
() {

347 
	gcur
) {

349 autØ
	g™em
 = 
Sto
::
check_™em
(
us
, 
cur
);

350 ià(!
	gcur
->
is_v®id
()) {

351 ià(!
	g™em
 || !
	gus
->
has_š£¹
(*
™em
)) {

352 
	gSto
::
abÜt
();

354 
	gcur
 = 
cur
->
Ãxt
;

358 ià(
	g™em
 && 
	gus
->
has_d–‘e
(*
™em
)) {

359 
	gcur
 = 
cur
->
Ãxt
;

366 
ä›nd
 
şass
 
	gLi¡1
;

367 
Li¡1
 *
	gus
;

368 
li¡_node
 *
	gcur
;

371 
Li¡I‹r
 
	$™”
() {

372  
	`Li¡I‹r
(
this
, 
h—d_
, 
çl£
);

373 
	}
}

375 
Li¡I‹r
 
	$ŒªsI‹r
() {

376 
	`v”ify_li¡
(
li¡v”siÚ_
);

377  
	`Li¡I‹r
(
this
, 
h—d_
, 
Œue
);

378 
	}
}

380 
size_t
 
	$size
() {

381 
	`v”ify_li¡
(
li¡v”siÚ_
);

382  
li¡size_
 + 
	`Œªs_size_offs
();

383 
	}
}

385 
size_t
 
	$un§ã_size
() const {

386  
li¡size_
;

387 
	}
}

389 
	$ş—r
() {

390 autØ
™em
 = 
h—d_
)

391 
»move
<
çl£
>(
h—d_
, 
Œue
);

392 
	}
}

394 
	$v”ify_li¡
(
v”siÚ_ty³
 
»adv
) {

395 
	`t_™em
(
this
).
	`add_»ad
(
»adv
);

396 
	`acquœe_ãnû
();

397 
	}
}

400 
	$lock
(
v”siÚ_ty³
& 
v
) {

401 
T¿n§ùiÚTid
::
	`lock
(
v
);

402 
	}
}

404 
	$uÆock
(
v”siÚ_ty³
& 
v
) {

405 
T¿n§ùiÚTid
::
	`uÆock
(
v
);

406 
	}
}

408 
boŞ
 
	$is_locked
(
v”siÚ_ty³
& 
v
) {

409  
T¿n§ùiÚTid
::
	`is_locked
(
v
);

410 
	}
}

412 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

416  
™em
.
key
<
Li¡1
*>(è!ğ
this


417 || 
txn
.
	`Œy_lock
(
™em
, 
li¡v”siÚ_
);

418 
	}
}

420 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
&è
ov”ride
 {

421 ià(
™em
.
key
<
Li¡1
*>(è=ğ
this
)

422  
T¿n§ùiÚTid
::
	`check_v”siÚ
(
li¡v”siÚ_
, 
™em
.
‹m¶©e
 
»ad_v®ue
<
v”siÚ_ty³
>());

423 autØ
n
 = 
™em
.
key
<
li¡_node
*>();

424  
n
->
	`is_v®id
(è|| 
	`has_š£¹
(
™em
);

425 
	}
}

427 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
t
è
ov”ride
 {

428 ià(
™em
.
key
<
Li¡1
*>(è=ğ
this
)

430 
li¡_node
 *
n
 = 
™em
.
key
<list_node*>();

431 ià(
	`has_d–‘e
(
™em
)) {

432 
»move
<
Œue
>(
n
,rue);

433 
li¡size_
--;

436 ià(
O·c™y
) {

437 
T¿n§ùiÚTid
::
	`£t_v”siÚ
(
li¡v”siÚ_
, 
t
.
	`comm™_tid
());

439 
T¿n§ùiÚTid
::
	`šc_nÚİaque_v”siÚ
(
li¡v”siÚ_
);

441 } ià(
	`has_doupd©e
(
™em
)) {

443 
n
->
v®
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

445 
n
->
	`m¬k_v®id
();

446 
li¡size_
++;

447 ià(
O·c™y
) {

448 
T¿n§ùiÚTid
::
	`£t_v”siÚ
(
li¡v”siÚ_
, 
t
.
	`comm™_tid
());

450 
T¿n§ùiÚTid
::
	`šc_nÚİaque_v”siÚ
(
li¡v”siÚ_
);

453 
	}
}

455 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

456 ià(
™em
.
key
<
Li¡1
*>(è=ğ
this
)

457 
	`uÆock
(
li¡v”siÚ_
);

458 
	}
}

460 
	$ş—nup
(
T¿nsI‹m
& 
™em
, 
boŞ
 
comm™‹d
è
ov”ride
 {

461 ià(!
comm™‹d
 && (
™em
.
	`æags
(è& 
š£¹_b™
)) {

462 
li¡_node
 *
n
 = 
™em
.
key
<list_node*>();

463 
»move
<
Œue
>(
n
);

465 
	}
}

467 
boŞ
 
	$v®id™yCheck
(
li¡_node
 *
n
, 
T¿nsI‹m
& 
™em
) {

468  
n
->
	`is_v®id
(è|| (
™em
.
	`æags
(è& 
š£¹_b™
);

469 
	}
}

471 
	g‹m¶©e
 <
ty³Çme
 
	gPTR
>

472 
T¿nsProxy
 
	$t_™em
(
PTR
 *
node
) {

474  
Sto
::
	`™em
(
this
, 
node
);

475 
	}
}

477 
boŞ
 
	$has_š£¹
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

478  
™em
.
	`has_wr™e
(è&& !
	`has_d–‘e
(™emè&& !
	`has_doupd©e
(item);

479 
	}
}

481 
boŞ
 
	$has_d–‘e
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

482  
™em
.
	`æags
(è& 
d–‘e_b™
;

483 
	}
}

485 
boŞ
 
	$has_doupd©e
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

486  
™em
.
	`æags
(è& 
doupd©e_b™
;

487 
	}
}

489 
	$add_lock_li¡_™em
() {

490 autØ
™em
 = 
	`t_™em
((*)
this
);

491 
™em
.
	`add_wr™e
(0);

492 
	}
}

494 
	$add_Œªs_size_offs
(
size_offs
) {

497 autØ
™em
 = 
	`t_™em
(
size_key
);

498 
™em
.
‹m¶©e
 
£t_¡ash
<>(™em.‹m¶©
¡ash_v®ue
<>(0è+ 
size_offs
);

499 
	}
}

501 
	$Œªs_size_offs
() {

502  
	`t_™em
(
size_key
).
‹m¶©e
 
¡ash_v®ue
<>(0);

503 
	}
}

505 
li¡_node
 *
	gh—d_
;

506 
	gli¡size_
;

507 
v”siÚ_ty³
 
	gli¡v”siÚ_
;

508 
Com·»
 
	gcomp_
;

514 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gDu¶iÿ‹s
,y³Çm
	gCom·»
, boŞ 
	gSÜ‹d
, boŞ 
	gO·c™y
,y³Çm
	gEËm
>

515 
şass
 
	gLi¡1I‹¿tÜ
 : 
public
 
¡d
::
™”©Ü
<¡d::
fÜw¬d_™”©Ü_g
, 
	gT
> {

516 
	gLi¡1I‹¿tÜ
<
	tT
, 
	tDu¶iÿ‹s
, 
	tCom·»
, 
	tSÜ‹d
, 
	tO·c™y
, 
	tEËm
> 
	t™”©Ü
;

517 
	gLi¡1
<
	tT
, 
	tDu¶iÿ‹s
, 
	tCom·»
, 
	tSÜ‹d
, 
	tO·c™y
, 
	tEËm
> 
	tli¡_ty³
;

518 
ty³Çme
 
	tli¡_ty³
::
	tli¡_node
†ist_node;

519 
	gpublic
:

520 
Li¡1I‹¿tÜ
(
li¡_ty³
 * 
li¡
, 
li¡_node
* 
±r
è: 
myLi¡
Öi¡), 
myPŒ
(ptr) {

521 
	gmyLi¡
->
v”ify_li¡
(
myLi¡
->
li¡v”siÚ_
);

523 
Li¡1I‹¿tÜ
(cÚ¡ Li¡1I‹¿tÜ& 
™r
è: 
myLi¡
(™r.myLi¡), 
myPŒ
(itr.myPtr) {}

525 
	gLi¡1I‹¿tÜ
& 
	gİ”©Ü
ğ(cÚ¡ 
Li¡1I‹¿tÜ
& 
v
) {

526 
myLi¡
 = 
v
.myList;

527 
	gmyPŒ
 = 
v
.
myPŒ
;

528  *
	gthis
;

531 
boŞ
 
	gİ”©Ü
==(
™”©Ü
 
Ùh”
) const {

532  (
myLi¡
 =ğ
Ùh”
.myLi¡è&& (
myPŒ
 == other.myPtr);

535 
boŞ
 
	gİ”©Ü
!=(
™”©Ü
 
Ùh”
) const {

536  !(
İ”©Ü
==(
Ùh”
));

539 
	gEËm
& 
	gİ”©Ü
*() {

540  
	gmyPŒ
->
	gv®
;

544 
šüem’t_±r
() {

545 ià(
	gmyPŒ
)

546 
	gmyPŒ
 = 
myPŒ
->
Ãxt
;

547 
	gmyPŒ
) {

549 autØ
	g™em
 = 
Sto
::
check_™em
(
myLi¡
, 
myPŒ
);

550 ià(!
	gmyPŒ
->
is_v®id
()) {

551 ià(!
	g™em
 || !
	gmyLi¡
->
has_š£¹
(*
™em
)) {

552 
	gSto
::
abÜt
();

554 
	gmyPŒ
 = 
myPŒ
->
Ãxt
;

558 ià(
	g™em
 && 
	gmyLi¡
->
has_d–‘e
(*
™em
)) {

559 
	gmyPŒ
 = 
myPŒ
->
Ãxt
;

567 
	g™”©Ü
& 
	gİ”©Ü
++() {

568 
šüem’t_±r
();

569  *
	gthis
;

573 
™”©Ü
 
	gİ”©Ü
++() {

574 
™”©Ü
 
şÚe
(*
this
);

575 
šüem’t_±r
();

576  
	gşÚe
;

579 
	g´iv©e
:

580 
li¡_ty³
 * 
myLi¡
;

581 
li¡_node
 * 
	gmyPŒ
;

	@datatype/PriorityQueue.hh

1 #´agm¨
Úû


3 
	~<veùÜ
>

4 
	~"TaggedLow.hh
"

5 
	~"T¿n§ùiÚ.hh
"

6 
	~"v”siÚed_v®ue.hh
"

9 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gO·c™y
 = 
çl£
>

10 şas 
	cPriÜ™yQueue
: 
public
 
TObjeù
 {

11 
T¿n§ùiÚTid
::
	tty³
 
	tV”siÚ
;

12 
	mv”siÚed_v®ue_¡ruù
<
	tT
> 
	tv”siÚed_v®ue
;

14 
cÚ¡ex´
 
	mT¿nsI‹m
::
æags_ty³
 
š£¹_g
 = 
T¿nsI‹m
::
u£r0_b™
;

15 
cÚ¡ex´
 
	mT¿nsI‹m
::
æags_ty³
 
d–‘e_g
 = 
T¿nsI‹m
::
u£r0_b™
<<1;

16 
cÚ¡ex´
 
	mT¿nsI‹m
::
æags_ty³
 
dœty_g
 = 
T¿nsI‹m
::
u£r0_b™
<<2;

18 
cÚ¡ex´
 
V”siÚ
 
	mš£¹_b™
 = 
T¿n§ùiÚTid
::
u£r_b™
;

19 
cÚ¡ex´
 
V”siÚ
 
	md–‘e_b™
 = 
T¿n§ùiÚTid
::
u£r_b™
<<1;

20 
cÚ¡ex´
 
V”siÚ
 
	mdœty_b™
 = 
T¿n§ùiÚTid
::
u£r_b™
<<2;

22 
cÚ¡ex´
 
	mpİ_key
 = -2;

23 
cÚ¡ex´
 
	mem±y_key
 = -3;

24 
cÚ¡ex´
 
	mtİ_key
 = -4;

25 
	mpublic
:

26 
	$PriÜ™yQueue
(è: 
	$h—p_
() {

27 
size_
 = 0;

28 
pİlock_
 = 0;

29 
pİv”siÚ_
 = 0;

30 
dœtytid_
 = -1;

31 
dœtyv®_
 = -1;

32 
dœtycouÁ_
 = 0;

36 
	$add
(
v”siÚed_v®ue
* 
v
) {

37 
chd
 = 
size_
;

38 ià(
chd
 >ğ
h—p_
.
	`size
()) {

39 
h—p_
.
	`push_back
(
v
);

41 
h—p_
[
chd
] = 
v
;

43 
size_
++;

45 
chd
 > 0) {

46 
·»Á
 = (
chd
 - 1) / 2;

47 
v”siÚed_v®ue
* 
befÜe
 = 
h—p_
[
·»Á
];

48 
Şd
 = 
chd
;

49 
v”siÚed_v®ue
* 
·»Á_v®
 = 
h—p_
[
·»Á
];

50 ià(
h—p_
[
chd
]->
	`»ad_v®ue
(è> 
·»Á_v®
->read_value()) {

51 
	`sw­
(
chd
, 
·»Á
);

52 
chd
 = 
·»Á
;

57 
	}
}

60 
v”siÚed_v®ue
* 
	$»moveMax
(
v”siÚed_v®ue
* 
expV®
 = 
NULL
) {

61 
bÙtom
 = --
size_
;

62 ià(
bÙtom
 < 0) {

63  
NULL
;

65 ià(
bÙtom
 == 0) {

66 
v”siÚed_v®ue
* 
»s
 = 
h—p_
[0];

67  
»s
;

70 
v”siÚed_v®ue
* 
»s
 = 
h—p_
[0];

72 ià(
expV®
 !ğ
NULL
 && 
»s
 !=ƒxpVal) {

73 
	`uÆock
(&
pİlock_
);

74 
Sto
::
	`abÜt
();

75  
NULL
;

77 
	`sw­
(
bÙtom
, 0);

79 
chd
 = 0;

80 
·»Á
 = 0;

81 2*
·»Á
 < 
size_
 - 1) {

82 
Ëá
 = 
·»Á
 * 2 + 1;

83 
right
 = (
·»Á
 * 2) + 2;

84 ià(
right
 >ğ
size_
) {

85 ià(
Ëá
 >ğ
size_
) {

88 ià(
h—p_
[
Ëá
]->
	`»ad_v®ue
(è> h—p_[
·»Á
]->read_value()) {

89 
	`sw­
(
·»Á
, 
Ëá
);

90 
·»Á
 = 
Ëá
;

96 ià(
h—p_
[
Ëá
]->
	`»ad_v®ue
(è> h—p_[
right
]->read_value()) {

97 
chd
 = 
Ëá
;

99 
chd
 = 
right
;

101 ià(
h—p_
[
chd
]->
	`»ad_v®ue
(è> h—p_[
·»Á
]->read_value()) {

102 
	`sw­
(
·»Á
, 
chd
);

103 
·»Á
 = 
chd
;

109  
»s
;

110 
	}
}

112 
v”siÚed_v®ue
* 
	$g‘Max
() {

113 
	`as£¹
(
T¿n§ùiÚTid
::
	`is_locked_h”e
(
pİlock_
));

114 ià(
size_
 == 0) {

115  
NULL
;

118 
v”siÚed_v®ue
* 
v®
 = 
h—p_
[0];

119 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
v®
);

120 ià(
	`is_š£¹ed
(
v®
->
	`v”siÚ
())) {

121 ià(
	`has_š£¹
(
™em
)) {

123  
v®
;

126 
	`uÆock
(&
pİlock_
);

127 
Sto
::
	`abÜt
();

128  
NULL
;

130 } ià(
	`is_d–‘ed
(
v®
->
	`v”siÚ
())) {

131 
	`»moveMax
(
v®
);

132 ià(
size_
 =ğ0è 
NULL
;

134  
v®
;

137 
	}
}

139 
	$push_nÚŒªs
(
T
 
v
) {

140 
	`lock
(&
pİlock_
);

141 
v”siÚed_v®ue
* 
v®
 = v”siÚed_v®ue::
	`make
(
v
, 
T¿n§ùiÚTid
::
šüem’t_v®ue
 + 
š£¹_b™
);

142 
	`add
(
v®
);

143 
	`uÆock
(&
pİlock_
);

144 
	}
}

146 
	$push
(
T
 
v
) {

147 
	`lock
(&
pİlock_
);

149 ià(
dœtytid_
 !ğ-1 && dœtytid_ !ğ
TTh»ad
::
	`id
(è&& 
v
 > 
dœtyv®_
) {

150 
	`uÆock
(&
pİlock_
);

151 
Sto
::
	`abÜt
();

154 
v”siÚed_v®ue
* 
v®
 = v”siÚed_v®ue::
	`make
(
v
, 
T¿n§ùiÚTid
::
šüem’t_v®ue
 + 
š£¹_b™
);

155 
	`add
(
v®
);

156 
Sto
::
	`™em
(
this
, 
v®
).
	`add_wr™e
(
v
).
	`add_æags
(
š£¹_g
);

157 
	`uÆock
(&
pİlock_
);

159 
	}
}

161 
T
 
	$pİ
() {

163 autØ
tİ_™em
 = 
Sto
::
	`check_™em
(
this
, 
tİ_key
);

164 
v”siÚed_v®ue
* 
»ad_v®
 = 
NULL
;

165 ià(
tİ_™em
 !ğ
NULL
 &&İ_™em->
	`has_»ad
()) {

166 
»ad_v®
 = (*
tİ_™em
).
‹m¶©e
 
»ad_v®ue
<
v”siÚed_v®ue
*>();

169 autØ
em±y_™em
 = 
Sto
::
	`check_™em
(
this
, 
em±y_key
);

170 
boŞ
 
»ad_em±y
 = 
em±y_™em
 !ğ
NULL
 &&ƒm±y_™em->
	`has_»ad
();

172 ià(
size_
 == 0) {

173 ià(
»ad_v®
 !ğ
NULL
) {

174 
Sto
::
	`abÜt
();

176 
Sto
::
	`™em
(
this
, 
em±y_key
).
	`add_»ad
(0);

178 
Sto
::
	`™em
(
this
, 
pİ_key
).
	`add_»ad
(
T¿n§ùiÚTid
::
	`uÆocked
(
pİv”siÚ_
));

182 
	`lock
(&
pİlock_
);

183 ià(
dœtytid_
 !ğ-1 && dœtytid_ !ğ
TTh»ad
::
	`id
()) {

185 
	`uÆock
(&
pİlock_
);

186 
Sto
::
	`abÜt
();

190 
v”siÚed_v®ue
* 
v®
 = 
	`g‘Max
();

192 
boŞ
 
shouldBeIn£¹ed
 = 
çl£
;

193 ià(
»ad_em±y
 && 
v®
 !ğ
NULL
è
shouldBeIn£¹ed
 = 
Œue
;

194 ià(
»ad_v®
 !ğ
NULL
 &&„—d_v®->
	`»ad_v®ue
(è=ğ
v®
->read_value()) {

195 
tİ_™em
->
	`»move_»ad
();

196 } ià(
»ad_v®
 !ğ
NULL
) {

197 
shouldBeIn£¹ed
 = 
Œue
;

199 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
v®
);

200 ià(
shouldBeIn£¹ed
 && !
	`has_š£¹
(
™em
)) {

201 
	`uÆock
(&
pİlock_
);

202 
Sto
::
	`abÜt
();

206 ià(
v®
 =ğ
NULL
) {

207 
Sto
::
	`™em
(
this
, 
em±y_key
).
	`add_»ad
(0);

208 
Sto
::
	`™em
(
this
, 
pİ_key
).
	`add_»ad
(
T¿n§ùiÚTid
::
	`uÆocked
(
pİv”siÚ_
));

209 
	`uÆock
(&
pİlock_
);

212 ià(
dœtytid_
 =ğ-1 || 
v®
->
	`»ad_v®ue
(è< 
dœtyv®_
) {

213 
dœtyv®_
 = 
v®
->
	`»ad_v®ue
();

214 
	`ãnû
();

216 
dœtytid_
 = 
TTh»ad
::
	`id
();

218 
	`»moveMax
(
v®
);

219 
	`uÆock
(&
pİlock_
);

221 ià(
	`has_š£¹
(
™em
)) {

222 
™em
.
	`add_æags
(
d–‘e_g
);

224 
™em
.
	`add_wr™e
(0).
	`add_æags
(
d–‘e_g
);

225 
dœtycouÁ_
++;

229 
Sto
::
	`™em
(
this
, 
pİ_key
).
	`add_wr™e
(0);

230  
v®
->
	`»ad_v®ue
();

231 
	}
}

233 
T
 
	$tİ
() {

234 ià(
size_
 == 0) {

235 
Sto
::
	`™em
(
this
, 
em±y_key
).
	`add_»ad
(0);

239 
Sto
::
	`™em
(
this
, 
pİ_key
).
	`add_»ad
(
T¿n§ùiÚTid
::
	`uÆocked
(
pİv”siÚ_
));

240 
	`acquœe_ãnû
();

241 ià(
size_
 == 0) {

242 
Sto
::
	`™em
(
this
, 
em±y_key
).
	`add_»ad
(0);

246 
	`lock
(&
pİlock_
);

247 ià(
dœtytid_
 !ğ-1 && dœtytid_ !ğ
TTh»ad
::
	`id
()) {

249 
	`uÆock
(&
pİlock_
);

250 
Sto
::
	`abÜt
();

252 
v”siÚed_v®ue
* 
v®
 = 
	`g‘Max
();

253 
	`uÆock
(&
pİlock_
);

254 ià(
v®
 =ğ
NULL
) {

255 
Sto
::
	`™em
(
this
, 
em±y_key
).
	`add_»ad
(0);

258 
T
 
»tv®
 = 
v®
->
	`»ad_v®ue
();

259 
Sto
::
	`™em
(
this
, 
v®
).
	`add_»ad
(v®->
	`v”siÚ
());

260 
Sto
::
	`™em
(
this
, 
tİ_key
).
	`add_»ad
(
v®
);

261  
»tv®
;

262 
	}
}

264 
	$un§ã_size
() {

265  
size_
;

266 
	}
}

268 
	$lock
(
v”siÚed_v®ue
 *
e
) {

269 
	`lock
(&
e
->
	`v”siÚ
());

270 
	}
}

271 
	$uÆock
(
v”siÚed_v®ue
 *
e
) {

272 
	`uÆock
(&
e
->
	`v”siÚ
());

273 
	}
}

275 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

276  
™em
.
key
<>(è!ğ
pİ_key


277 || 
txn
.
	`Œy_lock
(
™em
, 
pİv”siÚ_
);

278 
	}
}

280 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
&è
ov”ride
 {

281 ià(
™em
.
key
<>(è=ğ
tİ_key
è{  
Œue
; }

282 ià(
™em
.
key
<>(è=ğ
em±y_key
) {

284 
i
 = 0; i < 
size_
; i++) {

285 
v”siÚed_v®ue
* 
v®
 = 
h—p_
[
i
];

286 ià(!
	`is_š£¹ed
(
v®
->
	`v”siÚ
())

287 || 
T¿n§ùiÚTid
::
	`is_locked_–£wh”e
(
v®
->
	`v”siÚ
()))

288  
çl£
;

291 ià(
dœtytid_
 !ğ-1 && dœtytid_ !ğ
TTh»ad
::
	`id
()è 
çl£
;

292  
Œue
;

294 ià(
™em
.
key
<>(è=ğ
pİ_key
) {

295  
T¿n§ùiÚTid
::
	`check_v”siÚ
(
pİv”siÚ_
, 
™em
.
‹m¶©e
 
»ad_v®ue
<
V”siÚ
>());

298 autØ
e
 = 
™em
.
key
<
v”siÚed_v®ue
*>();

299 ià(
dœtytid_
 !ğ-1 && dœtytid_ !ğ
TTh»ad
::
	`id
(è&& 
dœtyv®_
 >ğ
e
->
	`»ad_v®ue
()è 
çl£
;

300 ià(
	`has_d–‘e
(
™em
)è 
Œue
;

302 
Ëv–
 = 1;

303 
boŞ
 
found
 = 
çl£
;

304 
i
 = 0; i < 
size_
; i++) {

305 
v”siÚed_v®ue
* 
v®
 = 
h—p_
[
i
];

306 ià(
v®
 =ğ
e
 || v®->
	`»ad_v®ue
(è=ğe->»ad_v®ue()è
found
 = 
Œue
;

307 ià(
v®
->
	`»ad_v®ue
(è> 
e
->read_value()) {

308 autØ
™
 = 
Sto
::
	`check_™em
(
this
, 
v®
);

309 ià(
™
 !ğ
NULL
 && 
	`has_š£¹
(*it)) {

310 
Ëv–
 = 
	`fšdLev–
(
i
) + 1;

313  
çl£
;

316 ià(
i
 =ğ
	`’dOfLev–
(
Ëv–
)) ;

318 ià(
dœtytid_
 !ğ-1 && dœtytid_ !ğ
TTh»ad
::
	`id
(è&& 
dœtyv®_
 >ğ
e
->
	`»ad_v®ue
()è 
çl£
;

319 ià(!
found
è 
çl£
;

320  
Œue
;

322 
	}
}

325 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
t
è
ov”ride
 {

326 ià(
™em
.
key
<>(è=ğ
pİ_key
){

327 ià(
O·c™y
) {

328 
T¿n§ùiÚTid
::
	`£t_v”siÚ
(
pİv”siÚ_
, 
t
.
	`comm™_tid
());

330 
T¿n§ùiÚTid
::
	`šc_nÚİaque_v”siÚ
(
pİv”siÚ_
);

333 autØ
e
 = 
™em
.
key
<
v”siÚed_v®ue
*>();

334 ià(
	`has_š£¹
(
™em
)) {

335 
	`”a£_š£¹ed
(&
e
->
	`v”siÚ
());

338 
	}
}

340 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

341 ià(
™em
.
key
<>(è=ğ
pİ_key
)

342 
	`uÆock
(&
pİv”siÚ_
);

343 
	}
}

345 
	$ş—nup
(
T¿nsI‹m
& 
™em
, 
boŞ
 
comm™‹d
è
ov”ride
 {

346 ià(
comm™‹d
 && 
dœtytid_
 =ğ
TTh»ad
::
	`id
()) {

347 
dœtytid_
 = -1;

349 ià(!
comm™‹d
) {

350 if(
	`has_š£¹
(
™em
è&& 
	`has_d–‘e
(item)) {

354 ià(
	`has_š£¹
(
™em
)) {

355 autØ
e
 = 
™em
.
key
<
v”siÚed_v®ue
*>();

356 
	`m¬k_d–‘ed
(&
e
->
	`v”siÚ
());

357 
	`ãnû
();

358 
	`”a£_š£¹ed
(&
e
->
	`v”siÚ
());

359 } ià(
	`has_d–‘e
(
™em
)) {

360 autØ
e
 = 
™em
.
key
<
v”siÚed_v®ue
*>();

361 autØ
v
 = 
e
->
	`»ad_v®ue
();

362 
v”siÚed_v®ue
* 
v®
 = v”siÚed_v®ue::
	`make
(
v
, 
T¿n§ùiÚTid
::
šüem’t_v®ue
);

363 
	`lock
(&
pİlock_
);

364 
	`add
(
v®
);

365 
	`uÆock
(&
pİlock_
);

366 
	`ãnû
();

367 
dœtycouÁ_
--;

368 ià(
dœtycouÁ_
 == 0) {

369 
	`as£¹
(
dœtytid_
 =ğ
TTh»ad
::
	`id
());

370 
dœtytid_
 = -1;

374 
	}
}

377 
	$´št
() {

378 
i
 =0; i < 
size_
; i++) {

379 
¡d
::
cout
 << 
h—p_
[
i
]->
	`»ad_v®ue
(è<< "[" << (!
	`is_š£¹ed
(h—p_[i]->
	`v”siÚ
()è&& !
	`is_d–‘ed
(heap_[i]->version())) << "] ";

381 
¡d
::
cout
 << std::
’dl
;

382 
	}
}

385 
	g´iv©e
:

386 
	$lock
(
V”siÚ
 *
v
) {

387 
T¿n§ùiÚTid
::
	`lock
(*
v
);

388 
	}
}

390 
	$uÆock
(
V”siÚ
 *
v
) {

391 
T¿n§ùiÚTid
::
	`uÆock
(*
v
);

392 
	}
}

394 
boŞ
 
	$has_š£¹
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

395  
™em
.
	`æags
(è& 
š£¹_g
;

396 
	}
}

397 
boŞ
 
	$has_d–‘e
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

398  
™em
.
	`æags
(è& 
d–‘e_g
;

399 
	}
}

401 
boŞ
 
	$has_dœty
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

402  
™em
.
	`æags
(è& 
dœty_g
;

403 
	}
}

405 
boŞ
 
	$is_š£¹ed
(
V”siÚ
 
v
) {

406  
v
 & 
š£¹_b™
;

407 
	}
}

409 
	$”a£_š£¹ed
(
V”siÚ
* 
v
) {

410 *
v
 = *v & (~
š£¹_b™
);

411 
	}
}

413 
	$m¬k_š£¹ed
(
V”siÚ
* 
v
) {

414 *
v
 = *v | 
š£¹_b™
;

415 
	}
}

417 
boŞ
 
	$is_dœty
(
V”siÚ
 
v
) {

418  
v
 & 
dœty_b™
;

419 
	}
}

421 
	$”a£_dœty
(
V”siÚ
* 
v
) {

422 
	`as£¹
(
	`is_dœty
(*
v
));

423 *
v
 = *v & (~
dœty_b™
);

424 
	}
}

426 
	$m¬k_dœty
(
V”siÚ
* 
v
) {

427 
	`as£¹
(!
	`is_dœty
(*
v
));

428 *
v
 = *v | 
dœty_b™
;

429 
	}
}

431 
boŞ
 
	$is_d–‘ed
(
V”siÚ
 
v
) {

432  
v
 & 
d–‘e_b™
;

433 
	}
}

435 
	$”a£_d–‘ed
(
V”siÚ
* 
v
) {

436 *
v
 = *v & (~
d–‘e_b™
);

437 
	}
}

439 
	$m¬k_d–‘ed
(
V”siÚ
* 
v
) {

440 *
v
 = *v | 
d–‘e_b™
;

441 
	}
}

443 
	$fšdLev–
(
i
) {

444  
	`û
(
	`log
((è(
i
+2)) /†og(2.0));

445 
	}
}

447 
	$’dOfLev–
(
l
) {

448 
	`as£¹
(
l
 >= 1);

449  (1 << 
l
) - 2;

450 
	}
}

453 
	$sw­
(
i
, 
j
) {

454 
v”siÚed_v®ue
* 
tmp
 = 
h—p_
[
i
];

455 
h—p_
[
i
] = h—p_[
j
];

456 
h—p_
[
j
] = 
tmp
;

457 
	}
}

459 
	g¡d
::
veùÜ
<
v”siÚed_v®ue
 *> 
h—p_
;

460 
V”siÚ
 
	gpİlock_
;

461 
V”siÚ
 
	gpİv”siÚ_
;

462 
	gsize_
;

463 
	gdœtyv®_
;

464 
	gdœtytid_
;

465 
	gdœtycouÁ_
;

	@datatype/PriorityQueue1.hh

1 #´agm¨
Úû


3 
	~"TVeùÜ.hh
"

4 
	~<®gÜ™hm
>

6 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gINIT_CAPACITY
 = 10000>

7 şas 
	cPriÜ™yQueue1
 {

8 
public
:

9 
	$PriÜ™yQueue1
() {

10 
–ems
.
	`nÚŒªs_»£rve
(
INIT_CAPACITY
);

13 
	$push
(
T
 
v
) {

14 
–ems
.
	`push_back
(
v
);

15 
¡d
::
	`push_h—p
(
–ems
.
	`begš
(),ƒËms.
	`’d
());

16 
	}
}

18 
	$pİ
() {

21 
¡d
::
	`pİ_h—p
(
–ems
.
	`begš
(),ƒËms.
	`’d
());

22 
–ems
.
	`pİ_back
();

23 
	}
}

25 
T
 
	$tİ
() {

26  
–ems
.
	`äÚt
();

27 
	}
}

29 
ušt32_t
 
	$size
() {

30  
–ems
.
	`size
();

31 
	}
}

33 
	$´št
() {

34 
–ems
.
	`´št
();

35 
	}
}

37 
	g´iv©e
:

38 
TVeùÜ
<
T
> 
–ems
;

	@datatype/Queue.hh

1 #´agm¨
Úû


3 
	~<li¡
>

4 
	~"TaggedLow.hh
"

5 
	~"T¿n§ùiÚ.hh
"

6 
	~"TW¿µed.hh
"

8 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gBUF_SIZE
 = 1000000,

9 
	g‹m¶©e
 <
	gty³Çme
> 
şass
 
	gW
 = 
TO·queW¿µed
>

10 şas 
	cQueue
: 
public
 
TObjeù
 {

11 
public
:

12 
ty³Çme
 
	tW
<
	tT
>::
	tv”siÚ_ty³
 version_type;

14 
	$Queue
(è: 
	`h—d_
(0), 
	`_
(0), 
	`v”siÚ_
(0), 
	$h—dv”siÚ_
(0) {}

16 
cÚ¡ex´
 
T¿nsI‹m
::
æags_ty³
 
d–‘e_b™
 = T¿nsI‹m::
u£r0_b™
;

17 
cÚ¡ex´
 
T¿nsI‹m
::
æags_ty³
 
»ad_wr™es
 = T¿nsI‹m::
u£r0_b™
<<1;

18 
cÚ¡ex´
 
T¿nsI‹m
::
æags_ty³
 
li¡_b™
 = T¿nsI‹m::
u£r0_b™
<<2;

19 
cÚ¡ex´
 
T¿nsI‹m
::
æags_ty³
 
em±y_b™
 = T¿nsI‹m::
u£r0_b™
<<3;

22 
	$nÚŒªs_push
(
T
 
v
) {

23 
queueSlÙs
[
_
] = 
v
;

24 
_
 = (_+1)%
BUF_SIZE
;

25 
	`as£¹
(
h—d_
 !ğ
_
);

26 
	}
}

28 
T
 
	$nÚŒªs_pİ
() {

29 
	`as£¹
(
h—d_
 !ğ
_
);

30 
T
 
v
 = 
queueSlÙs
[
h—d_
];

31 
h—d_
 = (h—d_+1)%
BUF_SIZE
;

32  
v
;

33 
	}
}

35 
boŞ
 
	$nÚŒªs_em±y
() const {

36  
h—d_
 =ğ
_
;

37 
	}
}

39 
	g‹m¶©e
 <
ty³Çme
 
	gRªdomG’
>

40 
	$nÚŒªs_shufæe
(
RªdomG’
 
g’
) {

41 autØ
h—d
 = &
queueSlÙs
[
h—d_
];

42 autØ

 = &
queueSlÙs
[
_
];

44 
	`as£¹
(
h—d
 < 

);

45 
¡d
::
	`shufæe
(
h—d
, 

, 
g’
);

46 
	}
}

48 
	$nÚŒªs_ş—r
() {

49 !
	`nÚŒªs_em±y
())

50 
	`nÚŒªs_pİ
();

51 
	}
}

54 
	$ŒªsPush
(cÚ¡ 
T
& 
v
) {

55 autØ
™em
 = 
Sto
::
	`™em
(
this
, -1);

56 ià(
™em
.
	`has_wr™e
()) {

57 ià(!
	`is_li¡
(
™em
)) {

58 auto& 
v®
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

59 
¡d
::
li¡
<
T
> 
wr™e_li¡
;

60 ià(!
	`is_em±y
(
™em
)) {

61 
wr™e_li¡
.
	`push_back
(
v®
);

62 
™em
.
	`ş—r_æags
(
em±y_b™
);

64 
wr™e_li¡
.
	`push_back
(
v
);

65 
™em
.
	`ş—r_wr™e
();

66 
™em
.
	`add_wr™e
(
wr™e_li¡
);

67 
™em
.
	`add_æags
(
li¡_b™
);

70 auto& 
wr™e_li¡
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
¡d
::
li¡
<
T
>>();

71 
wr™e_li¡
.
	`push_back
(
v
);

74 
™em
.
	`add_wr™e
(
v
);

75 
	}
}

77 
boŞ
 
	$ŒªsPİ
() {

78 autØ
hv
 = 
h—dv”siÚ_
;

79 
	`ãnû
();

80 autØ
šdex
 = 
h—d_
;

81 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
šdex
);

84 ià(
šdex
 =ğ
_
) {

85 autØ
tv
 = 
v”siÚ_
;

86 
	`ãnû
();

88 ià(
šdex
 =ğ
_
) {

89 autØ
push™em
 = 
Sto
::
	`™em
(
this
,-1);

90 ià(!
push™em
.
	`has_»ad
())

91 
push™em
.
	`ob£rve
(
tv
);

92 ià(
push™em
.
	`has_wr™e
()) {

93 ià(
	`is_li¡
(
push™em
)) {

94 auto& 
wr™e_li¡
 = 
push™em
.
‹m¶©e
 
wr™e_v®ue
<
¡d
::
li¡
<
T
>>();

96 ià(!
wr™e_li¡
.
	`em±y
()) {

97 
wr™e_li¡
.
	`pİ_äÚt
();

98 
™em
.
	`add_æags
(
»ad_wr™es
);

99  
Œue
;

101  
çl£
;

104 ià(!
	`is_em±y
(
push™em
)) {

105 
push™em
.
	`add_æags
(
em±y_b™
);

106  
Œue
;

108  
çl£
;

111  
çl£
;

114 ià(
	`has_d–‘e
(
™em
)) {

115 
šdex
 = (šdex + 1è% 
BUF_SIZE
;

116 
™em
 = 
Sto
::
	`™em
(
this
, 
šdex
);

121 autØ
lock™em
 = 
Sto
::
	`™em
(
this
, -2);

122 ià(!
lock™em
.
	`has_»ad
()) {

123 
lock™em
.
	`ob£rve
(
hv
);

125 
lock™em
.
	`add_wr™e
(0);

126 
™em
.
	`add_æags
(
d–‘e_b™
);

127 
™em
.
	`add_wr™e
(0);

128  
Œue
;

129 
	}
}

131 
boŞ
 
	$ŒªsFrÚt
(
T
& 
v®
) {

132 autØ
hv
 = 
h—dv”siÚ_
;

133 
	`ãnû
();

134 
šdex
 = 
h—d_
;

135 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
šdex
);

138 ià(
šdex
 =ğ
_
) {

139 autØ
tv
 = 
v”siÚ_
;

140 
	`ãnû
();

142 ià(
šdex
 =ğ
_
) {

143 autØ
push™em
 = 
Sto
::
	`™em
(
this
,-1);

144 ià(!
push™em
.
	`has_»ad
())

145 
push™em
.
	`ob£rve
(
tv
);

146 ià(
push™em
.
	`has_wr™e
()) {

147 ià(
	`is_li¡
(
push™em
)) {

148 auto& 
wr™e_li¡
ğ
push™em
.
‹m¶©e
 
wr™e_v®ue
<
¡d
::
li¡
<
T
>>();

150 ià(!
wr™e_li¡
.
	`em±y
()) {

151 
v®
 = 
wr™e_li¡
.
	`äÚt
();

152  
Œue
;

154  
çl£
;

157 ià(!
	`is_em±y
(
push™em
)) {

158 auto& 
v
 = 
push™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

159 
v®
 = 
v
;

160  
Œue
;

162  
çl£
;

164  
çl£
;

167 ià(
	`has_d–‘e
(
™em
)) {

168 
šdex
 = (šdex + 1è% 
BUF_SIZE
;

169 
™em
 = 
Sto
::
	`™em
(
this
, 
šdex
);

174 autØ
lock™em
 = 
Sto
::
	`™em
(
this
, -2);

175 ià(!
lock™em
.
	`has_»ad
()) {

176 
lock™em
.
	`ob£rve
(
hv
);

178 
v®
 = 
queueSlÙs
[
šdex
];

179  
Œue
;

180 
	}
}

182 
	g´iv©e
:

183 
boŞ
 
	$has_d–‘e
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

184  
™em
.
	`æags
(è& 
d–‘e_b™
;

185 
	}
}

187 
boŞ
 
	$is_rw
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

188  
™em
.
	`æags
(è& 
»ad_wr™es
;

189 
	}
}

191 
boŞ
 
	$is_li¡
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

192  
™em
.
	`æags
(è& 
li¡_b™
;

193 
	}
}

195 
boŞ
 
	$is_em±y
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

196  
™em
.
	`æags
(è& 
em±y_b™
;

197 
	}
}

199 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

200 ià(
™em
.
key
<>() == -1)

201  
txn
.
	`Œy_lock
(
™em
, 
v”siÚ_
);

202 ià(
™em
.
key
<>() == -2)

203  
txn
.
	`Œy_lock
(
™em
, 
h—dv”siÚ_
);

205  
Œue
;

206 
	}
}

208 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
t
è
ov”ride
 {

209 (è
t
;

211 ià(
™em
.
key
<>() == -2)

212  
™em
.
	`check_v”siÚ
(
h—dv”siÚ_
);

214 ià(
™em
.
key
<>() == -1)

215  
™em
.
	`check_v”siÚ
(
v”siÚ_
);

217 
	`as£¹
(0);

218  
çl£
;

219 
	}
}

221 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

223 ià(
™em
.
key
<>() == -2)

226 ià(
	`has_d–‘e
(
™em
)) {

228 ià(!
	`is_rw
(
™em
))

229 
h—d_
 = (h—d_+1è% 
BUF_SIZE
;

230 
h—dv”siÚ_
.
	`£t_v”siÚ
(
txn
.
	`comm™_tid
());

233 ià(
™em
.
key
<>() == -1) {

234 autØ
h—d_šdex
 = 
h—d_
;

236 ià(
	`is_li¡
(
™em
)) {

237 auto& 
wr™e_li¡
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
¡d
::
li¡
<
T
>>();

238 !
wr™e_li¡
.
	`em±y
()) {

240 
	`as£¹
(
_
 !ğ(
h—d_šdex
-1è% 
BUF_SIZE
);

241 
queueSlÙs
[
_
] = 
wr™e_li¡
.
	`äÚt
();

242 
wr™e_li¡
.
	`pİ_äÚt
();

243 
_
 = (_+1è% 
BUF_SIZE
;

246 ià(!
	`is_em±y
(
™em
)) {

247 auto& 
v®
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

248 
queueSlÙs
[
_
] = 
v®
;

249 
_
 = (_+1è% 
BUF_SIZE
;

252 
v”siÚ_
.
	`£t_v”siÚ
(
txn
.
	`comm™_tid
());

254 
	}
}

256 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

257 ià(
™em
.
key
<>() == -1)

258 
v”siÚ_
.
	`uÆock
();

259 ià(
™em
.
key
<>() == -2)

260 
h—dv”siÚ_
.
	`uÆock
();

261 
	}
}

263 
T
 
	gqueueSlÙs
[
BUF_SIZE
];

265 
	gh—d_
;

266 
	g_
;

267 
v”siÚ_ty³
 
	gv”siÚ_
;

268 
v”siÚ_ty³
 
	gh—dv”siÚ_
;

	@datatype/RBTree.hh

1 #´agm¨
Úû


3 
	~<ÿs£¹
>

4 
	~<ut™y
>

5 
	~"TaggedLow.hh
"

6 
	~"IÁ”çû.hh
"

7 
	~"TW¿µed.hh
"

8 
	~"RBT»eIÁ”Çl.hh
"

10 #iâdeà
STO_NO_STM


11 
	~"T¿n§ùiÚ.hh
"

14 
	#DEBUG
 0

	)

15 #ià
DEBUG


16 
T¿n§ùiÚTid
::
ty³
 
lock
;

19 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
> 
şass
 
	gRBT»eI‹¿tÜ
;

20 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
> 
şass
 
	gRBT»e
;

22 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

23 şas 
	crbw¿µ”
 : 
public
 
P
 {

24 
public
:

25 
ty³Çme
 
	tP
::
	tkey_ty³
 key_type;

26 
ty³Çme
 
	tP
::
	tv®ue_ty³
 value_type;

28 
ex¶ic™
 
šlše
 
	$rbw¿µ”
(cÚ¡ 
P
& 
x
)

29 : 
	$P
(
x
) {

31 
šlše
 cÚ¡ 
P
& 
	$rb·œ
() const {

32  *
this
;

33 
	}
}

34 
šlše
 
	gP
& 
	$mubË_rb·œ
() {

35  *
this
;

36 
	}
}

37 
	grblšks
<
	grbw¿µ”
<
	gP
> > 
	grblšks_
;

42 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
>

43 şas 
	crb·œ
 {

44 
	mpublic
:

45 
TW¿µed
<
	t¡d
::
	t·œ
<cÚ¡ 
	tK
, 
	tT
>> 
	tw¿µed_·œ
;

46 
ty³Çme
 
	tw¿µed_·œ
::
	tv”siÚ_ty³
 version_type;

47 
ty³Çme
 
	tv”siÚ_ty³
::
	tty³
 
	t¿w_v”siÚ
;

48 
K
 
	tkey_ty³
;

49 
T
 
	tv®ue_ty³
;

51 
cÚ¡ex´
 
	mT¿n§ùiÚTid
::
ty³
 
š£¹_b™
 = 
T¿n§ùiÚTid
::
u£r_b™
;

59 
ex¶ic™
 
	$rb·œ
(cÚ¡ 
K
& 
key
, cÚ¡ 
T
& 
v®ue
)

60 : 
	`key_
(
key
), 
	`v®_
(
v®ue
),

61 
	`v”s_
(
Sto
::
	`š™Ÿlized_tid
(è+ 
š£¹_b™
),

62 
	`nodev”s_
(
Sto
::
	`š™Ÿlized_tid
()), 
	$hohv”s_
() {}

63 
ex¶ic™
 
	`rb·œ
(
¡d
::
·œ
<cÚ¡ 
K
, 
T
>& 
kvp
)

64 : 
	`key_
(
kvp
.
fœ¡
), 
	`v®_
(kvp.
£cÚd
),

65 
	`v”s_
(
Sto
::
	`š™Ÿlized_tid
(è+ 
š£¹_b™
),

66 
	`nodev”s_
(
Sto
::
	`š™Ÿlized_tid
()), 
	$hohv”s_
(è{
	}
}

69 
	gv”siÚ_ty³
& 
	$v”siÚ
() {

70  
v”s_
;

71 
	}
}

72 cÚ¡ 
	gv”siÚ_ty³
& 
	$v”siÚ
() const {

73  
v”s_
;

74 
	}
}

75 
	gv”siÚ_ty³
& 
	$nodev”siÚ
() {

76  
nodev”s_
;

77 
	}
}

78 cÚ¡ 
	gv”siÚ_ty³
& 
	$nodev”siÚ
() const {

79  
nodev”s_
;

80 
	}
}

83 
	$lock
() {

84 
v”s_
.
	`lock
();

85 
	}
}

86 
	$uÆock
() {

87 ià(
v”s_
.
	`is_locked_h”e
())

88 
v”s_
.
	`uÆock
();

89 
	}
}

90 
boŞ
 
	$check
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

91  
™em
.
	`check_v”siÚ
(
v”s_
);

92 
	}
}

93 
	$š¡®l
(
T¿nsI‹m
& 
™em
, cÚ¡ 
T¿n§ùiÚ
& 
txn
) {

94 
v®_
.
	`wr™e
(
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>());

95 
txn
.
	`£t_v”siÚ
(
v”s_
);

96 
	}
}

99 
	$lock_nv
() {

100 
nodev”s_
.
	`lock
();

101 
	}
}

102 
	$uÆock_nv
() {

103 ià(
nodev”s_
.
	`is_locked_h”e
())

104 
nodev”s_
.
	`uÆock
();

105 
	}
}

106 
boŞ
 
	$check_nv
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

107  
™em
.
	`check_v”siÚ
(
nodev”s_
);

108 
	}
}

109 
	$š¡®l_nv
(cÚ¡ 
T¿n§ùiÚ
& 
txn
) {

110 
	`as£¹
(
nodev”s_
.
	`is_locked_h”e
());

111 
txn
.
	`£t_v”siÚ
(
nodev”s_
);

112 
	}
}

115 cÚ¡ 
	gK
& 
	$key
() const {

116  
key_
;

117 
	}
}

118 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	grb·œ
& 
	grhs
) const {

119  (
key
(è< 
	grhs
.key());

121 
boŞ
 
	gİ”©Ü
>(cÚ¡ 
	grb·œ
& 
	grhs
) const {

122  (
key
(è> 
	grhs
.key());

125 
T
 
	$»ad_v®ue
(
T¿nsProxy
& 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

126  
v®_
.
	`»ad
(
™em
, 
v”siÚ
);

127 
	}
}

128 
	gT
& 
	$wr™—bË_v®ue
() {

129  
v®_
.
	`acûss
();

130 
	}
}

133 
	$lock_hohv”siÚ
() {

134 
hohv”s_
.
	`lock
();

135 
	}
}

136 
	$uÆock_hohv”siÚ
() {

137 
	`as£¹
(
hohv”s_
.
	`is_locked_h”e
());

138 
TV”siÚ
 
	`nv
(
hohv”s_
.
	`v®ue
(è+ 
T¿n§ùiÚTid
::
šüem’t_v®ue
);

139 
hohv”s_
.
	`£t_v”siÚ_uÆock
(
nv
);

140 
	}
}

141 
v”siÚ_ty³
 
	$uÆocked_hohv”siÚ
() const {

142 
v”siÚ_ty³
 
v
 = 
hohv”s_
;

143 
v
.
	`is_locked
()) {

144 
	`acquœe_ãnû
();

145 
v
 = 
hohv”s_
;

147  
v
;

148 
	}
}

149 
boŞ
 
	$v®id©e_hohv”siÚ
(
v”siÚ_ty³
 
Şd_v
) const {

150 
	`acquœe_ãnû
();

151  (
hohv”s_
 =ğ
Şd_v
);

152 
	}
}

154 
	g´iv©e
:

156 cÚ¡ 
K
 
key_
;

157 
	gTW¿µed
<
	gT
> 
	gv®_
;

158 
v”siÚ_ty³
 
	gv”s_
;

159 
v”siÚ_ty³
 
	gnodev”s_
;

160 
v”siÚ_ty³
 
	ghohv”s_
;

163 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
> 
şass
 
	gRBProxy
;

165 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

166 
şass
 
	gRBT»e


167 #iâdeà
STO_NO_STM


168 : 
public
 
TObjeù


171 
ä›nd
 
şass
 
RBT»eI‹¿tÜ
<
K
, 
	gT
, 
	gGlob®Size
>;

172 
ä›nd
 
şass
 
	gRBProxy
<
	gK
, 
	gT
, 
	gGlob®Size
>;

174 
	gT¿n§ùiÚTid
::
	tty³
 
	tRWV”siÚ
;

175 
	gTW¿µed
<
	t¡d
::
	t·œ
<cÚ¡ 
	tK
, 
	tT
>> 
	tw¿µed_·œ
;

176 
ty³Çme
 
	tw¿µed_·œ
::
	tv”siÚ_ty³
 
	tV”siÚ
;

177 
V”siÚ
 
	tv”siÚ_ty³
;

179 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
š£¹_g
 = 
T¿nsI‹m
::
u£r0_b™
;

180 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
d–‘e_g
 = 
T¿nsI‹m
::
u£r0_b™
<<1;

181 
cÚ¡ex´
 
	gT¿n§ùiÚTid
::
ty³
 
š£¹_b™
 = 
T¿n§ùiÚTid
::
u£r_b™
;

183 
	gRBT»eI‹¿tÜ
<
	tK
, 
	tT
, 
	tGlob®Size
> 
	t™”©Ü
;

184 cÚ¡ 
	tRBT»eI‹¿tÜ
<
	tK
, 
	tT
, 
	tGlob®Size
> 
	tcÚ¡_™”©Ü
;

186 
	gpublic
:

187 
RBT»e
() {

188 
sizev”siÚ_
 = 0;

189 
	gsize_
 = 0;

190 
	gŒ“lock_
 = 0;

191 #ià
DEBUG


192 
	g¡©s_
 = {0,0,0,0,0,0};

196 
	grbw¿µ”
<
	trb·œ
<
	tK
, 
	tT
>> 
	tw¿µ”_ty³
;

197 
	grbŒ“
<
	tw¿µ”_ty³
> 
	tš‹º®_Œ“_ty³
;

199 
	grbnod•Œ
<
	tw¿µ”_ty³
> 
	tš‹º®_±r_ty³
;

200 
	g¡d
::
	ttu¶e
<
	tw¿µ”_ty³
*, 
	tV”siÚ
> 
	tnode_šfo_ty³
;

201 
	g¡d
::
	t·œ
<
	tnode_šfo_ty³
,‚ode_šfo_ty³> 
	tbound¬›s_ty³
;

204 
šlše
 
size_t
 
size
() const;

206 
šlše
 
size_t
 
couÁ
(cÚ¡ 
K
& 
key
) const;

208 
šlše
 
	gRBProxy
<
	gK
, 
	gT
, 
	gGlob®Size
> 
	gİ”©Ü
[](cÚ¡ K& 
	gkey
);

210 
šlše
 
size_t
 
”a£
(cÚ¡ 
K
& 
key
);

213 
boŞ
 
nÚŒªs_š£¹
(cÚ¡ 
K
& 
key
, cÚ¡ 
T
& 
v®ue
);

214 
boŞ
 
nÚŒªs_cÚšs
(cÚ¡ 
K
& 
key
);

215 
boŞ
 
nÚŒªs_»move
(cÚ¡ 
K
& 
key
);

216 
boŞ
 
nÚŒªs_»move
(cÚ¡ 
K
& 
key
, 
T
& 
Şdv®
);

217 
T
 
nÚŒªs_fšd
(cÚ¡ 
K
& 
key
);

218 
boŞ
 
nÚŒªs_fšd
(cÚ¡ 
K
& 
key
, 
T
& 
v®
);

220 
boŞ
 
¡amp_š£¹
(cÚ¡ 
K
& 
key
, cÚ¡ 
T
& 
v®
);

221 
T
 
¡amp_fšd
(cÚ¡ 
K
& 
key
);

232 
__©Œibu‹__
((
®ways_šlše
)è
	g¡d
::
tu¶e
<
w¿µ”_ty³
*, 
	gV”siÚ
, 
	gboŞ
, 
	gbound¬›s_ty³
> 
v”if›d_lookup
(
rbw¿µ”
<
rb·œ
<
K
, 
T
>>& 
rbkvp
) const {

234 autØ
	gš™Ÿl
 = 
Œ“lock_
;

235 
ãnû
();

236 ià(
	gT¿n§ùiÚTid
::
is_locked
(
š™Ÿl
)) {

237 
»Ïx_ãnû
();

240 autØ
	g»suÉs
 = 
w¿µ”_Œ“_
.
fšd_ªy
(
rbkvp
,

241 
rb´iv
::
make_com·»
<
w¿µ”_ty³
, w¿µ”_ty³>(
w¿µ”_Œ“_
.
r_
.
g‘_com·»
()));

242 
ãnû
();

243 ià(
	gš™Ÿl
 =ğ
Œ“lock_
)

244  
»suÉs
;

245 
»Ïx_ãnû
();

249 #iâdeà
STO_NO_STM


283 
boŞ
 
lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
&è
	gov”ride
;

284 
uÆock
(
T¿nsI‹m
& 
™em
è
	gov”ride
;

285 
boŞ
 
check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
Œªs
è
	gov”ride
;

286 
š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
t
è
	gov”ride
;

287 
ş—nup
(
T¿nsI‹m
& 
™em
, 
boŞ
 
comm™‹d
è
	gov”ride
;

288 #ià
DEBUG


289 
´št_ab£Á_»ads
();

291 
´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
ècÚ¡ 
	gov”ride
;

293 
	g´iv©e
:

294 
size_t
 
debug_size
() const {

295  
w¿µ”_Œ“_
.
size
();

358 
šlše
 
boŞ
 
is_phªtom_node
(
w¿µ”_ty³
* 
node
, 
V”siÚ
 
v®_v”
) const {

359 autØ
	g™em
 = 
Sto
::
™em
(
cÚ¡_ÿ¡
<
RBT»e
<
K
, 
T
, 
Glob®Size
>*>(
this
), 
node
);

360  (
is_š£¹ed
(
v®_v”
è&& !
has_š£¹
(
™em
è&& !
has_d–‘e
(item));

366 
šlše
 
boŞ
 
is_soá_phªtom
(
w¿µ”_ty³
* 
node
) const {

367 
	gV”siÚ
& 
	gv®_v”
 = 
node
->
v”siÚ
();

368 autØ
	g™em
 = 
Sto
::
™em
(
cÚ¡_ÿ¡
<
RBT»e
<
K
, 
T
, 
Glob®Size
>*>(
this
), 
node
);

369  (
is_š£¹ed
(
v®_v”
è&& (
has_š£¹
(
™em
è|| 
has_d–‘e
(item)));

373 
šlše
 
chªge_size_off£t
(
ssize_t
 
d–
) {

374 ià(!
	gGlob®Size
)

376 autØ
	gsize_™em
 = 
Sto
::
™em
(
this
, 
size_key_
);

377 
ssize_t
 
	g´ev_off£t
 = 
size_™em
.
has_wr™e
(è? size_™em.
‹m¶©e
 
wr™e_v®ue
<ssize_t>() : 0;

378 
	gsize_™em
.
add_wr™e
(
´ev_off£t
 + 
d–
);

379 
as£¹
(
size_
 + 
size_™em
.
‹m¶©e
 
wr™e_v®ue
<
ssize_t
>() >= 0);

380 #ià
DEBUG


381 
	gT¿n§ùiÚTid
::
lock
(::lock);

382 
´štf
("\tba£ size: %lu\n", 
size_
);

383 
´štf
("\toff£t: %ld\n", 
size_™em
.
‹m¶©e
 
wr™e_v®ue
<
ssize_t
>());

384 
	gT¿n§ùiÚTid
::
uÆock
(::
lock
);

394 
šlše
 
	g¡d
::
tu¶e
<
w¿µ”_ty³
*, 
	gV”siÚ
, 
	gboŞ
, 
	gbound¬›s_ty³
>

395 
fšd_Ü_abÜt
(
rbw¿µ”
<
rb·œ
<
K
, 
T
>>& 
rbkvp
) const {

396 autØ
	g»suÉs
 = 
v”if›d_lookup
(
rbkvp
);

399 
w¿µ”_ty³
* 
	gx
 = 
¡d
::
g‘
<0>(
»suÉs
);

400 
V”siÚ
 
	gv®_v”
 = 
¡d
::
g‘
<1>(
»suÉs
);

401 
boŞ
 
	gfound
 = 
¡d
::
g‘
<2>(
»suÉs
);

402 
	gbound¬›s_ty³
& 
	gbound¬›s
 = 
¡d
::
g‘
<3>(
»suÉs
);

405 ià(
	gfound
) {

406 autØ
	g™em
 = 
Sto
::
™em
(
cÚ¡_ÿ¡
<
RBT»e
<
K
, 
T
, 
Glob®Size
>*>(
this
), 
x
);

408 ià(
is_š£¹ed
(
v®_v”
)) {

410 ià(
has_š£¹
(
™em
è|| (
has_d–‘e
(item))) {

411  
	g»suÉs
;

414 #ià
DEBUG


415 
	gT¿n§ùiÚTid
::
lock
(::lock);

416 
´štf
("Aborted in find_or_abort\n");

417 
	gT¿n§ùiÚTid
::
uÆock
(::
lock
);

419 
	gSto
::
abÜt
();

421  
	g»suÉs
;

425 
	g™em
.
ob£rve
(
v®_v”
);

430 ià(!
	gx
) {

431 
	gSto
::
™em
(
cÚ¡_ÿ¡
<
RBT»e
<
K
, 
T
, 
Glob®Size
>*>(
this
), 
Œ“_key_
).
ob£rve
(
v®_v”
);

435 
	gi
 = 0; i < 2; ++i) {

436 
	gnode_šfo_ty³
& 
	gbšfo
 = (
i
 =ğ0)? 
bound¬›s
.
fœ¡
 : bound¬›s.
£cÚd
;

437 
w¿µ”_ty³
* 
	gn
 = 
¡d
::
g‘
<0>(
bšfo
);

438 
V”siÚ
 
	gv
 = 
¡d
::
g‘
<1>(
bšfo
);

439 ià(
	gn
) {

440 #ià
DEBUG


441 
	gT¿n§ùiÚTid
::
lock
(::lock);

442 
´štf
("\t#T¿ckšg bound¬y 0x%lx (k %d),‚v 0x%lx\n", ()
n
,‚->
key
(), 
v
);

443 
	gT¿n§ùiÚTid
::
uÆock
(::
lock
);

445 
	gSto
::
™em
(
cÚ¡_ÿ¡
<
RBT»e
<
K
, 
T
, 
Glob®Size
>*>(
this
),

446 (
»š‹½»t_ÿ¡
<
ušŒ_t
>(
n
)|0x1)).
ob£rve
(
v
);

451  
	g»suÉs
;

462 
šlše
 
	g¡d
::
tu¶e
<
w¿µ”_ty³
*, 
	gV”siÚ
, 
	gboŞ
, 
	gbound¬›s_ty³
, 
	gnode_šfo_ty³
>

463 
fšd_Ü_š£¹
(
w¿µ”_ty³
& 
rbkvp
) {

464 
lock_wr™e
(&
Œ“lock_
);

465 autØ
	g»suÉs
 = 
w¿µ”_Œ“_
.
fšd_š£¹
(
rbkvp
,

466 
rb´iv
::
make_com·»
<
w¿µ”_ty³
, w¿µ”_ty³>(
w¿µ”_Œ“_
.
r_
.
g‘_com·»
()));

467 
uÆock_wr™e
(&
Œ“lock_
);

469 
boŞ
 
	gfound
 = 
¡d
::
g‘
<2>(
»suÉs
);

470 
w¿µ”_ty³
* 
	gªs
 = 
¡d
::
g‘
<0>(
»suÉs
);

471 
V”siÚ
 
	gv”
 = 
¡d
::
g‘
<1>(
»suÉs
);

472 ià(
	gfound
 && 
is_phªtom_node
(
ªs
, 
v”
)) {

473 
	gSto
::
abÜt
();

475  
	g»suÉs
;

481 
šlše
 
w¿µ”_ty³
* 
š£¹_ab£Á
(
rbnod•Œ
<w¿µ”_ty³> 
found_p
, cÚ¡ 
K
& 
key
) {

482 #ià
DEBUG


483 
	g¡©s_
.
	gab£Á_š£¹
++;

487 
w¿µ”_ty³
* 
	gn
 = (w¿µ”_ty³*)
m®loc
((wrapper_type));

488 
Ãw
 (
n
è
w¿µ”_ty³
(
rb·œ
<
K
, 
T
>(
key
, T()));

490 
boŞ
 
	gside
 = (
found_p
.
node
(è=ğ
nuÎ±r
)? 
çl£
 :

491 
w¿µ”_Œ“_
.
r_
.
node_com·»
(*
n
, *
found_p
.
node
()) > 0;

492 
	gw¿µ”_Œ“_
.
š£¹_comm™
(
n
, 
found_p
, 
side
);

495 
as£¹
(
is_š£¹ed
(
n
->
v”siÚ
()));

497 ià(
	gfound_p
.
node
(è=ğ
nuÎ±r
) {

498 
Sto
::
™em
(
this
, 
Œ“_key_
).
add_wr™e
(0);

501 autØ
	gv”siÚs
 = 
found_p
.
node
()->
šc_nodev”siÚ
();

502 autØ
	g™em
 = 
Sto
::
™em
(
this
, 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
found_p
.
node
()) | 1);

504 ià(
	g™em
.
has_»ad
()) {

505 
	g™em
.
upd©e_»ad
(
v”siÚs
.
fœ¡
, v”siÚs.
£cÚd
);

509 
	gSto
::
™em
(
this
, 
n
).
add_wr™e
(
T
()).
add_æags
(
š£¹_g
);

515 
chªge_size_off£t
(1);

516  
	gn
;

522 
šlše
 
w¿µ”_ty³
* 
š£¹
(cÚ¡ 
K
& 
key
) {

523 
	grbw¿µ”
<
	grb·œ
<
	gK
, 
	gT
>> 
node
Ğ
rb·œ
<
K
, 
T
>(
key
, T()) );

524 autØ
	g»suÉs
 = 
this
->
fšd_Ü_š£¹
(
node
);

525 
w¿µ”_ty³
* 
	gx
 = 
¡d
::
g‘
<0>(
»suÉs
);

526 
V”siÚ
 
	gv”
 = 
¡d
::
g‘
<1>(
»suÉs
);

527 
boŞ
 
	gfound
 = 
¡d
::
g‘
<2>(
»suÉs
);

528 
	gbound¬›s_ty³
& 
	gbound¬›s
 = 
¡d
::
g‘
<3>(
»suÉs
);

529 
	gnode_šfo_ty³
& 
	gpšfo
 = 
¡d
::
g‘
<4>(
»suÉs
);

530 
w¿µ”_ty³
* 
	gp
 = 
¡d
::
g‘
<0>(
pšfo
);

536 ià(!
	gfound
) {

537 #ià
DEBUG


538 
	g¡©s_
.
	gab£Á_š£¹
++;

540 
w¿µ”_ty³
* 
	glhs
 = 
¡d
::
g‘
<0>(
bound¬›s
.
fœ¡
);

541 
w¿µ”_ty³
* 
	grhs
 = 
¡d
::
g‘
<0>(
bound¬›s
.
£cÚd
);

542 ià(
	gp
 =ğ
nuÎ±r
) {

544 
as£¹
(
lhs
 =ğ
nuÎ±r
 && 
rhs
 ==‚ullptr);

545 
	gSto
::
™em
(
this
, 
Œ“_key_
).
add_wr™e
(0);

548 autØ
	g™em
 = 
Sto
::
™em
(
this
, 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
p
) | 0x1);

549 
	g™em
.
add_wr™e
(0);

553 ià(
	gSto
::
™em
(
this
, 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
lhs
è| 0x1).
has_»ad
()

554 || 
	gSto
::
™em
(
this
, 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
rhs
è| 0x1).
has_»ad
()) {

555 
	gSto
::
™em
(
this
, 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
x
è| 0x1).
ob£rve
(
v”
);

558 
	gSto
::
™em
(
this
, 
x
).
add_wr™e
(
T
()).
add_æags
(
š£¹_g
);

559 
chªge_size_off£t
(1);

560  
	gx
;

565 #ià
DEBUG


566 
	g¡©s_
.
	g´e£Á_š£¹
++;

568 autØ
	g™em
 = 
Sto
::
™em
(
this
, 
x
);

571 ià(
has_d–‘e
(
™em
)) {

572 
	g™em
.
ş—r_æags
(
d–‘e_g
);

574 ià(
is_š£¹ed
(
v”
)) {

575 
	g™em
.
add_æags
(
š£¹_g
);

579 
	g™em
.
add_wr™e
(
T
());

581 
chªge_size_off£t
(1);

582  
	gx
;

591 
	g™em
.
ob£rve
(
v”
);

592  
	gx
;

597 #ifdeà
STO_NO_STM


598 
chªge_size_off£t
(){}

601 
lock_»ad
(
RWV”siÚ
 *
v
è{
	gT¿n§ùiÚTid
::lock_read(*v);}

602 
lock_wr™e
(
RWV”siÚ
 *
v
è{
	gT¿n§ùiÚTid
::lock_write(*v);}

603 
uÆock_»ad
(
RWV”siÚ
 *
v
è{
	gT¿n§ùiÚTid
::unlock_read(*v);}

604 
uÆock_wr™e
(
RWV”siÚ
 *
v
) {

605 
	gT¿n§ùiÚTid
::
šc_wr™e_v”siÚ
(*
v
);

606 
	gT¿n§ùiÚTid
::
uÆock_wr™e
(*
v
);

609 
boŞ
 
has_š£¹
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

610  
	g™em
.
æags
(è& 
	gš£¹_g
;

612 
boŞ
 
has_d–‘e
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

613  
	g™em
.
æags
(è& 
	gd–‘e_g
;

615 
boŞ
 
is_š£¹ed
(
V”siÚ
& 
v
) {

616  
	gv
.
v®ue
(è& 
	gš£¹_b™
;

618 
”a£_š£¹ed
(
V”siÚ
& 
v
) {

619 
	gv
.
v®ue
(è&ğ~
š£¹_b™
;

622 
š‹º®_Œ“_ty³
 
	gw¿µ”_Œ“_
;

624 
size_t
 
	gsize_
;

625 
V”siÚ
 
	gsizev”siÚ_
;

628 
mubË
 
RWV”siÚ
 
	gŒ“lock_
;

631 
cÚ¡ex´
 
ušŒ_t
 
	gŒ“_b™
 = 1U<<0;

632 
cÚ¡ex´
 
ušŒ_t
 
	gŒ“_key_
 = 
Œ“_b™
;

633 
cÚ¡ex´
 
ušŒ_t
 
	gsize_b™
 = 1U<<1;

634 
cÚ¡ex´
 
ušŒ_t
 
	gsize_key_
 = 
size_b™
;

635 
cÚ¡ex´
 
ušŒ_t
 
	g¡¬t_b™
 = 1U<<2;

636 
cÚ¡ex´
 
ušŒ_t
 
	g¡¬t_key_
 = 
¡¬t_b™
;

637 #ià
DEBUG


638 
mubË
 
	s¡©s
 {

639 
	gab£Á_š£¹
, 
	gab£Á_d–‘e
, 
	gab£Á_couÁ
;

640 
	g´e£Á_š£¹
, 
	g´e£Á_d–‘e
, 
	g´e£Á_couÁ
;

641 } 
	g¡©s_
;

645 #iâdeà
STO_NO_STM


647 
	g‹m¶©e
<
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

648 
şass
 
	gRBT»eI‹¿tÜ
 : 
public
 
¡d
::
™”©Ü
<¡d::
bidœeùiÚ®_™”©Ü_g
, 
	grbw¿µ”
<
	grb·œ
<
	gK
, 
	gT
>>> {

649 
	gpublic
:

650 
rbw¿µ”
<
	trb·œ
<
	tK
, 
	tT
>> 
	tw¿µ”
;

651 
	gRBT»eI‹¿tÜ
<
	tK
, 
	tT
, 
	tGlob®Size
> 
	t™”©Ü
;

652 
	gRBProxy
<
	tK
, 
	tT
, 
	tGlob®Size
> 
	t´oxy_ty³
;

653 
	g¡d
::
	t·œ
<cÚ¡ 
	tK
, 
	t´oxy_ty³
> 
	t´oxy_·œ_ty³
;

655 
RBT»eI‹¿tÜ
(
RBT»e
<
K
, 
T
, 
Glob®Size
> * 
Œ“
, 
w¿µ”
* 
node
è: 
Œ“_
Ñ»e), 
node_
Òode), 
´oxy_·œ_
(
nuÎ±r
) {

656 
	gthis
->
upd©e_´oxy_·œ
();

658 
RBT»eI‹¿tÜ
(cÚ¡ RBT»eI‹¿tÜ& 
™r
è: 
Œ“_
(™r.Œ“_), 
node_
(™r.node_), 
´oxy_·œ_
(
nuÎ±r
) {

659 
	gthis
->
upd©e_´oxy_·œ
();

661 ~
RBT»eI‹¿tÜ
() {

662 
	gthis
->
de¡roy_´oxy_·œ
();

665 
	gRBT»eI‹¿tÜ
& 
	gİ”©Ü
=(cÚ¡ 
RBT»eI‹¿tÜ
& 
v
) {

666 
Œ“_
 = 
v
.tree_;

667 
	gnode_
 = 
v
.
node_
;

668 
	gthis
->
upd©e_´oxy_·œ
();

669  *
	gthis
;

672 
boŞ
 
	gİ”©Ü
==(
™”©Ü
 
Ùh”
) const {

673  (
Œ“_
 =ğ
Ùh”
.Œ“_è&& (
node_
 == other.node_);

676 
boŞ
 
	gİ”©Ü
!=(
™”©Ü
 
Ùh”
) const {

677  !(
İ”©Ü
==(
Ùh”
));

681 
	g´oxy_·œ_ty³
& 
	gİ”©Ü
*() {

683 
	gSto
::
™em
(
Œ“_
, 
node_
).
ob£rve
Òode_->
v”siÚ
());

684 
	gthis
->
upd©e_´oxy_·œ
();

685  *
	g´oxy_·œ_
;

688 
´oxy_·œ_ty³
* 
	gİ”©Ü
->() {

690 
	gSto
::
™em
(
Œ“_
, 
node_
).
ob£rve
Òode_->
v”siÚ
());

691 
	gthis
->
upd©e_´oxy_·œ
();

692  
	g´oxy_·œ_
;

696 
	g™”©Ü
& 
	gİ”©Ü
++() {

697 
	gnode_
 = 
Œ“_
->
g‘_Ãxt
(
node_
);

698 
	gthis
->
upd©e_´oxy_·œ
();

699  *
	gthis
;

703 
™”©Ü
 
	gİ”©Ü
++() {

704 
	gRBT»eI‹¿tÜ
<
	gK
, 
	gT
, 
	gGlob®Size
> 
şÚe
(*
this
);

705 
	gnode_
 = 
Œ“_
->
g‘_Ãxt
(
node_
);

706 
	gthis
->
upd©e_´oxy_·œ
();

707  
	gşÚe
;

710 
	g™”©Ü
& 
	gİ”©Ü
--() {

711 
	gnode_
 = 
Œ“_
->
g‘_´ev
(
node_
);

712 
	gthis
->
upd©e_´oxy_·œ
();

713  *
	gthis
;

716 
™”©Ü
 
	gİ”©Ü
--() {

717 
	gRBT»eI‹¿tÜ
<
	gK
, 
	gT
, 
	gGlob®Size
> 
şÚe
(*
this
);

718 
	gnode_
 = 
Œ“_
->
g‘_´ev
(
node_
);

719 
	gthis
->
upd©e_´oxy_·œ
();

720  
	gşÚe
;

723 
	g´iv©e
:

724 
šlše
 
de¡roy_´oxy_·œ
() {

725 ià(
´oxy_·œ_
 !ğ
nuÎ±r
) {

726 
d–‘e
 
´oxy_·œ_
;

729 
šlše
 
upd©e_´oxy_·œ
() {

730 ià(
	g´oxy_·œ_
 !ğ
nuÎ±r
) {

731 
d–‘e
 
´oxy_·œ_
;

733 ià(
	gnode_
 =ğ
nuÎ±r
) {

734 
´oxy_·œ_
 = 
nuÎ±r
;

737 
´oxy_·œ_ty³
* 
	gÃw_·œ
 = 
Ãw
 
¡d
::
·œ
<cÚ¡ 
K
, 
	gRBProxy
<
	gK
, 
	gT
, 
	gGlob®Size
>>(
	gnode_
->
key
(), 
´oxy_ty³
(*
Œ“_
, 
node_
));

738 
	g´oxy_·œ_
 = 
Ãw_·œ
;

743 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
> * 
	gŒ“_
;

744 
w¿µ”
* 
	gnode_
;

745 
´oxy_·œ_ty³
* 
	g´oxy_·œ_
;

750 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

751 şas 
	cRBProxy
 {

752 
	mpublic
:

753 
RBT»e
<
	tK
, 
	tT
, 
	tGlob®Size
> 
	tŒª¡»e_t
;

754 
	mrbw¿µ”
<
	trb·œ
<
	tK
, 
	tT
>> 
	tw¿µ”_ty³
;

755 
	mT¿n§ùiÚTid
::
	tty³
 
	tV”siÚ
;

757 
ex¶ic™
 
	$RBProxy
(
Œª¡»e_t
& 
Œ“
, 
w¿µ”_ty³
* 
node
)

758 : 
	`Œ“_
(
Œ“
), 
	$node_
(
node
) {};

761 
İ”©Ü
 
	$T
() {

762 autØ
™em
 = 
Sto
::
	`™em
(&
Œ“_
, 
node_
);

763 ià(
™em
.
	`has_wr™e
()) {

764  
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

767  
node_
->
	`»ad_v®ue
(
™em
,‚ode_->
	`v”siÚ
());

769 
	}
}

770 
	gRBProxy
& 
	gİ”©Ü
=(cÚ¡ 
T
& 
v®ue
) {

771 autØ
™em
 = 
Sto
::™em(&
Œ“_
, 
node_
);

772 
	g™em
.
add_wr™e
(
v®ue
);

773  *
	gthis
;

775 
	gRBProxy
& 
	gİ”©Ü
=(
RBProxy
& 
Ùh”
) {

776 autØ
™em
 = 
Sto
::™em(&
Œ“_
, 
node_
);

777 
	g™em
.
add_wr™e
((
T
)
Ùh”
);

778  *
	gthis
;

780 
	g´iv©e
:

781 
Œª¡»e_t
& 
Œ“_
;

782 
w¿µ”_ty³
* 
	gnode_
;

785 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

786 
šlše
 
size_t
 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$size
() const {

787 
	`®ways_as£¹
(
Glob®Size
);

788 autØ
size_™em
 = 
Sto
::
	`™em
(
cÚ¡_ÿ¡
<
RBT»e
<
K
, 
T
, 
Glob®Size
>*>(
this
), 
size_key_
);

789 ià(!
size_™em
.
	`has_»ad
()) {

790 
size_™em
.
	`ob£rve
(
sizev”siÚ_
);

793 
ssize_t
 
off£t
 = (
size_™em
.
	`has_wr™e
()è? size_™em.
‹m¶©e
 
wr™e_v®ue
<ssize_t>() : 0;

794  
size_
 + 
off£t
;

795 
	}
}

797 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

798 
šlše
 
size_t
 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$couÁ
(cÚ¡ 
K
& 
key
) const {

799 
rbw¿µ”
<
rb·œ
<
K
, 
T
>> 
	`idx_·œ
Ôb·œ<K, T>(
key
, 
	`T
()));

802 autØ
»suÉs
 = 
	`fšd_Ü_abÜt
(
idx_·œ
);

804 
w¿µ”_ty³
* 
node
 = 
¡d
::
g‘
<0>(
»suÉs
);

805 
boŞ
 
found
 = 
¡d
::
g‘
<2>(
»suÉs
);

806 #ià
DEBUG


807 (!
found
è? 
¡©s_
.
ab£Á_couÁ
++ : sts_.
´e£Á_couÁ
++;

809 ià(
found
) {

810 autØ
™em
 = 
Sto
::
	`™em
(
cÚ¡_ÿ¡
<
RBT»e
<
K
, 
T
, 
Glob®Size
>*>(
this
), 
node
);

811 ià(
	`has_d–‘e
(
™em
)) {

816  (
found
) ? 1 : 0;

817 
	}
}

819 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

820 
šlše
 
	gRBProxy
<
	gK
, 
	gT
, 
	gGlob®Size
> 
	gRBT»e
<K, T, Glob®Size>::
İ”©Ü
[](cÚ¡ 
K
& 
key
) {

822 autØ
node
 = 
š£¹
(
key
);

823  
	gRBProxy
<
	gK
, 
	gT
, 
	gGlob®Size
>(*
	gthis
, 
	gnode
);

826 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

827 
šlše
 
size_t
 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$”a£
(cÚ¡ 
K
& 
key
) {

828 
rbw¿µ”
<
rb·œ
<
K
, 
T
>> 
	`idx_·œ
Ôb·œ<K, T>(
key
, 
	`T
()));

830 autØ
»suÉs
 = 
	`fšd_Ü_abÜt
(
idx_·œ
);

831 
w¿µ”_ty³
* 
x
 = 
¡d
::
g‘
<0>(
»suÉs
);

832 
boŞ
 
found
 = 
¡d
::
g‘
<2>(
»suÉs
);

833 
V”siÚ
 
v”
 = 
¡d
::
g‘
<1>(
»suÉs
);

836 ià(
found
) {

837 #ià
DEBUG


838 
¡©s_
.
´e£Á_d–‘e
++;

840 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
x
);

843 ià(
	`is_š£¹ed
(
v”
)) {

845 ià(
	`has_š£¹
(
™em
)) {

846 
™em
.
	`add_wr™e
(0).
	`ş—r_æags
(
š£¹_g
).
	`add_æags
(
d–‘e_g
);

847 
	`chªge_size_off£t
(-1);

849 } ià(
	`has_d–‘e
(
™em
)) {

854 #ià
DEBUG


855 
T¿n§ùiÚTid
::
	`lock
(::
lock
);

856 
	`´štf
("Aborted inƒrase (insert bit set)\n");

857 
T¿n§ùiÚTid
::
	`uÆock
(::
lock
);

859 
Sto
::
	`abÜt
();

864 } ià(
	`has_d–‘e
(
™em
)) {

869 
™em
.
	`add_wr™e
(0).
	`add_æags
(
d–‘e_g
);

872 
	`chªge_size_off£t
(-1);

877 #ià
DEBUG


878 
¡©s_
.
ab£Á_d–‘e
++;

882 
	}
}

884 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

885 
boŞ
 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
) {

886 ià(
™em
.
key
<
ušŒ_t
>(è=ğ
size_key_
)

887  
txn
.
	`Œy_lock
(
™em
, 
sizev”siÚ_
);

888 ià(
™em
.
key
<
ušŒ_t
>(è=ğ
Œ“_key_
)

889  
txn
.
	`Œy_lock
(
™em
, 
w¿µ”_Œ“_
.
Œ“v”siÚ_
);

891 
ušŒ_t
 
x
 = 
™em
.
key
<uintptr_t>();

892 
w¿µ”_ty³
* 
n
 = 
»š‹½»t_ÿ¡
<w¿µ”_ty³*>(
x
 & ~
	`ušŒ_t
(1));

893 ià(((!(
x
 & 1è&& !
	`has_d–‘e
(
™em
))

894 || 
n
->
	`nodev”siÚ
().
	`is_locked_h”e
()

895 || 
txn
.
	`Œy_lock
(
™em
, 
n
->
	`nodev”siÚ
()))

896 && ((
x
 & 1è|| 
txn
.
	`Œy_lock
(
™em
, 
n
->
	`v”siÚ
())))

897  
Œue
;

899 
n
->
	`uÆock_nv
();

900  
çl£
;

903 
	}
}

905 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

906 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$uÆock
(
T¿nsI‹m
& 
™em
) {

907 ià(
™em
.
key
<
ušŒ_t
>(è=ğ
size_key_
) {

908 
sizev”siÚ_
.
	`uÆock
();

909 } ià(
™em
.
key
<
ušŒ_t
>(è=ğ
Œ“_key_
) {

910 
w¿µ”_Œ“_
.
Œ“v”siÚ_
.
	`uÆock
();

912 
ušŒ_t
 
x
 = 
™em
.
key
<uintptr_t>();

913 
w¿µ”_ty³
* 
n
 = 
»š‹½»t_ÿ¡
<w¿µ”_ty³*>(
x
 & ~
	`ušŒ_t
(1));

914 ià(!(
x
 & 1)) {

915 
n
->
	`uÆock
();

916 ià(!
	`has_d–‘e
(
™em
))

919 
n
->
	`uÆock_nv
();

921 
	}
}

923 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

924 
boŞ
 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
&) {

925 autØ
e
 = 
™em
.
key
<
ušŒ_t
>();

926 
boŞ
 
is_Œ“key
 = ((
ušŒ_t
)
e
 =ğ(ušŒ_t)
Œ“_key_
);

927 
boŞ
 
is_sizekey
 = ((
ušŒ_t
)
e
 =ğ(ušŒ_t)
size_key_
);

928 
boŞ
 
is_¡ruùu»d
 = (
e
 & 
	`ušŒ_t
(1)è&& !
is_Œ“key
;

929 
V”siÚ
 
»ad_v”siÚ
 = 
™em
.
»ad_v®ue
<Version>();

930 
V”siÚ
 
cu¼_v”siÚ
;

932 ià(
is_sizekey
) {

933 
cu¼_v”siÚ
 = 
sizev”siÚ_
;

934 } ià(
is_Œ“key
) {

935 
cu¼_v”siÚ
 = 
w¿µ”_Œ“_
.
Œ“v”siÚ_
;

936 } ià(
is_¡ruùu»d
) {

937 
w¿µ”_ty³
* 
n
 = 
»š‹½»t_ÿ¡
<w¿µ”_ty³*>(
e
 & ~
	`ušŒ_t
(1));

938  
n
->
	`check_nv
(
™em
);

939 #ià
DEBUG


940 
T¿n§ùiÚTid
::
	`lock
(::
lock
);

941 
	`´štf
("\t#»ad %°nv 0x%lx,ƒx°%lx\n", 
n
, 
cu¼_v”siÚ
, 
»ad_v”siÚ
);

942 
T¿n§ùiÚTid
::
	`uÆock
(::
lock
);

945 
w¿µ”_ty³
* 
n
 = 
»š‹½»t_ÿ¡
<w¿µ”_ty³*>(
e
);

946  
n
->
	`check
(
™em
);

948 
	`ãnû
();

952 ià(
cu¼_v”siÚ
.
	`check_v”siÚ
(
»ad_v”siÚ
))

953  
Œue
;

954 #ià
DEBUG


955 ià(!
is_sizekey
 && !
is_Œ“key
) {

956 
w¿µ”_ty³
* 
node
 = 
»š‹½»t_ÿ¡
<w¿µ”_ty³*>(
e
 & ~
	`ušŒ_t
(1));

957 
k_
 = 
node
?‚ode->
	`key
() : 0;

958 
v_
 = 
node
?‚ode->
	`wr™—bË_v®ue
() : 0;

959 
T¿n§ùiÚTid
::
	`lock
(::
lock
);

960 
	`´štf
("Check faed‡ˆTI‹m %°(key=%d, v®=%d)\n", (*)
e
, 
k_
, 
v_
);

961 
T¿n§ùiÚTid
::
	`uÆock
(::
lock
);

963 
T¿n§ùiÚTid
::
	`lock
(::
lock
);

964 ià((
cu¼_v”siÚ
 ^ 
»ad_v”siÚ
è>ğ(
T¿n§ùiÚTid
::
lock_b™
 << 1))

965 
	`´štf
("\tV”siÚ mism©ch: %lx -> %lx\n", 
»ad_v”siÚ
, 
cu¼_v”siÚ
);

966 ià(
T¿n§ùiÚTid
::
	`is_locked_–£wh”e
(
cu¼_v”siÚ
))

967 
	`´štf
("\tVersion†ockedƒlsewhere\n");

968 
T¿n§ùiÚTid
::
	`uÆock
(::
lock
);

970  
çl£
;

971 
	}
}

974 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

975 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
t
) {

977 
w¿µ”_ty³
* 
e
 = 
™em
.
key
<wrapper_type*>();

979 ià(
e
 =ğ(
w¿µ”_ty³
*)
Œ“_key_
) {

980 
	`as£¹
(
w¿µ”_Œ“_
.
Œ“v”siÚ_
.
	`is_locked_h”e
());

981 
t
.
	`£t_v”siÚ_uÆock
(
w¿µ”_Œ“_
.
Œ“v”siÚ_
, 
™em
);

983 } ià(
e
 =ğ(
w¿µ”_ty³
*)
size_key_
) {

984 
	`®ways_as£¹
(
Glob®Size
);

985 
	`as£¹
(
sizev”siÚ_
.
	`is_locked_h”e
());

986 
size_
 +ğ
™em
.
‹m¶©e
 
wr™e_v®ue
<
ssize_t
>();

987 
t
.
	`£t_v”siÚ_uÆock
(
sizev”siÚ_
, 
™em
);

988 
	`as£¹
((
ssize_t
)
size_
 >= 0);

989 } ià(
	`ušŒ_t
(
e
) & uintptr_t(1)) {

990 autØ
n
 = 
»š‹½»t_ÿ¡
<
w¿µ”_ty³
*>(
	`ušŒ_t
(
e
) & ~uintptr_t(1));

991 
n
->
	`š¡®l_nv
(
t
);

993 
	`as£¹
(
e
->
	`v”siÚ
().
	`is_locked_h”e
());

994 
	`as£¹
(((
ušŒ_t
)
e
 & 0x1) == 0);

995 
boŞ
 
d–‘ed
 = 
	`has_d–‘e
(
™em
);

996 
boŞ
 
š£¹ed
 = 
	`has_š£¹
(
™em
);

999 
	`as£¹
(!(
d–‘ed
 && 
š£¹ed
));

1001 ià(
d–‘ed
) {

1003 
	`lock_wr™e
(&
Œ“lock_
);

1004 
w¿µ”_Œ“_
.
	`”a£
(*
e
);

1005 
	`uÆock_wr™e
(&
Œ“lock_
);

1007 
e
->
	`v”siÚ
().
	`£t_v”siÚ
(
t
.
	`comm™_tid
());

1008 
e
->
	`š¡®l_nv
(
t
);

1009 
T¿n§ùiÚ
::
	`rcu_ä“
(
e
);

1012 
e
->
	`š¡®l
(
™em
, 
t
);

1015 
	}
}

1017 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

1018 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$ş—nup
(
T¿nsI‹m
& 
™em
, 
boŞ
 
comm™‹d
) {

1019 ià(!
comm™‹d
) {

1022 ià(
	`has_š£¹
(
™em
è|| 
	`has_d–‘e
(item)) {

1023 autØ
e
 = 
™em
.
key
<
w¿µ”_ty³
*>();

1024 
	`as£¹
(((
ušŒ_t
)
e
 & 0x1) == 0);

1025 ià(!
	`is_š£¹ed
(
e
->
	`v”siÚ
()))

1027 
	`lock_wr™e
(&
Œ“lock_
);

1028 
w¿µ”_Œ“_
.
	`”a£
(*
e
);

1029 
	`uÆock_wr™e
(&
Œ“lock_
);

1031 
e
->
	`nodev”siÚ
().
	`£t_nÚİaque
();

1032 
T¿n§ùiÚ
::
	`rcu_ä“
(
e
);

1035 
	}
}

1037 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

1038 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
) const {

1039 
w
 << "{RBT»e<" << 
	`ty³id
(
K
).
	`Çme
(è<< "," <<y³id(
T
).Çme(è<< "> " << (*è
this
;

1040 ià(
™em
.
key
<
ušŒ_t
>(è=ğ
size_key_
)

1041 
w
 << ".size";

1042 ià(
™em
.
key
<
ušŒ_t
>(è=ğ
Œ“_key_
)

1043 
w
 << ".tree";

1045 
ušŒ_t
 
x
 = 
™em
.
key
<uintptr_t>();

1046 ià(
x
 & 1)

1047 
w
 << "." << (*è(
x
 & ~
	`ušŒ_t
(1)) << "V";

1049 
w
 << "." << (*è
x
;

1051 ià(
™em
.
	`has_»ad
())

1052 
w
 << " R" << 
™em
.
»ad_v®ue
<
v”siÚ_ty³
>();

1053 ià(
™em
.
	`has_wr™e
()) {

1054 ià(
™em
.
key
<
ušŒ_t
>(è=ğ
size_key_
)

1055 
w
 << " Î”" << 
™em
.
wr™e_v®ue
<
ssize_t
>();

1056 ià(
™em
.
key
<
ušŒ_t
>(è=ğ
Œ“_key_


1057 || (
™em
.
key
<
ušŒ_t
>() & 1))

1058 
w
 << " Î”";

1060 
w
 << " =" << 
™em
.
wr™e_v®ue
<
T
>();

1062 
w
 << "}";

1063 
	}
}

1068 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

1069 
boŞ
 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$¡amp_š£¹
(cÚ¡ 
K
& 
key
, cÚ¡ 
T
& 
v®ue
) {

1070 
rbw¿µ”
<
rb·œ
<
K
, 
T
>> 
	`node
Ğrb·œ<K, T>(
key
, 
v®ue
) );

1071 autØ
»suÉs
 = 
this
->
	`fšd_Ü_š£¹
(
node
);

1072 
w¿µ”_ty³
* 
x
 = 
¡d
::
g‘
<0>(
»suÉs
);

1073 
V”siÚ
 
v”
 = 
¡d
::
g‘
<1>(
»suÉs
);

1074 
boŞ
 
found
 = 
¡d
::
g‘
<2>(
»suÉs
);

1075 
bound¬›s_ty³
& 
bound¬›s
 = 
¡d
::
g‘
<3>(
»suÉs
);

1076 
node_šfo_ty³
& 
pšfo
 = 
¡d
::
g‘
<4>(
»suÉs
);

1077 
w¿µ”_ty³
* 
p
 = 
¡d
::
g‘
<0>(
pšfo
);

1079 
V”siÚ
 
p_v”
 = 
¡d
::
g‘
<1>(
pšfo
);

1083 ià(!
found
) {

1084 
w¿µ”_ty³
* 
lhs
 = 
¡d
::
g‘
<0>(
bound¬›s
.
fœ¡
);

1085 
w¿µ”_ty³
* 
rhs
 = 
¡d
::
g‘
<0>(
bound¬›s
.
£cÚd
);

1086 ià(
p
 =ğ
nuÎ±r
) {

1088 
	`as£¹
(
lhs
 =ğ
nuÎ±r
 && 
rhs
 ==‚ullptr);

1089 
Sto
::
	`™em
(
this
, 
Œ“_key_
).
	`add_wr™e
(0);

1092 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
p
) | 0x1);

1093 
™em
.
	`add_wr™e
(0);

1097 ià(
Sto
::
	`™em
(
this
, 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
lhs
è| 0x1).
	`has_»ad
()

1098 || 
Sto
::
	`™em
(
this
, 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
rhs
è| 0x1).
	`has_»ad
()) {

1099 
Sto
::
	`™em
(
this
, 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
x
è| 0x1).
	`ob£rve
(
v”
);

1102 
Sto
::
	`™em
(
this
, 
x
).
	`add_wr™e
(
v®ue
).
	`add_æags
(
š£¹_g
);

1103 
	`chªge_size_off£t
(1);

1104  
Œue
;

1109 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
x
);

1112 ià(
	`has_d–‘e
(
™em
)) {

1113 
™em
.
	`ş—r_æags
(
d–‘e_g
);

1115 ià(
	`is_š£¹ed
(
v”
)) {

1118 
™em
.
	`add_æags
(
š£¹_g
);

1122 
™em
.
	`add_wr™e
(
v®ue
);

1124 
	`chªge_size_off£t
(1);

1125  
Œue
;

1134 
™em
.
	`ob£rve
(
v”
);

1135  
çl£
;

1138 
	}
}

1140 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

1141 
T
 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$¡amp_fšd
(cÚ¡ 
K
& 
key
) {

1142 
rbw¿µ”
<
rb·œ
<
K
, 
T
>> 
	`idx_·œ
Ôb·œ<K, T>(
key
, 
	`T
()));

1146 autØ
»suÉs
 = 
	`fšd_Ü_abÜt
(
idx_·œ
);

1148 
w¿µ”_ty³
* 
node
 = 
¡d
::
g‘
<0>(
»suÉs
);

1149 
V”siÚ
 
v”
 = 
¡d
::
g‘
<1>(
»suÉs
);

1150 
boŞ
 
found
 = 
¡d
::
g‘
<2>(
»suÉs
);

1151 ià(
found
) {

1152 autØ
™em
 = 
Sto
::
	`™em
(
cÚ¡_ÿ¡
<
RBT»e
<
K
, 
T
, 
Glob®Size
>*>(
this
), 
node
);

1153 ià(
	`has_d–‘e
(
™em
)) {

1155  
	`T
();

1157  
node
->
	`»ad_v®ue
(
™em
, 
v”
);

1159  
	`T
();

1161 
	}
}

1163 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

1164 
boŞ
 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$nÚŒªs_š£¹
(cÚ¡ 
K
& 
key
, cÚ¡ 
T
& 
v®ue
) {

1165 
	`lock_wr™e
(&
Œ“lock_
);

1166 
w¿µ”_ty³
 
	`idx_·œ
(
rb·œ
<
K
, 
T
>(
key
, 
v®ue
));

1167 autØ
»suÉs
 = 
w¿µ”_Œ“_
.
	`fšd_Ü_·»Á
(
idx_·œ
,

1168 
rb´iv
::
make_com·»
<
w¿µ”_ty³
, w¿µ”_ty³>(
w¿µ”_Œ“_
.
r_
.
	`g‘_com·»
()));

1169 
boŞ
 
found
 = 
¡d
::
g‘
<1>(
»suÉs
);

1170 ià(!
found
) {

1171 
size_
++;

1172 
rbnod•Œ
<
w¿µ”_ty³
> 
p
 = 
¡d
::
g‘
<0>(
»suÉs
);

1173 
w¿µ”_ty³
* 
n
 = (w¿µ”_ty³*)
	`m®loc
((wrapper_type));

1174 
	`Ãw
 (
n
è
	`w¿µ”_ty³
(
rb·œ
<
K
, 
T
>(
key
, 
v®ue
));

1175 
	`”a£_š£¹ed
(
n
->
	`v”siÚ
());

1176 
boŞ
 
side
 = (
p
.
	`node
(è=ğ
nuÎ±r
è? 
çl£
 : (
w¿µ”_Œ“_
.
r_
.
	`node_com·»
(*
n
, *p.node()) > 0);

1177 
w¿µ”_Œ“_
.
	`š£¹_comm™
(
n
, 
p
, 
side
);

1179 
	`uÆock_wr™e
(&
Œ“lock_
);

1180  !
found
;

1181 
	}
}

1183 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

1184 
boŞ
 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$nÚŒªs_cÚšs
(cÚ¡ 
K
& 
key
) {

1185 
w¿µ”_ty³
 
	`idx_·œ
(
rb·œ
<
K
, 
T
>(
key
, 
	`T
()));

1186 autØ
»suÉs
 = 
	`v”if›d_lookup
(
idx_·œ
);

1187  
¡d
::
g‘
<2>(
»suÉs
);

1188 
	}
}

1190 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

1191 
T
 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$nÚŒªs_fšd
(cÚ¡ 
K
& 
key
) {

1192 
w¿µ”_ty³
 
	`idx_·œ
(
rb·œ
<
K
, 
T
>(
key
, 
	`T
()));

1193 autØ
»suÉs
 = 
	`v”if›d_lookup
(
idx_·œ
);

1194 
boŞ
 
found
 = 
¡d
::
g‘
<2>(
»suÉs
);

1196 
T
 
»t
 = 
found
 ? 
¡d
::
g‘
<0>(
»suÉs
)->
	`wr™—bË_v®ue
(è: 
	`T
();

1197  
»t
;

1198 
	}
}

1200 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

1201 
boŞ
 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$nÚŒªs_fšd
(cÚ¡ 
K
& 
key
, 
T
& 
v®
) {

1202 
w¿µ”_ty³
 
	`idx_·œ
(
rb·œ
<
K
, 
T
>(
key
, 
	`T
()));

1203 autØ
»suÉs
 = 
	`v”if›d_lookup
(
idx_·œ
);

1204 
boŞ
 
found
 = 
¡d
::
g‘
<2>(
»suÉs
);

1205 ià(
found
) {

1206 
v®
 = 
¡d
::
g‘
<0>(
»suÉs
)->
	`wr™—bË_v®ue
();

1208  
found
;

1209 
	}
}

1211 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

1212 
boŞ
 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$nÚŒªs_»move
(cÚ¡ 
K
& 
key
) {

1213 
	`lock_wr™e
(&
Œ“lock_
);

1214 
w¿µ”_ty³
 
	`idx_·œ
(
rb·œ
<
K
, 
T
>(
key
, 
	`T
()));

1215 autØ
»suÉs
 = 
w¿µ”_Œ“_
.
	`fšd_ªy
(
idx_·œ
,

1216 
rb´iv
::
make_com·»
<
w¿µ”_ty³
, w¿µ”_ty³>(
w¿µ”_Œ“_
.
r_
.
	`g‘_com·»
()));

1217 
boŞ
 
found
 = 
¡d
::
g‘
<2>(
»suÉs
);

1218 ià(
found
) {

1219 
size_
--;

1220 
w¿µ”_ty³
* 
n
 = 
¡d
::
g‘
<0>(
»suÉs
);

1221 
w¿µ”_Œ“_
.
	`”a£
(*
n
);

1222 
	`ä“
(
n
);

1224 
	`uÆock_wr™e
(&
Œ“lock_
);

1225  
found
;

1226 
	}
}

1230 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

1231 
boŞ
 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$nÚŒªs_»move
(cÚ¡ 
K
& 
key
, 
T
& 
Şdv®
) {

1232 
	`lock_wr™e
(&
Œ“lock_
);

1233 
w¿µ”_ty³
 
	`idx_·œ
(
rb·œ
<
K
, 
T
>(
key
, 
	`T
()));

1234 autØ
»suÉs
 = 
w¿µ”_Œ“_
.
	`fšd_ªy
(
idx_·œ
,

1235 
rb´iv
::
make_com·»
<
w¿µ”_ty³
, w¿µ”_ty³>(
w¿µ”_Œ“_
.
r_
.
	`g‘_com·»
()));

1236 
boŞ
 
found
 = 
¡d
::
g‘
<2>(
»suÉs
);

1237 ià(
found
) {

1238 
size_
--;

1239 
w¿µ”_ty³
* 
n
 = 
¡d
::
g‘
<0>(
»suÉs
);

1241 
Şdv®
 = 
n
->
	`wr™—bË_v®ue
();

1242 
w¿µ”_Œ“_
.
	`”a£
(*
n
);

1243 
	`ä“
(
n
);

1245 
	`uÆock_wr™e
(&
Œ“lock_
);

1246  
found
;

1247 
	}
}

1250 #ià
DEBUG


1251 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
, 
boŞ
 
	gGlob®Size
>

1252 
šlše
 
	gRBT»e
<
	gK
, 
	gT
, 
	gGlob®Size
>::
	$´št_ab£Á_»ads
() {

1253 
¡d
::
cout
 << "ab£Á in£¹s: " << 
¡©s_
.
ab£Á_š£¹
 << std::
’dl
;

1254 
¡d
::
cout
 << "ab£Á d–‘es: " << 
¡©s_
.
ab£Á_d–‘e
 << std::
’dl
;

1255 
¡d
::
cout
 << "ab£Á couÁs: " << 
¡©s_
.
ab£Á_couÁ
 << std::
’dl
;

1256 
¡d
::
cout
 << "´e£Á in£¹s: " << 
¡©s_
.
´e£Á_š£¹
 << std::
’dl
;

1257 
¡d
::
cout
 << "´e£Á d–‘es: " << 
¡©s_
.
´e£Á_d–‘e
 << std::
’dl
;

1258 
¡d
::
cout
 << "´e£Á couÁs: " << 
¡©s_
.
´e£Á_couÁ
 << std::
’dl
;

1259 
¡d
::
cout
 << "size: " << 
	`debug_size
(è<< std::
’dl
;

1260 
	}
}

	@datatype/RBTreeInternal.hh

1 #´agm¨
Úû


3 
	~<ut™y
>

4 
	~<tu¶e
>

5 
	~<veùÜ
>

6 
	~<iomª
>

7 
	~<io¡»am
>

8 
	~"IÁ”çû.hh
"

10 #iâdeà
rbaccouÁ


11 
	#rbaccouÁ
(
x
)

	)

14 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

15 şas 
	crbnod•Œ
 {

16 
	mpublic
:

18 
boŞ
 (
	trbnod•Œ
<
	tT
>::*
	tun¥ecif›d_boŞ_ty³
)() const;

20 
rbnod•Œ
() = ;

21 
šlše
 
rbnod•Œ
(
T
* 
x
, 
boŞ
 
cŞÜ
);

22 
ex¶ic™
 
šlše
 
rbnod•Œ
(
ušŒ_t
 
iv®ue
);

24 
šlše
 
İ”©Ü
 
	$un¥ecif›d_boŞ_ty³
() const;

25 
šlše
 
boŞ
 
İ”©Ü
!() const;

26 
šlše
 
ušŒ_t
 
	$iv®ue
() const;

28 
šlše
 
T
* 
	$node
() const;

29 
šlše
 
rbnod•Œ
<
T
>& 
	$chd
(
boŞ
 
i¤ight
) const;

30 
šlše
 
boŞ
 
	$chd»n_§me_cŞÜ
() const;

31 
šlše
 
boŞ
 
	$fšd_chd
(
T
* 
node
) const;

32 
šlše
 
rbnod•Œ
<
T
>& 
	`lßd_cŞÜ
();

33 
šlše
 
rbnod•Œ
<
T
> 
	`£t_chd
(
boŞ
 
i¤ight
,„bnod•Œ<T> 
x
, T*& 
roÙ
) const;

34 
šlše
 
T
*& 
	$·»Á
() const;

35 
šlše
 
rbnod•Œ
<
T
> 
	$bÏck_·»Á
() const;

37 
šlše
 
boŞ
 
	$»d
() const;

38 
šlše
 
rbnod•Œ
<
T
> 
	$chªge_cŞÜ
(
boŞ
 
cŞÜ
) const;

39 
šlše
 
rbnod•Œ
<
T
> 
	$»v”£_cŞÜ
() const;

41 
šlše
 
rbnod•Œ
<
T
> 
	$rÙ©e
(
boŞ
 
i¤ight
) const;

42 
šlše
 
rbnod•Œ
<
T
> 
	$æ
() const;

44 
size_t
 
	$size
() const;

45 
‹m¶©e
 <
ty³Çme
 
C
>

46 
	$check
(
T
* 
·»Á
, 
this_bÏck_height
, & 
bÏck_height
,

47 
T
* 
roÙ
, T* 
begš
, T* 
’d
, 
C
& 
com·»
) const;

48 
	$ouut
(
¡d
::
o¡»am
& 
s
, 
šd’t
, 
T
* 
highlight
) const;

50 
´iv©e
:

51 
ušŒ_t
 
x_
;

54 
‹m¶©e
 <
ty³Çme
 
T
>

55 şas 
	crblšks
 {

56 
public
:

57 
T
* 
p_
;

58 
rbnod•Œ
<
T
> 
c_
[2];

61 
Çme¥aû
 
rb´iv
 {

62 
‹m¶©e
 <
ty³Çme
 
Com·»
>

63 
rbcom·»
 : 
´iv©e
 
Com·»
 {

64 
šlše
 
	`rbcom·»
(cÚ¡ 
Com·»
 &
com·»
);

65 
‹m¶©e
 <
ty³Çme
 
T
>

66 
šlše
 
	`node_com·»
(cÚ¡ 
T
& 
a
, cÚ¡ T& 
b
) const;

67 
‹m¶©e
 <
ty³Çme
 
A
,y³Çm
B
>

68 
šlše
 
	`com·»
(cÚ¡ 
A
 &
a
, cÚ¡ 
B
 &
b
) const;

69 
šlše
 
Com·»
& 
	`g‘_com·»
() const;

72 
‹m¶©e
 <
ty³Çme
 
T
>

73 
	sdeçuÉ_com·¿tÜ
 {

74 
šlše
 
	`İ”©Ü
()(cÚ¡ 
T
 &
a
, cÚ¡ T &
b
) const {

75  
a
 < 
b
 ? -1 : (b <‡ ? 1 : 0);

79 
‹m¶©e
 <
ty³Çme
 
T
>

80 
šlše
 
	`deçuÉ_com·»
(cÚ¡ 
T
 &
a
, cÚ¡ T &
b
) {

81  
deçuÉ_com·¿tÜ
<
T
>()(
a
, 
b
);

84 
‹m¶©e
 <
ty³Çme
 
T
,y³Çm
Com·»
>

85 
rb»p
 : 
public
 
rbcom·»
<
Com·»
> {

86 
T
* 
roÙ_
;

87 
T
* 
lim™_
[2];

88 
rbcom·»
<
	tCom·»
> 
	trbcom·»_ty³
;

89 
šlše
 
	`rb»p
(cÚ¡ 
Com·»
 &
com·»
);

92 
‹m¶©e
 <
ty³Çme
 
C
,y³Çm
R‘
> 
şass
 
rbcom·¿tÜ
;

94 
‹m¶©e
 <
ty³Çme
 
C
>

95 
şass
 
rbcom·¿tÜ
<
C
, 
boŞ
> {

96 
public
:

97 
šlše
 
	`rbcom·¿tÜ
(
C
 
comp
)

98 : 
	`comp_
(
comp
) {

100 
‹m¶©e
 <
ty³Çme
 
A
,y³Çm
B
>

101 
šlše
 
boŞ
 
	`Ëss
(cÚ¡ 
A
& 
a
, cÚ¡ 
B
& 
b
) {

102  
	`comp_
(
a
, 
b
);

104 
‹m¶©e
 <
ty³Çme
 
A
,y³Çm
B
>

105 
šlše
 
boŞ
 
	`g»©”
(cÚ¡ 
A
& 
a
, cÚ¡ 
B
& 
b
) {

106  
	`comp_
(
b
, 
a
);

108 
‹m¶©e
 <
ty³Çme
 
A
,y³Çm
B
>

109 
šlše
 
	`com·»
(cÚ¡ 
A
& 
a
, cÚ¡ 
B
& 
b
) {

110  
	`comp_
(
a
, 
b
) ? -1 : comp_(b,‡);

112 
´iv©e
:

113 
C
 
comp_
;

116 
‹m¶©e
 <
ty³Çme
 
C
>

117 
şass
 
rbcom·¿tÜ
<
C
, > {

118 
public
:

119 
šlše
 
	`rbcom·¿tÜ
(
C
 
comp
)

120 : 
	`comp_
(
comp
) {

122 
‹m¶©e
 <
ty³Çme
 
A
,y³Çm
B
>

123 
šlše
 
boŞ
 
	`Ëss
(cÚ¡ 
A
& 
a
, cÚ¡ 
B
& 
b
) {

124  
	`comp_
(
a
, 
b
) < 0;

126 
‹m¶©e
 <
ty³Çme
 
A
,y³Çm
B
>

127 
šlše
 
boŞ
 
	`g»©”
(cÚ¡ 
A
& 
a
, cÚ¡ 
B
& 
b
) {

128  
	`comp_
(
a
, 
b
) > 0;

130 
‹m¶©e
 <
ty³Çme
 
A
,y³Çm
B
>

131 
šlše
 
	`com·»
(cÚ¡ 
A
& 
a
, cÚ¡ 
B
& 
b
) {

132  
	`comp_
(
a
, 
b
);

134 
´iv©e
:

135 
C
 
comp_
;

138 
‹m¶©e
 <
ty³Çme
 
K
,y³Çm
T
,y³Çm
C
>

139 
šlše
‡utØ
	`make_com·»
(
C
 
comp
è-> 
rbcom·¿tÜ
<C, 
	`deşty³
(
	`comp
(*(
K
*)
nuÎ±r
, *(
T
*)nullptr))> {

140  
rbcom·¿tÜ
<
C
, 
	`deşty³
(
	`comp
(*(
K
*)
nuÎ±r
, *(
T
*êuÎ±r))>(
comp
);

143 
	}
}

145 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

146 şas 
	crb®gÜ™hms
 {

147 
	mpublic
:

148 
šlše
 
T
* 
Ãxt_node
(T* 
n
);

149 
šlše
 
T
* 
´ev_node
(T* 
n
);

150 
šlše
 
T
* 
´ev_node
(T* 
n
, T* 
Ï¡
);

151 
šlše
 
T
* 
¡•_node
(T* 
n
, 
boŞ
 
fÜw¬d
);

152 
šlše
 
T
* 
edge_node
(T* 
n
, 
boŞ
 
fÜw¬d
);

156 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gCom·»
 = 
rb´iv
::
deçuÉ_com·¿tÜ
<
T
>>

157 şas 
	crbŒ“
 {

158 
public
:

159 
T
* 
	tpoš‹r
;

160 cÚ¡ 
	tT
* 
	tcÚ¡_poš‹r
;

161 
	mT
& 
	t»ã»nû
;

162 cÚ¡ 
	tT
& 
	tcÚ¡_»ã»nû
;

163 
Com·»
 
	tv®ue_com·»
;

164 
T
 
	tnode_ty³
;

166 
TV”siÚ
 
	tV”siÚ
;

167 
	m¡d
::
	ttu¶e
<
	tT
*, 
	tV”siÚ
> 
	tnode_šfo_ty³
;

168 
	m¡d
::
	t·œ
<
	tnode_šfo_ty³
,‚ode_šfo_ty³> 
	tbound¬›s_ty³
;

170 
šlše
 
rbŒ“
(cÚ¡ 
v®ue_com·»
 &
com·»
 = value_compare());

171 ~
rbŒ“
();

173 
šlše
 
node_ty³
 *
roÙ
();

176 
šlše
 
boŞ
 
	$em±y
() const;

177 
šlše
 
size_t
 
	$size
() const;

180 
šlše
 
rbnod•Œ
<
T
> 
	`š£¹
(
»ã»nû
 
n
);

181 
šlše
 
T
* 
	`”a£
(
»ã»nû
 
x
);

183 
‹m¶©e
 <
ty³Çme
 
TT
,y³Çm
CC
>

184 
ä›nd
 
¡d
::
o¡»am
 &
İ”©Ü
<<(¡d::o¡»am &
s
, cÚ¡ 
rbŒ“
<
TT
, 
CC
> &
Œ“
);

185 
	$check
() const;

187 
´iv©e
:

188 
rb´iv
::
rb»p
<
T
, 
Com·»
> 
r_
;

190 
V”siÚ
 
Œ“v”siÚ_
;

192 
‹m¶©e
 <
ty³Çme
 
K
,y³Çm
Comp
>

193 
šlše
 
¡d
::
tu¶e
<
T
*, 
V”siÚ
, 
boŞ
, 
bound¬›s_ty³
> 
	$fšd_ªy
(cÚ¡ 
K
& 
key
, 
Comp
 
comp
) const;

195 
‹m¶©e
 <
ty³Çme
 
K
,y³Çm
Comp
>

196 
šlše
 
¡d
::
tu¶e
<
T
*, 
V”siÚ
, 
boŞ
, 
bound¬›s_ty³
, 
node_šfo_ty³
> 
	`fšd_š£¹
(
K
& 
key
, 
Comp
 
comp
);

198 
‹m¶©e
 <
ty³Çme
 
K
,y³Çm
Comp
>

199 
šlše
 
¡d
::
tu¶e
<
rbnod•Œ
<
T
>, 
boŞ
> 
	$fšd_Ü_·»Á
(cÚ¡ 
K
& 
key
, 
Comp
 
comp
) const;

201 
	`š£¹_comm™
(
T
* 
x
, 
rbnod•Œ
<T> 
p
, 
boŞ
 
side
);

202 
T
* 
	`d–‘e_node
(T* 
viùim
, T* 
sucûssÜ_hšt
);

203 
	`d–‘e_node_fixup
(
rbnod•Œ
<
T
> 
p
, 
boŞ
 
side
);

205 
‹m¶©e
<
ty³Çme
 
K
,y³Çm
V
, 
boŞ
 
Glob®Size
> 
ä›nd
 
şass
 
RBT»e
;

208 
‹m¶©e
 <
ty³Çme
 
T
>

209 
šlše
 
rbnod•Œ
<
T
>::
	$rbnod•Œ
(
T
* 
x
, 
boŞ
 
cŞÜ
)

210 : 
	`x_
(
»š‹½»t_ÿ¡
<
ušŒ_t
>(
x
è| 
cŞÜ
) {

211 
	}
}

213 
‹m¶©e
 <
ty³Çme
 
T
>

214 
šlše
 
rbnod•Œ
<
T
>::
	$rbnod•Œ
(
ušŒ_t
 
x
)

215 : 
	$x_
(
x
) {

216 
	}
}

218 
‹m¶©e
 <
ty³Çme
 
T
>

219 
šlše
 
rbnod•Œ
<
T
>::
İ”©Ü
 
	$un¥ecif›d_boŞ_ty³
() const {

220  
x_
 !ğ0 ? &
rbnod•Œ
<
T
>::
İ”©Ü
! : 0;

221 
	}
}

223 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

224 
šlše
 
boŞ
 
	grbnod•Œ
<
	gT
>::
İ”©Ü
!() const {

225  !
x_
;

228 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

229 
šlše
 
ušŒ_t
 
	grbnod•Œ
<
	gT
>::
	$iv®ue
() const {

230  
x_
;

231 
	}
}

233 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

234 
šlše
 
T
* 
	grbnod•Œ
<
	gT
>::
	$node
() const {

235  
»š‹½»t_ÿ¡
<
T
*>(
x_
 & ~
	`ušŒ_t
(1));

236 
	}
}

238 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

239 
šlše
 
	grbnod•Œ
<
	gT
>&„bnod•Œ<T>::
	$chd
(
boŞ
 
i¤ight
) const {

240  
	`node
()->
rblšks_
.
c_
[
i¤ight
];

241 
	}
}

243 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

244 
šlše
 
boŞ
 
	grbnod•Œ
<
	gT
>::
	$chd»n_§me_cŞÜ
() const {

245  ((
	`node
()->
rblšks_
.
c_
[0].
x_
 ^‚ode()->rblinks_.c_[1].x_) & 1) == 0;

246 
	}
}

248 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

249 
šlše
 
boŞ
 
	grbnod•Œ
<
	gT
>::
	$fšd_chd
(
T
* 
n
) const {

250  
x_
 && 
	`node
()->
rblšks_
.
c_
[1].node(è=ğ
n
;

251 
	}
}

253 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

254 
šlše
 
	grbnod•Œ
<
	gT
>&„bnod•Œ<T>::
	$lßd_cŞÜ
() {

255 
	`as£¹
(!
	`»d
());

256 
rbnod•Œ
<
T
> 
p
;

257 ià(
x_
 && (
p
 = 
	`bÏck_·»Á
()è&&….
	`chd
Õ.
	`fšd_chd
(
	`node
())).
	`»d
())

258 
x_
 |= 1;

259  *
this
;

260 
	}
}

262 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

263 
šlše
 
	grbnod•Œ
<
	gT
>„bnod•Œ<T>::
£t_chd
(
boŞ
 
i¤ight
, 
rbnod•Œ
<
T
> 
x
, T*& 
roÙ
) const {

264 ià(
	gx_
)

265 
chd
(
i¤ight
èğ
x
;

267 
	groÙ
 = 
x
.
node
();

268  
	gx
;

271 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

272 
šlše
 
	gT
*& 
	grbnod•Œ
<T>::
	$·»Á
() const {

273  
	`node
()->
rblšks_
.
p_
;

274 
	}
}

276 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

277 
šlše
 
	grbnod•Œ
<
	gT
>„bnod•Œ<T>::
	$bÏck_·»Á
() const {

278  
rbnod•Œ
<
T
>(
	`node
()->
rblšks_
.
p_
, 
çl£
);

279 
	}
}

281 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

282 
šlše
 
boŞ
 
	grbnod•Œ
<
	gT
>::
	$»d
() const {

283  
x_
 & 1;

284 
	}
}

286 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

287 
šlše
 
	grbnod•Œ
<
	gT
>„bnod•Œ<T>::
	$chªge_cŞÜ
(
boŞ
 
cŞÜ
) const {

288  
rbnod•Œ
<
T
>(
cŞÜ
 ? 
x_
 | 1 : x_ & ~
	`ušŒ_t
(1));

289 
	}
}

291 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

292 
šlše
 
	grbnod•Œ
<
	gT
>„bnod•Œ<T>::
	$»v”£_cŞÜ
() const {

293  
rbnod•Œ
<
T
>(
x_
 ^ 1);

294 
	}
}

296 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

297 
šlše
 
	grbnod•Œ
<
	gT
>„bnod•Œ<T>::
	$rÙ©e
(
boŞ
 
side
) const {

298 
	`rbaccouÁ
(
rÙ©iÚ
);

299 
rbnod•Œ
<
T
> 
x
 = 
	`chd
(!
side
);

306 ià((
	`chd
(!
side
èğ
x
.child(side)))

307 
x
.
	`chd
(
side
).
	`·»Á
(èğ
	`node
();

308 
boŞ
 
Şd_cŞÜ
 = 
	`»d
();

309 
x
.
	`chd
(
side
èğ
	`chªge_cŞÜ
(
Œue
);

310 
x
.
	`·»Á
() =…arent();

311 
	`·»Á
(èğ
x
.
	`node
();

312  
x
.
	`chªge_cŞÜ
(
Şd_cŞÜ
);

313 
	}
}

315 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

316 
šlše
 
	grbnod•Œ
<
	gT
>„bnod•Œ<T>::
	$æ
() const {

317 
	`rbaccouÁ
(
æ
);

318 
	`chd
(
çl£
èğchd(çl£).
	`»v”£_cŞÜ
();

319 
	`chd
(
Œue
èğchdÑrue).
	`»v”£_cŞÜ
();

320  
	`»v”£_cŞÜ
();

321 
	}
}

323 
Çme¥aû
 
	grb´iv
 {

324 
	g‹m¶©e
 <
ty³Çme
 
	gCom·»
>

325 
šlše
 
	grbcom·»
<
	gCom·»
>::
rbcom·»
(cÚ¡ 
Com·»
& 
com·»
)

326 : 
Com·»
(
com·»
) {

329 
‹m¶©e
 <
ty³Çme
 
Com·»
>em¶©<ty³Çm
T
>

330 
šlše
 
rbcom·»
<
Com·»
>::
node_com·»
(cÚ¡ 
T
& 
a
, cÚ¡ T& 
b
) const {

331 
	gcmp
 = 
this
->
İ”©Ü
()(
a
, 
	gb
);

332  
	gcmp
 ? cm°: 
rb´iv
::
deçuÉ_com·»
(&
a
, &
b
);

335 
	g‹m¶©e
 <
ty³Çme
 
	gCom·»
>em¶©<ty³Çm
	gA
,y³Çm
	gB
>

336 
šlše
 
	grbcom·»
<
	gCom·»
>::
com·»
(cÚ¡ 
A
& 
a
, cÚ¡ 
B
& 
b
) const {

337  
	gthis
->
İ”©Ü
()(
	ga
, 
	gb
);

340 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gC
>

341 
šlše
 
	grb»p
<
	gT
, 
	gC
>::
rb»p
(cÚ¡ 
C
 &
com·»
è: 
rbcom·»_ty³
(compare) {

342 
this
->
roÙ_
 =his->
lim™_
[0] =his->limit_[1] = 0;

345 
	g‹m¶©e
 <
ty³Çme
 
	gCom·»
>

346 
šlše
 
	gCom·»
& 
	grbcom·»
<Com·»>::
g‘_com·»
() const {

347  *
cÚ¡_ÿ¡
<
Com·»
*>(
¡©ic_ÿ¡
<cÚ¡ Com·»*>(
this
));

353 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gC
>

354 
šlše
 
	grbŒ“
<
	gT
, 
	gC
>::
	$rbŒ“
(cÚ¡ 
v®ue_com·»
 &
com·»
)

355 : 
	`r_
(
com·»
), 
	`Œ“v”siÚ_
(
Sto
::
	$š™Ÿlized_tid
()) {

356 
	}
}

358 
‹m¶©e
 <
ty³Çme
 
T
,y³Çm
	gC
>

359 
	grbŒ“
<
	gT
, 
	gC
>::~
	$rbŒ“
() {

360 
	}
}

362 
‹m¶©e
 <
ty³Çme
 
T
,y³Çm
	gC
>

363 
	grbŒ“
<
	gT
, 
	gC
>::
š£¹_comm™
(
T
* 
x
, 
rbnod•Œ
<T> 
p
, 
boŞ
 
side
) {

365 
	gx
->
	grblšks_
.
	gp_
 = 
p
.
node
();

366 
	gx
->
	grblšks_
.
	gc_
[0] = 
x
->
rblšks_
.
c_
[1] = 
rbnod•Œ
<
T
>(0, 
	gçl£
);

369 ià(
	gp
) {

370 
	gp
.
chd
(
side
èğ
rbnod•Œ
<
T
>(
x
, 
	gŒue
);

371 ià(
	gp
.
node
(è=ğ
r_
.
lim™_
[
side
])

372 
r_
.
lim™_
[
side
] = 
x
;

374 
	gr_
.
	groÙ_
 = 
r_
.
lim™_
[0] =„_.lim™_[1] = 
x
;

378 
	gp
.
»d
()) {

379 
	grbnod•Œ
<
	gT
> 
	ggp
 = 
p
.
bÏck_·»Á
(), 
	gz
;

380 ià(
	ggp
.
chd
(0).
»d
() && gp.child(1).red()) {

381 
	gz
 = 
gp
.
æ
();

382 
	gp
 = 
gp
.
bÏck_·»Á
().
lßd_cŞÜ
();

384 
boŞ
 
	ggpside
 = 
gp
.
fšd_chd
(
p
.
node
());

385 ià(
	ggpside
 !ğ
side
) {

386 
gp
.
chd
(
gpside
èğ
p
.
rÙ©e
(gpside);

388 
	gz
 = 
gp
.
rÙ©e
(!
gpside
);

389 
	gp
 = 
z
.
bÏck_·»Á
();

391 
	gside
 = 
p
.
fšd_chd
(
gp
.
node
());

392 
	gp
.
£t_chd
(
side
, 
z
, 
r_
.
roÙ_
);

396 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gC
>

397 
	grbnod•Œ
<
	gT
> 
	grbŒ“
<T, 
	gC
>::
	$š£¹
(
»ã»nû
 
x
) {

398 
	`rbaccouÁ
(
š£¹
);

401 
rbnod•Œ
<
T
> 
	`p
(
r_
.
roÙ_
, 
çl£
);

402 
boŞ
 
side
 = 
çl£
;

403 
p
 && (
side
 = 
r_
.
	`node_com·»
(
x
, *p.
	`node
()) > 0,

404 
p
.
	`chd
(
side
)))

405 
p
 =….
	`chd
(
side
);

407 
	`š£¹_comm™
(&
x
, 
p
, 
side
);

408  
p
;

409 
	}
}

411 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gC
>

412 
T
* 
	grbŒ“
<
	gT
, 
	gC
>::
	$d–‘e_node
(
T
* 
viùim_node
, T* 
succ
) {

413 
usšg
 
¡d
::
sw­
;

415 
rbnod•Œ
<
T
> 
	`viùim
(
viùim_node
, 
çl£
);

416 
rbnod•Œ
<
T
> 
p
 = 
viùim
.
	`bÏck_·»Á
();

417 
boŞ
 
side
 = 
p
.
	`fšd_chd
(
viùim_node
);

420 ià(
viùim
.
	`chd
(0) && victim.child(1)) {

421 ià(!
succ
)

422 
succ
 = 
viùim
.
	`chd
(
Œue
).
	`node
();

423 
succ
->
rblšks_
.
c_
[0];

424 
succ
 = succ->
rblšks_
.
c_
[0].
	`node
())

426 
rbnod•Œ
<
T
> 
succ_p
 =„bnod•Œ<T>(
succ
->
rblšks_
.
p_
, 
çl£
);

427 
boŞ
 
sside
 = 
succ
 =ğ
succ_p
.
	`chd
(
Œue
).
	`node
();

428 ià(
p
)

429 
p
.
	`chd
(
side
èğ
rbnod•Œ
<
T
>(
succ
,….chd(side).
	`»d
());

431 
r_
.
roÙ_
 = 
succ
;

432 
	`sw­
(
succ
->
rblšks_
, 
viùim
.
	`node
()->rblinks_);

433 ià(
sside
)

434 
succ
->
rblšks_
.
c_
[
sside
] = 
viùim
.
	`chªge_cŞÜ
(succ->rblšks_.c_[sside].
	`»d
());

435 
succ
->
rblšks_
.
c_
[0].
	`·»Á
() = succ->rblinks_.c_[1].parent() = succ;

436 
p
 = 
viùim
.
	`bÏck_·»Á
();

437 
side
 = 
sside
;

439 
succ
 = 
nuÎ±r
;

442 
boŞ
 
aùive
 = !
viùim
.
	`chd
(
çl£
);

443 
rbnod•Œ
<
T
> 
x
 = 
viùim
.
	`chd
(
aùive
);

444 
boŞ
 
cŞÜ
 = 
p
 &&….
	`chd
(
side
).
	`»d
();

445 
p
.
	`£t_chd
(
side
, 
x
, 
r_
.
roÙ_
);

446 ià(
x
)

447 
x
.
	`·»Á
(èğ
p
.
	`node
();

450 
i
 = 0; i != 2; ++i)

451 ià(
viùim
.
	`node
(è=ğ
this
->
r_
.
lim™_
[
i
]) {

452 
rbnod•Œ
<
T
> 
b
 = (
x
 ? x : 
p
);

453 
b
 && b.
	`chd
(
i
))

454 
b
 = b.
	`chd
(
i
);

455 
this
->
r_
.
lim™_
[
i
] = 
b
.
	`node
();

458 ià(!
cŞÜ
)

459 
	`d–‘e_node_fixup
(
p
, 
side
);

462  
p
.
	`node
();

463 
	}
}

465 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gC
>

466 
	grbŒ“
<
	gT
, 
	gC
>::
d–‘e_node_fixup
(
rbnod•Œ
<
T
> 
p
, 
boŞ
 
side
) {

467 
	gp
 && !p.
chd
(0).
»d
() && !p.child(1).red()

468 && !
	gp
.
chd
(!
side
).chd(0).
»d
()

469 && !
	gp
.
chd
(!
side
).chd(1).
»d
()) {

470 
	gp
.
chd
(!
side
èğ
p
.chd(!side).
chªge_cŞÜ
(
Œue
);

471 
T
* 
	gnode
 = 
p
.
node
();

472 
	gp
 = 
p
.
bÏck_·»Á
();

473 
	gside
 = 
p
.
fšd_chd
(
node
);

476 ià(
	gp
 && !p.
chd
(
side
).
»d
()) {

477 
	grbnod•Œ
<
	gT
> 
	ggp
 = 
p
.
bÏck_·»Á
();

478 
boŞ
 
	ggpside
 = 
gp
.
fšd_chd
(
p
.
node
());

480 ià(
	gp
.
chd
(!
side
).
»d
()) {

482 
	ggp
.
£t_chd
(
gpside
, 
p
.
rÙ©e
(
side
), 
r_
.
roÙ_
);

483 
	ggp
 = 
p
.
bÏck_·»Á
();

484 
	ggpside
 = 
side
;

487 
	grbnod•Œ
<
	gT
> 
	gw
 = 
p
.
chd
(!
side
);

488 ià(!
	gw
.
chd
(0).
»d
() && !w.child(1).red()) {

489 
	gp
.
chd
(!
side
èğ
w
.
chªge_cŞÜ
(
Œue
);

490 
	gp
 = 
p
.
chªge_cŞÜ
(
çl£
);

492 ià(!
	gw
.
chd
(!
side
).
»d
()) {

493 
	gp
.
chd
(!
side
èğ
w
.
rÙ©e
(!side);

495 
boŞ
 
	ggpside
 = 
gp
.
fšd_chd
(
p
.
node
());

496 ià(
	ggp
)

497 
	gp
 = 
gp
.
chd
(
gpside
);

498 
	gp
 = 
p
.
rÙ©e
(
side
);

499 
	gp
.
chd
(0èğ
p
.chd(0).
chªge_cŞÜ
(
çl£
);

500 
	gp
.
chd
(1èğ
p
.chd(1).
chªge_cŞÜ
(
çl£
);

502 
	ggp
.
£t_chd
(
gpside
, 
p
, 
r_
.
roÙ_
);

503 } ià(
	gp
)

504 
	gp
.
chd
(
side
èğ
p
.chd(side).
chªge_cŞÜ
(
çl£
);

507 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gC
>

508 
šlše
 
T
* 
	grbŒ“
<
	gT
, 
	gC
>::
	$roÙ
() {

509  
r_
.
roÙ_
;

510 
	}
}

515 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gC
>em¶©<ty³Çm
	gK
,y³Çm
	gComp
>

516 
šlše
 
	g¡d
::
tu¶e
<
T
*, 
ty³Çme
 
	grbŒ“
<
	gT
, 
	gC
>::
V”siÚ
, 
	gboŞ
,

517 
ty³Çme
 
	grbŒ“
<
	gT
, 
	gC
>::
bound¬›s_ty³
>

518 
rbŒ“
<
T
, 
	gC
>::
	$fšd_ªy
(cÚ¡ 
K
& 
key
, 
Comp
 
comp
) const {

520 
rbnod•Œ
<
T
> 
	`n
(
r_
.
roÙ_
, 
çl£
);

521 
rbnod•Œ
<
T
> 
	`p
(
nuÎ±r
, 
çl£
);

523 
T
* 
lhs
 = 
r_
.
lim™_
[0];

524 
T
* 
rhs
 = 
r_
.
lim™_
[1];

525 
bound¬›s_ty³
 
bound¬y
 = 
¡d
::
	`make_·œ
(¡d::
	`make_tu¶e
(
lhs
,†h ?†hs->
	`nodev”siÚ
() : 0),

526 
¡d
::
	`make_tu¶e
(
rhs
,„h ?„hs->
	`nodev”siÚ
() : 0));

528 
n
.
	`node
()) {

529 
cmp
 = 
comp
.
	`com·»
(
key
, *
n
.
	`node
());

530 ià(
cmp
 == 0)

535 ià(
cmp
 > 0) {

536 
T
* 
nb
 = 
n
.
	`node
();

537 
bound¬y
.
fœ¡
 = 
¡d
::
	`make_tu¶e
(
nb
,‚b->
	`nodev”siÚ
());

539 
T
* 
nb
 = 
n
.
	`node
();

540 
bound¬y
.
£cÚd
 = 
¡d
::
	`make_tu¶e
(
nb
,‚b->
	`nodev”siÚ
());

542 
p
 = 
n
;

543 
n
 =‚.
	`node
()->
rblšks_
.
c_
[
cmp
 > 0];

546 
boŞ
 
found
 = (
n
.
	`node
(è!ğ
nuÎ±r
);

547 
T
* 
»Šode
 = 
found
 ? 
n
.
	`node
(è: 
p
.node();

548 
V”siÚ
 
»tv”
 = 
»Šode
 ?„‘node->
	`v”siÚ
(è: 
Œ“v”siÚ_
;

550  
¡d
::
	`make_tu¶e
(
»Šode
, 
»tv”
, 
found
, 
bound¬y
);

551 
	}
}

553 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gC
>em¶©<ty³Çm
	gK
,y³Çm
	gComp
>

554 
šlše
 
	g¡d
::
tu¶e
<
rbnod•Œ
<
T
>, 
	gboŞ
> 
	grbŒ“
<
	gT
, 
	gC
>::
	$fšd_Ü_·»Á
(cÚ¡ 
K
& 
key
, 
Comp
 
comp
) const {

555 
rbnod•Œ
<
T
> 
	`n
(
r_
.
roÙ_
, 
çl£
);

556 
rbnod•Œ
<
T
> 
	`p
(
nuÎ±r
, 
çl£
);

558 
n
.
	`node
()) {

559 
cmp
 = 
comp
.
	`com·»
(
key
, *
n
.
	`node
());

560 ià(
cmp
 == 0)

563 
p
 = 
n
;

564 
n
 =‚.
	`node
()->
rblšks_
.
c_
[
cmp
 > 0];

567 
boŞ
 
found
 = (
n
.
	`node
(è!ğ
nuÎ±r
);

569  
¡d
::
	`make_tu¶e
(
found
 ? 
n
 : 
p
, found);

570 
	}
}

572 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gT
>

573 
şass
 
	grb·œ
;

575 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gC
>em¶©<ty³Çm
	gK
,y³Çm
	gComp
>

576 
šlše
 
	g¡d
::
tu¶e
<
T
*, 
ty³Çme
 
	grbŒ“
<
	gT
, 
	gC
>::
V”siÚ
, 
	gboŞ
,

577 
ty³Çme
 
	grbŒ“
<
	gT
, 
	gC
>::
bound¬›s_ty³
,y³ÇmrbŒ“<T, C>::
node_šfo_ty³
>

578 
rbŒ“
<
T
, 
	gC
>::
	$fšd_š£¹
(
K
& 
key
, 
Comp
 
comp
) {

580 
rbnod•Œ
<
T
> 
	`n
(
r_
.
roÙ_
, 
çl£
);

581 
rbnod•Œ
<
T
> 
	`p
(
nuÎ±r
, 
çl£
);

583 
T
* 
lhs
 = 
r_
.
lim™_
[0];

584 
T
* 
rhs
 = 
r_
.
lim™_
[1];

585 
bound¬›s_ty³
 
bound¬y
 = 
¡d
::
	`make_·œ
(¡d::
	`make_tu¶e
(
lhs
,†h ?†hs->
	`nodev”siÚ
() : 0),

586 
¡d
::
	`make_tu¶e
(
rhs
,„h ?„hs->
	`nodev”siÚ
() : 0));

588 
cmp
 = 0;

589 
n
.
	`node
()) {

590 
cmp
 = 
comp
.
	`com·»
(
key
, *
n
.
	`node
());

591 ià(
cmp
 == 0)

593 ià(
cmp
 > 0) {

594 
T
* 
nb
 = 
n
.
	`node
();

595 
bound¬y
.
fœ¡
 = 
¡d
::
	`make_tu¶e
(
nb
,‚b->
	`nodev”siÚ
());

597 
T
* 
nb
 = 
n
.
	`node
();

598 
bound¬y
.
£cÚd
 = 
¡d
::
	`make_tu¶e
(
nb
,‚b->
	`nodev”siÚ
());

600 
p
 = 
n
;

601 
n
 =‚.
	`node
()->
rblšks_
.
c_
[
cmp
 > 0];

604 
boŞ
 
found
 = (
n
.
	`node
(è!ğ
nuÎ±r
);

605 
T
* 
»Šode
 = 
n
.
	`node
();

606 
V”siÚ
 
»tv”
 = 
»Šode
 ? (
found
 ?„‘node->
	`v”siÚ
() : 0) : 0;

607 
node_šfo_ty³
 
·»Á
 = 
¡d
::
	`make_tu¶e
(
p
.
	`node
(),….node(è?….node()->
	`nodev”siÚ
() : 0);

610 ià(!
found
) {

611 
»Šode
 = (
T
*)
	`m®loc
((T));

612 
	`Ãw
 (
»Šode
è
	`T
((
rb·œ
<
ty³Çme
 
K
::
key_ty³
,y³ÇmK::
v®ue_ty³
>)
key
);

613 
»tv”
 = 
»Šode
->
	`nodev”siÚ
();

614 
	`š£¹_comm™
(
»Šode
, 
p
, (
cmp
 > 0));

619  
¡d
::
	`make_tu¶e
(
»Šode
, 
»tv”
, 
found
, 
bound¬y
, 
·»Á
);

620 
	}
}

622 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gC
>

623 
šlše
 
T
* 
	grbŒ“
<
	gT
, 
	gC
>::
	$”a£
(
T
& 
node
) {

624 
	`rbaccouÁ
(
”a£
);

625 
T
* 
»t
 = 
	`d–‘e_node
(&
node
, 
nuÎ±r
);

626  
»t
;

627 
	}
}

630 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

631 
	grbnod•Œ
<
	gT
>::
	$ouut
(
¡d
::
o¡»am
 &
s
, 
šd’t
, 
T
* 
highlight
) const {

632 ià(!*
this
)

633 
s
 << "<empty>\n";

635 ià(
	`chd
(0))

636 
	`chd
(0).
	`ouut
(
s
, 
šd’t
 + 2, 
highlight
);

637 
s
 << 
¡d
::
	`£tw
(
šd’t
è<< "" << (cÚ¡ 
T
&è*
	`node
(è<< " @" << (*ènode(è<< (
	`»d
() ? "„ed" : "");

638 ià(
highlight
 && highlighˆ=ğ
	`node
())

639 
s
 << " ******…@" << (*è
	`node
()->
rblšks_
.
p_
 << "\n";

641 
s
 << "\n";

642 ià(
	`chd
(1))

643 
	`chd
(1).
	`ouut
(
s
, 
šd’t
 + 2, 
highlight
);

645 
	}
}

647 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gC
>

648 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(
¡d
::o¡»am &
s
, cÚ¡ 
	grbŒ“
<
	gT
, 
	gC
> &
	gŒ“
) {

649 
	grbnod•Œ
<
	gT
>(
	gŒ“
.
	gr_
.
	groÙ_
, 
	gçl£
).
ouut
(
s
, 0, 0);

650  
	gs
;

653 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

654 
size_t
 
	grbnod•Œ
<
	gT
>::
	$size
() const {

655  1 + (
	`chd
(
çl£
è? chd(çl£).
	`size
() : 0)

656 + (
	`chd
(
Œue
è? chdÑrue).
	`size
() : 0);

657 
	}
}

659 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gC
>

660 
šlše
 
boŞ
 
	grbŒ“
<
	gT
, 
	gC
>::
	$em±y
() const {

661  !
r_
.
roÙ_
;

662 
	}
}

664 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gC
>

665 
šlše
 
size_t
 
	grbŒ“
<
	gT
, 
	gC
>::
	$size
() const {

666  
r_
.
roÙ_
 ? 
rbnod•Œ
<
T
>Ô_.roÙ_, 
çl£
).
	`size
() : 0;

667 
	}
}

669 
	#rbcheck_as£¹
(
x
èdØ{ ià(!(x)è{ 
rbnod•Œ
<
T
>(
roÙ
, 
çl£
).
	`ouut
(
¡d
::
û¼
, 0, 
	`node
()); 
	`as£¹
(x); } } 0)

	)

671 
	g‹m¶©e
 <
ty³Çme
 
	gT
>em¶©<ty³Çm
	gC
>

672 
	grbnod•Œ
<
	gT
>::
	$check
(
T
* 
·»Á
, 
this_bÏck_height
, & 
bÏck_height
,

673 
T
* 
roÙ
, T* 
begš
, T* 
’d
, 
C
& 
com·»
) const {

674 
	`rbcheck_as£¹
(
	`node
()->
rblšks_
.
p_
 =ğ
·»Á
);

675 ià(
·»Á
) {

676 
cmp
 = 
	`com·»
(*
	`node
(), *
·»Á
);

677 ià(
·»Á
->
rblšks_
.
c_
[0].
	`node
() ==‚ode())

678 
	`rbcheck_as£¹
(
cmp
 < 0 || (cm°=ğ0 && 
	`node
(è< 
·»Á
));

680 
	`rbcheck_as£¹
(
cmp
 > 0 || (cm°=ğ0 && 
	`node
(è> 
·»Á
));

682 ià(
	`»d
())

683 
	`rbcheck_as£¹
(!
	`chd
(
çl£
).
	`»d
(è&& !chd(
Œue
).red());

686 ++
this_bÏck_height
;

688 ià(
begš
 && !
	`chd
(
çl£
))

689 
	`as£¹
(
begš
 =ğ
	`node
());

690 ià(
’d
 && !
	`chd
(
Œue
))

691 
	`as£¹
(
’d
 =ğ
	`node
());

692 
i
 = 0; i < 2; ++i)

693 ià(
	`chd
(
i
))

694 
	`chd
(
i
).
	`check
(
	`node
(), 
this_bÏck_height
, 
bÏck_height
,

695 
roÙ
, 
i
 ? 0 : 
begš
, i ? 
’d
 : 0, 
com·»
);

696 ià(
bÏck_height
 == -1)

697 
bÏck_height
 = 
this_bÏck_height
;

699 
	`as£¹
(
bÏck_height
 =ğ
this_bÏck_height
);

700 
	}
}

702 #undeà
rbcheck_as£¹


704 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gC
>

705 
	grbŒ“
<
	gT
, 
	gC
>::
	$check
() const {

706 
bÏck_height
 = -1;

707 ià(
r_
.
roÙ_
)

708 
rbnod•Œ
<
T
>(
r_
.
roÙ_
, 
çl£
).
	`check
(0, 0, 
bÏck_height
,„_.root_,

709 
r_
.
lim™_
[0],„_.lim™_[1],„_.
	`g‘_com·»
());

711 
	`as£¹
(!
r_
.
lim™_
[0] && !r_.limit_[1]);

712  
bÏck_height
;

713 
	}
}

716 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

717 
šlše
 
T
* 
	grb®gÜ™hms
<
	gT
>::
	$edge_node
(
T
* 
n
, 
boŞ
 
fÜw¬d
) {

718 
n
->
rblšks_
.
c_
[
fÜw¬d
])

719 
n
 =‚->
rblšks_
.
c_
[
fÜw¬d
].
	`node
();

720  
n
;

721 
	}
}

723 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

724 
šlše
 
T
* 
	grb®gÜ™hms
<
	gT
>::
	$¡•_node
(
T
* 
n
, 
boŞ
 
fÜw¬d
) {

725 ià(
n
->
rblšks_
.
c_
[
fÜw¬d
])

726 
n
 = 
	`edge_node
Ò->
rblšks_
.
c_
[
fÜw¬d
].
	`node
(), !forward);

728 
T
* 
´ev
;

730 
´ev
 = 
n
;

731 
n
 =‚->
rblšks_
.
p_
;

732 } 
n
 &&‚->
rblšks_
.
c_
[!
fÜw¬d
].
	`node
(è!ğ
´ev
);

734  
n
;

735 
	}
}

737 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

738 
šlše
 
T
* 
	grb®gÜ™hms
<
	gT
>::
	$Ãxt_node
(
T
* 
n
) {

739  
	`¡•_node
(
n
, 
Œue
);

740 
	}
}

742 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

743 
šlše
 
T
* 
	grb®gÜ™hms
<
	gT
>::
	$´ev_node
(
T
* 
n
) {

744  
	`¡•_node
(
n
, 
çl£
);

745 
	}
}

747 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

748 
šlše
 
T
* 
	grb®gÜ™hms
<
	gT
>::
	$´ev_node
(
T
* 
n
, T* 
Ï¡
) {

749  
n
 ? 
	`¡•_node
Ò, 
çl£
è: 
Ï¡
;

750 
	}
}

	@datatype/SingleElem.hh

1 #´agm¨
Úû


2 
	~"IÁ”çû.hh
"

3 
	~"v”siÚed_v®ue.hh
"

5 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gG’”icSTM
 = 
çl£
,y³Çm
	gSŒuùu»
 = 
v”siÚed_v®ue_¡ruù
<
T
>>

8 şas 
	cSšgËEËm
 : 
public
 
TObjeù
 {

9 
public
:

10 
T
 
	$un§ã_»ad
() const {

11  
s_
.
	`»ad_v®ue
();

13 
	$un§ã_wr™e
(
T
 
v
) {

14 
s_
.
	`£t_v®ue
(
v
);

15 
	}
}

17 
	$wr™e
(
T
 
v
) {

18 
T¿n§ùiÚTid
::
	`lock
(
s_
.
	`v”siÚ
());

19 
s_
.
	`£t_v®ue
(
v
);

20 
T¿n§ùiÚTid
::
	`£t_v”siÚ_uÆock
(
s_
.
	`v”siÚ
(), T¿n§ùiÚTid::
	`Ãxt_nÚİaque_v”siÚ
(s_.version()));

21 
	}
}

23 
	g´iv©e
:

24 
T¿n§ùiÚTid
::
	tty³
 
	tv”siÚ_ty³
;

26 
šlše
 
	$©omicR—d
(
v”siÚ_ty³
& 
v
, 
T
& 
v®
) const {

27 
v”siÚ_ty³
 
v2
;

29 
v2
 = 
s_
.
	`v”siÚ
();

30 ià(
T¿n§ùiÚTid
::
	`is_locked
(
v2
))

31 
Sto
::
	`abÜt
();

32 
	`ãnû
();

33 
v®
 = 
s_
.
	`»ad_v®ue
();

34 
	`ãnû
();

35 
v
 = 
s_
.
	`v”siÚ
();

36 } 
v
 !ğ
v2
);

37 
	}
}

39 
	gpublic
:

40 
T
 
	$ŒªsR—d
() const {

41 autØ
™em
 = 
Sto
::
	`™em
(
this
,his);

42 ià(
™em
.
	`has_wr™e
())

43  
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

45 
v”siÚ_ty³
 
v
;

46 
T
 
v®
;

47 
	`©omicR—d
(
v
, 
v®
);

48 ià(
G’”icSTM
)

49 
Sto
::
	`check_İac™y
(
v
);

50 
™em
.
	`add_»ad
(
v
);

51  
v®
;

53 
	}
}

56 
İ”©Ü
 
	$T
() {

57 ià(
Sto
::
	`š_´og»ss
())

58  
	`ŒªsR—d
();

60  
	`un§ã_»ad
();

61 
	}
}

63 
	$ŒªsWr™e
(cÚ¡ 
T
& 
v
) {

64 
Sto
::
	`™em
(
this
,his).
	`add_wr™e
(
v
);

65 
	}
}

68 
	gSšgËEËm
& 
	gİ”©Ü
ğ(cÚ¡ 
T
& 
v
) {

69 ià(
Sto
::
š_´og»ss
())

70 
ŒªsWr™e
(
v
);

72 
un§ã_wr™e
(
v
);

73  *
	gthis
;

76 
	$lock
() {

77 
T¿n§ùiÚTid
::
	`lock
(
s_
.
	`v”siÚ
());

78 
	}
}

80 
	$uÆock
() {

81 
T¿n§ùiÚTid
::
	`uÆock
(
s_
.
	`v”siÚ
());

82 
	}
}

84 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

85  
txn
.
	`Œy_lock
(
™em
, 
s_
.
	`v”siÚ
());

86 
	}
}

88 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
&è
ov”ride
 {

89  
T¿n§ùiÚTid
::
	`check_v”siÚ
(
s_
.
	`v”siÚ
(), 
™em
.
‹m¶©e
 
»ad_v®ue
<
v”siÚ_ty³
>());

90 
	}
}

92 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
t
è
ov”ride
 {

93 
s_
.
	`£t_v®ue
(
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>());

94 ià(
G’”icSTM
) {

95 
T¿n§ùiÚTid
::
	`£t_v”siÚ
(
s_
.
	`v”siÚ
(), 
t
.
	`comm™_tid
());

97 
T¿n§ùiÚTid
::
	`šc_nÚİaque_v”siÚ
(
s_
.
	`v”siÚ
());

99 
	}
}

101 
	$uÆock
(
T¿nsI‹m
&è
ov”ride
 {

102 
	`uÆock
();

103 
	}
}

105 
	g´Ùeùed
:

107 
SŒuùu»
 
s_
;

	@datatype/SwissTArray.hh

1 #´agm¨
Úû


2 
	~"TW¿µed.hh
"

3 
	~"TA¼ayProxy.hh
"

4 
	~"T¿n§ùiÚ.hh
"

5 
	~<şim™s
>

6 
	~<±h»ad.h
>

7 
	~<b™£t
>

8 
	~<f¡»am
>

9 
	~<s¡»am
>

10 
	~<c¡dlib
>

12 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
 = 
TSwissNÚİaqueW¿µed
>

13 şas 
	cSwissTA¼ay
 : 
public
 
TObjeù
 {

14 
public
:

15 
şass
 
™”©Ü
;

16 
şass
 
	mcÚ¡_™”©Ü
;

17 
T
 
	tv®ue_ty³
;

18 
ty³Çme
 
	tW
<
	tT
>::
	t»ad_ty³
 
	tg‘_ty³
;

19 
ty³Çme
 
	tW
<
	tT
>::
	tv”siÚ_ty³
 version_type;

20 
	tsize_ty³
;

21 
	tdifã»nû_ty³
;

22 
	mTCÚ¡A¼ayProxy
<
	tSwissTA¼ay
<
	tT
, 
	tN
, 
	tW
> > 
	tcÚ¡_´oxy_ty³
;

23 
	mTA¼ayProxy
<
	tSwissTA¼ay
<
	tT
, 
	tN
, 
	tW
> > 
	t´oxy_ty³
;

25 
size_ty³
 
	$size
() const {

26  
N
;

29 
cÚ¡_´oxy_ty³
 
İ”©Ü
[](
size_ty³
 
i
) const {

30 
	`as£¹
(
i
 < 
N
);

31  
	`cÚ¡_´oxy_ty³
(
this
, 
i
);

32 
	}
}

33 
´oxy_ty³
 
	gİ”©Ü
[](
size_ty³
 
	gi
) {

34 
as£¹
(
i
 < 
N
);

35  
´oxy_ty³
(
this
, 
i
);

38 
šlše
 
™”©Ü
 
begš
();

39 
šlše
 
™”©Ü
 
’d
();

40 
šlše
 
cÚ¡_™”©Ü
 
	$cbegš
() const;

41 
šlše
 
cÚ¡_™”©Ü
 
	$ûnd
() const;

42 
šlše
 
cÚ¡_™”©Ü
 
	$begš
() const;

43 
šlše
 
cÚ¡_™”©Ü
 
	$’d
() const;

46 
boŞ
 
	$ŒªsG‘
(
size_ty³
 
i
, 
T
& 
»t
) const {

47 
	`as£¹
(
i
 < 
N
);

48 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
i
);

49 ià(
™em
.
	`has_wr™e
()) {

50 
»t
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

51  
Œue
;

53 
boŞ
 
ok
;

54 
¡d
::
	`t›
(
ok
, 
»t
èğ
d©a_
[
i
].
v
.
	`»ad
(
™em
, d©a_[i].
v”siÚ
);

55  
ok
;

57 
	}
}

58 
boŞ
 
	$ŒªsPut
(
size_ty³
 
i
, 
T
 
x
) {

59 
	`as£¹
(
i
 < 
N
);

60  
Sto
::
	`™em
(
this
, 
i
).
	`acquœe_wr™e
(
d©a_
[i].
v”siÚ
, 
x
);

61 
	}
}

63 
g‘_ty³
 
	$ŒªsG‘_throws
(
size_ty³
 
i
) const {

64 
g‘_ty³
 
»t
;

65 
boŞ
 
ok
 = 
	`ŒªsG‘
(
i
, 
»t
);

66 ià(!
ok
)

67 
Sto
::
	`abÜt
();

68  
»t
;

69 
	}
}

70 
	$ŒªsPut_throws
(
size_ty³
 
i
, 
T
 
x
) {

71 
boŞ
 
ok
 = 
	`ŒªsPut
(
i
, 
x
);

72 ià(!
ok
)

73 
Sto
::
	`abÜt
();

74 
	}
}

75 
g‘_ty³
 
	$nÚŒªs_g‘
(
size_ty³
 
i
) const {

76 
	`as£¹
(
i
 < 
N
);

77  
d©a_
[
i
].
v
.
	`acûss
();

78 
	}
}

79 
	$nÚŒªs_put
(
size_ty³
 
i
, cÚ¡ 
T
& 
x
) {

80 
	`as£¹
(
i
 < 
N
);

81 
d©a_
[
i
].
v
.
	`acûss
(èğ
x
;

82 
	}
}

83 
	$nÚŒªs_put
(
size_ty³
 
i
, 
T
&& 
x
) {

84 
	`as£¹
(
i
 < 
N
);

85 
d©a_
[
i
].
v
.
	`acûss
(èğ
¡d
::
	`move
(
x
);

86 
	}
}

89 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

91 autØ
ok
 = 
txn
.
	`Œy_lock
(
™em
, 
d©a_
[™em.
key
<
size_ty³
>()].
v”siÚ
);

92 
	`as£¹
(
ok
);

93  
Œue
;

94 
	}
}

95 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

96  
d©a_
[
™em
.
key
<
size_ty³
>()].
v”siÚ
.
	`ı_check_v”siÚ
(
txn
, item);

98 
	}
}

99 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

100 
size_ty³
 
i
 = 
™em
.
key
<size_type>();

101 
d©a_
[
i
].
v
.
	`wr™e
(
™em
.
wr™e_v®ue
<
T
>());

102 
txn
.
	`£t_v”siÚ_uÆock
(
d©a_
[
i
].
v”siÚ
, 
™em
);

103 
	}
}

104 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

105 
d©a_
[
™em
.
key
<
size_ty³
>()].
v”siÚ
.
	`ı_uÆock
(item);

106 
	}
}

108 
	g´iv©e
:

109 
	s–em
 {

110 
mubË
 
v”siÚ_ty³
 
v”siÚ
;

111 
	gW
<
	gT
> 
	gv
;

113 
–em
 
	gd©a_
[
N
];

115 
ä›nd
 
şass
 
	g™”©Ü
;

116 
ä›nd
 
şass
 
	gcÚ¡_™”©Ü
;

120 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

121 
şass
 
	gSwissTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
cÚ¡_™”©Ü
 : 
public
 
¡d
::
™”©Ü
<¡d::
¿ndom_acûss_™”©Ü_g
, T> {

122 
	gpublic
:

123 
SwissTA¼ay
<
	tT
, 
	tN
, 
	tW
> 
	t¬¿y_ty³
;

124 
ty³Çme
 
	t¬¿y_ty³
::
	tsize_ty³
 size_type;

125 
ty³Çme
 
	t¬¿y_ty³
::
	tdifã»nû_ty³
 difference_type;

127 
cÚ¡_™”©Ü
(cÚ¡ 
SwissTA¼ay
<
T
, 
N
, 
W
>* 
a
, 
size_ty³
 
i
)

128 : 
a_
(
cÚ¡_ÿ¡
<
¬¿y_ty³
*>(
a
)), 
i_
(
i
) {

131 
ty³Çme
 
	g¬¿y_ty³
::
cÚ¡_´oxy_ty³
 
İ”©Ü
*() const {

132  
¬¿y_ty³
::
cÚ¡_´oxy_ty³
(
a_
, 
i_
);

135 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

136  
a_
 =ğ
x
.a_ && 
i_
 == x.i_;

138 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

139  !(*
this
 =ğ
x
);

141 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

142 
as£¹
(
a_
 =ğ
x
.a_);

143  
	gi_
 < 
	gx
.i_;

145 
boŞ
 
	gİ”©Ü
<=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

146 
as£¹
(
a_
 =ğ
x
.a_);

147  
	gi_
 <ğ
x
.
i_
;

149 
boŞ
 
	gİ”©Ü
>(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

150 
as£¹
(
a_
 =ğ
x
.a_);

151  
	gi_
 > 
	gx
.i_;

153 
boŞ
 
	gİ”©Ü
>=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

154 
as£¹
(
a_
 =ğ
x
.a_);

155  
	gi_
 >ğ
x
.
i_
;

158 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
+=(
difã»nû_ty³
 
d–
) {

159 
i_
 +ğ
d–
;

160  *
	gthis
;

162 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
-=(
difã»nû_ty³
 
d–
) {

163 
i_
 +ğ
d–
;

164  *
	gthis
;

166 
cÚ¡_™”©Ü
 
	gİ”©Ü
+(
difã»nû_ty³
 
	gd–
) const {

167  
cÚ¡_™”©Ü
(
a_
, 
i_
 + 
d–
);

169 
cÚ¡_™”©Ü
 
	gİ”©Ü
-(
difã»nû_ty³
 
	gd–
) const {

170  
cÚ¡_™”©Ü
(
a_
, 
i_
 - 
d–
);

172 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
++() {

173 ++
	gi_
;

174  *
	gthis
;

176 
cÚ¡_™”©Ü
 
	gİ”©Ü
++() {

177 ++
	gi_
;

178  
cÚ¡_™”©Ü
(
a_
, 
i_
 - 1);

180 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
--() {

181 --
	gi_
;

182  *
	gthis
;

184 
cÚ¡_™”©Ü
 
	gİ”©Ü
--() {

185 --
	gi_
;

186  
cÚ¡_™”©Ü
(
a_
, 
i_
 + 1);

189 
difã»nû_ty³
 
	gİ”©Ü
-(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

190 
as£¹
(
a_
 =ğ
x
.a_);

191  
	gi_
 - 
	gx
.i_;

194 
	g´Ùeùed
:

195 
¬¿y_ty³
* 
a_
;

196 
size_ty³
 
	gi_
;

199 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

200 
şass
 
	gSwissTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
™”©Ü
 : 
public
 
cÚ¡_™”©Ü
 {

201 
public
:

202 
SwissTA¼ay
<
	tT
, 
	tN
, 
	tW
> 
	t¬¿y_ty³
;

203 
ty³Çme
 
	t¬¿y_ty³
::
	tsize_ty³
 size_type;

204 
ty³Çme
 
	t¬¿y_ty³
::
	tdifã»nû_ty³
 difference_type;

206 
™”©Ü
(cÚ¡ 
SwissTA¼ay
<
T
, 
N
, 
W
>* 
a
, 
size_ty³
 
i
)

207 : 
cÚ¡_™”©Ü
(
a
, 
i
) {

210 
ty³Çme
 
	g¬¿y_ty³
::
´oxy_ty³
 
İ”©Ü
*() const {

211  
¬¿y_ty³
::
´oxy_ty³
(
this
->
a_
,his->
i_
);

214 
	g™”©Ü
& 
	gİ”©Ü
+=(
difã»nû_ty³
 
d–
) {

215 
this
->
i_
 +ğ
d–
;

216  *
	gthis
;

218 
	g™”©Ü
& 
	gİ”©Ü
-=(
difã»nû_ty³
 
d–
) {

219 
this
->
i_
 +ğ
d–
;

220  *
	gthis
;

222 
™”©Ü
 
	gİ”©Ü
+(
difã»nû_ty³
 
	gd–
) const {

223  
™”©Ü
(
this
->
a_
,his->
i_
 + 
d–
);

225 
™”©Ü
 
	gİ”©Ü
-(
difã»nû_ty³
 
	gd–
) const {

226  
™”©Ü
(
this
->
a_
,his->
i_
 - 
d–
);

228 
	g™”©Ü
& 
	gİ”©Ü
++() {

229 ++
	gthis
->
	gi_
;

230  *
	gthis
;

232 
™”©Ü
 
	gİ”©Ü
++() {

233 ++
	gthis
->
	gi_
;

234  
™”©Ü
(
this
->
a_
,his->
i_
 - 1);

236 
	g™”©Ü
& 
	gİ”©Ü
--() {

237 --
	gthis
->
	gi_
;

238  *
	gthis
;

240 
™”©Ü
 
	gİ”©Ü
--() {

241 --
	gthis
->
	gi_
;

242  
™”©Ü
(
this
->
a_
,his->
i_
 + 1);

246 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

247 
šlše
‡utØ
	gSwissTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
begš
(è-> 
™”©Ü
 {

248  
™”©Ü
(
this
, 0);

251 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

252 
šlše
‡utØ
	gSwissTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
’d
(è-> 
™”©Ü
 {

253  
™”©Ü
(
this
, 
N
);

256 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

257 
šlše
‡utØ
	gSwissTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
	$cbegš
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

258  
	`cÚ¡_™”©Ü
(
this
, 0);

259 
	}
}

261 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

262 
šlše
‡utØ
	gSwissTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
	$ûnd
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

263  
	`cÚ¡_™”©Ü
(
this
, 
N
);

264 
	}
}

266 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

267 
šlše
‡utØ
	gSwissTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
	$begš
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

268  
	`cÚ¡_™”©Ü
(
this
, 0);

269 
	}
}

271 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

272 
šlše
‡utØ
	gSwissTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
	$’d
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

273  
	`cÚ¡_™”©Ü
(
this
, 
N
);

274 
	}
}

	@datatype/SwissTGeneric.hh

1 #´agm¨
Úû


2 
	~"T¿n§ùiÚ.hh
"

3 
	~"TW¿µed.hh
"

4 
	~"CÚcu¼’cyCÚŒŞ.hh
"

5 
	~"CÚ‹ÁiÚMªag”.hh
"

6 
	~"T¿n§ùiÚ.hh
"

7 
	~"SwissTA¼ay.hh
"

9 
	~<sys/»sourû.h
>

10 
	~<as£¹.h
>

14 
	g‹m¶©e
 <‹m¶©<
	gty³Çme
> 
şass
 
	gW
 = 
TSwissW¿µed
>

15 şas 
	cSwissTBasicG’”ic
 : 
public
 
TObjeù
 {

16 
public
:

17 
ty³Çme
 
	tW
<>::
	tv”siÚ_ty³
 version_type;

18 
cÚ¡ex´
 
	mbË_size
 = 1 << 22;

20 
	m‹m¶©e
 <
ty³Çme
 
	mT
>

21 
boŞ
 
	$»ad
(
T
* 
wÜd
, T& 
»t
) {

24 
	`¡©ic_as£¹
((
T
) <= (*), "T†argerhan void*");

25 
	`¡©ic_as£¹
(
mass
::
is_ŒivŸÎy_cİyabË
<
T
>::
v®ue
, "T‚ontrivial");

26 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
wÜd
);

27 ià(
™em
.
	`has_wr™e
()) {

29 
»t
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

30  
Œue
;

32 
boŞ
 
sucûss
;

33 
¡d
::
	`t›
(
sucûss
, 
»t
èğ
W
<
T
>::
	`»ad
(
wÜd
, 
™em
, 
	`v”siÚ
(word));

34  
sucûss
;

37 
‹m¶©e
 <
ty³Çme
 
T
>

38 
	$»ad_throws
(
T
* 
wÜd
, T& 
»t
) {

39 ià(!
	`»ad
(
wÜd
, 
»t
)) {

40 
Sto
::
	`abÜt
();

42 
	}
}

44 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

45 
boŞ
 
	$wr™e
(
T
* 
wÜd
, 
U
 
v®ue
) {

46 
	`¡©ic_as£¹
((
T
) <= (*), "T†argerhan void*");

47 
	`¡©ic_as£¹
(
mass
::
is_ŒivŸÎy_cİyabË
<
T
>::
v®ue
, "T‚ontrivial");

48 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
wÜd
);

49 autØ
v®
 = 
™em
.
	`acquœe_wr™e
(
	`v”siÚ
(
wÜd
), 
	`T
(
v®ue
));

50  
v®
;

51 
	}
}

52 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

53 
	$wr™e_throws
(
T
* 
wÜd
, 
U
 
v®ue
) {

54 ià(!
	`wr™e
(
wÜd
, 
v®ue
)) {

55 
Sto
::
	`abÜt
();

57 
	}
}

60 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

61 (è
txn
;

62 
v”siÚ_ty³
& 
v”s
 = 
	`v”siÚ
(
™em
.
‹m¶©e
 
key
<*>());

63  
v”s
.
	`is_locked_h”e
(è|| v”s.
	`ı_Œy_lock
(
™em
, -1);

64 
	}
}

65 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

66  
	`v”siÚ
(
™em
.
‹m¶©e
 
key
<*>()).
	`ı_check_v”siÚ
(
txn
, item);

67 
	}
}

68 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

69 * 
wÜd
 = 
™em
.
‹m¶©e
 
key
<*>();

70 * 
d©a
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<*>();

71 
	`memıy
(
wÜd
, &
d©a
, 4);

73 
txn
.
	`£t_v”siÚ
(
	`v”siÚ
(
wÜd
));

74 
	}
}

75 
šlše
 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

76 
v”siÚ_ty³
& 
v”s
 = 
	`v”siÚ
(
™em
.
‹m¶©e
 
key
<*>());

78 ià(
v”s
.
	`is_locked_h”e
())

79 
v”s
.
	`ı_uÆock
(
™em
);

82 
	}
}

84 
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
ècÚ¡ 
ov”ride
 {

85 
w
 << "{SwissTG’”iø@" << 
™em
.
key
<*>();

86 
w
 << "}";

87 
	}
}

88 
	$š™_bË_couÁs
() {

89 
	}
}

90 
	$´št_bË_couÁs
() {

91 
	}
}

93 
	g´iv©e
:

94 
v”siÚ_ty³
 
bË_
[
bË_size
];

99 
šlše
 
	gv”siÚ_ty³
& 
	$v”siÚ
(* 
k
) {

100 #ifdeà
__x86_64__


101 
šdex
 = (
»š‹½»t_ÿ¡
<
ušŒ_t
>(
k
è>> 5è% 
bË_size
;

103  
bË_
[
šdex
];

105 
šdex
 = (
»š‹½»t_ÿ¡
<
ušŒ_t
>(
k
è>> 4è% 
bË_size
;

107  
bË_
[(
šdex
];

109 
	}
}

112 
šlše
 
	gWr™eLock
& 
	$wlock
(* 
k
, 
šdex
) {

113 
	`as£¹
(
çl£
);

114 #ifdeà
__x86_64__


115  
wlock_bË_
[(
»š‹½»t_ÿ¡
<
ušŒ_t
>(
k
è>> 5è% 
bË_size
];

117  
wlock_bË_
[(
»š‹½»t_ÿ¡
<
ušŒ_t
>(
k
è>> 4è% 
bË_size
];

119 
	}
}

121 
šlše
 
	gWr™eLock
& 
	$wlock
(* 
k
) {

122 #ifdeà
__x86_64__


123 
šdex
 = (
»š‹½»t_ÿ¡
<
ušŒ_t
>(
k
è>> 5è% 
bË_size
;

125  
wlock_bË_
[
šdex
];

127 
šdex
 = (
»š‹½»t_ÿ¡
<
ušŒ_t
>(
k
è>> 4è% 
bË_size
;

129  
wlock_bË_
[
šdex
];

131 
	}
}

137 
	gSwissTBasicG’”ic
<
	tTSwissO·queW¿µed
> 
	tSwissTG’”ic
;

138 
	gSwissTBasicG’”ic
<
	tTSwissNÚİaqueW¿µed
> 
	tSwissTNÚİaqueG’”ic
;

	@datatype/TART.hh

1 #´agm¨
Úû


2 
	~"cÚfig.h
"

3 
	~"comp”.hh
"

4 
	~<veùÜ
>

5 
	~"IÁ”çû.hh
"

6 
	~"T¿n§ùiÚ.hh
"

7 
	~"TW¿µed.hh
"

8 
	~"sim¶e_¡r.hh
"

9 
	~"´št_v®ue.hh
"

10 
	~"ART.hh
"

12 cÚ¡ * 
	$c_¡r
(
¡d
::
¡ršg
 
s
) {

13  (cÚ¡ *è
s
.
	`c_¡r
();

14 
	}
}

16 şas 
	cTART
 : 
public
 
TObjeù
 {

17 
public
:

18 
¡d
::
	t¡ršg
 
	tKey
;

19 
	m¡d
::
	t¡ršg
 
	tkey_ty³
;

20 
ušŒ_t
 
	tV®ue
;

21 
ušŒ_t
 
	tV®ue_ty³
;

23 
ty³Çme
 
	t¡d
::
	tcÚd™iÚ®
<
	tŒue
, 
	tTV”siÚ
, 
	tTNÚİaqueV”siÚ
>::
	tty³
 
	tV”siÚ_ty³
;

24 
ty³Çme
 
	t¡d
::
	tcÚd™iÚ®
<
	tŒue
, 
	tTW¿µed
<
	tV®ue
>, 
	tTNÚİaqueW¿µed
<V®ue>>::
	tty³
 
	tw¿µed_ty³
;

26 
cÚ¡ex´
 
	mT¿nsI‹m
::
æags_ty³
 
d–‘ed_b™
 = 
T¿nsI‹m
::
u£r0_b™
;

28 
	$TART
() {

29 
	`¬t_Œ“_š™
(&
roÙ_
.
	`acûss
());

32 
¡d
::
·œ
<
boŞ
, 
V®ue
> 
	$ŒªsG‘
(
Key
 
k
) {

33 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
k
);

34 ià(
™em
.
	`has_wr™e
()) {

35 autØ
v®
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
V®ue
>();

36  {
Œue
, 
v®
};

38 
¡d
::
·œ
<
boŞ
, 
V®ue
> 
»t
;

39 
v”s_
.
	`lock_exşusive
();

40 
	`´štf
("COUNTER %02zu TID %d‡¹ s—rchšg ... ... ... ", 
some_couÁ”
++, 
TTh»ad
::
	`id
());

41 
¬t_Ëaf
* 
Ëaf
 = 
	`¬t_£¬ch
(&
roÙ_
.
	`acûss
(), 
	`c_¡r
(
k
), k.
	`Ëngth
());

42 
	`´štf
("COUNTER %02zu TID %d‡¹ s—rched\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
());

43 
V®ue
 
v®
 = 0;

44 ià(
Ëaf
 !ğ
NULL
) {

45 
v®
 = (
V®ue
è
Ëaf
->
v®ue
;

46 
Ëaf
->
v”s
.
	`ob£rve_»ad
(
™em
);

47 
	`´štf
("COUNTER %02zu TID %d GET %°ob£rved key %s, v® i %d, v” i %d\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
Ëaf
, 
	`c_¡r
(
k
), 
v®
,†—f->
v”s
);

49 
v”s_
.
	`ob£rve_»ad
(
™em
);

50 
	`´štf
("COUNTER %02zu TID %d GET %°ob£rved key %s,†—ànuÎ\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
Ëaf
, 
	`c_¡r
(
k
));

52 
v”s_
.
	`uÆock_exşusive
();

53 
»t
 = {
Œue
, 
v®
};

54 
	`´štf
("COUNTER %02zu TID %d g‘ key: %s, v®: %lu\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
k
.
	`c_¡r
(), 
v®
);

55  
»t
;

57 
	}
}

59 
V®ue
 
	$lookup
(
Key
 
k
) {

60 autØ
»suÉ
 = 
	`ŒªsG‘
(
k
);

61 ià(!
»suÉ
.
fœ¡
) {

62 
throw
 
T¿n§ùiÚ
::
	`AbÜt
();

64  
»suÉ
.
£cÚd
;

66 
	}
}

68 
	$ŒªsPut
(
Key
 
k
, 
V®ue
 
v
) {

69 
	`´štf
("COUNTER %02zu TID %d…uˆkey: %s, v®: %lu\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
k
.
	`c_¡r
(), 
v
);

70 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
k
);

71 
™em
.
	`add_wr™e
(
v
);

72 
™em
.
	`ş—r_æags
(
d–‘ed_b™
);

73 
	}
}

75 
	$š£¹
(
Key
 
k
, 
V®ue
 
v
) {

76 
	`ŒªsPut
(
k
, 
v
);

77 
	}
}

79 
	$”a£
(
Key
 
k
) {

80 
	`´štf
("COUNTER %02zu TID %dƒ¿£ key: %s\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
k
.
	`c_¡r
());

81 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
k
);

82 
™em
.
	`add_æags
(
d–‘ed_b™
);

83 
™em
.
	`add_wr™e
(0);

84 
	}
}

86 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

87  
v”s_
.
	`is_locked_h”e
(è|| 
txn
.
	`Œy_lock
(
™em
, vers_);

88 
	}
}

89 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

90 
Key
 
key
 = 
™em
.
‹m¶©e
 key<Key>();

91 
	`´štf
("COUNTER %02zu TID %d checkšg %s\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
	`c_¡r
(
key
));

92 
¬t_Ëaf
* 
s
 = 
	`¬t_£¬ch
(&
roÙ_
.
	`acûss
(), 
	`c_¡r
(
key
), key.
	`Ëngth
());

93 ià(
s
 =ğ
NULL
) {

94 
	`´štf
("COUNTER %02zu TID %d‚uÎ check,»v”siÚ i %d\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
v”s_
);

95  
v”s_
.
	`ı_check_v”siÚ
(
txn
, 
™em
);

97 
	`´štf
("COUNTER %02zu TID %d check„‘uºšg, v”siÚ i %d\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
s
->
v”s
);

98  
s
->
v”s
.
	`ı_check_v”siÚ
(
txn
, 
™em
);

99 
	}
}

100 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

101 
V®ue
 
v®
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<Value>();

102 
Key
 
key
 = 
™em
.
‹m¶©e
 key<Key>();

104 ià(
™em
.
	`has_æag
(
d–‘ed_b™
)) {

105 
	`¬t_d–‘e
(&
roÙ_
.
	`acûss
(), 
	`c_¡r
(
key
), key.
	`Ëngth
());

106 
txn
.
	`£t_v”siÚ
(
v”s_
);

108 
boŞ
 
Ãw_š£¹
;

109 
¬t_Ëaf
* 
s
 = 
	`¬t_š£¹
(&
roÙ_
.
	`acûss
(), 
	`c_¡r
(
key
), key.
	`Ëngth
(), (*è
v®
, &
Ãw_š£¹
);

110 ià(
Ãw_š£¹
) {

111 
	`´štf
("COUNTER %02zu TID %d»v”siÚ s‘\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
());

112 
txn
.
	`£t_v”siÚ
(
v”s_
);

114 
s
->
v”s
.
	`lock_exşusive
();

115 
	`´štf
("COUNTER %02zu TID %d in¡®l: key i %s, v® v”siÚ wa %d\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
	`c_¡r
(
key
), 
s
->
v”s
);

116 
txn
.
	`£t_v”siÚ
(
s
->
v”s
);

117 
	`´štf
("COUNTER %02zu TID %d in¡®È%p: v® v”siÚ s‘Ø%d\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
s
, s->
v”s
);

118 
s
->
v”s
.
	`uÆock_exşusive
();

121 
	`´štf
("COUNTER %02zu TID %d in¡®Èkey: %s, v®: %lu\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
(), 
key
.
	`c_¡r
(), 
v®
);

122 
	}
}

123 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

124 ià(
v”s_
.
	`is_locked_h”e
()) {

125 
v”s_
.
	`ı_uÆock
(
™em
);

127 
	`´štf
("COUNTER %02zu TID %d UNLOCKED\n", 
some_couÁ”
++, 
TTh»ad
::
	`id
());

128 
	}
}

129 
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
ècÚ¡ 
ov”ride
 {

130 
w
 << "{TART<" << 
	`ty³id
().
	`Çme
(è<< "> " << (*è
this
;

131 ià(
™em
.
	`has_»ad
())

132 
w
 << " R" << 
™em
.
»ad_v®ue
<
V”siÚ_ty³
>();

133 ià(
™em
.
	`has_wr™e
())

134 
w
 << " =" << 
™em
.
wr™e_v®ue
<>();

135 
w
 << "}";

136 
	}
}

137 
	g´Ùeùed
:

138 
V”siÚ_ty³
 
v”s_
;

139 
	gTO·queW¿µed
<
	g¬t_Œ“
> 
	groÙ_
;

	@datatype/TArray.hh

1 #´agm¨
Úû


3 
	~"Sto.hh
"

4 
	~"TA¼ayProxy.hh
"

6 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
 = 
TO·queW¿µed
>

7 şas 
	cTA¼ay
 : 
public
 
TObjeù
 {

8 
public
:

9 
şass
 
™”©Ü
;

10 
şass
 
	mcÚ¡_™”©Ü
;

11 
T
 
	tv®ue_ty³
;

12 
ty³Çme
 
	tW
<
	tT
>::
	t»ad_ty³
 
	tg‘_ty³
;

13 
ty³Çme
 
	tW
<
	tT
>::
	tv”siÚ_ty³
 version_type;

14 
	tsize_ty³
;

15 
	tdifã»nû_ty³
;

16 
	mTCÚ¡A¼ayProxy
<
	tTA¼ay
<
	tT
, 
	tN
, 
	tW
> > 
	tcÚ¡_´oxy_ty³
;

17 
	mTA¼ayProxy
<
	tTA¼ay
<
	tT
, 
	tN
, 
	tW
> > 
	t´oxy_ty³
;

19 
size_ty³
 
	$size
() const {

20  
N
;

23 
cÚ¡_´oxy_ty³
 
İ”©Ü
[](
size_ty³
 
i
) const {

24 
	`as£¹
(
i
 < 
N
);

25  
	`cÚ¡_´oxy_ty³
(
this
, 
i
);

26 
	}
}

27 
´oxy_ty³
 
	gİ”©Ü
[](
size_ty³
 
	gi
) {

28 
as£¹
(
i
 < 
N
);

29  
´oxy_ty³
(
this
, 
i
);

32 
šlše
 
™”©Ü
 
begš
();

33 
šlše
 
™”©Ü
 
’d
();

34 
šlše
 
cÚ¡_™”©Ü
 
	$cbegš
() const;

35 
šlše
 
cÚ¡_™”©Ü
 
	$ûnd
() const;

36 
šlše
 
cÚ¡_™”©Ü
 
	$begš
() const;

37 
šlše
 
cÚ¡_™”©Ü
 
	$’d
() const;

40 
boŞ
 
	$ŒªsG‘
(
size_ty³
 
i
, 
v®ue_ty³
& 
»t
) const {

41 
	`as£¹
(
i
 < 
N
);

42 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
i
);

43 ià(
™em
.
	`has_wr™e
()) {

44 
»t
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

45  
Œue
;

48 autØ
»suÉ
 = 
d©a_
[
i
].
v
.
	`»ad
(
™em
, d©a_[i].
v”s
);

49 
»t
 = 
»suÉ
.
£cÚd
;

50  
»suÉ
.
fœ¡
;

52 
	}
}

53 
v®ue_ty³
 
	$ŒªsG‘_throws
(
size_ty³
 
i
) const {

54 
	`as£¹
(
i
 < 
N
);

55 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
i
);

56 ià(
™em
.
	`has_wr™e
()) {

57  
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

60 autØ
»suÉ
 = 
d©a_
[
i
].
v
.
	`»ad
(
™em
, d©a_[i].
v”s
);

61 ià(!
»suÉ
.
fœ¡
)

62 
throw
 
T¿n§ùiÚ
::
	`AbÜt
();

63  
»suÉ
.
£cÚd
;

65 
	}
}

66 
boŞ
 
	$ŒªsPut
(
size_ty³
 
i
, 
T
 
x
) const {

67 
	`as£¹
(
i
 < 
N
);

68 
Sto
::
	`™em
(
this
, 
i
).
	`add_wr™e
(
x
);

69  
Œue
;

70 
	}
}

71 
	$ŒªsPut_throws
(
size_ty³
 
i
, 
T
 
x
) const {

72 
	`ŒªsPut
(
i
, 
x
);

73 
	}
}

75 
g‘_ty³
 
	$nÚŒªs_g‘
(
size_ty³
 
i
) const {

76 
	`as£¹
(
i
 < 
N
);

77  
d©a_
[
i
].
v
.
	`acûss
();

78 
	}
}

79 
	$nÚŒªs_put
(
size_ty³
 
i
, cÚ¡ 
T
& 
x
) {

80 
	`as£¹
(
i
 < 
N
);

81 
d©a_
[
i
].
v
.
	`acûss
(èğ
x
;

82 
	}
}

83 
	$nÚŒªs_put
(
size_ty³
 
i
, 
T
&& 
x
) {

84 
	`as£¹
(
i
 < 
N
);

85 
d©a_
[
i
].
v
.
	`acûss
(èğ
¡d
::
	`move
(
x
);

86 
	}
}

89 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

90  
txn
.
	`Œy_lock
(
™em
, 
d©a_
[™em.
key
<
size_ty³
>()].
v”s
);

91 
	}
}

92 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

93  
d©a_
[
™em
.
key
<
size_ty³
>()].
v”s
.
	`ı_check_v”siÚ
(
txn
, item);

94 
	}
}

95 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

96 
size_ty³
 
i
 = 
™em
.
key
<size_type>();

97 
d©a_
[
i
].
v
.
	`wr™e
(
™em
.
wr™e_v®ue
<
T
>());

98 
txn
.
	`£t_v”siÚ_uÆock
(
d©a_
[
i
].
v”s
, 
™em
);

99 
	}
}

100 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

101 
d©a_
[
™em
.
key
<
size_ty³
>()].
v”s
.
	`ı_uÆock
(item);

102 
	}
}

104 
	g´iv©e
:

105 
	s–em
 {

106 
v”siÚ_ty³
 
v”s
;

107 
	gW
<
	gT
> 
	gv
;

109 
–em
 
	gd©a_
[
N
];

111 
ä›nd
 
şass
 
	g™”©Ü
;

112 
ä›nd
 
şass
 
	gcÚ¡_™”©Ü
;

116 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

117 
şass
 
	gTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
cÚ¡_™”©Ü
 : 
public
 
¡d
::
™”©Ü
<¡d::
¿ndom_acûss_™”©Ü_g
, T> {

118 
	gpublic
:

119 
TA¼ay
<
	tT
, 
	tN
, 
	tW
> 
	t¬¿y_ty³
;

120 
ty³Çme
 
	t¬¿y_ty³
::
	tsize_ty³
 size_type;

121 
ty³Çme
 
	t¬¿y_ty³
::
	tdifã»nû_ty³
 difference_type;

123 
cÚ¡_™”©Ü
(cÚ¡ 
TA¼ay
<
T
, 
N
, 
W
>* 
a
, 
size_ty³
 
i
)

124 : 
a_
(
cÚ¡_ÿ¡
<
¬¿y_ty³
*>(
a
)), 
i_
(
i
) {

127 
ty³Çme
 
	g¬¿y_ty³
::
cÚ¡_´oxy_ty³
 
İ”©Ü
*() const {

128  
¬¿y_ty³
::
cÚ¡_´oxy_ty³
(
a_
, 
i_
);

131 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

132  
a_
 =ğ
x
.a_ && 
i_
 == x.i_;

134 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

135  !(*
this
 =ğ
x
);

137 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

138 
as£¹
(
a_
 =ğ
x
.a_);

139  
	gi_
 < 
	gx
.i_;

141 
boŞ
 
	gİ”©Ü
<=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

142 
as£¹
(
a_
 =ğ
x
.a_);

143  
	gi_
 <ğ
x
.
i_
;

145 
boŞ
 
	gİ”©Ü
>(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

146 
as£¹
(
a_
 =ğ
x
.a_);

147  
	gi_
 > 
	gx
.i_;

149 
boŞ
 
	gİ”©Ü
>=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

150 
as£¹
(
a_
 =ğ
x
.a_);

151  
	gi_
 >ğ
x
.
i_
;

154 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
+=(
difã»nû_ty³
 
d–
) {

155 
i_
 +ğ
d–
;

156  *
	gthis
;

158 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
-=(
difã»nû_ty³
 
d–
) {

159 
i_
 +ğ
d–
;

160  *
	gthis
;

162 
cÚ¡_™”©Ü
 
	gİ”©Ü
+(
difã»nû_ty³
 
	gd–
) const {

163  
cÚ¡_™”©Ü
(
a_
, 
i_
 + 
d–
);

165 
cÚ¡_™”©Ü
 
	gİ”©Ü
-(
difã»nû_ty³
 
	gd–
) const {

166  
cÚ¡_™”©Ü
(
a_
, 
i_
 - 
d–
);

168 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
++() {

169 ++
	gi_
;

170  *
	gthis
;

172 
cÚ¡_™”©Ü
 
	gİ”©Ü
++() {

173 ++
	gi_
;

174  
cÚ¡_™”©Ü
(
a_
, 
i_
 - 1);

176 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
--() {

177 --
	gi_
;

178  *
	gthis
;

180 
cÚ¡_™”©Ü
 
	gİ”©Ü
--() {

181 --
	gi_
;

182  
cÚ¡_™”©Ü
(
a_
, 
i_
 + 1);

185 
difã»nû_ty³
 
	gİ”©Ü
-(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

186 
as£¹
(
a_
 =ğ
x
.a_);

187  
	gi_
 - 
	gx
.i_;

190 
	g´Ùeùed
:

191 
¬¿y_ty³
* 
a_
;

192 
size_ty³
 
	gi_
;

195 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

196 
şass
 
	gTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
™”©Ü
 : 
public
 
cÚ¡_™”©Ü
 {

197 
public
:

198 
TA¼ay
<
	tT
, 
	tN
, 
	tW
> 
	t¬¿y_ty³
;

199 
ty³Çme
 
	t¬¿y_ty³
::
	tsize_ty³
 size_type;

200 
ty³Çme
 
	t¬¿y_ty³
::
	tdifã»nû_ty³
 difference_type;

202 
™”©Ü
(cÚ¡ 
TA¼ay
<
T
, 
N
, 
W
>* 
a
, 
size_ty³
 
i
)

203 : 
cÚ¡_™”©Ü
(
a
, 
i
) {

206 
ty³Çme
 
	g¬¿y_ty³
::
´oxy_ty³
 
İ”©Ü
*() const {

207  
¬¿y_ty³
::
´oxy_ty³
(
this
->
a_
,his->
i_
);

210 
	g™”©Ü
& 
	gİ”©Ü
+=(
difã»nû_ty³
 
d–
) {

211 
this
->
i_
 +ğ
d–
;

212  *
	gthis
;

214 
	g™”©Ü
& 
	gİ”©Ü
-=(
difã»nû_ty³
 
d–
) {

215 
this
->
i_
 +ğ
d–
;

216  *
	gthis
;

218 
™”©Ü
 
	gİ”©Ü
+(
difã»nû_ty³
 
	gd–
) const {

219  
™”©Ü
(
this
->
a_
,his->
i_
 + 
d–
);

221 
™”©Ü
 
	gİ”©Ü
-(
difã»nû_ty³
 
	gd–
) const {

222  
™”©Ü
(
this
->
a_
,his->
i_
 - 
d–
);

224 
	g™”©Ü
& 
	gİ”©Ü
++() {

225 ++
	gthis
->
	gi_
;

226  *
	gthis
;

228 
™”©Ü
 
	gİ”©Ü
++() {

229 ++
	gthis
->
	gi_
;

230  
™”©Ü
(
this
->
a_
,his->
i_
 - 1);

232 
	g™”©Ü
& 
	gİ”©Ü
--() {

233 --
	gthis
->
	gi_
;

234  *
	gthis
;

236 
™”©Ü
 
	gİ”©Ü
--() {

237 --
	gthis
->
	gi_
;

238  
™”©Ü
(
this
->
a_
,his->
i_
 + 1);

242 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

243 
šlše
‡utØ
	gTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
begš
(è-> 
™”©Ü
 {

244  
™”©Ü
(
this
, 0);

247 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

248 
šlše
‡utØ
	gTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
’d
(è-> 
™”©Ü
 {

249  
™”©Ü
(
this
, 
N
);

252 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

253 
šlše
‡utØ
	gTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
	$cbegš
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

254  
	`cÚ¡_™”©Ü
(
this
, 0);

255 
	}
}

257 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

258 
šlše
‡utØ
	gTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
	$ûnd
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

259  
	`cÚ¡_™”©Ü
(
this
, 
N
);

260 
	}
}

262 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

263 
šlše
‡utØ
	gTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
	$begš
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

264  
	`cÚ¡_™”©Ü
(
this
, 0);

265 
	}
}

267 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

268 
šlše
‡utØ
	gTA¼ay
<
	gT
, 
	gN
, 
	gW
>::
	$’d
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

269  
	`cÚ¡_™”©Ü
(
this
, 
N
);

270 
	}
}

	@datatype/TArrayAdaptive.hh

1 #´agm¨
Úû


3 
	~"Sto.hh
"

4 
	~"TA¼ayProxy.hh
"

6 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
 = 
TAd­tiveNÚİaqueW¿µed
>

7 şas 
	cTA¼ayAd­tive
 : 
public
 
TObjeù
 {

8 
public
:

9 
şass
 
™”©Ü
;

10 
şass
 
	mcÚ¡_™”©Ü
;

11 
T
 
	tv®ue_ty³
;

12 
ty³Çme
 
	tW
<
	tT
>::
	t»ad_ty³
 
	tg‘_ty³
;

13 
ty³Çme
 
	tW
<
	tT
>::
	tv”siÚ_ty³
 version_type;

14 
	tsize_ty³
;

15 
	tdifã»nû_ty³
;

16 
	mTCÚ¡A¼ayProxy
<
	tTA¼ayAd­tive
<
	tT
, 
	tN
, 
	tW
> > 
	tcÚ¡_´oxy_ty³
;

17 
	mTA¼ayProxy
<
	tTA¼ayAd­tive
<
	tT
, 
	tN
, 
	tW
> > 
	t´oxy_ty³
;

19 
size_ty³
 
	$size
() const {

20  
N
;

23 
cÚ¡_´oxy_ty³
 
İ”©Ü
[](
size_ty³
 
i
) const {

24 
	`as£¹
(
i
 < 
N
);

25  
	`cÚ¡_´oxy_ty³
(
this
, 
i
);

26 
	}
}

27 
´oxy_ty³
 
	gİ”©Ü
[](
size_ty³
 
	gi
) {

28 
as£¹
(
i
 < 
N
);

29  
´oxy_ty³
(
this
, 
i
);

32 
šlše
 
™”©Ü
 
begš
();

33 
šlše
 
™”©Ü
 
’d
();

34 
šlše
 
cÚ¡_™”©Ü
 
	$cbegš
() const;

35 
šlše
 
cÚ¡_™”©Ü
 
	$ûnd
() const;

36 
šlše
 
cÚ¡_™”©Ü
 
	$begš
() const;

37 
šlše
 
cÚ¡_™”©Ü
 
	$’d
() const;

40 
boŞ
 
	$ŒªsG‘
(
size_ty³
 
i
, 
v®ue_ty³
& 
»t
) const {

41 
	`as£¹
(
i
 < 
N
);

43 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
i
);

44 ià(
™em
.
	`has_wr™e
()) {

45 
»t
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

46  
Œue
;

49 autØ
»suÉ
 = 
d©a_
[
i
].
v
.
	`»ad
(
™em
, d©a_[i].
v”s
);

50 
»t
 = 
»suÉ
.
£cÚd
;

51  
»suÉ
.
fœ¡
;

53 
	}
}

54 
v®ue_ty³
 
	$ŒªsG‘_throws
(
size_ty³
 
i
) const {

55 
v®ue_ty³
 
»t
;

56 
boŞ
 
ok
 = 
	`ŒªsG‘
(
i
, 
»t
);

57 ià(!
ok
)

58 
throw
 
T¿n§ùiÚ
::
	`AbÜt
();

59  
»t
;

60 
	}
}

61 
boŞ
 
	$ŒªsPut
(
size_ty³
 
i
, 
T
 
x
) {

62 
	`as£¹
(
i
 < 
N
);

64  
Sto
::
	`™em
(
this
, 
i
).
	`acquœe_wr™e
(
d©a_
[i].
v”s
, 
x
);

65 
	}
}

66 
	$ŒªsPut_throws
(
size_ty³
 
i
, 
T
 
x
) {

67 
boŞ
 
ok
 = 
	`ŒªsPut
(
i
, 
x
);

68 ià(!
ok
)

69 
throw
 
T¿n§ùiÚ
::
	`AbÜt
();

70 
	}
}

72 
g‘_ty³
 
	$nÚŒªs_g‘
(
size_ty³
 
i
) const {

73 
	`as£¹
(
i
 < 
N
);

74  
d©a_
[
i
].
v
.
	`acûss
();

75 
	}
}

76 
	$nÚŒªs_put
(
size_ty³
 
i
, cÚ¡ 
T
& 
x
) {

77 
	`as£¹
(
i
 < 
N
);

78 
d©a_
[
i
].
v
.
	`acûss
(èğ
x
;

79 
	}
}

80 
	$nÚŒªs_put
(
size_ty³
 
i
, 
T
&& 
x
) {

81 
	`as£¹
(
i
 < 
N
);

82 
d©a_
[
i
].
v
.
	`acûss
(èğ
¡d
::
	`move
(
x
);

83 
	}
}

86 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

87  
txn
.
	`Œy_lock
(
™em
, 
d©a_
[™em.
key
<
size_ty³
>()].
v”s
);

88 
	}
}

89 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

90  
d©a_
[
™em
.
key
<
size_ty³
>()].
v”s
.
	`ı_check_v”siÚ
(
txn
, item);

91 
	}
}

92 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

93 
size_ty³
 
i
 = 
™em
.
key
<size_type>();

94 
d©a_
[
i
].
v
.
	`wr™e
(
™em
.
wr™e_v®ue
<
T
>());

95 
txn
.
	`£t_v”siÚ_uÆock
(
d©a_
[
i
].
v”s
, 
™em
);

96 
	}
}

97 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

98 
d©a_
[
™em
.
key
<
size_ty³
>()].
v”s
.
	`ı_uÆock
(item);

99 
	}
}

101 
	g´iv©e
:

102 
	s–em
 {

103 
mubË
 
v”siÚ_ty³
 
v”s
;

104 
	gW
<
	gT
> 
	gv
;

106 
–em
 
	gd©a_
[
N
];

108 
ä›nd
 
şass
 
	g™”©Ü
;

109 
ä›nd
 
şass
 
	gcÚ¡_™”©Ü
;

113 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

114 
şass
 
	gTA¼ayAd­tive
<
	gT
, 
	gN
, 
	gW
>::
cÚ¡_™”©Ü
 : 
public
 
¡d
::
™”©Ü
<¡d::
¿ndom_acûss_™”©Ü_g
, T> {

115 
	gpublic
:

116 
TA¼ayAd­tive
<
	tT
, 
	tN
, 
	tW
> 
	t¬¿y_ty³
;

117 
ty³Çme
 
	t¬¿y_ty³
::
	tsize_ty³
 size_type;

118 
ty³Çme
 
	t¬¿y_ty³
::
	tdifã»nû_ty³
 difference_type;

120 
cÚ¡_™”©Ü
(cÚ¡ 
TA¼ayAd­tive
<
T
, 
N
, 
W
>* 
a
, 
size_ty³
 
i
)

121 : 
a_
(
cÚ¡_ÿ¡
<
¬¿y_ty³
*>(
a
)), 
i_
(
i
) {

124 
ty³Çme
 
	g¬¿y_ty³
::
cÚ¡_´oxy_ty³
 
İ”©Ü
*() const {

125  
¬¿y_ty³
::
cÚ¡_´oxy_ty³
(
a_
, 
i_
);

128 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

129  
a_
 =ğ
x
.a_ && 
i_
 == x.i_;

131 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

132  !(*
this
 =ğ
x
);

134 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

135 
as£¹
(
a_
 =ğ
x
.a_);

136  
	gi_
 < 
	gx
.i_;

138 
boŞ
 
	gİ”©Ü
<=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

139 
as£¹
(
a_
 =ğ
x
.a_);

140  
	gi_
 <ğ
x
.
i_
;

142 
boŞ
 
	gİ”©Ü
>(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

143 
as£¹
(
a_
 =ğ
x
.a_);

144  
	gi_
 > 
	gx
.i_;

146 
boŞ
 
	gİ”©Ü
>=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

147 
as£¹
(
a_
 =ğ
x
.a_);

148  
	gi_
 >ğ
x
.
i_
;

151 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
+=(
difã»nû_ty³
 
d–
) {

152 
i_
 +ğ
d–
;

153  *
	gthis
;

155 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
-=(
difã»nû_ty³
 
d–
) {

156 
i_
 +ğ
d–
;

157  *
	gthis
;

159 
cÚ¡_™”©Ü
 
	gİ”©Ü
+(
difã»nû_ty³
 
	gd–
) const {

160  
cÚ¡_™”©Ü
(
a_
, 
i_
 + 
d–
);

162 
cÚ¡_™”©Ü
 
	gİ”©Ü
-(
difã»nû_ty³
 
	gd–
) const {

163  
cÚ¡_™”©Ü
(
a_
, 
i_
 - 
d–
);

165 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
++() {

166 ++
	gi_
;

167  *
	gthis
;

169 
cÚ¡_™”©Ü
 
	gİ”©Ü
++() {

170 ++
	gi_
;

171  
cÚ¡_™”©Ü
(
a_
, 
i_
 - 1);

173 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
--() {

174 --
	gi_
;

175  *
	gthis
;

177 
cÚ¡_™”©Ü
 
	gİ”©Ü
--() {

178 --
	gi_
;

179  
cÚ¡_™”©Ü
(
a_
, 
i_
 + 1);

182 
difã»nû_ty³
 
	gİ”©Ü
-(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

183 
as£¹
(
a_
 =ğ
x
.a_);

184  
	gi_
 - 
	gx
.i_;

187 
	g´Ùeùed
:

188 
¬¿y_ty³
* 
a_
;

189 
size_ty³
 
	gi_
;

192 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

193 
şass
 
	gTA¼ayAd­tive
<
	gT
, 
	gN
, 
	gW
>::
™”©Ü
 : 
public
 
cÚ¡_™”©Ü
 {

194 
public
:

195 
TA¼ayAd­tive
<
	tT
, 
	tN
, 
	tW
> 
	t¬¿y_ty³
;

196 
ty³Çme
 
	t¬¿y_ty³
::
	tsize_ty³
 size_type;

197 
ty³Çme
 
	t¬¿y_ty³
::
	tdifã»nû_ty³
 difference_type;

199 
™”©Ü
(cÚ¡ 
TA¼ayAd­tive
<
T
, 
N
, 
W
>* 
a
, 
size_ty³
 
i
)

200 : 
cÚ¡_™”©Ü
(
a
, 
i
) {

203 
ty³Çme
 
	g¬¿y_ty³
::
´oxy_ty³
 
İ”©Ü
*() const {

204  
¬¿y_ty³
::
´oxy_ty³
(
this
->
a_
,his->
i_
);

207 
	g™”©Ü
& 
	gİ”©Ü
+=(
difã»nû_ty³
 
d–
) {

208 
this
->
i_
 +ğ
d–
;

209  *
	gthis
;

211 
	g™”©Ü
& 
	gİ”©Ü
-=(
difã»nû_ty³
 
d–
) {

212 
this
->
i_
 +ğ
d–
;

213  *
	gthis
;

215 
™”©Ü
 
	gİ”©Ü
+(
difã»nû_ty³
 
	gd–
) const {

216  
™”©Ü
(
this
->
a_
,his->
i_
 + 
d–
);

218 
™”©Ü
 
	gİ”©Ü
-(
difã»nû_ty³
 
	gd–
) const {

219  
™”©Ü
(
this
->
a_
,his->
i_
 - 
d–
);

221 
	g™”©Ü
& 
	gİ”©Ü
++() {

222 ++
	gthis
->
	gi_
;

223  *
	gthis
;

225 
™”©Ü
 
	gİ”©Ü
++() {

226 ++
	gthis
->
	gi_
;

227  
™”©Ü
(
this
->
a_
,his->
i_
 - 1);

229 
	g™”©Ü
& 
	gİ”©Ü
--() {

230 --
	gthis
->
	gi_
;

231  *
	gthis
;

233 
™”©Ü
 
	gİ”©Ü
--() {

234 --
	gthis
->
	gi_
;

235  
™”©Ü
(
this
->
a_
,his->
i_
 + 1);

239 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

240 
šlše
‡utØ
	gTA¼ayAd­tive
<
	gT
, 
	gN
, 
	gW
>::
begš
(è-> 
™”©Ü
 {

241  
™”©Ü
(
this
, 0);

244 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

245 
šlše
‡utØ
	gTA¼ayAd­tive
<
	gT
, 
	gN
, 
	gW
>::
’d
(è-> 
™”©Ü
 {

246  
™”©Ü
(
this
, 
N
);

249 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

250 
šlše
‡utØ
	gTA¼ayAd­tive
<
	gT
, 
	gN
, 
	gW
>::
	$cbegš
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

251  
	`cÚ¡_™”©Ü
(
this
, 0);

252 
	}
}

254 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

255 
šlše
‡utØ
	gTA¼ayAd­tive
<
	gT
, 
	gN
, 
	gW
>::
	$ûnd
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

256  
	`cÚ¡_™”©Ü
(
this
, 
N
);

257 
	}
}

259 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

260 
šlše
‡utØ
	gTA¼ayAd­tive
<
	gT
, 
	gN
, 
	gW
>::
	$begš
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

261  
	`cÚ¡_™”©Ü
(
this
, 0);

262 
	}
}

264 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

265 
šlše
‡utØ
	gTA¼ayAd­tive
<
	gT
, 
	gN
, 
	gW
>::
	$’d
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

266  
	`cÚ¡_™”©Ü
(
this
, 
N
);

267 
	}
}

	@datatype/TArrayProxy.hh

1 #´agm¨
Úû


3 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

4 şas 
	cTCÚ¡A¼ayProxy
 {

5 
	mpublic
:

6 
ty³Çme
 
	tC
::
	tv®ue_ty³
 value_type;

7 
ty³Çme
 
	tC
::
	tg‘_ty³
 get_type;

8 
ty³Çme
 
	tC
::
	tsize_ty³
 size_type;

10 
	$TCÚ¡A¼ayProxy
(cÚ¡ 
C
* 
c
, 
size_ty³
 
idx
)

11 : 
	`c_
(
c
), 
	$idx_
(
idx
) {

14 
İ”©Ü
 
	$v®ue_ty³
() const {

15  
c_
->
	`ŒªsG‘_throws
(
idx_
);

16 
	}
}

18 
	gTCÚ¡A¼ayProxy
<
	gC
>& 
	gİ”©Ü
=(cÚ¡ 
TCÚ¡A¼ayProxy
<
C
>&èğ
d–‘e
;

20 
	g´Ùeùed
:

21 cÚ¡ 
C
* 
c_
;

22 
size_ty³
 
	gidx_
;

25 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

26 
şass
 
	gTA¼ayProxy
 : 
public
 
TCÚ¡A¼ayProxy
<
C
> {

27 
public
:

28 
TCÚ¡A¼ayProxy
<
	tC
> 
	tba£_ty³
;

29 
ty³Çme
 
	tTCÚ¡A¼ayProxy
<
	tC
>::
	tv®ue_ty³
 value_type;

30 
ty³Çme
 
	tTCÚ¡A¼ayProxy
<
	tC
>::
	tg‘_ty³
 get_type;

31 
ty³Çme
 
	tTCÚ¡A¼ayProxy
<
	tC
>::
	tsize_ty³
 size_type;

33 
TA¼ayProxy
(
C
* 
c
, 
size_ty³
 
idx
)

34 : 
ba£_ty³
(
c
, 
idx
) {

37 
	gTA¼ayProxy
<
	gC
>& 
	gİ”©Ü
=(cÚ¡ 
v®ue_ty³
& 
x
) {

38 
cÚ¡_ÿ¡
<
C
*>(
this
->
c_
)->
ŒªsPut_throws
Ñhis->
idx_
, 
x
);

39  *
	gthis
;

41 
	gTA¼ayProxy
<
	gC
>& 
	gİ”©Ü
=(
v®ue_ty³
&& 
x
) {

42 
cÚ¡_ÿ¡
<
C
*>(
this
->
c_
)->
ŒªsPut_throws
Ñhis->
idx_
, 
¡d
::
move
(
x
));

43  *
	gthis
;

45 
	gTA¼ayProxy
<
	gC
>& 
	gİ”©Ü
=(cÚ¡ 
TA¼ayProxy
<
C
>& 
x
) {

46 
cÚ¡_ÿ¡
<
C
*>(
this
->
c_
)->
ŒªsPut_throws
Ñhis->
idx_
, 
x
.
İ”©Ü
 
g‘_ty³
());

47  *
	gthis
;

	@datatype/TBox.hh

1 #´agm¨
Úû


3 
	~"Sto.hh
"

5 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
 = 
TO·queW¿µed
<
T
> >

6 şas 
	cTBox
 : 
public
 
TObjeù
 {

7 
public
:

8 
ty³Çme
 
	tW
::
	t»ad_ty³
„ead_type;

9 
ty³Çme
 
	tW
::
	tv”siÚ_ty³
 version_type;

11 
	$TBox
() {

13 
‹m¶©e
 <
ty³Çme
... 
Args
>

14 
ex¶ic™
 
	$TBox
(
Args
&&... 
¬gs
)

15 : 
	`v_
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {

16 
	}
}

18 
¡d
::
·œ
<
boŞ
, 
	g»ad_ty³
> 
	$»ad_nÙhrow
() const {

19 autØ
™em
 = 
Sto
::
	`™em
(
this
, 0);

20 ià(
™em
.
	`has_wr™e
())

21  {
Œue
, 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>()};

23  
v_
.
	`»ad
(
™em
, 
v”s_
);

24 
	}
}

26 
»ad_ty³
 
	$»ad
() const {

27 autØ
»suÉ
 = 
	`»ad_nÙhrow
();

28 ià(!
»suÉ
.
fœ¡
)

29 
throw
 
T¿n§ùiÚ
::
	`AbÜt
();

31  
»suÉ
.
£cÚd
;

32 
	}
}

34 
	$wr™e
(cÚ¡ 
T
& 
x
) {

35 
Sto
::
	`™em
(
this
, 0).
	`acquœe_wr™e
(
v”s_
, 
x
);

36 
	}
}

37 
	$wr™e
(
T
&& 
x
) {

38 
Sto
::
	`™em
(
this
, 0).
	`acquœe_wr™e
(
v”s_
, 
¡d
::
	`move
(
x
));

39 
	}
}

40 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

41 
	$wr™e
(
Args
&&... 
¬gs
) {

42 
Sto
::
	`™em
(
this
, 0).
‹m¶©e
 
acquœe_wr™e
<
T
>(
v”s_
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

43 
	}
}

45 
İ”©Ü
 
	$»ad_ty³
() const {

46  
	`»ad
();

47 
	}
}

48 
	gTBox
<
	gT
, 
	gW
>& 
	gİ”©Ü
=(cÚ¡ 
T
& 
x
) {

49 
wr™e
(
x
);

50  *
	gthis
;

52 
	gTBox
<
	gT
, 
	gW
>& 
	gİ”©Ü
=(
T
&& 
x
) {

53 
wr™e
(
¡d
::
move
(
x
));

54  *
	gthis
;

61 
	gTBox
<
	gT
, 
	gW
>& 
	gİ”©Ü
=(cÚ¡ 
TBox
<
T
, W>& 
	gx
) {

62 
wr™e
(
x
.
»ad
());

63  *
	gthis
;

66 cÚ¡ 
	gT
& 
	$nÚŒªs_»ad
() const {

67  
v_
.
	`acûss
();

68 
	}
}

69 
	gT
& 
	$nÚŒªs_acûss
() {

70  
v_
.
	`acûss
();

71 
	}
}

72 
	$nÚŒªs_wr™e
(cÚ¡ 
T
& 
x
) {

73 
v_
.
	`acûss
(èğ
x
;

74 
	}
}

75 
	$nÚŒªs_wr™e
(
T
&& 
x
) {

76 
v_
.
	`acûss
(èğ
¡d
::
	`move
(
x
);

77 
	}
}

80 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

81  
txn
.
	`Œy_lock
(
™em
, 
v”s_
);

82 
	}
}

83 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

84  
v”s_
.
	`ı_check_v”siÚ
(
txn
, 
™em
);

85 
	}
}

86 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

87 
v_
.
	`wr™e
(
¡d
::
	`move
(
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>()));

88 
txn
.
	`£t_v”siÚ_uÆock
(
v”s_
, 
™em
);

89 
	}
}

90 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

91 
v”s_
.
	`ı_uÆock
(
™em
);

92 
	}
}

93 
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
ècÚ¡ 
ov”ride
 {

94 
w
 << "{TBox<" << 
	`ty³id
(
T
).
	`Çme
(è<< "> " << (*è
this
;

95 ià(
™em
.
	`has_»ad
())

96 
w
 << " R" << 
™em
.
»ad_v®ue
<
v”siÚ_ty³
>();

97 ià(
™em
.
	`has_wr™e
())

98 
w
 << " =" << 
™em
.
wr™e_v®ue
<
T
>();

99 
w
 << "}";

100 
	}
}

102 
	g´Ùeùed
:

103 
v”siÚ_ty³
 
v”s_
;

104 
W
 
	gv_
;

	@datatype/TCounter.hh

1 #´agm¨
Úû


2 
	~"TIÁP»diÿ‹.hh
"

4 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
 = 
TW¿µed
<
T
> >

5 şas 
	cTCouÁ”
 : 
public
 
TObjeù
 {

6 
TIÁP»diÿ‹
<
	tT
, 
	tW
> 
	t_ty³
;

7 
ty³Çme
 
	t_ty³
::
	t´ed_ty³
…red_type;

8 
	mpublic
:

9 
ty³Çme
 
	tW
::
	tv”siÚ_ty³
 version_type;

10 
cÚ¡ex´
 
	mT¿nsI‹m
::
æags_ty³
 
d–_b™
 = 
T¿nsI‹m
::
u£r0_b™
;

11 
cÚ¡ex´
 
	mT¿nsI‹m
::
æags_ty³
 
assigÃd_b™
 = 
T¿nsI‹m
::
u£r0_b™
 << 1;

12 
	s·œ_ty³
 {

13 
T
 
	mfœ¡
;

14 
T
 
	m£cÚd
;

17 
	$TCouÁ”
() {

18 
	}
}

19 
ex¶ic™
 
	$TCouÁ”
(
T
 
x
)

20 : 
	$v_
(
x
) {

21 
	}
}

23 
İ”©Ü
 
	$T
() const {

24 autØ
™em
 = 
Sto
::
	`™em
(
this
, 0);

25 
T
 
»suÉ
 = 
	`T
();

26 ià(!
™em
.
	`has_æag
(
assigÃd_b™
)) {

27 
»suÉ
 +ğ
v_
.
	`¢­shÙ
(
™em
, 
v”s_
);

28 
	`g‘
(
™em
).
	`ob£rve
(
»suÉ
);

30 ià(
™em
.
	`has_wr™e
())

31 
»suÉ
 +ğ
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

32  
»suÉ
;

33 
	}
}

35 
	gTCouÁ”
<
	gT
, 
	gW
>& 
	gİ”©Ü
=(
T
 
x
) {

36 
Sto
::
™em
(
this
, 0).
add_wr™e
(
x
).
assign_æags
(
assigÃd_b™
);

37  *
	gthis
;

39 
	gTCouÁ”
<
	gT
, 
	gW
>& 
	gİ”©Ü
=(cÚ¡ 
TCouÁ”
<
T
, W>& 
	gx
) {

40  *
	gthis
 = 
x
.
İ”©Ü
 
T
();

42 
	g‹m¶©e
 <
ty³Çme
 
	gTT
,y³Çm
	gWW
>

43 
	gTCouÁ”
<
	gT
, 
	gW
>& 
	gİ”©Ü
=(cÚ¡ 
TCouÁ”
<
TT
, 
	gWW
>& 
	gx
) {

44  *
	gthis
 = 
x
.
İ”©Ü
 
TT
();

47 
T
 
	$nÚŒªs_»ad
() const {

48  
v_
.
	`acûss
();

49 
	}
}

50 
	$nÚŒªs_wr™e
(
T
 
x
) {

51 
v_
.
	`acûss
(èğ
x
;

52 
	}
}

54 
boŞ
 
	gİ”©Ü
==(
T
 
x
) const {

55  
ob£rve_eq
(
Sto
::
™em
(
this
, 0), 
x
);

57 
boŞ
 
	gİ”©Ü
!=(
T
 
x
) const {

58  !
ob£rve_eq
(
Sto
::
™em
(
this
, 0), 
x
);

60 
boŞ
 
	gİ”©Ü
<(
T
 
	gx
) const {

61  
ob£rve_É
(
Sto
::
™em
(
this
, 0), 
x
);

63 
boŞ
 
	gİ”©Ü
<=(
T
 
x
) const {

64  
ob£rve_Ë
(
Sto
::
™em
(
this
, 0), 
x
);

66 
boŞ
 
	gİ”©Ü
>=(
T
 
x
) const {

67  !
ob£rve_É
(
Sto
::
™em
(
this
, 0), 
x
);

69 
boŞ
 
	gİ”©Ü
>(
T
 
	gx
) const {

70  !
ob£rve_Ë
(
Sto
::
™em
(
this
, 0), 
x
);

73 
	gTCouÁ”
<
	gT
, 
	gW
>& 
	gİ”©Ü
+=(
T
 
d–
) {

74 autØ
™em
 = 
Sto
::™em(
this
, 0);

75 
	g™em
.
add_wr™e
(
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>(T()è+ 
d–
);

76 ià(!
	g™em
.
has_æag
(
assigÃd_b™
))

77 
	g™em
.
add_æags
(
d–_b™
);

78  *
	gthis
;

80 
	gTCouÁ”
<
	gT
, 
	gW
>& 
	gİ”©Ü
-=(
T
 
d–
) {

81 autØ
™em
 = 
Sto
::™em(
this
, 0);

82 
	g™em
.
add_wr™e
(
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>(T()è- 
d–
);

83 ià(!
	g™em
.
has_æag
(
assigÃd_b™
))

84 
	g™em
.
add_æags
(
d–_b™
);

85  *
	gthis
;

87 
	gTCouÁ”
<
	gT
, 
	gW
>& 
	gİ”©Ü
++() {

88  *
	gthis
 += 1;

90 
	gİ”©Ü
++() {

91 *
	gthis
 += 1;

93 
	gTCouÁ”
<
	gT
, 
	gW
>& 
	gİ”©Ü
--() {

94  *
	gthis
 -= 1;

96 
	gİ”©Ü
--() {

97 *
	gthis
 -= 1;

101 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

102  
txn
.
	`Œy_lock
(
™em
, 
v”s_
);

103 
	}
}

104 
boŞ
 
	$check_´ediÿ‹
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
, 
boŞ
 
comm™tšg
è
ov”ride
 {

105 
T¿nsProxy
 
	`p
(
txn
, 
™em
);

106 
´ed_ty³
 
´ed
 = 
™em
.
‹m¶©e
 
´ediÿ‹_v®ue
<pred_type>();

107 
T
 
v®ue
 = 
v_
.
	`wa™_¢­shÙ
(
p
, 
v”s_
, 
comm™tšg
);

108  
´ed
.
	`v”ify
(
v®ue
);

109 
	}
}

110 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

111  
v”s_
.
	`ı_check_v”siÚ
(
txn
, 
™em
);

112 
	}
}

113 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

114 
T
 
»suÉ
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<T>();

115 ià(
™em
.
	`has_æag
(
d–_b™
))

116 
»suÉ
 +ğ
v_
.
	`acûss
();

117 
v_
.
	`wr™e
(
»suÉ
);

118 
txn
.
	`£t_v”siÚ_uÆock
(
v”s_
, 
™em
);

119 
	}
}

120 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

121 
v”s_
.
	`ı_uÆock
(
™em
);

122 
	}
}

123 
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
ècÚ¡ 
ov”ride
 {

124 
w
 << "{CouÁ” " << (*è
this
 << "=" << 
v_
.
	`acûss
(è<< ".v" << 
v”s_
.
	`v®ue
();

125 ià(
™em
.
	`has_»ad
())

126 
w
 << " R" << 
™em
.
»ad_v®ue
<
v”siÚ_ty³
>();

127 ià(
™em
.
	`has_wr™e
(è&& i‹m.
	`has_æag
(
d–_b™
))

128 
w
 << " Î”" << 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

129 ià(
™em
.
	`has_wr™e
())

130 
w
 << " =" << 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

131 ià(
™em
.
	`has_´ediÿ‹
(è&& !™em.
	`has_»ad
()) {

132 auto& 
p
 = 
™em
.
´ediÿ‹_v®ue
<
´ed_ty³
>();

133 
w
 << " P[" << 
p
.
fœ¡
 << "," <<….
£cÚd
 << "]";

135 
w
 << "}";

136 
	}
}

138 
	g´iv©e
:

139 
v”siÚ_ty³
 
v”s_
;

140 
W
 
	gv_
;

142 
	g´ed_ty³
& 
	$g‘
(
T¿nsProxy
& 
™em
) {

143  
™em
.
´ediÿ‹_v®ue
<
´ed_ty³
>Õ»d_ty³::
	`uncÚ¡¿šed
());

144 
	}
}

145 
T
 
	$¢­shÙ
(
T¿nsProxy
 
™em
) const {

146 ià(
™em
.
	`has_æag
(
assigÃd_b™
))

147  
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

149  
v_
.
	`¢­shÙ
(
™em
, 
v”s_
);

150 
	}
}

151 
T
 
	$d–
(
T¿nsProxy
 
™em
) {

152  
™em
.
	`has_æag
(
d–_b™
è? i‹m.
‹m¶©e
 
wr™e_v®ue
<
T
>(è: 
	`T
();

153 
	}
}

154 
boŞ
 
	$ob£rve_eq
(
T¿nsProxy
 
™em
, 
T
 
v®ue
) const {

155 
v®ue
 -ğ
	`d–
(
™em
);

156 
T
 
s
 = 
	`¢­shÙ
(
™em
);

157 ià(!
™em
.
	`has_æag
(
assigÃd_b™
))

158 
	`g‘
(
™em
).
	`ob£rve_‹¡_eq
(
s
, 
v®ue
);

159  
s
 =ğ
v®ue
;

160 
	}
}

161 
boŞ
 
	$ob£rve_É
(
T¿nsProxy
 
™em
, 
T
 
v®ue
) const {

162 
v®ue
 -ğ
	`d–
(
™em
);

163 
boŞ
 
»suÉ
 = 
	`¢­shÙ
(
™em
è< 
v®ue
;

164 ià(!
™em
.
	`has_æag
(
assigÃd_b™
))

165 
	`g‘
(
™em
).
	`ob£rve_É
(
v®ue
, 
»suÉ
);

166  
»suÉ
;

167 
	}
}

168 
boŞ
 
	$ob£rve_Ë
(
T¿nsProxy
 
™em
, 
T
 
v®ue
) const {

169 
v®ue
 -ğ
	`d–
(
™em
);

170 
boŞ
 
»suÉ
 = 
	`¢­shÙ
(
™em
è<ğ
v®ue
;

171 ià(!
™em
.
	`has_æag
(
assigÃd_b™
))

172 
	`g‘
(
™em
).
	`ob£rve_Ë
(
v®ue
, 
»suÉ
);

173  
»suÉ
;

174 
	}
}

178 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
>

179 
boŞ
 
	gİ”©Ü
==(
T
 
a
, cÚ¡ 
	gTCouÁ”
<
	gT
, 
	gW
>& 
	gb
) {

180  
	gb
 =ğ
a
;

182 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
>

183 
boŞ
 
	gİ”©Ü
!=(
T
 
a
, cÚ¡ 
	gTCouÁ”
<
	gT
, 
	gW
>& 
	gb
) {

184  
	gb
 !ğ
a
;

186 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
>

187 
boŞ
 
	gİ”©Ü
<(
T
 
	ga
, cÚ¡ 
	gTCouÁ”
<
	gT
, 
	gW
>& 
	gb
) {

188  
	gb
 > 
	ga
;

190 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
>

191 
boŞ
 
	gİ”©Ü
<=(
T
 
a
, cÚ¡ 
	gTCouÁ”
<
	gT
, 
	gW
>& 
	gb
) {

192  
	gb
 >ğ
a
;

194 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
>

195 
boŞ
 
	gİ”©Ü
>=(
T
 
a
, cÚ¡ 
	gTCouÁ”
<
	gT
, 
	gW
>& 
	gb
) {

196  
	gb
 <ğ
a
;

198 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
>

199 
boŞ
 
	gİ”©Ü
>(
T
 
	ga
, cÚ¡ 
	gTCouÁ”
<
	gT
, 
	gW
>& 
	gb
) {

200  
	gb
 < 
	ga
;

	@datatype/TFlexArray.hh

1 #´agm¨
Úû


3 
	~"Sto.hh
"

5 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

6 şas 
	cTFËxA¼ay
 : 
public
 
TObjeù
 {

7 
public
:

8 
T
 
	tv®ue_ty³
;

9 
ty³Çme
 
	tW
<
	tT
>::
	t»ad_ty³
 
	tg‘_ty³
;

10 
ty³Çme
 
	tW
<
	tT
>::
	tv”siÚ_ty³
 version_type;

11 
	tsize_ty³
;

13 
	$TFËxA¼ay
() {

14 
i
 = 0; i < 
N
; ++i)

15 
	`Ãw
 (
d©a_
 + 
i
è
	`–em
();

18 
size_ty³
 
	$size
() const {

19  
N
;

20 
	}
}

22 
boŞ
 
	$ŒªsG‘
(
size_ty³
 
i
, 
v®ue_ty³
 &
»t
) const {

23 
	`as£¹
(
i
 < 
N
);

24 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
i
);

25 ià(
™em
.
	`has_wr™e
()) {

26 
»t
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

27  
Œue
;

29 autØ
»suÉ
 = 
d©a_
[
i
].
v
.
	`»ad
(
™em
, d©a_[i].
v”s
);

30 
»t
 = 
»suÉ
.
£cÚd
;

31  
»suÉ
.
fœ¡
;

33 
	}
}

35 
boŞ
 
	$ŒªsPut
(
size_ty³
 
i
, 
T
 
x
) const {

36 
	`as£¹
(
i
 < 
N
);

37  
Sto
::
	`™em
(
this
, 
i
).
	`acquœe_wr™e
(
d©a_
[i].
v”s
, 
x
);

38 
	}
}

40 
g‘_ty³
 
	$nÚŒªs_g‘
(
size_ty³
 
i
) const {

41 
	`as£¹
(
i
 < 
N
);

42  
d©a_
[
i
].
v
.
	`acûss
();

43 
	}
}

45 
	$nÚŒªs_put
(
size_ty³
 
i
, cÚ¡ 
T
 &
x
) {

46 
	`as£¹
(
i
 < 
N
);

47 
d©a_
[
i
].
v
.
	`acûss
(èğ
x
;

48 
	}
}

50 
	$nÚŒªs_put
(
size_ty³
 
i
, 
T
 &&
x
) {

51 
	`as£¹
(
i
 < 
N
);

52 
d©a_
[
i
].
v
.
	`acûss
(èğ
¡d
::
	`move
(
x
);

53 
	}
}

56 
boŞ
 
	$lock
(
T¿nsI‹m
 &
™em
, 
T¿n§ùiÚ
 &
txn
è
ov”ride
 {

57  
txn
.
	`Œy_lock
(
™em
, 
d©a_
[™em.
key
<
size_ty³
>()].
v”s
);

58 
	}
}

60 
boŞ
 
	$check
(
T¿nsI‹m
 &
™em
, 
T¿n§ùiÚ
 &
txn
è
ov”ride
 {

61  
d©a_
[
™em
.
key
<
size_ty³
>()].
v”s
.
	`ı_check_v”siÚ
(
txn
, item);

62 
	}
}

64 
	$š¡®l
(
T¿nsI‹m
 &
™em
, 
T¿n§ùiÚ
 &
txn
è
ov”ride
 {

65 
size_ty³
 
i
 = 
™em
.
key
<size_type>();

66 
d©a_
[
i
].
v
.
	`wr™e
(
™em
.
wr™e_v®ue
<
T
>());

67 
txn
.
	`£t_v”siÚ_uÆock
(
d©a_
[
i
].
v”s
, 
™em
);

68 
	}
}

70 
	$uÆock
(
T¿nsI‹m
 &
™em
è
ov”ride
 {

71 
d©a_
[
™em
.
key
<
size_ty³
>()].
v”s
.
	`ı_uÆock
(item);

72 
	}
}

74 
	g´iv©e
:

75 
	s–em
 {

76 
–em
() = ;

77 
mubË
 
v”siÚ_ty³
 
	gv”s
;

78 
	gW
<
	gT
> 
	gv
;

80 
–em
 
	gd©a_
[
N
];

83 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
>

84 
usšg
 
	gTOCCA¼ay
 = 
TFËxA¼ay
<
T
, 
	gN
, 
	gTNÚİaqueW¿µed
>;

86 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
>

87 
usšg
 
	gTAd­tiveA¼ay
 = 
TFËxA¼ay
<
T
, 
	gN
, 
	gTAd­tiveNÚİaqueW¿µed
>;

89 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
>

90 
usšg
 
	gTSwissA¼ay
 = 
TFËxA¼ay
<
T
, 
	gN
, 
	gTSwissNÚİaqueW¿µed
>;

92 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
>

93 
usšg
 
	gTicTocA¼ay
 = 
TFËxA¼ay
<
T
, 
	gN
, 
	gTicTocNÚİaqueW¿µed
>;

	@datatype/TGeneric.hh

1 #´agm¨
Úû


2 
	~"T¿n§ùiÚ.hh
"

3 
	~"TW¿µed.hh
"

5 
	g‹m¶©e
 <‹m¶©<
	gty³Çme
> 
şass
 
	gW
 = 
TO·queW¿µed
>

6 şas 
	cTBasicG’”ic
 : 
public
 
TObjeù
 {

7 
public
:

8 
ty³Çme
 
	tW
<>::
	tv”siÚ_ty³
 version_type;

9 
cÚ¡ex´
 
	mbË_size
 = 1 << 15;

11 
	m‹m¶©e
 <
ty³Çme
 
	mT
>

12 
T
 
	$»ad
(
T
* 
wÜd
) {

15 
	`¡©ic_as£¹
((
T
) <= (*), "T†argerhan void*");

16 
	`¡©ic_as£¹
(
mass
::
is_ŒivŸÎy_cİyabË
<
T
>::
v®ue
, "T‚ontrivial");

17 autØ
™
 = 
Sto
::
	`™em
(
this
, 
wÜd
);

18 ià(
™
.
	`has_wr™e
()) {

19 
	`as£¹
(
™
.
	`shiáed_u£r_æags
(è=ğ(
T
));

20  
™
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

22  
W
<
T
>::
	`»ad
(
wÜd
, 
™
, 
	`v”siÚ
(wÜd)).
£cÚd
;

24 
‹m¶©e
 <
ty³Çme
 
T
,y³Çm
U
>

25 
	$wr™e
(
T
* 
wÜd
, 
U
 
v®ue
) {

26 
	`¡©ic_as£¹
((
T
) <= (*), "T†argerhan void*");

27 
	`¡©ic_as£¹
(
mass
::
is_ŒivŸÎy_cİyabË
<
T
>::
v®ue
, "T‚ontrivial");

28 
Sto
::
	`™em
(
this
, 
wÜd
).
	`add_wr™e
(
	`T
(
v®ue
)).
	`assign_æags
((
T
è<< 
T¿nsI‹m
::
u£rf_shiá
);

29 
	}
}

32 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

33 
v”siÚ_ty³
& 
v”s
 = 
	`v”siÚ
(
™em
.
‹m¶©e
 
key
<*>());

34  
v”s
.
	`is_locked_h”e
(è|| 
txn
.
	`Œy_lock
(
™em
, vers);

35 
	}
}

36 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

37  
	`v”siÚ
(
™em
.
‹m¶©e
 
key
<*>()).
	`ı_check_v”siÚ
(
txn
, item);

38 
	}
}

39 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

40 * 
wÜd
 = 
™em
.
‹m¶©e
 
key
<*>();

41 * 
d©a
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<*>();

42 
	`memıy
(
wÜd
, &
d©a
, 
™em
.
	`shiáed_u£r_æags
());

43 
txn
.
	`£t_v”siÚ
(
	`v”siÚ
(
wÜd
));

44 
	}
}

45 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

46 
v”siÚ_ty³
& 
v”s
 = 
	`v”siÚ
(
™em
.
‹m¶©e
 
key
<*>());

47 ià(
v”s
.
	`is_locked_h”e
())

48 
v”s
.
	`ı_uÆock
(
™em
);

49 
	}
}

50 
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
ècÚ¡ 
ov”ride
 {

51 
w
 << "{TG’”iø@" << 
™em
.
key
<*>();

52 ià(
™em
.
	`has_»ad
())

53 
w
 << " R" << 
™em
.
»ad_v®ue
<
v”siÚ_ty³
>();

54 ià(
™em
.
	`has_wr™e
())

55 
w
 << " =" << 
™em
.
wr™e_v®ue
<*>(è<< "/" << i‹m.
	`shiáed_u£r_æags
();

56 
w
 << "}";

57 
	}
}

59 
	g´iv©e
:

60 
v”siÚ_ty³
 
bË_
[
bË_size
];

62 
šlše
 
	gv”siÚ_ty³
& 
	$v”siÚ
(* 
k
) {

63  
bË_
[(
»š‹½»t_ÿ¡
<
ušŒ_t
>(
k
è>> 3è% 
bË_size
];

64 
	}
}

67 
	gTBasicG’”ic
<
	tTO·queW¿µed
> 
	tTG’”ic
;

68 
	gTBasicG’”ic
<
	tTNÚİaqueW¿µed
> 
	tTNÚİaqueG’”ic
;

	@datatype/TInt.hh

1 #´agm¨
Úû


3 
	~"Sto.hh
"

6 şas 
	cTIÁ
 : 
public
 
TObjeù
 {

7 
public
:

8 
ty³Çme
 
	tTO·queW¿µed
<>::
	t»ad_ty³
„ead_type;

9 
ty³Çme
 
	tTO·queW¿µed
<>::
	tv”siÚ_ty³
 version_type;

10 
cÚ¡ex´
 
	mT¿nsI‹m
::
æags_ty³
 
assigÃd_b™
 = 
T¿nsI‹m
::
u£r0_b™
;

12 
	$TIÁ
() {

14 
‹m¶©e
 <
ty³Çme
... 
Args
>

15 
ex¶ic™
 
	$TIÁ
(
Args
&&... 
¬gs
)

16 : 
	`v_
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {

17 
	}
}

19 
¡d
::
·œ
<
boŞ
, 
	g»ad_ty³
> 
	$»ad_nÙhrow
() const {

20 autØ
™em
 = 
Sto
::
	`™em
(
this
, 0);

22 ià(!
™em
.
	`has_æag
(
assigÃd_b™
)) {

23 autØ
x
 = 
v_
.
	`»ad
(
™em
, 
v”s_
);

24 ià(
™em
.
	`has_wr™e
()) {

25 autØ
d–
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<>();

26 
x
 = {x.
fœ¡
, x.
£cÚd
 + 
d–
};

29  
x
;

31 ià(
™em
.
	`has_wr™e
())

32  {
Œue
, 
™em
.
‹m¶©e
 
wr™e_v®ue
<>()};

34  
v_
.
	`»ad
(
™em
, 
v”s_
);

36 
	}
}

38 
»ad_ty³
 
	$»ad
() const {

39 autØ
»suÉ
 = 
	`»ad_nÙhrow
();

40 ià(!
»suÉ
.
fœ¡
)

41 
throw
 
T¿n§ùiÚ
::
	`AbÜt
();

43  
»suÉ
.
£cÚd
;

44 
	}
}

46 
	$wr™e
(cÚ¡ & 
x
) {

47 autØ
™em
 = 
Sto
::
	`™em
(
this
, 0);

48 
™em
.
	`acquœe_wr™e
(
v”s_
, 
x
);

49 
™em
.
	`add_æags
(
assigÃd_b™
);

50 
	}
}

51 
	$wr™e
(&& 
x
) {

52 autØ
™em
 = 
Sto
::
	`™em
(
this
, 0);

53 
™em
.
	`acquœe_wr™e
(
v”s_
, 
¡d
::
	`move
(
x
));

54 
™em
.
	`add_æags
(
assigÃd_b™
);

55 
	}
}

56 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

57 
	$wr™e
(
Args
&&... 
¬gs
) {

58 autØ
™em
 = 
Sto
::
	`™em
(
this
, 0);

59 
™em
.
‹m¶©e
 
acquœe_wr™e
<>(
v”s_
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

60 
™em
.
	`add_æags
(
assigÃd_b™
);

61 
	}
}

63 
İ”©Ü
 
	$»ad_ty³
() const {

64  
	`»ad
();

65 
	}
}

66 
	gTIÁ
& 
	gİ”©Ü
=(cÚ¡ & 
x
) {

67 
wr™e
(
x
);

68  *
	gthis
;

70 
	gTIÁ
& 
	gİ”©Ü
=(&& 
x
) {

71 
wr™e
(
¡d
::
move
(
x
));

72  *
	gthis
;

79 
	gTIÁ
& 
	gİ”©Ü
=(cÚ¡ 
TIÁ
& 
x
) {

80 
wr™e
(
x
.
»ad
());

81  *
	gthis
;

84 
	$šc
(
n
) {

86 autØ
™em
 = 
Sto
::
	`™em
(
this
, 0);

87 ià(
™em
.
	`has_»ad
()) {

88 
	`wr™e
(
this
->
	`»ad
(è+ 
n
);

91 ià(
™em
.
	`has_wr™e
()) {

92 
™em
.
	`acquœe_wr™e
(
v”s_
, i‹m.
‹m¶©e
 
wr™e_v®ue
<>(è+ 
n
);

94 
™em
.
	`acquœe_wr™e
(
v”s_
, 
n
);

97 
	}
}

99 cÚ¡ & 
	$nÚŒªs_»ad
() const {

100  
v_
.
	`acûss
();

101 
	}
}

102 & 
	$nÚŒªs_acûss
() {

103  
v_
.
	`acûss
();

104 
	}
}

105 
	$nÚŒªs_wr™e
(cÚ¡ & 
x
) {

106 
v_
.
	`acûss
(èğ
x
;

107 
	}
}

108 
	$nÚŒªs_wr™e
(&& 
x
) {

109 
v_
.
	`acûss
(èğ
¡d
::
	`move
(
x
);

110 
	}
}

113 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

114  
txn
.
	`Œy_lock
(
™em
, 
v”s_
);

115 
	}
}

116 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

117  
v”s_
.
	`ı_check_v”siÚ
(
txn
, 
™em
);

118 
	}
}

119 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

120 
v_
.
	`wr™e
(
¡d
::
	`move
(
™em
.
‹m¶©e
 
wr™e_v®ue
<>()));

121 
txn
.
	`£t_v”siÚ_uÆock
(
v”s_
, 
™em
);

122 
	}
}

123 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

124 
v”s_
.
	`ı_uÆock
(
™em
);

125 
	}
}

126 
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
ècÚ¡ 
ov”ride
 {

127 
w
 << "{TIÁ<" << 
	`ty³id
().
	`Çme
(è<< "> " << (*è
this
;

128 ià(
™em
.
	`has_»ad
())

129 
w
 << " R" << 
™em
.
»ad_v®ue
<
v”siÚ_ty³
>();

130 ià(
™em
.
	`has_wr™e
())

131 
w
 << " =" << 
™em
.
wr™e_v®ue
<>();

132 
w
 << "}";

133 
	}
}

135 
	g´Ùeùed
:

136 
v”siÚ_ty³
 
v”s_
;

137 
	gTO·queW¿µed
<> 
	gv_
;

	@datatype/TIntPredicate.hh

1 #´agm¨
Úû


2 
	~<ut™y
>

3 
	~<¡dio.h
>

4 
	~"TW¿µed.hh
"

5 
	~"TIÁRªge.hh
"

7 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
 = 
TNÚİaqueW¿µed
<
T
> >

8 şas 
	cTIÁP»diÿ‹
 : 
public
 
TObjeù
 {

9 
public
:

10 
ty³Çme
 
	tW
::
	tv”siÚ_ty³
 version_type;

11 
	mTIÁRªge
<
	tT
> 
	t´ed_ty³
;

13 
	$TIÁP»diÿ‹
() {

15 
	$TIÁP»diÿ‹
(
T
 
x
)

16 : 
	$v_
(
x
) {

17 
	}
}

19 
İ”©Ü
 
	$T
() const {

20 autØ
™em
 = 
Sto
::
	`™em
(
this
, 0);

21 ià(
™em
.
	`has_wr™e
())

22  
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

24 
T
 
»suÉ
 = 
v_
.
	`¢­shÙ
(
™em
, 
v”s_
);

25 
	`g‘
(
™em
).
	`ob£rve
(
»suÉ
);

26  
»suÉ
;

28 
	}
}

30 
	gTIÁP»diÿ‹
<
	gT
, 
	gW
>& 
	gİ”©Ü
=(
T
 
x
) {

31 
Sto
::
™em
(
this
, 0).
add_wr™e
(
x
);

32  *
	gthis
;

34 
	gTIÁP»diÿ‹
<
	gT
, 
	gW
>& 
	gİ”©Ü
=(cÚ¡ 
TIÁP»diÿ‹
<
T
, W>& 
	gx
) {

35  *
	gthis
 = 
x
.
İ”©Ü
 
T
();

37 
	g‹m¶©e
 <
ty³Çme
 
	gTT
,y³Çm
	gWW
>

38 
	gTIÁP»diÿ‹
<
	gT
, 
	gW
>& 
	gİ”©Ü
=(cÚ¡ 
TIÁP»diÿ‹
<
TT
, 
	gWW
>& 
	gx
) {

39  *
	gthis
 = 
x
.
İ”©Ü
 
TT
();

42 
T
 
	$nÚŒªs_»ad
() const {

43  
v_
.
	`acûss
();

44 
	}
}

45 
	$nÚŒªs_wr™e
(
T
 
x
) {

46 
v_
.
	`acûss
(èğ
x
;

47 
	}
}

49 
boŞ
 
	gİ”©Ü
==(
T
 
x
) const {

50  
ob£rve_eq
(
Sto
::
™em
(
this
, 0), 
x
);

52 
boŞ
 
	gİ”©Ü
!=(
T
 
x
) const {

53  !
ob£rve_eq
(
Sto
::
™em
(
this
, 0), 
x
);

55 
boŞ
 
	gİ”©Ü
<(
T
 
	gx
) const {

56  
ob£rve_É
(
Sto
::
™em
(
this
, 0), 
x
);

58 
boŞ
 
	gİ”©Ü
<=(
T
 
x
) const {

59  
ob£rve_Ë
(
Sto
::
™em
(
this
, 0), 
x
);

61 
boŞ
 
	gİ”©Ü
>=(
T
 
x
) const {

62  !
ob£rve_É
(
Sto
::
™em
(
this
, 0), 
x
);

64 
boŞ
 
	gİ”©Ü
>(
T
 
	gx
) const {

65  !
ob£rve_Ë
(
Sto
::
™em
(
this
, 0), 
x
);

70 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

71  
txn
.
	`Œy_lock
(
™em
, 
v”s_
);

72 
	}
}

73 
boŞ
 
	$check_´ediÿ‹
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
, 
boŞ
 
comm™tšg
è
ov”ride
 {

74 
T¿nsProxy
 
	`p
(
txn
, 
™em
);

75 
´ed_ty³
 
´ed
 = 
™em
.
‹m¶©e
 
´ediÿ‹_v®ue
<pred_type>();

76 
T
 
v®ue
 = 
v_
.
	`wa™_¢­shÙ
(
p
, 
v”s_
, 
comm™tšg
);

77  
´ed
.
	`v”ify
(
v®ue
);

78 
	}
}

79 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

80  
v”s_
.
	`ı_check_v”siÚ
(
txn
, 
™em
);

81 
	}
}

82 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

83 
v_
.
	`wr™e
(
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>());

84 
txn
.
	`£t_v”siÚ_uÆock
(
v”s_
, 
™em
);

85 
	}
}

86 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

87 
v”s_
.
	`ı_uÆock
(
™em
);

88 
	}
}

89 
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
ècÚ¡ 
ov”ride
 {

90 
w
 << "{IÁProxy " << (*è
this
 << "=" << 
v_
.
	`acûss
(è<< ".v" << 
v”s_
.
	`v®ue
();

91 ià(
™em
.
	`has_»ad
())

92 
w
 << " R" << 
™em
.
‹m¶©e
 
»ad_v®ue
<
v”siÚ_ty³
>();

93 ià(
™em
.
	`has_wr™e
())

94 
w
 << " =" << 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

95 ià(
™em
.
	`has_´ediÿ‹
(è&& !™em.
	`has_»ad
()) {

96 auto& 
p
 = 
™em
.
´ediÿ‹_v®ue
<
´ed_ty³
>();

97 
w
 << " P[" << 
p
.
fœ¡
 << "," <<….
£cÚd
 << "]";

99 
w
 << "}";

100 
	}
}

102 
	g´iv©e
:

103 
v”siÚ_ty³
 
v”s_
;

104 
W
 
	gv_
;

106 
	g´ed_ty³
& 
	$g‘
(
T¿nsProxy
& 
™em
) {

107  
™em
.
´ediÿ‹_v®ue
<
´ed_ty³
>Õ»d_ty³::
	`uncÚ¡¿šed
());

108 
	}
}

109 
T
 
	$¢­shÙ
(
T¿nsProxy
 
™em
) const {

110 ià(
™em
.
	`has_wr™e
())

111  
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

113  
v_
.
	`¢­shÙ
(
™em
, 
v”s_
);

114 
	}
}

115 
boŞ
 
	$ob£rve_eq
(
T¿nsProxy
 
™em
, 
T
 
v®ue
) const {

116 
T
 
s
 = 
	`¢­shÙ
(
™em
);

117 ià(!
™em
.
	`has_wr™e
())

118 
	`g‘
(
™em
).
	`ob£rve_‹¡_eq
(
s
, 
v®ue
);

119  
s
 =ğ
v®ue
;

120 
	}
}

121 
boŞ
 
	$ob£rve_É
(
T¿nsProxy
 
™em
, 
T
 
v®ue
) const {

122 
boŞ
 
»suÉ
 = 
	`¢­shÙ
(
™em
è< 
v®ue
;

123 ià(!
™em
.
	`has_wr™e
())

124 
	`g‘
(
™em
).
	`ob£rve_É
(
v®ue
, 
»suÉ
);

125  
»suÉ
;

126 
	}
}

127 
boŞ
 
	$ob£rve_Ë
(
T¿nsProxy
 
™em
, 
T
 
v®ue
) const {

128 
boŞ
 
»suÉ
 = 
	`¢­shÙ
(
™em
è<ğ
v®ue
;

129 ià(!
™em
.
	`has_wr™e
())

130 
	`g‘
(
™em
).
	`ob£rve_Ë
(
v®ue
, 
»suÉ
);

131  
»suÉ
;

132 
	}
}

136 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
>

137 
boŞ
 
	gİ”©Ü
==(
T
 
a
, cÚ¡ 
	gTIÁP»diÿ‹
<
	gT
, 
	gW
>& 
	gb
) {

138  
	gb
 =ğ
a
;

140 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
>

141 
boŞ
 
	gİ”©Ü
!=(
T
 
a
, cÚ¡ 
	gTIÁP»diÿ‹
<
	gT
, 
	gW
>& 
	gb
) {

142  
	gb
 !ğ
a
;

144 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
>

145 
boŞ
 
	gİ”©Ü
<(
T
 
	ga
, cÚ¡ 
	gTIÁP»diÿ‹
<
	gT
, 
	gW
>& 
	gb
) {

146  
	gb
 > 
	ga
;

148 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
>

149 
boŞ
 
	gİ”©Ü
<=(
T
 
a
, cÚ¡ 
	gTIÁP»diÿ‹
<
	gT
, 
	gW
>& 
	gb
) {

150  
	gb
 >ğ
a
;

152 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
>

153 
boŞ
 
	gİ”©Ü
>=(
T
 
a
, cÚ¡ 
	gTIÁP»diÿ‹
<
	gT
, 
	gW
>& 
	gb
) {

154  
	gb
 <ğ
a
;

156 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gW
>

157 
boŞ
 
	gİ”©Ü
>(
T
 
	ga
, cÚ¡ 
	gTIÁP»diÿ‹
<
	gT
, 
	gW
>& 
	gb
) {

158  
	gb
 < 
	ga
;

161 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

162 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	gTIÁRªge
<
	gT
>& 
	g¿nge
) {

163  
	gw
 << '[' << 
	g¿nge
.
	gfœ¡
 << ',' <<„ªge.
	g£cÚd
 << ']';

	@datatype/TIntRange.hh

1 #´agm¨
Úû


2 
	~<lim™s
>

3 
	~"comp”.hh
"

4 
	~"T¿n§ùiÚ.hh
"

6 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

7 
	sTIÁRªge
 {

8 
T
 
	mfœ¡
;

9 
T
 
	m£cÚd
;

11 
	mTIÁRªge
<
	mT
> 
uncÚ¡¿šed
() {

12  
	mTIÁRªge
<
	mT
>{
	m¡d
::
num”ic_lim™s
<
T
>::
mš
(), std::num”ic_lim™s<T>::
max
()};

14 
ob£rve
(
T
 
v®ue
) {

15 ià(
	mfœ¡
 <ğ
v®ue
 && v®u<ğ
£cÚd
)

16 
fœ¡
 = 
£cÚd
 = 
v®ue
;

18 
	mSto
::
abÜt
();

20 
ob£rve_‹¡_eq
(
T
 
v®ue
, T 
com·risÚ
) {

21 ià(
	mv®ue
 =ğ
com·risÚ
) {

22 
fœ¡
 = 
¡d
::
max
(fœ¡, 
v®ue
);

23 
	m£cÚd
 = 
¡d
::
mš
(
£cÚd
, 
v®ue
);

24 } ià(
	mv®ue
 < 
	mcom·risÚ
)

25 
	m£cÚd
 = 
¡d
::
mš
(
£cÚd
, 
com·risÚ
 - 1);

27 
	mfœ¡
 = 
¡d
::
max
(
fœ¡
, 
com·risÚ
 + 1);

28 ià(
	mfœ¡
 > 
	m£cÚd
)

29 
	mSto
::
abÜt
();

31 
ob£rve_É
(
T
 
v®ue
, 
boŞ
 
was_É
 = 
Œue
) {

32 ià(
was_É
)

33 
£cÚd
 = 
¡d
::
mš
(£cÚd, 
v®ue
 - 1);

35 
	mfœ¡
 = 
¡d
::
max
(
fœ¡
, 
v®ue
);

36 ià(
	mfœ¡
 > 
	m£cÚd
)

37 
	mSto
::
abÜt
();

39 
ob£rve_Ë
(
T
 
v®ue
, 
boŞ
 
was_Ë
 = 
Œue
) {

40 ià(
was_Ë
)

41 
£cÚd
 = 
¡d
::
mš
(£cÚd, 
v®ue
);

43 
	mfœ¡
 = 
¡d
::
max
(
fœ¡
, 
v®ue
 + 1);

44 ià(
	mfœ¡
 > 
	m£cÚd
)

45 
	mSto
::
abÜt
();

47 
ob£rve_gt
(
T
 
v®ue
, 
boŞ
 
was_gt
 = 
Œue
) {

48 
ob£rve_Ë
(
v®ue
, !
was_gt
);

50 
ob£rve_ge
(
T
 
v®ue
, 
boŞ
 
was_ge
 = 
Œue
) {

51 
ob£rve_É
(
v®ue
, !
was_ge
);

53 
boŞ
 
v”ify
(
T
 
v®ue
) const {

54  
	mfœ¡
 <ğ
v®ue
 && v®u<ğ
£cÚd
;

57 
ä›nd
 
	m¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	mTIÁRªge
<
	mT
>& 
	mr
) {

58  
	mw
 << '[' << 
	mr
.
	mfœ¡
 << ',' <<„.
	m£cÚd
 << ']';

62 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gSigÃd
 = 
¡d
::
is_sigÃd
<
T
>::
v®ue
>

63 
şass
 
TIÁRªgeProxy
;

65 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

66 
şass
 
	gTIÁRªgeProxy
<
	gT
, 
	gçl£
> {

67 
	gpublic
:

68 
T
 
	tv®ue_ty³
;

69 
ty³Çme
 
	tmass
::
	tmake_sigÃd
<
	tT
>::
	tty³
 
	tdifã»nû_ty³
;

71 
TIÁRªgeProxy
(
TIÁRªge
<
T
>* 
r
, 
v®ue_ty³
 
Üigš®
, 
difã»nû_ty³
 
d–
)

72 : 
r_
(
r
), 
Üigš®_
(
Üigš®
), 
d–_
(
d–
) {

75 
İ”©Ü
 
v®ue_ty³
() const {

77 ià(
	gr_
)

78 
	gr_
->
ob£rve
(
Üigš®_
);

79  
	gÜigš®_
 + 
	gd–_
;

82 
boŞ
 
	gİ”©Ü
==(
v®ue_ty³
 
x
) const {

83 
x
 -ğ
d–_
;

84 ià(
	gr_
)

85 
	gr_
->
ob£rve_‹¡_eq
(
Üigš®_
, 
x
);

86  
	gÜigš®_
 =ğ
x
;

88 
boŞ
 
	gİ”©Ü
!=(
v®ue_ty³
 
x
) const {

89  !(*
this
 =ğ
x
);

91 
boŞ
 
	gİ”©Ü
<(
v®ue_ty³
 
	gx
) const {

92 
	gx
 -ğ
d–_
;

93 ià(
	gr_
)

94 
	gr_
->
ob£rve_É
(
x
, 
Üigš®_
 < x);

95  
	gÜigš®_
 < 
	gx
;

97 
boŞ
 
	gİ”©Ü
<=(
v®ue_ty³
 
x
) const {

98 
x
 -ğ
d–_
;

99 ià(
	gr_
)

100 
	gr_
->
ob£rve_Ë
(
x
, 
Üigš®_
 <= x);

101  
	gÜigš®_
 <ğ
x
;

103 
boŞ
 
	gİ”©Ü
>=(
v®ue_ty³
 
x
) const {

104  !(*
this
 < 
x
);

106 
boŞ
 
	gİ”©Ü
>(
v®ue_ty³
 
	gx
) const {

107  !(*
	gthis
 <ğ
x
);

111 
boŞ
 
	gİ”©Ü
==(
difã»nû_ty³
 
x
) const {

112  *
this
 =ğ
v®ue_ty³
(
x
);

114 
boŞ
 
	gİ”©Ü
!=(
difã»nû_ty³
 
x
) const {

115  *
this
 !ğ
v®ue_ty³
(
x
);

117 
boŞ
 
	gİ”©Ü
<(
difã»nû_ty³
 
	gx
) const {

118  *
	gthis
 < 
v®ue_ty³
(
x
);

120 
boŞ
 
	gİ”©Ü
<=(
difã»nû_ty³
 
x
) const {

121  *
this
 <ğ
v®ue_ty³
(
x
);

123 
boŞ
 
	gİ”©Ü
>=(
difã»nû_ty³
 
x
) const {

124  *
this
 >ğ
v®ue_ty³
(
x
);

126 
boŞ
 
	gİ”©Ü
>(
difã»nû_ty³
 
	gx
) const {

127  *
	gthis
 > 
v®ue_ty³
(
x
);

130 
	g´iv©e
:

131 
TIÁRªge
<
T
>* 
r_
;

132 
v®ue_ty³
 
	gÜigš®_
;

133 
difã»nû_ty³
 
	gd–_
;

136 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

137 
şass
 
	gTIÁRªgeProxy
<
	gT
, 
	gŒue
> {

138 
	gpublic
:

139 
T
 
	tv®ue_ty³
;

141 
TIÁRªgeProxy
(
TIÁRªge
<
T
>* 
r
, 
v®ue_ty³
 
Üigš®
, v®ue_ty³ 
d–
)

142 : 
r_
(
r
), 
Üigš®_
(
Üigš®
), 
d–_
(
d–
) {

145 
İ”©Ü
 
v®ue_ty³
() const {

147 ià(
	gr_
)

148 
	gr_
->
ob£rve
(
Üigš®_
);

149  
	gÜigš®_
 + 
	gd–_
;

152 
boŞ
 
	gİ”©Ü
==(
v®ue_ty³
 
x
) const {

153 
x
 -ğ
d–_
;

154 ià(
	gr_
)

155 
	gr_
->
ob£rve_‹¡_eq
(
Üigš®_
, 
x
);

156  
	gÜigš®_
 =ğ
x
;

158 
boŞ
 
	gİ”©Ü
!=(
v®ue_ty³
 
x
) const {

159  !(*
this
 =ğ
x
);

161 
boŞ
 
	gİ”©Ü
<(
v®ue_ty³
 
	gx
) const {

162 
	gx
 -ğ
d–_
;

163 ià(
	gr_
)

164 
	gr_
->
ob£rve_É
(
x
, 
Üigš®_
 < x);

165  
	gÜigš®_
 < 
	gx
;

167 
boŞ
 
	gİ”©Ü
<=(
v®ue_ty³
 
x
) const {

168 
x
 -ğ
d–_
;

169 ià(
	gr_
)

170 
	gr_
->
ob£rve_Ë
(
x
, 
Üigš®_
 <= x);

171  
	gÜigš®_
 <ğ
x
;

173 
boŞ
 
	gİ”©Ü
>=(
v®ue_ty³
 
x
) const {

174  !(*
this
 < 
x
);

176 
boŞ
 
	gİ”©Ü
>(
v®ue_ty³
 
	gx
) const {

177  !(*
	gthis
 <ğ
x
);

180 
	g´iv©e
:

181 
TIÁRªge
<
T
>* 
r_
;

182 
v®ue_ty³
 
	gÜigš®_
;

183 
v®ue_ty³
 
	gd–_
;

186 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

187 şas 
	cTIÁRªgeDifã»nûProxy
 {

188 
	mpublic
:

189 
T
 
	tsize_ty³
;

190 
ty³Çme
 
	tmass
::
	tmake_sigÃd
<
	tT
>::
	tty³
 
	tdifã»nû_ty³
;

192 
TIÁRªgeDifã»nûProxy
(
TIÁRªge
<
T
>* 
r
, 
size_ty³
 
Üigš®
, 
difã»nû_ty³
 
d–
)

193 : 
r_
(
r
), 
Üigš®_
(
Üigš®
), 
	$d–_
(
d–
) {

196 
İ”©Ü
 
	$difã»nû_ty³
() const {

198 ià(
r_
)

199 
r_
->
	`ob£rve
(
Üigš®_
);

200  
Üigš®_
 + 
d–_
;

201 
	}
}

203 
boŞ
 
	gİ”©Ü
==(
difã»nû_ty³
 
x
) const {

204 
x
 -ğ
d–_
;

205 ià(
	gr_
 && 
	gx
 >= 0)

206 
r_
->
ob£rve_‹¡_eq
(
Üigš®_
, 
x
);

207  
	gx
 >ğ0 && 
Üigš®_
 =ğ
size_ty³
(
x
);

209 
boŞ
 
	gİ”©Ü
!=(
difã»nû_ty³
 
x
) const {

210  !(*
this
 =ğ
x
);

212 
boŞ
 
	gİ”©Ü
<(
difã»nû_ty³
 
	gx
) const {

213 
	gx
 -ğ
d–_
;

214 ià(
	gr_
 && 
	gx
 >= 0)

215 
r_
->
ob£rve_É
(
x
, 
Üigš®_
 < 
size_ty³
(x));

216  
	gx
 >ğ0 && 
Üigš®_
 < 
size_ty³
(
x
);

218 
boŞ
 
	gİ”©Ü
<=(
difã»nû_ty³
 
x
) const {

219 
x
 -ğ
d–_
;

220 ià(
	gr_
 && 
	gx
 >= 0)

221 
r_
->
ob£rve_Ë
(
x
, 
Üigš®_
 <ğ
size_ty³
(x));

222  
	gx
 >ğ0 && 
Üigš®_
 <ğ
size_ty³
(
x
);

224 
boŞ
 
	gİ”©Ü
>=(
difã»nû_ty³
 
x
) const {

225  !(*
this
 < 
x
);

227 
boŞ
 
	gİ”©Ü
>(
difã»nû_ty³
 
	gx
) const {

228  !(*
	gthis
 <ğ
x
);

231 
	g´iv©e
:

232 
TIÁRªge
<
T
>* 
r_
;

233 
size_ty³
 
	gÜigš®_
;

234 
difã»nû_ty³
 
	gd–_
;

237 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gSigÃd
>

238 
boŞ
 
	gİ”©Ü
==(
T
 
a
, cÚ¡ 
	gTIÁRªgeProxy
<
	gT
, 
	gSigÃd
>& 
	gb
) {

239  
	gb
 =ğ
a
;

241 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gSigÃd
>

242 
boŞ
 
	gİ”©Ü
!=(
T
 
a
, cÚ¡ 
	gTIÁRªgeProxy
<
	gT
, 
	gSigÃd
>& 
	gb
) {

243  
	gb
 !ğ
a
;

245 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gSigÃd
>

246 
boŞ
 
	gİ”©Ü
<(
T
 
	ga
, cÚ¡ 
	gTIÁRªgeProxy
<
	gT
, 
	gSigÃd
>& 
	gb
) {

247  
	gb
 > 
	ga
;

249 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gSigÃd
>

250 
boŞ
 
	gİ”©Ü
<=(
T
 
a
, cÚ¡ 
	gTIÁRªgeProxy
<
	gT
, 
	gSigÃd
>& 
	gb
) {

251  
	gb
 >ğ
a
;

253 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gSigÃd
>

254 
boŞ
 
	gİ”©Ü
>=(
T
 
a
, cÚ¡ 
	gTIÁRªgeProxy
<
	gT
, 
	gSigÃd
>& 
	gb
) {

255  
	gb
 <ğ
a
;

257 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gSigÃd
>

258 
boŞ
 
	gİ”©Ü
>(
T
 
	ga
, cÚ¡ 
	gTIÁRªgeProxy
<
	gT
, 
	gSigÃd
>& 
	gb
) {

259  
	gb
 < 
	ga
;

262 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

263 
boŞ
 
	gİ”©Ü
==(
ty³Çme
 
TIÁRªgeDifã»nûProxy
<
T
>::
difã»nû_ty³
 
a
,

264 cÚ¡ 
	gTIÁRªgeDifã»nûProxy
<
	gT
>& 
	gb
) {

265  
	gb
 =ğ
a
;

267 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

268 
boŞ
 
	gİ”©Ü
!=(
ty³Çme
 
TIÁRªgeDifã»nûProxy
<
T
>::
difã»nû_ty³
 
a
,

269 cÚ¡ 
	gTIÁRªgeDifã»nûProxy
<
	gT
>& 
	gb
) {

270  
	gb
 !ğ
a
;

272 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

273 
boŞ
 
	gİ”©Ü
<(
ty³Çme
 
	gTIÁRªgeDifã»nûProxy
<
	gT
>::
difã»nû_ty³
 
a
,

274 cÚ¡ 
	gTIÁRªgeDifã»nûProxy
<
	gT
>& 
	gb
) {

275  
	gb
 > 
	ga
;

277 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

278 
boŞ
 
	gİ”©Ü
<=(
ty³Çme
 
TIÁRªgeDifã»nûProxy
<
T
>::
difã»nû_ty³
 
a
,

279 cÚ¡ 
	gTIÁRªgeDifã»nûProxy
<
	gT
>& 
	gb
) {

280  
	gb
 >ğ
a
;

282 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

283 
boŞ
 
	gİ”©Ü
>=(
ty³Çme
 
TIÁRªgeDifã»nûProxy
<
T
>::
difã»nû_ty³
 
a
,

284 cÚ¡ 
	gTIÁRªgeDifã»nûProxy
<
	gT
>& 
	gb
) {

285  
	gb
 <ğ
a
;

287 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

288 
boŞ
 
	gİ”©Ü
>(
ty³Çme
 
	gTIÁRªgeDifã»nûProxy
<
	gT
>::
difã»nû_ty³
 
a
,

289 cÚ¡ 
	gTIÁRªgeDifã»nûProxy
<
	gT
>& 
	gb
) {

290  
	gb
 < 
	ga
;

	@datatype/TVector.hh

1 #´agm¨
Úû


2 
	~"TW¿µed.hh
"

3 
	~"TA¼ayProxy.hh
"

4 
	~"TIÁP»diÿ‹.hh
"

6 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
 = 
TO·queW¿µed
>

7 şas 
	cTVeùÜ
 : 
public
 
TObjeù
 {

8 
public
:

9 
usšg
 
size_ty³
 = ;

10 
usšg
 
	mdifã»nû_ty³
 = ;

11 
ty³Çme
 
	tW
<
	tT
>::
	tv”siÚ_ty³
 version_type;

12 
	m´iv©e
:

13 #ifdeà
TVECTOR_DEFAULT_CAPACITY


14 
cÚ¡ex´
 
size_ty³
 
deçuÉ_ÿ·c™y
 = 
TVECTOR_DEFAULT_CAPACITY
;

16 
cÚ¡ex´
 
size_ty³
 
	mdeçuÉ_ÿ·c™y
 = 128;

18 
usšg
 
	m´ed_ty³
 = 
TIÁRªge
<
size_ty³
>;

19 
usšg
 
	mkey_ty³
 = ;

20 
cÚ¡ex´
 
key_ty³
 
	msize_key
 = -1;

31 
cÚ¡ex´
 
	mT¿nsI‹m
::
æags_ty³
 
pİ_b™
 = 
T¿nsI‹m
::
u£r0_b™
;

32 
cÚ¡ex´
 
	mT¿nsI‹m
::
æags_ty³
 
Úlyexi¡s_b™
 = 
pİ_b™
 << 1;

33 
cÚ¡ex´
 
	mT¿nsI‹m
::
æags_ty³
 
šdexed_b™
 = 
pİ_b™
 << 2;

34 
cÚ¡ex´
 
ty³Çme
 
	mv”siÚ_ty³
::
ty³
 
d—d_b™
 = 
T¿n§ùiÚTid
::
u£r_b™
;

35 
	mpublic
:

36 
şass
 
™”©Ü
;

37 
şass
 
	mcÚ¡_™”©Ü
;

38 
usšg
 
	msize_´oxy
 = 
TIÁRªgeProxy
<
size_ty³
>;

39 
usšg
 
	mdifã»nû_´oxy
 = 
TIÁRªgeDifã»nûProxy
<
size_ty³
>;

40 
T
 
	tv®ue_ty³
;

41 
ty³Çme
 
	tW
<
	tT
>::
	t»ad_ty³
 
	tg‘_ty³
;

42 
	mTCÚ¡A¼ayProxy
<
	tTVeùÜ
<
	tT
, 
	tW
> > 
	tcÚ¡_´oxy_ty³
;

43 
	mTA¼ayProxy
<
	tTVeùÜ
<
	tT
, 
	tW
> > 
	t´oxy_ty³
;

44 
´oxy_ty³
 
	t»ã»nû
;

45 
cÚ¡_´oxy_ty³
 
	tcÚ¡_»ã»nû
;

47 
	$TVeùÜ
()

48 : 
	`size_
(0), 
	`max_size_
(0), 
	$ÿ·c™y_
(
deçuÉ_ÿ·c™y
) {

49 
d©a_
 = 
»š‹½»t_ÿ¡
<
–em
*>(
Ãw
 [ÓËmè* 
ÿ·c™y_
]);

50 
size_ty³
 
i
 = 0; i !ğ
ÿ·c™y_
; ++i)

51 
d©a_
[
i
].
v”s
 = 
	`v”siÚ_ty³
(
d—d_b™
);

53 ~
	$TVeùÜ
() {

54 
usšg
 
WT
 = 
W
<
T
>;

55 
size_ty³
 
i
 = 0; i !ğ
max_size_
; ++i)

56 
d©a_
[
i
].
v
.~
	`WT
();

57 
d–‘e
[] 
»š‹½»t_ÿ¡
<*>(
d©a_
);

58 
	}
}

60 
size_´oxy
 
	$size
() const {

61 autØ
s™em
 = 
	`size_™em
();

62 auto& 
sšfo
 = 
	`size_šfo
(
s™em
);

63  
	`size_´oxy
(&
	`size_´ediÿ‹
(
s™em
), 
sšfo
.
fœ¡
, sšfo.
£cÚd
 - sinfo.first);

64 
	}
}

65 
boŞ
 
	$em±y
() const {

66  
	`size
() != 0;

67 
	}
}

69 
cÚ¡_´oxy_ty³
 
	gİ”©Ü
[](
size_ty³
 
	gi
) const {

70  
cÚ¡_´oxy_ty³
(
this
, 
i
);

72 
´oxy_ty³
 
	gİ”©Ü
[](
size_ty³
 
	gi
) {

73  
´oxy_ty³
(
this
, 
i
);

75 
cÚ¡_´oxy_ty³
 
	$äÚt
() const {

76  
	`cÚ¡_´oxy_ty³
(
this
, 0);

77 
	}
}

78 
´oxy_ty³
 
	$äÚt
() {

79  
	`´oxy_ty³
(
this
, 0);

80 
	}
}

81 
cÚ¡_´oxy_ty³
 
	$back
() const {

82 autØ
s™em
 = 
	`size_™em
();

83 auto& 
sšfo
 = 
	`size_šfo
(
s™em
);

84 
	`size_´ediÿ‹
(
s™em
).
	`ob£rve
(
sšfo
.
fœ¡
);

85 ià(!
sšfo
.
£cÚd
)

86 
v”siÚ_ty³
::
	`İaque_throw
(
¡d
::
	`out_of_¿nge
("TVector::back"));

87  
	`cÚ¡_´oxy_ty³
(
this
, 
sšfo
.
£cÚd
 - 1);

88 
	}
}

89 
´oxy_ty³
 
	$back
() {

90 autØ
s™em
 = 
	`size_™em
();

91 auto& 
sšfo
 = 
	`size_šfo
(
s™em
);

92 
	`size_´ediÿ‹
(
s™em
).
	`ob£rve
(
sšfo
.
fœ¡
);

93 ià(!
sšfo
.
£cÚd
)

94 
v”siÚ_ty³
::
	`İaque_throw
(
¡d
::
	`out_of_¿nge
("TVector::back"));

95  
	`´oxy_ty³
(
this
, 
sšfo
.
£cÚd
 - 1);

96 
	}
}

98 
šlše
 
™”©Ü
 
begš
();

99 
šlše
 
™”©Ü
 
’d
();

100 
šlše
 
cÚ¡_™”©Ü
 
	$cbegš
() const;

101 
šlše
 
cÚ¡_™”©Ü
 
	$ûnd
() const;

102 
šlše
 
cÚ¡_™”©Ü
 
	$begš
() const;

103 
šlše
 
cÚ¡_™”©Ü
 
	$’d
() const;

105 
	$push_back
(
T
 
x
) {

106 autØ
s™em
 = 
	`size_™em
().
	`add_wr™e
();

107 
´ed_ty³
& 
wv®
 = 
	`size_šfo
(
s™em
);

108 ++
wv®
.
£cÚd
;

109 
Sto
::
	`™em
(
this
, 
wv®
.
£cÚd
 - 1).
	`ş—r_wr™e
().
	`ş—r_æags
(
pİ_b™
)

110 .
	`add_wr™e
(
¡d
::
	`move
(
x
));

111 
	}
}

112 
	$pİ_back
() {

113 autØ
s™em
 = 
	`size_™em
().
	`add_wr™e
();

114 
´ed_ty³
& 
wv®
 = 
	`size_šfo
(
s™em
);

115 ià(!
wv®
.
£cÚd
)

116 
v”siÚ_ty³
::
	`İaque_throw
(
¡d
::
	`out_of_¿nge
("TVector::pop_back"));

117 --
wv®
.
£cÚd
;

118 
Sto
::
	`™em
(
this
, 
wv®
.
£cÚd
).
	`add_wr™e
().
	`add_æags
(
pİ_b™
);

119 
	}
}

121 
ş—r
();

122 
™”©Ü
 
”a£
(™”©Ü 
pos
);

123 
™”©Ü
 
š£¹
(™”©Ü 
pos
, 
T
 
x
);

124 
»size
(
size_ty³
 
size
, 
T
 
x
 = T());

126 
nÚŒªs_»£rve
(
size_ty³
 
size
);

127 
	$nÚŒªs_push_back
(
T
 
x
) {

128 
size_ty³
& 
sz
 = 
size_
.
	`acûss
();

129 
	`as£¹
(
sz
 < 
ÿ·c™y_
);

130 ià(
sz
 =ğ
max_size_
) {

131 
	`Ãw
(
»š‹½»t_ÿ¡
<*>(&
d©a_
[
sz
].
v
)è
W
<
T
>(
¡d
::
	`move
(
x
));

132 ++
max_size_
;

134 
d©a_
[
sz
].
v
.
	`wr™e
(
¡d
::
	`move
(
x
));

135 ++
sz
;

136 
	}
}

139 
	g¡d
::
·œ
<
boŞ
, 
	gg‘_ty³
> 
	$ŒªsG‘
(
size_ty³
 
i
) const {

140 
T¿nsProxy
 
™em
 = 
Sto
::
	`™em
(
this
, 
i
);

141 ià(
™em
.
	`has_wr™e
()) {

142 ià(
™em
.
	`has_æag
(
pİ_b™
)) {

143 
out_of_¿nge
:

144 
v”siÚ_ty³
::
	`İaque_throw
(
¡d
::
	`out_of_¿nge
("TVector::transGet"));

146 ià(!
™em
.
	`has_æag
(
šdexed_b™
)) {

147 autØ
s™em
 = 
	`size_™em
();

148 
	`size_´ediÿ‹
(
s™em
).
	`ob£rve
(
	`size_šfo
(s™em).
fœ¡
);

150 
™em
.
	`add_æags
(
šdexed_b™
);

151  {
Œue
, 
™em
.
wr™e_v®ue
<
T
>()};

153 
™em
.
	`add_æags
(
šdexed_b™
);

154 autØ
»suÉ
 = 
d©a_
[
i
].
v
.
	`»ad
(
™em
, d©a_[i].
v”s
);

155 ià(!
»suÉ
.
fœ¡
) {

156 
throw
 
T¿n§ùiÚ
::
	`AbÜt
();

158 ià(
™em
.
»ad_v®ue
<
v”siÚ_ty³
>().
	`v®ue
(è& 
d—d_b™
)

159 
out_of_¿nge
;

160  
»suÉ
;

162 
	}
}

163 
g‘_ty³
 
	$ŒªsG‘_throws
(
size_ty³
 
i
) const {

164 autØ
»suÉ
 = 
	`ŒªsG‘
(
i
);

165 ià(!
»suÉ
.
fœ¡
) {

166 
throw
 
T¿n§ùiÚ
::
	`AbÜt
();

168  
»suÉ
.
£cÚd
;

169 
	}
}

170 
boŞ
 
	$ŒªsPut
(
size_ty³
 
i
, 
T
 
x
) {

171 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
i
);

172 ià(
™em
.
	`has_æag
(
pİ_b™
)

173 || (!
™em
.
	`has_»ad
(è&& !™em.
	`has_wr™e
(è&& !
	`put_š_¿nge
(™em, 
i
)))

174  
çl£
;

175 ià(
™em
.
	`has_wr™e
(è&& !™em.
	`has_æag
(
šdexed_b™
)) {

176 autØ
s™em
 = 
	`size_™em
();

177 
	`size_´ediÿ‹
(
s™em
).
	`ob£rve
(
	`size_šfo
(s™em).
fœ¡
);

179 
™em
.
	`add_wr™e
(
¡d
::
	`move
(
x
)).
	`add_æags
(
šdexed_b™
);

180  
Œue
;

181 
	}
}

182 
	$ŒªsPut_throws
(
size_ty³
 
i
, 
T
 
x
) {

183 ià(!
	`ŒªsPut
(
i
, 
x
)) {

184 
v”siÚ_ty³
::
	`İaque_throw
(
¡d
::
	`out_of_¿nge
("TVector::transPut"));

186 
	}
}

188 
size_ty³
 
	$nÚŒªs_size
() const {

189  
size_
.
	`acûss
();

190 
	}
}

191 
g‘_ty³
 
	$nÚŒªs_g‘
(
size_ty³
 
i
) const {

192 
	`as£¹
(
i
 < 
size_
.
	`acûss
());

193  
d©a_
[
i
].
v
.
	`acûss
();

194 
	}
}

195 
	$nÚŒªs_put
(
size_ty³
 
i
, cÚ¡ 
T
& 
x
) {

196 
	`as£¹
(
i
 < 
size_
.
	`acûss
());

197 
d©a_
[
i
].
v
.
	`acûss
(èğ
x
;

198 
	}
}

199 
	$nÚŒªs_put
(
size_ty³
 
i
, 
T
&& 
x
) {

200 
	`as£¹
(
i
 < 
size_
.
	`acûss
());

201 
d©a_
[
i
].
v
.
	`acûss
(èğ
¡d
::
	`move
(
x
);

202 
	}
}

205 
boŞ
 
	$check_´ediÿ‹
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
, 
boŞ
 
comm™tšg
è
ov”ride
 {

206 
T¿nsProxy
 
	`p
(
txn
, 
™em
);

207 
´ed_ty³
 
´ed
 = 
™em
.
‹m¶©e
 
´ediÿ‹_v®ue
<pred_type>();

208 
size_ty³
 
v®ue
 = 
size_
.
	`wa™_¢­shÙ
(
p
, 
size_v”s_
, 
comm™tšg
);

209  
´ed
.
	`v”ify
(
v®ue
);

210 
	}
}

211 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

212 autØ
key
 = 
™em
.
‹m¶©e
 key<
key_ty³
>();

213 ià(
key
 =ğ
size_key
) {

214 ià(!
txn
.
	`Œy_lock
(
™em
, 
size_v”s_
))

215  
çl£
;

216 
size_d–_
 = 
size_
.
	`acûss
(è- 
	`size_šfo
(
™em
).
fœ¡
;

217  
Œue
;

219 
key
 +ğ
™em
.
	`has_æag
(
šdexed_b™
è? 0 : 
size_d–_
;

220 ià(
key
 < 0)

221  
çl£
;

222  
txn
.
	`Œy_lock
(
™em
, 
d©a_
[
key
].
v”s
);

224 
	}
}

225 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

226 autØ
key
 = 
™em
.
‹m¶©e
 key<
key_ty³
>();

227 ià(
key
 =ğ
size_key
)

228  
size_v”s_
.
	`ı_check_v”siÚ
(
txn
, 
™em
);

229 ià(
™em
.
	`has_æag
(
Úlyexi¡s_b™
))

230  !(
d©a_
[
key
].
v”s
.
	`¢­shÙ
(
™em
, 
txn
è& 
d—d_b™
);

232 
	`as£¹
(
™em
.
	`has_æag
(
šdexed_b™
));

233  
d©a_
[
key
].
v”s
.
	`ı_check_v”siÚ
(
txn
, 
™em
);

235 
	}
}

236 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

237 autØ
key
 = 
™em
.
‹m¶©e
 key<
key_ty³
>();

238 ià(
key
 =ğ
size_key
) {

239 
´ed_ty³
& 
wv®
 = 
	`size_šfo
(
™em
);

240 
	`as£¹
(
wv®
.
£cÚd
 + 
size_d–_
 >= 0);

241 
size_
.
	`wr™e
(
wv®
.
£cÚd
 + 
size_d–_
);

242 
txn
.
	`£t_v”siÚ
(
size_v”s_
);

245 
key
 +ğ
™em
.
	`has_æag
(
šdexed_b™
è? 0 : 
size_d–_
;

246 ià(!
™em
.
	`has_æag
(
pİ_b™
)) {

247 
	`as£¹
(
key
 <ğ
max_size_
 && key < 
ÿ·c™y_
);

248 ià(
key
 =ğ
max_size_
) {

249 
	`Ãw
(
»š‹½»t_ÿ¡
<*>(&
d©a_
[
key
].
v
)è
W
<
T
>(
¡d
::
	`move
(
™em
.
wr™e_v®ue
<T>()));

250 ++
max_size_
;

252 
d©a_
[
key
].
v
.
	`wr™e
(
¡d
::
	`move
(
™em
.
wr™e_v®ue
<
T
>()));

254 
txn
.
	`£t_v”siÚ_uÆock
(
d©a_
[
key
].
v”s
, 
™em
, i‹m.
	`has_æag
(
pİ_b™
è? 
d—d_b™
 : 0);

255 
	}
}

256 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

257 autØ
key
 = 
™em
.
‹m¶©e
 key<
key_ty³
>();

258 ià(
key
 =ğ
size_key
)

259 
size_v”s_
.
	`ı_uÆock
(
™em
);

261 
key
 +ğ
™em
.
	`has_æag
(
šdexed_b™
è? 0 : 
size_d–_
;

262 
d©a_
[
key
].
v”s
.
	`ı_uÆock
(
™em
);

264 
	}
}

265 
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
ècÚ¡ 
ov”ride
 {

266 
w
 << "{TVeùÜ<" << 
	`ty³id
(
T
).
	`Çme
(è<< "> " << (*è
this
;

267 
key_ty³
 
key
 = 
™em
.key<key_type>();

268 ià(
key
 =ğ
size_key
) {

269 
w
 << ".siz@" << 
	`size_šfo
(
™em
).
fœ¡
;

270 ià(
™em
.
	`has_»ad
())

271 
w
 << " R" << 
™em
.
»ad_v®ue
<
v”siÚ_ty³
>();

272 ià(
™em
.
	`has_´ediÿ‹
())

273 
w
 << ' ' << 
™em
.
´ediÿ‹_v®ue
<
´ed_ty³
>();

274 ià(
™em
.
	`has_wr™e
())

275 
w
 << " =" << 
	`size_šfo
(
™em
).
£cÚd
;

277 
w
 << "[" << 
key
;

278 ià(!
™em
.
	`has_æag
(
šdexed_b™
))

279 
w
 << "?";

280 
w
 << "]";

281 ià(
™em
.
	`has_»ad
())

282 
w
 << " R" << 
™em
.
»ad_v®ue
<
v”siÚ_ty³
>();

283 ià(
™em
.
	`has_wr™e
(è&& i‹m.
	`has_æag
(
pİ_b™
))

284 
w
 << " =X";

285 ià(
™em
.
	`has_wr™e
())

286 
w
 << " =" << 
™em
.
wr™e_v®ue
<
T
>();

288 
w
 << "}";

289 
	}
}

290 
boŞ
 
	$check_nÙ_locked_h”e
(
h”e
) const {

291 ià(
size_v”s_
.
	`is_locked_h”e
(
h”e
))

292  
çl£
;

293 
size_ty³
 
max_size
 = 
max_size_
;

294 
size_ty³
 
i
 = 0; i !ğ
max_size
; ++i)

295 ià(
d©a_
[
i
].
v”s
.
	`is_locked_h”e
(
h”e
))

296  
çl£
;

297  
Œue
;

298 
	}
}

299 
	$´št
(
¡d
::
o¡»am
& 
w
) const;

301 
´iv©e
:

302 
	s–em
 {

303 
v”siÚ_ty³
 
v”s
;

304 
W
<
T
> 
v
;

305 
	}
};

306 
–em
* 
	gd©a_
;

307 
	gW
<
	gsize_ty³
> 
	gsize_
;

308 
v”siÚ_ty³
 
	gsize_v”s_
;

309 
size_ty³
 
	gsize_d–_
;

310 
size_ty³
 
	gmax_size_
;

311 
size_ty³
 
	gÿ·c™y_
;

314 
T¿nsProxy
 
	$size_™em
() const {

315 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
size_key
);

316 ià(!
™em
.
	`has_´ediÿ‹
()) {

317 
™em
.
	`£t_´ediÿ‹
(
´ed_ty³
::
	`uncÚ¡¿šed
());

318 
size_ty³
 
sz
 = 
size_
.
	`¢­shÙ
(
™em
, 
size_v”s_
);

319 
™em
.
‹m¶©e
 
xwr™e_v®ue
<
´ed_ty³
>(èğ´ed_ty³{
sz
, sz};

321  
™em
;

322 
	}
}

323 
	g´ed_ty³
& 
	$size_´ediÿ‹
(
T¿nsProxy
 
s™em
) {

324  
s™em
.
‹m¶©e
 
´ediÿ‹_v®ue
<
´ed_ty³
>();

325 
	}
}

326 
	g´ed_ty³
& 
	$size_´ediÿ‹
(
T¿nsI‹m
* 
s™em
) {

327  
s™em
->
‹m¶©e
 
´ediÿ‹_v®ue
<
´ed_ty³
>();

328 
	}
}

329 
size_ty³
 
	$Üigš®_size
(cÚ¡ 
T¿nsI‹m
* 
s™em
) {

330  
s™em
->
‹m¶©e
 
xwr™e_v®ue
<
´ed_ty³
>().
fœ¡
;

331 
	}
}

332 
	g´ed_ty³
& 
	$size_´ediÿ‹
() const {

333  
	`size_´ediÿ‹
(
	`size_™em
());

334 
	}
}

335 
	g´ed_ty³
& 
	$size_šfo
(
T¿nsProxy
 
s™em
) {

336  
s™em
.
‹m¶©e
 
xwr™e_v®ue
<
´ed_ty³
>();

337 
	}
}

338 
	g´ed_ty³
& 
	$size_šfo
(
T¿nsI‹m
& 
s™em
) {

339  
s™em
.
‹m¶©e
 
xwr™e_v®ue
<
´ed_ty³
>();

340 
	}
}

341 cÚ¡ 
	g´ed_ty³
& 
	$size_šfo
(cÚ¡ 
T¿nsI‹m
& 
s™em
) {

342  
s™em
.
‹m¶©e
 
xwr™e_v®ue
<
´ed_ty³
>();

343 
	}
}

344 
	g´ed_ty³
& 
	$size_šfo
() const {

345  
	`size_šfo
(
	`size_™em
());

346 
	}
}

348 
	g¡d
::
·œ
<
boŞ
, 
	gg‘_ty³
> 
	$ŒªsG‘
(
size_ty³
 
i
, 
T¿nsProxy
 
™em
) const {

349 ià(
™em
.
	`has_wr™e
())

350  {
Œue
, 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>()};

352  
d©a_
[
i
].
v
.
	`»ad
(
™em
, d©a_[i].
v”s
);

353 
	}
}

354 
g‘_ty³
 
	$ŒªsG‘_throws
(
size_ty³
 
i
, 
T¿nsProxy
 
™em
) const {

355 autØ
»suÉ
 = 
	`ŒªsG‘
(
i
, 
™em
);

356 ià(!
»suÉ
.
fœ¡
)

357 
Sto
::
	`abÜt
();

358  
»suÉ
.
£cÚd
;

359 
	}
}

360 
boŞ
 
	$put_š_¿nge
(
T¿nsProxy
& 
™em
, 
size_ty³
 
i
) const {

361 ià(
i
 >ğ
ÿ·c™y_
)

362  
çl£
;

363 
™em
.
	`ob£rve
(
d©a_
[
i
].
v”s
);

364 
™em
.
	`add_æags
(
Úlyexi¡s_b™
);

365  !(
™em
.
»ad_v®ue
<
v”siÚ_ty³
>().
	`v®ue
(è& 
d—d_b™
);

366 
	}
}

368 
ä›nd
 
şass
 
	g™”©Ü
;

369 
ä›nd
 
şass
 
	gcÚ¡_™”©Ü
;

373 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

374 
şass
 
	gTVeùÜ
<
	gT
, 
	gW
>::
cÚ¡_™”©Ü
 : 
public
 
¡d
::
™”©Ü
<¡d::
¿ndom_acûss_™”©Ü_g
, T> {

375 
	gpublic
:

376 
TVeùÜ
<
	tT
, 
	tW
> 
	tveùÜ_ty³
;

377 
ty³Çme
 
	tveùÜ_ty³
::
	tsize_ty³
 size_type;

378 
ty³Çme
 
	tveùÜ_ty³
::
	tdifã»nû_ty³
 difference_type;

379 
ty³Çme
 
	tveùÜ_ty³
::
	t´ed_ty³
…red_type;

380 
ty³Çme
 
	tveùÜ_ty³
::
	tdifã»nû_´oxy
 difference_proxy;

382 
cÚ¡_™”©Ü
()

383 : 
a_
() {

385 
cÚ¡_™”©Ü
(cÚ¡ 
TVeùÜ
<
T
, 
W
>* 
a
, 
size_ty³
 
i
, 
T¿nsI‹m
* 
e™em
)

386 : 
a_
(
cÚ¡_ÿ¡
<
veùÜ_ty³
*>(
a
)), 
i_
(
i
), 
e™em_
(
e™em
) {

389 
ty³Çme
 
	gveùÜ_ty³
::
cÚ¡_´oxy_ty³
 
İ”©Ü
*() const {

390  
veùÜ_ty³
::
cÚ¡_´oxy_ty³
(
a_
, 
i_
);

393 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

394 ià(
a_
 !ğ
x
.a_)

395  
çl£
;

396 ià(
difã»Á_’d
(
x
)) {

397 
difã»nû_ty³
 
	gd
 = 
e™em_
 ? 
x
.
i_
 - i_ : i_ - x.i_;

398 
T¿nsI‹m
* 
	ge™em
 = 
e™em_
 ?ƒ™em_ : 
x
.eitem_;

399 
size_ty³
 
	gsz
 = 
a_
->
Üigš®_size
(
e™em
);

400 
	ga_
->
size_´ediÿ‹
(
e™em
).
ob£rve_‹¡_eq
(
sz
, 
d
 + sz);

402  
	gi_
 =ğ
x
.
i_
;

404 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

405  !(*
this
 =ğ
x
);

407 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

408 
as£¹
(
a_
 =ğ
x
.a_);

409 ià(
	ge™em_
 && !
	gx
.eitem_) {

410 
size_ty³
 
	gsz
 = 
a_
->
Üigš®_size
(
e™em_
);

411 
	ga_
->
size_´ediÿ‹
(
e™em_
).
ob£rve_É
(
x
.
i_
 - i_ + 
sz
, i_ < x.i_);

412 } ià(
	gx
.
	ge™em_
 && !eitem_) {

413 
size_ty³
 
	gsz
 = 
a_
->
Üigš®_size
(
x
.
e™em_
);

414 
	ga_
->
size_´ediÿ‹
(
x
.
e™em_
).
ob£rve_gt
(
i_
 - x.i_ + 
sz
, i_ < x.i_);

416  
	gi_
 < 
	gx
.i_;

418 
boŞ
 
	gİ”©Ü
<=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

419 
as£¹
(
a_
 =ğ
x
.a_);

420 ià(
	ge™em_
 && !
	gx
.eitem_) {

421 
size_ty³
 
	gsz
 = 
a_
->
Üigš®_size
(
e™em_
);

422 
	ga_
->
size_´ediÿ‹
(
e™em_
).
ob£rve_Ë
(
x
.
i_
 - i_ + 
sz
, i_ <= x.i_);

423 } ià(
	gx
.
	ge™em_
 && !eitem_) {

424 
size_ty³
 
	gsz
 = 
a_
->
Üigš®_size
(
x
.
e™em_
);

425 
	ga_
->
size_´ediÿ‹
(
x
.
e™em_
).
ob£rve_ge
(
i_
 - x.i_ + 
sz
, i_ <= x.i_);

427  
	gi_
 <ğ
x
.
i_
;

429 
boŞ
 
	gİ”©Ü
>(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

430  
	gx
 < *
	gthis
;

432 
boŞ
 
	gİ”©Ü
>=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

433  
x
 <ğ*
this
;

436 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
+=(
difã»nû_ty³
 
d–
) {

437 
i_
 +ğ
d–
;

438  *
	gthis
;

440 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
-=(
difã»nû_ty³
 
d–
) {

441 
i_
 +ğ
d–
;

442  *
	gthis
;

444 
cÚ¡_™”©Ü
 
	gİ”©Ü
+(
difã»nû_ty³
 
	gd–
) const {

445  
cÚ¡_™”©Ü
(
a_
, 
i_
 + 
d–
, 
e™em_
);

447 
cÚ¡_™”©Ü
 
	gİ”©Ü
-(
difã»nû_ty³
 
	gd–
) const {

448  
cÚ¡_™”©Ü
(
a_
, 
i_
 - 
d–
, 
e™em_
);

450 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
++() {

451 ++
	gi_
;

452  *
	gthis
;

454 
cÚ¡_™”©Ü
 
	gİ”©Ü
++() {

455 ++
	gi_
;

456  
cÚ¡_™”©Ü
(
a_
, 
i_
 - 1, 
e™em_
);

458 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
--() {

459 --
	gi_
;

460  *
	gthis
;

462 
cÚ¡_™”©Ü
 
	gİ”©Ü
--() {

463 --
	gi_
;

464  
cÚ¡_™”©Ü
(
a_
, 
i_
 + 1, 
e™em_
);

467 
šlše
 
difã»nû_´oxy
 
	gİ”©Ü
-(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const;

469 
	g´Ùeùed
:

470 
veùÜ_ty³
* 
a_
;

471 
size_ty³
 
	gi_
;

472 
T¿nsI‹m
* 
	ge™em_
;

474 
boŞ
 
difã»Á_’d
(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

475  
	ge™em_
 !ğ
x
.
e™em_
;

477 
ä›nd
 
şass
 
	gTVeùÜ
<
	gT
, 
	gW
>;

480 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

481 
şass
 
	gTVeùÜ
<
	gT
, 
	gW
>::
™”©Ü
 : 
public
 
cÚ¡_™”©Ü
 {

482 
public
:

483 
TVeùÜ
<
	tT
, 
	tW
> 
	tveùÜ_ty³
;

484 
ty³Çme
 
	tveùÜ_ty³
::
	tsize_ty³
 size_type;

485 
ty³Çme
 
	tveùÜ_ty³
::
	tdifã»nû_ty³
 difference_type;

487 
™”©Ü
() {

489 
™”©Ü
(cÚ¡ 
TVeùÜ
<
T
, 
W
>* 
a
, 
size_ty³
 
i
, 
T¿nsI‹m
* 
e™em
)

490 : 
cÚ¡_™”©Ü
(
a
, 
i
, 
e™em
) {

493 
ty³Çme
 
	gveùÜ_ty³
::
´oxy_ty³
 
İ”©Ü
*() const {

494  
veùÜ_ty³
::
´oxy_ty³
(
this
->
a_
,his->
i_
);

497 
	g™”©Ü
& 
	gİ”©Ü
+=(
difã»nû_ty³
 
d–
) {

498 
this
->
i_
 +ğ
d–
;

499  *
	gthis
;

501 
	g™”©Ü
& 
	gİ”©Ü
-=(
difã»nû_ty³
 
d–
) {

502 
this
->
i_
 +ğ
d–
;

503  *
	gthis
;

505 
™”©Ü
 
	gİ”©Ü
+(
difã»nû_ty³
 
	gd–
) const {

506  
™”©Ü
(
this
->
a_
,his->
i_
 + 
d–
,his->
e™em_
);

508 
™”©Ü
 
	gİ”©Ü
-(
difã»nû_ty³
 
	gd–
) const {

509  
™”©Ü
(
this
->
a_
,his->
i_
 - 
d–
,his->
e™em_
);

511 
	g™”©Ü
& 
	gİ”©Ü
++() {

512 ++
	gthis
->
	gi_
;

513  *
	gthis
;

515 
™”©Ü
 
	gİ”©Ü
++() {

516 ++
	gthis
->
	gi_
;

517  
™”©Ü
(
this
->
a_
,his->
i_
 - 1,his->
e™em_
);

519 
	g™”©Ü
& 
	gİ”©Ü
--() {

520 --
	gthis
->
	gi_
;

521  *
	gthis
;

523 
™”©Ü
 
	gİ”©Ü
--() {

524 --
	gthis
->
	gi_
;

525  
™”©Ü
(
this
->
a_
,his->
i_
 + 1,his->
e™em_
);

528 
difã»nû_´oxy
 
	gİ”©Ü
-(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

529  
	gcÚ¡_™”©Ü
::
İ”©Ü
-(
x
);

532 
	g´iv©e
:

533 
ä›nd
 
şass
 
TVeùÜ
<
T
, 
	gW
>;

537 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

538 
šlše
‡utØ
	gTVeùÜ
<
	gT
, 
	gW
>::
begš
(è-> 
™”©Ü
 {

539  
™”©Ü
(
this
, 0, 0);

542 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

543 
šlše
‡utØ
	gTVeùÜ
<
	gT
, 
	gW
>::
’d
(è-> 
™”©Ü
 {

544 
T¿nsProxy
 
s™em
 = 
size_™em
();

545  
™”©Ü
(
this
, 
size_šfo
(
s™em
).
£cÚd
, &s™em.
™em
());

548 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

549 
šlše
‡utØ
	gTVeùÜ
<
	gT
, 
	gW
>::
	$cbegš
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

550  
	`cÚ¡_™”©Ü
(
this
, 0, 0);

551 
	}
}

553 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

554 
šlše
‡utØ
	gTVeùÜ
<
	gT
, 
	gW
>::
	$ûnd
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

555 
T¿nsProxy
 
s™em
 = 
	`size_™em
();

556  
	`cÚ¡_™”©Ü
(
this
, 
	`size_šfo
(
s™em
).
£cÚd
, &s™em.
	`™em
());

557 
	}
}

559 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

560 
šlše
‡utØ
	gTVeùÜ
<
	gT
, 
	gW
>::
	$begš
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

561  
	`cbegš
();

562 
	}
}

564 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

565 
šlše
‡utØ
	gTVeùÜ
<
	gT
, 
	gW
>::
	$’d
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

566  
	`ûnd
();

567 
	}
}

570 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

571 
šlše
‡utØ
	gTVeùÜ
<
	gT
, 
	gW
>::
cÚ¡_™”©Ü
::
İ”©Ü
-(cÚ¡ cÚ¡_™”©Ü& 
x
ècÚ¡ -> 
difã»nû_´oxy
 {

572 
as£¹
(
a_
 =ğ
x
.a_);

573 ià(
difã»Á_’d
(
x
)) {

574 
T¿nsI‹m
* 
	ge™em
 = 
e™em_
 ?ƒ™em_ : 
x
.eitem_;

575 
size_ty³
 
	gsz
 = 
a_
->
Üigš®_size
(
e™em
);

576  
difã»nû_´oxy
(&
a_
->
size_´ediÿ‹
(
e™em
), 
sz
, 
i_
 - 
x
.i_ - sz);

578  
difã»nû_´oxy
(
nuÎ±r
, 0, 
i_
 - 
x
.i_);

582 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

583 
	gTVeùÜ
<
	gT
, 
	gW
>::
	$ş—r
() {

584 autØ
s™em
 = 
	`size_™em
().
	`add_wr™e
();

585 
´ed_ty³
& 
wv®
 = 
	`size_šfo
(
s™em
);

586 
size_ty³
 
i
 = 0; i !ğ
wv®
.
£cÚd
; ++i)

587 
Sto
::
	`™em
(
this
, 
i
).
	`add_wr™e
().
	`add_æags
(
pİ_b™
);

588 
wv®
.
£cÚd
 = 0;

589 
	}
}

591 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

592 autØ
	gTVeùÜ
<
	gT
, 
	gW
>::
”a£
(
™”©Ü
 
pos
) -> iterator {

593 autØ
s™em
 = 
size_™em
().
add_wr™e
();

594 
	g´ed_ty³
& 
	gwv®
 = 
size_šfo
(
s™em
);

595 ià(
	gpos
.
	gi_
 >ğ
wv®
.
£cÚd
)

596 
v”siÚ_ty³
::
İaque_throw
(
¡d
::
out_of_¿nge
("TVector::erase"));

597 
size_´ediÿ‹
(
s™em
).
ob£rve
(
wv®
.
fœ¡
);

598 --
	gwv®
.
	g£cÚd
;

599 
T¿nsProxy
 
	g™em
 = 
Sto
::
™em
(
this
, 
pos
.
i_
).
add_æags
(
šdexed_b™
);

600 
size_ty³
 
	gi
 = 
pos
.
i_
; i !ğ
wv®
.
£cÚd
; ++i) {

601 
T¿nsProxy
 
	gÃxt_™em
 = 
Sto
::
™em
(
this
, 
i
 + 1).
add_æags
(
šdexed_b™
);

602 
	g™em
.
add_wr™e
(
ŒªsG‘_throws
(
i
 + 1, 
Ãxt_™em
));

603 
	g™em
 = 
Ãxt_™em
;

605 
	g™em
.
add_wr™e
().
add_æags
(
pİ_b™
);

606  
	gpos
;

609 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

610 autØ
	gTVeùÜ
<
	gT
, 
	gW
>::
š£¹
(
™”©Ü
 
pos
, 
T
 
v®ue
è-> 
	g™”©Ü
 {

611 autØ
	gs™em
 = 
size_™em
().
add_wr™e
();

612 
	g´ed_ty³
& 
	gwv®
 = 
size_šfo
(
s™em
);

613 ià(
	gpos
.
	gi_
 > 
	gwv®
.
	g£cÚd
)

614 
	gv”siÚ_ty³
::
İaque_throw
(
¡d
::
out_of_¿nge
("TVector::insert"));

615 
size_´ediÿ‹
(
s™em
).
ob£rve
(
wv®
.
fœ¡
);

616 ++
	gwv®
.
	g£cÚd
;

617 
T¿nsProxy
 
	g™em
 = 
Sto
::
™em
(
this
, 
wv®
.
£cÚd
 - 1).
ş—r_wr™e
().
ş—r_æags
(
pİ_b™
).
add_æags
(
šdexed_b™
);

618 
size_ty³
 
	gi
 = 
wv®
.
£cÚd
 - 1; i !ğ
pos
.
i_
; --i) {

619 
T¿nsProxy
 
	gÃxt_™em
 = 
Sto
::
™em
(
this
, 
i
 - 1).
add_æags
(
šdexed_b™
);

620 
	g™em
.
add_wr™e
(
ŒªsG‘_throws
(
i
 - 1, 
Ãxt_™em
));

621 
	g™em
 = 
Ãxt_™em
;

623 
	g™em
.
add_wr™e
(
¡d
::
move
(
v®ue
));

624  
	gpos
;

627 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

628 
	gTVeùÜ
<
	gT
, 
	gW
>::
	$»size
(
size_ty³
 
size
, 
T
 
v®ue
) {

629 autØ
s™em
 = 
	`size_™em
().
	`add_wr™e
();

630 
´ed_ty³
& 
wv®
 = 
	`size_šfo
(
s™em
);

631 
	`size_´ediÿ‹
(
s™em
).
	`ob£rve
(
wv®
.
fœ¡
);

632 
size_ty³
 
Şd_size
 = 
wv®
.
£cÚd
;

633 
wv®
.
£cÚd
 = 
size
;

634 ; 
Şd_size
 > 
wv®
.
£cÚd
; --old_size)

635 
Sto
::
	`™em
(
this
, 
Şd_size
 - 1).
	`add_wr™e
().
	`add_æags
(
šdexed_b™
 | 
pİ_b™
);

636 ; 
Şd_size
 < 
wv®
.
£cÚd
; ++old_size)

637 
Sto
::
	`™em
(
this
, 
Şd_size
).
	`ş—r_wr™e
().
	`ş—r_æags
(
pİ_b™
).
	`add_æags
(
šdexed_b™
)

638 .
	`add_wr™e
(
v®ue
);

639 
	}
}

641 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

642 
	gTVeùÜ
<
	gT
, 
	gW
>::
	$nÚŒªs_»£rve
(
size_ty³
 
size
) {

643 
size_ty³
 
Ãw_ÿ·c™y
 = 
ÿ·c™y_
;

644 
size
 > 
Ãw_ÿ·c™y
)

645 
Ãw_ÿ·c™y
 <<= 1;

646 ià(
Ãw_ÿ·c™y
 > 
ÿ·c™y_
) {

647 
–em
* 
Ãw_d©a
 = 
»š‹½»t_ÿ¡
<–em*>(
Ãw
 [ÓËmè* 
Ãw_ÿ·c™y
]);

648 
	`memıy
(
Ãw_d©a
, 
d©a_
, (
–em
è* 
ÿ·c™y_
);

649 
size_ty³
 
i
 = 
ÿ·c™y_
; i !ğ
Ãw_ÿ·c™y
; ++i)

650 
Ãw_d©a
[
i
].
v”s
 = 
d—d_b™
;

651 
T¿n§ùiÚ
::
	`rcu_d–‘e_¬¿y
(
»š‹½»t_ÿ¡
<*>(
d©a_
));

652 
d©a_
 = 
Ãw_d©a
;

653 
ÿ·c™y_
 = 
Ãw_ÿ·c™y
;

655 
	}
}

657 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

658 
	gTVeùÜ
<
	gT
, 
	gW
>::
	$´št
(
¡d
::
o¡»am
& 
w
) const {

659 
size_ty³
 
sz
 = 
size_
.
	`acûss
();

660 
w
 << "TVeùÜ<" << 
	`ty³id
(
T
).
	`Çme
(è<< ">{" << (*è
this


661 << "size=" << 
sz
 << '@' << 
size_v”s_
 << " [";

662 
size_ty³
 
i
 = 0; i < 
sz
; ++i) {

663 ià(
i
)

664 
w
 << ", ";

665 ià(
i
 >= 10)

666 
w
 << '[' << 
i
 << ']';

667 
w
 << 
d©a_
[
i
].
v
.
	`acûss
(è<< '@' << d©a_[i].
v”s
;

669 
w
 << "]";

670 
size_ty³
 
i
 = 
sz
; i < 
max_size_
 && i < sz + 10; ++i) {

671 
w
 << ", ";

672 ià(
i
 >= 10)

673 
w
 << '[' << 
i
 << ']';

674 
w
 << '@' << 
d©a_
[
i
].
v”s
;

676 ià(
sz
 + 10 < 
max_size_
)

677 
w
 << "...";

678 
w
 << "}";

679 
	}
}

681 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
> 
şass
 
	gW
>

682 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	gTVeùÜ
<
	gT
, 
	gW
>& 
	gv
) {

683 
	gv
.
´št
(
w
);

684  
	gw
;

	@datatype/TVector_nopred.hh

1 #´agm¨
Úû


2 
	~"TW¿µed.hh
"

3 
	~"TA¼ayProxy.hh
"

4 
	~"TIÁP»diÿ‹.hh
"

6 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
 = 
TO·queW¿µed
>

7 şas 
	cTVeùÜ_nİ»d
 : 
public
 
TObjeù
 {

8 
public
:

9 
usšg
 
size_ty³
 = ;

10 
usšg
 
	mdifã»nû_ty³
 = ;

11 
ty³Çme
 
	tW
<
	tT
>::
	tv”siÚ_ty³
 version_type;

12 
	m´iv©e
:

13 #ifdeà
TVECTOR_DEFAULT_CAPACITY


14 
cÚ¡ex´
 
size_ty³
 
deçuÉ_ÿ·c™y
 = 
TVECTOR_DEFAULT_CAPACITY
;

16 
cÚ¡ex´
 
size_ty³
 
	mdeçuÉ_ÿ·c™y
 = 128;

18 
usšg
 
	m´ed_ty³
 = 
TIÁRªge
<
size_ty³
>;

19 
usšg
 
	mkey_ty³
 = ;

20 
cÚ¡ex´
 
key_ty³
 
	msize_key
 = -1;

30 
cÚ¡ex´
 
	mT¿nsI‹m
::
æags_ty³
 
pİ_b™
 = 
T¿nsI‹m
::
u£r0_b™
;

31 
cÚ¡ex´
 
	mT¿nsI‹m
::
æags_ty³
 
Úlyexi¡s_b™
 = 
pİ_b™
 << 1;

32 
cÚ¡ex´
 
ty³Çme
 
	mv”siÚ_ty³
::
ty³
 
d—d_b™
 = 
T¿n§ùiÚTid
::
u£r_b™
;

33 
	mpublic
:

34 
şass
 
™”©Ü
;

35 
şass
 
	mcÚ¡_™”©Ü
;

36 
T
 
	tv®ue_ty³
;

37 
ty³Çme
 
	tW
<
	tT
>::
	t»ad_ty³
 
	tg‘_ty³
;

38 
	mTCÚ¡A¼ayProxy
<
	tTVeùÜ_nİ»d
<
	tT
, 
	tW
> > 
	tcÚ¡_´oxy_ty³
;

39 
	mTA¼ayProxy
<
	tTVeùÜ_nİ»d
<
	tT
, 
	tW
> > 
	t´oxy_ty³
;

40 
´oxy_ty³
 
	t»ã»nû
;

41 
cÚ¡_´oxy_ty³
 
	tcÚ¡_»ã»nû
;

43 
	$TVeùÜ_nİ»d
()

44 : 
	`size_
(0), 
	`max_size_
(0), 
	$ÿ·c™y_
(
deçuÉ_ÿ·c™y
) {

45 
d©a_
 = 
»š‹½»t_ÿ¡
<
–em
*>(
Ãw
 [ÓËmè* 
ÿ·c™y_
]);

46 
size_ty³
 
i
 = 0; i !ğ
ÿ·c™y_
; ++i)

47 
d©a_
[
i
].
v”s
 = 
	`v”siÚ_ty³
(
d—d_b™
);

49 ~
	$TVeùÜ_nİ»d
() {

50 
usšg
 
WT
 = 
W
<
T
>;

51 
size_ty³
 
i
 = 0; i !ğ
max_size_
; ++i)

52 
d©a_
[
i
].
v
.~
	`WT
();

53 
d–‘e
[] 
»š‹½»t_ÿ¡
<*>(
d©a_
);

54 
	}
}

56 
size_ty³
 
	$size
() const {

57  
	`size_šfo
().
£cÚd
;

58 
	}
}

59 
boŞ
 
	$em±y
() const {

60  
	`size
() != 0;

61 
	}
}

63 
cÚ¡_´oxy_ty³
 
	gİ”©Ü
[](
size_ty³
 
	gi
) const {

64  
cÚ¡_´oxy_ty³
(
this
, 
i
);

66 
´oxy_ty³
 
	gİ”©Ü
[](
size_ty³
 
	gi
) {

67  
´oxy_ty³
(
this
, 
i
);

69 
cÚ¡_´oxy_ty³
 
	$äÚt
() const {

70  
	`cÚ¡_´oxy_ty³
(
this
, 0);

71 
	}
}

72 
´oxy_ty³
 
	$äÚt
() {

73  
	`´oxy_ty³
(
this
, 0);

74 
	}
}

75 
cÚ¡_´oxy_ty³
 
	$back
() const {

76 auto& 
sšfo
 = 
	`size_šfo
();

77 ià(!
sšfo
.
£cÚd
)

78 
v”siÚ_ty³
::
	`İaque_throw
(
¡d
::
	`out_of_¿nge
("TVector_nopred::back"));

79  
	`cÚ¡_´oxy_ty³
(
this
, 
sšfo
.
£cÚd
 - 1);

80 
	}
}

81 
´oxy_ty³
 
	$back
() {

82 auto& 
sšfo
 = 
	`size_šfo
();

83 ià(!
sšfo
.
£cÚd
)

84 
v”siÚ_ty³
::
	`İaque_throw
(
¡d
::
	`out_of_¿nge
("TVector_nopred::back"));

85  
	`´oxy_ty³
(
this
, 
sšfo
.
£cÚd
 - 1);

86 
	}
}

88 
šlše
 
™”©Ü
 
begš
();

89 
šlše
 
™”©Ü
 
’d
();

90 
šlše
 
cÚ¡_™”©Ü
 
	$cbegš
() const;

91 
šlše
 
cÚ¡_™”©Ü
 
	$ûnd
() const;

92 
šlše
 
cÚ¡_™”©Ü
 
	$begš
() const;

93 
šlše
 
cÚ¡_™”©Ü
 
	$’d
() const;

95 
	$push_back
(
T
 
x
) {

96 autØ
s™em
 = 
	`size_™em
().
	`add_wr™e
();

97 
´ed_ty³
& 
wv®
 = 
s™em
.
‹m¶©e
 
xwr™e_v®ue
<pred_type>();

98 ++
wv®
.
£cÚd
;

99 
Sto
::
	`™em
(
this
, 
wv®
.
£cÚd
 - 1).
	`ş—r_wr™e
().
	`ş—r_æags
(
pİ_b™
)

100 .
	`add_wr™e
(
¡d
::
	`move
(
x
));

101 
	}
}

102 
	$pİ_back
() {

103 autØ
s™em
 = 
	`size_™em
().
	`add_wr™e
();

104 
´ed_ty³
& 
wv®
 = 
	`size_šfo
(
s™em
);

105 ià(!
wv®
.
£cÚd
)

106 
v”siÚ_ty³
::
	`İaque_throw
(
¡d
::
	`out_of_¿nge
("TVector_nopred::pop_back"));

107 --
wv®
.
£cÚd
;

108 
Sto
::
	`™em
(
this
, 
wv®
.
£cÚd
).
	`add_wr™e
().
	`add_æags
(
pİ_b™
);

109 
	}
}

111 
ş—r
();

112 
™”©Ü
 
”a£
(™”©Ü 
pos
);

113 
™”©Ü
 
š£¹
(™”©Ü 
pos
, 
T
 
x
);

114 
»size
(
size_ty³
 
size
, 
T
 
x
 = T());

116 
nÚŒªs_»£rve
(
size_ty³
 
size
);

117 
	$nÚŒªs_push_back
(
T
 
x
) {

118 
size_ty³
& 
sz
 = 
size_
.
	`acûss
();

119 
	`as£¹
(
sz
 < 
ÿ·c™y_
);

120 ià(
sz
 =ğ
max_size_
) {

121 
	`Ãw
(
»š‹½»t_ÿ¡
<*>(&
d©a_
[
sz
].
v
)è
W
<
T
>(
¡d
::
	`move
(
x
));

122 ++
max_size_
;

124 
d©a_
[
sz
].
v
.
	`wr™e
(
¡d
::
	`move
(
x
));

125 ++
sz
;

126 
	}
}

129 
	g¡d
::
·œ
<
boŞ
, 
	gg‘_ty³
> 
	$ŒªsG‘
(
size_ty³
 
i
) const {

130 
T¿nsProxy
 
™em
 = 
Sto
::
	`™em
(
this
, 
i
);

131 ià(
™em
.
	`has_wr™e
()) {

132 ià(
™em
.
	`has_æag
(
pİ_b™
)) {

133 
out_of_¿nge
:

134 
v”siÚ_ty³
::
	`İaque_throw
(
¡d
::
	`out_of_¿nge
("TVector_nopred::transGet"));

136  {
Œue
, 
™em
.
wr™e_v®ue
<
T
>()};

138 autØ
»suÉ
 = 
d©a_
[
i
].
v
.
	`»ad
(
™em
, d©a_[i].
v”s
);

139 ià(!
»suÉ
.
fœ¡
) {

140  
»suÉ
;

142 ià(
™em
.
»ad_v®ue
<
v”siÚ_ty³
>().
	`v®ue
(è& 
d—d_b™
)

143 
out_of_¿nge
;

144  
»suÉ
;

146 
	}
}

147 
g‘_ty³
 
	$ŒªsG‘_throws
(
size_ty³
 
i
) const {

148 autØ
»suÉ
 = 
	`ŒªsG‘
(
i
);

149 ià(!
»suÉ
.
fœ¡
) {

150 
Sto
::
	`abÜt
();

152  
»suÉ
.
£cÚd
;

153 
	}
}

154 
boŞ
 
	$ŒªsPut
(
size_ty³
 
i
, 
T
 
x
) {

155 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
i
);

156 ià(
™em
.
	`has_æag
(
pİ_b™
)

157 || (!
™em
.
	`has_»ad
(è&& !™em.
	`has_wr™e
(è&& !
	`put_š_¿nge
(™em, 
i
)))

158  
çl£
;

159 
™em
.
	`add_wr™e
(
¡d
::
	`move
(
x
));

160  
Œue
;

161 
	}
}

162 
	$ŒªsPut_throws
(
size_ty³
 
i
, 
T
 
x
) {

163 ià(!
	`ŒªsPut
(
i
, 
x
)) {

164 
v”siÚ_ty³
::
	`İaque_throw
(
¡d
::
	`out_of_¿nge
("TVector_nopred::transPut"));

166 
	}
}

168 
size_ty³
 
	$nÚŒªs_size
() const {

169  
size_
.
	`acûss
();

170 
	}
}

171 
g‘_ty³
 
	$nÚŒªs_g‘
(
size_ty³
 
i
) const {

172 
	`as£¹
(
i
 < 
size_
.
	`acûss
());

173  
d©a_
[
i
].
v
.
	`acûss
();

174 
	}
}

175 
	$nÚŒªs_put
(
size_ty³
 
i
, cÚ¡ 
T
& 
x
) {

176 
	`as£¹
(
i
 < 
size_
.
	`acûss
());

177 
d©a_
[
i
].
v
.
	`acûss
(èğ
x
;

178 
	}
}

179 
	$nÚŒªs_put
(
size_ty³
 
i
, 
T
&& 
x
) {

180 
	`as£¹
(
i
 < 
size_
.
	`acûss
());

181 
d©a_
[
i
].
v
.
	`acûss
(èğ
¡d
::
	`move
(
x
);

182 
	}
}

185 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

186 autØ
key
 = 
™em
.
‹m¶©e
 key<
key_ty³
>();

187 ià(
key
 =ğ
size_key
)

188  
txn
.
	`Œy_lock
(
™em
, 
size_v”s_
);

190  
txn
.
	`Œy_lock
(
™em
, 
d©a_
[
key
].
v”s
);

191 
	}
}

192 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

193 autØ
key
 = 
™em
.
‹m¶©e
 key<
key_ty³
>();

194 ià(
key
 =ğ
size_key
)

195  
size_v”s_
.
	`ı_check_v”siÚ
(
txn
, 
™em
);

196 ià(
™em
.
	`has_æag
(
Úlyexi¡s_b™
))

197  !(
d©a_
[
key
].
v”s
.
	`¢­shÙ
(
™em
, 
txn
è& 
d—d_b™
);

199  
d©a_
[
key
].
v”s
.
	`ı_check_v”siÚ
(
txn
, 
™em
);

200 
	}
}

201 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

202 autØ
key
 = 
™em
.
‹m¶©e
 key<
key_ty³
>();

203 ià(
key
 =ğ
size_key
) {

204 
´ed_ty³
& 
wv®
 = 
	`size_šfo
(
™em
);

205 
size_
.
	`wr™e
(
wv®
.
£cÚd
);

206 
txn
.
	`£t_v”siÚ
(
size_v”s_
);

209 ià(!
™em
.
	`has_æag
(
pİ_b™
)) {

210 ià(
key
 =ğ
max_size_
) {

211 
	`Ãw
(
»š‹½»t_ÿ¡
<*>(&
d©a_
[
key
].
v
)è
W
<
T
>(
¡d
::
	`move
(
™em
.
wr™e_v®ue
<T>()));

212 ++
max_size_
;

214 
d©a_
[
key
].
v
.
	`wr™e
(
¡d
::
	`move
(
™em
.
wr™e_v®ue
<
T
>()));

216 
txn
.
	`£t_v”siÚ_uÆock
(
d©a_
[
key
].
v”s
, 
™em
, i‹m.
	`has_æag
(
pİ_b™
è? 
d—d_b™
 : 0);

217 
	}
}

218 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

219 autØ
key
 = 
™em
.
‹m¶©e
 key<
key_ty³
>();

220 ià(
key
 =ğ
size_key
)

221 
size_v”s_
.
	`ı_uÆock
(
™em
);

223 
d©a_
[
key
].
v”s
.
	`ı_uÆock
(
™em
);

224 
	}
}

225 
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
ècÚ¡ 
ov”ride
 {

226 
w
 << "{TVeùÜ_nİ»d<" << 
	`ty³id
(
T
).
	`Çme
(è<< "> " << (*è
this
;

227 
key_ty³
 
key
 = 
™em
.key<key_type>();

228 ià(
key
 =ğ
size_key
) {

229 
w
 << ".siz@" << 
	`size_šfo
(
™em
).
fœ¡
;

230 ià(
™em
.
	`has_»ad
())

231 
w
 << " R" << 
™em
.
»ad_v®ue
<
v”siÚ_ty³
>();

232 ià(
™em
.
	`has_wr™e
())

233 
w
 << " =" << 
	`size_šfo
(
™em
).
£cÚd
;

235 
w
 << "[" << 
key
 << "]";

236 ià(
™em
.
	`has_»ad
())

237 
w
 << " R" << 
™em
.
»ad_v®ue
<
v”siÚ_ty³
>();

238 ià(
™em
.
	`has_wr™e
(è&& i‹m.
	`has_æag
(
pİ_b™
))

239 
w
 << " =X";

240 ià(
™em
.
	`has_wr™e
())

241 
w
 << " =" << 
™em
.
wr™e_v®ue
<
T
>();

243 
w
 << "}";

244 
	}
}

245 
boŞ
 
	$check_nÙ_locked_h”e
(
h”e
) const {

246 ià(
size_v”s_
.
	`is_locked_h”e
(
h”e
))

247  
çl£
;

248 
size_ty³
 
max_size
 = 
max_size_
;

249 
size_ty³
 
i
 = 0; i !ğ
max_size
; ++i)

250 ià(
d©a_
[
i
].
v”s
.
	`is_locked_h”e
(
h”e
))

251  
çl£
;

252  
Œue
;

253 
	}
}

254 
	$´št
(
¡d
::
o¡»am
& 
w
) const;

256 
´iv©e
:

257 
	s–em
 {

258 
v”siÚ_ty³
 
v”s
;

259 
W
<
T
> 
v
;

260 
	}
};

261 
–em
* 
	gd©a_
;

262 
	gW
<
	gsize_ty³
> 
	gsize_
;

263 
v”siÚ_ty³
 
	gsize_v”s_
;

264 
size_ty³
 
	gmax_size_
;

265 
size_ty³
 
	gÿ·c™y_
;

268 
T¿nsProxy
 
	$size_™em
() const {

269 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
size_key
);

270 ià(!
™em
.
	`has_»ad
()) {

271 autØ
»suÉ
 = 
size_
.
	`»ad
(
™em
, 
size_v”s_
);

272 ià(!
»suÉ
.
fœ¡
) {

273 
Sto
::
	`abÜt
();

275 autØ
sz
 = 
»suÉ
.
£cÚd
;

276 
™em
.
‹m¶©e
 
xwr™e_v®ue
<
´ed_ty³
>(èğ´ed_ty³{
sz
, sz};

278  
™em
;

279 
	}
}

280 
	g´ed_ty³
& 
	$size_šfo
(
T¿nsProxy
 
s™em
) {

281  
s™em
.
‹m¶©e
 
xwr™e_v®ue
<
´ed_ty³
>();

282 
	}
}

283 
	g´ed_ty³
& 
	$size_šfo
(
T¿nsI‹m
& 
s™em
) {

284  
s™em
.
‹m¶©e
 
xwr™e_v®ue
<
´ed_ty³
>();

285 
	}
}

286 cÚ¡ 
	g´ed_ty³
& 
	$size_šfo
(cÚ¡ 
T¿nsI‹m
& 
s™em
) {

287  
s™em
.
‹m¶©e
 
xwr™e_v®ue
<
´ed_ty³
>();

288 
	}
}

289 
	g´ed_ty³
& 
	$size_šfo
() const {

290  
	`size_šfo
(
	`size_™em
());

291 
	}
}

293 
	g¡d
::
·œ
<
boŞ
, 
	gg‘_ty³
> 
	$ŒªsG‘
(
size_ty³
 
i
, 
T¿nsProxy
 
™em
) const {

294 ià(
™em
.
	`has_wr™e
())

295  {
Œue
, 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>()};

297  
d©a_
[
i
].
v
.
	`»ad
(
™em
, d©a_[i].
v”s
);

299 
	}
}

300 
g‘_ty³
 
	$ŒªsG‘_throws
(
size_ty³
 
i
, 
T¿nsProxy
 
™em
) const {

301 autØ
»suÉ
 = 
	`ŒªsG‘
(
i
, 
™em
);

302 ià(!
»suÉ
.
fœ¡
) {

303 
Sto
::
	`abÜt
();

305  
»suÉ
.
£cÚd
;

306 
	}
}

308 
boŞ
 
	$put_š_¿nge
(
T¿nsProxy
& 
™em
, 
size_ty³
 
i
) const {

309 ià(
i
 >ğ
ÿ·c™y_
)

310  
çl£
;

311 ià(!
™em
.
	`ob£rve
(
d©a_
[
i
].
v”s
)) {

312 
Sto
::
	`abÜt
();

314 
™em
.
	`add_æags
(
Úlyexi¡s_b™
);

315  !(
™em
.
»ad_v®ue
<
v”siÚ_ty³
>().
	`v®ue
(è& 
d—d_b™
);

316 
	}
}

318 
ä›nd
 
şass
 
	g™”©Ü
;

319 
ä›nd
 
şass
 
	gcÚ¡_™”©Ü
;

323 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

324 
şass
 
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
cÚ¡_™”©Ü
 : 
public
 
¡d
::
™”©Ü
<¡d::
¿ndom_acûss_™”©Ü_g
, T> {

325 
	gpublic
:

326 
TVeùÜ_nİ»d
<
	tT
, 
	tW
> 
	tveùÜ_ty³
;

327 
ty³Çme
 
	tveùÜ_ty³
::
	tsize_ty³
 size_type;

328 
ty³Çme
 
	tveùÜ_ty³
::
	tdifã»nû_ty³
 difference_type;

330 
cÚ¡_™”©Ü
()

331 : 
a_
() {

333 
cÚ¡_™”©Ü
(cÚ¡ 
TVeùÜ_nİ»d
<
T
, 
W
>* 
a
, 
size_ty³
 
i
)

334 : 
a_
(
cÚ¡_ÿ¡
<
veùÜ_ty³
*>(
a
)), 
i_
(
i
) {

337 
ty³Çme
 
	gveùÜ_ty³
::
cÚ¡_´oxy_ty³
 
İ”©Ü
*() const {

338  
veùÜ_ty³
::
cÚ¡_´oxy_ty³
(
a_
, 
i_
);

341 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

342  
a_
 =ğ
x
.a_ && 
i_
 == x.i_;

344 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

345  !(*
this
 =ğ
x
);

347 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

348 
as£¹
(
a_
 =ğ
x
.a_);

349  
	gi_
 < 
	gx
.i_;

351 
boŞ
 
	gİ”©Ü
<=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

352 
as£¹
(
a_
 =ğ
x
.a_);

353  
	gi_
 <ğ
x
.
i_
;

355 
boŞ
 
	gİ”©Ü
>(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

356  
	gx
 < *
	gthis
;

358 
boŞ
 
	gİ”©Ü
>=(cÚ¡ 
cÚ¡_™”©Ü
& 
x
) const {

359  
x
 <ğ*
this
;

362 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
+=(
difã»nû_ty³
 
d–
) {

363 
i_
 +ğ
d–
;

364  *
	gthis
;

366 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
-=(
difã»nû_ty³
 
d–
) {

367 
i_
 +ğ
d–
;

368  *
	gthis
;

370 
cÚ¡_™”©Ü
 
	gİ”©Ü
+(
difã»nû_ty³
 
	gd–
) const {

371  
cÚ¡_™”©Ü
(
a_
, 
i_
 + 
d–
);

373 
cÚ¡_™”©Ü
 
	gİ”©Ü
-(
difã»nû_ty³
 
	gd–
) const {

374  
cÚ¡_™”©Ü
(
a_
, 
i_
 - 
d–
);

376 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
++() {

377 ++
	gi_
;

378  *
	gthis
;

380 
cÚ¡_™”©Ü
 
	gİ”©Ü
++() {

381 ++
	gi_
;

382  
cÚ¡_™”©Ü
(
a_
, 
i_
 - 1);

384 
	gcÚ¡_™”©Ü
& 
	gİ”©Ü
--() {

385 --
	gi_
;

386  *
	gthis
;

388 
cÚ¡_™”©Ü
 
	gİ”©Ü
--() {

389 --
	gi_
;

390  
cÚ¡_™”©Ü
(
a_
, 
i_
 + 1);

393 
šlše
 
difã»nû_ty³
 
	gİ”©Ü
-(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const;

395 
	g´Ùeùed
:

396 
veùÜ_ty³
* 
a_
;

397 
size_ty³
 
	gi_
;

399 
ä›nd
 
şass
 
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>;

402 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

403 
şass
 
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
™”©Ü
 : 
public
 
cÚ¡_™”©Ü
 {

404 
public
:

405 
TVeùÜ_nİ»d
<
	tT
, 
	tW
> 
	tveùÜ_ty³
;

406 
ty³Çme
 
	tveùÜ_ty³
::
	tsize_ty³
 size_type;

407 
ty³Çme
 
	tveùÜ_ty³
::
	tdifã»nû_ty³
 difference_type;

409 
™”©Ü
() {

411 
™”©Ü
(cÚ¡ 
TVeùÜ_nİ»d
<
T
, 
W
>* 
a
, 
size_ty³
 
i
)

412 : 
cÚ¡_™”©Ü
(
a
, 
i
) {

415 
ty³Çme
 
	gveùÜ_ty³
::
´oxy_ty³
 
İ”©Ü
*() const {

416  
veùÜ_ty³
::
´oxy_ty³
(
this
->
a_
,his->
i_
);

419 
	g™”©Ü
& 
	gİ”©Ü
+=(
difã»nû_ty³
 
d–
) {

420 
this
->
i_
 +ğ
d–
;

421  *
	gthis
;

423 
	g™”©Ü
& 
	gİ”©Ü
-=(
difã»nû_ty³
 
d–
) {

424 
this
->
i_
 +ğ
d–
;

425  *
	gthis
;

427 
™”©Ü
 
	gİ”©Ü
+(
difã»nû_ty³
 
	gd–
) const {

428  
™”©Ü
(
this
->
a_
,his->
i_
 + 
d–
);

430 
™”©Ü
 
	gİ”©Ü
-(
difã»nû_ty³
 
	gd–
) const {

431  
™”©Ü
(
this
->
a_
,his->
i_
 - 
d–
);

433 
	g™”©Ü
& 
	gİ”©Ü
++() {

434 ++
	gthis
->
	gi_
;

435  *
	gthis
;

437 
™”©Ü
 
	gİ”©Ü
++() {

438 ++
	gthis
->
	gi_
;

439  
™”©Ü
(
this
->
a_
,his->
i_
 - 1);

441 
	g™”©Ü
& 
	gİ”©Ü
--() {

442 --
	gthis
->
	gi_
;

443  *
	gthis
;

445 
™”©Ü
 
	gİ”©Ü
--() {

446 --
	gthis
->
	gi_
;

447  
™”©Ü
(
this
->
a_
,his->
i_
 + 1);

450 
difã»nû_ty³
 
	gİ”©Ü
-(cÚ¡ 
	gcÚ¡_™”©Ü
& 
	gx
) const {

451  
	gcÚ¡_™”©Ü
::
İ”©Ü
-(
x
);

454 
	g´iv©e
:

455 
ä›nd
 
şass
 
TVeùÜ_nİ»d
<
T
, 
	gW
>;

459 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

460 
šlše
‡utØ
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
begš
(è-> 
™”©Ü
 {

461  
™”©Ü
(
this
, 0);

464 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

465 
šlše
‡utØ
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
’d
(è-> 
™”©Ü
 {

466  
™”©Ü
(
this
, 
size_šfo
().
£cÚd
);

469 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

470 
šlše
‡utØ
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
	$cbegš
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

471  
	`cÚ¡_™”©Ü
(
this
, 0);

472 
	}
}

474 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

475 
šlše
‡utØ
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
	$ûnd
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

476  
	`™”©Ü
(
this
, 
	`size_šfo
().
£cÚd
);

477 
	}
}

479 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

480 
šlše
‡utØ
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
	$begš
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

481  
	`cbegš
();

482 
	}
}

484 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

485 
šlše
‡utØ
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
	$’d
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

486  
	`ûnd
();

487 
	}
}

491 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

492 
šlše
‡utØ
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
cÚ¡_™”©Ü
::
İ”©Ü
-(cÚ¡ cÚ¡_™”©Ü& 
x
ècÚ¡ -> 
difã»nû_ty³
 {

493  
i_
 - 
x
.i_;

497 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

498 
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
	$ş—r
() {

499 autØ
s™em
 = 
	`size_™em
().
	`add_wr™e
();

500 
´ed_ty³
& 
wv®
 = 
	`size_šfo
(
s™em
);

501 
size_ty³
 
i
 = 0; i !ğ
wv®
.
£cÚd
; ++i)

502 
Sto
::
	`™em
(
this
, 
i
).
	`add_wr™e
().
	`add_æags
(
pİ_b™
);

503 
wv®
.
£cÚd
 = 0;

504 
	}
}

506 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

507 autØ
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
”a£
(
™”©Ü
 
pos
) -> iterator {

508 autØ
s™em
 = 
size_™em
().
add_wr™e
();

509 
	g´ed_ty³
& 
	gwv®
 = 
size_šfo
(
s™em
);

510 ià(
	gpos
.
	gi_
 >ğ
wv®
.
£cÚd
)

511 
v”siÚ_ty³
::
İaque_throw
(
¡d
::
out_of_¿nge
("TVector_nopred::erase"));

512 --
	gwv®
.
	g£cÚd
;

513 
T¿nsProxy
 
	g™em
 = 
Sto
::
™em
(
this
, 
pos
.
i_
);

514 
size_ty³
 
	gi
 = 
pos
.
i_
; i !ğ
wv®
.
£cÚd
; ++i) {

515 
T¿nsProxy
 
	gÃxt_™em
 = 
Sto
::
™em
(
this
, 
i
 + 1);

516 
	g™em
.
add_wr™e
(
ŒªsG‘_throws
(
i
 + 1, 
Ãxt_™em
));

517 
	g™em
 = 
Ãxt_™em
;

519 
	g™em
.
add_wr™e
().
add_æags
(
pİ_b™
);

520  
	gpos
;

523 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

524 autØ
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
š£¹
(
™”©Ü
 
pos
, 
T
 
v®ue
è-> 
	g™”©Ü
 {

525 autØ
	gs™em
 = 
size_™em
().
add_wr™e
();

526 
	g´ed_ty³
& 
	gwv®
 = 
size_šfo
(
s™em
);

527 ià(
	gpos
.
	gi_
 > 
	gwv®
.
	g£cÚd
)

528 
	gv”siÚ_ty³
::
İaque_throw
(
¡d
::
out_of_¿nge
("TVector_nopred::insert"));

529 ++
	gwv®
.
	g£cÚd
;

530 
T¿nsProxy
 
	g™em
 = 
Sto
::
™em
(
this
, 
wv®
.
£cÚd
 - 1).
ş—r_wr™e
().
ş—r_æags
(
pİ_b™
);

531 
size_ty³
 
	gi
 = 
wv®
.
£cÚd
 - 1; i !ğ
pos
.
i_
; --i) {

532 
T¿nsProxy
 
	gÃxt_™em
 = 
Sto
::
™em
(
this
, 
i
 - 1);

533 
	g™em
.
add_wr™e
(
ŒªsG‘_throws
(
i
 - 1, 
Ãxt_™em
));

534 
	g™em
 = 
Ãxt_™em
;

536 
	g™em
.
add_wr™e
(
¡d
::
move
(
v®ue
));

537  
	gpos
;

540 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

541 
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
	$»size
(
size_ty³
 
size
, 
T
 
v®ue
) {

542 autØ
s™em
 = 
	`size_™em
().
	`add_wr™e
();

543 
´ed_ty³
& 
wv®
 = 
	`size_šfo
(
s™em
);

544 
size_ty³
 
Şd_size
 = 
wv®
.
£cÚd
;

545 
wv®
.
£cÚd
 = 
size
;

546 ; 
Şd_size
 > 
wv®
.
£cÚd
; --old_size)

547 
Sto
::
	`™em
(
this
, 
Şd_size
 - 1).
	`add_wr™e
().
	`add_æags
(
pİ_b™
);

548 ; 
Şd_size
 < 
wv®
.
£cÚd
; ++old_size)

549 
Sto
::
	`™em
(
this
, 
Şd_size
).
	`ş—r_wr™e
().
	`ş—r_æags
(
pİ_b™
)

550 .
	`add_wr™e
(
v®ue
);

551 
	}
}

553 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

554 
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
	$nÚŒªs_»£rve
(
size_ty³
 
size
) {

555 
size_ty³
 
Ãw_ÿ·c™y
 = 
ÿ·c™y_
;

556 
size
 > 
Ãw_ÿ·c™y
)

557 
Ãw_ÿ·c™y
 <<= 1;

558 ià(
Ãw_ÿ·c™y
 > 
ÿ·c™y_
) {

559 
–em
* 
Ãw_d©a
 = 
»š‹½»t_ÿ¡
<–em*>(
Ãw
 [ÓËmè* 
Ãw_ÿ·c™y
]);

560 
	`memıy
(
Ãw_d©a
, 
d©a_
, (
–em
è* 
ÿ·c™y_
);

561 
size_ty³
 
i
 = 
ÿ·c™y_
; i !ğ
Ãw_ÿ·c™y
; ++i)

562 
Ãw_d©a
[
i
].
v”s
 = 
d—d_b™
;

563 
T¿n§ùiÚ
::
	`rcu_d–‘e_¬¿y
(
»š‹½»t_ÿ¡
<*>(
d©a_
));

564 
d©a_
 = 
Ãw_d©a
;

565 
ÿ·c™y_
 = 
Ãw_ÿ·c™y
;

567 
	}
}

569 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

570 
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>::
	$´št
(
¡d
::
o¡»am
& 
w
) const {

571 
size_ty³
 
sz
 = 
size_
.
	`acûss
();

572 
w
 << "TVeùÜ_nİ»d<" << 
	`ty³id
(
T
).
	`Çme
(è<< ">{" << (*è
this


573 << "size=" << 
sz
 << '@' << 
size_v”s_
 << " [";

574 
size_ty³
 
i
 = 0; i < 
sz
; ++i) {

575 ià(
i
)

576 
w
 << ", ";

577 ià(
i
 >= 10)

578 
w
 << '[' << 
i
 << ']';

579 
w
 << 
d©a_
[
i
].
v
.
	`acûss
(è<< '@' << d©a_[i].
v”s
;

581 
w
 << "]";

582 
size_ty³
 
i
 = 
sz
; i < 
max_size_
 && i < sz + 10; ++i) {

583 
w
 << ", ";

584 ià(
i
 >= 10)

585 
w
 << '[' << 
i
 << ']';

586 
w
 << '@' << 
d©a_
[
i
].
v”s
;

588 ià(
sz
 + 10 < 
max_size_
)

589 
w
 << "...";

590 
w
 << "}";

591 
	}
}

593 
	g‹m¶©e
 <
ty³Çme
 
	gT
,em¶©<
	gty³Çme
>y³Çm
	gW
>

594 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	gTVeùÜ_nİ»d
<
	gT
, 
	gW
>& 
	gv
) {

595 
	gv
.
´št
(
w
);

596  
	gw
;

	@datatype/TransAlloc.hh

1 #´agm¨
Úû


2 
	~"cÚfig.h
"

3 
	~"comp”.hh
"

4 
	~"IÁ”çû.hh
"

5 
	~"T¿n§ùiÚ.hh
"

7 şas 
	cT¿nsAÎoc
 : 
public
 
TObjeù
 {

8 
public
:

9 
cÚ¡ex´
 
T¿nsI‹m
::
æags_ty³
 
®loc_æag
 = T¿nsI‹m::
u£r0_b™
;

10 (*
	tä“_ty³
)(*);

13 
	$ŒªsF»e
(*
±r
) {

14 
Sto
::
	`Ãw_™em
(
this
, 
±r
).
‹m¶©e
 
add_wr™e
<
ä“_ty³
, f»e_ty³>(::
ä“
);

18 * 
	$ŒªsM®loc
(
size_t
 
sz
) {

19 *
±r
 = 
	`m®loc
(
sz
);

20 
Sto
::
	`Ãw_™em
(
this
, 
±r
).
‹m¶©e
 
add_wr™e
<
ä“_ty³
, f»e_ty³>(::
ä“
).
	`add_æags
(
®loc_æag
);

21  
±r
;

22 
	}
}

25 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

26 
	$ŒªsD–‘e
(
T
 *
x
) {

27 
Sto
::
	`Ãw_™em
(
this
, 
x
).
‹m¶©e
 
add_wr™e
<
ä“_ty³
, f»e_ty³>(&
ObjeùDe¡roy”
<
T
>::
de¡roy_ªd_ä“
);

28 
	}
}

32 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

33 
T
* 
	$ŒªsNew
(
Args
&&... 
¬gs
) {

34 
T
* 
x
 = 
Ãw
 
	`T
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

35 
Sto
::
	`Ãw_™em
(
this
, 
x
).
‹m¶©e
 
add_wr™e
<
ä“_ty³
, f»e_ty³>(&
ObjeùDe¡roy”
<
T
>::
de¡roy_ªd_ä“
).
	`add_æags
(
®loc_æag
);

36  
x
;

37 
	}
}

39 
boŞ
 
	$lock
(
T¿nsI‹m
&, 
T¿n§ùiÚ
&è
ov”ride
 {  
Œue
; 
	}
}

40 
boŞ
 
	$check
(
T¿nsI‹m
&, 
T¿n§ùiÚ
&è
ov”ride
 {  
çl£
; 
	}
}

41 
	$š¡®l
(
T¿nsI‹m
&, 
T¿n§ùiÚ
&è
ov”ride
 {
	}
}

42 
	$uÆock
(
T¿nsI‹m
&è
ov”ride
 {
	}
}

43 
	$ş—nup
(
T¿nsI‹m
& 
™em
, 
boŞ
 
comm™‹d
è
ov”ride
 {

44 ià(
comm™‹d
 =ğ!
™em
.
	`has_æag
(
®loc_æag
))

45 
T¿n§ùiÚ
::
	`rcu_ÿÎ
(
™em
.
wr™e_v®ue
<
ä“_ty³
>(), i‹m.
key
<*>());

46 
	}
}

47 
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
ècÚ¡ 
ov”ride
 {

48 
w
 << "{T¿nsAÎoø@" << 
™em
.
key
<*>();

49 ià(
™em
.
wr™e_v®ue
<>())

50 
w
 << ".alloc}";

52 
w
 << ".free}";

53 
	}
}

	@datatype/TransPessimisticLocking.hh

1 #´agm¨
Úû


3 
	~"Boo¡šg_locks.hh
"

6 şas 
	cT¿nsPessimi¡icLockšg
 : 
public
 
TObjeù
 {

7 
ušt64_t
 
	tb™_ty³
;

9 
šlše
 
b™_ty³
 
	$¥š_lock
() {  1<<0; }

10 
šlše
 
b™_ty³
 
	$»ad_lock
(è{  1<<1; 
	}
}

11 
šlše
 
b™_ty³
 
	$wr™e_lock
(è{  1<<2; 
	}
}

13 
	gpublic
:

17 
	$ŒªsR—dLock
(
RWLock
 *
lock
) {

18 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
lock
);

20 ià(!
™em
.
	`has_wr™e
()) {

21 ià(!
lock
->
	`ŒyR—dLock
(
READ_SPIN
)) {

22 
Sto
::
	`abÜt
();

25 
™em
.
	`add_wr™e
(
	`»ad_lock
());

27 
	}
}

28 
	$ŒªsWr™eLock
(
RWLock
 *
lock
) {

29 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
lock
);

30 ià(!
™em
.
	`has_wr™e
()) {

31 ià(!
lock
->
	`ŒyWr™eLock
(
WRITE_SPIN
)) {

32 
Sto
::
	`abÜt
();

35 
™em
.
	`add_wr™e
(
	`wr™e_lock
());

36 } ià(
™em
.
‹m¶©e
 
wr™e_v®ue
<
b™_ty³
>(è=ğ
	`»ad_lock
()) {

37 ià(!
lock
->
	`ŒyUpg¿de
(
WRITE_SPIN
)) {

38 
Sto
::
	`abÜt
();

41 
™em
.
	`add_wr™e
(
	`wr™e_lock
());

43 
	}
}

44 
	$ŒªsSpšLock
(
SpšLock
 *
lock
) {

45 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
lock
);

46 ià(!
™em
.
	`has_wr™e
()) {

47 ià(!
lock
->
	`ŒyLock
(
WRITE_SPIN
)) {

48 
Sto
::
	`abÜt
();

51 
™em
.
	`add_wr™e
(
	`¥š_lock
());

53 
	}
}

55 
boŞ
 
	$lock
(
T¿nsI‹m
&, 
T¿n§ùiÚ
&è
ov”ride
 {  
Œue
; 
	}
}

56 
boŞ
 
	$check
(cÚ¡ 
T¿nsI‹m
&, cÚ¡ 
T¿n§ùiÚ
&è
ov”ride
 {  
çl£
; 
	}
}

57 
	$š¡®l
(
T¿nsI‹m
&, cÚ¡ 
T¿n§ùiÚ
&è
ov”ride
 {
	}
}

58 
	$uÆock
(
T¿nsI‹m
&è
ov”ride
 {
	}
}

59 
	$ş—nup
(
T¿nsI‹m
& 
™em
, 
boŞ
 
comm™‹d
è
ov”ride
 {

60 autØ
ty³
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
b™_ty³
>();

61 ià(
ty³
 =ğ
	`¥š_lock
()) {

62 
™em
.
‹m¶©e
 
key
<
SpšLock
*>()->
	`uÆock
();

65 autØ*
lock
 = 
™em
.
‹m¶©e
 
key
<
RWLock
*>();

66 ià(
ty³
 =ğ
	`»ad_lock
()) {

67 
lock
->
	`»adUÆock
();

68 } ià(
ty³
 =ğ
	`wr™e_lock
()) {

69 
lock
->
	`wr™eUÆock
();

71 
	}
}

	@datatype/TransUndoable.hh

1 #´agm¨
Úû


3 
	~"T¿n§ùiÚ.hh
"

5 şas 
	cT¿nsUndßbË
 : 
public
 
TObjeù
 {

6 
public
:

7 (*
	tUndoFunùiÚ
)(*, *, *);

8 
	$add_undo
(
UndoFunùiÚ
 
undo_func
, *
cÚ‹xt1
, *
cÚ‹xt2
) {

12 autØ
™em
 = 
Sto
::
	`Ãw_™em
(
this
, 
undo_func
);

13 
™em
.
	`£t_¡ash
(
cÚ‹xt1
);

14 
™em
.
	`add_wr™e
(
cÚ‹xt2
);

20 
boŞ
 
	$lock
(
T¿nsI‹m
&, 
T¿n§ùiÚ
&è
ov”ride
 {  
Œue
; 
	}
}

21 
	$uÆock
(
T¿nsI‹m
&è
ov”ride
 {
	}
}

22 
boŞ
 
	$check
(cÚ¡ 
T¿nsI‹m
&, cÚ¡ 
T¿n§ùiÚ
&è
ov”ride
 {  
çl£
; 
	}
}

23 
	$š¡®l
(
T¿nsI‹m
&, cÚ¡ 
T¿n§ùiÚ
&è
ov”ride
 {
	}
}

24 
	$ş—nup
(
T¿nsI‹m
& 
™em
, 
boŞ
 
comm™‹d
è
ov”ride
 {

25 ià(!
comm™‹d
) {

26 autØ
undo_func
 = 
™em
.
key
<
UndoFunùiÚ
>();

27 
	`undo_func
(
this
, 
™em
.
¡ash_v®ue
<*>(), i‹m.
wr™e_v®ue
<*>());

29 
	}
}

	@datatype/Vector.hh

1 #´agm¨
Úû


3 
	~"cÚfig.h
"

4 
	~"comp”.hh
"

5 
	~<io¡»am
>

6 
	~<veùÜ
>

7 
	~<m­
>

8 
	~<¡ršg.h
>

9 
	~"T¿n§ùiÚ.hh
"

10 
	~"TA¼ayProxy.hh
"

11 
	~"Box.hh
"

12 
	~"rwlock.hh
"

13 
	~<¡dexû±
>

15 
	#IT_SIZE
 10000

	)

16 
	#log2
(
x
è
	`û
(
	`log
((è
size
è/†og(2.0))

	)

18 
	g‹m¶©e
<
ty³Çme
 
	gT
, 
boŞ
 
	gO·c™y
 = 
çl£
,y³Çm
	gEËm
 = 
Box
<
T
>, boŞ 
	gSm¬tI‹¿tÜ
 = 
Œue
> 
şass
 
VeùÜ
;

19 
	g‹m¶©e
<
ty³Çme
 
	gT
, 
boŞ
 
	gO·c™y
 = 
çl£
,y³Çm
	gEËm
 = 
Box
<
T
>, boŞ 
	gSm¬tI‹¿tÜ
 = 
Œue
> 
şass
 
VecI‹¿tÜ
;

21 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gO·c™y
,y³Çm
	gEËm
, boŞ 
	gSm¬tI‹¿tÜ
>

22 şas 
	cVeùÜ
 : 
public
 
TObjeù
 {

23 
public
:

24 
	tšdex_ty³
;

26 
	m´iv©e
:

27 
ä›nd
 
şass
 
VecI‹¿tÜ
<
T
, 
	mO·c™y
, 
	mEËm
, 
	mSm¬tI‹¿tÜ
>;

28 cÚ¡ 
	tVeùÜ
<
	tT
, 
	tO·c™y
, 
	tEËm
, 
	tSm¬tI‹¿tÜ
> 
	tcÚ¡_veùÜ_ty³
;

29 
	mVeùÜ
<
	tT
, 
	tO·c™y
, 
	tEËm
, 
	tSm¬tI‹¿tÜ
> 
	tveùÜ_ty³
;

31 
	mT¿n§ùiÚTid
::
	tty³
 
	tV”siÚ
;

33 
cÚ¡ex´
 
	mveùÜ_key
 = -1;

34 
cÚ¡ex´
 
	mpush_back_key
 = -2;

35 
cÚ¡ex´
 
	msize_key
 = -3;

36 
cÚ¡ex´
 
	msize_´ed_key
 = -4;

37 
cÚ¡ex´
 
	mT¿nsI‹m
::
æags_ty³
 
li¡_b™
 = 
T¿nsI‹m
::
u£r0_b™
;

38 
cÚ¡ex´
 
	mT¿nsI‹m
::
æags_ty³
 
d–‘e_b™
 = 
T¿nsI‹m
::
u£r0_b™
<<1;

39 
cÚ¡ex´
 
št32_t
 
	mv®ue_shiá
 = 1;

40 
cÚ¡ex´
 
št32_t
 
	mgeq_mask
 = 1;

41 
	mpublic
:

42 
	tkey_ty³
;

43 
T
 
	tv®ue_ty³
;

44 
v®ue_ty³
 
	tg‘_ty³
;

46 
	mVecI‹¿tÜ
<
	tT
, 
	tO·c™y
, 
	tEËm
, 
	tSm¬tI‹¿tÜ
> 
	t™”©Ü
;

47 cÚ¡ 
	tVecI‹¿tÜ
<
	tT
, 
	tO·c™y
, 
	tEËm
, 
	tSm¬tI‹¿tÜ
> 
	tcÚ¡_™”©Ü
;

48 
	mTA¼ayProxy
<
	tVeùÜ
<
	tT
, 
	tO·c™y
, 
	tEËm
, 
	tSm¬tI‹¿tÜ
>> 
	t´oxy_ty³
;

49 
	mTCÚ¡A¼ayProxy
<
	tVeùÜ
<
	tT
, 
	tO·c™y
, 
	tEËm
, 
	tSm¬tI‹¿tÜ
>> 
	tcÚ¡_´oxy_ty³
;

50 
št32_t
 
	tsize_ty³
;

53 
	$VeùÜ
(): 
	$»size_lock_
() {

54 
ÿ·c™y_
 = 0;

55 
size_
 = 0;

56 
vecv”siÚ_
 = 0;

57 
d©a_
 = 
NULL
;

60 
	$VeùÜ
(
size_ty³
 
size
): 
	$»size_lock_
() {

61 
size_
 = 0;

62 
ÿ·c™y_
 = 1 << ((è
	`log2
(
size
));

63 
vecv”siÚ_
 = 0;

65 
d©a_
 = 
Ãw
 
EËm
[
ÿ·c™y_
];

66 
	}
}

68 
	$»£rve
(
size_ty³
 
Ãw_ÿ·c™y
) {

69 ià(
Ãw_ÿ·c™y
 <ğ
ÿ·c™y_
)

71 
EËm
 * 
Ãw_d©a
 = 
Ãw
 EËm[
Ãw_ÿ·c™y
];

73 
»size_lock_
.
	`wr™e_lock
();

74 
size_ty³
 
i
 = 0; i < 
ÿ·c™y_
; i++) {

75 
Ãw_d©a
[
i
] = 
d©a_
[i];

77 
ÿ·c™y_
 = 
Ãw_ÿ·c™y
;

78 ià(
d©a_
 !ğ
NULL
)

79 
T¿n§ùiÚ
::
	`rcu_d–‘e_¬¿y
(
d©a_
);

80 
d©a_
 = 
Ãw_d©a
;

81 
»size_lock_
.
	`wr™e_uÆock
();

82 
	}
}

84 
	$push_back
(cÚ¡ 
v®ue_ty³
& 
v
) {

85 ià(
	`Œªs_size_offs
() < 0) {

87 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
size_
 + 
	`Œªs_size_offs
());

88 ià(!
™em
.
	`has_wr™e
(è|| ! 
	`has_d–‘e
(item)) {

90 
Sto
::
	`abÜt
();

92 
™em
.
	`ş—r_wr™e
();

93 
™em
.
	`ş—r_æags
(
d–‘e_b™
);

94 
™em
.
	`add_wr™e
(
v
);

95 
	`add_Œªs_size_offs
(1);

99 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
push_back_key
);

100 ià(
™em
.
	`has_wr™e
()) {

101 ià(!
	`is_li¡
(
™em
)) {

102 auto& 
v®
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

103 
¡d
::
veùÜ
<
T
> 
wr™e_li¡
;

104 
wr™e_li¡
.
	`push_back
(
v®
);

105 
wr™e_li¡
.
	`push_back
(
v
);

106 
™em
.
	`ş—r_wr™e
();

107 
™em
.
	`add_wr™e
(
wr™e_li¡
);

108 
™em
.
	`add_æags
(
li¡_b™
);

111 auto& 
wr™e_li¡
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
¡d
::
veùÜ
<
T
>>();

112 
wr™e_li¡
.
	`push_back
(
v
);

116 
™em
.
	`add_wr™e
(
v
);

117 
™em
.
	`ş—r_æags
(
li¡_b™
);

119 
	`add_lock_veùÜ_™em
();

120 
	`add_Œªs_size_offs
(1);

121 
	}
}

122 
	$nÚŒªs_push_back
(
T
 
x
) {

123 
	`as£¹
(
size_
 < 
ÿ·c™y_
);

124 
d©a_
[
size_
].
	`wr™e
(
¡d
::
	`move
(
x
));

125 ++
size_
;

126 
	}
}

128 
	$pİ_back
() {

129 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
push_back_key
);

130 ià(
™em
.
	`has_wr™e
()) {

131 ià(!
	`is_li¡
(
™em
)) {

132 
™em
.
	`ş—r_wr™e
();

133 
	`add_Œªs_size_offs
(-1);

138 auto& 
wr™e_li¡
ğ
™em
.
‹m¶©e
 
wr™e_v®ue
<
¡d
::
veùÜ
<
T
>>();

139 
wr™e_li¡
.
	`pİ_back
();

140 ià(
wr™e_li¡
.
	`size
(è=ğ0è
™em
.
	`ş—r_wr™e
();

141 
	`add_Œªs_size_offs
(-1);

146 autØ
vec™em
 = 
	`add_veùÜ_v”siÚ
(
T¿n§ùiÚTid
::
	`uÆocked
(
vecv”siÚ_
));

147 
	`acquœe_ãnû
();

148 
size_ty³
 
size
 = 
size_
;

149 
	`acquœe_ãnû
();

150 ià(
size
 + 
	`Œªs_size_offs
() == 0) {

154 
vec™em
.
	`add_wr™e
(0);

155 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
size_
 + 
	`Œªs_size_offs
(è- 1).
	`add_wr™e
(0).
	`add_æags
(
d–‘e_b™
);

156 ià(
™em
.
	`æags
(è& 
EËm
::
v®id_Úly_b™
) {

157 
™em
.
	`ş—r_»ad
();

158 
™em
.
	`ş—r_æags
(
EËm
::
v®id_Úly_b™
);

160 
	`add_Œªs_size_offs
(-1);

162 
	}
}

164 
™”©Ü
 
	$”a£
(
™”©Ü
 
pos
) {

165 
™”©Ü
 
’d_™
 = 
	`’d
();

166 
™”©Ü
 
™
 = 
pos
; iˆ!ğ(
’d_™
 - 1); ++it) {

167 *(
™
èğ(
T
) *(it + 1);

169 
	`pİ_back
();

170  
pos
;

172 
	}
}

174 
™”©Ü
 
	$š£¹
(
™”©Ü
 
pos
, cÚ¡ 
T
& 
v®ue
) {

175 
™”©Ü
 
’d_™
 = 
	`’d
();

176 
	`push_back
(*(
’d_™
 - 1));

177 
™”©Ü
 
™
 = (
’d_™
 - 1); iˆ!ğ
pos
; --it) {

178 *(
™
èğ(
T
) *(it - 1);

181 *
pos
 = 
v®ue
;

182  
pos
;

183 
	}
}

185 
size_ty³
 
	$size
() {

186 
	`add_veùÜ_v”siÚ
(
T¿n§ùiÚTid
::
	`uÆocked
(
vecv”siÚ_
));

187 
	`acquœe_ãnû
();

188  
size_
 + 
	`Œªs_size_offs
();

189 
	}
}

191 
boŞ
 
	$checkSize
(
size_ty³
 
sz
) {

192 ià(!
Sm¬tI‹¿tÜ
) {

193  
	`size
(è=ğ
sz
;

195 
size_ty³
 
size
 = 
size_
;

196 
št32_t
 
off£t
 = 
	`Œªs_size_offs
();

198 
št32_t
 
´ed
 = (
sz
 - 
off£t
è<< 
v®ue_shiá
;

199 ià(
size
 + 
off£t
 =ğ
sz
) {

200 } ià(
size
 + 
off£t
 > 
sz
) {

201 
´ed
 |ğ
geq_mask
;

203 
Sto
::
	`abÜt
();

205 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
size_´ed_key
);

206 ià(
™em
.
	`has_´ediÿ‹
()) {

207 
št32_t
 
Şd_´ed
 = 
™em
.
‹m¶©e
 
´ediÿ‹_v®ue
<int32_t>();

209 ià(
´ed
 =ğ
Şd_´ed
 || (Şd_´ed &…»d & 
geq_mask
))

210 
´ed
 =…»d >ğ
Şd_´ed
 ?…red : old_pred;

211 ià((
Şd_´ed
 & 
geq_mask
è&& old_´ed <ğ(
´ed
 | geq_mask))

213 ià((
´ed
 & 
geq_mask
è&&…»d <ğ(
Şd_´ed
 | geq_mask))

214 
´ed
 = 
Şd_´ed
;

216 
Sto
::
	`abÜt
();

218 
™em
.
	`£t_´ediÿ‹
(
´ed
);

219  
size
 + 
off£t
 =ğ
sz
;

220 
	}
}

222 
size_ty³
 
	$nÚŒªs_size
() const {

223  
size_
;

224 
	}
}

225 
T
 
	$nÚŒªs_g‘
(
key_ty³
 
i
) const {

226 
	`as£¹
(
i
 < 
size_
);

227  
d©a_
[
i
].
	`un§ã_»ad
();

228 
	}
}

230 
´oxy_ty³
 
	$äÚt
() {

231 ià(
size_
 + 
	`Œªs_size_offs
() == 0)

232 
Sto
::
	`abÜt
();

233  
	`´oxy_ty³
(
this
, 0);

234 
	}
}

236 
´oxy_ty³
 
	$back
() {

237 
size_t
 
sz
 = 
	`size
();

238 ià(
sz
 == 0)

239 
Sto
::
	`abÜt
();

240  
	`´oxy_ty³
(
this
, 
sz
 - 1);

241 
	}
}

243 
cÚ¡_´oxy_ty³
 
	gİ”©Ü
[](
key_ty³
 
	gi
) const {

244 
size_ty³
 
	gsz
 = 
size_
 + 
Œªs_size_offs
();

245 ià(
	gi
 >ğ
sz
)

246 
Sto
::
abÜt
();

247  
cÚ¡_´oxy_ty³
(
this
, 
i
);

249 
´oxy_ty³
 
	gİ”©Ü
[](
key_ty³
 
	gi
) {

250 
size_ty³
 
	gsz
 = 
size_
 + 
Œªs_size_offs
();

251 ià(
	gi
 >ğ
sz
)

252 
Sto
::
abÜt
();

253  
´oxy_ty³
(
this
, 
i
);

256 
v®ue_ty³
 
	$ŒªsG‘
(cÚ¡ 
key_ty³
& 
i
) const {

257 
V”siÚ
 
v”
 = 
vecv”siÚ_
;

258 
	`acquœe_ãnû
();

259 
size_ty³
 
size
 = 
size_
;

260 
	`acquœe_ãnû
();

261 ià(
i
 >ğ
size
 + 
	`Œªs_size_offs
()) {

262 
Sto
::
	`check_İac™y
();

263 
throw
 
¡d
::
	`out_of_¿nge
("Vector::transGet");

265 ià(
i
 < 
size
)

266  
d©a_
[
i
].
	`ŒªsR—d
(
Sto
::
	`™em
(
this
, i));

268 
diff
 = 
i
 - 
size
;

270 autØ
exŒa_™ems
 = 
Sto
::
	`™em
(
this
, 
push_back_key
);

272 
	`add_veùÜ_v”siÚ
(
T¿n§ùiÚTid
::
	`uÆocked
(
v”
));

273 ià(
exŒa_™ems
.
	`has_wr™e
()) {

274 ià(
	`is_li¡
(
exŒa_™ems
)) {

275 auto& 
wr™e_li¡
ğ
exŒa_™ems
.
‹m¶©e
 
wr™e_v®ue
<
¡d
::
veùÜ
<
T
>>();

276 ià(!
wr™e_li¡
.
	`em±y
()) {

277  
wr™e_li¡
[
diff
];

279 
	`as£¹
(
çl£
);

283 
	`as£¹
(
diff
 == 0);

284  
exŒa_™ems
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

287 
	`as£¹
(
çl£
);

289 
	}
}

291 
	$ŒªsUpd©e
(cÚ¡ 
key_ty³
& 
i
, 
v®ue_ty³
 
v
) {

293 
V”siÚ
 
v”
 = 
vecv”siÚ_
;

294 
	`acquœe_ãnû
();

295 
size_ty³
 
size
 = 
size_
;

296 
	`acquœe_ãnû
();

297 ià(
i
 >ğ
size
 + 
	`Œªs_size_offs
()) {

298 
Sto
::
	`check_İac™y
();

299 
throw
 
¡d
::
	`out_of_¿nge
("Vector::transUpdate");

301 ià(
i
 < 
size
)

302 
d©a_
[
i
].
	`ŒªsWr™e
(
Sto
::
	`™em
(
this
, i), 
¡d
::
	`move
(
v
));

304 
diff
 = 
i
 - 
size
;

306 autØ
exŒa_™ems
 = 
Sto
::
	`™em
(
this
, 
push_back_key
);

308 
	`add_veùÜ_v”siÚ
(
T¿n§ùiÚTid
::
	`uÆocked
(
v”
));

309 ià(
exŒa_™ems
.
	`has_wr™e
()) {

310 ià(
	`is_li¡
(
exŒa_™ems
)) {

311 auto& 
wr™e_li¡
ğ
exŒa_™ems
.
‹m¶©e
 
wr™e_v®ue
<
¡d
::
veùÜ
<
T
>>();

312 ià(!
wr™e_li¡
.
	`em±y
()) {

313 
wr™e_li¡
[
diff
] = 
v
;

315 
	`as£¹
(
çl£
);

319 
	`as£¹
(
diff
 == 0);

320 
exŒa_™ems
.
	`ş—r_wr™e
();

321 
exŒa_™ems
.
	`add_wr™e
(
v
);

324 
	`as£¹
(
çl£
);

327 
	}
}

328 
	$ŒªsPut
(cÚ¡ 
key_ty³
& 
i
, 
v®ue_ty³
 
v
) {

329 
	`ŒªsUpd©e
(
i
, 
v
);

330 
	}
}

332 
boŞ
 
	$is_li¡
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

333  
™em
.
	`æags
(è& 
li¡_b™
;

334 
	}
}

336 
boŞ
 
	$has_d–‘e
(cÚ¡ 
T¿nsI‹m
& 
™em
) {

337  
™em
.
	`æags
(è& 
d–‘e_b™
;

338 
	}
}

340 
	$lock_v”siÚ
(
V”siÚ
& 
v
) {

341 
T¿n§ùiÚTid
::
	`lock
(
v
);

342 
	}
}

344 
	$uÆock_v”siÚ
(
V”siÚ
& 
v
) {

345 
T¿n§ùiÚTid
::
	`uÆock
(
v
);

346 
	}
}

348 
boŞ
 
	$is_locked
(
V”siÚ
& 
v
) const {

349  
T¿n§ùiÚTid
::
	`is_locked
(
v
);

350 
	}
}

352 
	$lock
(
key_ty³
 
i
) {

354 
»size_lock_
.
	`»ad_lock
();

355 
boŞ
 
locked
 = 
d©a_
[
i
].
	`Œy_lock
();

356 
»size_lock_
.
	`»ad_uÆock
();

357 ià(
locked
) ;

359 
	}
}

361 
	$uÆock
(
key_ty³
 
i
) {

362 
»size_lock_
.
	`»ad_lock
();

363 
d©a_
[
i
].
	`uÆock
();

364 
»size_lock_
.
	`»ad_uÆock
();

365 
	}
}

367 
	$add_Œªs_size_offs
(
size_offs
) {

370 autØ
™em
 = 
Sto
::
	`™em
(
this
, 
size_key
);

371 
™em
.
	`£t_¡ash
(™em.
‹m¶©e
 
¡ash_v®ue
<>(0è+ 
size_offs
);

372 
	}
}

374 
	$Œªs_size_offs
() const {

375  
Sto
::
	`™em
(
cÚ¡_ÿ¡
<
VeùÜ
<
T
, 
O·c™y
, 
EËm
, 
Sm¬tI‹¿tÜ
>*>(
this
), 
size_key
).
‹m¶©e
 
¡ash_v®ue
<>(0);

376 
	}
}

378 
T¿nsProxy
 
	$veùÜ_™em
() const {

380  
Sto
::
	`™em
(
this
, 
veùÜ_key
);

381 
	}
}

383 
	$add_lock_veùÜ_™em
() {

384 
	`veùÜ_™em
().
	`add_wr™e
(0);

385 
	}
}

387 
T¿nsProxy
 
	$add_veùÜ_v”siÚ
(
V”siÚ
 
v”
) const {

388  
	`veùÜ_™em
().
	`add_»ad
(
v”
);

389 
	}
}

391 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
&è
ov”ride
 {

392 ià(
™em
.
key
<>(è=ğ
veùÜ_key
) {

393 
	`lock_v”siÚ
(
vecv”siÚ_
);

394 } ià(
™em
.
key
<>(è!ğ
push_back_key
) {

395 
	`lock
(
™em
.
key
<
key_ty³
>());

397  
Œue
;

398 
	}
}

400 
boŞ
 
	$check_´ediÿ‹
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
&, 
boŞ
è
ov”ride
 {

401 
	`as£¹
(
™em
.
key
<>(è=ğ
size_´ed_key
);

402 autØ
lv
 = 
vecv”siÚ_
;

403 ià(
	`is_locked
(
lv
))

404  
çl£
;

405 
	`veùÜ_™em
().
	`add_»ad
(
lv
);

406 
	`acquœe_ãnû
();

407 autØ
size
 = 
size_
;

408 
št32_t
 
´ed
 = 
™em
.
‹m¶©e
 
´ediÿ‹_v®ue
<int32_t>();

409 
št32_t
 
´ed_v®ue
 = 
´ed
 >> 
v®ue_shiá
;

410 ià(
´ed
 & 
geq_mask
)

411  
size
 >ğ
´ed_v®ue
;

413  
size
 =ğ
´ed_v®ue
;

414 
	}
}

416 
boŞ
 
	$check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
&è
ov”ride
 {

417 ià(
™em
.
key
<>(è=ğ
veùÜ_key
 || i‹m.key<>(è=ğ
push_back_key
)

418  
T¿n§ùiÚTid
::
	`check_v”siÚ
(
vecv”siÚ_
, 
™em
.
‹m¶©e
 
»ad_v®ue
<
V”siÚ
>());

419 
key_ty³
 
i
 = 
™em
.
key
<key_type>();

420 
	`as£¹
(
i
 >= 0);

421 ià(
™em
.
	`æags
(è& 
EËm
::
v®id_Úly_b™
) {

422  
i
 < 
size_
 + 
	`Œªs_size_offs
()

423 && !
d©a_
[
i
].
	`is_locked_–£wh”e
();

425  
d©a_
[
i
].
	`check_v”siÚ
(
™em
.
‹m¶©e
 
»ad_v®ue
<
V”siÚ
>());

426 
	}
}

428 
	$š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
t
è
ov”ride
 {

430 ià(
™em
.
key
<>(è=ğ
veùÜ_key
)

432 ià(
™em
.
key
<>(è=ğ
push_back_key
) {

434 ià(
	`is_li¡
(
™em
)) {

435 auto& 
wr™e_li¡
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
¡d
::
veùÜ
<
T
>>();

436 
size_t
 
i
 = 0; i < 
wr™e_li¡
.
	`size
(); i++) {

437 ià(
size_
 >ğ
ÿ·c™y_
) {

439 
Ãw_ÿ·c™y
 = (
ÿ·c™y_
 == 0) ? 1 : capacity_ << 1;

440 
	`»£rve
(
Ãw_ÿ·c™y
);

442 
»size_lock_
.
	`»ad_lock
();

443 
d©a_
[
size_
].
	`wr™e
(
wr™e_li¡
[
i
]);

444 
	`acquœe_ãnû
();

445 
size_
++;

446 
»size_lock_
.
	`»ad_uÆock
();

450 auto& 
v®
 = 
™em
.
‹m¶©e
 
wr™e_v®ue
<
T
>();

451 ià(
size_
 >ğ
ÿ·c™y_
) {

453 
Ãw_ÿ·c™y
 = (
ÿ·c™y_
 == 0) ? 1 : capacity_ << 1;

454 
	`»£rve
(
Ãw_ÿ·c™y
);

456 
»size_lock_
.
	`»ad_lock
();

457 
d©a_
[
size_
].
	`wr™e
(
v®
);

458 
	`acquœe_ãnû
();

459 
size_
++;

460 
»size_lock_
.
	`»ad_uÆock
();

463 ià(
O·c™y
) {

464 
T¿n§ùiÚTid
::
	`£t_v”siÚ
(
vecv”siÚ_
, 
t
.
	`comm™_tid
());

466 
T¿n§ùiÚTid
::
	`šc_nÚİaque_v”siÚ
(
vecv”siÚ_
);

469 autØ
šdex
 = 
™em
.
key
<
key_ty³
>();

470 ià(
	`has_d–‘e
(
™em
)) {

471 ià(
šdex
 < 
size_
) {

472 
size_
 = 
šdex
;

474 ià(
O·c™y
) {

475 
T¿n§ùiÚTid
::
	`£t_v”siÚ
(
vecv”siÚ_
, 
t
.
	`comm™_tid
());

477 
T¿n§ùiÚTid
::
	`šc_nÚİaque_v”siÚ
(
vecv”siÚ_
);

480 } ià(
šdex
 >ğ
size_
) {

481 
	`as£¹
(
çl£
);

484 
»size_lock_
.
	`»ad_lock
();

485 
d©a_
[
šdex
].
	`š¡®l
(
™em
, 
t
);

486 
»size_lock_
.
	`»ad_uÆock
();

488 
	}
}

490 
	$uÆock
(
T¿nsI‹m
& 
™em
è
ov”ride
 {

491 ià(
™em
.
key
<>(è=ğ
veùÜ_key
)

492 
	`uÆock_v”siÚ
(
vecv”siÚ_
);

493 ià(
™em
.
key
<>(è!ğ
push_back_key
)

494 
	`uÆock
(
™em
.
key
<
key_ty³
>());

495 
	}
}

497 
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
ècÚ¡ 
ov”ride
 {

498 
w
 << "{Vector<";

499 cÚ¡ * 
pf
 = 
	`¡r¡r
(
__PRETTY_FUNCTION__
, "with T = ");

500 ià(
pf
) {

501 
pf
 += 9;

502 cÚ¡ * 
£mi
 = 
	`¡rchr
(
pf
, ';');

503 
w
.
	`wr™e
(
pf
, 
£mi
 -…f);

505 
w
 << "> " << (*è
this
;

506 ià(
™em
.
key
<>(è=ğ
size_´ed_key
) {

507 
w
 << ".size" << (
™em
.
´ediÿ‹_v®ue
<
št32_t
>(è& 
geq_mask
 ? ">=" : "=="è<< (™em.´ediÿ‹_v®ue<št32_t>(è>> 
v®ue_shiá
);

509 ià(
™em
.
key
<>(è=ğ
size_key
)

510 
w
 << ".size";

511 ià(
™em
.
key
<>(è=ğ
push_back_key
)

512 
w
 << ".push_back";

513 ià(
™em
.
key
<>(è=ğ
veùÜ_key
)

514 
w
 << ".vector";

516 
w
 << "[" << 
™em
.
key
<>() << "]";

517 ià(
	`has_d–‘e
(
™em
))

518 
w
 << "XX";

520 ià(
™em
.
	`has_»ad
())

521 
w
 << " ?" << 
™em
.
»ad_v®ue
<
V”siÚ
>();

522 ià(
™em
.
	`has_wr™e
())

523 
w
 << " =" << 
™em
.
wr™e_v®ue
<*>();

525 
w
 << "}";

526 
	}
}

528 
™”©Ü
 
	$begš
() {

529  
	`™”©Ü
(
this
, 0, 
çl£
);

530 
	}
}

531 
™”©Ü
 
	$’d
() {

534  
	`™”©Ü
(
this
, 0, 
Œue
);

535 
	}
}

538 
	$´št
() {

539 
i
 = 0; i < 
	`nÚŒªs_size
(); i++) {

540 
¡d
::
cout
 << 
	`nÚŒªs_g‘
(
i
) << " ";

542 
¡d
::
cout
 << std::
’dl
;

543 
	}
}

545 
	g´iv©e
:

546 
size_ty³
 
size_
;

547 
size_ty³
 
	gÿ·c™y_
;

548 
V”siÚ
 
	gvecv”siÚ_
;

549 
rwlock
 
	g»size_lock_
;

550 
EËm
* 
	gd©a_
;

554 
	g‹m¶©e
<
ty³Çme
 
	gT
, 
boŞ
 
	gO·c™y
,y³Çm
	gEËm
, boŞ 
	gSm¬tI‹¿tÜ
>

555 
şass
 
	gVecI‹¿tÜ
 : 
public
 
¡d
::
™”©Ü
<¡d::
¿ndom_acûss_™”©Ü_g
, 
	gT
> {

556 
	gpublic
:

557 
T
 
	tv®ue_ty³
;

558 
	gVeùÜ
<
	tT
, 
	tO·c™y
, 
	tEËm
, 
	tSm¬tI‹¿tÜ
> 
	tveùÜ_ty³
;

559 
ty³Çme
 
	tveùÜ_ty³
::
	t´oxy_ty³
…roxy_type;

560 
	gVecI‹¿tÜ
<
	tT
, 
	tO·c™y
, 
	tEËm
, 
	tSm¬tI‹¿tÜ
> 
	t™”©Ü
;

561 
VecI‹¿tÜ
() = ;

562 
VecI‹¿tÜ
(
VeùÜ
<
T
, 
O·c™y
, 
EËm
, 
Sm¬tI‹¿tÜ
> * 
¬r
, 
±r
, 
boŞ
 
’dy
è: 
myA¼
×¼), 
myPŒ
(ptr),ƒndy(endy) { }

563 
VecI‹¿tÜ
(cÚ¡ VecI‹¿tÜ& 
™r
è: 
myA¼
(™r.myA¼), 
myPŒ
(™r.myPŒ), 
’dy
(itr.endy) {}

565 
	gVecI‹¿tÜ
& 
	gİ”©Ü
ğ(cÚ¡ 
VecI‹¿tÜ
& 
v
) {

566 
myA¼
 = 
v
.myArr;

567 
	gmyPŒ
 = 
v
.
myPŒ
;

568 
	g’dy
 = 
v
.
’dy
;

569  *
	gthis
;

572 
boŞ
 
	gİ”©Ü
==(
™”©Ü
 
Ùh”
) const {

573 ià(
myA¼
 !ğ
Ùh”
.myArr)

574  
çl£
;

575 ià(
	g’dy
 =ğ
Ùh”
.
’dy
)

576  
myPŒ
 =ğ
Ùh”
.myPtr;

578 
size_t
 
	gsz
 = 
’dy
 ? 
Ùh”
.
myPŒ
 - myPtr : myPtr - other.myPtr;

579  
	gmyA¼
->
checkSize
(
sz
);

583 
boŞ
 
	gİ”©Ü
!=(
™”©Ü
 
Ùh”
) const {

584  !(
İ”©Ü
==(
Ùh”
));

587 
´oxy_ty³
 
	gİ”©Ü
*() {

588  
´oxy_ty³
(
myA¼
, 
’dy
 ? myA¼->
size
(è+ 
myPŒ
 : myPtr);

591 
´oxy_ty³
 
	gİ”©Ü
[](
	gd–
) {

592  
´oxy_ty³
(
myA¼
, (
’dy
 ? myA¼->
size
(è+ 
myPŒ
 : myPŒè+ 
d–
);

596 
	g™”©Ü
& 
	gİ”©Ü
++(è{ ++
	gmyPŒ
;  *
	gthis
; }

599 
™”©Ü
 
	gİ”©Ü
++() {

600 
	gVecI‹¿tÜ
<
	gT
, 
	gO·c™y
, 
	gEËm
, 
	gSm¬tI‹¿tÜ
> 
şÚe
(*
this
);

601 ++
	gmyPŒ
;

602  
	gşÚe
;

605 
	g™”©Ü
& 
	gİ”©Ü
--(è{ --
	gmyPŒ
;  *
	gthis
; }

607 
™”©Ü
 
	gİ”©Ü
--() {

608 
	gVecI‹¿tÜ
<
	gT
, 
	gO·c™y
, 
	gEËm
, 
	gSm¬tI‹¿tÜ
> 
şÚe
(*
this
);

609 --
	gmyPŒ
;

610  
	gşÚe
;

613 
™”©Ü
 
	gİ”©Ü
+(
	gi
) {

614 
	gVecI‹¿tÜ
<
	gT
, 
	gO·c™y
, 
	gEËm
, 
	gSm¬tI‹¿tÜ
> 
şÚe
(*
this
);

615 
	gşÚe
.
	gmyPŒ
 +ğ
i
;

616  
	gşÚe
;

619 
™”©Ü
 
	gİ”©Ü
-(
	gi
) {

620 
	gVecI‹¿tÜ
<
	gT
, 
	gO·c™y
, 
	gEËm
, 
	gSm¬tI‹¿tÜ
> 
şÚe
(*
this
);

621 
	gşÚe
.
	gmyPŒ
 -ğ
i
;

622  
	gşÚe
;

625 
	gİ”©Ü
-(cÚ¡ 
	g™”©Ü
& 
	grhs
) {

626 
as£¹
(
rhs
.
myA¼
 == myArr);

627 ià(
	g’dy
 =ğ
rhs
.
’dy
)

628  (
myPŒ
 - 
rhs
.myPtr);

630 
size_t
 
	gsize
 = 
myA¼
->
size
();

631 ià(
	g’dy
)

632  
	gsize
 + 
	gmyPŒ
 - 
	grhs
.myPtr;

634  
	gmyPŒ
 - 
	grhs
.myPŒ - 
	gsize
;

638 
	g´iv©e
:

639 
VeùÜ
<
T
, 
	gO·c™y
, 
	gEËm
, 
	gSm¬tI‹¿tÜ
> * 
	gmyA¼
;

640 
size_t
 
	gmyPŒ
;

641 
boŞ
 
	g’dy
;

	@datatype/print_value.hh

1 #´agm¨
Úû


2 
	~"comp”.hh
"

3 
	~<s¡»am
>

5 
Çme¥aû
 
	gmass
 {

7 
	g‹m¶©e
 <
ty³Çme
 
	gT
> cÏs 
	cis_´šbË
 : 
public
 
çl£_ty³
 {};

8 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<> : 
public
 
Œue_ty³
 {};

9 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<sigÃd > : 
public
 
Œue_ty³
 {};

10 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<> : 
public
 
Œue_ty³
 {};

11 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<
	gboŞ
> : 
public
 
Œue_ty³
 {};

12 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<> : 
public
 
Œue_ty³
 {};

13 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<> : 
public
 
Œue_ty³
 {};

14 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<> : 
public
 
Œue_ty³
 {};

15 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<> : 
public
 
Œue_ty³
 {};

16 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<> : 
public
 
Œue_ty³
 {};

17 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<> : 
public
 
Œue_ty³
 {};

18 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<> : 
public
 
Œue_ty³
 {};

19 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<> : 
public
 
Œue_ty³
 {};

20 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<> : 
public
 
Œue_ty³
 {};

21 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<> : 
public
 
Œue_ty³
 {};

22 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<> : 
public
 
Œue_ty³
 {};

23 
	g‹m¶©e
 <
ty³Çme
 
	gC
,y³Çm
	gT
,y³Çm
	gA
> 
şass
 
	gis_´šbË
<
	g¡d
::
basic_¡ršg
<
C
, T, A> > : 
public
 
Œue_ty³
 {};

24 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<cÚ¡ *> : 
public
 
Œue_ty³
 {};

25 
	g‹m¶©e
 <> 
şass
 
	gis_´šbË
<*> : 
public
 
Œue_ty³
 {};

27 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	g´šbË
 = 
is_´šbË
<ty³Çm
¡d
::
»move_cv
<
T
>::
ty³
>::
v®ue
 > 
şass
 
´št_v®ue_h–³r
;

28 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
şass
 
	g´št_v®ue_h–³r
<T, 
	gŒue
> {

29 
	gpublic
:

30 cÚ¡ 
	tT
& 
	tty³
;

31 cÚ¡ 
	gT
& 
´št_v®ue
(cÚ¡ 
T
& 
x
) {

32  
	gx
;

35 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
şass
 
	g´št_v®ue_h–³r
<T, 
	gçl£
> {

36 
	gpublic
:

37 
¡d
::
	t¡ršg
 
	tty³
;

38 
	g¡d
::
¡ršg
 
´št_v®ue
(cÚ¡ 
T
& 
x
) {

39 
¡d
::
o¡ršg¡»am
 
buf
;

40 
	gbuf
 << "<&" << (*è&
	gx
 << ">";

41  
	gbuf
.
¡r
();

45 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

46 autØ
´št_v®ue
(cÚ¡ 
T
& 
x
è-> 
ty³Çme
 
	g´št_v®ue_h–³r
<
	gT
>::
ty³
 {

47  
´št_v®ue_h–³r
<
T
>::
´št_v®ue
(
x
);

	@datatype/versioned_value.hh

1 #´agm¨
Úû


2 
	~<io¡»am
>

3 
	~"IÁ”çû.hh
"

4 
	~"mas¡»e_´št.hh
"

10 
	~"kvth»ad.hh
"

12 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
=>

13 
	sv”siÚed_v®ue_¡ruù
 {

14 
T
 
	tv®ue_ty³
;

15 
	mT¿n§ùiÚTid
::
	tty³
 
	tv”siÚ_ty³
;

17 
v”siÚed_v®ue_¡ruù
(è: 
v”siÚ_
(), 
v®ue_
() {}

19 
v”siÚed_v®ue_¡ruù
(cÚ¡ 
v®ue_ty³
& 
v®
, 
v”siÚ_ty³
 
v
è: 
v”siÚ_
(v), 
v®ue_
(val) {}

21 
v”siÚed_v®ue_¡ruù
* 
make
(cÚ¡ 
v®ue_ty³
& 
v®
, 
v”siÚ_ty³
 
v”siÚ
) {

22  
Ãw
 
	mv”siÚed_v®ue_¡ruù
<
	mT
>(
	mv®
, 
	mv”siÚ
);

25 
boŞ
 
ÃedsResize
(cÚ¡ 
v®ue_ty³
&) {

26  
	mçl£
;

29 
v”siÚed_v®ue_¡ruù
* 
»sizeIfN“ded
(cÚ¡ 
v®ue_ty³
&) {

30  
	mNULL
;

33 
šlše
 
£t_v®ue
(cÚ¡ 
v®ue_ty³
& 
v
) {

34 
	mv®ue_
 = 
v
;

37 
šlše
 cÚ¡ 
	mv®ue_ty³
& 
»ad_v®ue
() const {

38  
	mv®ue_
;

41 
šlše
 
	mv®ue_ty³
& 
wr™—bË_v®ue
() {

42  
	mv®ue_
;

45 
šlše
 cÚ¡ 
	mv”siÚ_ty³
& 
v”siÚ
() const {

46  
	mv”siÚ_
;

48 
šlše
 
	mv”siÚ_ty³
& 
v”siÚ
() {

49  
	mv”siÚ_
;

52 
šlše
 
d—Îoÿ‹_rcu
(
th»adšfo
& 
ti
) {

53 
	mti
.
d—Îoÿ‹_rcu
(
this
, (
v”siÚed_v®ue_¡ruù
), 
memg_v®ue
);

57 
´št
(
FILE
 *
f
, cÚ¡ *
´efix
, 
šd’t
, 
lcdf
::
SŒ
 
key
,

58 
kvtime¡amp_t
, *
suffix
) {

59 
	m¡d
::
¡ršg¡»am
 
vss
;

60 
	mvss
 << 
	mv®ue_
;

61 
årštf
(
f
, "%s%*s%.* ğ%s%s\n", 
´efix
, 
šd’t
, "",

62 
key
.
Ën
, key.
s
, 
vss
.
¡r
().
c_¡r
(), 
suffix
);

67 
İ”©Ü
()(
	mth»adšfo
& 
	mti
) {

69 
	mthis
->
	mv”siÚed_v®ue_¡ruù
::~
v”siÚed_v®ue_¡ruù
();

71 
	mti
.
d—Îoÿ‹
(
this
, (
v”siÚed_v®ue_¡ruù
), 
memg_v®ue
);

75 
	m´iv©e
:

76 
v”siÚ_ty³
 
v”siÚ_
;

77 
v®ue_ty³
 
	mv®ue_
;

81 
	g‹m¶©e
<
ty³Çme
 
	gT
>

82 
	gv”siÚed_v®ue_¡ruù
<
	gT
, 
ty³Çme
 
	g¡d
::
’abË_if
<!
__has_ŒivŸl_cİy
(
T
)>::
ty³
> {

83 
public
:

84 
T
 
	tv®ue_ty³
;

85 
	gT¿n§ùiÚTid
::
	tty³
 
	tv”siÚ_ty³
;

87 
v”siÚed_v®ue_¡ruù
* 
make
(cÚ¡ 
v®ue_ty³
& 
v®
, 
v”siÚ_ty³
 
v”siÚ
) {

88  
Ãw
 
v”siÚed_v®ue_¡ruù
(
v®
, 
v”siÚ
);

91 
v”siÚed_v®ue_¡ruù
(è: 
v”siÚ_
(), 
v®u•Œ_
() {}

93 
boŞ
 
ÃedsResize
(cÚ¡ 
v®ue_ty³
&) {

94  
	gçl£
;

96 
v”siÚed_v®ue_¡ruù
* 
»sizeIfN“ded
(cÚ¡ 
v®ue_ty³
&) {

97  
	gthis
;

100 
£t_v®ue
(cÚ¡ 
v®ue_ty³
& 
v
) {

102 
	gv®u•Œ_
 = 
Ãw
 
v®ue_ty³
(
¡d
::
move
(
v
));

106 cÚ¡ 
	gv®ue_ty³
& 
»ad_v®ue
() const {

107  *
	gv®u•Œ_
;

110 
šlše
 cÚ¡ 
	gv”siÚ_ty³
& 
v”siÚ
() const {

111  
	gv”siÚ_
;

113 
	gv”siÚ_ty³
& 
v”siÚ
() {

114  
	gv”siÚ_
;

117 
šlše
 
d—Îoÿ‹_rcu
(
th»adšfo
& 
ti
) {

119 
	gti
.
d—Îoÿ‹_rcu
(
this
, (
v”siÚed_v®ue_¡ruù
), 
memg_v®ue
);

123 
´št
(
FILE
 *
f
, cÚ¡ *
´efix
, 
šd’t
, 
lcdf
::
SŒ
 
key
,

124 
kvtime¡amp_t
, *
suffix
) {

125 
	g¡d
::
¡ršg¡»am
 
vss
;

126 
	gvss
 << *
	gv®u•Œ_
;

127 
årštf
(
f
, "%s%*s%.* ğ%s%s\n", 
´efix
, 
šd’t
, "",

128 
key
.
Ën
, key.
s
, 
vss
.
¡r
().
c_¡r
(), 
suffix
);

131 
	g´iv©e
:

132 
v”siÚed_v®ue_¡ruù
(cÚ¡ 
v®ue_ty³
& 
v®
, 
v”siÚ_ty³
 
v”siÚ
è: 
v”siÚ_
(v”siÚ), 
v®u•Œ_
(
Ãw
 v®ue_ty³(
¡d
::
move
(val))) {}

134 
v”siÚ_ty³
 
v”siÚ_
;

135 
v®ue_ty³
* 
	gv®u•Œ_
;

	@legacy/Boosting.cc

1 
	~"Boo¡šg_2.hh
"

2 
	~"Boo¡šg_¡ªd®Úe.hh
"

4 
boo¡šg_th»adšfo
 
	gboo¡šg_th»ads
[
BOOSTING_MAX_THREADS
];

5 
__th»ad
 
	gboo¡šg_th»adid
;

7 
	$boo¡šg_txS¹Hook
() {

8 
	`POST_COMMIT
(
boo¡šg_»Ëa£LocksC®lback
, 
NULL
, NULL, NULL);

10 
	`ON_ABORT
(
boo¡šg_»Ëa£LocksC®lback
, 
NULL
, NULL, NULL);

11 
	}
}

13 
	$boo¡šg_£tTh»adID
(
th»adid
) {

14 
boo¡šg_th»adid
 = 
th»adid
;

15 
	}
}

17 
	$boo¡šg_»Ëa£LocksC®lback
(*, *, *) {

18 autØ*
lock
 : 
	`_th»ad
().
lock£t
) {

19 
lock
->
	`uÆock
();

21 autØ*
rwlockp
 : 
	`_th»ad
().
rwlock£t
) {

22 auto& 
rwlock
 = *
rwlockp
;

23 ià(
rwlock
.
	`isWr™eLocked
()) {

24 
rwlock
.
	`wr™eUÆock
();

26 
rwlock
.
	`»adUÆock
();

30 
	`_th»ad
().
lock£t
.
	`un§ã_ş—r
();

31 
	`_th»ad
().
rwlock£t
.
	`un§ã_ş—r
();

32 
	}
}

34 
	$ŒªsR—dLock
(
RWLock
 *
lock
) {

35 ià(!
	`_th»ad
().
rwlock£t
.
	`exi¡s
(
lock
)) {

36 ià(!
lock
->
	`ŒyR—dLock
(
READ_SPIN
)) {

37 
	`DO_ABORT
();

40 
	`_th»ad
().
rwlock£t
.
	`push
(
lock
);

42 
	}
}

44 
	$ŒªsWr™eLock
(
RWLock
 *
lock
) {

45 ià(!
	`_th»ad
().
rwlock£t
.
	`exi¡s
(
lock
)) {

47 ià(!
lock
->
	`ŒyWr™eLock
(
WRITE_SPIN
)) {

48 
	`DO_ABORT
();

51 
	`_th»ad
().
rwlock£t
.
	`push
(
lock
);

54 ià(!
lock
->
	`isWr™eLocked
()) {

55 ià(!
lock
->
	`ŒyUpg¿de
(
WRITE_SPIN
)) {

56 
	`DO_ABORT
();

60 
	}
}

	@legacy/Boosting_common.hh

1 #´agm¨
Úû


6 
	~<as£¹.h
>

8 
	~"cÚfig.h
"

9 
	~"comp”.hh
"

11 
	~"Boo¡šg_ç¡£t.hh
"

12 
	~"Boo¡šg_locks.hh
"

14 #ià!
defšed
(
BOOSTING
è|| defšed(
STO
)

18 
	#STO_NO_STM


	)

21 
	#ADD_UNDO
 
ON_ABORT


	)

22 
	#TRANS_WRITE_LOCK
 
ŒªsWr™eLock


	)

23 
	#TRANS_READ_LOCK
 
ŒªsR—dLock


	)

25 
	sboo¡šg_th»adšfo
 {

26 
	mFa¡S‘
<
	mSpšLock
*> 
	mlock£t
;

27 
	mFa¡S‘
<
	mRWLock
*> 
	mrwlock£t
;

30 
	#BOOSTING_MAX_THREADS
 16

	)

31 
boo¡šg_th»adšfo
 
boo¡šg_th»ads
[
BOOSTING_MAX_THREADS
];

32 
__th»ad
 
boo¡šg_th»adid
;

34 
šlše
 
	gboo¡šg_th»adšfo
& 
	$_th»ad
() {

35  
boo¡šg_th»ads
[
boo¡šg_th»adid
];

36 
	}
}

39 
boo¡šg_txS¹Hook
();

41 
boo¡šg_£tTh»adID
(
th»adid
);

43 
boo¡šg_»Ëa£LocksC®lback
(*, *, *);

45 
ŒªsR—dLock
(
RWLock
 *
lock
);

46 
ŒªsWr™eLock
(
RWLock
 *
lock
);

	@legacy/Boosting_fastset.hh

1 #´agm¨
Úû


3 
	~"loÿl_veùÜ.hh
"

4 
	~<¡ršg.h
>

7 
	#BOOSTING_BLOOMFILTER_SIZE
 0

	)

10 
	#BOOSTING_HASHTABLE_SIZE
 1024

	)

12 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gSize
 = 512>

13 şas 
	cFa¡S‘
 {

14 
public
:

15 #ià
BOOSTING_HASHTABLE_SIZE


16 
cÚ¡ex´
 
ušt16_t
 
max_ba£
 = 1<<15;

18 
	$Fa¡S‘
(è: 
	$lockVec_
()

19 #ià
BOOSTING_HASHTABLE_SIZE


20 , 
	`hash_ba£_
(0), 
	$hashbË_
()

22 #ià
BOOSTING_BLOOMFILTER_SIZE


23 , 
	$bloom_
()

26 
	$push
(
T
& 
obj
) {

27 
lockVec_
.
	`push_back
(
obj
);

28 #ià
BOOSTING_BLOOMFILTER_SIZE


29 
ušt64_t
 
hash
 = 
	`bloom_hash
(
obj
);

30 
ušt64_t
 
idx
 = 
hash
 / 64;

31 
hash
 = hash % 64;

32 
bloom_
[
idx
] |ğ1 << 
hash
;

34 #ià
BOOSTING_HASHTABLE_SIZE


35 auto& 
h
 = 
hashbË_
[
	`hash
(
obj
)];

36 ià(
h
 <ğ
hash_ba£_
)

37 
h
 = 
hash_ba£_
 + 
lockVec_
.
	`size
();

39 
	}
}

40 
ty³Çme
 
	gloÿl_veùÜ
<
	gT
, 
	gSize
>::
™”©Ü
 
	$fšd
 (
T
& 
obj
) {

41 autØ
™
 = 
lockVec_
.
	`begš
();

42 autØ
’d
 = 
lockVec_
.
	`’d
(); 
™
 !=ƒnd; ++it) {

43 ià(*
™
 =ğ
obj
) {

44  
™
;

47  
™
;

48 
	}
}

49 
ty³Çme
 
	gloÿl_veùÜ
<
	gT
, 
	gSize
>::
™”©Ü
 
	$begš
 () {

50  
lockVec_
.
	`begš
();

51 
	}
}

52 
ty³Çme
 
	gloÿl_veùÜ
<
	gT
, 
	gSize
>::
™”©Ü
 
	$’d
 () {

53  
lockVec_
.
	`’d
();

54 
	}
}

55 
boŞ
 
	$exi¡s
(
T
& 
obj
) {

56 #ià
BOOSTING_BLOOMFILTER_SIZE


57 ià(
	`defš™–y_ab£Á
(
obj
))

58  
çl£
;

60 #ià
BOOSTING_HASHTABLE_SIZE


61 autØ
idx
 = 
hashbË_
[
	`hash
(
obj
)];

62 ià(
idx
 <ğ
hash_ba£_
)

63  
çl£
;

64 ià(
lockVec_
[
idx
 - 
hash_ba£_
 - 1] =ğ
obj
)

65  
Œue
;

67  
	`fšd
(
obj
è!ğ
lockVec_
.
	`’d
();

68 
	}
}

69 
	$ş—r
() {

70 #ià
BOOSTING_HASHTABLE_SIZE


71 
hash_ba£_
 +ğ
lockVec_
.
	`size
();

72 ià(
hash_ba£_
 >ğ
max_ba£
) {

73 
	`mem£t
(
hashbË_
, 0, (hashtable_));

74 
hash_ba£_
 = 0;

77 
lockVec_
.
	`ş—r
();

78 #ià
BOOSTING_BLOOMFILTER_SIZE


79 
	`mem£t
(
bloom_
, 0, (bloom_));

81 
	}
}

82 
	$un§ã_ş—r
() {

83 #ià
BOOSTING_HASHTABLE_SIZE


84 
hash_ba£_
 +ğ
lockVec_
.
	`size
();

85 ià(
hash_ba£_
 >ğ
max_ba£
) {

86 
	`mem£t
(
hashbË_
, 0, (hashtable_));

87 
hash_ba£_
 = 0;

90 
lockVec_
.
	`un§ã_ş—r
();

91 #ià
BOOSTING_BLOOMFILTER_SIZE


92 
	`mem£t
(
bloom_
, 0, (bloom_));

94 
	}
}

95 
boŞ
 
	$š£¹
(
T
& 
obj
) {

96 ià(
	`exi¡s
(
obj
))

97  
çl£
;

98 
lockVec_
.
	`push_back
(
obj
);

99  
Œue
;

100 
	}
}

101 
boŞ
 
	$”a£
(
T
& 
obj
) {

102 autØ
™
 = 
	`fšd
(
obj
);

103 ià(
™
 !ğ
lockVec_
.
	`’d
()) {

104 
lockVec_
.
	`”a£
(
™
);

105  
Œue
;

107  
çl£
;

108 
	}
}

109 
	g´iv©e
:

110 
loÿl_veùÜ
<
T
, 
	gSize
> 
	glockVec_
;

111 #ià
BOOSTING_HASHTABLE_SIZE


112 
ušt16_t
 
	ghash_ba£_
;

113 
ušt16_t
 
	ghashbË_
[
BOOSTING_HASHTABLE_SIZE
];

114 
šlše
 
	$hash
(
T
& 
obj
) {

115 
ušŒ_t
 
n
 = (ušŒ_t)
obj
;

117  (
n
 + (n>>16)*9è% 
BOOSTING_HASHTABLE_SIZE
;

118  ((
n
 >> 4è^ (À>> 20)è% 
BOOSTING_HASHTABLE_SIZE
;

119 
	}
}

121 #ià
BOOSTING_BLOOMFILTER_SIZE


122 
ušt64_t
 
	gbloom_
[
BOOSTING_BLOOMFILTER_SIZE
 / 64];

123 
šlše
 
ušt64_t
 
	$bloom_hash
(
T
& 
obj
) {

125  (((
šŒ_t
)
obj
 >> 2è^ ((šŒ_t)obj >> 5)è% 
BOOSTING_BLOOMFILTER_SIZE
;

126 
	}
}

127 
	gpublic
:

128 
šlše
 
boŞ
 
	$defš™–y_ab£Á
(
T
& 
obj
) {

129 
ušt64_t
 
hash
 = 
	`bloom_hash
(
obj
);

130 
idx
 = 
hash
 / 64;

131 
hash
 = hash % 64;

132  !((1<<
hash
è& 
bloom_
[
idx
]);

133 
	}
}

	@legacy/Boosting_list.hh

1 #´agm¨
Úû


3 
	~"Boo¡šg_2.hh
"

4 
	~"Boo¡šg_¡o.hh
"

5 
	~"Boo¡šg_lockkey.hh
"

7 
	~"Li¡.hh
"

9 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gDu¶iÿ‹s
 = 
çl£
,y³Çm
	gCom·»
 = 
DeçuÉCom·»
<
T
>, boŞ 
	gSÜ‹d
 = 
Œue
>

10 
şass
 
T¿nsLi¡


11 #ià
defšed
(
BOOSTING
è&& defšed(
STO
)

12 : 
public
 
T¿nsUndßbË


15 
public
:

16 
Li¡
<
	tT
, 
	tDu¶iÿ‹s
, 
	tCom·»
, 
	tSÜ‹d
> 
	tšÃr_li¡_t
;

18 
T¿nsLi¡
(
Com·»
 
comp
 = Com·»()è: 
li¡_
(comp), 
li¡lock_
() {}

20 
_undoIn£¹
(*
£lf
, *
c1
, *
c2
) {

22 ((
	gT¿nsLi¡
*)
	g£lf
)->
	gli¡_
.
‹m¶©e
 
	g»move
<
	gçl£
>((
	gT
){ 
	gc1
, 
	gc2
 });

26 
_undoD–‘e
(*
£lf
, *
c1
, *
c2
) {

27 
T
* 
	g–em
 = (T*)
c1
;

28 ((
	gT¿nsLi¡
*)
	g£lf
)->
	gli¡_
.
š£¹
(*
–em
);

29 
d–‘e
 
	g–em
;

32 
boŞ
 
ŒªsIn£¹
(cÚ¡ 
T
& 
–em
) {

34 
¡©ic_as£¹
((
T
) == 16, "we‡ssume T is…air_t");

35 
TRANS_WRITE_LOCK
(&
li¡lock_
);

36 
boŞ
 
	gš£¹ed
 = 
li¡_
.
š£¹
(
–em
);

37 ià(
	gš£¹ed
) {

38 *
	gwÜds
[2];

39 
Ãw
 (
wÜds
è
T
(
–em
);

40 
ADD_UNDO
(
T¿nsLi¡
::
_undoIn£¹
, 
this
, 
wÜds
[0], words[1]);

42  
	gš£¹ed
;

45 
T
* 
ŒªsFšd
(cÚ¡ T& 
–em
) {

46 
´štf
("never happens\n");

47 
TRANS_READ_LOCK
(&
li¡lock_
);

48 
T
* 
	g»t
 = 
li¡_
.
fšd
(
–em
);

49  
	g»t
;

52 
boŞ
 
ŒªsD–‘e
(cÚ¡ 
T
& 
–em
) {

53 
´štf
("never happensƒither\n");

54 
TRANS_WRITE_LOCK
(&
li¡lock_
);

55 
boŞ
 
	g»moved
 = 
li¡_
.
‹m¶©e
 
»move
<
çl£
>(
–em
);

56 ià(
	g»moved
) {

57 
ADD_UNDO
(
T¿nsLi¡
::
_undoD–‘e
, 
this
, 
Ãw
 
T
(
–em
), 
NULL
);

59  
	g»moved
;

62 
ty³Çme
 
	gšÃr_li¡_t
::
Li¡I‹r
 
ŒªsI‹r
() {

63 
TRANS_READ_LOCK
(&
li¡lock_
);

64  
	gli¡_
.
™”
();

67 
ty³Çme
 
	gšÃr_li¡_t
::
Li¡I‹r
 
™”
() {

68  
li¡_
.
™”
();

71 
size_t
 
ŒªsSize
() {

72 
TRANS_READ_LOCK
(&
li¡lock_
);

73  
	gli¡_
.
size
();

76 
	g´iv©e
:

77 
šÃr_li¡_t
 
li¡_
;

78 
RWLock
 
	gli¡lock_
;

	@legacy/Boosting_lockkey.hh

1 #´agm¨
Úû


3 
	~"Boo¡šg_2.hh
"

4 
	~"Boo¡šg_¡o.hh
"

5 
	~"Boo¡šg_locks.hh
"

7 
	~"HashbË.hh
"

9 
	g‹m¶©e
 <
ty³Çme
 
	gK
, 
	gIn™_size
 = 129,y³Çm
	gHash
 = 
¡d
::
hash
<
K
>,y³Çm
	gP»d
 = std::
equ®_to
<K>>

10 şas 
	cLockKey
 {

11 
public
:

12 
LockKey
(
size
 = 
In™_size
, 
Hash
 
h
 = Hash(), 
P»d
 
p
 = 
	$P»d
()è: 
	$lockM­
(
size
, 
h
, 
p
) {}

14 
	$»adLock
(cÚ¡ 
K
& 
key
) {

15 
RWLock
 *
lock
 = 
	`g‘Lock
(
key
);

16 
	`TRANS_READ_LOCK
(
lock
);

17 
	}
}

19 
	$wr™eLock
(cÚ¡ 
K
& 
key
) {

20 
RWLock
 *
lock
 = 
	`g‘Lock
(
key
);

21 
	`TRANS_WRITE_LOCK
(
lock
);

22 
	}
}

24 
	gpublic
:

25 
HashbË
<
K
, 
	gRWLock
, 
	gŒue
, 
	gIn™_size
, RWLock, 
	gHash
, 
	gP»d
> 
	glockM­
;

27 
RWLock
 *
	$g‘Lock
(cÚ¡ 
K
& 
key
) {

28 
RWLock
 *
lock
 = 
lockM­
.
	`»adPŒ
(
key
);

29 ià(!
lock
) {

32 
lock
 = 
lockM­
.
	`putIfAb£ÁPŒ
(
key
, 
	`RWLock
());

34  
lock
;

35 
	}
}

	@legacy/Boosting_locks.hh

1 #´agm¨
Úû


3 
	~"cÚfig.h
"

4 
	~"comp”.hh
"

8 
	#READ_SPIN
 100000

	)

10 
	#WRITE_SPIN
 100000

	)

13 şas 
	cSpšLock
 {

14 
	mpublic
:

15 
ušt64_t
 
	tlock_ty³
;

16 
	m´iv©e
:

17 
lock_ty³
 
lock
;

19 
cÚ¡ex´
 
lock_ty³
 
	mlock_b™
 =†ock_type(1) << ((lock_type) * 8 - 1);

21 
	mpublic
:

22 
	$SpšLock
(è: 
	$lock
(0) {}

24 
boŞ
 
	$ŒyLock
(
¥š
 = 0) {

25 
¥š
 >= 0) {

26 
lock_ty³
 
cur
 = 
lock
;

27 ià(!(
cur
 & 
lock_b™
è&& 
	`boŞ_cmpxchg
(&
lock
, cur,†ock_bit)) {

28  
Œue
;

30 
¥š
--;

31 
	`»Ïx_ãnû
();

33  
çl£
;

34 
	}
}

36 
	$uÆock
() {

37 
	`ãnû
();

38 
lock
 = 0;

39 
	}
}

46 şas 
	cRWLock
 {

47 
	mpublic
:

48 
ušt64_t
 
	tlock_ty³
;

49 
	m´iv©e
:

50 
lock_ty³
 
lock
;

52 
cÚ¡ex´
 
lock_ty³
 
	mwr™e_lock_b™
 =†ock_type(1) << ((lock_type) * 8 - 1);

53 
cÚ¡ex´
 
lock_ty³
 
	mwa™šg_wr™e_b™
 =†ock_type(1) << ((lock_type) * 8 - 2);

54 
cÚ¡ex´
 
lock_ty³
 
	m»ad”Mask
 = ~(
wr™e_lock_b™
 | 
wa™šg_wr™e_b™
);

57 
	mpublic
:

58 
	$RWLock
(è: 
	$lock
(0) {}

60 
boŞ
 
	$ŒyR—dLock
(
¥š
 = 0) {

61 
¥š
 >= 0) {

62 
lock_ty³
 
cur
 = 
lock
;

63 
	`ãnû
();

64 ià(!(
cur
 & 
wr™e_lock_b™
è&& !(cu¸& 
wa™šg_wr™e_b™
)) {

66 
lock_ty³
 
´ev
 = 
	`__sync_ãtch_ªd_add
(&
lock
, 1);

68 ià((
´ev
 & 
wr™e_lock_b™
è|| (´ev & 
wa™šg_wr™e_b™
)) {

69 
	`__sync_ãtch_ªd_add
(&
lock
, -1);

71 
	`acquœe_ãnû
();

72  
Œue
;

75 
¥š
--;

76 
	`»Ïx_ãnû
();

78  
çl£
;

79 
	}
}

81 
	$»adUÆock
() {

82 
	`as£¹
(
lock
 & 
»ad”Mask
);

83 
	`__sync_ãtch_ªd_add
(&
lock
, -1);

84 
	}
}

86 
boŞ
 
	$ŒyWr™eLock
(
¥š
 = 0) {

87 
boŞ
 
»gi¡”ed
 = 
çl£
;

88 
¥š
 >= 0) {

89 
lock_ty³
 
cur
 = 
lock
;

90 
	`ãnû
();

91 ià(!(
cur
 & 
wr™e_lock_b™
è&& !(cu¸& 
»ad”Mask
)) {

94 ià(
	`boŞ_cmpxchg
(&
lock
, 
cur
, 
wr™e_lock_b™
)) {

95 
	`acquœe_ãnû
();

96  
Œue
;

100 ià(!(
cur
 & 
wa™šg_wr™e_b™
è&& 
¥š
 > 0) {

101 
lock_ty³
 
´ev
 = 
	`__sync_ãtch_ªd_Ü
(&
lock
, 
wa™šg_wr™e_b™
);

102 
»gi¡”ed
 = !(
´ev
 & 
wa™šg_wr™e_b™
);

104 
¥š
--;

105 
	`»Ïx_ãnû
();

107 ià(
»gi¡”ed
) {

108 
	`__sync_ãtch_ªd_ªd
(&
lock
, ~
wa™šg_wr™e_b™
);

110  
çl£
;

111 
	}
}

113 
	$wr™eUÆock
() {

114 
	`__sync_ãtch_ªd_ªd
(&
lock
, ~
wr™e_lock_b™
);

115 
	}
}

119 
boŞ
 
	$ŒyUpg¿de
(
¥š
 = 0) {

120 
lock_ty³
 
cur
 = 
lock
;

121 
	`as£¹
(
cur
 & 
»ad”Mask
);

123 ià((
cur
 & 
wa™šg_wr™e_b™
è|| (
	`__sync_ãtch_ªd_Ü
(&
lock
, waiting_write_bit) & waiting_write_bit)) {

129  
çl£
;

131 
	`ãnû
();

132 
¥š
 >= 0) {

134 
lock_ty³
 
cur
 = 
lock
;

137 ià((
cur
 & 
»ad”Mask
) == 1) {

142 ià(
	`boŞ_cmpxchg
(&
lock
, 
cur
, 
wr™e_lock_b™
)) {

143 
	`acquœe_ãnû
();

144  
Œue
;

147 
¥š
--;

148 
	`»Ïx_ãnû
();

151 
	`__sync_ãtch_ªd_ªd
(&
lock
, ~
wa™šg_wr™e_b™
);

152  
çl£
;

153 
	}
}

156 
boŞ
 
	$isWr™eLocked
() {

157 
lock_ty³
 
cur
 = 
lock
;

158 
	`ãnû
();

159  (
cur
 & 
wr™e_lock_b™
);

160 
	}
}

	@legacy/Boosting_map.hh

1 #´agm¨
Úû


3 
	~"Boo¡šg_2.hh
"

4 
	~"Boo¡šg_¡o.hh
"

5 
	~"Boo¡šg_lockkey.hh
"

7 
	~"HashbË.hh
"

8 
	~"RBT»e.hh
"

10 
	#VOIDP
(
x
è((*)(
ušŒ_t
)(x))

	)

12 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gV
, 
	gIn™_size
 = 129,y³Çm
	gHash
 = 
¡d
::
hash
<
K
>,y³Çm
	gP»d
 = std::
equ®_to
<K>,

13 
ty³Çme
 
	gM­Ty³
 = 
HashbË
<
K
, 
	gV
, 
	gŒue
, 
	gIn™_size
, V, 
	gHash
, 
	gP»d
>>

14 
şass
 
	gT¿nsM­


15 #ià
defšed
(
BOOSTING
è&& defšed(
STO
)

16 : 
public
 
T¿nsUndßbË


19 
public
:

20 
M­Ty³
 
	tm­_ty³
;

21 
	g´iv©e
:

22 
M­Ty³
 
m­_
;

23 
	gLockKey
<
	gK
, 
	gIn™_size
, 
	gHash
, 
	gP»d
> 
	glockKey_
;

25 
	gpublic
:

26 
K
 
	tKey
;

27 
V
 
	tV®ue
;

29 
T¿nsM­
(è: 
m­_
(), 
lockKey_
(
In™_size
, 
Hash
(), 
P»d
()) {}

31 
T¿nsM­
(
M­Ty³
&& 
m­
, 
size
 = 
In™_size
, 
Hash
 
h
 = Hash(), 
P»d
 
p
 = P»d()è: 
m­_
(
¡d
::
move
(m­)), 
lockKey_
(size, h,…) {}

33 
boŞ
 
ŒªsG‘
(cÚ¡ 
Key
& 
k
, 
V®ue
& 
»tv®
) {

34 
	glockKey_
.
»adLock
(
k
);

35  
	gm­_
.
nÚŒªs_fšd
(
k
, 
»tv®
);

38 
boŞ
 
»move
(cÚ¡ 
Key
& 
k
) {

39  
	gm­_
.
nÚŒªs_»move
(
k
);

41 
boŞ
 
š£¹
(cÚ¡ 
Key
& 
k
, cÚ¡ 
V®ue
& 
v®
) {

42  
	gm­_
.
nÚŒªs_š£¹
(
k
, 
v®
);

44 
boŞ
 
»ad
(cÚ¡ 
Key
& 
k
, 
V®ue
& 
v®
) {

45  
	gm­_
.
nÚŒªs_fšd
(
k
, 
v®
);

48 
_undoD–‘e
(*
£lf
, *
c1
, *
c2
) {

49 
¡©ic_as£¹
((
Key
) <= 8, "must berivial‡nd word sized");

50 
¡©ic_as£¹
((
V®ue
) <= 8, "must berivial‡nd word sized");

51 
Key
 
	gkey
 = (Key)(
ušŒ_t
)
c1
;

52 
V®ue
 
	gv®
 = (V®ue)(
ušŒ_t
)
c2
;

53 
boŞ
 
	gš£¹ed
 = ((
T¿nsM­
*)
£lf
)->
m­_
.
nÚŒªs_š£¹
(
key
, 
v®
);

54 
as£¹
(
š£¹ed
);

60 
_undoIn£¹
(*
£lf
, *
c1
, *
c2
) {

61 
Key
 
	gkey
 = (Key)(
ušŒ_t
)
c1
;

62 
boŞ
 
	gsucûss
 = ((
T¿nsM­
*)
£lf
)->
m­_
.
nÚŒªs_»move
(
key
);

63 
as£¹
(
sucûss
);

67 
boŞ
 
ŒªsD–‘e
(cÚ¡ 
Key
& 
k
) {

68 
	glockKey_
.
wr™eLock
(
k
);

69 
V®ue
 
	gŞdv®
;

70 
boŞ
 
	gsucûss
 = 
m­_
.
nÚŒªs_»move
(
k
, 
Şdv®
);

71 ià(
	gsucûss
) {

72 
ADD_UNDO
(
T¿nsM­
::
_undoD–‘e
, 
this
, 
VOIDP
(
k
), VOIDP(
Şdv®
));

75  
	gsucûss
;

78 
boŞ
 
ŒªsIn£¹
(cÚ¡ 
Key
& 
k
, cÚ¡ 
V®ue
& 
v®
) {

79 
	glockKey_
.
wr™eLock
(
k
);

80 
boŞ
 
	gsucûss
 = 
m­_
.
nÚŒªs_š£¹
(
k
, 
v®
);

82 ià(
	gsucûss
) {

83 
ADD_UNDO
(
T¿nsM­
::
_undoIn£¹
, 
this
, 
VOIDP
(
k
), 
NULL
);

86  
	gsucûss
;

93 #ifdeà
USE_HASHTABLE


95 
_undoS‘
(*
£lf
, *
c1
, *
c2
) {

96 
Key
 
	gkey
 = (Key)(
ušŒ_t
)
c1
;

97 
V®ue
 
	gv®ue
 = (V®ue)(
ušŒ_t
)
c2
;

98 
boŞ
 
	gexi¡s
 = ((
T¿nsM­
*)
£lf
)->
m­_
.
put
(
key
, 
v®ue
);

99 
as£¹
(
exi¡s
);

103 
ŒªsPut
(cÚ¡ 
Key
& 
k
, cÚ¡ 
V®ue
& 
v®
) {

104 
	glockKey_
.
wr™eLock
(
k
);

105 
V®ue
 
	gŞdv®
;

106 
boŞ
 
	gexi¡s
 = 
m­_
.
put_g‘Şd
(
k
, 
v®
, 
Şdv®
);

107 ià(
	gexi¡s
) {

108 
ADD_UNDO
(
T¿nsM­
::
_undoS‘
, 
this
, 
VOIDP
(
k
), VOIDP(
Şdv®
));

110 
ADD_UNDO
(
T¿nsM­
::
_undoIn£¹
, 
this
, 
VOIDP
(
k
), 
NULL
);

113 
boŞ
 
ŒªsUpd©e
(cÚ¡ 
Key
& 
k
, cÚ¡ 
V®ue
& 
v®
) {

114 
	glockKey_
.
wr™eLock
(
k
);

115 
V®ue
 
	gŞdv®
;

116 
boŞ
 
	gth”e
 = 
m­_
.
nÚŒªs_fšd
(
k
, 
Şdv®
);

117 
boŞ
 
	gexi¡s
 = 
m­_
.
‹m¶©e
 
put
<
çl£
 , 
	gŒue
 >(
	gk
, 
	gv®
);

118 
as£¹
(
th”e
 =ğ
exi¡s
);

119 ià(
	gth”e
) {

120 
ADD_UNDO
(
T¿nsM­
::
_undoS‘
, 
this
, 
VOIDP
(
k
), VOIDP(
Şdv®
));

122  
	gth”e
;

124 
V®ue
 
un§ã_g‘
(cÚ¡ 
Key
& 
k
) {

125  
	gm­_
.
un§ã_g‘
(
k
);

	@legacy/Boosting_standalone.cc

1 
	~"Boo¡šg_¡ªd®Úe.hh
"

3 
Boo¡šg
 
	g__boo¡šgŒª§ùiÚs
[
BOOSTING_MAX_THREADS
];

	@legacy/Boosting_standalone.hh

1 #´agm¨
Úû


3 #ià
defšed
(
BOOSTING
è&& defšed(
BOOSTING_STANDALONE
)

4 
	~"loÿl_veùÜ.hh
"

5 
	~"Boo¡šg_commÚ.hh
"

7 şas 
	cBoo¡šg
 {

8 
	mpublic
:

9 şas 
	cAbÜt
 {};

10 (*
	tC®lback
)(*, *, *);

12 
	$Boo¡šg
(è: 
	`comm™C®lbacks
(), 
	$abÜtC®lbacks
(è{
	}
}

14 
	$did_comm™
() {

15 autØ
™
 = 
comm™C®lbacks
.
	`begš
(); iˆ!ğcomm™C®lbacks.
	`’d
(); ++it) {

16 auto& 
cb
 = *
™
;

17 
cb
.
	`ÿÎback
(cb.
cÚ‹xt1
, cb.
cÚ‹xt2
, cb.
cÚ‹xt3
);

19 
abÜtC®lbacks
.
	`un§ã_ş—r
();

20 
comm™C®lbacks
.
	`un§ã_ş—r
();

21 
	}
}

22 
	$did_abÜt
() {

24 autØ
™
 = 
abÜtC®lbacks
.
	`rbegš
(); iˆ!ğabÜtC®lbacks.
	`»nd
(); ++it) {

25 auto& 
cb
 = *
™
;

26 
cb
.
	`ÿÎback
(cb.
cÚ‹xt1
, cb.
cÚ‹xt2
, cb.
cÚ‹xt3
);

29 
abÜtC®lbacks
.
	`un§ã_ş—r
();

30 
comm™C®lbacks
.
	`un§ã_ş—r
();

31 
	}
}

33 
	$add_comm™_ÿÎback
(
C®lback
 
func
, *
c1
, *
c2
, *
c3
) {

34 
comm™C®lbacks
.
	`em¶aû_back
(
func
, 
c1
, 
c2
, 
c3
);

35 
	`as£¹
(
comm™C®lbacks
.
	`size
() == 1);

36 
	}
}

37 
	$add_abÜt_ÿÎback
(
C®lback
 
func
, *
c1
, *
c2
, *
c3
) {

38 
abÜtC®lbacks
.
	`em¶aû_back
(
func
, 
c1
, 
c2
, 
c3
);

39 
	}
}

41 
	g´iv©e
:

42 
	s_C®lback
 {

43 
_C®lback
(
C®lback
 
ÿÎback
, *
cÚ‹xt1
, *
cÚ‹xt2
, *
cÚ‹xt3
) : callback(callback), context1(context1), context2(context2), context3(context3) {}

44 
C®lback
 
	gÿÎback
;

45 *
	gcÚ‹xt1
;

46 *
	gcÚ‹xt2
;

47 *
	gcÚ‹xt3
;

51 
	gloÿl_veùÜ
<
	g_C®lback
, 1> 
	gcomm™C®lbacks
;

52 
	gloÿl_veùÜ
<
	g_C®lback
, 16> 
	gabÜtC®lbacks
;

55 
Boo¡šg
 
__boo¡šgŒª§ùiÚs
[
BOOSTING_MAX_THREADS
];

56 
	#BOOSTING_T
(è(
__boo¡šgŒª§ùiÚs
[
boo¡šg_th»adid
])

	)

58 
	#TRANSACTION
 \

61 
	`boo¡šg_txS¹Hook
(); \

62 
Œy
 {

	)

63 
	#RETRY
(
»Œy
) \

64 
	`BOOSTING_T
().
	`did_comm™
(); \

66 } 
	`ÿtch
(
Boo¡šg
::
AbÜt
 
e
) {} \

67 
	`BOOSTING_T
().
	`did_abÜt
(); \

68 ià(!(
»Œy
)) \

69 
throw
 
Boo¡šg
::
	`AbÜt
(); \

71 } 0)

	)

73 
	#DO_ABORT
(è(
throw
 
Boo¡šg
::
	`AbÜt
())

	)

74 
	#POST_COMMIT
(
ÿÎback
, 
cÚ‹xt1
, 
cÚ‹xt2
, 
cÚ‹xt3
è
	`BOOSTING_T
().
	`add_comm™_ÿÎback
((ÿÎback), (cÚ‹xt1), (cÚ‹xt2), (cÚ‹xt3))

	)

75 
	#ON_ABORT
(
ÿÎback
, 
cÚ‹xt1
, 
cÚ‹xt2
, 
cÚ‹xt3
è
	`BOOSTING_T
().
	`add_abÜt_ÿÎback
((ÿÎback), (cÚ‹xt1), (cÚ‹xt2), (cÚ‹xt3))

	)

	@legacy/Boosting_sto.hh

1 #´agm¨
Úû


3 #ià
defšed
(
BOOSTING
è&& defšed(
STO
)

5 
	~"T¿n§ùiÚ.hh
"

6 
	~"T¿nsUndßbË.hh
"

7 
	~"T¿nsPessimi¡icLockšg.hh
"

9 
T¿nsPessimi¡icLockšg
 
__³ssimi¡Lockšg
;

11 
	#ADD_UNDO
(
ÿÎback
, 
£lf
, 
cÚ‹xt1
, 
cÚ‹xt2
è({ 
	`as£¹
(£là=ğ
this
);his->
	`add_undo
(ÿÎback, cÚ‹xt1, cÚ‹xt2); })

	)

12 
	#TRANS_READ_LOCK
(
lock
è
__³ssimi¡Lockšg
.
	`ŒªsR—dLock
Öock)

	)

13 
	#TRANS_WRITE_LOCK
(
lock
è
__³ssimi¡Lockšg
.
	`ŒªsWr™eLock
Öock)

	)

	@legacy/Boosting_tl2.hh

1 #´agm¨
Úû


3 #ià
defšed
(
BOOSTING
è&& defšed(
STM
)

4 
	~"Boo¡šg_commÚ.hh
"

5 
	~"../../../2/¡m.h
"

7 
	#DO_ABORT
(è
	`TxAbÜt
(
STM_CUR_SELF
)

	)

8 
	#POST_COMMIT
(
ÿÎback
, 
cÚ‹xt1
, 
cÚ‹xt2
, 
cÚ‹xt3
è
	`TxPo¡Comm™Hook
(
STM_CUR_SELF
, (ÿÎback), (cÚ‹xt1), (cÚ‹xt2), (cÚ‹xt3))

	)

9 
	#ON_ABORT
(
ÿÎback
, 
cÚ‹xt1
, 
cÚ‹xt2
, 
cÚ‹xt3
è
	`TxAbÜtHook
(
STM_CUR_SELF
, (ÿÎback), (cÚ‹xt1), (cÚ‹xt2), (cÚ‹xt3))

	)

	@legacy/local_vector.hh

1 #iâdeà
GSTORE_LOCAL_VECTOR_HH


2 
	#GSTORE_LOCAL_VECTOR_HH
 1

	)

3 
	~"cÚfig.h
"

4 
	~"comp”.hh
"

5 
	~<memÜy
>

6 
	~<™”©Ü
>

7 
	~<as£¹.h
>

9 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
 = 
¡d
::
®loÿtÜ
<
T
> >

10 şas 
	cloÿl_veùÜ
 {

11 
public
:

12 
boŞ
 (
	tloÿl_veùÜ
<
	tT
, 
	tN
, 
	tA
>::*
	tun¥ecif›d_boŞ_ty³
)() const;

13 
T
 
	tv®ue_ty³
;

14 
v®ue_ty³
* 
	t™”©Ü
;

15 cÚ¡ 
	tv®ue_ty³
* 
	tcÚ¡_™”©Ü
;

16 
	m¡d
::
	t»v”£_™”©Ü
<
	t™”©Ü
>„everse_iterator;

17 
	m¡d
::
	t»v”£_™”©Ü
<
	tcÚ¡_™”©Ü
> 
	tcÚ¡_»v”£_™”©Ü
;

18 
	tsize_ty³
;

20 
šlše
 
loÿl_veùÜ
(cÚ¡ 
A
& 
®loÿtÜ
 = A());

21 
loÿl_veùÜ
(cÚ¡†oÿl_veùÜ<
T
, 
N
, 
A
>& 
x
);

22 
	m‹m¶©e
 <
	mNN
, 
ty³Çme
 
	mAA
>

23 
loÿl_veùÜ
(cÚ¡†oÿl_veùÜ<
T
, 
NN
, 
AA
>& 
x
);

24 
	mšlše
 ~
loÿl_veùÜ
();

26 
šlše
 
size_ty³
 
	$size
() const;

27 
šlše
 
size_ty³
 
	$ÿ·c™y
() const;

28 
šlše
 
boŞ
 
	$em±y
() const;

29 
šlše
 
İ”©Ü
 
	$un¥ecif›d_boŞ_ty³
() const;

30 
šlše
 
boŞ
 
İ”©Ü
!() const;

32 
šlše
 
™”©Ü
 
	`begš
();

33 
šlše
 
™”©Ü
 
	`’d
();

34 
šlše
 
cÚ¡_™”©Ü
 
	$begš
() const;

35 
šlše
 
cÚ¡_™”©Ü
 
	$’d
() const;

36 
šlše
 
cÚ¡_™”©Ü
 
	$cbegš
() const;

37 
šlše
 
cÚ¡_™”©Ü
 
	$ûnd
() const;

38 
šlše
 
»v”£_™”©Ü
 
	`rbegš
();

39 
šlše
 
»v”£_™”©Ü
 
	`»nd
();

40 
šlše
 
cÚ¡_»v”£_™”©Ü
 
	$rbegš
() const;

41 
šlše
 
cÚ¡_»v”£_™”©Ü
 
	$»nd
() const;

42 
šlše
 
cÚ¡_»v”£_™”©Ü
 
	$übegš
() const;

43 
šlše
 
cÚ¡_»v”£_™”©Ü
 
	$ü’d
() const;

45 
šlše
 
v®ue_ty³
& 
İ”©Ü
[](
size_ty³
 
i
);

46 
šlše
 cÚ¡ 
v®ue_ty³
& 
İ”©Ü
[](
size_ty³
 
i
) const;

47 
šlše
 
v®ue_ty³
& 
	`äÚt
();

48 
šlše
 cÚ¡ 
v®ue_ty³
& 
	$äÚt
() const;

49 
šlše
 
v®ue_ty³
& 
	`back
();

50 
šlše
 cÚ¡ 
v®ue_ty³
& 
	$back
() const;

52 
šlše
 
	`push_back
(cÚ¡ 
v®ue_ty³
& 
x
);

53 
šlše
 
	`push_back
(
v®ue_ty³
&& 
x
);

54 
‹m¶©e
 <
ty³Çme
... 
Args
> 
šlše
 
	`em¶aû_back
(Args&&... 
¬gs
);

55 
šlše
 
	`pİ_back
();

57 
šlše
 
	`ş—r
();

58 
šlše
 
	`un§ã_ş—r
();

59 
šlše
 
	`»size
(
size_ty³
 
n
, 
v®ue_ty³
 
x
 = 
	`v®ue_ty³
());

60 
™”©Ü
 
	`”a£
(™”©Ü 
pos™iÚ
);

61 
™”©Ü
 
	`”a£
(™”©Ü 
fœ¡
, i‹¿tÜ 
Ï¡
);

63 
šlše
 
loÿl_veùÜ
<
T
, 
N
, 
A
>& 
İ”©Ü
=(cÚ¡†oÿl_veùÜ<T, N, A>& 
x
);

64 
‹m¶©e
 <
NN
, 
ty³Çme
 
AA
>

65 
šlše
 
loÿl_veùÜ
<
T
, 
N
, 
A
>& 
İ”©Ü
=(cÚ¡†oÿl_veùÜ<T, 
NN
, 
AA
>& 
x
);

67 
´iv©e
:

68 
»p
 : 
public
 
A
 {

69 
T
* 
fœ¡_
;

70 
T
* 
Ï¡_
;

71 
T
* 
ÿ·c™y_
;

72 
lv_
[(
T
è* 
N
];

74 
šlše
 
	`»p
(cÚ¡ 
A
& 
a
);

76 
»p
 
r_
;

78 
	`grow
(
size_ty³
 
n
 = 0);

79 
	}
};

81 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

82 
šlše
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
»p
::
	$»p
(cÚ¡ 
A
& 
a
)

83 : 
	`A
(
a
), 
	`fœ¡_
(
»š‹½»t_ÿ¡
<
T
*>(
lv_
)),

84 
	`Ï¡_
(
fœ¡_
), 
	`ÿ·c™y_
(fœ¡_ + 
N
) {

85 
	}
}

87 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

88 
šlše
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$loÿl_veùÜ
(cÚ¡ 
A
& 
®loÿtÜ
)

89 : 
	$r_
(
®loÿtÜ
) {

90 
	}
}

92 
‹m¶©e
 <
ty³Çme
 
T
, 
	gN
,y³Çm
	gA
>

93 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
loÿl_veùÜ
(cÚ¡†oÿl_veùÜ<
T
, 
N
, 
A
>& 
x
)

94 : 
r_
(
	$A
()) {

95 cÚ¡ 
T
* 
™
 = 
x
.
r_
.
fœ¡_
; iˆ!ğx.r_.
Ï¡_
; ++it)

96 
	`push_back
(*
™
);

97 
	}
}

99 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>em¶©<
	gNN
,y³Çm
	gAA
>

100 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
loÿl_veùÜ
(cÚ¡†oÿl_veùÜ<
T
, 
NN
, 
AA
>& 
x
)

101 : 
r_
(
	$A
()) {

102 cÚ¡ 
T
* 
™
 = 
x
.
r_
.
fœ¡_
; iˆ!ğx.r_.
Ï¡_
; ++it)

103 
	`push_back
(*
™
);

104 
	}
}

106 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

107 
šlše
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::~
	$loÿl_veùÜ
() {

108 
T
* 
™
 = 
r_
.
fœ¡_
; iˆ!ğr_.
Ï¡_
; ++it)

109 
r_
.
	`de¡roy
(
™
);

110 ià(
r_
.
fœ¡_
 !ğ
»š‹½»t_ÿ¡
<
T
*>Ô_.
lv_
))

111 
r_
.
	`d—Îoÿ‹
Ô_.
fœ¡_
,„_.
ÿ·c™y_
 -„_.first_);

112 
	}
}

114 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

115 
šlše
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$size
() const {

116  
r_
.
Ï¡_
 -„_.
fœ¡_
;

117 
	}
}

119 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

120 
šlše
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$ÿ·c™y
() const {

121  
r_
.
ÿ·c™y_
 -„_.
fœ¡_
;

122 
	}
}

124 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

125 
šlše
 
boŞ
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$em±y
() const {

126  
r_
.
fœ¡_
 =ğr_.
Ï¡_
;

127 
	}
}

129 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

130 
šlše
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
İ”©Ü
 
	$un¥ecif›d_boŞ_ty³
() const {

131  
	`em±y
(è? 0 : &
loÿl_veùÜ
<
T
, 
N
, 
A
>::
em±y
;

132 
	}
}

134 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

135 
šlše
 
boŞ
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
İ”©Ü
!() const {

136  
em±y
();

139 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

140 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$grow
(
size_ty³
 
n
) {

141 
size_t
 
Ãwÿp
 = 
	`ÿ·c™y
() * 2;

142 
Ãwÿp
 < 
n
)

143 
Ãwÿp
 *= 2;

144 
T
* 
m
 = 
r_
.
	`®loÿ‹
(
Ãwÿp
);

145 
T
* 
™
 = 
r_
.
fœ¡_
, *
m™
 = 
m
; iˆ!ğr_.
Ï¡_
; ++it, ++mit) {

146 
r_
.
	`cÚ¡ruù
(
m™
, 
¡d
::
	`move
(*
™
));

147 
r_
.
	`de¡roy
(
™
);

149 ià(
r_
.
fœ¡_
 !ğ
»š‹½»t_ÿ¡
<
T
*>Ô_.
lv_
))

150 
r_
.
	`d—Îoÿ‹
Ô_.
fœ¡_
, 
	`ÿ·c™y
());

151 
r_
.
Ï¡_
 = 
m
 + (r_.Ï¡_ -„_.
fœ¡_
);

152 
r_
.
fœ¡_
 = 
m
;

153 
r_
.
ÿ·c™y_
 = 
m
 + 
Ãwÿp
;

154 
	}
}

156 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

157 
šlše
‡utØ
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
begš
(è-> 
™”©Ü
 {

158  
r_
.
fœ¡_
;

161 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

162 
šlše
‡utØ
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
’d
(è-> 
™”©Ü
 {

163  
r_
.
Ï¡_
;

166 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

167 
šlše
‡utØ
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$begš
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

168  
r_
.
fœ¡_
;

169 
	}
}

171 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

172 
šlše
‡utØ
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$’d
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

173  
r_
.
Ï¡_
;

174 
	}
}

176 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

177 
šlše
‡utØ
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$cbegš
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

178  
r_
.
fœ¡_
;

179 
	}
}

181 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

182 
šlše
‡utØ
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$ûnd
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

183  
r_
.
Ï¡_
;

184 
	}
}

186 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

187 
šlše
‡utØ
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
rbegš
(è-> 
»v”£_™”©Ü
 {

188  
»v”£_™”©Ü
(
’d
());

191 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

192 
šlše
‡utØ
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
»nd
(è-> 
»v”£_™”©Ü
 {

193  
»v”£_™”©Ü
(
begš
());

196 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

197 
šlše
‡utØ
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$rbegš
(ècÚ¡ -> 
cÚ¡_»v”£_™”©Ü
 {

198  
	`cÚ¡_»v”£_™”©Ü
(
	`’d
());

199 
	}
}

201 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

202 
šlše
‡utØ
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$»nd
(ècÚ¡ -> 
cÚ¡_»v”£_™”©Ü
 {

203  
	`cÚ¡_»v”£_™”©Ü
(
	`begš
());

204 
	}
}

206 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

207 
šlše
‡utØ
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$übegš
(ècÚ¡ -> 
cÚ¡_»v”£_™”©Ü
 {

208  
	`cÚ¡_»v”£_™”©Ü
(
	`’d
());

209 
	}
}

211 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

212 
šlše
‡utØ
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$ü’d
(ècÚ¡ -> 
cÚ¡_»v”£_™”©Ü
 {

213  
	`cÚ¡_»v”£_™”©Ü
(
	`begš
());

214 
	}
}

216 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

217 
šlše
 
	gT
& 
	gloÿl_veùÜ
<T, 
	gN
, 
	gA
>::
İ”©Ü
[](
size_ty³
 
i
) {

218  
r_
.
fœ¡_
[
i
];

221 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

222 
šlše
 cÚ¡ 
	gT
& 
	gloÿl_veùÜ
<T, 
	gN
, 
	gA
>::
İ”©Ü
[](
size_ty³
 
i
) const {

223  
r_
.
fœ¡_
[
i
];

226 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

227 
šlše
 
	gT
& 
	gloÿl_veùÜ
<T, 
	gN
, 
	gA
>::
	$äÚt
() {

228  
r_
.
fœ¡_
[0];

229 
	}
}

231 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

232 
šlše
 cÚ¡ 
	gT
& 
	gloÿl_veùÜ
<T, 
	gN
, 
	gA
>::
	$äÚt
() const {

233  
r_
.
fœ¡_
[0];

234 
	}
}

236 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

237 
šlše
 
	gT
& 
	gloÿl_veùÜ
<T, 
	gN
, 
	gA
>::
	$back
() {

238  
r_
.
Ï¡_
[-1];

239 
	}
}

241 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

242 
šlše
 cÚ¡ 
	gT
& 
	gloÿl_veùÜ
<T, 
	gN
, 
	gA
>::
	$back
() const {

243  
r_
.
Ï¡_
[-1];

244 
	}
}

246 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

247 
šlše
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$push_back
(cÚ¡ 
T
& 
x
) {

248 ià(
r_
.
Ï¡_
 =ğr_.
ÿ·c™y_
)

249 
	`grow
();

250 
r_
.
	`cÚ¡ruù
Ô_.
Ï¡_
, 
x
);

251 ++
r_
.
Ï¡_
;

252 
	}
}

254 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

255 
šlše
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$push_back
(
T
&& 
x
) {

256 ià(
r_
.
Ï¡_
 =ğr_.
ÿ·c™y_
)

257 
	`grow
();

258 
r_
.
	`cÚ¡ruù
Ô_.
Ï¡_
, 
¡d
::
	`move
(
x
));

259 ++
r_
.
Ï¡_
;

260 
	}
}

262 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>em¶©<
	gty³Çme
... 
	gArgs
>

263 
šlše
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$em¶aû_back
(
Args
&&... 
¬gs
) {

264 ià(
r_
.
Ï¡_
 =ğr_.
ÿ·c™y_
)

265 
	`grow
();

266 
r_
.
	`cÚ¡ruù
Ô_.
Ï¡_
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

267 ++
r_
.
Ï¡_
;

268 
	}
}

270 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

271 
šlše
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$pİ_back
() {

272 
	`as£¹
(
r_
.
fœ¡_
 !ğr_.
Ï¡_
);

273 --
r_
.
Ï¡_
;

274 
r_
.
	`de¡roy
Ô_.
Ï¡_
);

275 
	}
}

277 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

278 
šlše
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$un§ã_ş—r
() {

280 
r_
.
Ï¡_
 =„_.
fœ¡_
;

281 
	}
}

283 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

284 
šlše
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$ş—r
() {

285 autØ
™
 = 
r_
.
fœ¡_
; iˆ!ğr_.
Ï¡_
; ++it)

286 
r_
.
	`de¡roy
(
™
);

287 
r_
.
Ï¡_
 =„_.
fœ¡_
;

288 
	}
}

290 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

291 
šlše
 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$»size
(
size_ty³
 
n
, 
v®ue_ty³
 
v
) {

292 ià(
	`ÿ·c™y
(è< 
n
)

293 
	`grow
(
n
);

294 autØ
™
 = 
r_
.
fœ¡_
 + 
n
;

295 autØ
xt
 = 
r_
.
Ï¡_
;

296 
r_
.
Ï¡_
 = 
™
;

297 ; 
™
 < 
xt
; ++it)

298 
r_
.
	`de¡roy
(
™
);

299 ; 
xt
 < 
™
; ++xt)

300 
r_
.
	`cÚ¡ruù
(
xt
, 
v
);

301 
	}
}

303 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

304 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>&

305 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
İ”©Ü
=(cÚ¡ 
loÿl_veùÜ
<
T
, N, A>& 
	gx
) {

306 ià(&
	gx
 !ğ
this
) {

307 
ş—r
();

308 ià(
ÿ·c™y
(è< 
	gx
.capacity())

309 
grow
(
x
.
ÿ·c™y
());

310 autØ
	gx™
 = 
x
.
r_
.
fœ¡_
; x™ !ğx.r_.
Ï¡_
; ++x™, ++
	gr_
.
	gÏ¡_
)

311 
	gr_
.
cÚ¡ruù
(
r_
.
Ï¡_
, *
x™
);

313  *
	gthis
;

316 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>em¶©<
	gNN
,y³Çm
	gAA
>

317 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>&

318 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
İ”©Ü
=(cÚ¡ 
loÿl_veùÜ
<
T
, 
	gNN
, 
	gAA
>& 
	gx
) {

319 
ş—r
();

320 ià(
ÿ·c™y
(è< 
	gx
.capacity())

321 
grow
(
x
.
ÿ·c™y
());

322 autØ
	gx™
 = 
x
.
r_
.
fœ¡_
; x™ !ğx.r_.
Ï¡_
; ++x™, ++
	gr_
.
	gÏ¡_
)

323 
	gr_
.
cÚ¡ruù
(
r_
.
Ï¡_
, *
x™
);

324  *
	gthis
;

327 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

328 
šlše
 
T
* 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$”a£
(
™”©Ü
 
pos™iÚ
) {

329  
	`”a£
(
pos™iÚ
,…osition + 1);

330 
	}
}

332 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

333 
T
* 
	gloÿl_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$”a£
(
™”©Ü
 
fœ¡
, i‹¿tÜ 
Ï¡
) {

334 ià(
fœ¡
 !ğ
Ï¡
) {

335 
™”©Ü
 
™
 = 
fœ¡
, 
x’d
 = 
	`’d
();

336 ; 
Ï¡
 !ğ
x’d
; ++
™
, ++last)

337 *
™
 = 
¡d
::
	`move
(*
Ï¡
);

338 
r_
.
Ï¡_
 = 
™
;

339 ; 
™
 !ğ
x’d
; ++it)

340 
r_
.
	`de¡roy
(
™
);

342  
fœ¡
;

343 
	}
}

	@lib/PlatformFeatures.hh

1 #´agm¨
Úû


3 
	~<ıuid.h
>

4 
	~<c¡ddef
>

5 
	~<c¡dšt
>

6 
	~<cùy³
>

8 
	~<¡ršg
>

9 
	~<io¡»am
>

10 
	~<iomª
>

11 
	~<s¡»am
>

13 
	~<±h»ad.h
>

15 
cÚ¡ex´
 
ušt32_t
 
	gËv–_b¡r
 = 0x80000004;

17 şas 
	cReg
 : {
—x
 = 0, 
	mebx
, 
	mecx
, 
	medx
, 
	msize
};

19 şas 
	cCpuidQu”y
 {

20 
	mpublic
:

21 
cÚ¡ex´
 
ušt32_t
 
qu”y_Ëv–
 = 0;

22 
cÚ¡ex´
 
ušt32_t
 
	m»suÉ_b™
 = 0;

23 
cÚ¡ex´
 
Reg
 
	m»suÉ_»g
 = Reg::
—x
;

26 şas 
	cTscQu”y
 : 
public
 
CpuidQu”y
 {

27 
public
:

28 
cÚ¡ex´
 
ušt32_t
 
qu”y_Ëv–
 = 0x80000001;

29 
cÚ¡ex´
 
ušt32_t
 
	m»suÉ_b™
 = (1 << 27);

30 
cÚ¡ex´
 
Reg
 
	m»suÉ_»g
 = Reg::
edx
;

33 şas 
	cIvTscQu”y
 : 
public
 
CpuidQu”y
 {

34 
public
:

35 
cÚ¡ex´
 
ušt32_t
 
qu”y_Ëv–
 = 0x80000007;

36 
cÚ¡ex´
 
ušt32_t
 
	m»suÉ_b™
 = (1 << 8);

37 
cÚ¡ex´
 
Reg
 
	m»suÉ_»g
 = Reg::
edx
;

40 
	g‹m¶©e
 <
ty³Çme
 
	gQu”y
>

41 
šlše
 
boŞ
 
	$ıu_has_ã©u»
() {

42 
ušt32_t
 
max_Ëv–
 = 
	`__g‘_ıuid_max
(0x80000000, 
nuÎ±r
);

43 ià(
max_Ëv–
 < 
Qu”y
::
qu”y_Ëv–
) {

44  
çl£
;

46 
ušt32_t
 
»gs
[
¡©ic_ÿ¡
<>(
Reg
::
size
)];

47 
r
 = 
	`__g‘_ıuid
(
Qu”y
::
qu”y_Ëv–
,

48 &
»gs
[
¡©ic_ÿ¡
<>(
Reg
::
—x
)],

49 &
»gs
[
¡©ic_ÿ¡
<>(
Reg
::
ebx
)],

50 &
»gs
[
¡©ic_ÿ¡
<>(
Reg
::
ecx
)],

51 &
»gs
[
¡©ic_ÿ¡
<>(
Reg
::
edx
)]);

52 ià(
r
 == 0)

53  
çl£
;

55  (
»gs
[
¡©ic_ÿ¡
<>(
Qu”y
::
»suÉ_»g
)] & Qu”y::
»suÉ_b™
);

57 
	}
}

59 
šlše
 
	g¡d
::
¡ršg
 
	$g‘_ıu_b¿nd_¡ršg
() {

60 
ušt32_t
 
max_Ëv–
 = 
	`__g‘_ıuid_max
(0x80000000, 
nuÎ±r
);

61 ià(
max_Ëv–
 < 
Ëv–_b¡r
)

62  
¡d
::
	`¡ršg
();

64 
ušt32_t
 
»gs
[
¡©ic_ÿ¡
<>(
Reg
::
size
)];

65 
¡d
::
¡ršg
 
bs
;

66 
i
 = 0; i < 3; ++i) {

67 
r
 = 
	`__g‘_ıuid
(0x80000002 + 
i
,

68 &
»gs
[
¡©ic_ÿ¡
<>(
Reg
::
—x
)],

69 &
»gs
[
¡©ic_ÿ¡
<>(
Reg
::
ebx
)],

70 &
»gs
[
¡©ic_ÿ¡
<>(
Reg
::
ecx
)],

71 &
»gs
[
¡©ic_ÿ¡
<>(
Reg
::
edx
)]);

72 ()
r
;

73 
j
 = 0; j < 
¡©ic_ÿ¡
<>(
Reg
::
size
); ++j) {

74 
k
 = 0; k < ()(
ušt32_t
); ++k) {

75 autØ
c
 = 
»š‹½»t_ÿ¡
<*>(&
»gs
[
j
])[
k
];

76 ià(
c
 != 0x00)

77 
bs
.
	`push_back
(
c
);

81  
bs
;

82 
	}
}

84 
šlše
 
	$g‘_ıu_b¿nd_äequ’cy
() {

85 
cÚ¡ex´
 
muÉl›rs
[] = {0.001, 1.0, 1000.0};

87 
¡d
::
¡ršg
 
bs
 = 
	`g‘_ıu_b¿nd_¡ršg
();

88 
¡d
::
cout
 << "Info: CPU d‘eùed‡ " << 
bs
 << std::
’dl
;

90 
un™
 = 0;

91 
¡d
::
¡ršg
::
size_ty³
 
äeq_¡r_’d
 = 
bs
.
	`rfšd
("MHz");

92 ià(
äeq_¡r_’d
 =ğ
¡d
::
¡ršg
::
Åos
) {

93 ++
un™
;

94 
äeq_¡r_’d
 = 
bs
.
	`rfšd
("GHz");

96 ià(
äeq_¡r_’d
 =ğ
¡d
::
¡ršg
::
Åos
) {

97 ++
un™
;

98 
äeq_¡r_’d
 = 
bs
.
	`fšd
("THz");

100 ià(
äeq_¡r_’d
 =ğ
¡d
::
¡ršg
::
Åos
)

103 autØ
äeq_¡r_begš
 = 
äeq_¡r_’d
;

104 
c
;

106 --
äeq_¡r_begš
;

107 
c
 = 
bs
[
äeq_¡r_begš
];

108 } 
	`isdig™
(
c
) || (c == '.'));

109 ++
äeq_¡r_begš
;

110 autØ
Ën
 = 
äeq_¡r_’d
 - 
äeq_¡r_begš
;

111 autØ
fs
 = 
bs
.
	`sub¡r
(
äeq_¡r_begš
, 
Ën
);

112 
¡d
::
¡ršg¡»am
 
	`ss
(
fs
);

113 
äeq
;

114 
ss
 >> 
äeq
;

116  
äeq
 * 
muÉl›rs
[
un™
];

117 
	}
}

119 
šlše
 
	$d‘”mše_ıu_äeq
() {

120 
äeq
 = 0.0;

121 
¡d
::
cout
 << "Checkšg fÜ„dtsı suµÜt..." << std::
æush
;

122 ià(!
ıu_has_ã©u»
<
TscQu”y
>()) {

123 
¡d
::
cout
 << std::
’dl
;

124 
¡d
::
û¼
 << "F©®ƒ¼Ü: CPU†ack time¡am°couÁ” (tscèÿ·b™y." << std::
’dl
;

125  
äeq
;

127 
¡d
::
cout
 << " Yes" << std::
’dl
;

130 
¡d
::
cout
 << "Checkšg fÜ inv¬ŸÁsøsuµÜt..." << std::
æush
;

131 ià(!
ıu_has_ã©u»
<
IvTscQu”y
>()) {

132 
¡d
::
cout
 << std::
’dl
;

133 
¡d
::
cout
 << "Warning: CPU does‚ot„eport support for invariantsc. Please double checkiming measurement."

134 << 
¡d
::
’dl
;

136 
¡d
::
cout
 << " Yes" << std::
’dl
;

139 
¡d
::
cout
 << "D‘”mššg…roûssÜ f»qu’cy..." << std::
’dl
;

140 
äeq
 = 
	`g‘_ıu_b¿nd_äequ’cy
();

141 ià(
äeq
 == 0.0) {

142 
¡d
::
cout
 << "Warning: Can't determine…rocessorsc frequency from CPU brand string. Usinghe default value "

143 "oà1 GHz." << 
¡d
::
’dl
;

144 
äeq
 = 1.0;

146 
¡d
::
cout
 << "Info: CPUsc frequency determined‡s "

147 << 
¡d
::
fixed
 << std::
	`£»cisiÚ
(2è<< 
äeq
 << " GHz." << std::
’dl
;

148  
äeq
;

149 
	}
}

151 
šlše
 
	$£t_affš™y
(
ruÂ”_id
) {

152 
ıu_£t_t
 
ıu£t
;

153 
	`CPU_ZERO
(&
ıu£t
);

156 
ıu_id
 = 
ruÂ”_id
;

157 
	`CPU_SET
(
ıu_id
, &
ıu£t
);

158 
rc
 = 
	`±h»ad_£ffš™y_Å
(
	`±h»ad_£lf
(), (
ıu_£t_t
), &
ıu£t
);

159 ià(
rc
 != 0) {

160 
¡d
::
û¼
 << "E¼Ü c®lšg…th»ad_£ffš™y_Å: " << 
rc
 << "\n";

161 
	`abÜt
();

163 
	}
}

	@lib/StringWrapper.hh

1 #´agm¨
Úû


2 
	~<¡ršg
>

3 
	~"Pack”.hh
"

5 şas 
	cSŒšgW¿µ”
 {

6 
	mpublic
:

7 
	$SŒšgW¿µ”
(
¡d
::
¡ršg
& 
s
)

8 : 
	$¥Œ_
(&
s
) {

10 
	$SŒšgW¿µ”
(cÚ¡ 
¡d
::
¡ršg
& 
s
)

11 : 
	`¥Œ_
(
cÚ¡_ÿ¡
<
¡d
::
¡ršg
*>(&
s
)) {

12 
	}
}

13 
¡d
::
¡ršg
* 
	$v®ue
() const {

14  
¥Œ_
;

15 
	}
}

16 
İ”©Ü
 
	g¡d
::
¡ršg
&() {

17  *
¥Œ_
;

19 
İ”©Ü
 cÚ¡ 
	g¡d
::
¡ršg
&() const {

20  *
¥Œ_
;

22 
	g´iv©e
:

23 
¡d
::
¡ršg
* 
¥Œ_
;

26 
	g‹m¶©e
 <>

27 
	gPack”
<
	g¡d
::
¡ršg
, 
	gçl£
> {

28 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

29 * 
·ck
(
T¿n§ùiÚBufãr
& 
buf
, 
Args
&&... 
¬gs
) {

30  
	gbuf
.
‹m¶©e
 
	g®loÿ‹
<
	g¡d
::
¡ršg
>(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

32 * 
·ck
(
T¿n§ùiÚBufãr
&, cÚ¡ 
SŒšgW¿µ”
& 
w¿µ”
) {

33  
	gw¿µ”
.
v®ue
();

35 * 
·ck
(
T¿n§ùiÚBufãr
&, 
SŒšgW¿µ”
&& 
w¿µ”
) {

36  
	gw¿µ”
.
v®ue
();

38 * 
·ck_unique
(
T¿n§ùiÚBufãr
& 
buf
, cÚ¡ 
¡d
::
¡ršg
& 
x
) {

39 ià(cÚ¡ * 
±r
 = 
buf
.
fšd
<
UniqueKey
<
¡d
::
¡ršg
> >(
x
))

40  
cÚ¡_ÿ¡
<*>(
±r
);

42  
	gbuf
.
	g®loÿ‹
<
	gUniqueKey
<
	g¡d
::
¡ršg
> >(
x
);

44 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

45 * 
»·ck
(
T¿n§ùiÚBufãr
& 
buf
, *, 
Args
&&... 
¬gs
) {

46  
·ck
(
buf
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

48 
	g¡d
::
¡ršg
& 
uÅack
(* 
x
) {

49  *(
¡d
::
¡ršg
*è
x
;

	@lib/SystemProfiler.hh

1 #´agm¨
Úû


3 
	~<s¡»am
>

4 
	~<io¡»am
>

5 
	~<funùiÚ®
>

6 
	~<¡ršg
>

7 
	~<ÿs£¹
>

8 
	~<fú.h
>

9 
	~<sys/¡©.h
>

10 
	~<sys/wa™.h
>

11 
	~<sys/ty³s.h
>

12 
	~<uni¡d.h
>

13 
	~<sigÇl.h
>

14 
	~"comp”.hh
"

16 
Çme¥aû
 
	gProf”
 {

18 şas 
	c³rf_mode
 : { 
»cÜd
 = 1, 
	gcouÁ”s
 };

20 
pid_t
 
	$¥awn
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
³rf_mode
 
mode
) {

21 
¡d
::
¡ršg¡»am
 
ss
;

22 
ss
 << 
	`g‘pid
();

24 autØ
´ofe_Çme
 = 
Çme
 + ((
mode
 =ğ
³rf_mode
::
»cÜd
) ? ".data" : ".txt");

26 
pid_t
 
pid
 = 
	`fÜk
();

27 ià(
pid
 == 0) {

28 
cÚsŞe
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
);

29 
	`®ways_as£¹
(
cÚsŞe
 > 0);

30 
	`®ways_as£¹
(
	`dup2
(
cÚsŞe
, 
STDOUT_FILENO
) != -1);

31 
	`®ways_as£¹
(
	`dup2
(
cÚsŞe
, 
STDERR_FILENO
) != -1);

32 ià(
mode
 =ğ
³rf_mode
::
»cÜd
) {

33 
	`ex™
(
	`exeş
("/u¤/bš/³rf", "³rf", "»cÜd", "-g", "-o", 
´ofe_Çme
.
	`c_¡r
(),

34 "-p", 
ss
.
	`¡r
().
	`c_¡r
(), 
nuÎ±r
));

35 } ià(
mode
 =ğ
³rf_mode
::
couÁ”s
) {

36 
	`ex™
(
	`exeş
("/usr/bin/perf", "perf", "stat", "-e",

39 "-o", 
´ofe_Çme
.
	`c_¡r
(),

40 "-p", 
ss
.
	`¡r
().
	`c_¡r
(), 
nuÎ±r
));

44  
pid
;

45 
	}
}

47 
boŞ
 
	$¡İ
(
pid_t
 
pid
) {

48 ià(
	`kl
(
pid
, 
SIGINT
) != 0)

49  
çl£
;

50 ià(
	`wa™pid
(
pid
, 
nuÎ±r
, 0) !=…id)

51  
çl£
;

52  
Œue
;

53 
	}
}

55 
´ofe
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, std::
funùiÚ
<()> 
´of“
) {

56 
pid_t
 
pid
 = 
¥awn
(
Çme
, 
³rf_mode
::
»cÜd
);

58 
´of“
();

60 
boŞ
 
	gok
 = 
¡İ
(
pid
);

61 
®ways_as£¹
(
ok
);

64 
´ofe
(
¡d
::
funùiÚ
<()> 
´of“
) {

65 
´ofe
("³rf", 
´of“
);

	@lib/clp.c

36 #ifdeà
HAVE_CONFIG_H


37 
	~<cÚfig.h
>

39 
	~"şp.h
"

40 
	~<¡dlib.h
>

41 
	~<¡ršg.h
>

42 
	~<¡dio.h
>

43 
	~<as£¹.h
>

44 
	~<¡d¬g.h
>

45 
	~<ùy³.h
>

46 #ià
HAVE_SYS_TYPES_H


47 
	~<sys/ty³s.h
>

51 #ià!
defšed
(
HAVE_STRTOUL
è&& !defšed(
HAVE_CONFIG_H
)

52 
	#HAVE_STRTOUL
 1

	)

54 #ià
defšed
(
HAVE_INTTYPES_H
è|| !defšed(
HAVE_CONFIG_H
)

55 
	~<š‰y³s.h
>

56 #–ià!
defšed
(
HAVE_UINTPTR_T
)

57 
	tušŒ_t
;

60 #ifdeà
__ılu¥lus


158 
	#CÍ_DoubËdLÚg
 (
CÍ_LÚgIm¶ic™
 * 2)

	)

160 
	#CÍ_In™ŸlV®Ty³
 8

	)

161 
	#MAX_AMBIGUOUS_VALUES
 4

	)

164 
v®_ty³
;

165 
CÍ_V®P¬£Func
 
func
;

166 
æags
;

167 *
u£r_d©a
;

168 } 
	tCÍ_V®Ty³
;

171 
Úg
 : 1;

172 
ishÜt
 : 1;

173 
imªd©Üy
 : 1;

174 
iİtiÚ®
 : 1;

175 
os
 : 1;

176 
šeg
 : 1;

177 
»fm©ch
 : 1;

178 
lmmpos_shÜt
 : 1;

179 
lmmÃg_shÜt
 : 1;

180 
Úgoff
;

181 
lmmpos
;

182 
lmmÃg
;

183 } 
	tCÍ_IÁ”nO±iÚ
;

186 
	#CÍ_O±iÚCh¬sSize
 5

	)

189 
c
;

190 
ty³
;

191 } 
	tCÍ_Oşass
;

192 
	#CÍ_OşassSize
 10

	)

194 
	sCÍ_IÁ”Çl
 {

195 cÚ¡ 
CÍ_O±iÚ
 *
İt
;

196 
CÍ_IÁ”nO±iÚ
 *
iİt
;

197 
nİt
;

198 
İt_g’”©iÚ
;

200 
CÍ_V®Ty³
 *
v®ty³
;

201 
nv®ty³
;

203 cÚ¡ * cÚ¡ *
¬gv
;

204 
¬gc
;

206 
CÍ_Oşass
 
oşass
[
CÍ_OşassSize
];

207 
noşass
;

208 
lÚg1pos
;

209 
lÚg1Ãg
;

210 
utf8
;

212 
İtiÚ_ch¬s
[
CÍ_O±iÚCh¬sSize
];

213 cÚ¡ *
x‹xt
;

215 cÚ¡ *
´og¿m_Çme
;

216 (*
”rÜ_hªdËr
)(
CÍ_P¬£r
 *, const *);

218 
İtiÚ_´oûssšg
;

219 
cu¼’t_İtiÚ
;

221 
is_shÜt
;

222 
whŞe_Ãg©ed
;

223 
could_be_shÜt
;

224 
cu¼’t_shÜt
;

225 
Ãg©ed_by_no
;

227 
ambiguous
;

228 
ambiguous_v®ues
[
MAX_AMBIGUOUS_VALUES
];

229 } 
	tCÍ_IÁ”Çl
;

232 
	sCÍ_P¬£rS‹
 {

233 cÚ¡ * cÚ¡ *
¬gv
;

234 
¬gc
;

236 
İtiÚ_ch¬s
[
CÍ_O±iÚCh¬sSize
];

237 cÚ¡ *
x‹xt
;

239 
İtiÚ_´oûssšg
;

241 
İt_g’”©iÚ
;

242 
cu¼’t_İtiÚ
;

243 
is_shÜt
;

244 
whŞe_Ãg©ed
;

245 
cu¼’t_shÜt
;

246 
Ãg©ed_by_no
;

250 
	sCÍ_SŒšgLi¡
 {

251 
CÍ_O±iÚ
 *
™ems
;

252 
CÍ_IÁ”nO±iÚ
 *
iİt
;

253 
n™ems
;

255 
®low_št
;

256 
v®_lÚg
;

257 
n™ems_šv®id_»pÜt
;

258 } 
	tCÍ_SŒšgLi¡
;

261 cÚ¡ 
CÍ_O±iÚ
 
şp_İtiÚ_£Áš–
[] = {

262 {"", 0, 
CÍ_NÙO±iÚ
, 0, 0},

263 {"", 0, 
CÍ_DÚe
, 0, 0},

264 {"", 0, 
CÍ_BadO±iÚ
, 0, 0},

265 {"", 0, 
CÍ_E¼Ü
, 0, 0}

269 
·r£_¡ršg
(
CÍ_P¬£r
 *, const *, , *);

270 
·r£_št
(
CÍ_P¬£r
 *, const *, , *);

271 
·r£_boŞ
(
CÍ_P¬£r
 *, const *, , *);

272 
·r£_doubË
(
CÍ_P¬£r
 *, const *, , *);

273 
·r£_¡ršg_li¡
(
CÍ_P¬£r
 *, const *, , *);

275 
ambigu™y_”rÜ
(
CÍ_P¬£r
 *, , *, cÚ¡ 
CÍ_O±iÚ
 *,

276 cÚ¡ 
CÍ_IÁ”nO±iÚ
 *, const *, const *,

284 
	#U_REPLACEMENT
 0xFFFD

	)

287 
’code_utf8
(*
s
, 
n
, 
c
)

289 ià(
c
 < 0 || c >= 0x110000 || (c >= 0xD800 && c <= 0xDFFF))

290 
c
 = 
U_REPLACEMENT
;

291 ià(
c
 <ğ0x7F && 
n
 >= 1)

292 *
s
++ = 
c
;

293 ià(
c
 <ğ0x7FF && 
n
 >= 2) {

294 *
s
++ = 0xC0 | (
c
 >> 6);

295 
ch¬1
;

296 } ià(
c
 <ğ0xFFFF && 
n
 >= 3) {

297 *
s
++ = 0xE0 | (
c
 >> 12);

298 
ch¬2
;

299 } ià(
n
 >= 4) {

300 *
s
++ = 0xF0 | (
c
 >> 18);

301 *
s
++ = 0x80 | ((
c
 >> 12) & 0x3F);

302 
ch¬2
:

303 *
s
++ = 0x80 | ((
c
 >> 6) & 0x3F);

304 
ch¬1
:

305 *
s
++ = 0x80 | (
c
 & 0x3F);

307  
s
;

311 
decode_utf8
(cÚ¡ *
s
, cÚ¡ **
ı
)

313 
c
;

314 ià((è*
s
 <= 0x7F)

315 
c
 = *
s
++;

316 ià((è*
s
 <= 0xC1)

317 
»¶aûm’t
;

318 ià((è*
s
 <= 0xDF) {

319 ià((
s
[1] & 0xC0) != 0x80)

320 
»¶aûm’t
;

321 
c
 = (*
s
++ & 0x1F) << 6;

322 
ch¬1
;

323 } ià((è*
s
 <= 0xEF) {

324 ià((
s
[1] & 0xC0) != 0x80

325 || (
s
[2] & 0xC0) != 0x80

326 || ((è*
s
 == 0xE0

327 && (
s
[1] & 0xE0) == 0x80)

328 || ((è*
s
 == 0xED

329 && (
s
[1] & 0xE0) == 0xA0))

330 
»¶aûm’t
;

331 
c
 = (*
s
++ & 0x0F) << 12;

332 
ch¬2
;

333 } ià((è*
s
 <= 0xF4) {

334 ià((
s
[1] & 0xC0) != 0x80

335 || (
s
[2] & 0xC0) != 0x80

336 || (
s
[3] & 0xC0) != 0x80

337 || ((è*
s
 == 0xF0

338 && (
s
[1] & 0xF0) == 0x80)

339 || ((è*
s
 == 0xF4

340 && (è
s
[1] >= 0x90))

341 
»¶aûm’t
;

342 
c
 = (*
s
++ & 0x07) << 18;

343 
c
 +ğ(*
s
++ & 0x3F) << 12;

344 
ch¬2
:

345 
c
 +ğ(*
s
++ & 0x3F) << 6;

346 
ch¬1
:

347 
c
 +ğ(*
s
++ & 0x3F);

349 
»¶aûm’t
:

350 
c
 = 
U_REPLACEMENT
;

351 
s
++; (*s & 0xC0) == 0x80; s++)

354 ià(
ı
)

355 *
ı
 = 
s
;

356  
c
;

360 
utf8_ch¬Ën
(cÚ¡ *
s
)

362 cÚ¡ *
sout
;

363 (è
decode_utf8
(
s
, &
sout
);

364  
sout
 - 
s
;

368 
şp_utf8_ch¬Ën
(cÚ¡ 
CÍ_IÁ”Çl
 *
şi
, cÚ¡ *
s
)

370  (
şi
->
utf8
 ? 
utf8_ch¬Ën
(
s
) : 1);

379 
mš_difã»Á_ch¬s
(cÚ¡ *
s
, cÚ¡ *
t
)

384 cÚ¡ *
sfœ¡
 = 
s
;

385 *
s
 && *
t
 && *s == *t)

386 
s
++, 
t
++;

387 ià(!*
s
)

388  
s
 - 
sfœ¡
;

390  
s
 - 
sfœ¡
 + 1;

394 
lÚg_as_shÜt
(cÚ¡ 
CÍ_IÁ”Çl
 *
şi
, cÚ¡ 
CÍ_O±iÚ
 *
o
,

395 
CÍ_IÁ”nO±iÚ
 *
io
, 
çu»
)

397 ià((
şi
->
lÚg1pos
 || cli->
lÚg1Ãg
è&& 
io
->
Úg
) {

398 cÚ¡ *
Çme
 = 
o
->
lÚg_Çme
 + 
io
->
Úgoff
;

399 ià(
şi
->
utf8
) {

400 
c
 = 
decode_utf8
(
Çme
, &name);

401 ià(!*
Çme
 && 
c
 && c !ğ
U_REPLACEMENT
)

402  
c
;

403 } ià(
Çme
[0] && !name[1])

404  (è
Çme
[0];

406  
çu»
;

410 
com·»_İtiÚs
(
CÍ_P¬£r
 *
şp
, cÚ¡ 
CÍ_O±iÚ
 *
o1
, 
CÍ_IÁ”nO±iÚ
 *
io1
,

411 cÚ¡ 
CÍ_O±iÚ
 *
o2
, 
CÍ_IÁ”nO±iÚ
 *
io2
)

413 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

414 
shÜt1
, 
shÜtx1
;

417 ià((!
io1
->
ishÜt
 && !io1->
Úg
è|| (!
io2
->ishort && !io2->ilong)

418 || !((
io1
->
os
 && 
io2
->osè|| (io1->
šeg
 && io2->ineg))

419 || 
o1
->
İtiÚ_id
 =ğ
o2
->option_id)

423 
shÜt1
 = (
io1
->
ishÜt
 ? 
o1
->
shÜt_Çme
 : -1);

424 
shÜtx1
 = 
lÚg_as_shÜt
(
şi
, 
o1
, 
io1
, -2);

425 ià(
shÜt1
 >ğ0 || 
shÜtx1
 >= 0) {

426 
shÜt2
 = (
io2
->
ishÜt
 ? 
o2
->
shÜt_Çme
 : -3);

427 
shÜtx2
 = 
lÚg_as_shÜt
(
şi
, 
o2
, 
io2
, -4);

428 ià(
shÜt1
 =ğ
shÜt2
)

429 
CÍ_O±iÚE¼Ü
(
şp
, "CLP iÁ”ÇÈ”rÜ: mÜthª 1 o±iÚ ha shÜˆÇm%<%c%>", 
shÜt1
);

430 ià((
shÜt1
 =ğ
shÜtx2
 || 
shÜtx1
 =ğ
shÜt2
 || shortx1 == shortx2)

431 && ((
io1
->
os
 && 
io2
->o && 
şi
->
lÚg1pos
)

432 || (
io1
->
šeg
 && 
io2
->šeg && 
şi
->
lÚg1Ãg
)))

433 
CÍ_O±iÚE¼Ü
(
şp
, "CLP iÁ”ÇÈ”rÜ: 1-ch¬†Úg‚amcÚæiù w™h shÜˆÇm%<%c%>", (
shÜt1
 =ğ
shÜtx2
 ? shÜtx2 : 
shÜtx1
));

437 ià(
io1
->
Úg
) {

438 cÚ¡ *
Çme1
 = 
o1
->
lÚg_Çme
 + 
io1
->
Úgoff
;

441 ià(
io2
->
ishÜt
 && !
io1
->
»fm©ch
) {

442 
Çme1ch¬
 = (
şi
->
utf8
 ? 
decode_utf8
(
Çme1
, 0) : () *name1);

443 ià(
Çme1ch¬
 =ğ
o2
->
shÜt_Çme
) {

444 ià(
io1
->
os
 && 
io2
->ipos)

445 
io1
->
lmmpos_shÜt
 = 1;

446 ià(
io1
->
šeg
 && 
io2
->ineg)

447 
io1
->
lmmÃg_shÜt
 = 1;

452 ià(
io2
->
Úg
) {

453 cÚ¡ *
Çme2
 = 
o2
->
lÚg_Çme
 + 
io2
->
Úgoff
;

454 ià(
¡rcmp
(
Çme1
, 
Çme2
) == 0)

455 
CÍ_O±iÚE¼Ü
(
şp
, "CLP iÁ”ÇÈ”rÜ: du¶iÿ‹†Úg‚am%<%s%>", 
Çme1
);

456 ià(
io1
->
os
 && 
io2
->o && !
¡ºcmp
(
Çme1
, 
Çme2
, io1->
lmmpos
)

457 && (!
io1
->
»fm©ch
 || 
¡ºcmp
(
Çme1
, 
Çme2
, 
¡¾’
(name1))))

458 
io1
->
lmmpos
 = 
mš_difã»Á_ch¬s
(
Çme1
, 
Çme2
);

459 ià(
io1
->
šeg
 && 
io2
->šeg && !
¡ºcmp
(
Çme1
, 
Çme2
, io1->
lmmÃg
)

460 && (!
io1
->
»fm©ch
 || 
¡ºcmp
(
Çme1
, 
Çme2
, 
¡¾’
(name1))))

461 
io1
->
lmmÃg
 = 
mš_difã»Á_ch¬s
(
Çme1
, 
Çme2
);

467 
ÿlcuÏ‹_lmm
(
CÍ_P¬£r
 *
şp
, cÚ¡ 
CÍ_O±iÚ
 *
İt
, 
CÍ_IÁ”nO±iÚ
 *
iİt
, 
nİt
)

469 
i
, 
j
;

470 
i
 = 0; i < 
nİt
; ++i) {

471 
iİt
[
i
].
lmmpos
 = iİt[i].
lmmÃg
 = 1;

472 
iİt
[
i
].
lmmpos_shÜt
 = iİt[i].
lmmÃg_shÜt
 = 0;

473 
j
 = 0; j < 
nİt
; ++j)

474 
com·»_İtiÚs
(
şp
, &
İt
[
i
], &
iİt
[i], &İt[
j
], &iopt[j]);

514 
CÍ_P¬£r
 *

515 
CÍ_NewP¬£r
(
¬gc
, cÚ¡ * cÚ¡ *
¬gv
, 
nİt
, cÚ¡ 
CÍ_O±iÚ
 *
İt
)

517 
CÍ_P¬£r
 *
şp
 = (CÍ_P¬£¸*)
m®loc
((Clp_Parser));

518 
CÍ_IÁ”Çl
 *
şi
 = (CÍ_IÁ”ÇÈ*)
m®loc
((Clp_Internal));

519 
CÍ_IÁ”nO±iÚ
 *
iİt
 = (CÍ_IÁ”nO±iÚ *)
m®loc
((CÍ_IÁ”nO±iÚè* 
nİt
);

520 ià(
şi
)

521 
şi
->
v®ty³
 = (
CÍ_V®Ty³
 *)
m®loc
((CÍ_V®Ty³è* 
CÍ_In™ŸlV®Ty³
);

522 ià(!
şp
 || !
şi
 || !
iİt
 || !şi->
v®ty³
)

523 
çed
;

525 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
CÍ_DÚe
];

526 
şp
->
Ãg©ed
 = 0;

527 
şp
->
have_v®
 = 0;

528 
şp
->
v¡r
 = 0;

529 
şp
->
u£r_d©a
 = 0;

530 
şp
->
š‹º®
 = 
şi
;

532 
şi
->
İt
 = opt;

533 
şi
->
nİt
 =‚opt;

534 
şi
->
iİt
 = iopt;

535 
şi
->
İt_g’”©iÚ
 = 0;

536 
şi
->
”rÜ_hªdËr
 = 0;

539 ià(
¬gc
 > 0) {

540 cÚ¡ *
¦ash
 = 
¡¼chr
(
¬gv
[0], '/');

541 
şi
->
´og¿m_Çme
 = 
¦ash
 ? sÏsh + 1 : 
¬gv
[0];

543 
şi
->
´og¿m_Çme
 = 0;

546 
CÍ_S‘Argum’ts
(
şp
, 
¬gc
 - 1, 
¬gv
 + 1);

550 *
s
 = 
g‘’v
("LANG");

551 
şi
->
utf8
 = (
s
 && (
¡r¡r
(s, "UTF-8") != 0 || strstr(s, "UTF8") != 0

552 || 
¡r¡r
(
s
, "utf8") != 0));

554 
şi
->
oşass
[0].
c
 = '-';

555 
şi
->
oşass
[0].
ty³
 = 
CÍ_ShÜt
;

556 
şi
->
noşass
 = 1;

557 
şi
->
lÚg1pos
 = cli->
lÚg1Ãg
 = 0;

560 
şi
->
nv®ty³
 = 0;

561 
CÍ_AddTy³
(
şp
, 
CÍ_V®SŒšg
, 0, 
·r£_¡ršg
, 0);

562 
CÍ_AddTy³
(
şp
, 
CÍ_V®SŒšgNÙO±iÚ
, 
CÍ_Di§ÎowO±iÚs
, 
·r£_¡ršg
, 0);

563 
CÍ_AddTy³
(
şp
, 
CÍ_V®IÁ
, 0, 
·r£_št
, (*è(
ušŒ_t
) 0);

564 
CÍ_AddTy³
(
şp
, 
CÍ_V®UnsigÃd
, 0, 
·r£_št
, (*è(
ušŒ_t
) 1);

565 
CÍ_AddTy³
(
şp
, 
CÍ_V®LÚg
, 0, 
·r£_št
, (*è(
ušŒ_t
) 2);

566 
CÍ_AddTy³
(
şp
, 
CÍ_V®UnsigÃdLÚg
, 0, 
·r£_št
, (*è(
ušŒ_t
) 3);

567 
CÍ_AddTy³
(
şp
, 
CÍ_V®BoŞ
, 0, 
·r£_boŞ
, 0);

568 
CÍ_AddTy³
(
şp
, 
CÍ_V®DoubË
, 0, 
·r£_doubË
, 0);

571 
CÍ_S‘O±iÚs
(
şp
, 
nİt
, 
İt
);

573  
şp
;

575 
çed
:

576 ià(
şi
 && cli->
v®ty³
)

577 
ä“
(
şi
->
v®ty³
);

578 ià(
şi
)

579 
ä“
(
şi
);

580 ià(
şp
)

581 
ä“
(
şp
);

582 ià(
iİt
)

583 
ä“
(
iİt
);

591 
CÍ_D–‘eP¬£r
(
CÍ_P¬£r
 *
şp
)

593 
i
;

594 
CÍ_IÁ”Çl
 *
şi
;

595 ià(!
şp
)

598 
şi
 = 
şp
->
š‹º®
;

601 
i
 = 0; i < 
şi
->
nv®ty³
; i++)

602 ià(
şi
->
v®ty³
[
i
].
func
 =ğ
·r£_¡ršg_li¡
) {

603 
CÍ_SŒšgLi¡
 *
ş¦
 = (CÍ_SŒšgLi¡ *)
şi
->
v®ty³
[
i
].
u£r_d©a
;

604 
ä“
(
ş¦
->
™ems
);

605 
ä“
(
ş¦
->
iİt
);

606 
ä“
(
ş¦
);

609 
ä“
(
şi
->
v®ty³
);

610 
ä“
(
şi
->
iİt
);

611 
ä“
(
şi
);

612 
ä“
(
şp
);

625 
CÍ_E¼ÜHªdËr


626 
CÍ_S‘E¼ÜHªdËr
(
CÍ_P¬£r
 *
şp
, (*
”rh
)(Clp_Parser *, const *))

628 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

629 
CÍ_E¼ÜHªdËr
 
Şd
 = 
şi
->
”rÜ_hªdËr
;

630 
şi
->
”rÜ_hªdËr
 = 
”rh
;

631  
Şd
;

647 
CÍ_S‘UTF8
(
CÍ_P¬£r
 *
şp
, 
utf8
)

649 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

650 
Şd_utf8
 = 
şi
->
utf8
;

651 
şi
->
utf8
 = utf8;

652 
ÿlcuÏ‹_lmm
(
şp
, 
şi
->
İt
, cli->
iİt
, cli->
nİt
);

653  
Şd_utf8
;

664 
CÍ_O±iÚCh¬
(
CÍ_P¬£r
 *
şp
, 
c
)

666 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

667 
i
, 
oşass
 = 0;

668 ià(
şi
->
noşass
 > 0 && cli->
oşass
[0].
c
 == 0)

669 
oşass
 = 
şi
->oşass[0].
ty³
;

670 
i
 = 0; i < 
şi
->
noşass
; ++i)

671 ià(
şi
->
oşass
[
i
].
c
 == c)

672 
oşass
 = 
şi
->oşass[
i
].
ty³
;

673  
oşass
;

722 
CÍ_S‘O±iÚCh¬
(
CÍ_P¬£r
 *
şp
, 
c
, 
ty³
)

724 
i
, 
lÚg1pos
, 
lÚg1Ãg
;

725 
Şd
 = 
CÍ_O±iÚCh¬
(
şp
, 
c
);

726 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

728 ià(
ty³
 !ğ
CÍ_NÙO±iÚ
 &&y³ !ğ
CÍ_ShÜt
 &&y³ !ğ
CÍ_LÚg


729 && 
ty³
 !ğ
CÍ_ShÜtNeg©ed
 &&y³ !ğ
CÍ_LÚgNeg©ed


730 && 
ty³
 !ğ
CÍ_LÚgIm¶ic™
 &&y³ !ğ(
CÍ_ShÜt
 | 
CÍ_LÚg
)

731 && 
ty³
 !ğ(
CÍ_ShÜtNeg©ed
 | 
CÍ_LÚgNeg©ed
))

733 ià(
c
 < 0 || c >ğ(
şi
->
utf8
 ? 0x110000 : 256))

736 ià(
c
 == 0)

737 
şi
->
noşass
 = 0;

738 
i
 = 0; i < 
şi
->
noşass
; ++i)

739 ià(
şi
->
oşass
[
i
].
c
 == c)

741 ià(
i
 =ğ
CÍ_OşassSize
)

744 
şi
->
oşass
[
i
].
c
 = c;

745 
şi
->
oşass
[
i
].
ty³
 =ype;

746 ià(
şi
->
noşass
 =ğ
i
)

747 
şi
->
noşass
 = 
i
 + 1;

749 
lÚg1pos
 = 
lÚg1Ãg
 = 0;

750 
i
 = 0; i < 
şi
->
noşass
; ++i) {

751 ià((
şi
->
oşass
[
i
].
ty³
 & 
CÍ_ShÜt
)

752 && (
şi
->
oşass
[
i
].
ty³
 & 
CÍ_LÚg
))

753 
lÚg1pos
 = 1;

754 ià((
şi
->
oşass
[
i
].
ty³
 & 
CÍ_ShÜtNeg©ed
)

755 && (
şi
->
oşass
[
i
].
ty³
 & 
CÍ_LÚgNeg©ed
))

756 
lÚg1Ãg
 = 1;

759 ià(
lÚg1pos
 !ğ
şi
->lÚg1po || 
lÚg1Ãg
 != cli->long1neg) {

761 
şi
->
lÚg1pos
 =†ong1pos;

762 
şi
->
lÚg1Ãg
 =†ong1neg;

763 
ÿlcuÏ‹_lmm
(
şp
, 
şi
->
İt
, cli->
iİt
, cli->
nİt
);

766  
Şd
;

797 
CÍ_S‘O±iÚs
(
CÍ_P¬£r
 *
şp
, 
nİt
, cÚ¡ 
CÍ_O±iÚ
 *
İt
)

799 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

800 
CÍ_IÁ”nO±iÚ
 *
iİt
;

801 
i
;

802 
İt_g’”©iÚ
 = 0;

804 ià(
nİt
 > 
şi
->nopt) {

805 
iİt
 = (
CÍ_IÁ”nO±iÚ
 *)
m®loc
((CÍ_IÁ”nO±iÚè* 
nİt
);

806 ià(!
iİt
)

808 
ä“
(
şi
->
iİt
);

809 
şi
->
iİt
 = iopt;

812 
şi
->
İt
 = opt;

813 
şi
->
nİt
 =‚opt;

814 
şi
->
İt_g’”©iÚ
 = ++opt_generation;

815 
iİt
 = 
şi
->iopt;

816 
şi
->
cu¼’t_İtiÚ
 = -1;

819 
i
 = 0; i < 
nİt
; ++i) {

820 
mem£t
(&
iİt
[
i
], 0, (iopt[i]));

823 ià(
İt
[
i
].
İtiÚ_id
 < 0) {

824 
CÍ_O±iÚE¼Ü
(
şp
, "CLP iÁ”ÇÈ”rÜ: o±iÚ %d ha Ãg©ivİtiÚ_id", 
i
);

825 
iİt
[
i
].
Úg
 = iİt[i].
ishÜt
 = iİt[i].
os
 = iİt[i].
šeg
 = 0;

830 
iİt
[
i
].
Úg
 = (
İt
[i].
lÚg_Çme
 != 0 && opt[i].long_name[0] != 0);

831 
iİt
[
i
].
ishÜt
 = (
İt
[i].
shÜt_Çme
 > 0

832 && 
İt
[
i
].
shÜt_Çme
 < (
şi
->
utf8
 ? 0x110000 : 256));

833 
iİt
[
i
].
os
 = 1;

834 
iİt
[
i
].
šeg
 = (
İt
[i].
æags
 & 
CÍ_Neg©e
) != 0;

835 
iİt
[
i
].
imªd©Üy
 = (
İt
[i].
æags
 & 
CÍ_Mªd©Üy
) != 0;

836 
iİt
[
i
].
iİtiÚ®
 = (
İt
[i].
æags
 & 
CÍ_O±iÚ®
) != 0;

837 
iİt
[
i
].
»fm©ch
 = (
İt
[i].
æags
 & 
CÍ_P»ã¼edM©ch
) != 0;

838 
iİt
[
i
].
Úgoff
 = 0;

841 ià(
İt
[
i
].
v®_ty³
 <= 0)

842 
iİt
[
i
].
imªd©Üy
 = iİt[i].
iİtiÚ®
 = 0;

843 ià(
İt
[
i
].
v®_ty³
 > 0 && !
iİt
[i].
iİtiÚ®
)

844 
iİt
[
i
].
imªd©Üy
 = 1;

847 ià(
iİt
[
i
].
Úg
 && 
¡ºcmp
(
İt
[i].
lÚg_Çme
, "no-", 3) == 0) {

848 
iİt
[
i
].
os
 = 0;

849 
iİt
[
i
].
šeg
 = 1;

850 
iİt
[
i
].
Úgoff
 = 3;

851 ià(
¡ºcmp
(
İt
[
i
].
lÚg_Çme
 + 3, "no-", 3) == 0)

852 
CÍ_O±iÚE¼Ü
(
şp
, "CLP iÁ”ÇÈ”rÜ: o±iÚ %d begš w™h \"no-no-\"", 
i
);

853 } ià(
İt
[
i
].
æags
 & 
CÍ_OÆyNeg©ed
) {

854 
iİt
[
i
].
os
 = 0;

855 
iİt
[
i
].
šeg
 = 1;

860 
ÿlcuÏ‹_lmm
(
şp
, 
İt
, 
iİt
, 
nİt
);

883 
CÍ_S‘Argum’ts
(
CÍ_P¬£r
 *
şp
, 
¬gc
, cÚ¡ * cÚ¡ *
¬gv
)

885 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

887 
şi
->
¬gc
 =‡rgc + 1;

888 
şi
->
¬gv
 =‡rgv - 1;

890 
şi
->
is_shÜt
 = 0;

891 
şi
->
whŞe_Ãg©ed
 = 0;

892 
şi
->
İtiÚ_´oûssšg
 = 1;

893 
şi
->
cu¼’t_İtiÚ
 = -1;

906 
CÍ_S‘O±iÚProûssšg
(
CÍ_P¬£r
 *
şp
, 
Ú
)

908 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

909 
Şd
 = 
şi
->
İtiÚ_´oûssšg
;

910 
şi
->
İtiÚ_´oûssšg
 = 
Ú
;

911  
Şd
;

922 
¬gcmp
(cÚ¡ *
»f
, cÚ¡ *
¬g
, 
mš_m©ch
, 
ãw”_dashes
)

937 cÚ¡ *
»f¡¬t
 = 
»f
;

938 cÚ¡ *
¬g¡¬t
 = 
¬g
;

939 
as£¹
(
mš_m©ch
 > 0);

941 
com·»
:

942 *
»f
 && *
¬g
 && *arg != '=' && *ref == *arg)

943 
»f
++, 
¬g
++;

946 ià(
ãw”_dashes
 && *
»f
 =ğ'-' &&„ef[1] &&„ef[1] =ğ*
¬g
) {

947 
»f
++;

948 
com·»
;

951 ià(*
¬g
 && *arg != '=')

953 ià(
»f
 - 
»f¡¬t
 < 
mš_m©ch
)

956  
¬g
 - 
¬g¡¬t
;

960 
fšd_´efix_İt
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
¬g
,

961 
nİt
, cÚ¡ 
CÍ_O±iÚ
 *
İt
,

962 cÚ¡ 
CÍ_IÁ”nO±iÚ
 *
iİt
,

963 *
ambiguous
, *
ambiguous_v®ues
)

969 
i
, 
ãw”_dashes
 = 0, 
fœ¡_ambiguous
 = *
ambiguous
;

970 
Ãg©ed
 = 
şp
 && clp->negated;

971 
fœ¡_ch¬Ën
 = (
şp
 ? 
şp_utf8_ch¬Ën
(şp->
š‹º®
, 
¬g
) : 1);

973 
»Œy
:

974 
i
 = 0; i < 
nİt
; i++) {

975 
Ën
, 
lmm
;

976 ià(!
iİt
[
i
].
Úg
 || (
Ãg©ed
 ? !iİt[i].
šeg
 : !iİt[i].
os
))

979 
lmm
 = (
Ãg©ed
 ? 
iİt
[
i
].
lmmÃg
 : iİt[i].
lmmpos
);

980 ià(
şp
 && cÍ->
š‹º®
->
could_be_shÜt


981 && (
Ãg©ed
 ? 
iİt
[
i
].
lmmÃg_shÜt
 : iİt[i].
lmmpos_shÜt
))

982 
lmm
 = (
fœ¡_ch¬Ën
 >=†mm ? first_charlen + 1 :†mm);

983 
Ën
 = 
¬gcmp
(
İt
[
i
].
lÚg_Çme
 + 
iİt
[i].
Úgoff
, 
¬g
, 
lmm
, 
ãw”_dashes
);

984 ià(
Ën
 > 0)

985  
i
;

986 ià(
Ën
 < 0) {

987 ià(*
ambiguous
 < 
MAX_AMBIGUOUS_VALUES
)

988 
ambiguous_v®ues
[*
ambiguous
] = 
i
;

989 (*
ambiguous
)++;

994 ià(*
ambiguous
 =ğ
fœ¡_ambiguous
 && !
ãw”_dashes
) {

995 
ãw”_dashes
 = 1;

996 
»Œy
;

1008 
v®_ty³_bš£¬ch
(
CÍ_IÁ”Çl
 *
şi
, 
v®_ty³
)

1010 
l
 = 0, 
r
 = 
şi
->
nv®ty³
;

1011 
l
 < 
r
) {

1012 
m
 = 
l
 + (
r
 -†) / 2;

1013 ià(
şi
->
v®ty³
[
m
].
v®_ty³
 == val_type)

1014  
m
;

1015 ià(
şi
->
v®ty³
[
m
].
v®_ty³
 < val_type)

1016 
l
 = 
m
 + 1;

1018 
r
 = 
m
;

1020  
l
;

1055 
CÍ_AddTy³
(
CÍ_P¬£r
 *
şp
, 
v®_ty³
, 
æags
,

1056 
CÍ_V®P¬£Func
 
·r£r
, *
u£r_d©a
)

1058 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1059 
vos
;

1061 ià(
v®_ty³
 <ğ0 || !
·r£r
)

1064 
vos
 = 
v®_ty³_bš£¬ch
(
şi
, 
v®_ty³
);

1066 ià(
vos
 =ğ
şi
->
nv®ty³
 || cli->
v®ty³
[vos].
v®_ty³
 != val_type) {

1067 ià(
şi
->
nv®ty³
 !ğ0 && (şi->nv®ty³ % 
CÍ_In™ŸlV®Ty³
) == 0) {

1068 
CÍ_V®Ty³
 *
Ãw_v®ty³
 =

1069 (
CÍ_V®Ty³
 *è
»®loc
(
şi
->
v®ty³
, (CÍ_V®Ty³è* (şi->
nv®ty³
 + 
CÍ_In™ŸlV®Ty³
));

1070 ià(!
Ãw_v®ty³
)

1072 
şi
->
v®ty³
 = 
Ãw_v®ty³
;

1074 
memmove
(&
şi
->
v®ty³
[
vos
 + 1], &cli->valtype[vtpos],

1075 (
CÍ_V®Ty³
è* (
şi
->
nv®ty³
 - 
vos
));

1076 
şi
->
nv®ty³
++;

1077 
şi
->
v®ty³
[
vos
].
func
 = 0;

1080 ià(
şi
->
v®ty³
[
vos
].
func
 =ğ
·r£_¡ršg_li¡
) {

1081 
CÍ_SŒšgLi¡
 *
ş¦
 = (CÍ_SŒšgLi¡ *è
şi
->
v®ty³
[
vos
].
u£r_d©a
;

1082 
ä“
(
ş¦
->
™ems
);

1083 
ä“
(
ş¦
->
iİt
);

1084 
ä“
(
ş¦
);

1087 
şi
->
v®ty³
[
vos
].
v®_ty³
 = val_type;

1088 
şi
->
v®ty³
[
vos
].
func
 = 
·r£r
;

1089 
şi
->
v®ty³
[
vos
].
æags
 = flags;

1090 
şi
->
v®ty³
[
vos
].
u£r_d©a
 = user_data;

1100 
·r£_¡ršg
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
¬g
, 
com¶aš
, *
u£r_d©a
)

1102 ()
com¶aš
, ()
u£r_d©a
;

1103 
şp
->
v®
.
s
 = 
¬g
;

1108 
·r£_št
(
CÍ_P¬£r
* 
şp
, cÚ¡ * 
¬g
, 
com¶aš
, * 
u£r_d©a
)

1110 cÚ¡ *
v®
;

1111 
ušŒ_t
 
ty³
 = (ušŒ_tè
u£r_d©a
;

1112 ià(*
¬g
 =ğ0 || 
is¥aû
(() *arg)

1113 || ((
ty³
 & 1è&& *
¬g
 == '-'))

1114 
v®
 = 
¬g
;

1115 ià(
ty³
 & 1) {

1116 #ià
HAVE_STRTOUL


1117 
şp
->
v®
.
ul
 = 
¡¹oul
(
¬g
, (**) &val, 0);

1120 ià(
¬g
[0] == '-')

1121 
v®
 = 
¬g
;

1123 
şp
->
v®
.
l
 = 
¡¹Ş
(
¬g
, (**) &val, 0);

1126 
şp
->
v®
.
l
 = 
¡¹Ş
(
¬g
, (**) &val, 0);

1127 ià(
ty³
 <= 1)

1128 
şp
->
v®
.
u
 = (èşp->v®.
ul
;

1129 ià(*
¬g
 !ğ0 && *
v®
 == 0)

1132 ià(
com¶aš
) {

1133 cÚ¡ *
mes§ge
 = 
ty³
 & 1

1136 
CÍ_O±iÚE¼Ü
(
şp
, 
mes§ge
, 
¬g
);

1143 
·r£_doubË
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
¬g
, 
com¶aš
, *
u£r_d©a
)

1145 cÚ¡ *
v®
;

1146 ()
u£r_d©a
;

1147 ià(*
¬g
 =ğ0 || 
is¥aû
(() *arg))

1148 
v®
 = 
¬g
;

1150 
şp
->
v®
.
d
 = 
¡¹od
(
¬g
, (**) &val);

1151 ià(*
¬g
 !ğ0 && *
v®
 == 0)

1154 ià(
com¶aš
)

1155 
CÍ_O±iÚE¼Ü
(
şp
, "%<%O%>ƒx³ù ¨»®‚umb”,‚Ù %<%s%>", 
¬g
);

1161 
·r£_boŞ
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
¬g
, 
com¶aš
, *
u£r_d©a
)

1163 
i
;

1164 
lÿrg
[6];

1165 ()
u£r_d©a
;

1166 ià(
¡¾’
(
¬g
è> 5 || 
¡rchr
(arg, '=') != 0)

1167 
”rÜ
;

1169 
i
 = 0; 
¬g
[i] != 0; i++)

1170 
lÿrg
[
i
] = 
tŞow”
((è
¬g
[i]);

1171 
lÿrg
[
i
] = 0;

1173 ià(
¬gcmp
("yes", 
lÿrg
, 1, 0) > 0

1174 || 
¬gcmp
("Œue", 
lÿrg
, 1, 0) > 0

1175 || 
¬gcmp
("1", 
lÿrg
, 1, 0) > 0) {

1176 
şp
->
v®
.
i
 = 1;

1178 } ià(
¬gcmp
("no", 
lÿrg
, 1, 0) > 0

1179 || 
¬gcmp
("çl£", 
lÿrg
, 1, 0) > 0

1180 || 
¬gcmp
("1", 
lÿrg
, 1, 0) > 0) {

1181 
şp
->
v®
.
i
 = 0;

1185 
”rÜ
:

1186 ià(
com¶aš
)

1187 
CÍ_O±iÚE¼Ü
(
şp
, "%<%O%>ƒx³ù ¨Œue-Ü-çl£ v®ue,‚Ù %<%s%>", 
¬g
);

1197 
·r£_¡ršg_li¡
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
¬g
, 
com¶aš
, *
u£r_d©a
)

1199 
CÍ_SŒšgLi¡
 *
¦
 = (CÍ_SŒšgLi¡ *)
u£r_d©a
;

1200 
idx
, 
ambiguous
 = 0;

1201 
ambiguous_v®ues
[
MAX_AMBIGUOUS_VALUES
 + 1];

1204 
idx
 = 
fšd_´efix_İt


1205 (0, 
¬g
, 
¦
->
n™ems
, sl->
™ems
, sl->
iİt
,

1206 &
ambiguous
, 
ambiguous_v®ues
);

1207 ià(
idx
 >= 0) {

1208 
şp
->
v®
.
i
 = 
¦
->
™ems
[
idx
].
İtiÚ_id
;

1209 ià(
¦
->
v®_lÚg
)

1210 
şp
->
v®
.
l
 = cÍ->v®.
i
;

1214 ià(
¦
->
®low_št
) {

1215 ià(
·r£_št
(
şp
, 
¬g
, 0, (*è(
ušŒ_t
è(
¦
->
v®_lÚg
 ? 2 : 0)))

1219 ià(
com¶aš
) {

1220 cÚ¡ *
com¶ašt
 = (
ambiguous
 ? "ambiguous" : "invalid");

1221 ià(!
ambiguous
) {

1222 
ambiguous
 = 
¦
->
n™ems_šv®id_»pÜt
;

1223 
idx
 = 0; idx < 
ambiguous
; idx++)

1224 
ambiguous_v®ues
[
idx
] = idx;

1226  
ambigu™y_”rÜ


1227 (
şp
, 
ambiguous
, 
ambiguous_v®ues
, 
¦
->
™ems
, sl->
iİt
,

1228 "", "İtiÚ %<%V%> i %s", 
com¶ašt
);

1235 
fšish_¡ršg_li¡
(
CÍ_P¬£r
 *
şp
, 
v®_ty³
, 
æags
,

1236 
CÍ_O±iÚ
 *
™ems
, 
n™ems
, 
™emsÿp
)

1238 
i
;

1239 
CÍ_SŒšgLi¡
 *
ş¦
 = (CÍ_SŒšgLi¡ *)
m®loc
((Clp_StringList));

1240 
CÍ_IÁ”nO±iÚ
 *
iİt
 = (CÍ_IÁ”nO±iÚ *)
m®loc
((CÍ_IÁ”nO±iÚè* 
n™ems
);

1241 ià(!
ş¦
 || !
iİt
)

1242 
”rÜ
;

1244 
ş¦
->
™ems
 = items;

1245 
ş¦
->
iİt
 = iopt;

1246 
ş¦
->
n™ems
 =‚items;

1247 
ş¦
->
®low_št
 = (
æags
 & 
CÍ_AÎowNumb”s
) != 0;

1248 
ş¦
->
v®_lÚg
 = (
æags
 & 
CÍ_SŒšgLi¡LÚg
) != 0;

1250 ià(
n™ems
 < 
MAX_AMBIGUOUS_VALUES
 &&‚™em < 
™emsÿp
 && 
ş¦
->
®low_št
) {

1251 
™ems
[
n™ems
].
lÚg_Çme
 = "any integer";

1252 
ş¦
->
n™ems_šv®id_»pÜt
 = 
n™ems
 + 1;

1253 } ià(
n™ems
 > 
MAX_AMBIGUOUS_VALUES
 + 1)

1254 
ş¦
->
n™ems_šv®id_»pÜt
 = 
MAX_AMBIGUOUS_VALUES
 + 1;

1256 
ş¦
->
n™ems_šv®id_»pÜt
 = 
n™ems
;

1258 
i
 = 0; i < 
n™ems
; i++) {

1259 
iİt
[
i
].
Úg
 = iİt[i].
os
 = 1;

1260 
iİt
[
i
].
ishÜt
 = iİt[i].
šeg
 = iİt[i].
Úgoff
 = iİt[i].
»fm©ch
 = 0;

1262 
ÿlcuÏ‹_lmm
(
şp
, 
™ems
, 
iİt
, 
n™ems
);

1264 ià(
CÍ_AddTy³
(
şp
, 
v®_ty³
, 0, 
·r£_¡ršg_li¡
, 
ş¦
) >= 0)

1267 
”rÜ
:

1268 ià(
ş¦
)

1269 
ä“
(
ş¦
);

1270 ià(
iİt
)

1271 
ä“
(
iİt
);

1301 
CÍ_AddSŒšgLi¡Ty³
(
CÍ_P¬£r
 *
şp
, 
v®_ty³
, 
æags
, ...)

1303 
n™ems
 = 0;

1304 
™emsÿp
 = 5;

1305 
CÍ_O±iÚ
 *
™ems
 = (CÍ_O±iÚ *)
m®loc
((CÍ_O±iÚè* 
™emsÿp
);

1307 
va_li¡
 
v®
;

1308 
va_¡¬t
(
v®
, 
æags
);

1310 ià(!
™ems
)

1311 
”rÜ
;

1315 
v®ue
;

1316 *
Çme
 = 
va_¬g
(
v®
, *);

1317 ià(!
Çme
)

1319 ià(
æags
 & 
CÍ_SŒšgLi¡LÚg
) {

1320 
lv®ue
 = 
va_¬g
(
v®
, );

1321 
v®ue
 = (è
lv®ue
;

1322 
as£¹
(
v®ue
 =ğ
lv®ue
);

1324 
v®ue
 = 
va_¬g
(
v®
, );

1326 ià(
n™ems
 >ğ
™emsÿp
) {

1327 
CÍ_O±iÚ
 *
Ãw_™ems
;

1328 
™emsÿp
 *= 2;

1329 
Ãw_™ems
 = (
CÍ_O±iÚ
 *)
»®loc
(
™ems
, (CÍ_O±iÚè* 
™emsÿp
);

1330 ià(!
Ãw_™ems
)

1331 
”rÜ
;

1332 
™ems
 = 
Ãw_™ems
;

1335 
™ems
[
n™ems
].
lÚg_Çme
 = 
Çme
;

1336 
™ems
[
n™ems
].
İtiÚ_id
 = 
v®ue
;

1337 
™ems
[
n™ems
].
æags
 = 0;

1338 
n™ems
++;

1341 
va_’d
(
v®
);

1342 ià(
fšish_¡ršg_li¡
(
şp
, 
v®_ty³
, 
æags
, 
™ems
, 
n™ems
, 
™emsÿp
) >= 0)

1345 
”rÜ
:

1346 
va_’d
(
v®
);

1347 ià(
™ems
)

1348 
ä“
(
™ems
);

1390 
CÍ_AddSŒšgLi¡Ty³Vec
(
CÍ_P¬£r
 *
şp
, 
v®_ty³
, 
æags
,

1391 
n¡rs
, cÚ¡ * cÚ¡ *
¡rs
,

1392 cÚ¡ *
v®s
)

1397 
i
;

1398 
™emsÿp
 = (
n¡rs
 < 5 ? 5 :‚strs);

1399 
CÍ_O±iÚ
 *
™ems
 = (CÍ_O±iÚ *)
m®loc
((CÍ_O±iÚè* 
™emsÿp
);

1400 ià(!
™ems
)

1404 
i
 = 0; i < 
n¡rs
; i++) {

1405 
™ems
[
i
].
lÚg_Çme
 = 
¡rs
[i];

1406 
™ems
[
i
].
İtiÚ_id
 = 
v®s
[i];

1407 
™ems
[
i
].
æags
 = 0;

1410 ià(
fšish_¡ršg_li¡
(
şp
, 
v®_ty³
, 
æags
, 
™ems
, 
n¡rs
, 
™emsÿp
) >= 0)

1413 
ä“
(
™ems
);

1424 
CÍ_Prog¿mName
(
CÍ_P¬£r
 *
şp
)

1426  
şp
->
š‹º®
->
´og¿m_Çme
;

1436 
CÍ_S‘Prog¿mName
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
Çme
)

1438 cÚ¡ *
Şd
 = 
şp
->
š‹º®
->
´og¿m_Çme
;

1439 
şp
->
š‹º®
->
´og¿m_Çme
 = 
Çme
;

1440  
Şd
;

1463 
CÍ_P¬£rS‹
 *

1464 
CÍ_NewP¬£rS‹
()

1466 
CÍ_P¬£rS‹
 *
¡©e
 = (CÍ_P¬£rS‹ *)
m®loc
((Clp_ParserState));

1467 ià(
¡©e
) {

1468 
¡©e
->
¬gv
 = 0;

1469 
¡©e
->
¬gc
 = 0;

1470 
¡©e
->
İtiÚ_ch¬s
[0] = 0;

1471 
¡©e
->
x‹xt
 = 0;

1472 
¡©e
->
İtiÚ_´oûssšg
 = 0;

1473 
¡©e
->
İt_g’”©iÚ
 = 0;

1474 
¡©e
->
cu¼’t_İtiÚ
 = -1;

1475 
¡©e
->
is_shÜt
 = 0;

1476 
¡©e
->
whŞe_Ãg©ed
 = 0;

1477 
¡©e
->
cu¼’t_shÜt
 = 0;

1478 
¡©e
->
Ãg©ed_by_no
 = 0;

1480  
¡©e
;

1488 
CÍ_D–‘eP¬£rS‹
(
CÍ_P¬£rS‹
 *
¡©e
)

1490 
ä“
(
¡©e
);

1498 
CÍ_SaveP¬£r
(cÚ¡ 
CÍ_P¬£r
 *
şp
, 
CÍ_P¬£rS‹
 *
¡©e
)

1500 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1501 
¡©e
->
¬gv
 = 
şi
->argv;

1502 
¡©e
->
¬gc
 = 
şi
->argc;

1503 
memıy
(
¡©e
->
İtiÚ_ch¬s
, 
şi
->İtiÚ_ch¬s, 
CÍ_O±iÚCh¬sSize
);

1504 
¡©e
->
x‹xt
 = 
şi
->xtext;

1506 
¡©e
->
İtiÚ_´oûssšg
 = 
şi
->option_processing;

1507 
¡©e
->
İt_g’”©iÚ
 = 
şi
->opt_generation;

1508 
¡©e
->
cu¼’t_İtiÚ
 = 
şi
->current_option;

1509 
¡©e
->
is_shÜt
 = 
şi
->is_short;

1510 
¡©e
->
whŞe_Ãg©ed
 = 
şi
->whole_negated;

1511 
¡©e
->
cu¼’t_shÜt
 = 
şi
->current_short;

1512 
¡©e
->
Ãg©ed_by_no
 = 
şi
->negated_by_no;

1531 
CÍ_Re¡ÜeP¬£r
(
CÍ_P¬£r
 *
şp
, cÚ¡ 
CÍ_P¬£rS‹
 *
¡©e
)

1533 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1534 
şi
->
¬gv
 = 
¡©e
->argv;

1535 
şi
->
¬gc
 = 
¡©e
->argc;

1536 
memıy
(
şi
->
İtiÚ_ch¬s
, 
¡©e
->İtiÚ_ch¬s, 
CÍ_O±iÚCh¬sSize
);

1537 
şi
->
x‹xt
 = 
¡©e
->xtext;

1538 
şi
->
İtiÚ_´oûssšg
 = 
¡©e
->option_processing;

1539 
şi
->
is_shÜt
 = 
¡©e
->is_short;

1540 
şi
->
whŞe_Ãg©ed
 = 
¡©e
->whole_negated;

1541 
şi
->
cu¼’t_shÜt
 = 
¡©e
->current_short;

1542 
şi
->
Ãg©ed_by_no
 = 
¡©e
->negated_by_no;

1543 ià(
şi
->
İt_g’”©iÚ
 =ğ
¡©e
->opt_generation)

1544 
şi
->
cu¼’t_İtiÚ
 = 
¡©e
->current_option;

1546 
şi
->
cu¼’t_İtiÚ
 = -1;

1555 
£t_İtiÚ_‹xt
(
CÍ_IÁ”Çl
 *
şi
, cÚ¡ *
‹xt
, 
n_İtiÚ_ch¬s
)

1557 
as£¹
(
n_İtiÚ_ch¬s
 < 
CÍ_O±iÚCh¬sSize
);

1558 
memıy
(
şi
->
İtiÚ_ch¬s
, 
‹xt
, 
n_İtiÚ_ch¬s
);

1559 
şi
->
İtiÚ_ch¬s
[
n_İtiÚ_ch¬s
] = 0;

1560 
şi
->
x‹xt
 = 
‹xt
 + 
n_İtiÚ_ch¬s
;

1564 
g‘_oşass
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
‹xt
, *
och¬sk
)

1566 
c
;

1567 ià(
şp
->
š‹º®
->
utf8
) {

1568 cÚ¡ *
s
;

1569 
c
 = 
decode_utf8
(
‹xt
, &
s
);

1570 *
och¬sk
 = 
s
 - 
‹xt
;

1572 
c
 = (è
‹xt
[0];

1573 *
och¬sk
 = 1;

1575  
CÍ_O±iÚCh¬
(
şp
, 
c
);

1579 
Ãxt_¬gum’t
(
CÍ_P¬£r
 *
şp
, 
wªt_¬gum’t
)

1598 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1599 cÚ¡ *
‹xt
;

1600 
oşass
, 
och¬sk
;

1603 
şp
->
have_v®
 = 0;

1604 
şp
->
v¡r
 = 0;

1605 
şi
->
could_be_shÜt
 = 0;

1608 ià(
şi
->
is_shÜt
) {

1609 
şi
->
x‹xt
 +ğ
şp_utf8_ch¬Ën
(cli, cli->xtext);

1610 ià(
şi
->
x‹xt
[0] == 0)

1611 
şi
->
is_shÜt
 = 0;

1612 ià(
wªt_¬gum’t
 > 0) {

1614 
şp
->
have_v®
 = 1;

1615 ià(
şi
->
x‹xt
[0] == '=')

1616 
şp
->
v¡r
 = 
şi
->
x‹xt
 + 1;

1618 
şp
->
v¡r
 = 
şi
->
x‹xt
;

1619 
şi
->
is_shÜt
 = 0;

1625 ià(
şi
->
is_shÜt
)

1629 
şi
->
whŞe_Ãg©ed
 = 0;

1630 
şi
->
x‹xt
 = 0;

1632 ià(
şi
->
¬gc
 <= 1)

1635 
şi
->
¬gc
--;

1636 
şi
->
¬gv
++;

1637 
‹xt
 = 
şi
->
¬gv
[0];

1639 ià(
wªt_¬gum’t
 > 1)

1640 
nÙ_İtiÚ
;

1642 ià(
‹xt
[0] == '-' &&ext[1] == '-') {

1643 
oşass
 = 
CÍ_DoubËdLÚg
;

1644 
och¬sk
 = 2;

1646 
oşass
 = 
g‘_oşass
(
şp
, 
‹xt
, &
och¬sk
);

1651 ià((
oşass
 & (
CÍ_ShÜt
 | 
CÍ_ShÜtNeg©ed
))

1652 && (
oşass
 & (
CÍ_LÚg
 | 
CÍ_LÚgNeg©ed
))) {

1653 
oşass
 &ğ~(
CÍ_ShÜt
 | 
CÍ_ShÜtNeg©ed
);

1654 ià(
‹xt
[
och¬sk
])

1655 
şi
->
could_be_shÜt
 = 1;

1658 
oşass
) {

1660 
CÍ_ShÜt
:

1661 
şi
->
is_shÜt
 = 1;

1662 
check_sšgËtÚ
;

1664 
CÍ_ShÜtNeg©ed
:

1665 
şi
->
is_shÜt
 = 1;

1666 
şi
->
whŞe_Ãg©ed
 = 1;

1667 
check_sšgËtÚ
;

1669 
CÍ_LÚg
:

1670 
check_sšgËtÚ
;

1672 
CÍ_LÚgNeg©ed
:

1673 
şi
->
whŞe_Ãg©ed
 = 1;

1674 
check_sšgËtÚ
;

1676 
check_sšgËtÚ
:

1679 ià(!
‹xt
[
och¬sk
])

1680 
nÙ_İtiÚ
;

1681 
£t_İtiÚ_‹xt
(
şi
, 
‹xt
, 
och¬sk
);

1684 
CÍ_LÚgIm¶ic™
:

1687 ià(
wªt_¬gum’t
 > 0)

1688 
nÙ_İtiÚ
;

1689 
£t_İtiÚ_‹xt
(
şi
, 
‹xt
, 0);

1692 
CÍ_DoubËdLÚg
:

1693 
£t_İtiÚ_‹xt
(
şi
, 
‹xt
, 
och¬sk
);

1696 
nÙ_İtiÚ
:

1697 
CÍ_NÙO±iÚ
:

1698 
şi
->
is_shÜt
 = 0;

1699 
şp
->
have_v®
 = 1;

1700 
şp
->
v¡r
 = 
‹xt
;

1704 
as£¹
(0 );

1713 
sw™ch_to_shÜt_¬gum’t
(
CÍ_P¬£r
 *
şp
)

1715 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1716 cÚ¡ *
‹xt
 = 
şi
->
¬gv
[0];

1717 
och¬sk
, 
oşass
 = 
g‘_oşass
(
şp
, 
‹xt
, &ocharskip);

1718 
as£¹
(
şi
->
could_be_shÜt
);

1719 
şi
->
is_shÜt
 = 1;

1720 
şi
->
whŞe_Ãg©ed
 = (
oşass
 & 
CÍ_ShÜtNeg©ed
 ? 1 : 0);

1721 
£t_İtiÚ_‹xt
(
şi
, cli->
¬gv
[0], 
och¬sk
);

1726 
fšd_lÚg
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
¬g
)

1732 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1733 
İŠo
, 
Ën
, 
lmm
;

1734 cÚ¡ 
CÍ_O±iÚ
 *
İt
 = 
şi
->opt;

1735 cÚ¡ 
CÍ_IÁ”nO±iÚ
 *
iİt
;

1736 
fœ¡_Ãg©ive_ambiguous
;

1739 
İŠo
 = 
fšd_´efix_İt


1740 (
şp
, 
¬g
, 
şi
->
nİt
, 
İt
, cli->
iİt
,

1741 &
şi
->
ambiguous
, cli->
ambiguous_v®ues
);

1742 ià(
İŠo
 >= 0)

1743 
wÜked
;

1748 
fœ¡_Ãg©ive_ambiguous
 = 
şi
->
ambiguous
;

1749 
¬g
[0] == 'n' &&‡rg[1] == 'o' &&‡rg[2] == '-') {

1750 
¬g
 += 3;

1751 
şp
->
Ãg©ed
 = !clp->negated;

1752 
İŠo
 = 
fšd_´efix_İt


1753 (
şp
, 
¬g
, 
şi
->
nİt
, 
İt
, cli->
iİt
,

1754 &
şi
->
ambiguous
, cli->
ambiguous_v®ues
);

1755 ià(
İŠo
 >= 0)

1756 
wÜked
;

1762 
i
, 
max
 = 
şi
->
ambiguous
;

1763 ià(
max
 > 
MAX_AMBIGUOUS_VALUES
) max = MAX_AMBIGUOUS_VALUES;

1764 
i
 = 
fœ¡_Ãg©ive_ambiguous
; i < 
max
; i++)

1765 
şi
->
ambiguous_v®ues
[
i
] = -cli->ambiguous_values[i] - 1;

1769 
wÜked
:

1770 
iİt
 = &
şi
->iİt[
İŠo
];

1771 
lmm
 = (
şp
->
Ãg©ed
 ? 
iİt
->
lmmÃg
 : iİt->
lmmpos
);

1772 ià(
şi
->
could_be_shÜt


1773 && (
şp
->
Ãg©ed
 ? 
iİt
->
lmmÃg_shÜt
 : iİt->
lmmpos_shÜt
)) {

1774 
fœ¡_ch¬Ën
 = 
şp_utf8_ch¬Ën
(
şi
, 
¬g
);

1775 
lmm
 = (
fœ¡_ch¬Ën
 >=†mm ? first_charlen + 1 :†mm);

1777 
Ën
 = 
¬gcmp
(
İt
[
İŠo
].
lÚg_Çme
 + 
iİt
->
Úgoff
, 
¬g
, 
lmm
, 1);

1778 
as£¹
(
Ën
 > 0);

1779 ià(
¬g
[
Ën
] == '=') {

1780 
şp
->
have_v®
 = 1;

1781 
şp
->
v¡r
 = 
¬g
 + 
Ën
 + 1;

1783  
İŠo
;

1788 
fšd_shÜt
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
‹xt
)

1791 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1792 cÚ¡ 
CÍ_O±iÚ
 *
İt
 = 
şi
->opt;

1793 cÚ¡ 
CÍ_IÁ”nO±iÚ
 *
iİt
 = 
şi
->iopt;

1794 
i
, 
c
;

1795 ià(
şp
->
š‹º®
->
utf8
)

1796 
c
 = 
decode_utf8
(
‹xt
, 0);

1798 
c
 = (è*
‹xt
;

1800 
i
 = 0; i < 
şi
->
nİt
; i++)

1801 ià(
iİt
[
i
].
ishÜt
 && 
İt
[i].
shÜt_Çme
 =ğ
c


1802 && (!
şp
->
Ãg©ed
 || 
iİt
[
i
].
šeg
)) {

1803 
şp
->
Ãg©ed
 = cÍ->Ãg©ed || !
iİt
[
i
].
os
;

1804  
i
;

1854 
CÍ_Next
(
CÍ_P¬£r
 *
şp
)

1856 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1857 
İŠo
;

1858 cÚ¡ 
CÍ_O±iÚ
 *
İt
;

1859 
CÍ_P¬£rS‹
 
şp§ve
;

1860 
vos
, 
com¶aš
;

1863 
şi
->
cu¼’t_İtiÚ
 = -1;

1864 
şi
->
ambiguous
 = 0;

1867 ià(!
Ãxt_¬gum’t
(
şp
, 
şi
->
İtiÚ_´oûssšg
 ? 0 : 2)) {

1868 
şp
->
v®
.
s
 = cÍ->
v¡r
;

1869 
İŠo
 = 
şp
->
have_v®
 ? 
CÍ_NÙO±iÚ
 : 
CÍ_DÚe
;

1870 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
İŠo
];

1871  
İŠo
;

1874 
şp
->
Ãg©ed
 = 
şi
->
whŞe_Ãg©ed
;

1875 ià(
şi
->
is_shÜt
)

1876 
İŠo
 = 
fšd_shÜt
(
şp
, 
şi
->
x‹xt
);

1878 
İŠo
 = 
fšd_lÚg
(
şp
, 
şi
->
x‹xt
);

1882 ià(
İŠo
 < 0 && 
şi
->
could_be_shÜt
) {

1883 
sw™ch_to_shÜt_¬gum’t
(
şp
);

1884 
İŠo
 = 
fšd_shÜt
(
şp
, 
şi
->
x‹xt
);

1888 ià(
İŠo
 < 0 || (
şp
->
Ãg©ed
 && !
şi
->
iİt
[İŠo].
šeg
)) {

1891 ià(
¡rcmp
(
şi
->
¬gv
[0], "--") == 0) {

1892 
CÍ_S‘O±iÚProûssšg
(
şp
, 0);

1893  
CÍ_Next
(
şp
);

1897 ià(
şi
->
ambiguous
)

1898 
ambigu™y_”rÜ
(
şp
, 
şi
->
ambiguous
, cli->
ambiguous_v®ues
,

1899 
şi
->
İt
, cli->
iİt
, cli->
İtiÚ_ch¬s
,

1901 
şi
->
İtiÚ_ch¬s
, cli->
x‹xt
);

1902 ià(
şi
->
is_shÜt
 && !şi->
could_be_shÜt
)

1903 
CÍ_O±iÚE¼Ü
(
şp
, "unrecognized option %<%s%C%>",

1904 
şi
->
İtiÚ_ch¬s
, cli->
x‹xt
);

1906 
CÍ_O±iÚE¼Ü
(
şp
, "unrecognized option %<%s%s%>",

1907 
şi
->
İtiÚ_ch¬s
, cli->
x‹xt
);

1909 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
CÍ_BadO±iÚ
];

1910  
CÍ_BadO±iÚ
;

1914 
şi
->
cu¼’t_İtiÚ
 = 
İŠo
;

1915 
şi
->
cu¼’t_shÜt
 = cli->
is_shÜt
;

1916 
şi
->
Ãg©ed_by_no
 = 
şp
->
Ãg©ed
 && !şi->
whŞe_Ãg©ed
;

1919 ià(
şp
->
Ãg©ed


1920 || (!
şi
->
iİt
[
İŠo
].
imªd©Üy
 && !şi->iİt[İŠo].
iİtiÚ®
)) {

1921 ià(
şp
->
have_v®
) {

1922 
CÍ_O±iÚE¼Ü
(
şp
, "%<%O%> can%,take‡n‡rgument");

1923 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
CÍ_BadO±iÚ
];

1924  
CÍ_BadO±iÚ
;

1926 
şp
->
İtiÚ
 = &
şi
->
İt
[
İŠo
];

1927  
şi
->
İt
[
İŠo
].
İtiÚ_id
;

1933 
İt
 = &
şi
->İt[
İŠo
];

1934 ià(
İt
->
v®_ty³
 <= 0) {

1935 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
CÍ_E¼Ü
];

1936  
CÍ_E¼Ü
;

1938 
vos
 = 
v®_ty³_bš£¬ch
(
şi
, 
İt
->
v®_ty³
);

1939 ià(
vos
 =ğ
şi
->
nv®ty³


1940 || 
şi
->
v®ty³
[
vos
].
v®_ty³
 !ğ
İt
->val_type) {

1941 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
CÍ_E¼Ü
];

1942  
CÍ_E¼Ü
;

1947 
com¶aš
 = (
şp
->
have_v®
 !ğ0è|| 
şi
->
iİt
[
İŠo
].
imªd©Üy
;

1948 
CÍ_SaveP¬£r
(
şp
, &
şp§ve
);

1950 ià(
şi
->
iİt
[
İŠo
].
imªd©Üy
 && !
şp
->
have_v®
) {

1954 
di§Îow
 = (
şi
->
v®ty³
[
vos
].
æags
 & 
CÍ_Di§ÎowO±iÚs
) != 0;

1955 
Ãxt_¬gum’t
(
şp
, 
di§Îow
 ? 1 : 2);

1956 ià(!
şp
->
have_v®
) {

1957 
gÙ_İtiÚ
 = 
şi
->
x‹xt
 != 0;

1958 
CÍ_Re¡ÜeP¬£r
(
şp
, &
şp§ve
);

1959 ià(
gÙ_İtiÚ
)

1960 
CÍ_O±iÚE¼Ü
(
şp
, "%<%O%>„equires‡‚on-option‡rgument");

1962 
CÍ_O±iÚE¼Ü
(
şp
, "%<%O%>„equires‡n‡rgument");

1963 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
CÍ_BadO±iÚ
];

1964  
CÍ_BadO±iÚ
;

1967 } ià(
şi
->
is_shÜt
 && !
şp
->
have_v®


1968 && 
şi
->
x‹xt
[
şp_utf8_ch¬Ën
(cli, cli->xtext)])

1971 
Ãxt_¬gum’t
(
şp
, 1);

1974 
şp
->
İtiÚ
 = 
İt
;

1975 ià(
şp
->
have_v®
) {

1976 
CÍ_V®Ty³
 *
©r
 = &
şi
->
v®ty³
[
vos
];

1977 ià(
©r
->
func
(
şp
, cÍ->
v¡r
, 
com¶aš
,‡Œ->
u£r_d©a
) <= 0) {

1979 
şp
->
have_v®
 = 0;

1980 ià(
şi
->
iİt
[
İŠo
].
imªd©Üy
) {

1981 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
CÍ_BadO±iÚ
];

1982  
CÍ_BadO±iÚ
;

1984 
CÍ_Re¡ÜeP¬£r
(
şp
, &
şp§ve
);

1985 
şp
->
İtiÚ
 = 
İt
;

1990  
İt
->
İtiÚ_id
;

2002 
CÍ_Shiá
(
CÍ_P¬£r
 *
şp
, 
®low_İtiÚs
)

2006 
CÍ_P¬£rS‹
 
şp§ve
;

2007 
CÍ_SaveP¬£r
(
şp
, &
şp§ve
);

2008 
Ãxt_¬gum’t
(
şp
, 
®low_İtiÚs
 ? 2 : 1);

2009 ià(!
şp
->
have_v®
)

2010 
CÍ_Re¡ÜeP¬£r
(
şp
, &
şp§ve
);

2011  
şp
->
v¡r
;

2019 
	sCÍ_BudSŒšg
 {

2020 * 
d©a
;

2021 * 
pos
;

2022 * 
’d_d©a
;

2023 
buf
[256];

2024 } 
	tCÍ_BudSŒšg
;

2026 
bud_¡ršg_´og¿m_´efix
(
CÍ_BudSŒšg
* 
bs
,

2027 cÚ¡ 
CÍ_P¬£r
* 
şp
);

2029 
bud_¡ršg_š™
(
CÍ_BudSŒšg
* 
bs
, 
CÍ_P¬£r
* 
şp
) {

2030 
bs
->
d©a
 = bs->
pos
 = bs->
buf
;

2031 
bs
->
’d_d©a
 = &bs->
buf
[(bs->buf)];

2032 ià(
şp
)

2033 
bud_¡ršg_´og¿m_´efix
(
bs
, 
şp
);

2036 
bud_¡ršg_ş—nup
(
CÍ_BudSŒšg
* 
bs
) {

2037 ià(
bs
->
d©a
 !ğbs->
buf
)

2038 
ä“
(
bs
->
d©a
);

2041 
bud_¡ršg_grow
(
CÍ_BudSŒšg
* 
bs
, 
size_t
 
wªt
) {

2042 
size_t
 
os
 = 
bs
->
pos
 - bs->
d©a
, 
nÿp
;

2043 ià(!
bs
->
pos
)

2045 
nÿp
 = (
bs
->
’d_d©a
 - bs->
d©a
è<< 1;‚ÿ°< 
wªt
;‚cap *= 2)

2047 ià(
bs
->
d©a
 =ğbs->
buf
) {

2048 ià((
bs
->
d©a
 = (*è
m®loc
(
nÿp
)))

2049 
memıy
(
bs
->
d©a
, bs->
buf
, bs->
pos
 - bs->buf);

2051 
bs
->
d©a
 = (*è
»®loc
(bs->d©a, 
nÿp
);

2052 ià(!
bs
->
d©a
) {

2053 
bs
->
pos
 = bs->
’d_d©a
 = bs->
d©a
;

2056 
bs
->
pos
 = bs->
d©a
 + 
os
;

2057 
bs
->
’d_d©a
 = bs->
d©a
 + 
nÿp
;

2062 
	#ENSURE_BUILD_STRING
(
bs
, 
¥aû
) \

2063 ((((
bs
)->
’d_d©a
 - (bs)->
pos
è>ğ(
¥aû
)) \

2064 || 
	`bud_¡ršg_grow
((
bs
), (bs)->
pos
 - (bs)->
d©a
 + (
¥aû
)))

	)

2067 
­³nd_bud_¡ršg
(
CÍ_BudSŒšg
 *
bs
, cÚ¡ *
s
, 
l
)

2069 ià(
l
 < 0)

2070 
l
 = 
¡¾’
(
s
);

2071 ià(
ENSURE_BUILD_STRING
(
bs
, 
l
)) {

2072 
memıy
(
bs
->
pos
, 
s
, 
l
);

2073 
bs
->
pos
 +ğ
l
;

2078 
bud_¡ršg_´og¿m_´efix
(
CÍ_BudSŒšg
* 
bs
, cÚ¡ 
CÍ_P¬£r
* 
şp
)

2080 cÚ¡ 
CÍ_IÁ”Çl
* 
şi
 = 
şp
->
š‹º®
;

2081 ià(
şi
->
´og¿m_Çme
 && cli->program_name[0]) {

2082 
­³nd_bud_¡ršg
(
bs
, 
şi
->
´og¿m_Çme
, -1);

2083 
­³nd_bud_¡ršg
(
bs
, ": ", 2);

2089 
CÍ_vb¥rštf
(
CÍ_P¬£r
 *
şp
, 
CÍ_BudSŒšg
 *
bs
,

2090 cÚ¡ *
fmt
, 
va_li¡
 
v®
)

2092 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

2093 cÚ¡ *
³rûÁ
;

2094 
c
;

2096 
³rûÁ
 = 
¡rchr
(
fmt
, '%');…ercent;…ercent = strchr(fmt, '%')) {

2097 
­³nd_bud_¡ršg
(
bs
, 
fmt
, 
³rûÁ
 - fmt);

2098 *++
³rûÁ
) {

2101 cÚ¡ *
s
 = 
va_¬g
(
v®
, const *);

2102 
­³nd_bud_¡ršg
(
bs
, 
s
 ? s : "(null)", -1);

2107 cÚ¡ *
s
 = 
va_¬g
(
v®
, const *);

2108 ià(
şi
->
utf8
)

2109 
c
 = 
decode_utf8
(
s
, 0);

2111 
c
 = (è*
s
;

2112 
ch¬_c
;

2116 
c
 = 
va_¬g
(
v®
, );

2117 
ch¬_c
;

2119 
ch¬_c
:

2120 ià(
ENSURE_BUILD_STRING
(
bs
, 4)) {

2121 ià(
c
 >= 32 && c <= 126)

2122 *
bs
->
pos
++ = 
c
;

2123 ià(
c
 < 32) {

2124 *
bs
->
pos
++ = '^';

2125 *
bs
->
pos
++ = 
c
 + 64;

2126 } ià(
şi
->
utf8
 && 
c
 >= 127 && c < 0x110000) {

2127 
bs
->
pos
 = 
’code_utf8
(bs->pos, 4, 
c
);

2128 } ià(
c
 >= 127 && c <= 255) {

2129 
¥rštf
(
bs
->
pos
, "\\%03o", 
c
 & 0xFF);

2130 
bs
->
pos
 += 4;

2132 *
bs
->
pos
++ = '\\';

2133 *
bs
->
pos
++ = '?';

2139 
d
 = 
va_¬g
(
v®
, );

2140 ià(
ENSURE_BUILD_STRING
(
bs
, 32)) {

2141 
¥rštf
(
bs
->
pos
, "%d", 
d
);

2142 
bs
->
pos
 = 
¡rchr
(bs->pos, 0);

2149 
İŠo
 = 
şi
->
cu¼’t_İtiÚ
;

2150 cÚ¡ 
CÍ_O±iÚ
 *
İt
 = &
şi
->İt[
İŠo
];

2151 ià(
İŠo
 < 0)

2152 
­³nd_bud_¡ršg
(
bs
, "(no current option!)", -1);

2153 ià(
şi
->
cu¼’t_shÜt
) {

2154 
­³nd_bud_¡ršg
(
bs
, 
şi
->
İtiÚ_ch¬s
, -1);

2155 ià(
ENSURE_BUILD_STRING
(
bs
, 5)) {

2156 ià(
şi
->
utf8
)

2157 
bs
->
pos
 = 
’code_utf8
(bs->pos, 5, 
İt
->
shÜt_Çme
);

2159 *
bs
->
pos
++ = 
İt
->
shÜt_Çme
;

2161 } ià(
şi
->
Ãg©ed_by_no
) {

2162 
­³nd_bud_¡ršg
(
bs
, 
şi
->
İtiÚ_ch¬s
, -1);

2163 
­³nd_bud_¡ršg
(
bs
, "no-", 3);

2164 
­³nd_bud_¡ršg
(
bs
, 
İt
->
lÚg_Çme
 + 
şi
->
iİt
[
İŠo
].
Úgoff
, -1);

2166 
­³nd_bud_¡ršg
(
bs
, 
şi
->
İtiÚ_ch¬s
, -1);

2167 
­³nd_bud_¡ršg
(
bs
, 
İt
->
lÚg_Çme
 + 
şi
->
iİt
[
İŠo
].
Úgoff
, -1);

2169 ià(
İŠo
 >ğ0 && 
şp
->
have_v®
 && *
³rûÁ
 == 'V') {

2170 ià(
şi
->
cu¼’t_shÜt
 && !şi->
iİt
[
İŠo
].
iİtiÚ®
)

2171 
­³nd_bud_¡ršg
(
bs
, " ", 1);

2172 ià(!
şi
->
cu¼’t_shÜt
)

2173 
­³nd_bud_¡ršg
(
bs
, "=", 1);

2174 
­³nd_bud_¡ršg
(
bs
, 
şp
->
v¡r
, -1);

2180 ià(
ENSURE_BUILD_STRING
(
bs
, 1))

2181 *
bs
->
pos
++ = '%';

2185 
­³nd_bud_¡ršg
(
bs
, (
şi
->
utf8
 ? "\342\200\230" : "'"), -1);

2190 
­³nd_bud_¡ršg
(
bs
, (
şi
->
utf8
 ? "\342\200\231" : "'"), -1);

2194 
­³nd_bud_¡ršg
(
bs
, "%", 1);

2195 
dÚe
;

2198 ià(
ENSURE_BUILD_STRING
(
bs
, 2)) {

2199 *
bs
->
pos
++ = '%';

2200 *
bs
->
pos
++ = *
³rûÁ
;

2205 
fmt
 = ++
³rûÁ
;

2208 
dÚe
:

2209 
­³nd_bud_¡ršg
(
bs
, 
fmt
, -1);

2212 cÚ¡ * 
bud_¡ršg_‹xt
(
CÍ_BudSŒšg
* 
bs
, 
»pÜt_oom
) {

2213 ià(
bs
->
pos
) {

2214 *
bs
->
pos
 = 0;

2215  
bs
->
d©a
;

2216 } ià(
»pÜt_oom
)

2219  
NULL
;

2223 
do_”rÜ
(
CÍ_P¬£r
 *
şp
, 
CÍ_BudSŒšg
 *
bs
)

2225 cÚ¡ *
‹xt
 = 
bud_¡ršg_‹xt
(
bs
, 1);

2226 ià(
şp
->
š‹º®
->
”rÜ_hªdËr
 != 0)

2227 (*
şp
->
š‹º®
->
”rÜ_hªdËr
)(şp, 
‹xt
);

2229 
åuts
(
‹xt
, 
¡d”r
);

2281 
CÍ_O±iÚE¼Ü
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
fÜm©
, ...)

2283 
CÍ_BudSŒšg
 
bs
;

2284 
va_li¡
 
v®
;

2285 
va_¡¬t
(
v®
, 
fÜm©
);

2286 
bud_¡ršg_š™
(&
bs
, 
şp
);

2287 
CÍ_vb¥rštf
(
şp
, &
bs
, 
fÜm©
, 
v®
);

2288 
­³nd_bud_¡ršg
(&
bs
, "\n", 1);

2289 
va_’d
(
v®
);

2290 
do_”rÜ
(
şp
, &
bs
);

2291 
bud_¡ršg_ş—nup
(&
bs
);

2292  
bs
.
pos
 - bs.
d©a
;

2305 
CÍ_årštf
(
CÍ_P¬£r
* 
şp
, 
FILE
* 
f
, cÚ¡ * 
fÜm©
, ...)

2307 
CÍ_BudSŒšg
 
bs
;

2308 
va_li¡
 
v®
;

2309 
va_¡¬t
(
v®
, 
fÜm©
);

2310 
bud_¡ršg_š™
(&
bs
, 
NULL
);

2311 
CÍ_vb¥rštf
(
şp
, &
bs
, 
fÜm©
, 
v®
);

2312 
va_’d
(
v®
);

2313 ià(
bs
.
pos
 !ğbs.
d©a
)

2314 
fwr™e
(
bs
.
d©a
, 1, bs.
pos
 - bs.d©a, 
f
);

2315 
bud_¡ršg_ş—nup
(&
bs
);

2316  
bs
.
pos
 - bs.
d©a
;

2330 
CÍ_vårštf
(
CÍ_P¬£r
* 
şp
, 
FILE
* 
f
, cÚ¡ * 
fÜm©
, 
va_li¡
 
v®
)

2332 
CÍ_BudSŒšg
 
bs
;

2333 
bud_¡ršg_š™
(&
bs
, 
NULL
);

2334 
CÍ_vb¥rštf
(
şp
, &
bs
, 
fÜm©
, 
v®
);

2335 ià(
bs
.
pos
 !ğbs.
d©a
)

2336 
fwr™e
(
bs
.
d©a
, 1, bs.
pos
 - bs.d©a, 
f
);

2337 
bud_¡ršg_ş—nup
(&
bs
);

2338  
bs
.
pos
 - bs.
d©a
;

2356 
CÍ_v¢´štf
(
CÍ_P¬£r
* 
şp
, * 
¡r
, 
size_t
 
size
,

2357 cÚ¡ * 
fÜm©
, 
va_li¡
 
v®
)

2359 
CÍ_BudSŒšg
 
bs
;

2360 
bud_¡ršg_š™
(&
bs
, 
NULL
);

2361 
CÍ_vb¥rštf
(
şp
, &
bs
, 
fÜm©
, 
v®
);

2362 ià((
size_t
è(
bs
.
pos
 - bs.
d©a
è< 
size
) {

2363 
memıy
(
¡r
, 
bs
.
d©a
, bs.
pos
 - bs.data);

2364 
¡r
[
bs
.
pos
 - bs.
d©a
] = 0;

2366 
memıy
(
¡r
, 
bs
.
d©a
, 
size
 - 1);

2367 
¡r
[
size
 - 1] = 0;

2369 
bud_¡ršg_ş—nup
(&
bs
);

2370  
bs
.
pos
 - bs.
d©a
;

2374 
ambigu™y_”rÜ
(
CÍ_P¬£r
 *
şp
, 
ambiguous
, *
ambiguous_v®ues
,

2375 cÚ¡ 
CÍ_O±iÚ
 *
İt
, cÚ¡ 
CÍ_IÁ”nO±iÚ
 *
iİt
,

2376 cÚ¡ *
´efix
, cÚ¡ *
fmt
, ...)

2378 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

2379 
CÍ_BudSŒšg
 
bs
;

2380 
i
;

2381 
va_li¡
 
v®
;

2383 
va_¡¬t
(
v®
, 
fmt
);

2384 
bud_¡ršg_š™
(&
bs
, 
şp
);

2385 
CÍ_vb¥rštf
(
şp
, &
bs
, 
fmt
, 
v®
);

2386 
­³nd_bud_¡ršg
(&
bs
, "\n", 1);

2388 
bud_¡ršg_´og¿m_´efix
(&
bs
, 
şp
);

2389 
­³nd_bud_¡ršg
(&
bs
, "(Possibilities‡re", -1);

2391 
i
 = 0; i < 
ambiguous
 && i < 
MAX_AMBIGUOUS_VALUES
; i++) {

2392 
v®ue
 = 
ambiguous_v®ues
[
i
];

2393 cÚ¡ *
no_dash
 = "";

2394 ià(
v®ue
 < 0)

2395 
v®ue
 = -(v®u+ 1), 
no_dash
 = "no-";

2396 ià(
i
 == 0)

2397 
­³nd_bud_¡ršg
(&
bs
, " ", 1);

2398 ià(
i
 =ğ
ambiguous
 - 1)

2399 
­³nd_bud_¡ršg
(&
bs
, (
i
 == 1 ? "‡nd " : ",‡nd "), -1);

2401 
­³nd_bud_¡ršg
(&
bs
, ", ", 2);

2402 
­³nd_bud_¡ršg
(&
bs
, (
şi
->
utf8
 ? "\342\200\230" : "'"), -1);

2403 
­³nd_bud_¡ršg
(&
bs
, 
´efix
, -1);

2404 
­³nd_bud_¡ršg
(&
bs
, 
no_dash
, -1);

2405 
­³nd_bud_¡ršg
(&
bs
, 
İt
[
v®ue
].
lÚg_Çme
 + 
iİt
[v®ue].
Úgoff
, -1);

2406 
­³nd_bud_¡ršg
(&
bs
, (
şi
->
utf8
 ? "\342\200\231" : "'"), -1);

2409 ià(
ambiguous
 > 
MAX_AMBIGUOUS_VALUES
)

2410 
­³nd_bud_¡ršg
(&
bs
, ",‡nd others", -1);

2411 
­³nd_bud_¡ršg
(&
bs
, ".)\n", -1);

2412 
va_’d
(
v®
);

2414 
do_”rÜ
(
şp
, &
bs
);

2415 
bud_¡ršg_ş—nup
(&
bs
);

2420 
cİy_¡ršg
(*
buf
, 
buæ’
, 
buåos
, cÚ¡ *
wh©
)

2422 
l
 = 
¡¾’
(
wh©
);

2423 ià(
l
 > 
buæ’
 - 
buåos
 - 1)

2424 
l
 = 
buæ’
 - 
buåos
 - 1;

2425 
memıy
(
buf
 + 
buåos
, 
wh©
, 
l
);

2426  
l
;

2442 
CÍ_CurO±iÚNameBuf
(
CÍ_P¬£r
 *
şp
, *
buf
, 
Ën
)

2444 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

2445 
İŠo
 = 
şi
->
cu¼’t_İtiÚ
;

2446 
pos
 = 0;

2447 ià(
İŠo
 < 0)

2448 
pos
 +ğ
cİy_¡ršg
(
buf
, 
Ën
,…os, "(no current option!)");

2449 ià(
şi
->
cu¼’t_shÜt
) {

2450 
pos
 +ğ
cİy_¡ršg
(
buf
, 
Ën
,…os, 
şi
->
İtiÚ_ch¬s
);

2451 ià(
şi
->
utf8
)

2452 
pos
 = (
’code_utf8
(
buf
 +…os, 
Ën
 -…o - 1, 
şi
->
İt
[
İŠo
].
shÜt_Çme
) - buf);

2453 ià(
pos
 < 
Ën
 - 1)

2454 
buf
[
pos
++] = 
şi
->
İt
[
İŠo
].
shÜt_Çme
;

2455 } ià(
şi
->
Ãg©ed_by_no
) {

2456 
pos
 +ğ
cİy_¡ršg
(
buf
, 
Ën
,…os, 
şi
->
İtiÚ_ch¬s
);

2457 
pos
 +ğ
cİy_¡ršg
(
buf
, 
Ën
,…os, "no-");

2458 
pos
 +ğ
cİy_¡ršg
(
buf
, 
Ën
,…os, 
şi
->
İt
[
İŠo
].
lÚg_Çme
 + cli->
iİt
[İŠo].
Úgoff
);

2460 
pos
 +ğ
cİy_¡ršg
(
buf
, 
Ën
,…os, 
şi
->
İtiÚ_ch¬s
);

2461 
pos
 +ğ
cİy_¡ršg
(
buf
, 
Ën
,…os, 
şi
->
İt
[
İŠo
].
lÚg_Çme
 + cli->
iİt
[İŠo].
Úgoff
);

2463 ià(
pos
 < 
Ën
)

2464 
buf
[
pos
] = 0;

2465  
pos
;

2480 
CÍ_CurO±iÚName
(
CÍ_P¬£r
 *
şp
)

2482 
buf
[256];

2483 
CÍ_CurO±iÚNameBuf
(
şp
, 
buf
, 256);

2484  
buf
;

2488 
CÍ_IsLÚg
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
lÚg_Çme
)

2490 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

2491 
İŠo
 = 
şi
->
cu¼’t_İtiÚ
;

2492  
İŠo
 >ğ0 && 
¡rcmp
(
şi
->
İt
[İŠo].
lÚg_Çme
,†ong_name) == 0;

2496 
CÍ_IsShÜt
(
CÍ_P¬£r
 *
şp
, 
shÜt_Çme
)

2498 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

2499 
İŠo
 = 
şi
->
cu¼’t_İtiÚ
;

2500  
İŠo
 >ğ0 && 
şi
->
İt
[İŠo].
shÜt_Çme
 == short_name;

2503 #ifdeà
__ılu¥lus


	@lib/clp.h

16 #iâdeà
LCDF_CLP_H


17 
	#LCDF_CLP_H


	)

18 #ifdeà
__ılu¥lus


42 
	~<¡dio.h
>

43 
	~<¡d¬g.h
>

45 
CÍ_O±iÚ
 
	tCÍ_O±iÚ
;

46 
CÍ_P¬£r
 
	tCÍ_P¬£r
;

47 
CÍ_P¬£rS‹
 
	tCÍ_P¬£rS‹
;

55 
	sCÍ_O±iÚ
 {

56 cÚ¡ *
lÚg_Çme
;

58 
shÜt_Çme
;

60 
İtiÚ_id
;

62 
v®_ty³
;

64 
æags
;

72 
	#CÍ_NoV®
 0

	)

73 
	#CÍ_V®SŒšg
 1

	)

75 
	#CÍ_V®SŒšgNÙO±iÚ
 2

	)

79 
	#CÍ_V®BoŞ
 3

	)

84 
	#CÍ_V®IÁ
 4

	)

91 
	#CÍ_V®UnsigÃd
 5

	)

98 
	#CÍ_V®LÚg
 6

	)

100 
	#CÍ_V®UnsigÃdLÚg
 7

	)

102 
	#CÍ_V®DoubË
 8

	)

105 
	#CÍ_V®Fœ¡U£r
 10

	)

113 
	#CÍ_Mªd©Üy
 (1<<0è

	)

119 
	#CÍ_O±iÚ®
 (1<<1è

	)

121 
	#CÍ_Neg©e
 (1<<2è

	)

125 
	#CÍ_OÆyNeg©ed
 (1<<3è

	)

131 
	#CÍ_P»ã¼edM©ch
 (1<<4è

	)

142 
	#CÍ_ShÜt
 (1<<0è

	)

144 
	#CÍ_LÚg
 (1<<1è

	)

146 
	#CÍ_ShÜtNeg©ed
 (1<<2è

	)

148 
	#CÍ_LÚgNeg©ed
 (1<<3è

	)

150 
	#CÍ_LÚgIm¶ic™
 (1<<4è

	)

155 
	#CÍ_NÙO±iÚ
 0

	)

157 
	#CÍ_DÚe
 -1

	)

159 
	#CÍ_BadO±iÚ
 -2

	)

161 
	#CÍ_E¼Ü
 -3

	)

164 
	#CÍ_V®Size
 40

	)

166 
	#CÍ_V®IÁSize
 10

	)

177 (*
CÍ_V®P¬£Func
)(
	tCÍ_P¬£r
 *
	tşp
, cÚ¡ *
	tv¡r
,

178 
	tcom¶aš
, *
	tu£r_d©a
);

184 (*
CÍ_E¼ÜHªdËr
)(
	tCÍ_P¬£r
 *
	tşp
, cÚ¡ *
	tmes§ge
);

192 
	sCÍ_P¬£r
 {

193 cÚ¡ 
CÍ_O±iÚ
 *
İtiÚ
;

195 
Ãg©ed
;

197 
have_v®
;

198 cÚ¡ *
v¡r
;

202 
i
;

203 
u
;

204 
l
;

205 
ul
;

206 
d
;

207 cÚ¡ *
s
;

208 *
pv
;

209 #ifdeà
HAVE_INT64_TYPES


210 
št64_t
 
i64
;

211 
ušt64_t
 
u64
;

213 
cs
[
CÍ_V®Size
];

214 
ucs
[
CÍ_V®Size
];

215 
is
[
CÍ_V®IÁSize
];

216 
us
[
CÍ_V®IÁSize
];

217 } 
v®
;

220 *
u£r_d©a
;

223 
CÍ_IÁ”Çl
 *
š‹º®
;

227 #ià
__GNUC__
 >= 4

228 
	#CLP_SENTINEL
 
	`__©Œibu‹__
((
£Áš–
))

	)

230 
	#CLP_SENTINEL


	)

236 
CÍ_P¬£r
 *
CÍ_NewP¬£r
(
¬gc
, cÚ¡ * cÚ¡ *
¬gv
,

237 
nİt
, cÚ¡ 
CÍ_O±iÚ
 *
İt
);

240 
CÍ_D–‘eP¬£r
(
CÍ_P¬£r
 *
şp
);

244 cÚ¡ *
CÍ_Prog¿mName
(
CÍ_P¬£r
 *
şp
);

247 cÚ¡ *
CÍ_S‘Prog¿mName
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
Çme
);

251 
CÍ_E¼ÜHªdËr
 
CÍ_S‘E¼ÜHªdËr
(
CÍ_P¬£r
 *
şp
, CÍ_E¼ÜHªdË¸
”rh
);

254 
CÍ_S‘UTF8
(
CÍ_P¬£r
 *
şp
, 
utf8
);

257 
CÍ_O±iÚCh¬
(
CÍ_P¬£r
 *
şp
, 
c
);

260 
CÍ_S‘O±iÚCh¬
(
CÍ_P¬£r
 *
şp
, 
c
, 
ty³
);

263 
CÍ_S‘O±iÚs
(
CÍ_P¬£r
 *
şp
, 
nİt
, cÚ¡ 
CÍ_O±iÚ
 *
İt
);

266 
CÍ_S‘Argum’ts
(
CÍ_P¬£r
 *
şp
, 
¬gc
, cÚ¡ * cÚ¡ *
¬gv
);

269 
CÍ_S‘O±iÚProûssšg
(
CÍ_P¬£r
 *
şp
, 
Ú
);

272 
	#CÍ_Di§ÎowO±iÚs
 (1<<0è

	)

278 
CÍ_AddTy³
(
CÍ_P¬£r
 *
şp
, 
v®_ty³
, 
æags
,

279 
CÍ_V®P¬£Func
 
·r£r
, *
u£r_d©a
);

282 
	#CÍ_AÎowNumb”s
 (1<<0è

	)

286 
	#CÍ_SŒšgLi¡LÚg
 (1<<1è

	)

290 
CÍ_AddSŒšgLi¡Ty³Vec
(
CÍ_P¬£r
 *
şp
, 
v®_ty³
, 
æags
,

291 
n¡rs
, cÚ¡ * cÚ¡ *
¡rs
,

292 cÚ¡ *
v®s
);

295 
CÍ_AddSŒšgLi¡Ty³
(
CÍ_P¬£r
 *
şp
, 
v®_ty³
, 
æags
, ...)

296 
CLP_SENTINEL
;

300 
CÍ_Next
(
CÍ_P¬£r
 *
şp
);

303 cÚ¡ *
CÍ_Shiá
(
CÍ_P¬£r
 *
şp
, 
®low_İtiÚs
);

307 
CÍ_P¬£rS‹
 *
CÍ_NewP¬£rS‹
();

310 
CÍ_D–‘eP¬£rS‹
(
CÍ_P¬£rS‹
 *
¡©e
);

313 
CÍ_SaveP¬£r
(cÚ¡ 
CÍ_P¬£r
 *
şp
, 
CÍ_P¬£rS‹
 *
¡©e
);

316 
CÍ_Re¡ÜeP¬£r
(
CÍ_P¬£r
 *
şp
, cÚ¡ 
CÍ_P¬£rS‹
 *
¡©e
);

320 
CÍ_O±iÚE¼Ü
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
fÜm©
, ...);

323 
CÍ_v¢´štf
(
CÍ_P¬£r
* 
şp
, * 
¡r
, 
size_t
 
size
,

324 cÚ¡ * 
fÜm©
, 
va_li¡
 
v®
);

327 
CÍ_årštf
(
CÍ_P¬£r
* 
şp
, 
FILE
* 
f
, cÚ¡ * 
fÜm©
, ...);

330 
CÍ_vårštf
(
CÍ_P¬£r
* 
şp
, 
FILE
* 
f
, cÚ¡ * 
fÜm©
, 
va_li¡
 
v®
);

333 
CÍ_CurO±iÚNameBuf
(
CÍ_P¬£r
 *
şp
, *
buf
, 
Ën
);

336 cÚ¡ *
CÍ_CurO±iÚName
(
CÍ_P¬£r
 *
şp
);

339 
CÍ_IsLÚg
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
lÚg_Çme
);

342 
CÍ_IsShÜt
(
CÍ_P¬£r
 *
şp
, 
shÜt_Çme
);

344 #undeà
CLP_SENTINEL


345 #ifdeà
__ılu¥lus


	@lib/compiler.hh

16 #iâdeà
MASSTREE_COMPILER_HH


17 
	#MASSTREE_COMPILER_HH
 1

	)

19 
	~"cÚfig.h
"

22 
	#CACHE_LINE_SIZE
 64

	)

24 
	~<¡dšt.h
>

25 
	#__STDC_FORMAT_MACROS


	)

26 
	~<š‰y³s.h
>

27 
	~<¬·/š‘.h
>

28 #ià
HAVE_TYPE_TRAITS


29 
	~<ty³_Œa™s
>

31 
	~<ut™y
>

32 
	~<Ãw
>

34 
	#¬¿ysize
(
a
è(×è/ (×)[0]))

	)

36 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

37 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

39 #ià!
HAVE_CXX_STATIC_ASSERT


40 
	#¡©ic_as£¹
(
x
, 
msg
èxè0: !!(x):

	)

43 #ià!
HAVE_CXX_CONSTEXPR


44 
	#cÚ¡ex´
 cÚ¡

	)

47 #ià
HAVE_OFF_T_IS_LONG_LONG


48 
	#PRIdOFF_T
 "Îd"

	)

50 
	#PRIdOFF_T
 "ld"

	)

53 #ià
HAVE_SIZE_T_IS_UNSIGNED_LONG_LONG


54 
	#PRIdSIZE_T
 "Îu"

	)

55 
	#PRIdSSIZE_T
 "Îd"

	)

56 #–ià
HAVE_SIZE_T_IS_UNSIGNED_LONG


57 
	#PRIdSIZE_T
 "lu"

	)

58 
	#PRIdSSIZE_T
 "ld"

	)

60 
	#PRIdSIZE_T
 "u"

	)

61 
	#PRIdSSIZE_T
 "d"

	)

64 #ià(
__i386__
 || 
__x86_64__
è&& !
defšed
(
__x86__
)

65 
	#__x86__
 1

	)

67 
	#PREFER_X86
 1

	)

68 
	#ALLOW___SYNC_BUILTINS
 1

	)

70 #ià!
defšed
(
HAVE_INDIFFERENT_ALIGMENT
è&& (
__i386__
 || 
__x86_64__
 || 
__¬ch_um__
)

71 
	#HAVE_INDIFFERENT_ALIGNMENT
 1

	)

79 
šlše
 
	$ffs_msb
(
x
) {

80  (
x
 ? 
	`__butš_şz
(x) + 1 : 0);

81 
	}
}

83 
šlše
 
	$ffs_msb
(
x
) {

84  (
x
 ? 
	`__butš_şzl
(x) + 1 : 0);

85 
	}
}

87 
šlše
 
	$ffs_msb
(
x
) {

88  (
x
 ? 
	`__butš_şzÎ
(x) + 1 : 0);

89 
	}
}

96 
šlše
 
	$ãnû
() {

97 
asm
 volatile("" : : : "memory");

98 
	}
}

101 
šlše
 
	$acquœe_ãnû
() {

102 
asm
 volatile("" : : : "memory");

103 
	}
}

106 
šlše
 
	$»Ëa£_ãnû
() {

107 
asm
 volatile("" : : : "memory");

108 
	}
}

113 
šlše
 
	$»Ïx_ãnû
() {

114 
asm
 volatile("pause" : : : "memory");

115 
	}
}

118 
šlše
 
	$memÜy_ãnû
() {

119 
asm
 volatile("mfence" : : : "memory");

120 
	}
}

123 
	sdo_nÙhšg
 {

124 
İ”©Ü
()() const {

126 
	m‹m¶©e
 <
ty³Çme
 
	mT
>

127 
İ”©Ü
()(cÚ¡ 
	mT
&) const {

129 
	m‹m¶©e
 <
ty³Çme
 
	mT
,y³Çm
	mU
>

130 
İ”©Ü
()(cÚ¡ 
	mT
&, cÚ¡ 
	mU
&) const {

135 
	sãnû_funùiÚ
 {

136 
İ”©Ü
()() const {

137 
ãnû
();

142 
	s»Ïx_ãnû_funùiÚ
 {

143 
İ”©Ü
()() const {

144 
»Ïx_ãnû
();

149 
	sbackoff_ãnû_funùiÚ
 {

150 
backoff_ãnû_funùiÚ
()

151 : 
couÁ_
(0) {

153 
İ”©Ü
()() {

154 
i
 = 
couÁ_
; 
	mi
 >= 0; --i)

155 
»Ïx_ãnû
();

156 
	mcouÁ_
 = ((
couÁ_
 << 1) | 1) & 15;

158 
	m´iv©e
:

159 
couÁ_
;

163 
	g‹m¶©e
 <
	gSIZE
, 
ty³Çme
 
	gBARRIER
> 
	gsized_comp”_İ”©iÚs
;

165 
	g‹m¶©e
 <
ty³Çme
 
	gB
> 
	gsized_comp”_İ”©iÚs
<1, B> {

166 
	tty³
;

167 
šlše
 
ty³
 
xchg
Ñy³* 
objeù
,y³ 
Ãw_v®ue
) {

168 
asm
 volatile("xchgb %0,%1"

169 : "+q" (
Ãw_v®ue
), "+m" (*
	gobjeù
));

170 
B
()();

171  
	gÃw_v®ue
;

173 
šlše
 
ty³
 
v®_cmpxchg
Ñy³* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

174 #ià
__x86__
 && (
PREFER_X86
 || !
HAVE___SYNC_VAL_COMPARE_AND_SWAP
)

175 
asm
 volatile("lock; cmpxchgb %2,%1"

176 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
)

177 : "r" (
desœed
) : "cc");

178 
B
()();

179  
	gex³ùed
;

181  
__sync_v®_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

184 
šlše
 
boŞ
 
boŞ_cmpxchg
(
ty³
* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

185 #ià
HAVE___SYNC_BOOL_COMPARE_AND_SWAP
 && 
ALLOW___SYNC_BUILTINS


186  
__sync_boŞ_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

188 
boŞ
 
	g»suÉ
;

189 
asm
 volatile("lock; cmpxchgb %3,%1; sete %b2"

190 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
), "=q" (
	g»suÉ
)

191 : "q" (
desœed
) : "cc");

192 
B
()();

193  
	g»suÉ
;

196 
šlše
 
ty³
 
ãtch_ªd_add
Ñy³ *
objeù
,y³ 
add’d
) {

197 #ià
__x86__
 && (
PREFER_X86
 || !
HAVE___SYNC_FETCH_AND_ADD
)

198 
asm
 volatile("lock; xaddb %0,%1"

199 : "+q" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

200 
B
()();

201  
	gadd’d
;

203  
__sync_ãtch_ªd_add
(
objeù
, 
add’d
);

206 
šlše
 
©omic_Ü
(
ty³
* 
objeù
,y³ 
add’d
) {

207 #ià
__x86__


208 
asm
 volatile("lock; orb %0,%1"

209 : "ô" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

210 
B
()();

212 
__sync_ãtch_ªd_Ü
(
objeù
, 
add’d
);

217 
	g‹m¶©e
 <
ty³Çme
 
	gB
> 
	gsized_comp”_İ”©iÚs
<2, B> {

218 #ià
SIZEOF_SHORT
 == 2

219 
	tty³
;

221 
št16_t
 
	tty³
;

223 
šlše
 
ty³
 
xchg
Ñy³* 
objeù
,y³ 
Ãw_v®ue
) {

224 
asm
 volatile("xchgw %0,%1"

225 : "+r" (
Ãw_v®ue
), "+m" (*
	gobjeù
));

226 
B
()();

227  
	gÃw_v®ue
;

229 
šlše
 
ty³
 
v®_cmpxchg
Ñy³* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

230 #ià
__x86__
 && (
PREFER_X86
 || !
HAVE___SYNC_VAL_COMPARE_AND_SWAP
)

231 
asm
 volatile("lock; cmpxchgw %2,%1"

232 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
)

233 : "r" (
desœed
) : "cc");

234 
B
()();

235  
	gex³ùed
;

237  
__sync_v®_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

240 
šlše
 
boŞ
 
boŞ_cmpxchg
(
ty³
* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

241 #ià
HAVE___SYNC_BOOL_COMPARE_AND_SWAP
 && 
ALLOW___SYNC_BUILTINS


242  
__sync_boŞ_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

244 
boŞ
 
	g»suÉ
;

245 
asm
 volatile("lock; cmpxchgw %3,%1; sete %b2"

246 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
), "=q" (
	g»suÉ
)

247 : "r" (
desœed
) : "cc");

248 
B
()();

249  
	g»suÉ
;

252 
šlše
 
ty³
 
ãtch_ªd_add
Ñy³* 
objeù
,y³ 
add’d
) {

253 #ià
__x86__
 && (
PREFER_X86
 || !
HAVE___SYNC_FETCH_AND_ADD
)

254 
asm
 volatile("lock; xaddw %0,%1"

255 : "+r" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

256 
B
()();

257  
	gadd’d
;

259  
__sync_ãtch_ªd_add
(
objeù
, 
add’d
);

262 
šlše
 
©omic_Ü
(
ty³
* 
objeù
,y³ 
add’d
) {

263 #ià
__x86__


264 
asm
 volatile("lock; orw %0,%1"

265 : "ô" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

266 
B
()();

268 
__sync_ãtch_ªd_Ü
(
objeù
, 
add’d
);

273 
	g‹m¶©e
 <
ty³Çme
 
	gB
> 
	gsized_comp”_İ”©iÚs
<4, B> {

274 #ià
SIZEOF_INT
 == 4

275 
	tty³
;

277 
št32_t
 
	tty³
;

279 
šlše
 
ty³
 
xchg
Ñy³* 
objeù
,y³ 
Ãw_v®ue
) {

280 
asm
 volatile("xchgl %0,%1"

281 : "+r" (
Ãw_v®ue
), "+m" (*
	gobjeù
));

282 
B
()();

283  
	gÃw_v®ue
;

285 
šlše
 
ty³
 
v®_cmpxchg
Ñy³* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

286 #ià
__x86__
 && (
PREFER_X86
 || !
HAVE___SYNC_VAL_COMPARE_AND_SWAP
)

287 
asm
 volatile("lock; cmpxchgl %2,%1"

288 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
)

289 : "r" (
desœed
) : "cc");

290 
B
()();

291  
	gex³ùed
;

293  
__sync_v®_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

296 
šlše
 
boŞ
 
boŞ_cmpxchg
(
ty³
* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

297 #ià
HAVE___SYNC_BOOL_COMPARE_AND_SWAP
 && 
ALLOW___SYNC_BUILTINS


298  
__sync_boŞ_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

300 
boŞ
 
	g»suÉ
;

301 
asm
 volatile("lock; cmpxchgl %3,%1; sete %b2"

302 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
), "=q" (
	g»suÉ
)

303 : "r" (
desœed
) : "cc");

304 
B
()();

305  
	g»suÉ
;

308 
šlše
 
ty³
 
ãtch_ªd_add
Ñy³ *
objeù
,y³ 
add’d
) {

309 #ià
__x86__
 && (
PREFER_X86
 || !
HAVE___SYNC_FETCH_AND_ADD
)

310 
asm
 volatile("lock; xaddl %0,%1"

311 : "+r" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

312 
B
()();

313  
	gadd’d
;

315  
__sync_ãtch_ªd_add
(
objeù
, 
add’d
);

318 
šlše
 
©omic_Ü
(
ty³
* 
objeù
,y³ 
add’d
) {

319 #ià
__x86__


320 
asm
 volatile("lock; orl %0,%1"

321 : "ô" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

322 
B
()();

324 
__sync_ãtch_ªd_Ü
(
objeù
, 
add’d
);

329 
	g‹m¶©e
 <
ty³Çme
 
	gB
> 
	gsized_comp”_İ”©iÚs
<8, B> {

330 #ià
SIZEOF_LONG_LONG
 == 8

331 
	tty³
;

332 #–ià
SIZEOF_LONG
 == 8

333 
	tty³
;

335 
št64_t
 
	tty³
;

337 #ià
__x86_64__


338 
šlše
 
ty³
 
xchg
Ñy³* 
objeù
,y³ 
Ãw_v®ue
) {

339 
asm
 volatile("xchgq %0,%1"

340 : "+r" (
Ãw_v®ue
), "+m" (*
	gobjeù
));

341 
B
()();

342  
	gÃw_v®ue
;

345 
šlše
 
ty³
 
v®_cmpxchg
Ñy³* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

346 #ià
__x86_64__
 && (
PREFER_X86
 || !
HAVE___SYNC_VAL_COMPARE_AND_SWAP_8
)

347 
asm
 volatile("lock; cmpxchgq %2,%1"

348 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
)

349 : "r" (
desœed
) : "cc");

350 
B
()();

351  
	gex³ùed
;

352 #–ià
__i386__
 && (
PREFER_X86
 || !
HAVE___SYNC_VAL_COMPARE_AND_SWAP_8
)

353 
ušt32_t
 
ex³ùed_low
(
ex³ùed
), 
ex³ùed_high
(expected >> 32),

354 
desœed_low
(
desœed
), 
desœed_high
(desired >> 32);

355 
asm
 volatile("lock; cmpxchg8b %2"

356 : "+a" (
ex³ùed_low
), "+d" (
	gex³ùed_high
), "+m" (*
	gobjeù
)

357 : "b" (
desœed_low
), "c" (
	gdesœed_high
) : "cc");

358 
B
()();

359  ((
	gušt64_t
è
	gex³ùed_high
 << 32è| 
	gex³ùed_low
;

360 #–ià
HAVE___SYNC_VAL_COMPARE_AND_SWAP_8


361  
__sync_v®_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

364 
šlše
 
boŞ
 
boŞ_cmpxchg
(
ty³
* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

365 #ià
HAVE___SYNC_BOOL_COMPARE_AND_SWAP_8
 && 
ALLOW___SYNC_BUILTINS


366  
__sync_boŞ_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

367 #–ià
__x86_64__


368 
boŞ
 
	g»suÉ
;

369 
asm
 volatile("lock; cmpxchgq %3,%1; sete %b2"

370 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
), "=q" (
	g»suÉ
)

371 : "r" (
desœed
) : "cc");

372 
B
()();

373  
	g»suÉ
;

375 
ušt32_t
 
ex³ùed_low
(
ex³ùed
), 
ex³ùed_high
(expected >> 32),

376 
desœed_low
(
desœed
), 
desœed_high
(desired >> 32);

377 
boŞ
 
	g»suÉ
;

378 
asm
 volatile("lock; cmpxchg8b %2; sete %b4"

379 : "+a" (
ex³ùed_low
), "+d" (
	gex³ùed_high
),

380 "+m" (*
	gobjeù
), "=q" (
	g»suÉ
)

381 : "b" (
desœed_low
), "c" (
	gdesœed_high
) : "cc");

382 
B
()();

383  
	g»suÉ
;

386 #ià
__x86_64__
 || 
HAVE___SYNC_FETCH_AND_ADD_8


387 
šlše
 
ty³
 
ãtch_ªd_add
Ñy³* 
objeù
,y³ 
add’d
) {

388 #ià
__x86_64__
 && (
PREFER_X86
 || !
HAVE___SYNC_FETCH_AND_ADD_8
)

389 
asm
 volatile("lock; xaddq %0,%1"

390 : "+r" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

391 
B
()();

392  
	gadd’d
;

394  
__sync_ãtch_ªd_add
(
objeù
, 
add’d
);

398 #ià
__x86_64__
 || 
HAVE___SYNC_FETCH_AND_OR_8


399 
šlše
 
©omic_Ü
(
ty³
* 
objeù
,y³ 
add’d
) {

400 #ià
__x86_64__


401 
asm
 volatile("lock; orq %0,%1"

402 : "ô" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

403 
B
()();

405 
__sync_ãtch_ªd_Ü
(
objeù
, 
add’d
);

411 
	g‹m¶©e
<
ty³Çme
 
	gT
>

412 
šlše
 
T
 
	$xchg
(
T
* 
objeù
, T 
Ãw_v®ue
) {

413 
sized_comp”_İ”©iÚs
<(
	tT
), 
	tãnû_funùiÚ
> 
	tsco_t
;

414 
ty³Çme
 
	tsco_t
::
	tty³
ype;

415  (
T
è
sco_t
::
	`xchg
((
ty³
*è
objeù
, (ty³è
Ãw_v®ue
);

416 
	}
}

418 
šlše
 
št8_t
 
	$xchg
(
št8_t
* 
objeù
, 
Ãw_v®ue
) {

419  
	`xchg
(
objeù
, (
št8_t
è
Ãw_v®ue
);

420 
	}
}

421 
šlše
 
ušt8_t
 
	$xchg
(
ušt8_t
* 
objeù
, 
Ãw_v®ue
) {

422  
	`xchg
(
objeù
, (
ušt8_t
è
Ãw_v®ue
);

423 
	}
}

424 
šlše
 
št16_t
 
	$xchg
(
št16_t
* 
objeù
, 
Ãw_v®ue
) {

425  
	`xchg
(
objeù
, (
št16_t
è
Ãw_v®ue
);

426 
	}
}

427 
šlše
 
ušt16_t
 
	$xchg
(
ušt16_t
* 
objeù
, 
Ãw_v®ue
) {

428  
	`xchg
(
objeù
, (
ušt16_t
è
Ãw_v®ue
);

429 
	}
}

430 
šlše
 
	$xchg
(* 
objeù
, 
Ãw_v®ue
) {

431  
	`xchg
(
objeù
, (è
Ãw_v®ue
);

432 
	}
}

447 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

448 
šlše
 
T
 
	$cmpxchg
(
T
* 
objeù
, T 
ex³ùed
, T 
desœed
) {

449 
sized_comp”_İ”©iÚs
<(
	tT
), 
	tãnû_funùiÚ
> 
	tsco_t
;

450 
ty³Çme
 
	tsco_t
::
	tty³
ype;

451  (
T
è
sco_t
::
	`v®_cmpxchg
((
ty³
*è
objeù
, (ty³è
ex³ùed
, (ty³è
desœed
);

452 
	}
}

454 
šlše
 
	$cmpxchg
(*
objeù
, 
ex³ùed
, 
desœed
) {

455  
	`cmpxchg
(
objeù
, (
ex³ùed
), (
desœed
));

456 
	}
}

473 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

474 
šlše
 
boŞ
 
	$boŞ_cmpxchg
(
T
* 
objeù
, T 
ex³ùed
, T 
desœed
) {

475 
sized_comp”_İ”©iÚs
<(
	tT
), 
	tãnû_funùiÚ
> 
	tsco_t
;

476 
ty³Çme
 
	tsco_t
::
	tty³
ype;

477  
sco_t
::
	`boŞ_cmpxchg
((
ty³
*è
objeù
, (ty³è
ex³ùed
, (ty³è
desœed
);

478 
	}
}

480 
šlše
 
boŞ
 
	$boŞ_cmpxchg
(
ušt8_t
* 
objeù
, 
ex³ùed
, 
desœed
) {

481  
	`boŞ_cmpxchg
(
objeù
, 
	`ušt8_t
(
ex³ùed
), ušt8_t(
desœed
));

482 
	}
}

483 
šlše
 
boŞ
 
	$boŞ_cmpxchg
(*
objeù
, 
ex³ùed
, 
desœed
) {

484  
	`boŞ_cmpxchg
(
objeù
, (
ex³ùed
), (
desœed
));

485 
	}
}

491 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

492 
šlše
 
T
 
	$ãtch_ªd_add
(
T
* 
objeù
, T 
add’d
) {

493 
sized_comp”_İ”©iÚs
<(
	tT
), 
	tãnû_funùiÚ
> 
	tsco_t
;

494 
ty³Çme
 
	tsco_t
::
	tty³
ype;

495  (
T
è
sco_t
::
	`ãtch_ªd_add
((
ty³
*è
objeù
, (ty³è
add’d
);

496 
	}
}

498 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

499 
šlše
 
T
* 
	$ãtch_ªd_add
(
T
** 
objeù
, 
add’d
) {

500 
sized_comp”_İ”©iÚs
<(
	tT
*), 
	tãnû_funùiÚ
> 
	tsco_t
;

501 
ty³Çme
 
	tsco_t
::
	tty³
ype;

502  (
T
*è
sco_t
::
	`ãtch_ªd_add
((
ty³
*è
objeù
, (ty³è(
add’d
 * (T)));

503 
	}
}

505 
šlše
 
št8_t
 
	$ãtch_ªd_add
(
št8_t
* 
objeù
, 
add’d
) {

506  
	`ãtch_ªd_add
(
objeù
, 
	`št8_t
(
add’d
));

507 
	}
}

508 
šlše
 
ušt8_t
 
	$ãtch_ªd_add
(
ušt8_t
* 
objeù
, 
add’d
) {

509  
	`ãtch_ªd_add
(
objeù
, 
	`ušt8_t
(
add’d
));

510 
	}
}

511 
šlše
 
št16_t
 
	$ãtch_ªd_add
(
št16_t
* 
objeù
, 
add’d
) {

512  
	`ãtch_ªd_add
(
objeù
, 
	`št16_t
(
add’d
));

513 
	}
}

514 
šlše
 
ušt16_t
 
	$ãtch_ªd_add
(
ušt16_t
* 
objeù
, 
add’d
) {

515  
	`ãtch_ªd_add
(
objeù
, 
	`ušt16_t
(
add’d
));

516 
	}
}

517 
šlše
 
	$ãtch_ªd_add
(* 
objeù
, 
add’d
) {

518  
	`ãtch_ªd_add
(
objeù
, (
add’d
));

519 
	}
}

520 
šlše
 
	$ãtch_ªd_add
(* 
objeù
, 
add’d
) {

521  
	`ãtch_ªd_add
(
objeù
, ()(
add’d
));

522 
	}
}

526 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

527 
šlše
 
	$‹¡_ªd_£t_acquœe
(
T
* 
objeù
) {

528 
sized_comp”_İ”©iÚs
<(
	tT
), 
	tdo_nÙhšg
> 
	tsco_t
;

529 
ty³Çme
 
	tsco_t
::
	tty³
ype;

530 
sco_t
::
	`xchg
((
ty³
*è
objeù
, (type) 1))

531 
	`»Ïx_ãnû
();

532 
	`acquœe_ãnû
();

533 
	}
}

536 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

537 
šlše
 
	$‹¡_ªd_£t_»Ëa£
(
T
* 
objeù
) {

538 
	`»Ëa£_ãnû
();

539 *
objeù
 = 
	`T
();

540 
	}
}

546 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

547 
šlše
 
	$©omic_Ü
(
T
* 
objeù
, T 
add’d
) {

548 
sized_comp”_İ”©iÚs
<(
	tT
), 
	tãnû_funùiÚ
> 
	tsco_t
;

549 
ty³Çme
 
	tsco_t
::
	tty³
ype;

550 
sco_t
::
	`©omic_Ü
((
ty³
*è
objeù
, (ty³è
add’d
);

551 
	}
}

553 
šlše
 
	$©omic_Ü
(
št8_t
* 
objeù
, 
add’d
) {

554 
	`©omic_Ü
(
objeù
, 
	`št8_t
(
add’d
));

555 
	}
}

556 
šlše
 
	$©omic_Ü
(
ušt8_t
* 
objeù
, 
add’d
) {

557 
	`©omic_Ü
(
objeù
, 
	`ušt8_t
(
add’d
));

558 
	}
}

559 
šlše
 
	$©omic_Ü
(
št16_t
* 
objeù
, 
add’d
) {

560 
	`©omic_Ü
(
objeù
, 
	`št16_t
(
add’d
));

561 
	}
}

562 
šlše
 
	$©omic_Ü
(
ušt16_t
* 
objeù
, 
add’d
) {

563 
	`©omic_Ü
(
objeù
, 
	`ušt16_t
(
add’d
));

564 
	}
}

565 
šlše
 
	$©omic_Ü
(* 
objeù
, 
add’d
) {

566 
	`©omic_Ü
(
objeù
, (
add’d
));

567 
	}
}

568 
šlše
 
	$©omic_Ü
(* 
objeù
, 
add’d
) {

569 
	`©omic_Ü
(
objeù
, ()(
add’d
));

570 
	}
}

574 #ià!
PREFETCH_DEFINED


575 
šlše
 
	$´eãtch
(cÚ¡ *
±r
) {

576 #ifdeà
NOPREFETCH


577 (è
±r
;

579 ¡ruù { 
x
[
CACHE_LINE_SIZE
]; } 
	tÿch–še_t
;

580 
asm
 vŞ©e("´eãtcht0 %0" : : "m" (*(cÚ¡ 
ÿch–še_t
 *)
±r
));

582 
	}
}

585 
šlše
 
	$´eãtchÁa
(cÚ¡ *
±r
) {

586 #ifdeà
NOPREFETCH


587 (è
±r
;

589 ¡ruù { 
x
[
CACHE_LINE_SIZE
]; } 
	tÿch–še_t
;

590 
asm
 vŞ©e("´eãtchÁ¨%0" : : "m" (*(cÚ¡ 
ÿch–še_t
 *)
±r
));

592 
	}
}

595 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

596 
	sv®ue_´eãtch”
 {

597 
İ”©Ü
()(
	mT
) {

601 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

602 
	gv®ue_´eãtch”
<
	gT
 *> {

603 
İ”©Ü
()(
T
 *
	gp
) {

604 
´eãtch
((cÚ¡ *è
p
);

610 
šlše
 
ušt64_t
 
	$Áohq
(
ušt64_t
 
v®
) {

611 #ifdeà
__i386__


614 
ušt32_t
 
a
;

615 
ušt32_t
 
b
;

616 } 
s
;

617 
ušt64_t
 
u
;

618 } 
v
;

619 
v
.
u
 = 
v®
;

620 
	`asm
("bswapl %0; bswapl %1; xchgl %0,%1"

621 : "+r" (
v
.
s
.
a
), "+r" (v.s.
b
));

622  
v
.
u
;

624 
	`asm
("bsw­q %0" : "+r" (
v®
));

625  
v®
;

627 
	}
}

629 
šlše
 
ušt64_t
 
	$htÚq
(
ušt64_t
 
v®
) {

630  
	`Áohq
(
v®
);

631 
	}
}

640 #ià
HAVE___BUILTIN_CLZ


641 
šlše
 
	$şz
(
x
) {

642  
	`__butš_şz
(
x
);

643 
	}
}

644 
šlše
 
	$şz
(
x
) {

645  
	`__butš_şz
(
x
);

646 
	}
}

649 #ià
HAVE___BUILTIN_CLZL


650 
šlše
 
	$şz
(
x
) {

651  
	`__butš_şzl
(
x
);

652 
	}
}

653 
šlše
 
	$şz
(
x
) {

654  
	`__butš_şzl
(
x
);

655 
	}
}

658 #ià
HAVE___BUILTIN_CLZLL


659 
šlše
 
	$şz
(
x
) {

660  
	`__butš_şzÎ
(
x
);

661 
	}
}

662 
šlše
 
	$şz
(
x
) {

663  
	`__butš_şzÎ
(
x
);

664 
	}
}

671 #ià
HAVE___BUILTIN_CTZ


672 
šlše
 
	$ùz
(
x
) {

673  
	`__butš_ùz
(
x
);

674 
	}
}

675 
šlše
 
	$ùz
(
x
) {

676  
	`__butš_ùz
(
x
);

677 
	}
}

680 #ià
HAVE___BUILTIN_CTZL


681 
šlše
 
	$ùz
(
x
) {

682  
	`__butš_ùzl
(
x
);

683 
	}
}

684 
šlše
 
	$ùz
(
x
) {

685  
	`__butš_ùzl
(
x
);

686 
	}
}

689 #ià
HAVE___BUILTIN_CTZLL


690 
šlše
 
	$ùz
(
x
) {

691  
	`__butš_ùzÎ
(
x
);

692 
	}
}

693 
šlše
 
	$ùz
(
x
) {

694  
	`__butš_ùzÎ
(
x
);

695 
	}
}

698 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

699 
šlše
 
T
 
	$iû
(
T
 
x
, 
U
 
y
) {

700 
U
 
mod
 = 
x
 % 
y
;

701  
x
 + (
mod
 ? 
y
 - mod : 0);

702 
	}
}

708 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

709 
šlše
 
T
 
	$iû_log2
(
T
 
x
) {

710  
	`T
(1è<< ((
T
è* 8 - 
	`şz
(
x
) - !(x & (x - 1)));

711 
	}
}

715 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

716 
šlše
 
T
 
	$iæoÜ_log2
(
T
 
x
) {

717  
	`T
(1è<< ((
T
è* 8 - 1 - 
	`şz
(
x
));

718 
	}
}

723 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

724 
šlše
 
	$fšd_lowe¡_z”o_nibbË
(
T
 
x
) {

725 
	`¡©ic_as£¹
((
T
) <= (), "T isoo big");

726 #ià
SIZEOF_LONG_LONG
 == 16

727 
T
 
h
 = 
	`T
(0x88888888888888888888888888888888ULL), 
l
 = T(0x11111111111111111111111111111111ULL);

729 
T
 
h
 = 
	`T
(0x8888888888888888ULL), 
l
 = T(0x1111111111111111ULL);

731 
T
 
t
 = 
h
 & (
x
 - 
l
) & ~x;

732  
t
 ? 
	`ùz
(t) >> 2 : -1;

733 
	}
}

740 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

741  
x
;

742 
	}
}

744 
šlše
 sigÃd 
	$ho¡_to_Ãt_Üd”
(sigÃd 
x
) {

745  
x
;

746 
	}
}

748 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

749  
x
;

750 
	}
}

752 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

753  
	`htÚs
(
x
);

754 
	}
}

756 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

757  
	`htÚs
(
x
);

758 
	}
}

760 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

761  
	`htÚl
(
x
);

762 
	}
}

764 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

765  
	`htÚl
(
x
);

766 
	}
}

767 #ià
SIZEOF_LONG
 == 4

769 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

770  
	`htÚl
(
x
);

771 
	}
}

773 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

774  
	`htÚl
(
x
);

775 
	}
}

776 #–ià
SIZEOF_LONG
 == 8

778 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

779  
	`htÚq
(
x
);

780 
	}
}

782 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

783  
	`htÚq
(
x
);

784 
	}
}

786 #ià
SIZEOF_LONG_LONG
 == 8

788 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

789  
	`htÚq
(
x
);

790 
	}
}

792 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

793  
	`htÚq
(
x
);

794 
	}
}

796 #ià!
HAVE_INT64_T_IS_LONG
 && !
HAVE_INT64_T_IS_LONG_LONG


798 
šlše
 
št64_t
 
	$ho¡_to_Ãt_Üd”
(
št64_t
 
x
) {

799  
	`htÚq
(
x
);

800 
	}
}

802 
šlše
 
ušt64_t
 
	$ho¡_to_Ãt_Üd”
(
ušt64_t
 
x
) {

803  
	`htÚq
(
x
);

804 
	}
}

807 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

808 uniÚ { 
f
; 
ušt32_t
 
i
; } 
v
;

809 
v
.
f
 = 
x
;

810 
v
.
i
 = 
	`ho¡_to_Ãt_Üd”
(v.i);

811  
v
.
f
;

812 
	}
}

814 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

815 uniÚ { 
d
; 
ušt64_t
 
i
; } 
v
;

816 
v
.
d
 = 
x
;

817 
v
.
i
 = 
	`ho¡_to_Ãt_Üd”
(v.i);

818  
v
.
d
;

819 
	}
}

826 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

827  
x
;

828 
	}
}

830 
šlše
 sigÃd 
	$Ãt_to_ho¡_Üd”
(sigÃd 
x
) {

831  
x
;

832 
	}
}

834 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

835  
x
;

836 
	}
}

838 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

839  
	`Áohs
(
x
);

840 
	}
}

842 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

843  
	`Áohs
(
x
);

844 
	}
}

846 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

847  
	`Áohl
(
x
);

848 
	}
}

850 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

851  
	`Áohl
(
x
);

852 
	}
}

853 #ià
SIZEOF_LONG
 == 4

855 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

856  
	`Áohl
(
x
);

857 
	}
}

859 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

860  
	`Áohl
(
x
);

861 
	}
}

862 #–ià
SIZEOF_LONG
 == 8

864 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

865  
	`Áohq
(
x
);

866 
	}
}

868 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

869  
	`Áohq
(
x
);

870 
	}
}

872 #ià
SIZEOF_LONG_LONG
 == 8

874 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

875  
	`Áohq
(
x
);

876 
	}
}

878 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

879  
	`Áohq
(
x
);

880 
	}
}

882 #ià!
HAVE_INT64_T_IS_LONG
 && !
HAVE_INT64_T_IS_LONG_LONG


884 
šlše
 
št64_t
 
	$Ãt_to_ho¡_Üd”
(
št64_t
 
x
) {

885  
	`Áohq
(
x
);

886 
	}
}

888 
šlše
 
ušt64_t
 
	$Ãt_to_ho¡_Üd”
(
ušt64_t
 
x
) {

889  
	`Áohq
(
x
);

890 
	}
}

893 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

894  
	`ho¡_to_Ãt_Üd”
(
x
);

895 
	}
}

897 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

898  
	`ho¡_to_Ãt_Üd”
(
x
);

899 
	}
}

901 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	smake_®Ÿ§bË
 {};

902 
	#MAKE_ALIASABLE
(
T
è
‹m¶©e
 <> 
make_®Ÿ§bË
<T> { T 
	tty³
 
	t__©Œibu‹__
((
	t__may_®Ÿs__
)); }

	)

903 
MAKE_ALIASABLE
();

904 
MAKE_ALIASABLE
(signed );

905 
MAKE_ALIASABLE
();

906 
MAKE_ALIASABLE
();

907 
MAKE_ALIASABLE
();

908 
MAKE_ALIASABLE
();

909 
MAKE_ALIASABLE
();

910 
MAKE_ALIASABLE
();

911 
MAKE_ALIASABLE
();

912 
MAKE_ALIASABLE
();

913 
MAKE_ALIASABLE
();

914 
MAKE_ALIASABLE
();

915 
MAKE_ALIASABLE
();

916 #undeà
MAKE_ALIASABLE


918 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

919 
šlše
 * 
	$wr™e_š_ho¡_Üd”
(* 
s
, 
T
 
x
) {

920 #ià
HAVE_INDIFFERENT_ALIGNMENT


921 *
»š‹½»t_ÿ¡
<
ty³Çme
 
make_®Ÿ§bË
<
T
>::
ty³
*>(
s
èğ
x
;

923 
	`memıy
(
s
, &
x
, (x));

925  
s
 + (
x
);

926 
	}
}

928 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

929 
šlše
 
ušt8_t
* 
	$wr™e_š_ho¡_Üd”
(
ušt8_t
* 
s
, 
T
 
x
) {

930  
»š‹½»t_ÿ¡
<
ušt8_t
*>

931 (
	`wr™e_š_ho¡_Üd”
(
»š‹½»t_ÿ¡
<*>(
s
), 
x
));

932 
	}
}

934 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

935 
šlše
 
T
 
	$»ad_š_ho¡_Üd”
(cÚ¡ * 
s
) {

936 #ià
HAVE_INDIFFERENT_ALIGNMENT


937  *
»š‹½»t_ÿ¡
<cÚ¡ 
ty³Çme
 
make_®Ÿ§bË
<
T
>::
ty³
*>(
s
);

939 
T
 
x
;

940 
	`memıy
(&
x
, 
s
, (x));

941  
x
;

943 
	}
}

945 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

946 
šlše
 
T
 
	$»ad_š_ho¡_Üd”
(cÚ¡ 
ušt8_t
* 
s
) {

947  
»ad_š_ho¡_Üd”
<
T
>(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
));

948 
	}
}

950 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

951 
šlše
 * 
	$wr™e_š_Ãt_Üd”
(* 
s
, 
T
 
x
) {

952  
wr™e_š_ho¡_Üd”
<
T
>(
s
, 
	`ho¡_to_Ãt_Üd”
(
x
));

953 
	}
}

955 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

956 
šlše
 
ušt8_t
* 
	$wr™e_š_Ãt_Üd”
(
ušt8_t
* 
s
, 
T
 
x
) {

957  
»š‹½»t_ÿ¡
<
ušt8_t
*>

958 (
	`wr™e_š_Ãt_Üd”
(
»š‹½»t_ÿ¡
<*>(
s
), 
x
));

959 
	}
}

961 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

962 
šlše
 
T
 
	$»ad_š_Ãt_Üd”
(cÚ¡ * 
s
) {

963  
	`Ãt_to_ho¡_Üd”
(
»ad_š_ho¡_Üd”
<
T
>(
s
));

964 
	}
}

966 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

967 
šlše
 
T
 
	$»ad_š_Ãt_Üd”
(cÚ¡ 
ušt8_t
* 
s
) {

968  
»ad_š_Ãt_Üd”
<
T
>(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
));

969 
	}
}

972 
šlše
 
ušt64_t
 
	$»ad_pmc
(
ušt32_t
 
ecx
) {

973 
ušt32_t
 
a
, 
d
;

974 
__asm
 
	`__vŞ©e
("rdpmc" : "÷"(
a
), "=d"(
d
è: "c"(
ecx
));

975  ((
ušt64_t
)
a
è| (((ušt64_t)
d
) << 32);

976 
	}
}

978 
šlše
 
ušt64_t
 
	$»ad_tsc
()

980 
ušt32_t
 
low
, 
high
;

981 
asm
 vŞ©e("rdtsc" : "÷" (
low
), "=d" (
high
));

982  ((
ušt64_t
)
low
è| (((ušt64_t)
high
) << 32);

983 
	}
}

985 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

986 
šlše
 
	$com·»
(
T
 
a
, T 
b
) {

987 ià(
a
 =ğ
b
)

990  
a
 < 
b
 ? -1 : 1;

991 
	}
}

995 
Çme¥aû
 
	gmass
 {

997 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	sty³_synÚym
 {

998 
T
 
	tty³
;

1002 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS


1003 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
T
 
	gV
>

1004 
usšg
 
	gš‹g¿l_cÚ¡ªt
 = 
¡d
::
š‹g¿l_cÚ¡ªt
<
T
, 
	gV
>;

1005 
	g¡d
::
	tŒue_ty³
rue_type;

1006 
	g¡d
::
	tçl£_ty³
 false_type;

1008 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
T
 
	gV
>

1009 
	sš‹g¿l_cÚ¡ªt
 {

1010 
	gš‹g¿l_cÚ¡ªt
<
	tT
, 
	tV
> 
	tty³
;

1011 
T
 
	tv®ue_ty³
;

1012 
cÚ¡ex´
 
T
 
	gv®ue
 = 
V
;

1014 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
T
 
	gV
> 
cÚ¡ex´
 T 
	gš‹g¿l_cÚ¡ªt
<T, V>::
v®ue
;

1015 
	gš‹g¿l_cÚ¡ªt
<
	tboŞ
, 
	tŒue
> 
	tŒue_ty³
;

1016 
	gš‹g¿l_cÚ¡ªt
<
	tboŞ
, 
	tçl£
> 
	tçl£_ty³
;

1019 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS


1020 
	g‹m¶©e
 <
boŞ
 
	gB
, 
ty³Çme
 
	gT
,y³Çm
	gF
>

1021 
usšg
 
	gcÚd™iÚ®
 = 
¡d
::
cÚd™iÚ®
<
B
, 
	gT
, 
	gF
>;

1023 
	g‹m¶©e
 <
boŞ
 
	gB
, 
ty³Çme
 
	gT
,y³Çm
	gF
> 
	scÚd™iÚ®
 {};

1024 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gF
> 
	gcÚd™iÚ®
<
	gŒue
, T, F> {

1025 
T
 
	tty³
;

1027 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gF
> 
	gcÚd™iÚ®
<
	gçl£
, T, F> {

1028 
F
 
	tty³
;

1032 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS


1033 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	g»move_cÚ¡
 = 
¡d
::
»move_cÚ¡
<
T
>;

1034 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	g»move_vŞ©e
 = 
¡d
::
»move_vŞ©e
<
T
>;

1035 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	g»move_cv
 = 
¡d
::
»move_cv
<
T
>;

1037 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	g»move_cÚ¡
 : 
public
 
ty³_synÚym
<
T
> {};

1038 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	g»move_cÚ¡
<cÚ¡ T> : 
public
 
ty³_synÚym
<
T
> {};

1039 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	g»move_vŞ©e
 : 
public
 
ty³_synÚym
<
T
> {};

1040 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	g»move_vŞ©e
<vŞ©T> : 
public
 
ty³_synÚym
<
T
> {};

1041 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	s»move_cv
 {

1042 
ty³Çme
 
	t»move_cÚ¡
<
	tty³Çme
 
	t»move_vŞ©e
<
	tT
>::
	tty³
>::typeype;

1046 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS


1047 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gis_poš‹r
 = 
¡d
::
is_poš‹r
<
T
>;

1049 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_poš‹r_h–³r
 : 
public
 
çl£_ty³
 {};

1050 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_poš‹r_h–³r
<T*> : 
public
 
Œue_ty³
 {};

1051 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_poš‹r


1052 : 
public
 
š‹g¿l_cÚ¡ªt
<
boŞ
, 
	gis_poš‹r_h–³r
<
ty³Çme
 
	g»move_cv
<
	gT
>::
ty³
>::
v®ue
> {};

1055 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS


1056 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gis_»ã»nû
 = 
¡d
::
is_»ã»nû
<
T
>;

1058 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_»ã»nû_h–³r
 : 
public
 
çl£_ty³
 {};

1059 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_»ã»nû_h–³r
<T&> : 
public
 
Œue_ty³
 {};

1060 #ià
HAVE_CXX_RVALUE_REFERENCES


1061 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_»ã»nû_h–³r
<T&&> : 
public
 
Œue_ty³
 {};

1063 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_»ã»nû


1064 : 
public
 
š‹g¿l_cÚ¡ªt
<
boŞ
, 
	gis_»ã»nû_h–³r
<
ty³Çme
 
	g»move_cv
<
	gT
>::
ty³
>::
v®ue
> {};

1067 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS


1068 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gmake_unsigÃd
 = 
¡d
::
make_unsigÃd
<
T
>;

1069 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gmake_sigÃd
 = 
¡d
::
make_sigÃd
<
T
>;

1071 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	smake_unsigÃd
 {};

1072 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1073 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<sigÃd > : 
public
 
ty³_synÚym
<> {};

1074 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1075 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1076 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1077 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1078 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1079 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1080 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1081 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1082 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1084 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	smake_sigÃd
 {};

1085 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<signed > {};

1086 
	g‹m¶©e
 <> 
	gmake_sigÃd
<sigÃd > : 
public
 
ty³_synÚym
<signed > {};

1087 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<signed > {};

1088 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1089 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1090 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1091 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1092 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1093 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1094 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1095 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1104 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS
 && 
HAVE_STD_IS_TRIVIALLY_COPYABLE


1105 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gis_ŒivŸÎy_cİyabË
 = 
¡d
::
is_ŒivŸÎy_cİyabË
<
T
>;

1106 #–ià
HAVE___HAS_TRIVIAL_COPY


1107 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_ŒivŸÎy_cİyabË
 : 
public
 
š‹g¿l_cÚ¡ªt
<
boŞ
, 
__has_ŒivŸl_cİy
(
T
)> {};

1109 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_ŒivŸÎy_cİyabË
 : 
public
 
çl£_ty³
 {};

1110 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1111 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<sigÃd > : 
public
 
Œue_ty³
 {};

1112 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1113 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1114 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1115 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1116 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1117 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1118 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1119 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1120 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1121 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_ŒivŸÎy_cİyabË
<T *> : 
public
 
Œue_ty³
 {};

1133 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gu£_»ã»nû
 = (!
is_»ã»nû
<
T
>::
v®ue


1134 && (!
is_ŒivŸÎy_cİyabË
<
T
>::
v®ue


1135 || (
T
) > (*)))>

1136 
ç¡_¬gum’t
;

1138 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gç¡_¬gum’t
<T, 
	gŒue
> {

1139 
cÚ¡ex´
 
boŞ
 
	gis_»ã»nû
 = 
Œue
;

1140 cÚ¡ 
	tT
 &
	tty³
;

1141 #ià
HAVE_CXX_RVALUE_REFERENCES


1142 
	t’abË_rv®ue_»ã»nû
;

1145 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gç¡_¬gum’t
<T, 
	gçl£
> {

1146 
cÚ¡ex´
 
boŞ
 
	gis_»ã»nû
 = 
çl£
;

1147 
T
 
	tty³
;

1149 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
cÚ¡ex´
 
boŞ
 
	gç¡_¬gum’t
<T, 
	gŒue
>::
is_»ã»nû
;

1150 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
cÚ¡ex´
 
boŞ
 
	gç¡_¬gum’t
<T, 
	gçl£
>::
is_»ã»nû
;

1155 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1156 
	ghas_ç¡_št_muÉly
 : 
public
 
mass
::
çl£_ty³
 {

1160 #ià
defšed
(
__i386__
è|| defšed(
__x86_64__
)

1161 
šlše
 
	$št_muÉly
(
a
, 
b
, &
xlow
, &
xhigh
)

1163 
	`__asm__
("muÈ%2" : "÷" (
xlow
), "=d" (
xhigh
è: "r" (
a
), "a" (
b
) : "cc");

1164 
	}
}

1165 
	g‹m¶©e
 <> 
	ghas_ç¡_št_muÉly
<> : 
public
 
mass
::
Œue_ty³
 {};

1167 #ià
SIZEOF_LONG
 =ğ4 || (
defšed
(
__x86_64__
) && SIZEOF_LONG == 8)

1168 
šlše
 
	$št_muÉly
(
a
, 
b
, &
xlow
, &
xhigh
)

1170 
	`__asm__
("muÈ%2" : "÷" (
xlow
), "=d" (
xhigh
è: "r" (
a
), "a" (
b
) : "cc");

1171 
	}
}

1172 
	g‹m¶©e
 <> 
	ghas_ç¡_št_muÉly
<> : 
public
 
mass
::
Œue_ty³
 {};

1175 #ià
defšed
(
__x86_64__
è&& 
SIZEOF_LONG_LONG
 == 8

1176 
šlše
 
	$št_muÉly
(
a
, 
b
, &
xlow
, &
xhigh
)

1178 
	`__asm__
("muÈ%2" : "÷" (
xlow
), "=d" (
xhigh
è: "r" (
a
), "a" (
b
) : "cc");

1179 
	}
}

1180 
	g‹m¶©e
 <> 
	ghas_ç¡_št_muÉly
<> : 
public
 
mass
::
Œue_ty³
 {};

1184 
	sunš™Ÿlized_ty³
 {};

	@lib/randgen.hh

1 #´agm¨
Úû


3 
	sRªd
 {

4 
ušt32_t
 
	t»suÉ_ty³
;

5 
»suÉ_ty³
 
	mx
;

6 
Rªd
(
»suÉ_ty³
 
a
,„esult_type = 0)

7 : 
x
(
a
) {

9 
»suÉ_ty³
 
İ”©Ü
()() {

10 
x
 = 1103515245 * x + 12345;

11  
	mx
 & 0x7fffffff;

13 
cÚ¡ex´
 
»suÉ_ty³
 
mš
() {

16 
cÚ¡ex´
 
»suÉ_ty³
 
max
() {

	@lib/sampling.hh

1 #´agm¨
Úû


5 
	~<c¡dlib
>

6 
	~<ÿs£¹
>

7 
	~<c¡ršg
>

8 
	~<cm©h
>

9 
	~<veùÜ
>

10 
	~<¿ndom
>

11 
	~<®gÜ™hm
>

13 
Çme¥aû
 
	g§m¶šg
 {

15 
size_t
 
	tšdex_t
;

16 
	g¡d
::
	tveùÜ
<> 
	tweight_ty³
;

17 
	g¡d
::
	tveùÜ
<
	tšdex_t
> 
	tŒaû_ty³
;

22 şas 
	cP»fixSumT»e
 {

23 
	gpublic
:

24 
P»fixSumT»e
(
size_t
 
num_š‹rv®s
) {

25 
size_t
 
Å2
 = 1;

26 
	gÅ2
 < 
	gnum_š‹rv®s
)‚p2 <<= 1;

27 
	gËaves_idx
 = 
Å2
 - 1;

28 
	gsize
 = 
Å2
 * 2;

29 
	g¬¿y
 = 
Ãw
 
size_t
[
size
];

30 
bz”o
(
¬¿y
, 
size
*(
size_t
));

33 ~
P»fixSumT»e
() {

34 
	gd–‘e
[] 
	g¬¿y
;

38 
lßd
(cÚ¡ 
pmf_ty³
& 
pmf
) {

39 
size_t
 
	gi
 = 0; i < 
	gpmf
.
size
(); ++i)

40 
šüem’t_š‹rv®
((
šdex_t
)
i
, 
pmf
[i]);

44 
šdex_t
 
fšd_š‹rv®
(
size_t
 
´efix_sum
) const {

45 
as£¹
(
´efix_sum
 <ğ
¬¿y
[0]);

46 
šdex_t
 
	gp
 = 0;

47 
	gp
 < 
	gËaves_idx
) {

48 
šdex_t
 
	gËá
 = 
p
*2+1;

49 
šdex_t
 
	gright
 = 
p
*2+2;

50 
size_t
 
	g®
 = 
¬¿y
[
Ëá
];

51 ià(
	g®
 >ğ
´efix_sum
) {

52 
p
 = 
Ëá
;

54 
	g´efix_sum
 -ğ
®
;

55 
	gp
 = 
right
;

56 
as£¹
(
´efix_sum
 <ğ
¬¿y
[
right
]);

59  
	gp
 - 
	gËaves_idx
;

62 
size_t
 
adju¡ed_»sŞutiÚ
() const {

63  
	g¬¿y
[0];

66 
	g´iv©e
:

69 
šüem’t_š‹rv®
(
šdex_t
 
šdex
, 
size_t
 
amouÁ
) {

70 
	gšdex
 +ğ
Ëaves_idx
;

71 
	gŒue
) {

72 
	g¬¿y
[
šdex
] +ğ
amouÁ
;

73 ià(
	gšdex
 == 0)

75 
	gšdex
 = (
šdex
 - 1)/2;

79 
size_t
 *
	g¬¿y
;

80 
size_t
 
	gsize
;

81 
size_t
 
	gËaves_idx
;

85 
	g‹m¶©e
 <
ty³Çme
 
	gIÁTy³
>

86 şas 
	cStoUnifÜmIÁSam¶”
 {

87 
	gpublic
:

88 
¡d
::
	tmt19937
 
	tºg_ty³
;

90 
ex¶ic™
 
StoUnifÜmIÁSam¶”
(
ºg_ty³
& 
ºg
è: 
g’
Ông), 
dis
() {}

91 
StoUnifÜmIÁSam¶”
(
ºg_ty³
& 
ºg
, 
IÁTy³
 
¿nge
)

92 : 
g’
(
ºg
), 
dis
(0, 
¿nge
) {}

94 
IÁTy³
 
§m¶e
() {

95  
dis
(
g’
);

98 
IÁTy³
 
§m¶e
(
ºg_ty³
& 
ºg
) {

99  
dis
(
ºg
);

102 
£t_·¿ms
(
ty³Çme
 
¡d
::
unifÜm_št_di¡ributiÚ
<
IÁTy³
>::
·¿m_ty³
 
p
) {

103 
dis
.
·¿m
(
p
);

106 
	gºg_ty³
& 
g’”©Ü
() {

107  
	gg’
;

110 
	g´iv©e
:

111 
ºg_ty³
& 
g’
;

112 
	g¡d
::
unifÜm_št_di¡ributiÚ
<
IÁTy³
> 
dis
;

119 
	g‹m¶©e
 <
ty³Çme
 
	gIÁTy³
 = 
šdex_t
>

120 şas 
	cStoRªdomDi¡ributiÚ
 {

121 
public
:

122 
ty³Çme
 
	tStoUnifÜmIÁSam¶”
<
	tIÁTy³
>::
	tºg_ty³
„ng_type;

124 
StoRªdomDi¡ributiÚ
(
ºg_ty³
& 
ºg
, 
IÁTy³
 
a
, IÁTy³ 
b
)

125 : 
begš
(
a
), 
’d
(
b
), 
uis
(
ºg
), 
di¡
() {

126 
as£¹
(
a
 < 
b
);

129 
	gvœtu®
 ~
StoRªdomDi¡ributiÚ
() = ;

131 
IÁTy³
 
§m¶e
() const {

132 autØ
	gs_šdex
 = 
§m¶e_idx
();

133  
	gs_šdex
 + 
	gbegš
;

136 
IÁTy³
 
§m¶e
(
ºg_ty³
& 
ºg
) const {

137 autØ
	gs_šdex
 = 
§m¶e_idx
(
ºg
);

138  
	gs_šdex
 + 
	gbegš
;

141 
vœtu®
 
ušt64_t
 
§m¶e_idx
() const {

142  
di¡
(
uis
.
g’”©Ü
());

145 
vœtu®
 
ušt64_t
 
§m¶e_idx
(
ºg_ty³
& 
ºg
) const {

146  
di¡
(
ºg
);

149 
	gºg_ty³
& 
g’”©Ü
() const {

150  
	guis
.
g’”©Ü
();

153 
Œaû_ty³
 
§m¶e_Œaû
(
size_t
 
num_§m¶es
) const {

154 
Œaû_ty³
 
	gŒaû
;

155 
size_t
 
	gi
 = 0; i < 
	gnum_§m¶es
; ++i)

156 
	gŒaû
.
push_back
(
§m¶e
());

157  
	gŒaû
;

160 
	g´Ùeùed
:

161 
g’”©e
(
weight_ty³
&& 
pmf
) {

162 
¡d
::
disü‘e_di¡ributiÚ
<
IÁTy³
> 
d_
(
pmf
.
begš
(),…mf.
’d
());

163 
	gdi¡
.
·¿m
(
d_
.param());

166 
IÁTy³
 
	gbegš
;

167 
IÁTy³
 
	g’d
;

169 
mubË
 
	gStoUnifÜmIÁSam¶”
<
	gušt64_t
> 
	guis
;

171 
mubË
 
	g¡d
::
disü‘e_di¡ributiÚ
<
ušt64_t
> 
di¡
;

175 
	g‹m¶©e
 <
ty³Çme
 
	gIÁTy³
 = 
šdex_t
>

176 
şass
 
StoUnifÜmDi¡ributiÚ
 : 
public
 
StoRªdomDi¡ributiÚ
<
IÁTy³
> {

177 
public
:

178 
usšg
 
ty³Çme
 
StoRªdomDi¡ributiÚ
<
IÁTy³
>::
ºg_ty³
;

179 
StoUnifÜmDi¡ributiÚ
(
ºg_ty³
& 
ºg
, 
IÁTy³
 
a
, IÁTy³ 
b
) :

180 
StoRªdomDi¡ributiÚ
<
IÁTy³
>(
ºg
, 
	ga
, 
	gb
è{ 
	gthis
->
g’”©e
(
g’”©e_weights
()); }

182 
ušt64_t
 
§m¶e_idx
(ècÚ¡ 
	gov”ride
 {

183  
	gthis
->
	guis
.
§m¶e
();

186 
ušt64_t
 
§m¶e_idx
(
ºg_ty³
& 
ºg
ècÚ¡ 
	gov”ride
 {

187  
	gthis
->
	guis
.
§m¶e
(
ºg
);

190 
	g´iv©e
:

191 
weight_ty³
 
g’”©e_weights
() {

192 
¡d
::
unifÜm_št_di¡ributiÚ
<
IÁTy³
> 
d
(
this
->
begš
,his->
’d
);

193 
	gthis
->
	guis
.
£t_·¿ms
(
d
.
·¿m
());

194  
weight_ty³
();

199 
	g‹m¶©e
 <
ty³Çme
 
	gIÁTy³
 = 
šdex_t
>

200 
şass
 
StoZfDi¡ributiÚ
 : 
public
 
StoRªdomDi¡ributiÚ
<
IÁTy³
> {

201 
public
:

202 
cÚ¡ex´
 
deçuÉ_skew
 = 1.0;

203 
usšg
 
ty³Çme
 
	gStoRªdomDi¡ributiÚ
<
	gIÁTy³
>::
ºg_ty³
;

205 
StoZfDi¡ributiÚ
(
ºg_ty³
& 
ºg
, 
IÁTy³
 
a
, IÁTy³ 
b
, 
skew
 = 
deçuÉ_skew
) :

206 
StoRªdomDi¡ributiÚ
<
IÁTy³
>(
ºg
, 
	ga
, 
	gb
), 
skewÃss
(
skew
), 
sum_
() {

207 
ÿlcuÏ‹_sum
();

208 
	gthis
->
g’”©e
(
g’”©e_weights
());

211 
	g´iv©e
:

212 
weight_ty³
 
g’”©e_weights
() {

213 
weight_ty³
 
pmf
;

214 autØ
	gi
 = 
this
->
begš
; i <ğthis->
’d
; ++i) {

215 
	gp
 = 1.0/(
¡d
::
pow
(()(
i
 - 
this
->
begš
 + 1), 
skewÃss
)*
	gsum_
);

217 
	gpmf
.
push_back
(
p
);

219  
	gpmf
;

222 
ÿlcuÏ‹_sum
() {

223 
	gs
 = 0.0;

224 autØ
	gi
 = 
this
->
begš
; i <ğthis->
’d
; ++i)

225 
	gs
 +ğ
¡d
::
pow
(1.0/()(
i
- 
this
->
begš
 +1), 
skewÃss
);

226 
	gsum_
 = 
s
;

229 
	gskewÃss
;

230 
	gsum_
;

234 
	g‹m¶©e
 <
ty³Çme
 
	gTy³
>

235 
şass
 
	gStoCu¡omDi¡ributiÚ
 : 
public
 
StoRªdomDi¡ributiÚ
<
ušt64_t
> {

236 
public
:

237 
usšg
 
ty³Çme
 
StoRªdomDi¡ributiÚ
<
ušt64_t
>::
ºg_ty³
;

240 
Ty³
 
	gid’tif›r
;

241 
size_t
 
	gcouÁ
;

242 } 
	thi¡og¿m_±_ty³
;

245 
Ty³
 
	gid’tif›r
;

246 
	gweight
;

247 } 
	tweigh‹d_±_ty³
;

249 
	g¡d
::
	tveùÜ
<
	thi¡og¿m_±_ty³
> 
	thi¡og¿m_ty³
;

250 
	g¡d
::
	tveùÜ
<
	tweigh‹d_±_ty³
> 
	tweightg¿m_ty³
;

252 
StoCu¡omDi¡ributiÚ
(
ºg_ty³
& 
ºg
, cÚ¡ 
hi¡og¿m_ty³
& 
hi¡og¿m
) :

253 
StoRªdomDi¡ributiÚ
<
ušt64_t
>(
ºg
, 0, 
	ghi¡og¿m
.
size
() - 1),

254 
šdex_Œª¦©iÚ_bË
() {

255 
»£t_Œª¦©iÚ_bË
(
hi¡og¿m
);

256 
	gthis
->
g’”©e
(
g’”©e_weight
(
hi¡og¿m
));

259 
StoCu¡omDi¡ributiÚ
(
ºg_ty³
& 
ºg
, cÚ¡ 
weightg¿m_ty³
& 
weightg¿m
) :

260 
StoRªdomDi¡ributiÚ
<
ušt64_t
>(
ºg
, 0, 
	gweightg¿m
.
size
() - 1),

261 
šdex_Œª¦©iÚ_bË
() {

262 
»£t_Œª¦©iÚ_bË
(
weightg¿m
);

263 
	gthis
->
g’”©e
(
exŒaù_weight
(
weightg¿m
));

266 cÚ¡ 
	gTy³
& 
§m¶e
() const {

267  
	gšdex_Œª¦©iÚ_bË
[
this
->
§m¶e_idx
()];

269 cÚ¡ 
	gTy³
& 
§m¶e
(
ºg_ty³
& 
ºg
) const {

270  
	gšdex_Œª¦©iÚ_bË
[
this
->
§m¶e_idx
(
ºg
)];

273 
	g´iv©e
:

274 
‹m¶©e
 <
ty³Çme
 
PoštTy³
>

275 
»£t_Œª¦©iÚ_bË
(cÚ¡ 
¡d
::
veùÜ
<
PoštTy³
>& 
id_li¡
) {

276 
šdex_Œª¦©iÚ_bË
.
»£rve
(
id_li¡
.
size
());

277 auto& 
	gpošt
 : 
id_li¡
)

278 
šdex_Œª¦©iÚ_bË
.
push_back
(
pošt
.
id’tif›r
);

281 
weight_ty³
 
g’”©e_weight
(cÚ¡ 
hi¡og¿m_ty³
& 
hi¡og¿m
) {

282 
weight_ty³
 
	gpmf
;

283 auto& 
	g·œ
 : 
hi¡og¿m
)

284 
pmf
.
push_back
(()
·œ
.
couÁ
);

285  
	gpmf
;

288 
weight_ty³
 
exŒaù_weight
(cÚ¡ 
weightg¿m_ty³
& 
weightg¿m
) {

289 
weight_ty³
 
	gpmf
;

290 auto& 
	gpošt
 : 
weightg¿m
)

291 
pmf
.
push_back
(
pošt
.
weight
);

292  
	gpmf
;

295 
	g¡d
::
veùÜ
<
Ty³
> 
šdex_Œª¦©iÚ_bË
;

	@lib/simple_str.hh

1 #´agm¨
Úû


3 şas 
	csim¶e_¡r
 {

4 
	mpublic
:

5 
	$·d
(
v
)

7 ià(
	`lik–y
(
v
 <= 512)) {

8  (
v
 + 15) & ~15;

10 
v
--;

11 
v
 |= v >> 1;

12 
v
 |= v >> 2;

13 
v
 |= v >> 4;

14 
v
 |= v >> 8;

15 
v
 |= v >> 16;

16 #ià
UINT_MAX
 =ğ
UINT64_MAX


17 
v
 |= v >> 32;

19 
v
++;

20  
v
;

23 
šlše
 
	$size_fÜ
(
Ën
) {

24 
»s
 = 
	`·d
(
Ën
 + (
sim¶e_¡r
));

25  
»s
;

27 
	}
}

29 
boŞ
 
	$Ãeds_»size
(
Ën
) {

30  
Ën
 > ()
ÿ·c™y_
;

31 
	}
}

33 cÚ¡ *
	$d©a
() {

34  
buf_
;

35 
	}
}

37 
	$Ëngth
() {

38  
size_
;

39 
	}
}

41 
	$ÿ·c™y
() {

42  
ÿ·c™y_
;

43 
	}
}

45 
šlše
 
	gsim¶e_¡r
& 
	gİ”©Ü
ğ(cÚ¡ 
¡d
::
¡ršg
& 
v
) {

46 
Ën
 = 
v
.
Ëngth
();

47 
	gsize_
 = 
Ën
;

48 ià(
uÆik–y
(
Ãeds_»size
(
Ën
))) {

49 
	gÿ·c™y_
 = 
size_fÜ
(
Ën
è- (
sim¶e_¡r
);

50 
	gbuf_
 = (*è
m®loc
(
ÿ·c™y_
);

52 
memıy
(
buf_
, 
v
.
d©a
(), 
Ën
);

53  *
	gthis
;

56 
İ”©Ü
 
	g¡d
::
	$¡ršg
() {

57  
¡d
::
	`¡ršg
(
this
->
	`d©a
(),his->
	`Ëngth
());

58 
	}
}

60 
	$sim¶e_¡r
(cÚ¡ 
¡d
::
¡ršg
& 
v
) {

61 
Ën
 = 
v
.
	`Ëngth
();

62 
size_
 = 
Ën
;

63 
ÿ·c™y_
 = 
	`size_fÜ
(
Ën
è- (
sim¶e_¡r
);

64 
buf_
 = (*è
	`m®loc
(
ÿ·c™y_
);

65 
	`memıy
(
buf_
, 
v
.
	`d©a
(), 
Ën
);

66 
	}
}

67 
	g´iv©e
:

68 
ušt32_t
 
size_
;

69 
ušt32_t
 
	gÿ·c™y_
;

70 *
	gbuf_
;

	@lib/stuffed_str.hh

1 #´agm¨
Úû


2 
	~"¡ršg_ba£.hh
"

4 
	g‹m¶©e
 <
ty³Çme
 
	gStuff
>

5 şas 
	c¡ufãd_¡r
 {

6 
	mpublic
:

7 
Stuff
 
	t¡uff_ty³
;

9 
	sSnd¬dM®loc
 {

10 *
İ”©Ü
()(
size_t
 
	ms
) {

11  
m®loc
(
s
);

15 
	g‹m¶©e
 <
ty³Çme
 
	gM®loc
 = 
Snd¬dM®loc
>

16 
¡ufãd_¡r
* 
make
(cÚ¡ *
¡r
, 
Ën
, 
ÿ·c™y
, cÚ¡ 
Stuff
& 
v®
, 
M®loc
 
m
 = 
	$M®loc
()) {

18 
	`as£¹
(
	`size_fÜ
(
Ën
è<ğ
ÿ·c™y
);

20 autØ
vs
 = (
¡ufãd_¡r
*)
	`m
(
ÿ·c™y
);

21 
	`Ãw
 (
vs
è
	`¡ufãd_¡r
(
v®
, 
Ën
, 
ÿ·c™y
 - (
¡ufãd_¡r
), 
¡r
);

22  
vs
;

23 
	}
}

25 
	g‹m¶©e
 <
ty³Çme
 
	gM®loc
 = 
Snd¬dM®loc
>

26 
¡ufãd_¡r
* 
make
(cÚ¡ 
¡d
::
¡ršg
& 
s
, cÚ¡ 
Stuff
& 
v®
, 
M®loc
 
m
 = 
	$M®loc
()) {

27  
	`make
(
s
.
	`d©a
(), s.
	`Ëngth
(), 
	`size_fÜ
(s.Ëngth()), 
v®
, 
m
);

28 
	}
}

30 
	g‹m¶©e
 <
ty³Çme
 
	gSŒ
,y³Çm
	gM®loc
 = 
Snd¬dM®loc
>

31 
¡ufãd_¡r
* 
make
(cÚ¡ 
lcdf
::
SŒšg_ba£
<
SŒ
>& 
s
, cÚ¡ 
Stuff
& 
v®
, 
M®loc
 
m
 = 
	$M®loc
()) {

32  
	`make
(
s
.
	`d©a
(), s.
	`Ëngth
(), 
	`size_fÜ
(s.Ëngth()), 
v®
, 
m
);

33 
	}
}

35 
	$·d
(
v
)

37 ià(
	`lik–y
(
v
 <= 512)) {

38  (
v
 + 15) & ~15;

40 
v
--;

41 
v
 |= v >> 1;

42 
v
 |= v >> 2;

43 
v
 |= v >> 4;

44 
v
 |= v >> 8;

45 
v
 |= v >> 16;

46 #ià
UINT_MAX
 =ğ
UINT64_MAX


47 
v
 |= v >> 32;

49 
v
++;

50  
v
;

51 
	}
}

53 
šlše
 
	$size_fÜ
(
Ën
) {

54  
	`·d
(
Ën
 + (
¡ufãd_¡r
));

55 
	}
}

57 
boŞ
 
	$Ãeds_»size
(
Ën
) {

58  
Ën
 > ()
ÿ·c™y_
;

59 
	}
}

61 
	g‹m¶©e
 <
ty³Çme
 
	gM®loc
 = 
Snd¬dM®loc
>

62 
¡ufãd_¡r
* 
»£rve
(
Ën
, 
M®loc
 
m
 = 
	$M®loc
()) {

63 ià(
	`lik–y
(!
	`Ãeds_»size
(
Ën
))) {

64  
this
;

66  
¡ufãd_¡r
::
	`make
(
buf_
, 
size_
, 
Ën
, 
¡uff_
, 
m
);

67 
	}
}

71 
	g‹m¶©e
 <
ty³Çme
 
	gM®loc
 = 
Snd¬dM®loc
>

72 
¡ufãd_¡r
* 
»¶aû
(cÚ¡ *
¡r
, 
Ën
, 
M®loc
 
m
 = 
	$M®loc
()) {

73 ià(
	`lik–y
(!
	`Ãeds_»size
(
Ën
))) {

74 
size_
 = 
Ën
;

75 
	`memıy
(
buf_
, 
¡r
, 
Ën
);

76  
this
;

78  
¡ufãd_¡r
::
	`make
(
¡r
, 
Ën
, 
	`size_fÜ
Ö’), 
¡uff_
, 
m
);

79 
	}
}

81 cÚ¡ *
	$d©a
() {

82  
buf_
;

83 
	}
}

85 
	$Ëngth
() {

86  
size_
;

87 
	}
}

89 
	$ÿ·c™y
() {

90  
ÿ·c™y_
;

91 
	}
}

93 
	gStuff
& 
	$¡uff
() {

94  
¡uff_
;

95 
	}
}

97 
Stuff
 
	$¡uff
() const {

98  
¡uff_
;

99 
	}
}

101 
	g´iv©e
:

102 
	$¡ufãd_¡r
(cÚ¡ 
Stuff
& 
¡uff
, 
ušt32_t
 
size
, ušt32_ˆ
ÿ·c™y
, cÚ¡ *
buf
) :

103 
	`¡uff_
(
¡uff
), 
	`size_
(
size
), 
	$ÿ·c™y_
(
ÿ·c™y
) {

104 
	`memıy
(
buf_
, 
buf
, 
size
);

105 
	}
}

107 
Stuff
 
	g¡uff_
;

108 
ušt32_t
 
	gsize_
;

109 
ušt32_t
 
	gÿ·c™y_
;

110 
	gbuf_
[0];

	@masstree-beta/btree_leaflink.hh

16 #iâdeà
BTREE_LEAFLINK_HH


17 
	#BTREE_LEAFLINK_HH
 1

	)

18 
	~"comp”.hh
"

25 
	g‹m¶©e
 <
ty³Çme
 
	gN
, 
boŞ
 
	gCONCURRENT
 = 
N
::
cÚcu¼’t
> 
	sbŒ“_Ëaæšk
 {};

30 
	g‹m¶©e
 <
ty³Çme
 
	gN
> 
	gbŒ“_Ëaæšk
<N, 
	gŒue
> {

31 
	g´iv©e
:

32 
šlše
 
N
 *
m¬k
(N *
n
) {

33  
»š‹½»t_ÿ¡
<
N
 *>Ôeš‹½»t_ÿ¡<
ušŒ_t
>(
n
) + 1);

35 
šlše
 
boŞ
 
is_m¬ked
(
N
 *
n
) {

36  
	g»š‹½»t_ÿ¡
<
	gušŒ_t
>(
	gn
) & 1;

38 
	g‹m¶©e
 <
ty³Çme
 
	gSF
>

39 
šlše
 
N
 *
lock_Ãxt
(N *
n
, 
SF
 
¥š_funùiÚ
) {

41 
N
 *
	gÃxt
 = 
n
->
Ãxt_
.
±r
;

42 ià(!
	gÃxt


43 || (!
is_m¬ked
(
Ãxt
)

44 && 
boŞ_cmpxchg
(&
n
->
Ãxt_
.
±r
, 
Ãxt
, 
m¬k
(next))))

45  
	gÃxt
;

46 
¥š_funùiÚ
();

50 
	gpublic
:

56 
lšk_¥l™
(
N
 *
n
, N *
Ä
) {

57 
lšk_¥l™
(
n
, 
Ä
, 
»Ïx_ãnû_funùiÚ
());

60 
	g‹m¶©e
 <
ty³Çme
 
	gSF
>

61 
lšk_¥l™
(
N
 *
n
, N *
Ä
, 
SF
 
¥š_funùiÚ
) {

62 
	gÄ
->
	g´ev_
 = 
n
;

63 
N
 *
	gÃxt
 = 
lock_Ãxt
(
n
, 
¥š_funùiÚ
);

64 
	gÄ
->
	gÃxt_
.
	g±r
 = 
Ãxt
;

65 ià(
	gÃxt
)

66 
	gÃxt
->
	g´ev_
 = 
Ä
;

67 
ãnû
();

68 
	gn
->
	gÃxt_
.
	g±r
 = 
Ä
;

76 
uÆšk
(
N
 *
n
) {

77 
uÆšk
(
n
, 
»Ïx_ãnû_funùiÚ
());

80 
	g‹m¶©e
 <
ty³Çme
 
	gSF
>

81 
uÆšk
(
N
 *
n
, 
SF
 
¥š_funùiÚ
) {

84 
N
 *
	gÃxt
 = 
lock_Ãxt
(
n
, 
¥š_funùiÚ
);

85 
N
 *
	g´ev
;

87 
	g´ev
 = 
n
->
´ev_
;

88 ià(
boŞ_cmpxchg
(&
´ev
->
Ãxt_
.
±r
, 
n
, 
m¬k
(n)))

90 
¥š_funùiÚ
();

92 ià(
	gÃxt
)

93 
	gÃxt
->
	g´ev_
 = 
´ev
;

94 
ãnû
();

95 
	g´ev
->
	gÃxt_
.
	g±r
 = 
Ãxt
;

101 
	g‹m¶©e
 <
ty³Çme
 
	gN
> 
	gbŒ“_Ëaæšk
<N, 
	gçl£
> {

102 
lšk_¥l™
(
N
 *
n
, N *
Ä
) {

103 
lšk_¥l™
(
n
, 
Ä
, 
do_nÙhšg
());

105 
	g‹m¶©e
 <
ty³Çme
 
	gSF
>

106 
lšk_¥l™
(
N
 *
n
, N *
Ä
, 
SF
) {

107 
	gÄ
->
	g´ev_
 = 
n
;

108 
	gÄ
->
	gÃxt_
.
	g±r
 = 
n
->
Ãxt_
.
±r
;

109 
	gn
->
	gÃxt_
.
	g±r
 = 
Ä
;

110 ià(
	gÄ
->
	gÃxt_
.
	g±r
)

111 
	gÄ
->
	gÃxt_
.
	g±r
->
	g´ev_
 = 
Ä
;

113 
uÆšk
(
N
 *
n
) {

114 
uÆšk
(
n
, 
do_nÙhšg
());

116 
	g‹m¶©e
 <
ty³Çme
 
	gSF
>

117 
uÆšk
(
N
 *
n
, 
SF
) {

118 ià(
	gn
->
	gÃxt_
.
	g±r
)

119 
	gn
->
	gÃxt_
.
	g±r
->
	g´ev_
 = 
n
->
´ev_
;

120 
	gn
->
	g´ev_
->
	gÃxt_
.
	g±r
 = 
n
->
Ãxt_
.
±r
;

	@masstree-beta/checkpoint.cc

16 
	~"checkpošt.hh
"

20 
boŞ
 
	gck¡©e
::
	$vis™_v®ue
(
SŒ
 
key
, cÚ¡ 
row_ty³
* 
v®ue
, 
th»adšfo
&) {

21 ià(
’dkey
 && 
key
 >=ƒndkey)

22  
çl£
;

23 ià(!
	`row_is_m¬k”
(
v®ue
)) {

24 
msg·ck
::
uÅ¬£r
<
kvout
> 
	`up
(*
v®s
);

25 
up
.
	`wr™e
(
key
).
	`wr™e_wide
(
v®ue
->
	`time¡amp
());

26 
v®ue
->
	`checkpošt_wr™e
(
up
);

27 ++
couÁ
;

29  
Œue
;

30 
	}
}

	@masstree-beta/checkpoint.hh

16 #iâdeà
MASSTREE_CHECKPOINT_HH


17 
	#MASSTREE_CHECKPOINT_HH


	)

18 
	~"kvrow.hh
"

19 
	~"kvio.hh
"

20 
	~"msg·ck.hh
"

22 
	sck¡©e
 {

23 
kvout
 *
	mv®s
;

24 
ušt64_t
 
	mcouÁ
;

25 
ušt64_t
 
	mby‹s
;

26 
±h»ad_cÚd_t
 
	m¡©e_cÚd
;

27 vŞ©
	m¡©e
;

28 
th»adšfo
 *
	mti
;

29 
SŒ
 
	m¡¬tkey
;

30 
SŒ
 
	m’dkey
;

32 
	m‹m¶©e
 <
ty³Çme
 
	mSS
,y³Çm
	mK
>

33 
vis™_Ëaf
(cÚ¡ 
SS
&, cÚ¡ 
K
&, 
th»adšfo
&) {

35 
boŞ
 
vis™_v®ue
(
SŒ
 
key
, cÚ¡ 
row_ty³
* 
v®ue
, 
th»adšfo
& 
ti
);

37 
	m‹m¶©e
 <
ty³Çme
 
	mT
>

38 
š£¹
(
T
& 
bË
, 
msg·ck
::
·r£r
& 
·r
, 
th»adšfo
& 
ti
);

41 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

42 
	gck¡©e
::
	$š£¹
(
T
& 
bË
, 
msg·ck
::
·r£r
& 
·r
, 
th»adšfo
& 
ti
) {

43 
SŒ
 
key
;

44 
kvtime¡amp_t
 
ts
{};

45 
·r
 >> 
key
 >> 
ts
;

46 
row_ty³
* 
row
 =„ow_ty³::
	`checkpošt_»ad
(
·r
, 
ts
, 
ti
);

48 
ty³Çme
 
T
::
cursÜ_ty³
 
	`Í
(
bË
, 
key
);

49 
boŞ
 
found
 = 
Í
.
	`fšd_š£¹
(
ti
);

50 
	`mas¡»e_šv¬ŸÁ
(!
found
); () found;

51 
ti
.
	`ob£rve_phªtoms
(
Í
.
	`node
());

52 
Í
.
	`v®ue
(èğ
row
;

53 
Í
.
	`fšish
(1, 
ti
);

54 
	}
}

	@masstree-beta/circular_int.hh

16 #iâdeà
KVDB_CIRCULAR_INT_HH


17 
	#KVDB_CIRCULAR_INT_HH
 1

	)

18 
	~"comp”.hh
"

20 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

21 şas 
	ccœcuÏr_št
 {

22 
	mpublic
:

23 
ty³Çme
 
	tmass
::
	tmake_unsigÃd
<
	tT
>::
	tty³
 
	tv®ue_ty³
;

24 
ty³Çme
 
	tmass
::
	tmake_sigÃd
<
	tT
>::
	tty³
 
	tdifã»nû_ty³
;

26 
	$cœcuÏr_št
()

27 : 
	$v_
() {

29 
	$cœcuÏr_št
(
T
 
x
)

30 : 
	$v_
(
x
) {

31 
	}
}

33 
v®ue_ty³
 
	$v®ue
() const {

34  
v_
;

35 
	}
}

37 
	gcœcuÏr_št
<
	gT
> &
	gİ”©Ü
++() {

38 ++
	gv_
;

39  *
	gthis
;

41 
	gcœcuÏr_št
<
	gT
> 
	gİ”©Ü
++() {

42 ++
	gv_
;

43  
	gcœcuÏr_št
<
	gT
>(
	gv_
 - 1);

45 
	gcœcuÏr_št
<
	gT
> &
	gİ”©Ü
--() {

46 --
	gv_
;

47  *
	gthis
;

49 
	gcœcuÏr_št
<
	gT
> 
	gİ”©Ü
--() {

50 --
	gv_
;

51  
	gcœcuÏr_št
<
	gT
>(
	gv_
 + 1);

53 
	gcœcuÏr_št
<
	gT
> &
	gİ”©Ü
+=(
x
) {

54 
v_
 +ğ
x
;

55  *
	gthis
;

57 
	gcœcuÏr_št
<
	gT
> &
	gİ”©Ü
+=(
x
) {

58 
v_
 +ğ
x
;

59  *
	gthis
;

61 
	gcœcuÏr_št
<
	gT
> &
	gİ”©Ü
-=(
x
) {

62 
v_
 -ğ
x
;

63  *
	gthis
;

65 
	gcœcuÏr_št
<
	gT
> &
	gİ”©Ü
-=(
x
) {

66 
v_
 -ğ
x
;

67  *
	gthis
;

70 
	gcœcuÏr_št
<
	gT
> 
cmpxchg
(
cœcuÏr_št
<
T
> 
ex³ùed
, cœcuÏr_št<T> 
desœed
) {

71  ::
cmpxchg
(&
v_
, 
ex³ùed
.v_, 
desœed
.v_);

73 
	gcœcuÏr_št
<
	gT
> 
	$cmpxchg
(
T
 
ex³ùed
, T 
desœed
) {

74  ::
	`cmpxchg
(&
v_
, 
ex³ùed
, 
desœed
);

75 
	}
}

77 
v®ue_ty³
 (
	tcœcuÏr_št
<
	tT
>::*
	tun¥ecif›d_boŞ_ty³
)() const;

78 
İ”©Ü
 
	$un¥ecif›d_boŞ_ty³
() const {

79  
v_
 !ğ0 ? &
cœcuÏr_št
<
T
>::
v®ue
 : 0;

80 
	}
}

81 
boŞ
 
	gİ”©Ü
!() const {

82  
	gv_
 == 0;

85 
	gcœcuÏr_št
<
	gT
> 
	gİ”©Ü
+(
	gx
) const {

86  
	gcœcuÏr_št
<
	gT
>(
	gv_
 + 
	gx
);

88 
	gcœcuÏr_št
<
	gT
> 
	gİ”©Ü
+(
	gx
) const {

89  
	gcœcuÏr_št
<
	gT
>(
	gv_
 + 
	gx
);

91 
	gcœcuÏr_št
<
	gT
> 
	$Ãxt_nÚz”o
() const {

92 
v®ue_ty³
 
v
 = 
v_
 + 1;

93  
cœcuÏr_št
<
T
>(
v
 + !v);

94 
	}
}

95 
v®ue_ty³
 
	$Ãxt_nÚz”o
(
v®ue_ty³
 
x
) {

96 ++
x
;

97  
x
 + !x;

98 
	}
}

99 
	gcœcuÏr_št
<
	gT
> 
	gİ”©Ü
-(
	gx
) const {

100  
	gcœcuÏr_št
<
	gT
>(
	gv_
 - 
	gx
);

102 
	gcœcuÏr_št
<
	gT
> 
	gİ”©Ü
-(
	gx
) const {

103  
	gcœcuÏr_št
<
	gT
>(
	gv_
 - 
	gx
);

105 
difã»nû_ty³
 
	gİ”©Ü
-(
	gcœcuÏr_št
<
	gT
> 
	gx
) const {

106  
	gv_
 - 
	gx
.v_;

109 
boŞ
 
	gİ”©Ü
==(
cœcuÏr_št
<
T
> 
x
) const {

110  
v_
 =ğ
x
.v_;

112 
boŞ
 
	gİ”©Ü
!=(
cœcuÏr_št
<
T
> 
x
) const {

113  !(*
this
 =ğ
x
);

115 
boŞ
 
	$Ëss
(
v®ue_ty³
 
a
, v®ue_ty³ 
b
) {

116  
	`difã»nû_ty³
(
a
 - 
b
) < 0;

117 
	}
}

118 
boŞ
 
	$Ëss_equ®
(
v®ue_ty³
 
a
, v®ue_ty³ 
b
) {

119  
	`difã»nû_ty³
(
a
 - 
b
) <= 0;

120 
	}
}

121 
boŞ
 
	gİ”©Ü
<(
	gcœcuÏr_št
<
	gT
> 
	gx
) const {

122  
Ëss
(
v_
, 
x
.v_);

124 
boŞ
 
	gİ”©Ü
<=(
cœcuÏr_št
<
T
> 
x
) const {

125  !
Ëss
(
x
.
v_
, v_);

127 
boŞ
 
	gİ”©Ü
>=(
cœcuÏr_št
<
T
> 
x
) const {

128  !
Ëss
(
v_
, 
x
.v_);

130 
boŞ
 
	gİ”©Ü
>(
	gcœcuÏr_št
<
	gT
> 
	gx
) const {

131  
Ëss
(
x
.
v_
, v_);

134 
	g´iv©e
:

135 
v®ue_ty³
 
v_
;

138 
	gcœcuÏr_št
<
	tušt64_t
> 
	tkv•och_t
;

140 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

141 
šlše
 
	gcœcuÏr_št
<
	gT
> 
cmpxchg
(
cœcuÏr_št
<
T
> *
objeù
, cœcuÏr_št<T> 
ex³ùed
,

142 
cœcuÏr_št
<
T
> 
desœed
) {

143  
	gobjeù
->
cmpxchg
(
ex³ùed
, 
desœed
);

	@masstree-beta/clp.c

36 #ià
HAVE_CONFIG_H


37 
	~<cÚfig.h
>

39 
	~"şp.h
"

40 
	~<¡dlib.h
>

41 
	~<¡ršg.h
>

42 
	~<¡dio.h
>

43 
	~<as£¹.h
>

44 
	~<¡d¬g.h
>

45 
	~<ùy³.h
>

46 #ià
HAVE_SYS_TYPES_H


47 
	~<sys/ty³s.h
>

51 #ià!
defšed
(
HAVE_STRTOUL
è&& !defšed(
HAVE_CONFIG_H
)

52 
	#HAVE_STRTOUL
 1

	)

54 #ià
defšed
(
HAVE_INTTYPES_H
è|| !defšed(
HAVE_CONFIG_H
)

55 
	~<š‰y³s.h
>

57 #ià!
defšed
(
HAVE_UINTPTR_T
è&& defšed(
HAVE_CONFIG_H
)

58 
	tušŒ_t
;

61 #ifdeà
__ılu¥lus


159 
	#CÍ_DoubËdLÚg
 (
CÍ_LÚgIm¶ic™
 * 2)

	)

161 
	#CÍ_In™ŸlV®Ty³
 8

	)

162 
	#MAX_AMBIGUOUS_VALUES
 4

	)

165 
v®_ty³
;

166 
CÍ_V®P¬£Func
 
func
;

167 
æags
;

168 *
u£r_d©a
;

169 } 
	tCÍ_V®Ty³
;

172 
Úg
 : 1;

173 
ishÜt
 : 1;

174 
imªd©Üy
 : 1;

175 
iİtiÚ®
 : 1;

176 
os
 : 1;

177 
šeg
 : 1;

178 
»fm©ch
 : 1;

179 
lmmpos_shÜt
 : 1;

180 
lmmÃg_shÜt
 : 1;

181 
Úgoff
;

182 
lmmpos
;

183 
lmmÃg
;

184 } 
	tCÍ_IÁ”nO±iÚ
;

187 
	#CÍ_O±iÚCh¬sSize
 5

	)

190 
c
;

191 
ty³
;

192 } 
	tCÍ_Oşass
;

193 
	#CÍ_OşassSize
 10

	)

195 
	sCÍ_IÁ”Çl
 {

196 cÚ¡ 
CÍ_O±iÚ
 *
İt
;

197 
CÍ_IÁ”nO±iÚ
 *
iİt
;

198 
nİt
;

199 
İt_g’”©iÚ
;

201 
CÍ_V®Ty³
 *
v®ty³
;

202 
nv®ty³
;

204 cÚ¡ * cÚ¡ *
¬gv
;

205 
¬gc
;

207 
CÍ_Oşass
 
oşass
[
CÍ_OşassSize
];

208 
noşass
;

209 
lÚg1pos
;

210 
lÚg1Ãg
;

211 
utf8
;

213 
İtiÚ_ch¬s
[
CÍ_O±iÚCh¬sSize
];

214 cÚ¡ *
x‹xt
;

216 cÚ¡ *
´og¿m_Çme
;

217 (*
”rÜ_hªdËr
)(
CÍ_P¬£r
 *, const *);

219 
İtiÚ_´oûssšg
;

220 
cu¼’t_İtiÚ
;

222 
is_shÜt
;

223 
whŞe_Ãg©ed
;

224 
could_be_shÜt
;

225 
cu¼’t_shÜt
;

226 
Ãg©ed_by_no
;

228 
ambiguous
;

229 
ambiguous_v®ues
[
MAX_AMBIGUOUS_VALUES
];

230 } 
	tCÍ_IÁ”Çl
;

233 
	sCÍ_P¬£rS‹
 {

234 cÚ¡ * cÚ¡ *
¬gv
;

235 
¬gc
;

237 
İtiÚ_ch¬s
[
CÍ_O±iÚCh¬sSize
];

238 cÚ¡ *
x‹xt
;

240 
İtiÚ_´oûssšg
;

242 
İt_g’”©iÚ
;

243 
cu¼’t_İtiÚ
;

244 
is_shÜt
;

245 
whŞe_Ãg©ed
;

246 
cu¼’t_shÜt
;

247 
Ãg©ed_by_no
;

251 
	sCÍ_SŒšgLi¡
 {

252 
CÍ_O±iÚ
 *
™ems
;

253 
CÍ_IÁ”nO±iÚ
 *
iİt
;

254 
n™ems
;

256 
®low_št
;

257 
v®_lÚg
;

258 
n™ems_šv®id_»pÜt
;

259 } 
	tCÍ_SŒšgLi¡
;

262 cÚ¡ 
CÍ_O±iÚ
 
şp_İtiÚ_£Áš–
[] = {

263 {"", 0, 
CÍ_NÙO±iÚ
, 0, 0},

264 {"", 0, 
CÍ_DÚe
, 0, 0},

265 {"", 0, 
CÍ_BadO±iÚ
, 0, 0},

266 {"", 0, 
CÍ_E¼Ü
, 0, 0}

270 
·r£_¡ršg
(
CÍ_P¬£r
 *, const *, , *);

271 
·r£_št
(
CÍ_P¬£r
 *, const *, , *);

272 
·r£_boŞ
(
CÍ_P¬£r
 *, const *, , *);

273 
·r£_doubË
(
CÍ_P¬£r
 *, const *, , *);

274 
·r£_¡ršg_li¡
(
CÍ_P¬£r
 *, const *, , *);

276 
ambigu™y_”rÜ
(
CÍ_P¬£r
 *, , *, cÚ¡ 
CÍ_O±iÚ
 *,

277 cÚ¡ 
CÍ_IÁ”nO±iÚ
 *, const *, const *,

285 
	#U_REPLACEMENT
 0xFFFD

	)

288 
’code_utf8
(*
s
, 
n
, 
c
)

290 ià(
c
 < 0 || c >= 0x110000 || (c >= 0xD800 && c <= 0xDFFF))

291 
c
 = 
U_REPLACEMENT
;

292 ià(
c
 <ğ0x7F && 
n
 >= 1)

293 *
s
++ = 
c
;

294 ià(
c
 <ğ0x7FF && 
n
 >= 2) {

295 *
s
++ = 0xC0 | (
c
 >> 6);

296 
ch¬1
;

297 } ià(
c
 <ğ0xFFFF && 
n
 >= 3) {

298 *
s
++ = 0xE0 | (
c
 >> 12);

299 
ch¬2
;

300 } ià(
n
 >= 4) {

301 *
s
++ = 0xF0 | (
c
 >> 18);

302 *
s
++ = 0x80 | ((
c
 >> 12) & 0x3F);

303 
ch¬2
:

304 *
s
++ = 0x80 | ((
c
 >> 6) & 0x3F);

305 
ch¬1
:

306 *
s
++ = 0x80 | (
c
 & 0x3F);

308  
s
;

312 
decode_utf8
(cÚ¡ *
s
, cÚ¡ **
ı
)

314 
c
;

315 ià((è*
s
 <= 0x7F)

316 
c
 = *
s
++;

317 ià((è*
s
 <= 0xC1)

318 
»¶aûm’t
;

319 ià((è*
s
 <= 0xDF) {

320 ià((
s
[1] & 0xC0) != 0x80)

321 
»¶aûm’t
;

322 
c
 = (*
s
++ & 0x1F) << 6;

323 
ch¬1
;

324 } ià((è*
s
 <= 0xEF) {

325 ià((
s
[1] & 0xC0) != 0x80

326 || (
s
[2] & 0xC0) != 0x80

327 || ((è*
s
 == 0xE0

328 && (
s
[1] & 0xE0) == 0x80)

329 || ((è*
s
 == 0xED

330 && (
s
[1] & 0xE0) == 0xA0))

331 
»¶aûm’t
;

332 
c
 = (*
s
++ & 0x0F) << 12;

333 
ch¬2
;

334 } ià((è*
s
 <= 0xF4) {

335 ià((
s
[1] & 0xC0) != 0x80

336 || (
s
[2] & 0xC0) != 0x80

337 || (
s
[3] & 0xC0) != 0x80

338 || ((è*
s
 == 0xF0

339 && (
s
[1] & 0xF0) == 0x80)

340 || ((è*
s
 == 0xF4

341 && (è
s
[1] >= 0x90))

342 
»¶aûm’t
;

343 
c
 = (*
s
++ & 0x07) << 18;

344 
c
 +ğ(*
s
++ & 0x3F) << 12;

345 
ch¬2
:

346 
c
 +ğ(*
s
++ & 0x3F) << 6;

347 
ch¬1
:

348 
c
 +ğ(*
s
++ & 0x3F);

350 
»¶aûm’t
:

351 
c
 = 
U_REPLACEMENT
;

352 
s
++; (*s & 0xC0) == 0x80; s++)

355 ià(
ı
)

356 *
ı
 = 
s
;

357  
c
;

361 
utf8_ch¬Ën
(cÚ¡ *
s
)

363 cÚ¡ *
sout
;

364 (è
decode_utf8
(
s
, &
sout
);

365  
sout
 - 
s
;

369 
şp_utf8_ch¬Ën
(cÚ¡ 
CÍ_IÁ”Çl
 *
şi
, cÚ¡ *
s
)

371  (
şi
->
utf8
 ? 
utf8_ch¬Ën
(
s
) : 1);

380 
mš_difã»Á_ch¬s
(cÚ¡ *
s
, cÚ¡ *
t
)

385 cÚ¡ *
sfœ¡
 = 
s
;

386 *
s
 && *
t
 && *s == *t)

387 
s
++, 
t
++;

388 ià(!*
s
)

389  
s
 - 
sfœ¡
;

391  
s
 - 
sfœ¡
 + 1;

395 
lÚg_as_shÜt
(cÚ¡ 
CÍ_IÁ”Çl
 *
şi
, cÚ¡ 
CÍ_O±iÚ
 *
o
,

396 
CÍ_IÁ”nO±iÚ
 *
io
, 
çu»
)

398 ià((
şi
->
lÚg1pos
 || cli->
lÚg1Ãg
è&& 
io
->
Úg
) {

399 cÚ¡ *
Çme
 = 
o
->
lÚg_Çme
 + 
io
->
Úgoff
;

400 ià(
şi
->
utf8
) {

401 
c
 = 
decode_utf8
(
Çme
, &name);

402 ià(!*
Çme
 && 
c
 && c !ğ
U_REPLACEMENT
)

403  
c
;

404 } ià(
Çme
[0] && !name[1])

405  (è
Çme
[0];

407  
çu»
;

411 
com·»_İtiÚs
(
CÍ_P¬£r
 *
şp
, cÚ¡ 
CÍ_O±iÚ
 *
o1
, 
CÍ_IÁ”nO±iÚ
 *
io1
,

412 cÚ¡ 
CÍ_O±iÚ
 *
o2
, 
CÍ_IÁ”nO±iÚ
 *
io2
)

414 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

415 
shÜt1
, 
shÜtx1
;

418 ià((!
io1
->
ishÜt
 && !io1->
Úg
è|| (!
io2
->ishort && !io2->ilong)

419 || !((
io1
->
os
 && 
io2
->osè|| (io1->
šeg
 && io2->ineg))

420 || 
o1
->
İtiÚ_id
 =ğ
o2
->option_id)

424 
shÜt1
 = (
io1
->
ishÜt
 ? 
o1
->
shÜt_Çme
 : -1);

425 
shÜtx1
 = 
lÚg_as_shÜt
(
şi
, 
o1
, 
io1
, -2);

426 ià(
shÜt1
 >ğ0 || 
shÜtx1
 >= 0) {

427 
shÜt2
 = (
io2
->
ishÜt
 ? 
o2
->
shÜt_Çme
 : -3);

428 
shÜtx2
 = 
lÚg_as_shÜt
(
şi
, 
o2
, 
io2
, -4);

429 ià(
shÜt1
 =ğ
shÜt2
)

430 
CÍ_O±iÚE¼Ü
(
şp
, "CLP iÁ”ÇÈ”rÜ: mÜthª 1 o±iÚ ha shÜˆÇm%<%c%>", 
shÜt1
);

431 ià((
shÜt1
 =ğ
shÜtx2
 || 
shÜtx1
 =ğ
shÜt2
 || shortx1 == shortx2)

432 && ((
io1
->
os
 && 
io2
->o && 
şi
->
lÚg1pos
)

433 || (
io1
->
šeg
 && 
io2
->šeg && 
şi
->
lÚg1Ãg
)))

434 
CÍ_O±iÚE¼Ü
(
şp
, "CLP iÁ”ÇÈ”rÜ: 1-ch¬†Úg‚amcÚæiù w™h shÜˆÇm%<%c%>", (
shÜt1
 =ğ
shÜtx2
 ? shÜtx2 : 
shÜtx1
));

438 ià(
io1
->
Úg
) {

439 cÚ¡ *
Çme1
 = 
o1
->
lÚg_Çme
 + 
io1
->
Úgoff
;

442 ià(
io2
->
ishÜt
 && !
io1
->
»fm©ch
) {

443 
Çme1ch¬
 = (
şi
->
utf8
 ? 
decode_utf8
(
Çme1
, 0) : () *name1);

444 ià(
Çme1ch¬
 =ğ
o2
->
shÜt_Çme
) {

445 ià(
io1
->
os
 && 
io2
->ipos)

446 
io1
->
lmmpos_shÜt
 = 1;

447 ià(
io1
->
šeg
 && 
io2
->ineg)

448 
io1
->
lmmÃg_shÜt
 = 1;

453 ià(
io2
->
Úg
) {

454 cÚ¡ *
Çme2
 = 
o2
->
lÚg_Çme
 + 
io2
->
Úgoff
;

455 ià(
¡rcmp
(
Çme1
, 
Çme2
) == 0)

456 
CÍ_O±iÚE¼Ü
(
şp
, "CLP iÁ”ÇÈ”rÜ: du¶iÿ‹†Úg‚am%<%s%>", 
Çme1
);

457 ià(
io1
->
os
 && 
io2
->o && !
¡ºcmp
(
Çme1
, 
Çme2
, io1->
lmmpos
)

458 && (!
io1
->
»fm©ch
 || 
¡ºcmp
(
Çme1
, 
Çme2
, 
¡¾’
(name1))))

459 
io1
->
lmmpos
 = 
mš_difã»Á_ch¬s
(
Çme1
, 
Çme2
);

460 ià(
io1
->
šeg
 && 
io2
->šeg && !
¡ºcmp
(
Çme1
, 
Çme2
, io1->
lmmÃg
)

461 && (!
io1
->
»fm©ch
 || 
¡ºcmp
(
Çme1
, 
Çme2
, 
¡¾’
(name1))))

462 
io1
->
lmmÃg
 = 
mš_difã»Á_ch¬s
(
Çme1
, 
Çme2
);

468 
ÿlcuÏ‹_lmm
(
CÍ_P¬£r
 *
şp
, cÚ¡ 
CÍ_O±iÚ
 *
İt
, 
CÍ_IÁ”nO±iÚ
 *
iİt
, 
nİt
)

470 
i
, 
j
;

471 
i
 = 0; i < 
nİt
; ++i) {

472 
iİt
[
i
].
lmmpos
 = iİt[i].
lmmÃg
 = 1;

473 
iİt
[
i
].
lmmpos_shÜt
 = iİt[i].
lmmÃg_shÜt
 = 0;

474 
j
 = 0; j < 
nİt
; ++j)

475 
com·»_İtiÚs
(
şp
, &
İt
[
i
], &
iİt
[i], &İt[
j
], &iopt[j]);

515 
CÍ_P¬£r
 *

516 
CÍ_NewP¬£r
(
¬gc
, cÚ¡ * cÚ¡ *
¬gv
, 
nİt
, cÚ¡ 
CÍ_O±iÚ
 *
İt
)

518 
CÍ_P¬£r
 *
şp
 = (CÍ_P¬£¸*)
m®loc
((Clp_Parser));

519 
CÍ_IÁ”Çl
 *
şi
 = (CÍ_IÁ”ÇÈ*)
m®loc
((Clp_Internal));

520 
CÍ_IÁ”nO±iÚ
 *
iİt
 = (CÍ_IÁ”nO±iÚ *)
m®loc
((CÍ_IÁ”nO±iÚè* 
nİt
);

521 ià(
şi
)

522 
şi
->
v®ty³
 = (
CÍ_V®Ty³
 *)
m®loc
((CÍ_V®Ty³è* 
CÍ_In™ŸlV®Ty³
);

523 ià(!
şp
 || !
şi
 || !
iİt
 || !şi->
v®ty³
)

524 
çed
;

526 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
CÍ_DÚe
];

527 
şp
->
Ãg©ed
 = 0;

528 
şp
->
have_v®
 = 0;

529 
şp
->
v¡r
 = 0;

530 
şp
->
u£r_d©a
 = 0;

531 
şp
->
š‹º®
 = 
şi
;

533 
şi
->
İt
 = opt;

534 
şi
->
nİt
 =‚opt;

535 
şi
->
iİt
 = iopt;

536 
şi
->
İt_g’”©iÚ
 = 0;

537 
şi
->
”rÜ_hªdËr
 = 0;

540 ià(
¬gc
 > 0) {

541 cÚ¡ *
¦ash
 = 
¡¼chr
(
¬gv
[0], '/');

542 
şi
->
´og¿m_Çme
 = 
¦ash
 ? sÏsh + 1 : 
¬gv
[0];

544 
şi
->
´og¿m_Çme
 = 0;

547 
CÍ_S‘Argum’ts
(
şp
, 
¬gc
 - 1, 
¬gv
 + 1);

551 *
s
 = 
g‘’v
("LANG");

552 
şi
->
utf8
 = (
s
 && (
¡r¡r
(s, "UTF-8") != 0 || strstr(s, "UTF8") != 0

553 || 
¡r¡r
(
s
, "utf8") != 0));

555 
şi
->
oşass
[0].
c
 = '-';

556 
şi
->
oşass
[0].
ty³
 = 
CÍ_ShÜt
;

557 
şi
->
noşass
 = 1;

558 
şi
->
lÚg1pos
 = cli->
lÚg1Ãg
 = 0;

561 
şi
->
nv®ty³
 = 0;

562 
CÍ_AddTy³
(
şp
, 
CÍ_V®SŒšg
, 0, 
·r£_¡ršg
, 0);

563 
CÍ_AddTy³
(
şp
, 
CÍ_V®SŒšgNÙO±iÚ
, 
CÍ_Di§ÎowO±iÚs
, 
·r£_¡ršg
, 0);

564 
CÍ_AddTy³
(
şp
, 
CÍ_V®IÁ
, 0, 
·r£_št
, (*è(
ušŒ_t
) 0);

565 
CÍ_AddTy³
(
şp
, 
CÍ_V®UnsigÃd
, 0, 
·r£_št
, (*è(
ušŒ_t
) 1);

566 
CÍ_AddTy³
(
şp
, 
CÍ_V®LÚg
, 0, 
·r£_št
, (*è(
ušŒ_t
) 2);

567 
CÍ_AddTy³
(
şp
, 
CÍ_V®UnsigÃdLÚg
, 0, 
·r£_št
, (*è(
ušŒ_t
) 3);

568 
CÍ_AddTy³
(
şp
, 
CÍ_V®BoŞ
, 0, 
·r£_boŞ
, 0);

569 
CÍ_AddTy³
(
şp
, 
CÍ_V®DoubË
, 0, 
·r£_doubË
, 0);

572 
CÍ_S‘O±iÚs
(
şp
, 
nİt
, 
İt
);

574  
şp
;

576 
çed
:

577 ià(
şi
 && cli->
v®ty³
)

578 
ä“
(
şi
->
v®ty³
);

579 ià(
şi
)

580 
ä“
(
şi
);

581 ià(
şp
)

582 
ä“
(
şp
);

583 ià(
iİt
)

584 
ä“
(
iİt
);

592 
CÍ_D–‘eP¬£r
(
CÍ_P¬£r
 *
şp
)

594 
i
;

595 
CÍ_IÁ”Çl
 *
şi
;

596 ià(!
şp
)

599 
şi
 = 
şp
->
š‹º®
;

602 
i
 = 0; i < 
şi
->
nv®ty³
; i++)

603 ià(
şi
->
v®ty³
[
i
].
func
 =ğ
·r£_¡ršg_li¡
) {

604 
CÍ_SŒšgLi¡
 *
ş¦
 = (CÍ_SŒšgLi¡ *)
şi
->
v®ty³
[
i
].
u£r_d©a
;

605 
ä“
(
ş¦
->
™ems
);

606 
ä“
(
ş¦
->
iİt
);

607 
ä“
(
ş¦
);

610 
ä“
(
şi
->
v®ty³
);

611 
ä“
(
şi
->
iİt
);

612 
ä“
(
şi
);

613 
ä“
(
şp
);

626 
CÍ_E¼ÜHªdËr


627 
CÍ_S‘E¼ÜHªdËr
(
CÍ_P¬£r
 *
şp
, (*
”rh
)(Clp_Parser *, const *))

629 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

630 
CÍ_E¼ÜHªdËr
 
Şd
 = 
şi
->
”rÜ_hªdËr
;

631 
şi
->
”rÜ_hªdËr
 = 
”rh
;

632  
Şd
;

648 
CÍ_S‘UTF8
(
CÍ_P¬£r
 *
şp
, 
utf8
)

650 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

651 
Şd_utf8
 = 
şi
->
utf8
;

652 
şi
->
utf8
 = utf8;

653 
ÿlcuÏ‹_lmm
(
şp
, 
şi
->
İt
, cli->
iİt
, cli->
nİt
);

654  
Şd_utf8
;

665 
CÍ_O±iÚCh¬
(
CÍ_P¬£r
 *
şp
, 
c
)

667 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

668 
i
, 
oşass
 = 0;

669 ià(
şi
->
noşass
 > 0 && cli->
oşass
[0].
c
 == 0)

670 
oşass
 = 
şi
->oşass[0].
ty³
;

671 
i
 = 0; i < 
şi
->
noşass
; ++i)

672 ià(
şi
->
oşass
[
i
].
c
 == c)

673 
oşass
 = 
şi
->oşass[
i
].
ty³
;

674  
oşass
;

723 
CÍ_S‘O±iÚCh¬
(
CÍ_P¬£r
 *
şp
, 
c
, 
ty³
)

725 
i
, 
lÚg1pos
, 
lÚg1Ãg
;

726 
Şd
 = 
CÍ_O±iÚCh¬
(
şp
, 
c
);

727 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

729 ià(
ty³
 !ğ
CÍ_NÙO±iÚ
 &&y³ !ğ
CÍ_ShÜt
 &&y³ !ğ
CÍ_LÚg


730 && 
ty³
 !ğ
CÍ_ShÜtNeg©ed
 &&y³ !ğ
CÍ_LÚgNeg©ed


731 && 
ty³
 !ğ
CÍ_LÚgIm¶ic™
 &&y³ !ğ(
CÍ_ShÜt
 | 
CÍ_LÚg
)

732 && 
ty³
 !ğ(
CÍ_ShÜtNeg©ed
 | 
CÍ_LÚgNeg©ed
))

734 ià(
c
 < 0 || c >ğ(
şi
->
utf8
 ? 0x110000 : 256))

737 ià(
c
 == 0)

738 
şi
->
noşass
 = 0;

739 
i
 = 0; i < 
şi
->
noşass
; ++i)

740 ià(
şi
->
oşass
[
i
].
c
 == c)

742 ià(
i
 =ğ
CÍ_OşassSize
)

745 
şi
->
oşass
[
i
].
c
 = c;

746 
şi
->
oşass
[
i
].
ty³
 =ype;

747 ià(
şi
->
noşass
 =ğ
i
)

748 
şi
->
noşass
 = 
i
 + 1;

750 
lÚg1pos
 = 
lÚg1Ãg
 = 0;

751 
i
 = 0; i < 
şi
->
noşass
; ++i) {

752 ià((
şi
->
oşass
[
i
].
ty³
 & 
CÍ_ShÜt
)

753 && (
şi
->
oşass
[
i
].
ty³
 & 
CÍ_LÚg
))

754 
lÚg1pos
 = 1;

755 ià((
şi
->
oşass
[
i
].
ty³
 & 
CÍ_ShÜtNeg©ed
)

756 && (
şi
->
oşass
[
i
].
ty³
 & 
CÍ_LÚgNeg©ed
))

757 
lÚg1Ãg
 = 1;

760 ià(
lÚg1pos
 !ğ
şi
->lÚg1po || 
lÚg1Ãg
 != cli->long1neg) {

762 
şi
->
lÚg1pos
 =†ong1pos;

763 
şi
->
lÚg1Ãg
 =†ong1neg;

764 
ÿlcuÏ‹_lmm
(
şp
, 
şi
->
İt
, cli->
iİt
, cli->
nİt
);

767  
Şd
;

798 
CÍ_S‘O±iÚs
(
CÍ_P¬£r
 *
şp
, 
nİt
, cÚ¡ 
CÍ_O±iÚ
 *
İt
)

800 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

801 
CÍ_IÁ”nO±iÚ
 *
iİt
;

802 
i
;

803 
İt_g’”©iÚ
 = 0;

805 ià(
nİt
 > 
şi
->nopt) {

806 
iİt
 = (
CÍ_IÁ”nO±iÚ
 *)
m®loc
((CÍ_IÁ”nO±iÚè* 
nİt
);

807 ià(!
iİt
)

809 
ä“
(
şi
->
iİt
);

810 
şi
->
iİt
 = iopt;

813 
şi
->
İt
 = opt;

814 
şi
->
nİt
 =‚opt;

815 
şi
->
İt_g’”©iÚ
 = ++opt_generation;

816 
iİt
 = 
şi
->iopt;

817 
şi
->
cu¼’t_İtiÚ
 = -1;

820 
i
 = 0; i < 
nİt
; ++i) {

821 
mem£t
(&
iİt
[
i
], 0, (iopt[i]));

824 ià(
İt
[
i
].
İtiÚ_id
 < 0) {

825 
CÍ_O±iÚE¼Ü
(
şp
, "CLP iÁ”ÇÈ”rÜ: o±iÚ %d ha Ãg©ivİtiÚ_id", 
i
);

826 
iİt
[
i
].
Úg
 = iİt[i].
ishÜt
 = iİt[i].
os
 = iİt[i].
šeg
 = 0;

831 
iİt
[
i
].
Úg
 = (
İt
[i].
lÚg_Çme
 != 0 && opt[i].long_name[0] != 0);

832 
iİt
[
i
].
ishÜt
 = (
İt
[i].
shÜt_Çme
 > 0

833 && 
İt
[
i
].
shÜt_Çme
 < (
şi
->
utf8
 ? 0x110000 : 256));

834 
iİt
[
i
].
os
 = 1;

835 
iİt
[
i
].
šeg
 = (
İt
[i].
æags
 & 
CÍ_Neg©e
) != 0;

836 
iİt
[
i
].
imªd©Üy
 = (
İt
[i].
æags
 & 
CÍ_Mªd©Üy
) != 0;

837 
iİt
[
i
].
iİtiÚ®
 = (
İt
[i].
æags
 & 
CÍ_O±iÚ®
) != 0;

838 
iİt
[
i
].
»fm©ch
 = (
İt
[i].
æags
 & 
CÍ_P»ã¼edM©ch
) != 0;

839 
iİt
[
i
].
Úgoff
 = 0;

842 ià(
İt
[
i
].
v®_ty³
 <= 0)

843 
iİt
[
i
].
imªd©Üy
 = iİt[i].
iİtiÚ®
 = 0;

844 ià(
İt
[
i
].
v®_ty³
 > 0 && !
iİt
[i].
iİtiÚ®
)

845 
iİt
[
i
].
imªd©Üy
 = 1;

848 ià(
iİt
[
i
].
Úg
 && 
¡ºcmp
(
İt
[i].
lÚg_Çme
, "no-", 3) == 0) {

849 
iİt
[
i
].
os
 = 0;

850 
iİt
[
i
].
šeg
 = 1;

851 
iİt
[
i
].
Úgoff
 = 3;

852 ià(
¡ºcmp
(
İt
[
i
].
lÚg_Çme
 + 3, "no-", 3) == 0)

853 
CÍ_O±iÚE¼Ü
(
şp
, "CLP iÁ”ÇÈ”rÜ: o±iÚ %d begš w™h \"no-no-\"", 
i
);

854 } ià(
İt
[
i
].
æags
 & 
CÍ_OÆyNeg©ed
) {

855 
iİt
[
i
].
os
 = 0;

856 
iİt
[
i
].
šeg
 = 1;

861 
ÿlcuÏ‹_lmm
(
şp
, 
İt
, 
iİt
, 
nİt
);

884 
CÍ_S‘Argum’ts
(
CÍ_P¬£r
 *
şp
, 
¬gc
, cÚ¡ * cÚ¡ *
¬gv
)

886 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

888 
şi
->
¬gc
 =‡rgc + 1;

889 
şi
->
¬gv
 =‡rgv - 1;

891 
şi
->
is_shÜt
 = 0;

892 
şi
->
whŞe_Ãg©ed
 = 0;

893 
şi
->
İtiÚ_´oûssšg
 = 1;

894 
şi
->
cu¼’t_İtiÚ
 = -1;

907 
CÍ_S‘O±iÚProûssšg
(
CÍ_P¬£r
 *
şp
, 
Ú
)

909 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

910 
Şd
 = 
şi
->
İtiÚ_´oûssšg
;

911 
şi
->
İtiÚ_´oûssšg
 = 
Ú
;

912  
Şd
;

923 
¬gcmp
(cÚ¡ *
»f
, cÚ¡ *
¬g
, 
mš_m©ch
, 
ãw”_dashes
)

938 cÚ¡ *
»f¡¬t
 = 
»f
;

939 cÚ¡ *
¬g¡¬t
 = 
¬g
;

940 
as£¹
(
mš_m©ch
 > 0);

942 
com·»
:

943 *
»f
 && *
¬g
 && *arg != '=' && *ref == *arg)

944 
»f
++, 
¬g
++;

947 ià(
ãw”_dashes
 && *
»f
 =ğ'-' &&„ef[1] &&„ef[1] =ğ*
¬g
) {

948 
»f
++;

949 
com·»
;

952 ià(*
¬g
 && *arg != '=')

954 ià(
»f
 - 
»f¡¬t
 < 
mš_m©ch
)

957  
¬g
 - 
¬g¡¬t
;

961 
fšd_´efix_İt
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
¬g
,

962 
nİt
, cÚ¡ 
CÍ_O±iÚ
 *
İt
,

963 cÚ¡ 
CÍ_IÁ”nO±iÚ
 *
iİt
,

964 *
ambiguous
, *
ambiguous_v®ues
)

970 
i
, 
ãw”_dashes
 = 0, 
fœ¡_ambiguous
 = *
ambiguous
;

971 
Ãg©ed
 = 
şp
 && clp->negated;

972 
fœ¡_ch¬Ën
 = (
şp
 ? 
şp_utf8_ch¬Ën
(şp->
š‹º®
, 
¬g
) : 1);

974 
»Œy
:

975 
i
 = 0; i < 
nİt
; i++) {

976 
Ën
, 
lmm
;

977 ià(!
iİt
[
i
].
Úg
 || (
Ãg©ed
 ? !iİt[i].
šeg
 : !iİt[i].
os
))

980 
lmm
 = (
Ãg©ed
 ? 
iİt
[
i
].
lmmÃg
 : iİt[i].
lmmpos
);

981 ià(
şp
 && cÍ->
š‹º®
->
could_be_shÜt


982 && (
Ãg©ed
 ? 
iİt
[
i
].
lmmÃg_shÜt
 : iİt[i].
lmmpos_shÜt
))

983 
lmm
 = (
fœ¡_ch¬Ën
 >=†mm ? first_charlen + 1 :†mm);

984 
Ën
 = 
¬gcmp
(
İt
[
i
].
lÚg_Çme
 + 
iİt
[i].
Úgoff
, 
¬g
, 
lmm
, 
ãw”_dashes
);

985 ià(
Ën
 > 0)

986  
i
;

987 ià(
Ën
 < 0) {

988 ià(*
ambiguous
 < 
MAX_AMBIGUOUS_VALUES
)

989 
ambiguous_v®ues
[*
ambiguous
] = 
i
;

990 (*
ambiguous
)++;

995 ià(*
ambiguous
 =ğ
fœ¡_ambiguous
 && !
ãw”_dashes
) {

996 
ãw”_dashes
 = 1;

997 
»Œy
;

1009 
v®_ty³_bš£¬ch
(
CÍ_IÁ”Çl
 *
şi
, 
v®_ty³
)

1011 
l
 = 0, 
r
 = 
şi
->
nv®ty³
;

1012 
l
 < 
r
) {

1013 
m
 = 
l
 + (
r
 -†) / 2;

1014 ià(
şi
->
v®ty³
[
m
].
v®_ty³
 == val_type)

1015  
m
;

1016 ià(
şi
->
v®ty³
[
m
].
v®_ty³
 < val_type)

1017 
l
 = 
m
 + 1;

1019 
r
 = 
m
;

1021  
l
;

1056 
CÍ_AddTy³
(
CÍ_P¬£r
 *
şp
, 
v®_ty³
, 
æags
,

1057 
CÍ_V®P¬£Func
 
·r£r
, *
u£r_d©a
)

1059 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1060 
vos
;

1062 ià(
v®_ty³
 <ğ0 || !
·r£r
)

1065 
vos
 = 
v®_ty³_bš£¬ch
(
şi
, 
v®_ty³
);

1067 ià(
vos
 =ğ
şi
->
nv®ty³
 || cli->
v®ty³
[vos].
v®_ty³
 != val_type) {

1068 ià(
şi
->
nv®ty³
 !ğ0 && (şi->nv®ty³ % 
CÍ_In™ŸlV®Ty³
) == 0) {

1069 
CÍ_V®Ty³
 *
Ãw_v®ty³
 =

1070 (
CÍ_V®Ty³
 *è
»®loc
(
şi
->
v®ty³
, (CÍ_V®Ty³è* (şi->
nv®ty³
 + 
CÍ_In™ŸlV®Ty³
));

1071 ià(!
Ãw_v®ty³
)

1073 
şi
->
v®ty³
 = 
Ãw_v®ty³
;

1075 
memmove
(&
şi
->
v®ty³
[
vos
 + 1], &cli->valtype[vtpos],

1076 (
CÍ_V®Ty³
è* (
şi
->
nv®ty³
 - 
vos
));

1077 
şi
->
nv®ty³
++;

1078 
şi
->
v®ty³
[
vos
].
func
 = 0;

1081 ià(
şi
->
v®ty³
[
vos
].
func
 =ğ
·r£_¡ršg_li¡
) {

1082 
CÍ_SŒšgLi¡
 *
ş¦
 = (CÍ_SŒšgLi¡ *è
şi
->
v®ty³
[
vos
].
u£r_d©a
;

1083 
ä“
(
ş¦
->
™ems
);

1084 
ä“
(
ş¦
->
iİt
);

1085 
ä“
(
ş¦
);

1088 
şi
->
v®ty³
[
vos
].
v®_ty³
 = val_type;

1089 
şi
->
v®ty³
[
vos
].
func
 = 
·r£r
;

1090 
şi
->
v®ty³
[
vos
].
æags
 = flags;

1091 
şi
->
v®ty³
[
vos
].
u£r_d©a
 = user_data;

1101 
·r£_¡ršg
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
¬g
, 
com¶aš
, *
u£r_d©a
)

1103 ()
com¶aš
, ()
u£r_d©a
;

1104 
şp
->
v®
.
s
 = 
¬g
;

1109 
·r£_št
(
CÍ_P¬£r
* 
şp
, cÚ¡ * 
¬g
, 
com¶aš
, * 
u£r_d©a
)

1111 cÚ¡ *
v®
;

1112 
ušŒ_t
 
ty³
 = (ušŒ_tè
u£r_d©a
;

1113 ià(*
¬g
 =ğ0 || 
is¥aû
(() *arg)

1114 || ((
ty³
 & 1è&& *
¬g
 == '-'))

1115 
v®
 = 
¬g
;

1116 ià(
ty³
 & 1) {

1117 #ià
HAVE_STRTOUL


1118 
şp
->
v®
.
ul
 = 
¡¹oul
(
¬g
, (**) &val, 0);

1121 ià(
¬g
[0] == '-')

1122 
v®
 = 
¬g
;

1124 
şp
->
v®
.
l
 = 
¡¹Ş
(
¬g
, (**) &val, 0);

1127 
şp
->
v®
.
l
 = 
¡¹Ş
(
¬g
, (**) &val, 0);

1128 ià(
ty³
 <= 1)

1129 
şp
->
v®
.
u
 = (èşp->v®.
ul
;

1130 ià(*
¬g
 !ğ0 && *
v®
 == 0)

1133 ià(
com¶aš
) {

1134 cÚ¡ *
mes§ge
 = 
ty³
 & 1

1137 
CÍ_O±iÚE¼Ü
(
şp
, 
mes§ge
, 
¬g
);

1144 
·r£_doubË
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
¬g
, 
com¶aš
, *
u£r_d©a
)

1146 cÚ¡ *
v®
;

1147 ()
u£r_d©a
;

1148 ià(*
¬g
 =ğ0 || 
is¥aû
(() *arg))

1149 
v®
 = 
¬g
;

1151 
şp
->
v®
.
d
 = 
¡¹od
(
¬g
, (**) &val);

1152 ià(*
¬g
 !ğ0 && *
v®
 == 0)

1155 ià(
com¶aš
)

1156 
CÍ_O±iÚE¼Ü
(
şp
, "%<%O%>ƒx³ù ¨»®‚umb”,‚Ù %<%s%>", 
¬g
);

1162 
·r£_boŞ
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
¬g
, 
com¶aš
, *
u£r_d©a
)

1164 
i
;

1165 
lÿrg
[6];

1166 ()
u£r_d©a
;

1167 ià(
¡¾’
(
¬g
è> 5 || 
¡rchr
(arg, '=') != 0)

1168 
”rÜ
;

1170 
i
 = 0; 
¬g
[i] != 0; i++)

1171 
lÿrg
[
i
] = 
tŞow”
((è
¬g
[i]);

1172 
lÿrg
[
i
] = 0;

1174 ià(
¬gcmp
("yes", 
lÿrg
, 1, 0) > 0

1175 || 
¬gcmp
("Œue", 
lÿrg
, 1, 0) > 0

1176 || 
¬gcmp
("1", 
lÿrg
, 1, 0) > 0) {

1177 
şp
->
v®
.
i
 = 1;

1179 } ià(
¬gcmp
("no", 
lÿrg
, 1, 0) > 0

1180 || 
¬gcmp
("çl£", 
lÿrg
, 1, 0) > 0

1181 || 
¬gcmp
("1", 
lÿrg
, 1, 0) > 0) {

1182 
şp
->
v®
.
i
 = 0;

1186 
”rÜ
:

1187 ià(
com¶aš
)

1188 
CÍ_O±iÚE¼Ü
(
şp
, "%<%O%>ƒx³ù ¨Œue-Ü-çl£ v®ue,‚Ù %<%s%>", 
¬g
);

1198 
·r£_¡ršg_li¡
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
¬g
, 
com¶aš
, *
u£r_d©a
)

1200 
CÍ_SŒšgLi¡
 *
¦
 = (CÍ_SŒšgLi¡ *)
u£r_d©a
;

1201 
idx
, 
ambiguous
 = 0;

1202 
ambiguous_v®ues
[
MAX_AMBIGUOUS_VALUES
 + 1];

1205 
idx
 = 
fšd_´efix_İt


1206 (0, 
¬g
, 
¦
->
n™ems
, sl->
™ems
, sl->
iİt
,

1207 &
ambiguous
, 
ambiguous_v®ues
);

1208 ià(
idx
 >= 0) {

1209 
şp
->
v®
.
i
 = 
¦
->
™ems
[
idx
].
İtiÚ_id
;

1210 ià(
¦
->
v®_lÚg
)

1211 
şp
->
v®
.
l
 = cÍ->v®.
i
;

1215 ià(
¦
->
®low_št
) {

1216 ià(
·r£_št
(
şp
, 
¬g
, 0, (*è(
ušŒ_t
è(
¦
->
v®_lÚg
 ? 2 : 0)))

1220 ià(
com¶aš
) {

1221 cÚ¡ *
com¶ašt
 = (
ambiguous
 ? "ambiguous" : "invalid");

1222 ià(!
ambiguous
) {

1223 
ambiguous
 = 
¦
->
n™ems_šv®id_»pÜt
;

1224 
idx
 = 0; idx < 
ambiguous
; idx++)

1225 
ambiguous_v®ues
[
idx
] = idx;

1227  
ambigu™y_”rÜ


1228 (
şp
, 
ambiguous
, 
ambiguous_v®ues
, 
¦
->
™ems
, sl->
iİt
,

1229 "", "İtiÚ %<%V%> i %s", 
com¶ašt
);

1236 
fšish_¡ršg_li¡
(
CÍ_P¬£r
 *
şp
, 
v®_ty³
, 
æags
,

1237 
CÍ_O±iÚ
 *
™ems
, 
n™ems
, 
™emsÿp
)

1239 
i
;

1240 
CÍ_SŒšgLi¡
 *
ş¦
 = (CÍ_SŒšgLi¡ *)
m®loc
((Clp_StringList));

1241 
CÍ_IÁ”nO±iÚ
 *
iİt
 = (CÍ_IÁ”nO±iÚ *)
m®loc
((CÍ_IÁ”nO±iÚè* 
n™ems
);

1242 ià(!
ş¦
 || !
iİt
)

1243 
”rÜ
;

1245 
ş¦
->
™ems
 = items;

1246 
ş¦
->
iİt
 = iopt;

1247 
ş¦
->
n™ems
 =‚items;

1248 
ş¦
->
®low_št
 = (
æags
 & 
CÍ_AÎowNumb”s
) != 0;

1249 
ş¦
->
v®_lÚg
 = (
æags
 & 
CÍ_SŒšgLi¡LÚg
) != 0;

1251 ià(
n™ems
 < 
MAX_AMBIGUOUS_VALUES
 &&‚™em < 
™emsÿp
 && 
ş¦
->
®low_št
) {

1252 
™ems
[
n™ems
].
lÚg_Çme
 = "any integer";

1253 
ş¦
->
n™ems_šv®id_»pÜt
 = 
n™ems
 + 1;

1254 } ià(
n™ems
 > 
MAX_AMBIGUOUS_VALUES
 + 1)

1255 
ş¦
->
n™ems_šv®id_»pÜt
 = 
MAX_AMBIGUOUS_VALUES
 + 1;

1257 
ş¦
->
n™ems_šv®id_»pÜt
 = 
n™ems
;

1259 
i
 = 0; i < 
n™ems
; i++) {

1260 
iİt
[
i
].
Úg
 = iİt[i].
os
 = 1;

1261 
iİt
[
i
].
ishÜt
 = iİt[i].
šeg
 = iİt[i].
Úgoff
 = iİt[i].
»fm©ch
 = 0;

1263 
ÿlcuÏ‹_lmm
(
şp
, 
™ems
, 
iİt
, 
n™ems
);

1265 ià(
CÍ_AddTy³
(
şp
, 
v®_ty³
, 0, 
·r£_¡ršg_li¡
, 
ş¦
) >= 0)

1268 
”rÜ
:

1269 ià(
ş¦
)

1270 
ä“
(
ş¦
);

1271 ià(
iİt
)

1272 
ä“
(
iİt
);

1302 
CÍ_AddSŒšgLi¡Ty³
(
CÍ_P¬£r
 *
şp
, 
v®_ty³
, 
æags
, ...)

1304 
n™ems
 = 0;

1305 
™emsÿp
 = 5;

1306 
CÍ_O±iÚ
 *
™ems
 = (CÍ_O±iÚ *)
m®loc
((CÍ_O±iÚè* 
™emsÿp
);

1308 
va_li¡
 
v®
;

1309 
va_¡¬t
(
v®
, 
æags
);

1311 ià(!
™ems
)

1312 
”rÜ
;

1316 
v®ue
;

1317 *
Çme
 = 
va_¬g
(
v®
, *);

1318 ià(!
Çme
)

1320 ià(
æags
 & 
CÍ_SŒšgLi¡LÚg
) {

1321 
lv®ue
 = 
va_¬g
(
v®
, );

1322 
v®ue
 = (è
lv®ue
;

1323 
as£¹
(
v®ue
 =ğ
lv®ue
);

1325 
v®ue
 = 
va_¬g
(
v®
, );

1327 ià(
n™ems
 >ğ
™emsÿp
) {

1328 
CÍ_O±iÚ
 *
Ãw_™ems
;

1329 
™emsÿp
 *= 2;

1330 
Ãw_™ems
 = (
CÍ_O±iÚ
 *)
»®loc
(
™ems
, (CÍ_O±iÚè* 
™emsÿp
);

1331 ià(!
Ãw_™ems
)

1332 
”rÜ
;

1333 
™ems
 = 
Ãw_™ems
;

1336 
™ems
[
n™ems
].
lÚg_Çme
 = 
Çme
;

1337 
™ems
[
n™ems
].
İtiÚ_id
 = 
v®ue
;

1338 
™ems
[
n™ems
].
æags
 = 0;

1339 
n™ems
++;

1342 
va_’d
(
v®
);

1343 ià(
fšish_¡ršg_li¡
(
şp
, 
v®_ty³
, 
æags
, 
™ems
, 
n™ems
, 
™emsÿp
) >= 0)

1346 
”rÜ
:

1347 
va_’d
(
v®
);

1348 ià(
™ems
)

1349 
ä“
(
™ems
);

1391 
CÍ_AddSŒšgLi¡Ty³Vec
(
CÍ_P¬£r
 *
şp
, 
v®_ty³
, 
æags
,

1392 
n¡rs
, cÚ¡ * cÚ¡ *
¡rs
,

1393 cÚ¡ *
v®s
)

1398 
i
;

1399 
™emsÿp
 = (
n¡rs
 < 5 ? 5 :‚strs);

1400 
CÍ_O±iÚ
 *
™ems
 = (CÍ_O±iÚ *)
m®loc
((CÍ_O±iÚè* 
™emsÿp
);

1401 ià(!
™ems
)

1405 
i
 = 0; i < 
n¡rs
; i++) {

1406 
™ems
[
i
].
lÚg_Çme
 = 
¡rs
[i];

1407 
™ems
[
i
].
İtiÚ_id
 = 
v®s
[i];

1408 
™ems
[
i
].
æags
 = 0;

1411 ià(
fšish_¡ršg_li¡
(
şp
, 
v®_ty³
, 
æags
, 
™ems
, 
n¡rs
, 
™emsÿp
) >= 0)

1414 
ä“
(
™ems
);

1425 
CÍ_Prog¿mName
(
CÍ_P¬£r
 *
şp
)

1427  
şp
->
š‹º®
->
´og¿m_Çme
;

1437 
CÍ_S‘Prog¿mName
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
Çme
)

1439 cÚ¡ *
Şd
 = 
şp
->
š‹º®
->
´og¿m_Çme
;

1440 
şp
->
š‹º®
->
´og¿m_Çme
 = 
Çme
;

1441  
Şd
;

1464 
CÍ_P¬£rS‹
 *

1465 
CÍ_NewP¬£rS‹
()

1467 
CÍ_P¬£rS‹
 *
¡©e
 = (CÍ_P¬£rS‹ *)
m®loc
((Clp_ParserState));

1468 ià(
¡©e
) {

1469 
¡©e
->
¬gv
 = 0;

1470 
¡©e
->
¬gc
 = 0;

1471 
¡©e
->
İtiÚ_ch¬s
[0] = 0;

1472 
¡©e
->
x‹xt
 = 0;

1473 
¡©e
->
İtiÚ_´oûssšg
 = 0;

1474 
¡©e
->
İt_g’”©iÚ
 = 0;

1475 
¡©e
->
cu¼’t_İtiÚ
 = -1;

1476 
¡©e
->
is_shÜt
 = 0;

1477 
¡©e
->
whŞe_Ãg©ed
 = 0;

1478 
¡©e
->
cu¼’t_shÜt
 = 0;

1479 
¡©e
->
Ãg©ed_by_no
 = 0;

1481  
¡©e
;

1489 
CÍ_D–‘eP¬£rS‹
(
CÍ_P¬£rS‹
 *
¡©e
)

1491 
ä“
(
¡©e
);

1499 
CÍ_SaveP¬£r
(cÚ¡ 
CÍ_P¬£r
 *
şp
, 
CÍ_P¬£rS‹
 *
¡©e
)

1501 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1502 
¡©e
->
¬gv
 = 
şi
->argv;

1503 
¡©e
->
¬gc
 = 
şi
->argc;

1504 
memıy
(
¡©e
->
İtiÚ_ch¬s
, 
şi
->İtiÚ_ch¬s, 
CÍ_O±iÚCh¬sSize
);

1505 
¡©e
->
x‹xt
 = 
şi
->xtext;

1507 
¡©e
->
İtiÚ_´oûssšg
 = 
şi
->option_processing;

1508 
¡©e
->
İt_g’”©iÚ
 = 
şi
->opt_generation;

1509 
¡©e
->
cu¼’t_İtiÚ
 = 
şi
->current_option;

1510 
¡©e
->
is_shÜt
 = 
şi
->is_short;

1511 
¡©e
->
whŞe_Ãg©ed
 = 
şi
->whole_negated;

1512 
¡©e
->
cu¼’t_shÜt
 = 
şi
->current_short;

1513 
¡©e
->
Ãg©ed_by_no
 = 
şi
->negated_by_no;

1532 
CÍ_Re¡ÜeP¬£r
(
CÍ_P¬£r
 *
şp
, cÚ¡ 
CÍ_P¬£rS‹
 *
¡©e
)

1534 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1535 
şi
->
¬gv
 = 
¡©e
->argv;

1536 
şi
->
¬gc
 = 
¡©e
->argc;

1537 
memıy
(
şi
->
İtiÚ_ch¬s
, 
¡©e
->İtiÚ_ch¬s, 
CÍ_O±iÚCh¬sSize
);

1538 
şi
->
x‹xt
 = 
¡©e
->xtext;

1539 
şi
->
İtiÚ_´oûssšg
 = 
¡©e
->option_processing;

1540 
şi
->
is_shÜt
 = 
¡©e
->is_short;

1541 
şi
->
whŞe_Ãg©ed
 = 
¡©e
->whole_negated;

1542 
şi
->
cu¼’t_shÜt
 = 
¡©e
->current_short;

1543 
şi
->
Ãg©ed_by_no
 = 
¡©e
->negated_by_no;

1544 ià(
şi
->
İt_g’”©iÚ
 =ğ
¡©e
->opt_generation)

1545 
şi
->
cu¼’t_İtiÚ
 = 
¡©e
->current_option;

1547 
şi
->
cu¼’t_İtiÚ
 = -1;

1556 
£t_İtiÚ_‹xt
(
CÍ_IÁ”Çl
 *
şi
, cÚ¡ *
‹xt
, 
n_İtiÚ_ch¬s
)

1558 
as£¹
(
n_İtiÚ_ch¬s
 < 
CÍ_O±iÚCh¬sSize
);

1559 
memıy
(
şi
->
İtiÚ_ch¬s
, 
‹xt
, 
n_İtiÚ_ch¬s
);

1560 
şi
->
İtiÚ_ch¬s
[
n_İtiÚ_ch¬s
] = 0;

1561 
şi
->
x‹xt
 = 
‹xt
 + 
n_İtiÚ_ch¬s
;

1565 
g‘_oşass
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
‹xt
, *
och¬sk
)

1567 
c
;

1568 ià(
şp
->
š‹º®
->
utf8
) {

1569 cÚ¡ *
s
;

1570 
c
 = 
decode_utf8
(
‹xt
, &
s
);

1571 *
och¬sk
 = 
s
 - 
‹xt
;

1573 
c
 = (è
‹xt
[0];

1574 *
och¬sk
 = 1;

1576  
CÍ_O±iÚCh¬
(
şp
, 
c
);

1580 
Ãxt_¬gum’t
(
CÍ_P¬£r
 *
şp
, 
wªt_¬gum’t
)

1599 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1600 cÚ¡ *
‹xt
;

1601 
oşass
, 
och¬sk
;

1604 
şp
->
have_v®
 = 0;

1605 
şp
->
v¡r
 = 0;

1606 
şi
->
could_be_shÜt
 = 0;

1609 ià(
şi
->
is_shÜt
) {

1610 
şi
->
x‹xt
 +ğ
şp_utf8_ch¬Ën
(cli, cli->xtext);

1611 ià(
şi
->
x‹xt
[0] == 0)

1612 
şi
->
is_shÜt
 = 0;

1613 ià(
wªt_¬gum’t
 > 0) {

1615 
şp
->
have_v®
 = 1;

1616 ià(
şi
->
x‹xt
[0] == '=')

1617 
şp
->
v¡r
 = 
şi
->
x‹xt
 + 1;

1619 
şp
->
v¡r
 = 
şi
->
x‹xt
;

1620 
şi
->
is_shÜt
 = 0;

1626 ià(
şi
->
is_shÜt
)

1630 
şi
->
whŞe_Ãg©ed
 = 0;

1631 
şi
->
x‹xt
 = 0;

1633 ià(
şi
->
¬gc
 <= 1)

1636 
şi
->
¬gc
--;

1637 
şi
->
¬gv
++;

1638 
‹xt
 = 
şi
->
¬gv
[0];

1640 ià(
wªt_¬gum’t
 > 1)

1641 
nÙ_İtiÚ
;

1643 ià(
‹xt
[0] == '-' &&ext[1] == '-') {

1644 
oşass
 = 
CÍ_DoubËdLÚg
;

1645 
och¬sk
 = 2;

1647 
oşass
 = 
g‘_oşass
(
şp
, 
‹xt
, &
och¬sk
);

1652 ià((
oşass
 & (
CÍ_ShÜt
 | 
CÍ_ShÜtNeg©ed
))

1653 && (
oşass
 & (
CÍ_LÚg
 | 
CÍ_LÚgNeg©ed
))) {

1654 
oşass
 &ğ~(
CÍ_ShÜt
 | 
CÍ_ShÜtNeg©ed
);

1655 ià(
‹xt
[
och¬sk
])

1656 
şi
->
could_be_shÜt
 = 1;

1659 
oşass
) {

1661 
CÍ_ShÜt
:

1662 
şi
->
is_shÜt
 = 1;

1663 
check_sšgËtÚ
;

1665 
CÍ_ShÜtNeg©ed
:

1666 
şi
->
is_shÜt
 = 1;

1667 
şi
->
whŞe_Ãg©ed
 = 1;

1668 
check_sšgËtÚ
;

1670 
CÍ_LÚg
:

1671 
check_sšgËtÚ
;

1673 
CÍ_LÚgNeg©ed
:

1674 
şi
->
whŞe_Ãg©ed
 = 1;

1675 
check_sšgËtÚ
;

1677 
check_sšgËtÚ
:

1680 ià(!
‹xt
[
och¬sk
])

1681 
nÙ_İtiÚ
;

1682 
£t_İtiÚ_‹xt
(
şi
, 
‹xt
, 
och¬sk
);

1685 
CÍ_LÚgIm¶ic™
:

1688 ià(
wªt_¬gum’t
 > 0)

1689 
nÙ_İtiÚ
;

1690 
£t_İtiÚ_‹xt
(
şi
, 
‹xt
, 0);

1693 
CÍ_DoubËdLÚg
:

1694 
£t_İtiÚ_‹xt
(
şi
, 
‹xt
, 
och¬sk
);

1697 
nÙ_İtiÚ
:

1698 
CÍ_NÙO±iÚ
:

1699 
şi
->
is_shÜt
 = 0;

1700 
şp
->
have_v®
 = 1;

1701 
şp
->
v¡r
 = 
‹xt
;

1705 
as£¹
(0 );

1714 
sw™ch_to_shÜt_¬gum’t
(
CÍ_P¬£r
 *
şp
)

1716 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1717 cÚ¡ *
‹xt
 = 
şi
->
¬gv
[0];

1718 
och¬sk
, 
oşass
 = 
g‘_oşass
(
şp
, 
‹xt
, &ocharskip);

1719 
as£¹
(
şi
->
could_be_shÜt
);

1720 
şi
->
is_shÜt
 = 1;

1721 
şi
->
whŞe_Ãg©ed
 = (
oşass
 & 
CÍ_ShÜtNeg©ed
 ? 1 : 0);

1722 
£t_İtiÚ_‹xt
(
şi
, cli->
¬gv
[0], 
och¬sk
);

1727 
fšd_lÚg
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
¬g
)

1733 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1734 
İŠo
, 
Ën
, 
lmm
;

1735 cÚ¡ 
CÍ_O±iÚ
 *
İt
 = 
şi
->opt;

1736 cÚ¡ 
CÍ_IÁ”nO±iÚ
 *
iİt
;

1737 
fœ¡_Ãg©ive_ambiguous
;

1740 
İŠo
 = 
fšd_´efix_İt


1741 (
şp
, 
¬g
, 
şi
->
nİt
, 
İt
, cli->
iİt
,

1742 &
şi
->
ambiguous
, cli->
ambiguous_v®ues
);

1743 ià(
İŠo
 >= 0)

1744 
wÜked
;

1749 
fœ¡_Ãg©ive_ambiguous
 = 
şi
->
ambiguous
;

1750 
¬g
[0] == 'n' &&‡rg[1] == 'o' &&‡rg[2] == '-') {

1751 
¬g
 += 3;

1752 
şp
->
Ãg©ed
 = !clp->negated;

1753 
İŠo
 = 
fšd_´efix_İt


1754 (
şp
, 
¬g
, 
şi
->
nİt
, 
İt
, cli->
iİt
,

1755 &
şi
->
ambiguous
, cli->
ambiguous_v®ues
);

1756 ià(
İŠo
 >= 0)

1757 
wÜked
;

1763 
i
, 
max
 = 
şi
->
ambiguous
;

1764 ià(
max
 > 
MAX_AMBIGUOUS_VALUES
) max = MAX_AMBIGUOUS_VALUES;

1765 
i
 = 
fœ¡_Ãg©ive_ambiguous
; i < 
max
; i++)

1766 
şi
->
ambiguous_v®ues
[
i
] = -cli->ambiguous_values[i] - 1;

1770 
wÜked
:

1771 
iİt
 = &
şi
->iİt[
İŠo
];

1772 
lmm
 = (
şp
->
Ãg©ed
 ? 
iİt
->
lmmÃg
 : iİt->
lmmpos
);

1773 ià(
şi
->
could_be_shÜt


1774 && (
şp
->
Ãg©ed
 ? 
iİt
->
lmmÃg_shÜt
 : iİt->
lmmpos_shÜt
)) {

1775 
fœ¡_ch¬Ën
 = 
şp_utf8_ch¬Ën
(
şi
, 
¬g
);

1776 
lmm
 = (
fœ¡_ch¬Ën
 >=†mm ? first_charlen + 1 :†mm);

1778 
Ën
 = 
¬gcmp
(
İt
[
İŠo
].
lÚg_Çme
 + 
iİt
->
Úgoff
, 
¬g
, 
lmm
, 1);

1779 
as£¹
(
Ën
 > 0);

1780 ià(
¬g
[
Ën
] == '=') {

1781 
şp
->
have_v®
 = 1;

1782 
şp
->
v¡r
 = 
¬g
 + 
Ën
 + 1;

1784  
İŠo
;

1789 
fšd_shÜt
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
‹xt
)

1792 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1793 cÚ¡ 
CÍ_O±iÚ
 *
İt
 = 
şi
->opt;

1794 cÚ¡ 
CÍ_IÁ”nO±iÚ
 *
iİt
 = 
şi
->iopt;

1795 
i
, 
c
;

1796 ià(
şp
->
š‹º®
->
utf8
)

1797 
c
 = 
decode_utf8
(
‹xt
, 0);

1799 
c
 = (è*
‹xt
;

1801 
i
 = 0; i < 
şi
->
nİt
; i++)

1802 ià(
iİt
[
i
].
ishÜt
 && 
İt
[i].
shÜt_Çme
 =ğ
c


1803 && (!
şp
->
Ãg©ed
 || 
iİt
[
i
].
šeg
)) {

1804 
şp
->
Ãg©ed
 = cÍ->Ãg©ed || !
iİt
[
i
].
os
;

1805  
i
;

1855 
CÍ_Next
(
CÍ_P¬£r
 *
şp
)

1857 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

1858 
İŠo
;

1859 cÚ¡ 
CÍ_O±iÚ
 *
İt
;

1860 
CÍ_P¬£rS‹
 
şp§ve
;

1861 
vos
, 
com¶aš
;

1864 
şi
->
cu¼’t_İtiÚ
 = -1;

1865 
şi
->
ambiguous
 = 0;

1868 ià(!
Ãxt_¬gum’t
(
şp
, 
şi
->
İtiÚ_´oûssšg
 ? 0 : 2)) {

1869 
şp
->
v®
.
s
 = cÍ->
v¡r
;

1870 
İŠo
 = 
şp
->
have_v®
 ? 
CÍ_NÙO±iÚ
 : 
CÍ_DÚe
;

1871 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
İŠo
];

1872  
İŠo
;

1875 
şp
->
Ãg©ed
 = 
şi
->
whŞe_Ãg©ed
;

1876 ià(
şi
->
is_shÜt
)

1877 
İŠo
 = 
fšd_shÜt
(
şp
, 
şi
->
x‹xt
);

1879 
İŠo
 = 
fšd_lÚg
(
şp
, 
şi
->
x‹xt
);

1883 ià(
İŠo
 < 0 && 
şi
->
could_be_shÜt
) {

1884 
sw™ch_to_shÜt_¬gum’t
(
şp
);

1885 
İŠo
 = 
fšd_shÜt
(
şp
, 
şi
->
x‹xt
);

1889 ià(
İŠo
 < 0 || (
şp
->
Ãg©ed
 && !
şi
->
iİt
[İŠo].
šeg
)) {

1892 ià(
¡rcmp
(
şi
->
¬gv
[0], "--") == 0) {

1893 
CÍ_S‘O±iÚProûssšg
(
şp
, 0);

1894  
CÍ_Next
(
şp
);

1898 ià(
şi
->
ambiguous
)

1899 
ambigu™y_”rÜ
(
şp
, 
şi
->
ambiguous
, cli->
ambiguous_v®ues
,

1900 
şi
->
İt
, cli->
iİt
, cli->
İtiÚ_ch¬s
,

1902 
şi
->
İtiÚ_ch¬s
, cli->
x‹xt
);

1903 ià(
şi
->
is_shÜt
 && !şi->
could_be_shÜt
)

1904 
CÍ_O±iÚE¼Ü
(
şp
, "unrecognized option %<%s%C%>",

1905 
şi
->
İtiÚ_ch¬s
, cli->
x‹xt
);

1907 
CÍ_O±iÚE¼Ü
(
şp
, "unrecognized option %<%s%s%>",

1908 
şi
->
İtiÚ_ch¬s
, cli->
x‹xt
);

1910 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
CÍ_BadO±iÚ
];

1911  
CÍ_BadO±iÚ
;

1915 
şi
->
cu¼’t_İtiÚ
 = 
İŠo
;

1916 
şi
->
cu¼’t_shÜt
 = cli->
is_shÜt
;

1917 
şi
->
Ãg©ed_by_no
 = 
şp
->
Ãg©ed
 && !şi->
whŞe_Ãg©ed
;

1920 ià(
şp
->
Ãg©ed


1921 || (!
şi
->
iİt
[
İŠo
].
imªd©Üy
 && !şi->iİt[İŠo].
iİtiÚ®
)) {

1922 ià(
şp
->
have_v®
) {

1923 
CÍ_O±iÚE¼Ü
(
şp
, "%<%O%> can%,take‡n‡rgument");

1924 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
CÍ_BadO±iÚ
];

1925  
CÍ_BadO±iÚ
;

1927 
şp
->
İtiÚ
 = &
şi
->
İt
[
İŠo
];

1928  
şi
->
İt
[
İŠo
].
İtiÚ_id
;

1934 
İt
 = &
şi
->İt[
İŠo
];

1935 ià(
İt
->
v®_ty³
 <= 0) {

1936 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
CÍ_E¼Ü
];

1937  
CÍ_E¼Ü
;

1939 
vos
 = 
v®_ty³_bš£¬ch
(
şi
, 
İt
->
v®_ty³
);

1940 ià(
vos
 =ğ
şi
->
nv®ty³


1941 || 
şi
->
v®ty³
[
vos
].
v®_ty³
 !ğ
İt
->val_type) {

1942 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
CÍ_E¼Ü
];

1943  
CÍ_E¼Ü
;

1948 
com¶aš
 = (
şp
->
have_v®
 !ğ0è|| 
şi
->
iİt
[
İŠo
].
imªd©Üy
;

1949 
CÍ_SaveP¬£r
(
şp
, &
şp§ve
);

1951 ià(
şi
->
iİt
[
İŠo
].
imªd©Üy
 && !
şp
->
have_v®
) {

1955 
di§Îow
 = (
şi
->
v®ty³
[
vos
].
æags
 & 
CÍ_Di§ÎowO±iÚs
) != 0;

1956 
Ãxt_¬gum’t
(
şp
, 
di§Îow
 ? 1 : 2);

1957 ià(!
şp
->
have_v®
) {

1958 
gÙ_İtiÚ
 = 
şi
->
x‹xt
 != 0;

1959 
CÍ_Re¡ÜeP¬£r
(
şp
, &
şp§ve
);

1960 ià(
gÙ_İtiÚ
)

1961 
CÍ_O±iÚE¼Ü
(
şp
, "%<%O%>„equires‡‚on-option‡rgument");

1963 
CÍ_O±iÚE¼Ü
(
şp
, "%<%O%>„equires‡n‡rgument");

1964 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
CÍ_BadO±iÚ
];

1965  
CÍ_BadO±iÚ
;

1968 } ià(
şi
->
is_shÜt
 && !
şp
->
have_v®


1969 && 
şi
->
x‹xt
[
şp_utf8_ch¬Ën
(cli, cli->xtext)])

1972 
Ãxt_¬gum’t
(
şp
, 1);

1975 
şp
->
İtiÚ
 = 
İt
;

1976 ià(
şp
->
have_v®
) {

1977 
CÍ_V®Ty³
 *
©r
 = &
şi
->
v®ty³
[
vos
];

1978 ià(
©r
->
func
(
şp
, cÍ->
v¡r
, 
com¶aš
,‡Œ->
u£r_d©a
) <= 0) {

1980 
şp
->
have_v®
 = 0;

1981 ià(
com¶aš
) {

1982 
şp
->
İtiÚ
 = &
şp_İtiÚ_£Áš–
[-
CÍ_BadO±iÚ
];

1983  
CÍ_BadO±iÚ
;

1985 
CÍ_Re¡ÜeP¬£r
(
şp
, &
şp§ve
);

1986 
şp
->
İtiÚ
 = 
İt
;

1991  
İt
->
İtiÚ_id
;

2003 
CÍ_Shiá
(
CÍ_P¬£r
 *
şp
, 
®low_İtiÚs
)

2007 
CÍ_P¬£rS‹
 
şp§ve
;

2008 
CÍ_SaveP¬£r
(
şp
, &
şp§ve
);

2009 
Ãxt_¬gum’t
(
şp
, 
®low_İtiÚs
 ? 2 : 1);

2010 ià(!
şp
->
have_v®
)

2011 
CÍ_Re¡ÜeP¬£r
(
şp
, &
şp§ve
);

2012  
şp
->
v¡r
;

2020 
	sCÍ_BudSŒšg
 {

2021 * 
d©a
;

2022 * 
pos
;

2023 * 
’d_d©a
;

2024 
buf
[256];

2025 } 
	tCÍ_BudSŒšg
;

2027 
bud_¡ršg_´og¿m_´efix
(
CÍ_BudSŒšg
* 
bs
,

2028 cÚ¡ 
CÍ_P¬£r
* 
şp
);

2030 
bud_¡ršg_š™
(
CÍ_BudSŒšg
* 
bs
, 
CÍ_P¬£r
* 
şp
) {

2031 
bs
->
d©a
 = bs->
pos
 = bs->
buf
;

2032 
bs
->
’d_d©a
 = &bs->
buf
[(bs->buf)];

2033 ià(
şp
)

2034 
bud_¡ršg_´og¿m_´efix
(
bs
, 
şp
);

2037 
bud_¡ršg_ş—nup
(
CÍ_BudSŒšg
* 
bs
) {

2038 ià(
bs
->
d©a
 !ğbs->
buf
)

2039 
ä“
(
bs
->
d©a
);

2042 
bud_¡ršg_grow
(
CÍ_BudSŒšg
* 
bs
, 
size_t
 
wªt
) {

2043 
size_t
 
os
 = 
bs
->
pos
 - bs->
d©a
, 
nÿp
;

2044 ià(!
bs
->
pos
)

2046 
nÿp
 = (
bs
->
’d_d©a
 - bs->
d©a
è<< 1;‚ÿ°< 
wªt
;‚cap *= 2)

2048 ià(
bs
->
d©a
 =ğbs->
buf
) {

2049 ià((
bs
->
d©a
 = (*è
m®loc
(
nÿp
)))

2050 
memıy
(
bs
->
d©a
, bs->
buf
, bs->
pos
 - bs->buf);

2052 
bs
->
d©a
 = (*è
»®loc
(bs->d©a, 
nÿp
);

2053 ià(!
bs
->
d©a
) {

2054 
bs
->
pos
 = bs->
’d_d©a
 = bs->
d©a
;

2057 
bs
->
pos
 = bs->
d©a
 + 
os
;

2058 
bs
->
’d_d©a
 = bs->
d©a
 + 
nÿp
;

2063 
	#ENSURE_BUILD_STRING
(
bs
, 
¥aû
) \

2064 ((((
bs
)->
’d_d©a
 - (bs)->
pos
è>ğ(
¥aû
)) \

2065 || 
	`bud_¡ršg_grow
((
bs
), (bs)->
pos
 - (bs)->
d©a
 + (
¥aû
)))

	)

2068 
­³nd_bud_¡ršg
(
CÍ_BudSŒšg
 *
bs
, cÚ¡ *
s
, 
l
)

2070 ià(
l
 < 0)

2071 
l
 = 
¡¾’
(
s
);

2072 ià(
ENSURE_BUILD_STRING
(
bs
, 
l
)) {

2073 
memıy
(
bs
->
pos
, 
s
, 
l
);

2074 
bs
->
pos
 +ğ
l
;

2079 
bud_¡ršg_´og¿m_´efix
(
CÍ_BudSŒšg
* 
bs
, cÚ¡ 
CÍ_P¬£r
* 
şp
)

2081 cÚ¡ 
CÍ_IÁ”Çl
* 
şi
 = 
şp
->
š‹º®
;

2082 ià(
şi
->
´og¿m_Çme
 && cli->program_name[0]) {

2083 
­³nd_bud_¡ršg
(
bs
, 
şi
->
´og¿m_Çme
, -1);

2084 
­³nd_bud_¡ršg
(
bs
, ": ", 2);

2090 
CÍ_vb¥rštf
(
CÍ_P¬£r
 *
şp
, 
CÍ_BudSŒšg
 *
bs
,

2091 cÚ¡ *
fmt
, 
va_li¡
 
v®
)

2093 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

2094 cÚ¡ *
³rûÁ
;

2095 
c
;

2097 
³rûÁ
 = 
¡rchr
(
fmt
, '%');…ercent;…ercent = strchr(fmt, '%')) {

2098 
­³nd_bud_¡ršg
(
bs
, 
fmt
, 
³rûÁ
 - fmt);

2099 *++
³rûÁ
) {

2102 cÚ¡ *
s
 = 
va_¬g
(
v®
, const *);

2103 
­³nd_bud_¡ršg
(
bs
, 
s
 ? s : "(null)", -1);

2108 cÚ¡ *
s
 = 
va_¬g
(
v®
, const *);

2109 ià(
şi
->
utf8
)

2110 
c
 = 
decode_utf8
(
s
, 0);

2112 
c
 = (è*
s
;

2113 
ch¬_c
;

2117 
c
 = 
va_¬g
(
v®
, );

2118 
ch¬_c
;

2120 
ch¬_c
:

2121 ià(
ENSURE_BUILD_STRING
(
bs
, 4)) {

2122 ià(
c
 >= 32 && c <= 126)

2123 *
bs
->
pos
++ = 
c
;

2124 ià(
c
 < 32) {

2125 *
bs
->
pos
++ = '^';

2126 *
bs
->
pos
++ = 
c
 + 64;

2127 } ià(
şi
->
utf8
 && 
c
 >= 127 && c < 0x110000) {

2128 
bs
->
pos
 = 
’code_utf8
(bs->pos, 4, 
c
);

2129 } ià(
c
 >= 127 && c <= 255) {

2130 
¥rštf
(
bs
->
pos
, "\\%03o", 
c
 & 0xFF);

2131 
bs
->
pos
 += 4;

2133 *
bs
->
pos
++ = '\\';

2134 *
bs
->
pos
++ = '?';

2140 
d
 = 
va_¬g
(
v®
, );

2141 ià(
ENSURE_BUILD_STRING
(
bs
, 32)) {

2142 
¥rštf
(
bs
->
pos
, "%d", 
d
);

2143 
bs
->
pos
 = 
¡rchr
(bs->pos, 0);

2150 
İŠo
 = 
şi
->
cu¼’t_İtiÚ
;

2151 cÚ¡ 
CÍ_O±iÚ
 *
İt
 = &
şi
->İt[
İŠo
];

2152 ià(
İŠo
 < 0)

2153 
­³nd_bud_¡ršg
(
bs
, "(no current option!)", -1);

2154 ià(
şi
->
cu¼’t_shÜt
) {

2155 
­³nd_bud_¡ršg
(
bs
, 
şi
->
İtiÚ_ch¬s
, -1);

2156 ià(
ENSURE_BUILD_STRING
(
bs
, 5)) {

2157 ià(
şi
->
utf8
)

2158 
bs
->
pos
 = 
’code_utf8
(bs->pos, 5, 
İt
->
shÜt_Çme
);

2160 *
bs
->
pos
++ = 
İt
->
shÜt_Çme
;

2162 } ià(
şi
->
Ãg©ed_by_no
) {

2163 
­³nd_bud_¡ršg
(
bs
, 
şi
->
İtiÚ_ch¬s
, -1);

2164 
­³nd_bud_¡ršg
(
bs
, "no-", 3);

2165 
­³nd_bud_¡ršg
(
bs
, 
İt
->
lÚg_Çme
 + 
şi
->
iİt
[
İŠo
].
Úgoff
, -1);

2167 
­³nd_bud_¡ršg
(
bs
, 
şi
->
İtiÚ_ch¬s
, -1);

2168 
­³nd_bud_¡ršg
(
bs
, 
İt
->
lÚg_Çme
 + 
şi
->
iİt
[
İŠo
].
Úgoff
, -1);

2170 ià(
İŠo
 >ğ0 && 
şp
->
have_v®
 && *
³rûÁ
 == 'V') {

2171 ià(
şi
->
cu¼’t_shÜt
 && !şi->
iİt
[
İŠo
].
iİtiÚ®
)

2172 
­³nd_bud_¡ršg
(
bs
, " ", 1);

2173 ià(!
şi
->
cu¼’t_shÜt
)

2174 
­³nd_bud_¡ršg
(
bs
, "=", 1);

2175 
­³nd_bud_¡ršg
(
bs
, 
şp
->
v¡r
, -1);

2181 ià(
ENSURE_BUILD_STRING
(
bs
, 1))

2182 *
bs
->
pos
++ = '%';

2186 
­³nd_bud_¡ršg
(
bs
, (
şi
->
utf8
 ? "\342\200\230" : "'"), -1);

2191 
­³nd_bud_¡ršg
(
bs
, (
şi
->
utf8
 ? "\342\200\231" : "'"), -1);

2195 
­³nd_bud_¡ršg
(
bs
, "%", 1);

2196 
dÚe
;

2199 ià(
ENSURE_BUILD_STRING
(
bs
, 2)) {

2200 *
bs
->
pos
++ = '%';

2201 *
bs
->
pos
++ = *
³rûÁ
;

2206 
fmt
 = ++
³rûÁ
;

2209 
dÚe
:

2210 
­³nd_bud_¡ršg
(
bs
, 
fmt
, -1);

2213 cÚ¡ * 
bud_¡ršg_‹xt
(
CÍ_BudSŒšg
* 
bs
, 
»pÜt_oom
) {

2214 ià(
bs
->
pos
) {

2215 *
bs
->
pos
 = 0;

2216  
bs
->
d©a
;

2217 } ià(
»pÜt_oom
)

2220  
NULL
;

2224 
do_”rÜ
(
CÍ_P¬£r
 *
şp
, 
CÍ_BudSŒšg
 *
bs
)

2226 cÚ¡ *
‹xt
 = 
bud_¡ršg_‹xt
(
bs
, 1);

2227 ià(
şp
->
š‹º®
->
”rÜ_hªdËr
 != 0)

2228 (*
şp
->
š‹º®
->
”rÜ_hªdËr
)(şp, 
‹xt
);

2230 
åuts
(
‹xt
, 
¡d”r
);

2282 
CÍ_O±iÚE¼Ü
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
fÜm©
, ...)

2284 
CÍ_BudSŒšg
 
bs
;

2285 
va_li¡
 
v®
;

2286 
va_¡¬t
(
v®
, 
fÜm©
);

2287 
bud_¡ršg_š™
(&
bs
, 
şp
);

2288 
CÍ_vb¥rštf
(
şp
, &
bs
, 
fÜm©
, 
v®
);

2289 
­³nd_bud_¡ršg
(&
bs
, "\n", 1);

2290 
va_’d
(
v®
);

2291 
do_”rÜ
(
şp
, &
bs
);

2292 
bud_¡ršg_ş—nup
(&
bs
);

2293  
bs
.
pos
 - bs.
d©a
;

2306 
CÍ_årštf
(
CÍ_P¬£r
* 
şp
, 
FILE
* 
f
, cÚ¡ * 
fÜm©
, ...)

2308 
CÍ_BudSŒšg
 
bs
;

2309 
va_li¡
 
v®
;

2310 
va_¡¬t
(
v®
, 
fÜm©
);

2311 
bud_¡ršg_š™
(&
bs
, 
NULL
);

2312 
CÍ_vb¥rštf
(
şp
, &
bs
, 
fÜm©
, 
v®
);

2313 
va_’d
(
v®
);

2314 ià(
bs
.
pos
 !ğbs.
d©a
)

2315 
fwr™e
(
bs
.
d©a
, 1, bs.
pos
 - bs.d©a, 
f
);

2316 
bud_¡ršg_ş—nup
(&
bs
);

2317  
bs
.
pos
 - bs.
d©a
;

2331 
CÍ_vårštf
(
CÍ_P¬£r
* 
şp
, 
FILE
* 
f
, cÚ¡ * 
fÜm©
, 
va_li¡
 
v®
)

2333 
CÍ_BudSŒšg
 
bs
;

2334 
bud_¡ršg_š™
(&
bs
, 
NULL
);

2335 
CÍ_vb¥rštf
(
şp
, &
bs
, 
fÜm©
, 
v®
);

2336 ià(
bs
.
pos
 !ğbs.
d©a
)

2337 
fwr™e
(
bs
.
d©a
, 1, bs.
pos
 - bs.d©a, 
f
);

2338 
bud_¡ršg_ş—nup
(&
bs
);

2339  
bs
.
pos
 - bs.
d©a
;

2357 
CÍ_v¢´štf
(
CÍ_P¬£r
* 
şp
, * 
¡r
, 
size_t
 
size
,

2358 cÚ¡ * 
fÜm©
, 
va_li¡
 
v®
)

2360 
CÍ_BudSŒšg
 
bs
;

2361 
bud_¡ršg_š™
(&
bs
, 
NULL
);

2362 
CÍ_vb¥rštf
(
şp
, &
bs
, 
fÜm©
, 
v®
);

2363 ià((
size_t
è(
bs
.
pos
 - bs.
d©a
è< 
size
) {

2364 
memıy
(
¡r
, 
bs
.
d©a
, bs.
pos
 - bs.data);

2365 
¡r
[
bs
.
pos
 - bs.
d©a
] = 0;

2367 
memıy
(
¡r
, 
bs
.
d©a
, 
size
 - 1);

2368 
¡r
[
size
 - 1] = 0;

2370 
bud_¡ršg_ş—nup
(&
bs
);

2371  
bs
.
pos
 - bs.
d©a
;

2375 
ambigu™y_”rÜ
(
CÍ_P¬£r
 *
şp
, 
ambiguous
, *
ambiguous_v®ues
,

2376 cÚ¡ 
CÍ_O±iÚ
 *
İt
, cÚ¡ 
CÍ_IÁ”nO±iÚ
 *
iİt
,

2377 cÚ¡ *
´efix
, cÚ¡ *
fmt
, ...)

2379 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

2380 
CÍ_BudSŒšg
 
bs
;

2381 
i
;

2382 
va_li¡
 
v®
;

2384 
va_¡¬t
(
v®
, 
fmt
);

2385 
bud_¡ršg_š™
(&
bs
, 
şp
);

2386 
CÍ_vb¥rštf
(
şp
, &
bs
, 
fmt
, 
v®
);

2387 
­³nd_bud_¡ršg
(&
bs
, "\n", 1);

2389 
bud_¡ršg_´og¿m_´efix
(&
bs
, 
şp
);

2390 
­³nd_bud_¡ršg
(&
bs
, "(Possibilities‡re", -1);

2392 
i
 = 0; i < 
ambiguous
 && i < 
MAX_AMBIGUOUS_VALUES
; i++) {

2393 
v®ue
 = 
ambiguous_v®ues
[
i
];

2394 cÚ¡ *
no_dash
 = "";

2395 ià(
v®ue
 < 0)

2396 
v®ue
 = -(v®u+ 1), 
no_dash
 = "no-";

2397 ià(
i
 == 0)

2398 
­³nd_bud_¡ršg
(&
bs
, " ", 1);

2399 ià(
i
 =ğ
ambiguous
 - 1)

2400 
­³nd_bud_¡ršg
(&
bs
, (
i
 == 1 ? "‡nd " : ",‡nd "), -1);

2402 
­³nd_bud_¡ršg
(&
bs
, ", ", 2);

2403 
­³nd_bud_¡ršg
(&
bs
, (
şi
->
utf8
 ? "\342\200\230" : "'"), -1);

2404 
­³nd_bud_¡ršg
(&
bs
, 
´efix
, -1);

2405 
­³nd_bud_¡ršg
(&
bs
, 
no_dash
, -1);

2406 
­³nd_bud_¡ršg
(&
bs
, 
İt
[
v®ue
].
lÚg_Çme
 + 
iİt
[v®ue].
Úgoff
, -1);

2407 
­³nd_bud_¡ršg
(&
bs
, (
şi
->
utf8
 ? "\342\200\231" : "'"), -1);

2410 ià(
ambiguous
 > 
MAX_AMBIGUOUS_VALUES
)

2411 
­³nd_bud_¡ršg
(&
bs
, ",‡nd others", -1);

2412 
­³nd_bud_¡ršg
(&
bs
, ".)\n", -1);

2413 
va_’d
(
v®
);

2415 
do_”rÜ
(
şp
, &
bs
);

2416 
bud_¡ršg_ş—nup
(&
bs
);

2421 
cİy_¡ršg
(*
buf
, 
buæ’
, 
buåos
, cÚ¡ *
wh©
)

2423 
l
 = 
¡¾’
(
wh©
);

2424 ià(
l
 > 
buæ’
 - 
buåos
 - 1)

2425 
l
 = 
buæ’
 - 
buåos
 - 1;

2426 
memıy
(
buf
 + 
buåos
, 
wh©
, 
l
);

2427  
l
;

2443 
CÍ_CurO±iÚNameBuf
(
CÍ_P¬£r
 *
şp
, *
buf
, 
Ën
)

2445 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

2446 
İŠo
 = 
şi
->
cu¼’t_İtiÚ
;

2447 
pos
 = 0;

2448 ià(
İŠo
 < 0)

2449 
pos
 +ğ
cİy_¡ršg
(
buf
, 
Ën
,…os, "(no current option!)");

2450 ià(
şi
->
cu¼’t_shÜt
) {

2451 
pos
 +ğ
cİy_¡ršg
(
buf
, 
Ën
,…os, 
şi
->
İtiÚ_ch¬s
);

2452 ià(
şi
->
utf8
)

2453 
pos
 = (
’code_utf8
(
buf
 +…os, 
Ën
 -…o - 1, 
şi
->
İt
[
İŠo
].
shÜt_Çme
) - buf);

2454 ià(
pos
 < 
Ën
 - 1)

2455 
buf
[
pos
++] = 
şi
->
İt
[
İŠo
].
shÜt_Çme
;

2456 } ià(
şi
->
Ãg©ed_by_no
) {

2457 
pos
 +ğ
cİy_¡ršg
(
buf
, 
Ën
,…os, 
şi
->
İtiÚ_ch¬s
);

2458 
pos
 +ğ
cİy_¡ršg
(
buf
, 
Ën
,…os, "no-");

2459 
pos
 +ğ
cİy_¡ršg
(
buf
, 
Ën
,…os, 
şi
->
İt
[
İŠo
].
lÚg_Çme
 + cli->
iİt
[İŠo].
Úgoff
);

2461 
pos
 +ğ
cİy_¡ršg
(
buf
, 
Ën
,…os, 
şi
->
İtiÚ_ch¬s
);

2462 
pos
 +ğ
cİy_¡ršg
(
buf
, 
Ën
,…os, 
şi
->
İt
[
İŠo
].
lÚg_Çme
 + cli->
iİt
[İŠo].
Úgoff
);

2464 ià(
pos
 < 
Ën
)

2465 
buf
[
pos
] = 0;

2466  
pos
;

2481 
CÍ_CurO±iÚName
(
CÍ_P¬£r
 *
şp
)

2483 
buf
[256];

2484 
CÍ_CurO±iÚNameBuf
(
şp
, 
buf
, 256);

2485  
buf
;

2489 
CÍ_IsLÚg
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
lÚg_Çme
)

2491 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

2492 
İŠo
 = 
şi
->
cu¼’t_İtiÚ
;

2493  
İŠo
 >ğ0 && 
¡rcmp
(
şi
->
İt
[İŠo].
lÚg_Çme
,†ong_name) == 0;

2497 
CÍ_IsShÜt
(
CÍ_P¬£r
 *
şp
, 
shÜt_Çme
)

2499 
CÍ_IÁ”Çl
 *
şi
 = 
şp
->
š‹º®
;

2500 
İŠo
 = 
şi
->
cu¼’t_İtiÚ
;

2501  
İŠo
 >ğ0 && 
şi
->
İt
[İŠo].
shÜt_Çme
 == short_name;

2504 #ifdeà
__ılu¥lus


	@masstree-beta/clp.h

16 #iâdeà
LCDF_CLP_H


17 
	#LCDF_CLP_H


	)

18 #ifdeà
__ılu¥lus


42 
	~<¡dio.h
>

43 
	~<¡d¬g.h
>

45 
CÍ_O±iÚ
 
	tCÍ_O±iÚ
;

46 
CÍ_P¬£r
 
	tCÍ_P¬£r
;

47 
CÍ_P¬£rS‹
 
	tCÍ_P¬£rS‹
;

55 
	sCÍ_O±iÚ
 {

56 cÚ¡ *
lÚg_Çme
;

58 
shÜt_Çme
;

60 
İtiÚ_id
;

62 
v®_ty³
;

64 
æags
;

72 
	#CÍ_NoV®
 0

	)

73 
	#CÍ_V®SŒšg
 1

	)

75 
	#CÍ_V®SŒšgNÙO±iÚ
 2

	)

79 
	#CÍ_V®BoŞ
 3

	)

84 
	#CÍ_V®IÁ
 4

	)

91 
	#CÍ_V®UnsigÃd
 5

	)

98 
	#CÍ_V®LÚg
 6

	)

100 
	#CÍ_V®UnsigÃdLÚg
 7

	)

102 
	#CÍ_V®DoubË
 8

	)

105 
	#CÍ_V®Fœ¡U£r
 10

	)

113 
	#CÍ_Mªd©Üy
 (1<<0è

	)

119 
	#CÍ_O±iÚ®
 (1<<1è

	)

121 
	#CÍ_Neg©e
 (1<<2è

	)

125 
	#CÍ_OÆyNeg©ed
 (1<<3è

	)

131 
	#CÍ_P»ã¼edM©ch
 (1<<4è

	)

142 
	#CÍ_ShÜt
 (1<<0è

	)

144 
	#CÍ_LÚg
 (1<<1è

	)

146 
	#CÍ_ShÜtNeg©ed
 (1<<2è

	)

148 
	#CÍ_LÚgNeg©ed
 (1<<3è

	)

150 
	#CÍ_LÚgIm¶ic™
 (1<<4è

	)

155 
	#CÍ_NÙO±iÚ
 0

	)

157 
	#CÍ_DÚe
 -1

	)

159 
	#CÍ_BadO±iÚ
 -2

	)

161 
	#CÍ_E¼Ü
 -3

	)

164 
	#CÍ_V®Size
 40

	)

166 
	#CÍ_V®IÁSize
 10

	)

177 (*
CÍ_V®P¬£Func
)(
	tCÍ_P¬£r
 *
	tşp
, cÚ¡ *
	tv¡r
,

178 
	tcom¶aš
, *
	tu£r_d©a
);

184 (*
CÍ_E¼ÜHªdËr
)(
	tCÍ_P¬£r
 *
	tşp
, cÚ¡ *
	tmes§ge
);

192 
	sCÍ_P¬£r
 {

193 cÚ¡ 
CÍ_O±iÚ
 *
İtiÚ
;

195 
Ãg©ed
;

197 
have_v®
;

198 cÚ¡ *
v¡r
;

202 
i
;

203 
u
;

204 
l
;

205 
ul
;

206 
d
;

207 cÚ¡ *
s
;

208 *
pv
;

209 #ifdeà
HAVE_INT64_TYPES


210 
št64_t
 
i64
;

211 
ušt64_t
 
u64
;

213 
cs
[
CÍ_V®Size
];

214 
ucs
[
CÍ_V®Size
];

215 
is
[
CÍ_V®IÁSize
];

216 
us
[
CÍ_V®IÁSize
];

217 } 
v®
;

220 *
u£r_d©a
;

223 
CÍ_IÁ”Çl
 *
š‹º®
;

227 #ià
__GNUC__
 >= 4

228 
	#CLP_SENTINEL
 
	`__©Œibu‹__
((
£Áš–
))

	)

230 
	#CLP_SENTINEL


	)

236 
CÍ_P¬£r
 *
CÍ_NewP¬£r
(
¬gc
, cÚ¡ * cÚ¡ *
¬gv
,

237 
nİt
, cÚ¡ 
CÍ_O±iÚ
 *
İt
);

240 
CÍ_D–‘eP¬£r
(
CÍ_P¬£r
 *
şp
);

244 cÚ¡ *
CÍ_Prog¿mName
(
CÍ_P¬£r
 *
şp
);

247 cÚ¡ *
CÍ_S‘Prog¿mName
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
Çme
);

251 
CÍ_E¼ÜHªdËr
 
CÍ_S‘E¼ÜHªdËr
(
CÍ_P¬£r
 *
şp
, CÍ_E¼ÜHªdË¸
”rh
);

254 
CÍ_S‘UTF8
(
CÍ_P¬£r
 *
şp
, 
utf8
);

257 
CÍ_O±iÚCh¬
(
CÍ_P¬£r
 *
şp
, 
c
);

260 
CÍ_S‘O±iÚCh¬
(
CÍ_P¬£r
 *
şp
, 
c
, 
ty³
);

263 
CÍ_S‘O±iÚs
(
CÍ_P¬£r
 *
şp
, 
nİt
, cÚ¡ 
CÍ_O±iÚ
 *
İt
);

266 
CÍ_S‘Argum’ts
(
CÍ_P¬£r
 *
şp
, 
¬gc
, cÚ¡ * cÚ¡ *
¬gv
);

269 
CÍ_S‘O±iÚProûssšg
(
CÍ_P¬£r
 *
şp
, 
Ú
);

272 
	#CÍ_Di§ÎowO±iÚs
 (1<<0è

	)

278 
CÍ_AddTy³
(
CÍ_P¬£r
 *
şp
, 
v®_ty³
, 
æags
,

279 
CÍ_V®P¬£Func
 
·r£r
, *
u£r_d©a
);

282 
	#CÍ_AÎowNumb”s
 (1<<0è

	)

286 
	#CÍ_SŒšgLi¡LÚg
 (1<<1è

	)

290 
CÍ_AddSŒšgLi¡Ty³Vec
(
CÍ_P¬£r
 *
şp
, 
v®_ty³
, 
æags
,

291 
n¡rs
, cÚ¡ * cÚ¡ *
¡rs
,

292 cÚ¡ *
v®s
);

295 
CÍ_AddSŒšgLi¡Ty³
(
CÍ_P¬£r
 *
şp
, 
v®_ty³
, 
æags
, ...)

296 
CLP_SENTINEL
;

300 
CÍ_Next
(
CÍ_P¬£r
 *
şp
);

303 cÚ¡ *
CÍ_Shiá
(
CÍ_P¬£r
 *
şp
, 
®low_İtiÚs
);

307 
CÍ_P¬£rS‹
 *
CÍ_NewP¬£rS‹
();

310 
CÍ_D–‘eP¬£rS‹
(
CÍ_P¬£rS‹
 *
¡©e
);

313 
CÍ_SaveP¬£r
(cÚ¡ 
CÍ_P¬£r
 *
şp
, 
CÍ_P¬£rS‹
 *
¡©e
);

316 
CÍ_Re¡ÜeP¬£r
(
CÍ_P¬£r
 *
şp
, cÚ¡ 
CÍ_P¬£rS‹
 *
¡©e
);

320 
CÍ_O±iÚE¼Ü
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
fÜm©
, ...);

323 
CÍ_v¢´štf
(
CÍ_P¬£r
* 
şp
, * 
¡r
, 
size_t
 
size
,

324 cÚ¡ * 
fÜm©
, 
va_li¡
 
v®
);

327 
CÍ_årštf
(
CÍ_P¬£r
* 
şp
, 
FILE
* 
f
, cÚ¡ * 
fÜm©
, ...);

330 
CÍ_vårštf
(
CÍ_P¬£r
* 
şp
, 
FILE
* 
f
, cÚ¡ * 
fÜm©
, 
va_li¡
 
v®
);

333 
CÍ_CurO±iÚNameBuf
(
CÍ_P¬£r
 *
şp
, *
buf
, 
Ën
);

336 cÚ¡ *
CÍ_CurO±iÚName
(
CÍ_P¬£r
 *
şp
);

339 
CÍ_IsLÚg
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
lÚg_Çme
);

342 
CÍ_IsShÜt
(
CÍ_P¬£r
 *
şp
, 
shÜt_Çme
);

344 #undeà
CLP_SENTINEL


345 #ifdeà
__ılu¥lus


	@masstree-beta/compiler.cc

16 
	~"comp”.hh
"

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

20 
	$ç_®ways_as£¹
(cÚ¡ * 
fe
, 
lše
,

21 cÚ¡ * 
as£¹iÚ
, cÚ¡ * 
mes§ge
) {

22 ià(
mes§ge
)

23 
	`årštf
(
¡d”r
, "assertion \"%s\" [%s] failed: file \"%s\",†ine %d\n",

24 
mes§ge
, 
as£¹iÚ
, 
fe
, 
lše
);

26 
	`årštf
(
¡d”r
, "assertion \"%s\" failed: file \"%s\",†ine %d\n",

27 
as£¹iÚ
, 
fe
, 
lše
);

28 
	`abÜt
();

29 
	}
}

31 
	$ç_mas¡»e_šv¬ŸÁ
(cÚ¡ * 
fe
, 
lše
,

32 cÚ¡ * 
as£¹iÚ
, cÚ¡ * 
mes§ge
) {

33 ià(
mes§ge
)

34 
	`årštf
(
¡d”r
, "invariant \"%s\" [%s] failed: file \"%s\",†ine %d\n",

35 
mes§ge
, 
as£¹iÚ
, 
fe
, 
lše
);

37 
	`årštf
(
¡d”r
, "invariant \"%s\" failed: file \"%s\",†ine %d\n",

38 
as£¹iÚ
, 
fe
, 
lše
);

39 
	`abÜt
();

40 
	}
}

42 
	$ç_mas¡»e_´ecÚd™iÚ
(cÚ¡ * 
fe
, 
lše
,

43 cÚ¡ * 
as£¹iÚ
, cÚ¡ * 
mes§ge
) {

44 ià(
mes§ge
)

45 
	`årštf
(
¡d”r
, "precondition \"%s\" [%s] failed: file \"%s\",†ine %d\n",

46 
mes§ge
, 
as£¹iÚ
, 
fe
, 
lše
);

48 
	`årštf
(
¡d”r
, "precondition \"%s\" failed: file \"%s\",†ine %d\n",

49 
as£¹iÚ
, 
fe
, 
lše
);

50 
	`abÜt
();

51 
	}
}

	@masstree-beta/compiler.hh

16 #iâdeà
MASSTREE_COMPILER_HH


17 
	#MASSTREE_COMPILER_HH
 1

	)

19 
	~"cÚfig.h
"

21 
	~<¡dšt.h
>

22 
	#__STDC_FORMAT_MACROS


	)

23 
	~<š‰y³s.h
>

24 
	~<¬·/š‘.h
>

25 #ià
HAVE_TYPE_TRAITS


26 
	~<ty³_Œa™s
>

29 
	#¬¿ysize
(
a
è(×è/ (×)[0]))

	)

31 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

32 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

34 #ià!
HAVE_CXX_STATIC_ASSERT


35 
	#¡©ic_as£¹
(
x
, 
msg
èxè0: !!(x):

	)

38 #ià!
HAVE_CXX_CONSTEXPR


39 
	#cÚ¡ex´
 cÚ¡

	)

42 #ià
HAVE_OFF_T_IS_LONG_LONG


43 
	#PRIdOFF_T
 "Îd"

	)

45 
	#PRIdOFF_T
 "ld"

	)

48 #ià
HAVE_SIZE_T_IS_UNSIGNED_LONG_LONG


49 
	#PRIdSIZE_T
 "Îu"

	)

50 
	#PRIdSSIZE_T
 "Îd"

	)

51 #–ià
HAVE_SIZE_T_IS_UNSIGNED_LONG


52 
	#PRIdSIZE_T
 "lu"

	)

53 
	#PRIdSSIZE_T
 "ld"

	)

55 
	#PRIdSIZE_T
 "u"

	)

56 
	#PRIdSSIZE_T
 "d"

	)

59 #ià(
__i386__
 || 
__x86_64__
è&& !
defšed
(
__x86__
)

60 
	#__x86__
 1

	)

62 
	#PREFER_X86
 1

	)

63 
	#ALLOW___SYNC_BUILTINS
 1

	)

65 #ià!
defšed
(
HAVE_INDIFFERENT_ALIGMENT
è&& (
__i386__
 || 
__x86_64__
 || 
__¬ch_um__
)

66 
	#HAVE_INDIFFERENT_ALIGNMENT
 1

	)

74 
šlše
 
	$ffs_msb
(
x
) {

75  (
x
 ? 
	`__butš_şz
(x) + 1 : 0);

76 
	}
}

78 
šlše
 
	$ffs_msb
(
x
) {

79  (
x
 ? 
	`__butš_şzl
(x) + 1 : 0);

80 
	}
}

82 
šlše
 
	$ffs_msb
(
x
) {

83  (
x
 ? 
	`__butš_şzÎ
(x) + 1 : 0);

84 
	}
}

91 
šlše
 
	$ãnû
() {

92 
asm
 volatile("" : : : "memory");

93 
	}
}

96 
šlše
 
	$acquœe_ãnû
() {

97 
asm
 volatile("" : : : "memory");

98 
	}
}

101 
šlše
 
	$»Ëa£_ãnû
() {

102 
asm
 volatile("" : : : "memory");

103 
	}
}

108 
šlše
 
	$»Ïx_ãnû
() {

109 
asm
 volatile("pause" : : : "memory");

110 
	}
}

113 
šlše
 
	$memÜy_ãnû
() {

114 
asm
 volatile("mfence" : : : "memory");

115 
	}
}

118 
	sdo_nÙhšg
 {

119 
İ”©Ü
()() const {

121 
	m‹m¶©e
 <
ty³Çme
 
	mT
>

122 
İ”©Ü
()(cÚ¡ 
	mT
&) const {

124 
	m‹m¶©e
 <
ty³Çme
 
	mT
,y³Çm
	mU
>

125 
İ”©Ü
()(cÚ¡ 
	mT
&, cÚ¡ 
	mU
&) const {

130 
	sãnû_funùiÚ
 {

131 
İ”©Ü
()() const {

132 
ãnû
();

137 
	s»Ïx_ãnû_funùiÚ
 {

138 
İ”©Ü
()() const {

139 
»Ïx_ãnû
();

144 
	sbackoff_ãnû_funùiÚ
 {

145 
backoff_ãnû_funùiÚ
()

146 : 
couÁ_
(0) {

148 
İ”©Ü
()() {

149 
i
 = 
couÁ_
; 
	mi
 >= 0; --i)

150 
»Ïx_ãnû
();

151 
	mcouÁ_
 = ((
couÁ_
 << 1) | 1) & 15;

153 
	m´iv©e
:

154 
couÁ_
;

158 
	g‹m¶©e
 <
	gSIZE
, 
ty³Çme
 
	gBARRIER
> 
	gsized_comp”_İ”©iÚs
;

160 
	g‹m¶©e
 <
ty³Çme
 
	gB
> 
	gsized_comp”_İ”©iÚs
<1, B> {

161 
	tty³
;

162 
šlše
 
ty³
 
xchg
Ñy³* 
objeù
,y³ 
Ãw_v®ue
) {

163 
asm
 volatile("xchgb %0,%1"

164 : "+q" (
Ãw_v®ue
), "+m" (*
	gobjeù
));

165 
B
()();

166  
	gÃw_v®ue
;

168 
šlše
 
ty³
 
v®_cmpxchg
Ñy³* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

169 #ià
__x86__
 && (
PREFER_X86
 || !
HAVE___SYNC_VAL_COMPARE_AND_SWAP
)

170 
asm
 volatile("lock; cmpxchgb %2,%1"

171 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
)

172 : "r" (
desœed
) : "cc");

173 
B
()();

174  
	gex³ùed
;

176  
__sync_v®_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

179 
šlše
 
boŞ
 
boŞ_cmpxchg
(
ty³
* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

180 #ià
HAVE___SYNC_BOOL_COMPARE_AND_SWAP
 && 
ALLOW___SYNC_BUILTINS


181  
__sync_boŞ_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

183 
boŞ
 
	g»suÉ
;

184 
asm
 volatile("lock; cmpxchgb %3,%1; sete %b2"

185 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
), "=q" (
	g»suÉ
)

186 : "q" (
desœed
) : "cc");

187 
B
()();

188  
	g»suÉ
;

191 
šlše
 
ty³
 
ãtch_ªd_add
Ñy³ *
objeù
,y³ 
add’d
) {

192 #ià
__x86__
 && (
PREFER_X86
 || !
HAVE___SYNC_FETCH_AND_ADD
)

193 
asm
 volatile("lock; xaddb %0,%1"

194 : "+q" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

195 
B
()();

196  
	gadd’d
;

198  
__sync_ãtch_ªd_add
(
objeù
, 
add’d
);

201 
šlše
 
©omic_Ü
(
ty³
* 
objeù
,y³ 
add’d
) {

202 #ià
__x86__


203 
asm
 volatile("lock; orb %0,%1"

204 : "ô" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

205 
B
()();

207 
__sync_ãtch_ªd_Ü
(
objeù
, 
add’d
);

212 
	g‹m¶©e
 <
ty³Çme
 
	gB
> 
	gsized_comp”_İ”©iÚs
<2, B> {

213 #ià
SIZEOF_SHORT
 == 2

214 
	tty³
;

216 
št16_t
 
	tty³
;

218 
šlše
 
ty³
 
xchg
Ñy³* 
objeù
,y³ 
Ãw_v®ue
) {

219 
asm
 volatile("xchgw %0,%1"

220 : "+r" (
Ãw_v®ue
), "+m" (*
	gobjeù
));

221 
B
()();

222  
	gÃw_v®ue
;

224 
šlše
 
ty³
 
v®_cmpxchg
Ñy³* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

225 #ià
__x86__
 && (
PREFER_X86
 || !
HAVE___SYNC_VAL_COMPARE_AND_SWAP
)

226 
asm
 volatile("lock; cmpxchgw %2,%1"

227 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
)

228 : "r" (
desœed
) : "cc");

229 
B
()();

230  
	gex³ùed
;

232  
__sync_v®_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

235 
šlše
 
boŞ
 
boŞ_cmpxchg
(
ty³
* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

236 #ià
HAVE___SYNC_BOOL_COMPARE_AND_SWAP
 && 
ALLOW___SYNC_BUILTINS


237  
__sync_boŞ_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

239 
boŞ
 
	g»suÉ
;

240 
asm
 volatile("lock; cmpxchgw %3,%1; sete %b2"

241 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
), "=q" (
	g»suÉ
)

242 : "r" (
desœed
) : "cc");

243 
B
()();

244  
	g»suÉ
;

247 
šlše
 
ty³
 
ãtch_ªd_add
Ñy³* 
objeù
,y³ 
add’d
) {

248 #ià
__x86__
 && (
PREFER_X86
 || !
HAVE___SYNC_FETCH_AND_ADD
)

249 
asm
 volatile("lock; xaddw %0,%1"

250 : "+r" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

251 
B
()();

252  
	gadd’d
;

254  
__sync_ãtch_ªd_add
(
objeù
, 
add’d
);

257 
šlše
 
©omic_Ü
(
ty³
* 
objeù
,y³ 
add’d
) {

258 #ià
__x86__


259 
asm
 volatile("lock; orw %0,%1"

260 : "ô" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

261 
B
()();

263 
__sync_ãtch_ªd_Ü
(
objeù
, 
add’d
);

268 
	g‹m¶©e
 <
ty³Çme
 
	gB
> 
	gsized_comp”_İ”©iÚs
<4, B> {

269 #ià
SIZEOF_INT
 == 4

270 
	tty³
;

272 
št32_t
 
	tty³
;

274 
šlše
 
ty³
 
xchg
Ñy³* 
objeù
,y³ 
Ãw_v®ue
) {

275 
asm
 volatile("xchgl %0,%1"

276 : "+r" (
Ãw_v®ue
), "+m" (*
	gobjeù
));

277 
B
()();

278  
	gÃw_v®ue
;

280 
šlše
 
ty³
 
v®_cmpxchg
Ñy³* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

281 #ià
__x86__
 && (
PREFER_X86
 || !
HAVE___SYNC_VAL_COMPARE_AND_SWAP
)

282 
asm
 volatile("lock; cmpxchgl %2,%1"

283 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
)

284 : "r" (
desœed
) : "cc");

285 
B
()();

286  
	gex³ùed
;

288  
__sync_v®_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

291 
šlše
 
boŞ
 
boŞ_cmpxchg
(
ty³
* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

292 #ià
HAVE___SYNC_BOOL_COMPARE_AND_SWAP
 && 
ALLOW___SYNC_BUILTINS


293  
__sync_boŞ_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

295 
boŞ
 
	g»suÉ
;

296 
asm
 volatile("lock; cmpxchgl %3,%1; sete %b2"

297 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
), "=q" (
	g»suÉ
)

298 : "r" (
desœed
) : "cc");

299 
B
()();

300  
	g»suÉ
;

303 
šlše
 
ty³
 
ãtch_ªd_add
Ñy³ *
objeù
,y³ 
add’d
) {

304 #ià
__x86__
 && (
PREFER_X86
 || !
HAVE___SYNC_FETCH_AND_ADD
)

305 
asm
 volatile("lock; xaddl %0,%1"

306 : "+r" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

307 
B
()();

308  
	gadd’d
;

310  
__sync_ãtch_ªd_add
(
objeù
, 
add’d
);

313 
šlše
 
©omic_Ü
(
ty³
* 
objeù
,y³ 
add’d
) {

314 #ià
__x86__


315 
asm
 volatile("lock; orl %0,%1"

316 : "ô" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

317 
B
()();

319 
__sync_ãtch_ªd_Ü
(
objeù
, 
add’d
);

324 
	g‹m¶©e
 <
ty³Çme
 
	gB
> 
	gsized_comp”_İ”©iÚs
<8, B> {

325 #ià
SIZEOF_LONG_LONG
 == 8

326 
	tty³
;

327 #–ià
SIZEOF_LONG
 == 8

328 
	tty³
;

330 
št64_t
 
	tty³
;

332 #ià
__x86_64__


333 
šlše
 
ty³
 
xchg
Ñy³* 
objeù
,y³ 
Ãw_v®ue
) {

334 
asm
 volatile("xchgq %0,%1"

335 : "+r" (
Ãw_v®ue
), "+m" (*
	gobjeù
));

336 
B
()();

337  
	gÃw_v®ue
;

340 
šlše
 
ty³
 
v®_cmpxchg
Ñy³* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

341 #ià
__x86_64__
 && (
PREFER_X86
 || !
HAVE___SYNC_VAL_COMPARE_AND_SWAP_8
)

342 
asm
 volatile("lock; cmpxchgq %2,%1"

343 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
)

344 : "r" (
desœed
) : "cc");

345 
B
()();

346  
	gex³ùed
;

347 #–ià
__i386__
 && (
PREFER_X86
 || !
HAVE___SYNC_VAL_COMPARE_AND_SWAP_8
)

348 
ušt32_t
 
ex³ùed_low
(
ex³ùed
), 
ex³ùed_high
(expected >> 32),

349 
desœed_low
(
desœed
), 
desœed_high
(desired >> 32);

350 
asm
 volatile("lock; cmpxchg8b %2"

351 : "+a" (
ex³ùed_low
), "+d" (
	gex³ùed_high
), "+m" (*
	gobjeù
)

352 : "b" (
desœed_low
), "c" (
	gdesœed_high
) : "cc");

353 
B
()();

354  ((
	gušt64_t
è
	gex³ùed_high
 << 32è| 
	gex³ùed_low
;

355 #–ià
HAVE___SYNC_VAL_COMPARE_AND_SWAP_8


356  
__sync_v®_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

359 
šlše
 
boŞ
 
boŞ_cmpxchg
(
ty³
* 
objeù
,y³ 
ex³ùed
,y³ 
desœed
) {

360 #ià
HAVE___SYNC_BOOL_COMPARE_AND_SWAP_8
 && 
ALLOW___SYNC_BUILTINS


361  
__sync_boŞ_com·»_ªd_sw­
(
objeù
, 
ex³ùed
, 
desœed
);

362 #–ià
__x86_64__


363 
boŞ
 
	g»suÉ
;

364 
asm
 volatile("lock; cmpxchgq %3,%1; sete %b2"

365 : "+a" (
ex³ùed
), "+m" (*
	gobjeù
), "=q" (
	g»suÉ
)

366 : "r" (
desœed
) : "cc");

367 
B
()();

368  
	g»suÉ
;

370 
ušt32_t
 
ex³ùed_low
(
ex³ùed
), 
ex³ùed_high
(expected >> 32),

371 
desœed_low
(
desœed
), 
desœed_high
(desired >> 32);

372 
boŞ
 
	g»suÉ
;

373 
asm
 volatile("lock; cmpxchg8b %2; sete %b4"

374 : "+a" (
ex³ùed_low
), "+d" (
	gex³ùed_high
),

375 "+m" (*
	gobjeù
), "=q" (
	g»suÉ
)

376 : "b" (
desœed_low
), "c" (
	gdesœed_high
) : "cc");

377 
B
()();

378  
	g»suÉ
;

381 #ià
__x86_64__
 || 
HAVE___SYNC_FETCH_AND_ADD_8


382 
šlše
 
ty³
 
ãtch_ªd_add
Ñy³* 
objeù
,y³ 
add’d
) {

383 #ià
__x86_64__
 && (
PREFER_X86
 || !
HAVE___SYNC_FETCH_AND_ADD_8
)

384 
asm
 volatile("lock; xaddq %0,%1"

385 : "+r" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

386 
B
()();

387  
	gadd’d
;

389  
__sync_ãtch_ªd_add
(
objeù
, 
add’d
);

393 #ià
__x86_64__
 || 
HAVE___SYNC_FETCH_AND_OR_8


394 
šlše
 
©omic_Ü
(
ty³
* 
objeù
,y³ 
add’d
) {

395 #ià
__x86_64__


396 
asm
 volatile("lock; orq %0,%1"

397 : "ô" (
add’d
), "+m" (*
	gobjeù
) : : "cc");

398 
B
()();

400 
__sync_ãtch_ªd_Ü
(
objeù
, 
add’d
);

406 
	g‹m¶©e
<
ty³Çme
 
	gT
>

407 
šlše
 
T
 
	$xchg
(
T
* 
objeù
, T 
Ãw_v®ue
) {

408 
sized_comp”_İ”©iÚs
<(
	tT
), 
	tãnû_funùiÚ
> 
	tsco_t
;

409 
ty³Çme
 
	tsco_t
::
	tty³
ype;

410  (
T
è
sco_t
::
	`xchg
((
ty³
*è
objeù
, (ty³è
Ãw_v®ue
);

411 
	}
}

413 
šlše
 
št8_t
 
	$xchg
(
št8_t
* 
objeù
, 
Ãw_v®ue
) {

414  
	`xchg
(
objeù
, (
št8_t
è
Ãw_v®ue
);

415 
	}
}

416 
šlše
 
ušt8_t
 
	$xchg
(
ušt8_t
* 
objeù
, 
Ãw_v®ue
) {

417  
	`xchg
(
objeù
, (
ušt8_t
è
Ãw_v®ue
);

418 
	}
}

419 
šlše
 
št16_t
 
	$xchg
(
št16_t
* 
objeù
, 
Ãw_v®ue
) {

420  
	`xchg
(
objeù
, (
št16_t
è
Ãw_v®ue
);

421 
	}
}

422 
šlše
 
ušt16_t
 
	$xchg
(
ušt16_t
* 
objeù
, 
Ãw_v®ue
) {

423  
	`xchg
(
objeù
, (
ušt16_t
è
Ãw_v®ue
);

424 
	}
}

425 
šlše
 
	$xchg
(* 
objeù
, 
Ãw_v®ue
) {

426  
	`xchg
(
objeù
, (è
Ãw_v®ue
);

427 
	}
}

442 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

443 
šlše
 
T
 
	$cmpxchg
(
T
* 
objeù
, T 
ex³ùed
, T 
desœed
) {

444 
sized_comp”_İ”©iÚs
<(
	tT
), 
	tãnû_funùiÚ
> 
	tsco_t
;

445 
ty³Çme
 
	tsco_t
::
	tty³
ype;

446  (
T
è
sco_t
::
	`v®_cmpxchg
((
ty³
*è
objeù
, (ty³è
ex³ùed
, (ty³è
desœed
);

447 
	}
}

449 
šlše
 
	$cmpxchg
(*
objeù
, 
ex³ùed
, 
desœed
) {

450  
	`cmpxchg
(
objeù
, (
ex³ùed
), (
desœed
));

451 
	}
}

468 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

469 
šlše
 
boŞ
 
	$boŞ_cmpxchg
(
T
* 
objeù
, T 
ex³ùed
, T 
desœed
) {

470 
sized_comp”_İ”©iÚs
<(
	tT
), 
	tãnû_funùiÚ
> 
	tsco_t
;

471 
ty³Çme
 
	tsco_t
::
	tty³
ype;

472  
sco_t
::
	`boŞ_cmpxchg
((
ty³
*è
objeù
, (ty³è
ex³ùed
, (ty³è
desœed
);

473 
	}
}

475 
šlše
 
boŞ
 
	$boŞ_cmpxchg
(
ušt8_t
* 
objeù
, 
ex³ùed
, 
desœed
) {

476  
	`boŞ_cmpxchg
(
objeù
, 
	`ušt8_t
(
ex³ùed
), ušt8_t(
desœed
));

477 
	}
}

478 
šlše
 
boŞ
 
	$boŞ_cmpxchg
(*
objeù
, 
ex³ùed
, 
desœed
) {

479  
	`boŞ_cmpxchg
(
objeù
, (
ex³ùed
), (
desœed
));

480 
	}
}

486 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

487 
šlše
 
T
 
	$ãtch_ªd_add
(
T
* 
objeù
, T 
add’d
) {

488 
sized_comp”_İ”©iÚs
<(
	tT
), 
	tãnû_funùiÚ
> 
	tsco_t
;

489 
ty³Çme
 
	tsco_t
::
	tty³
ype;

490  (
T
è
sco_t
::
	`ãtch_ªd_add
((
ty³
*è
objeù
, (ty³è
add’d
);

491 
	}
}

493 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

494 
šlše
 
T
* 
	$ãtch_ªd_add
(
T
** 
objeù
, 
add’d
) {

495 
sized_comp”_İ”©iÚs
<(
	tT
*), 
	tãnû_funùiÚ
> 
	tsco_t
;

496 
ty³Çme
 
	tsco_t
::
	tty³
ype;

497  (
T
*è
sco_t
::
	`ãtch_ªd_add
((
ty³
*è
objeù
, (ty³è(
add’d
 * (T)));

498 
	}
}

500 
šlše
 
	$ãtch_ªd_add
(* 
objeù
, 
add’d
) {

501  
	`ãtch_ªd_add
(
objeù
, (è
add’d
);

502 
	}
}

503 
šlše
 sigÃd 
	$ãtch_ªd_add
(sigÃd * 
objeù
, 
add’d
) {

504  
	`ãtch_ªd_add
(
objeù
, (sigÃd è
add’d
);

505 
	}
}

506 
šlše
 
	$ãtch_ªd_add
(* 
objeù
, 
add’d
) {

507  
	`ãtch_ªd_add
(
objeù
, (è
add’d
);

508 
	}
}

509 
šlše
 
	$ãtch_ªd_add
(* 
objeù
, 
add’d
) {

510  
	`ãtch_ªd_add
(
objeù
, (è
add’d
);

511 
	}
}

512 
šlše
 
	$ãtch_ªd_add
(* 
objeù
, 
add’d
) {

513  
	`ãtch_ªd_add
(
objeù
, (è
add’d
);

514 
	}
}

515 
šlše
 
	$ãtch_ªd_add
(* 
objeù
, 
add’d
) {

516  
	`ãtch_ªd_add
(
objeù
, (è
add’d
);

517 
	}
}

518 
šlše
 
	$ãtch_ªd_add
(* 
objeù
, 
add’d
) {

519  
	`ãtch_ªd_add
(
objeù
, (è
add’d
);

520 
	}
}

521 
šlše
 
	$ãtch_ªd_add
(* 
objeù
, 
add’d
) {

522  
	`ãtch_ªd_add
(
objeù
, (è
add’d
);

523 
	}
}

524 #ià
SIZEOF_LONG_LONG
 <= 8

525 
šlše
 
	$ãtch_ªd_add
(* 
objeù
, 
add’d
) {

526  
	`ãtch_ªd_add
(
objeù
, (è
add’d
);

527 
	}
}

528 
šlše
 
	$ãtch_ªd_add
(* 
objeù
, 
add’d
) {

529  
	`ãtch_ªd_add
(
objeù
, (è
add’d
);

530 
	}
}

535 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

536 
šlše
 
	$‹¡_ªd_£t_acquœe
(
T
* 
objeù
) {

537 
sized_comp”_İ”©iÚs
<(
	tT
), 
	tdo_nÙhšg
> 
	tsco_t
;

538 
ty³Çme
 
	tsco_t
::
	tty³
ype;

539 
sco_t
::
	`xchg
((
ty³
*è
objeù
, (type) 1))

540 
	`»Ïx_ãnû
();

541 
	`acquœe_ãnû
();

542 
	}
}

545 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

546 
šlše
 
	$‹¡_ªd_£t_»Ëa£
(
T
* 
objeù
) {

547 
	`»Ëa£_ãnû
();

548 *
objeù
 = 
	`T
();

549 
	}
}

555 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

556 
šlše
 
	$©omic_Ü
(
T
* 
objeù
, T 
add’d
) {

557 
sized_comp”_İ”©iÚs
<(
	tT
), 
	tãnû_funùiÚ
> 
	tsco_t
;

558 
ty³Çme
 
	tsco_t
::
	tty³
ype;

559 
sco_t
::
	`©omic_Ü
((
ty³
*è
objeù
, (ty³è
add’d
);

560 
	}
}

562 
šlše
 
	$©omic_Ü
(
št8_t
* 
objeù
, 
add’d
) {

563 
	`©omic_Ü
(
objeù
, 
	`št8_t
(
add’d
));

564 
	}
}

565 
šlše
 
	$©omic_Ü
(
ušt8_t
* 
objeù
, 
add’d
) {

566 
	`©omic_Ü
(
objeù
, 
	`ušt8_t
(
add’d
));

567 
	}
}

568 
šlše
 
	$©omic_Ü
(
št16_t
* 
objeù
, 
add’d
) {

569 
	`©omic_Ü
(
objeù
, 
	`št16_t
(
add’d
));

570 
	}
}

571 
šlše
 
	$©omic_Ü
(
ušt16_t
* 
objeù
, 
add’d
) {

572 
	`©omic_Ü
(
objeù
, 
	`ušt16_t
(
add’d
));

573 
	}
}

574 
šlše
 
	$©omic_Ü
(* 
objeù
, 
add’d
) {

575 
	`©omic_Ü
(
objeù
, (
add’d
));

576 
	}
}

577 
šlše
 
	$©omic_Ü
(* 
objeù
, 
add’d
) {

578 
	`©omic_Ü
(
objeù
, ()(
add’d
));

579 
	}
}

583 #ià!
PREFETCH_DEFINED


584 
šlše
 
	$´eãtch
(cÚ¡ *
±r
) {

585 #ifdeà
NOPREFETCH


586 (è
±r
;

588 ¡ruù { 
x
[
CACHE_LINE_SIZE
]; } 
	tÿch–še_t
;

589 
asm
 vŞ©e("´eãtcht0 %0" : : "m" (*(cÚ¡ 
ÿch–še_t
 *)
±r
));

591 
	}
}

594 
šlše
 
	$´eãtchÁa
(cÚ¡ *
±r
) {

595 #ifdeà
NOPREFETCH


596 (è
±r
;

598 ¡ruù { 
x
[
CACHE_LINE_SIZE
]; } 
	tÿch–še_t
;

599 
asm
 vŞ©e("´eãtchÁ¨%0" : : "m" (*(cÚ¡ 
ÿch–še_t
 *)
±r
));

601 
	}
}

604 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

605 
	sv®ue_´eãtch”
 {

606 
İ”©Ü
()(
	mT
) {

610 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

611 
	gv®ue_´eãtch”
<
	gT
 *> {

612 
İ”©Ü
()(
T
 *
	gp
) {

613 
´eãtch
((cÚ¡ *è
p
);

619 
šlše
 
ušt64_t
 
	$Áohq
(
ušt64_t
 
v®
) {

620 #ifdeà
__i386__


623 
ušt32_t
 
a
;

624 
ušt32_t
 
b
;

625 } 
s
;

626 
ušt64_t
 
u
;

627 } 
v
;

628 
v
.
u
 = 
v®
;

629 
	`asm
("bswapl %0; bswapl %1; xchgl %0,%1"

630 : "+r" (
v
.
s
.
a
), "+r" (v.s.
b
));

631  
v
.
u
;

633 
	`asm
("bsw­q %0" : "+r" (
v®
));

634  
v®
;

636 
	}
}

638 
šlše
 
ušt64_t
 
	$htÚq
(
ušt64_t
 
v®
) {

639  
	`Áohq
(
v®
);

640 
	}
}

649 #ià
HAVE___BUILTIN_CLZ


650 
šlše
 
	$şz
(
x
) {

651  
	`__butš_şz
(
x
);

652 
	}
}

653 
šlše
 
	$şz
(
x
) {

654  
	`__butš_şz
(
x
);

655 
	}
}

658 #ià
HAVE___BUILTIN_CLZL


659 
šlše
 
	$şz
(
x
) {

660  
	`__butš_şzl
(
x
);

661 
	}
}

662 
šlše
 
	$şz
(
x
) {

663  
	`__butš_şzl
(
x
);

664 
	}
}

667 #ià
HAVE___BUILTIN_CLZLL


668 
šlše
 
	$şz
(
x
) {

669  
	`__butš_şzÎ
(
x
);

670 
	}
}

671 
šlše
 
	$şz
(
x
) {

672  
	`__butš_şzÎ
(
x
);

673 
	}
}

680 #ià
HAVE___BUILTIN_CTZ


681 
šlše
 
	$ùz
(
x
) {

682  
	`__butš_ùz
(
x
);

683 
	}
}

684 
šlše
 
	$ùz
(
x
) {

685  
	`__butš_ùz
(
x
);

686 
	}
}

689 #ià
HAVE___BUILTIN_CTZL


690 
šlše
 
	$ùz
(
x
) {

691  
	`__butš_ùzl
(
x
);

692 
	}
}

693 
šlše
 
	$ùz
(
x
) {

694  
	`__butš_ùzl
(
x
);

695 
	}
}

698 #ià
HAVE___BUILTIN_CTZLL


699 
šlše
 
	$ùz
(
x
) {

700  
	`__butš_ùzÎ
(
x
);

701 
	}
}

702 
šlše
 
	$ùz
(
x
) {

703  
	`__butš_ùzÎ
(
x
);

704 
	}
}

707 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

708 
šlše
 
T
 
	$iû
(
T
 
x
, 
U
 
y
) {

709 
U
 
mod
 = 
x
 % 
y
;

710  
x
 + (
mod
 ? 
y
 - mod : 0);

711 
	}
}

717 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

718 
šlše
 
T
 
	$iû_log2
(
T
 
x
) {

719  
	`T
(1è<< ((
T
è* 8 - 
	`şz
(
x
) - !(x & (x - 1)));

720 
	}
}

724 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

725 
šlše
 
T
 
	$iæoÜ_log2
(
T
 
x
) {

726  
	`T
(1è<< ((
T
è* 8 - 1 - 
	`şz
(
x
));

727 
	}
}

732 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

733 
šlše
 
	$fšd_lowe¡_z”o_nibbË
(
T
 
x
) {

734 
	`¡©ic_as£¹
((
T
) <= (), "T isoo big");

735 #ià
SIZEOF_LONG_LONG
 == 16

736 
T
 
h
 = 
	`T
(0x88888888888888888888888888888888ULL), 
l
 = T(0x11111111111111111111111111111111ULL);

738 
T
 
h
 = 
	`T
(0x8888888888888888ULL), 
l
 = T(0x1111111111111111ULL);

740 
T
 
t
 = 
h
 & (
x
 - 
l
) & ~x;

741  
t
 ? 
	`ùz
(t) >> 2 : -1;

742 
	}
}

749 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

750  
x
;

751 
	}
}

753 
šlše
 sigÃd 
	$ho¡_to_Ãt_Üd”
(sigÃd 
x
) {

754  
x
;

755 
	}
}

757 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

758  
x
;

759 
	}
}

761 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

762  
	`htÚs
(
x
);

763 
	}
}

765 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

766  
	`htÚs
(
x
);

767 
	}
}

769 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

770  
	`htÚl
(
x
);

771 
	}
}

773 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

774  
	`htÚl
(
x
);

775 
	}
}

776 #ià
SIZEOF_LONG
 == 4

778 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

779  
	`htÚl
(
x
);

780 
	}
}

782 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

783  
	`htÚl
(
x
);

784 
	}
}

785 #–ià
SIZEOF_LONG
 == 8

787 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

788  
	`htÚq
(
x
);

789 
	}
}

791 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

792  
	`htÚq
(
x
);

793 
	}
}

795 #ià
SIZEOF_LONG_LONG
 == 8

797 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

798  
	`htÚq
(
x
);

799 
	}
}

801 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

802  
	`htÚq
(
x
);

803 
	}
}

805 #ià!
HAVE_INT64_T_IS_LONG
 && !
HAVE_INT64_T_IS_LONG_LONG


807 
šlše
 
št64_t
 
	$ho¡_to_Ãt_Üd”
(
št64_t
 
x
) {

808  
	`htÚq
(
x
);

809 
	}
}

811 
šlše
 
ušt64_t
 
	$ho¡_to_Ãt_Üd”
(
ušt64_t
 
x
) {

812  
	`htÚq
(
x
);

813 
	}
}

816 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

817 uniÚ { 
f
; 
ušt32_t
 
i
; } 
v
;

818 
v
.
f
 = 
x
;

819 
v
.
i
 = 
	`ho¡_to_Ãt_Üd”
(v.i);

820  
v
.
f
;

821 
	}
}

823 
šlše
 
	$ho¡_to_Ãt_Üd”
(
x
) {

824 uniÚ { 
d
; 
ušt64_t
 
i
; } 
v
;

825 
v
.
d
 = 
x
;

826 
v
.
i
 = 
	`ho¡_to_Ãt_Üd”
(v.i);

827  
v
.
d
;

828 
	}
}

835 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

836  
x
;

837 
	}
}

839 
šlše
 sigÃd 
	$Ãt_to_ho¡_Üd”
(sigÃd 
x
) {

840  
x
;

841 
	}
}

843 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

844  
x
;

845 
	}
}

847 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

848  
	`Áohs
(
x
);

849 
	}
}

851 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

852  
	`Áohs
(
x
);

853 
	}
}

855 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

856  
	`Áohl
(
x
);

857 
	}
}

859 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

860  
	`Áohl
(
x
);

861 
	}
}

862 #ià
SIZEOF_LONG
 == 4

864 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

865  
	`Áohl
(
x
);

866 
	}
}

868 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

869  
	`Áohl
(
x
);

870 
	}
}

871 #–ià
SIZEOF_LONG
 == 8

873 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

874  
	`Áohq
(
x
);

875 
	}
}

877 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

878  
	`Áohq
(
x
);

879 
	}
}

881 #ià
SIZEOF_LONG_LONG
 == 8

883 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

884  
	`Áohq
(
x
);

885 
	}
}

887 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

888  
	`Áohq
(
x
);

889 
	}
}

891 #ià!
HAVE_INT64_T_IS_LONG
 && !
HAVE_INT64_T_IS_LONG_LONG


893 
šlše
 
št64_t
 
	$Ãt_to_ho¡_Üd”
(
št64_t
 
x
) {

894  
	`Áohq
(
x
);

895 
	}
}

897 
šlše
 
ušt64_t
 
	$Ãt_to_ho¡_Üd”
(
ušt64_t
 
x
) {

898  
	`Áohq
(
x
);

899 
	}
}

902 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

903  
	`ho¡_to_Ãt_Üd”
(
x
);

904 
	}
}

906 
šlše
 
	$Ãt_to_ho¡_Üd”
(
x
) {

907  
	`ho¡_to_Ãt_Üd”
(
x
);

908 
	}
}

910 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	smake_®Ÿ§bË
 {};

911 
	#MAKE_ALIASABLE
(
T
è
‹m¶©e
 <> 
make_®Ÿ§bË
<T> { T 
	tty³
 
	t__©Œibu‹__
((
	t__may_®Ÿs__
)); }

	)

912 
MAKE_ALIASABLE
();

913 
MAKE_ALIASABLE
(signed );

914 
MAKE_ALIASABLE
();

915 
MAKE_ALIASABLE
();

916 
MAKE_ALIASABLE
();

917 
MAKE_ALIASABLE
();

918 
MAKE_ALIASABLE
();

919 
MAKE_ALIASABLE
();

920 
MAKE_ALIASABLE
();

921 
MAKE_ALIASABLE
();

922 
MAKE_ALIASABLE
();

923 
MAKE_ALIASABLE
();

924 
MAKE_ALIASABLE
();

925 #undeà
MAKE_ALIASABLE


927 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

928 
šlše
 * 
	$wr™e_š_ho¡_Üd”
(* 
s
, 
T
 
x
) {

929 #ià
HAVE_INDIFFERENT_ALIGNMENT


930 *
»š‹½»t_ÿ¡
<
ty³Çme
 
make_®Ÿ§bË
<
T
>::
ty³
*>(
s
èğ
x
;

932 
	`memıy
(
s
, &
x
, (x));

934  
s
 + (
x
);

935 
	}
}

937 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

938 
šlše
 
ušt8_t
* 
	$wr™e_š_ho¡_Üd”
(
ušt8_t
* 
s
, 
T
 
x
) {

939  
»š‹½»t_ÿ¡
<
ušt8_t
*>

940 (
	`wr™e_š_ho¡_Üd”
(
»š‹½»t_ÿ¡
<*>(
s
), 
x
));

941 
	}
}

943 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

944 
šlše
 
T
 
	$»ad_š_ho¡_Üd”
(cÚ¡ * 
s
) {

945 #ià
HAVE_INDIFFERENT_ALIGNMENT


946  *
»š‹½»t_ÿ¡
<cÚ¡ 
ty³Çme
 
make_®Ÿ§bË
<
T
>::
ty³
*>(
s
);

948 
T
 
x
;

949 
	`memıy
(&
x
, 
s
, (x));

950  
x
;

952 
	}
}

954 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

955 
šlše
 
T
 
	$»ad_š_ho¡_Üd”
(cÚ¡ 
ušt8_t
* 
s
) {

956  
»ad_š_ho¡_Üd”
<
T
>(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
));

957 
	}
}

959 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

960 
šlše
 * 
	$wr™e_š_Ãt_Üd”
(* 
s
, 
T
 
x
) {

961  
wr™e_š_ho¡_Üd”
<
T
>(
s
, 
	`ho¡_to_Ãt_Üd”
(
x
));

962 
	}
}

964 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

965 
šlše
 
ušt8_t
* 
	$wr™e_š_Ãt_Üd”
(
ušt8_t
* 
s
, 
T
 
x
) {

966  
»š‹½»t_ÿ¡
<
ušt8_t
*>

967 (
	`wr™e_š_Ãt_Üd”
(
»š‹½»t_ÿ¡
<*>(
s
), 
x
));

968 
	}
}

970 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

971 
šlše
 
T
 
	$»ad_š_Ãt_Üd”
(cÚ¡ * 
s
) {

972  
	`Ãt_to_ho¡_Üd”
(
»ad_š_ho¡_Üd”
<
T
>(
s
));

973 
	}
}

975 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

976 
šlše
 
T
 
	$»ad_š_Ãt_Üd”
(cÚ¡ 
ušt8_t
* 
s
) {

977  
»ad_š_Ãt_Üd”
<
T
>(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
));

978 
	}
}

981 
šlše
 
ušt64_t
 
	$»ad_pmc
(
ušt32_t
 
ecx
) {

982 
ušt32_t
 
a
, 
d
;

983 
__asm
 
	`__vŞ©e
("rdpmc" : "÷"(
a
), "=d"(
d
è: "c"(
ecx
));

984  ((
ušt64_t
)
a
è| (((ušt64_t)
d
) << 32);

985 
	}
}

987 
šlše
 
ušt64_t
 
	$»ad_tsc
()

989 
ušt32_t
 
low
, 
high
;

990 
asm
 vŞ©e("rdtsc" : "÷" (
low
), "=d" (
high
));

991  ((
ušt64_t
)
low
è| (((ušt64_t)
high
) << 32);

992 
	}
}

994 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

995 
šlše
 
	$com·»
(
T
 
a
, T 
b
) {

996 ià(
a
 =ğ
b
)

999  
a
 < 
b
 ? -1 : 1;

1000 
	}
}

1004 
Çme¥aû
 
	gmass
 {

1006 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	sty³_synÚym
 {

1007 
T
 
	tty³
;

1011 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS


1012 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
T
 
	gV
>

1013 
usšg
 
	gš‹g¿l_cÚ¡ªt
 = 
¡d
::
š‹g¿l_cÚ¡ªt
<
T
, 
	gV
>;

1014 
	g¡d
::
	tŒue_ty³
rue_type;

1015 
	g¡d
::
	tçl£_ty³
 false_type;

1017 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
T
 
	gV
>

1018 
	sš‹g¿l_cÚ¡ªt
 {

1019 
	gš‹g¿l_cÚ¡ªt
<
	tT
, 
	tV
> 
	tty³
;

1020 
T
 
	tv®ue_ty³
;

1021 
cÚ¡ex´
 
T
 
	gv®ue
 = 
V
;

1023 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
T
 
	gV
> 
cÚ¡ex´
 T 
	gš‹g¿l_cÚ¡ªt
<T, V>::
v®ue
;

1024 
	gš‹g¿l_cÚ¡ªt
<
	tboŞ
, 
	tŒue
> 
	tŒue_ty³
;

1025 
	gš‹g¿l_cÚ¡ªt
<
	tboŞ
, 
	tçl£
> 
	tçl£_ty³
;

1028 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS


1029 
	g‹m¶©e
 <
boŞ
 
	gB
, 
ty³Çme
 
	gT
,y³Çm
	gF
>

1030 
usšg
 
	gcÚd™iÚ®
 = 
¡d
::
cÚd™iÚ®
<
B
, 
	gT
, 
	gF
>;

1032 
	g‹m¶©e
 <
boŞ
 
	gB
, 
ty³Çme
 
	gT
,y³Çm
	gF
> 
	scÚd™iÚ®
 {};

1033 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gF
> 
	gcÚd™iÚ®
<
	gŒue
, T, F> {

1034 
T
 
	tty³
;

1036 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gF
> 
	gcÚd™iÚ®
<
	gçl£
, T, F> {

1037 
F
 
	tty³
;

1041 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS


1042 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	g»move_cÚ¡
 = 
¡d
::
»move_cÚ¡
<
T
>;

1043 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	g»move_vŞ©e
 = 
¡d
::
»move_vŞ©e
<
T
>;

1044 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	g»move_cv
 = 
¡d
::
»move_cv
<
T
>;

1046 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	g»move_cÚ¡
 : 
public
 
ty³_synÚym
<
T
> {};

1047 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	g»move_cÚ¡
<cÚ¡ T> : 
public
 
ty³_synÚym
<
T
> {};

1048 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	g»move_vŞ©e
 : 
public
 
ty³_synÚym
<
T
> {};

1049 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	g»move_vŞ©e
<vŞ©T> : 
public
 
ty³_synÚym
<
T
> {};

1050 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	s»move_cv
 {

1051 
ty³Çme
 
	t»move_cÚ¡
<
	tty³Çme
 
	t»move_vŞ©e
<
	tT
>::
	tty³
>::typeype;

1055 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS


1056 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gis_poš‹r
 = 
¡d
::
is_poš‹r
<
T
>;

1058 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_poš‹r_h–³r
 : 
public
 
çl£_ty³
 {};

1059 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_poš‹r_h–³r
<T*> : 
public
 
Œue_ty³
 {};

1060 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_poš‹r


1061 : 
public
 
š‹g¿l_cÚ¡ªt
<
boŞ
, 
	gis_poš‹r_h–³r
<
ty³Çme
 
	g»move_cv
<
	gT
>::
ty³
>::
v®ue
> {};

1064 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS


1065 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gis_»ã»nû
 = 
¡d
::
is_»ã»nû
<
T
>;

1067 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_»ã»nû_h–³r
 : 
public
 
çl£_ty³
 {};

1068 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_»ã»nû_h–³r
<T&> : 
public
 
Œue_ty³
 {};

1069 #ià
HAVE_CXX_RVALUE_REFERENCES


1070 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_»ã»nû_h–³r
<T&&> : 
public
 
Œue_ty³
 {};

1072 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_»ã»nû


1073 : 
public
 
š‹g¿l_cÚ¡ªt
<
boŞ
, 
	gis_»ã»nû_h–³r
<
ty³Çme
 
	g»move_cv
<
	gT
>::
ty³
>::
v®ue
> {};

1076 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS


1077 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gmake_unsigÃd
 = 
¡d
::
make_unsigÃd
<
T
>;

1078 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gmake_sigÃd
 = 
¡d
::
make_sigÃd
<
T
>;

1080 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	smake_unsigÃd
 {};

1081 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1082 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<sigÃd > : 
public
 
ty³_synÚym
<> {};

1083 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1084 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1085 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1086 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1087 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1088 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1089 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1090 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1091 
	g‹m¶©e
 <> 
	gmake_unsigÃd
<> : 
public
 
ty³_synÚym
<> {};

1093 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	smake_sigÃd
 {};

1094 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<signed > {};

1095 
	g‹m¶©e
 <> 
	gmake_sigÃd
<sigÃd > : 
public
 
ty³_synÚym
<signed > {};

1096 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<signed > {};

1097 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1098 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1099 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1100 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1101 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1102 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1103 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1104 
	g‹m¶©e
 <> 
	gmake_sigÃd
<> : 
public
 
ty³_synÚym
<> {};

1114 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS
 && 
HAVE_STD_IS_TRIVIALLY_COPYABLE


1115 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gis_ŒivŸÎy_cİyabË
 = 
¡d
::
is_ŒivŸÎy_cİyabË
<
T
>;

1116 #–ià
HAVE___HAS_TRIVIAL_COPY


1117 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_ŒivŸÎy_cİyabË
 : 
public
 
š‹g¿l_cÚ¡ªt
<
boŞ
, 
__has_ŒivŸl_cİy
(
T
)> {};

1119 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_ŒivŸÎy_cİyabË
 : 
public
 
çl£_ty³
 {};

1120 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1121 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<sigÃd > : 
public
 
Œue_ty³
 {};

1122 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1123 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1124 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1125 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1126 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1127 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1128 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1129 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1130 
	g‹m¶©e
 <> 
	gis_ŒivŸÎy_cİyabË
<> : 
public
 
Œue_ty³
 {};

1131 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_ŒivŸÎy_cİyabË
<T*> : 
public
 
Œue_ty³
 {};

1138 #ià
HAVE_CXX_TEMPLATE_ALIAS
 && 
HAVE_TYPE_TRAITS
 && 
HAVE_STD_IS_TRIVIALLY_DESTRUCTIBLE


1139 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gis_ŒivŸÎy_de¡ruùibË
 = 
¡d
::
is_ŒivŸÎy_de¡ruùibË
<
T
>;

1140 #–ià
HAVE___HAS_TRIVIAL_DESTRUCTOR


1141 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_ŒivŸÎy_de¡ruùibË
 : 
public
 
š‹g¿l_cÚ¡ªt
<
boŞ
, 
__has_ŒivŸl_de¡ruùÜ
(
T
)> {};

1143 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gis_ŒivŸÎy_de¡ruùibË
 : 
public
 
is_ŒivŸÎy_cİyabË
<
T
> {};

1155 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gu£_»ã»nû
 = (!
is_»ã»nû
<
T
>::
v®ue


1156 && (!
is_ŒivŸÎy_cİyabË
<
T
>::
v®ue


1157 || (
T
) > (*)))>

1158 
ç¡_¬gum’t
;

1160 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gç¡_¬gum’t
<T, 
	gŒue
> {

1161 
cÚ¡ex´
 
boŞ
 
	gis_»ã»nû
 = 
Œue
;

1162 cÚ¡ 
	tT
& 
	tty³
;

1163 #ià
HAVE_CXX_RVALUE_REFERENCES


1164 
	t’abË_rv®ue_»ã»nû
;

1167 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gç¡_¬gum’t
<T, 
	gçl£
> {

1168 
cÚ¡ex´
 
boŞ
 
	gis_»ã»nû
 = 
çl£
;

1169 
T
 
	tty³
;

1171 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
cÚ¡ex´
 
boŞ
 
	gç¡_¬gum’t
<T, 
	gŒue
>::
is_»ã»nû
;

1172 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
cÚ¡ex´
 
boŞ
 
	gç¡_¬gum’t
<T, 
	gçl£
>::
is_»ã»nû
;

1177 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1178 
	ghas_ç¡_št_muÉly
 : 
public
 
mass
::
çl£_ty³
 {

1182 #ià
defšed
(
__i386__
è|| defšed(
__x86_64__
)

1183 
šlše
 
	$št_muÉly
(
a
, 
b
, &
xlow
, &
xhigh
)

1185 
	`__asm__
("muÈ%2" : "÷" (
xlow
), "=d" (
xhigh
è: "r" (
a
), "a" (
b
) : "cc");

1186 
	}
}

1187 
	g‹m¶©e
 <> 
	ghas_ç¡_št_muÉly
<> : 
public
 
mass
::
Œue_ty³
 {};

1189 #ià
SIZEOF_LONG
 =ğ4 || (
defšed
(
__x86_64__
) && SIZEOF_LONG == 8)

1190 
šlše
 
	$št_muÉly
(
a
, 
b
, &
xlow
, &
xhigh
)

1192 
	`__asm__
("muÈ%2" : "÷" (
xlow
), "=d" (
xhigh
è: "r" (
a
), "a" (
b
) : "cc");

1193 
	}
}

1194 
	g‹m¶©e
 <> 
	ghas_ç¡_št_muÉly
<> : 
public
 
mass
::
Œue_ty³
 {};

1197 #ià
defšed
(
__x86_64__
è&& 
SIZEOF_LONG_LONG
 == 8

1198 
šlše
 
	$št_muÉly
(
a
, 
b
, &
xlow
, &
xhigh
)

1200 
	`__asm__
("muÈ%2" : "÷" (
xlow
), "=d" (
xhigh
è: "r" (
a
), "a" (
b
) : "cc");

1201 
	}
}

1202 
	g‹m¶©e
 <> 
	ghas_ç¡_št_muÉly
<> : 
public
 
mass
::
Œue_ty³
 {};

1206 
	sunš™Ÿlized_ty³
 {};

	@masstree-beta/config.h

4 #iâdeà
MASSTREE_CONFIG_H_INCLUDED


5 
	#MASSTREE_CONFIG_H_INCLUDED
 1

	)

11 
	#CACHE_LINE_SIZE
 64

	)

14 
	#ENABLE_ASSERTIONS
 1

	)

23 
	#HAVE_CLOCK_GETTIME
 1

	)

26 
	#HAVE_CXX_CONSTEXPR
 1

	)

29 
	#HAVE_CXX_RVALUE_REFERENCES
 1

	)

32 
	#HAVE_CXX_STATIC_ASSERT
 1

	)

35 
	#HAVE_CXX_TEMPLATE_ALIAS
 1

	)

39 
	#HAVE_DECL_CLOCK_GETTIME
 1

	)

43 
	#HAVE_DECL_GETLINE
 1

	)

46 
	#HAVE_EXECINFO_H
 1

	)

55 
	#HAVE_INT64_T_IS_LONG
 1

	)

61 
	#HAVE_INTTYPES_H
 1

	)

64 
	#HAVE_JEMALLOC
 1

	)

70 
	#HAVE_LONG_LONG
 1

	)

73 
	#HAVE_MADV_HUGEPAGE
 1

	)

76 
	#HAVE_MAP_HUGETLB
 1

	)

82 
	#HAVE_MEMORY_H
 1

	)

88 
	#HAVE_OFF_T_IS_LONG
 1

	)

97 
	#HAVE_SIZE_T_IS_UNSIGNED_LONG
 1

	)

103 
	#HAVE_STDINT_H
 1

	)

106 
	#HAVE_STDLIB_H
 1

	)

109 
	#HAVE_STD_HASH
 1

	)

112 
	#HAVE_STD_IS_RVALUE_REFERENCE
 1

	)

115 
	#HAVE_STD_IS_TRIVIALLY_COPYABLE
 1

	)

118 
	#HAVE_STD_IS_TRIVIALLY_DESTRUCTIBLE
 1

	)

121 
	#HAVE_STRINGS_H
 1

	)

124 
	#HAVE_STRING_H
 1

	)

127 
	#HAVE_SUPERPAGE
 1

	)

130 
	#HAVE_SYS_EPOLL_H
 1

	)

133 
	#HAVE_SYS_STAT_H
 1

	)

136 
	#HAVE_SYS_TYPES_H
 1

	)

142 
	#HAVE_TIME_H
 1

	)

145 
	#HAVE_TYPE_TRAITS
 1

	)

148 
	#HAVE_UNALIGNED_ACCESS
 1

	)

151 
	#HAVE_UNISTD_H
 1

	)

154 
	#HAVE___BUILTIN_CLZ
 1

	)

157 
	#HAVE___BUILTIN_CLZL
 1

	)

160 
	#HAVE___BUILTIN_CLZLL
 1

	)

163 
	#HAVE___BUILTIN_CTZ
 1

	)

166 
	#HAVE___BUILTIN_CTZL
 1

	)

169 
	#HAVE___BUILTIN_CTZLL
 1

	)

172 
	#HAVE___HAS_TRIVIAL_COPY
 1

	)

175 
	#HAVE___HAS_TRIVIAL_DESTRUCTOR
 1

	)

178 
	#HAVE___SYNC_ADD_AND_FETCH
 1

	)

181 
	#HAVE___SYNC_ADD_AND_FETCH_8
 1

	)

184 
	#HAVE___SYNC_BOOL_COMPARE_AND_SWAP
 1

	)

187 
	#HAVE___SYNC_BOOL_COMPARE_AND_SWAP_8
 1

	)

190 
	#HAVE___SYNC_FETCH_AND_ADD
 1

	)

193 
	#HAVE___SYNC_FETCH_AND_ADD_8
 1

	)

196 
	#HAVE___SYNC_FETCH_AND_OR
 1

	)

199 
	#HAVE___SYNC_FETCH_AND_OR_8
 1

	)

202 
	#HAVE___SYNC_LOCK_RELEASE_SET
 1

	)

205 
	#HAVE___SYNC_LOCK_TEST_AND_SET
 1

	)

208 
	#HAVE___SYNC_LOCK_TEST_AND_SET_VAL
 1

	)

211 
	#HAVE___SYNC_OR_AND_FETCH
 1

	)

214 
	#HAVE___SYNC_OR_AND_FETCH_8
 1

	)

217 
	#HAVE___SYNC_SYNCHRONIZE
 1

	)

220 
	#HAVE___SYNC_VAL_COMPARE_AND_SWAP
 1

	)

223 
	#HAVE___SYNC_VAL_COMPARE_AND_SWAP_8
 1

	)

226 
	#MASSTREE_MAXKEYLEN
 511

	)

235 
	#MASSTREE_ROW_TYPE_BAG
 1

	)

241 
	#PACKAGE_BUGREPORT
 ""

	)

244 
	#PACKAGE_NAME
 "mas¡»e-b‘a"

	)

247 
	#PACKAGE_STRING
 "mas¡»e-b‘¨0.1"

	)

250 
	#PACKAGE_TARNAME
 "mas¡»e-b‘a"

	)

253 
	#PACKAGE_URL
 ""

	)

256 
	#PACKAGE_VERSION
 "0.1"

	)

259 
	#SIZEOF_INT
 4

	)

262 
	#SIZEOF_LONG
 8

	)

265 
	#SIZEOF_LONG_LONG
 8

	)

268 
	#SIZEOF_SHORT
 2

	)

271 
	#SIZEOF_VOID_P
 8

	)

274 
	#STDC_HEADERS
 1

	)

278 #ià
defšed
 
AC_APPLE_UNIVERSAL_BUILD


279 #ià
defšed
 
__BIG_ENDIAN__


280 
	#WORDS_BIGENDIAN
 1

	)

283 #iâdeà
WORDS_BIGENDIAN


289 
	#WORDS_BIGENDIAN_SET
 1

	)

291 #ià!
FORCE_ENABLE_ASSERTIONS
 && !
ENABLE_ASSERTIONS


292 
	#NDEBUG
 1

	)

296 
	$ç_®ways_as£¹
(cÚ¡ * 
fe
, 
lše
, cÚ¡ * 
as£¹iÚ
, cÚ¡ * 
mes§ge
 = 0è
	`__©Œibu‹__
((
nÜ‘uº
));

297 
	#®ways_as£¹
(
x
, ...èdØ{ ià(!(x)è
	`ç_®ways_as£¹
(
__FILE__
, 
__LINE__
, #x, ## 
__VA_ARGS__
); 
	}
} 0)

	)

298 
	#mªd©Üy_as£¹
 
®ways_as£¹


	)

304 
	$ç_mas¡»e_šv¬ŸÁ
(cÚ¡ * 
fe
, 
lše
, cÚ¡ * 
as£¹iÚ
, cÚ¡ * 
mes§ge
 = 0è
	`__©Œibu‹__
((
nÜ‘uº
));

305 #ià
FORCE_ENABLE_ASSERTIONS
 || (!
	`defšed
(
ENABLE_INVARIANTS
è&& 
ENABLE_ASSERTIONS
) || ENABLE_INVARIANTS

306 
	#mas¡»e_šv¬ŸÁ
(
x
, ...èdØ{ ià(!(x)è
	`ç_mas¡»e_šv¬ŸÁ
(
__FILE__
, 
__LINE__
, #x, ## 
__VA_ARGS__
); 
	}
} 0)

	)

308 
	#mas¡»e_šv¬ŸÁ
(
x
, ...èdØ{ } 0)

	)

315 
	$ç_mas¡»e_´ecÚd™iÚ
(cÚ¡ * 
fe
, 
lše
, cÚ¡ * 
as£¹iÚ
, cÚ¡ * 
mes§ge
 = 0è
	`__©Œibu‹__
((
nÜ‘uº
));

316 #ià
FORCE_ENABLE_ASSERTIONS
 || (!
	`defšed
(
ENABLE_PRECONDITIONS
è&& 
ENABLE_ASSERTIONS
) || ENABLE_PRECONDITIONS

317 
	#mas¡»e_´ecÚd™iÚ
(
x
, ...èdØ{ ià(!(x)è
	`ç_mas¡»e_´ecÚd™iÚ
(
__FILE__
, 
__LINE__
, #x, ## 
__VA_ARGS__
); 
	}
} 0)

	)

319 
	#mas¡»e_´ecÚd™iÚ
(
x
, ...èdØ{ } 0)

	)

322 #iâdeà
šv¬ŸÁ


323 
	#šv¬ŸÁ
 
mas¡»e_šv¬ŸÁ


	)

325 #iâdeà
´ecÚd™iÚ


326 
	#´ecÚd™iÚ
 
mas¡»e_´ecÚd™iÚ


	)

	@masstree-beta/file.cc

16 
	~"fe.hh
"

17 
	~"¡¿ccum.hh
"

18 
	~<fú.h
>

19 
	~<¡dio.h
>

21 
	glcdf
::
SŒšg
 
	$»ad_fe_cÚ‹Ás
(
fd
) {

22 
lcdf
::
SŒšgAccum
 
§
;

24 *
buf
 = 
§
.
	`»£rve
(4096);

25 ià(!
buf
) {

26 
”ºo
 = 
ENOMEM
;

27  
lcdf
::
	`SŒšg
();

30 
ssize_t
 
x
 = 
	`»ad
(
fd
, 
buf
, 4096);

31 ià(
x
 != -1 && x != 0)

32 
§
.
	`adju¡_Ëngth
(
x
);

33 ià(
x
 == 0)

35 ià(
”ºo
 !ğ
EINTR
)

36  
lcdf
::
	`SŒšg
();

39 
”ºo
 = 0;

40  
§
.
	`ke_¡ršg
();

41 
	}
}

43 
	glcdf
::
SŒšg
 
	$»ad_fe_cÚ‹Ás
(cÚ¡ *
f’ame
) {

44 
fd
 = 
	`İ’
(
f’ame
, 
O_RDONLY
);

45 ià(
fd
 == -1)

46  
lcdf
::
	`SŒšg
();

48 
lcdf
::
SŒšg
 
‹xt
 = 
	`»ad_fe_cÚ‹Ás
(
fd
);

50 ià(
‹xt
.
	`em±y
(è&& 
”ºo
) {

51 
§ved_”ºo
 = 
”ºo
;

52 
	`şo£
(
fd
);

53 
”ºo
 = 
§ved_”ºo
;

55 
	`şo£
(
fd
);

56  
‹xt
;

57 
	}
}

59 
	$sync_wr™e_fe_cÚ‹Ás
(cÚ¡ *
f’ame
, cÚ¡ 
lcdf
::
SŒšg
 &
cÚ‹Ás
,

60 
mode_t
 
mode
)

62 
fd
 = 
	`İ’
(
f’ame
, 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
, 
mode
);

63 ià(
fd
 == -1)

66 
ssize_t
 
x
 = 
	`§ã_wr™e
(
fd
, 
cÚ‹Ás
.
	`d©a
(), cÚ‹Ás.
	`Ëngth
());

67 ià(
x
 !ğ
cÚ‹Ás
.
	`Ëngth
()) {

68 
”rÜ
:

69 
§ved_”ºo
 = 
”ºo
;

70 
	`şo£
(
fd
);

71 
”ºo
 = 
§ved_”ºo
;

75 ià(
	`fsync
(
fd
) != 0)

76 
”rÜ
;

78  
	`şo£
(
fd
);

79 
	}
}

81 
	$©omic_wr™e_fe_cÚ‹Ás
(cÚ¡ *
f’ame
, cÚ¡ 
lcdf
::
SŒšg
 &
cÚ‹Ás
,

82 
mode_t
 
mode
)

84 
lcdf
::
SŒšg
 
tmp_f’ame
 =†cdf::
	`SŒšg
(
f’ame
) + ".tmp";

85 
r
 = 
	`sync_wr™e_fe_cÚ‹Ás
(
tmp_f’ame
.
	`c_¡r
(), 
cÚ‹Ás
, 
mode
);

86 ià(
r
 != 0)

89  
	`»Çme
(
tmp_f’ame
.
	`c_¡r
(), 
f’ame
);

90 
	}
}

	@masstree-beta/file.hh

16 #iâdeà
KVDB_FILE_HH


17 
	#KVDB_FILE_HH
 1

	)

18 
	~<uni¡d.h
>

19 
	~<sys/ty³s.h
>

20 
	~<”ºo.h
>

21 
	~"¡ršg.hh
"

23 
šlše
 
ssize_t


24 
	$§ã_»ad
(
fd
, *
buf
, 
size_t
 
couÁ
)

26 
size_t
 
pos
 = 0;

27 
pos
 !ğ
couÁ
) {

28 
ssize_t
 
x
 = ::
	`»ad
(
fd
, 
buf
, 
couÁ
 - 
pos
);

29 ià(
x
 != -1 && x != 0) {

30 
buf
 = 
»š‹½»t_ÿ¡
<*>(bufè+ 
x
;

31 
pos
 +ğ
x
;

32 } ià(
x
 == 0)

34 ià(
”ºo
 !ğ
EINTR
 && 
pos
 == 0)

36 ià(
”ºo
 !ğ
EINTR
)

39  
pos
;

40 
	}
}

42 
šlše
 
ssize_t


43 
	$§ã_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

45 
size_t
 
pos
 = 0;

46 
pos
 !ğ
couÁ
) {

47 
ssize_t
 
x
 = ::
	`wr™e
(
fd
, 
buf
, 
couÁ
 - 
pos
);

48 ià(
x
 != -1 && x != 0) {

49 
buf
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(bufè+ 
x
;

50 
pos
 +ğ
x
;

51 } ià(
x
 == 0)

53 ià(
”ºo
 !ğ
EINTR
 && 
pos
 == 0)

55 ià(
”ºo
 !ğ
EINTR
)

58  
pos
;

59 
	}
}

61 
šlše
 

62 
	$checked_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

64 
ssize_t
 
x
 = 
	`§ã_wr™e
(
fd
, 
buf
, 
couÁ
);

65 
	`®ways_as£¹
(
	`size_t
(
x
è=ğ
couÁ
);

66 
	}
}

68 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
šlše
 

69 
	$checked_wr™e
(
fd
, cÚ¡ 
T
 *
x
)

71 
	`checked_wr™e
(
fd
, 
»š‹½»t_ÿ¡
<cÚ¡ *>(
x
), (*x));

72 
	}
}

75 
	glcdf
::
SŒšg
 
»ad_fe_cÚ‹Ás
(
fd
);

76 
	glcdf
::
SŒšg
 
»ad_fe_cÚ‹Ás
(cÚ¡ *
f’ame
);

77 
sync_wr™e_fe_cÚ‹Ás
(cÚ¡ *
f’ame
, cÚ¡ 
lcdf
::
SŒšg
 &
cÚ‹Ás
,

78 
mode_t
 
mode
 = 0666);

79 
©omic_wr™e_fe_cÚ‹Ás
(cÚ¡ *
f’ame
, cÚ¡ 
lcdf
::
SŒšg
 &
cÚ‹Ás
,

80 
mode_t
 
mode
 = 0666);

	@masstree-beta/hashcode.hh

16 #iâdeà
CLICK_HASHCODE_HH


17 
	#CLICK_HASHCODE_HH


	)

18 
	~<¡ddef.h
>

19 
	~<š‰y³s.h
>

20 #ià
HAVE_STD_HASH


21 
	~<funùiÚ®
>

35 
size_t
 
	thashcode_t
;

37 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

38 
šlše
 
hashcode_t
 
	$hashcode
(
T
 cÚ¡ &
x
) {

39  
x
.
	`hashcode
();

40 
	}
}

42 
	g‹m¶©e
 <>

43 
šlše
 
hashcode_t
 
	$hashcode
(cÚ¡ &
x
) {

44  
x
;

45 
	}
}

47 
	g‹m¶©e
 <>

48 
šlše
 
hashcode_t
 
	$hashcode
(sigÃd cÚ¡ &
x
) {

49  
x
;

50 
	}
}

52 
	g‹m¶©e
 <>

53 
šlše
 
hashcode_t
 
	$hashcode
(cÚ¡ &
x
) {

54  
x
;

55 
	}
}

57 
	g‹m¶©e
 <>

58 
šlše
 
hashcode_t
 
	$hashcode
(cÚ¡ &
x
) {

59  
x
;

60 
	}
}

62 
	g‹m¶©e
 <>

63 
šlše
 
hashcode_t
 
	$hashcode
(cÚ¡ &
x
) {

64  
x
;

65 
	}
}

67 
	g‹m¶©e
 <>

68 
šlše
 
hashcode_t
 
	$hashcode
(cÚ¡ &
x
) {

69  
x
;

70 
	}
}

72 
	g‹m¶©e
 <>

73 
šlše
 
hashcode_t
 
	$hashcode
(cÚ¡ &
x
) {

74  
x
;

75 
	}
}

77 
	g‹m¶©e
 <>

78 
šlše
 
hashcode_t
 
	$hashcode
(cÚ¡ &
x
) {

79  
x
;

80 
	}
}

82 
	g‹m¶©e
 <>

83 
šlše
 
hashcode_t
 
	$hashcode
(cÚ¡ &
x
) {

84  
x
;

85 
	}
}

87 
	g‹m¶©e
 <>

88 
šlše
 
hashcode_t
 
	$hashcode
(cÚ¡ &
x
) {

89  (
x
 >> 32) ^ x;

90 
	}
}

92 
	g‹m¶©e
 <>

93 
šlše
 
hashcode_t
 
	$hashcode
(cÚ¡ &
x
) {

94  (
x
 >> 32) ^ x;

95 
	}
}

97 #ià
HAVE_INT64_TYPES
 && !
HAVE_INT64_IS_LONG
 && !
HAVE_INT64_IS_LONG_LONG


98 
	g‹m¶©e
 <>

99 
šlše
 
hashcode_t
 
	$hashcode
(
št64_t
 cÚ¡ &
x
) {

100  (
x
 >> 32) ^ x;

101 
	}
}

103 
	g‹m¶©e
 <>

104 
šlše
 
hashcode_t
 
	$hashcode
(
ušt64_t
 cÚ¡ &
x
) {

105  (
x
 >> 32) ^ x;

106 
	}
}

109 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

110 
šlše
 
hashcode_t
 
	$hashcode
(
T
 * cÚ¡ &
x
) {

111  
»š‹½»t_ÿ¡
<
ušŒ_t
>(
x
) >> 3;

112 
	}
}

114 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

115 
šlše
 
ty³Çme
 
	gT
::
key_cÚ¡_»ã»nû
 
	$hashkey
(cÚ¡ 
T
 &
x
) {

116  
x
.
	`hashkey
();

117 
	}
}

	@masstree-beta/json.cc

17 
	~"jsÚ.hh
"

18 
	~"comp”.hh
"

19 
	~<ùy³.h
>

20 
Çme¥aû
 
	glcdf
 {

58 cÚ¡ 
	gJsÚ
::
nuÎ_t
 
JsÚ
::
nuÎ
;

59 cÚ¡ 
JsÚ
 
	gJsÚ
::
nuÎ_jsÚ
;

60 cÚ¡ 
SŒšg
 
¬¿y_¡ršg
("[Array]", 7);

61 cÚ¡ 
SŒšg
 
objeù_¡ršg
("[Object]", 8);

65 
	gJsÚ
::
A¼ayJsÚ
* 
JsÚ
::A¼ayJsÚ::
make
(
n
) {

66 
ÿp
 = 
n
 < 8 ? 8 :‚;

67 * 
	gbuf
 = 
Ãw
 [(
A¼ayJsÚ
è+ 
ÿp
 * (
JsÚ
)];

68  
Ãw
((*è
buf
è
A¼ayJsÚ
(
ÿp
);

71 
	gJsÚ
::
A¼ayJsÚ
::
de¡roy
(A¼ayJsÚ* 
aj
) {

72 ià(
aj
)

73 
i
 = 0; 
	gi
 !ğ
aj
->
size
; ++i)

74 
	gaj
->
	ga
[
i
].~
JsÚ
();

75 
	gd–‘e
[] 
	g»š‹½»t_ÿ¡
<*>(
	gaj
);

81 
	gJsÚ
::
ObjeùJsÚ
::ObjeùJsÚ(cÚ¡ ObjeùJsÚ &
x
)

82 : 
Com¶exJsÚ
(), 
os_
(
x
.os_), 
n_
(x.n_), 
ÿ·c™y_
(x.capacity_),

83 
hash_
(
x
.hash_)

85 
	gsize
 = 
x
.
size
;

86 
grow
(
Œue
);

89 
	gJsÚ
::
ObjeùJsÚ
::~ObjectJson()

91 
ObjeùI‹m
 *
ob
 = 
os_
, *
	gÛ
 = ob + 
n_
;

92 ; 
	gob
 !ğ
Û
; ++ob)

93 ià(
	gob
->
	gÃxt_
 > -2)

94 
	gob
->~
ObjeùI‹m
();

95 
	gd–‘e
[] 
	g»š‹½»t_ÿ¡
<*>(
	gos_
);

98 
	gJsÚ
::
ObjeùJsÚ
::
grow
(
boŞ
 
cİy
)

100 ià(
cİy
 && !
ÿ·c™y_
)

102 
	gÃw_ÿ·c™y
;

103 ià(
	gcİy
)

104 
	gÃw_ÿ·c™y
 = 
ÿ·c™y_
;

105 ià(
	gÿ·c™y_
)

106 
	gÃw_ÿ·c™y
 = 
ÿ·c™y_
 * 2;

108 
	gÃw_ÿ·c™y
 = 8;

109 
ObjeùI‹m
 *
	gÃw_os
 = 
»š‹½»t_ÿ¡
<ObjeùI‹m *>(
İ”©Ü
 
Ãw
[]((ObjeùI‹mè* 
Ãw_ÿ·c™y
));

110 
ObjeùI‹m
 *
	gob
 = 
os_
, *
	gÛ
 = 
ob
 + 
n_
;

111 
ObjeùI‹m
 *
	goi
 = 
Ãw_os
; 
	gob
 !ğ
Û
; ++oi, ++ob) {

112 ià(
	gob
->
	gÃxt_
 == -2)

113 
oi
->
Ãxt_
 = -2;

114 ià(
	gcİy
)

115 
Ãw
((*è
oi
è
ObjeùI‹m
(
ob
->
v_
.
fœ¡
, ob->v_.
£cÚd
, ob->
Ãxt_
);

117 
memıy
(
oi
, 
ob
, (
ObjeùI‹m
));

119 ià(!
	gcİy
)

120 
İ”©Ü
 
	gd–‘e
[](
	g»š‹½»t_ÿ¡
<*>(
	gos_
));

121 
	gos_
 = 
Ãw_os
;

122 
	gÿ·c™y_
 = 
Ãw_ÿ·c™y
;

125 
	gJsÚ
::
ObjeùJsÚ
::
»hash
()

127 
hash_
.
assign
(hash_.
size
() * 2, -1);

128 
	gi
 = 
n_
 - 1; i >= 0; --i) {

129 
	gObjeùI‹m
 &
	goi
 = 
™em
(
i
);

130 ià(
	goi
.
	gÃxt_
 > -2) {

131 
	gb
 = 
buck‘
(
oi
.
v_
.
fœ¡
.
d©a
(), oi.v_.fœ¡.
Ëngth
());

132 
	goi
.
	gÃxt_
 = 
hash_
[
b
];

133 
	ghash_
[
b
] = 
i
;

138 
	gJsÚ
::
ObjeùJsÚ
::
fšd_š£¹
(cÚ¡ 
SŒšg
 &
key
, cÚ¡ 
JsÚ
 &
v®ue
)

140 ià(
	ghash_
.
em±y
())

141 
	ghash_
.
assign
(8, -1);

142 *
	gb
 = &
hash_
[
buck‘
(
key
.
d©a
(), key.
Ëngth
())], 
	gchaš
 = 0;

143 *
	gb
 >ğ0 && 
os_
[*
b
].
v_
.
fœ¡
 !ğ
key
) {

144 
b
 = &
os_
[*b].
Ãxt_
;

145 ++
	gchaš
;

147 ià(*
	gb
 >= 0)

148  *
b
;

150 *
	gb
 = 
n_
;

151 ià(
	gn_
 =ğ
ÿ·c™y_
)

152 
grow
(
çl£
);

154 
Ãw
 ((*è&
os_
[
n_
]è
ObjeùI‹m
(
key
, 
v®ue
, -1);

155 ++
	gn_
;

156 ++
	gsize
;

157 ià(
	gchaš
 > 4)

158 
»hash
();

159  
	gn_
 - 1;

163 
	gJsÚ
 &JsÚ::
ObjeùJsÚ
::
g‘_š£¹
(
SŒ
 
key
)

165 ià(
hash_
.
em±y
())

166 
hash_
.
assign
(8, -1);

167 *
	gb
 = &
hash_
[
buck‘
(
key
.
d©a
(), key.
Ëngth
())], 
	gchaš
 = 0;

168 *
	gb
 >ğ0 && 
os_
[*
b
].
v_
.
fœ¡
 !ğ
key
) {

169 
b
 = &
os_
[*b].
Ãxt_
;

170 ++
	gchaš
;

172 ià(*
	gb
 >= 0)

173  
os_
[*
b
].
v_
.
£cÚd
;

175 *
	gb
 = 
n_
;

176 ià(
	gn_
 =ğ
ÿ·c™y_
)

177 
grow
(
çl£
);

179 
Ãw
 ((*è&
os_
[
n_
]è
ObjeùI‹m
(
SŒšg
(
key
.
d©a
(), key.
Ëngth
()), 
nuÎ_jsÚ
, -1);

180 ++
	gn_
;

181 ++
	gsize
;

182 ià(
	gchaš
 > 4)

183 
»hash
();

184  
	gos_
[
n_
 - 1].
	gv_
.
	g£cÚd
;

188 
	gJsÚ
::
ObjeùJsÚ
::
”a£
(
p
) {

189 cÚ¡ 
ObjeùI‹m
& 
oi
 = 
™em
(
p
);

190 * 
	gb
 = &
hash_
[
buck‘
(
oi
.
v_
.
fœ¡
.
d©a
(), oi.v_.fœ¡.
Ëngth
())];

191 *
	gb
 >ğ0 && *
b
 !ğ
p
)

192 
b
 = &
os_
[*b].
Ãxt_
;

193 
as£¹
(*
b
 =ğ
p
);

194 *
	gb
 = 
os_
[
p
].
Ãxt_
;

195 
	gos_
[
p
].~
ObjeùI‹m
();

196 
	gos_
[
p
].
	gÃxt_
 = -2;

197 --
	gsize
;

200 
	gJsÚ
::
size_ty³
 
JsÚ
::
ObjeùJsÚ
::
”a£
(
SŒ
 
key
) {

201 * 
b
 = &
hash_
[
buck‘
(
key
.
d©a
(), key.
Ëngth
())];

202 *
	gb
 >ğ0 && 
os_
[*
b
].
v_
.
fœ¡
 !ğ
key
)

203 
b
 = &
os_
[*b].
Ãxt_
;

204 ià(*
	gb
 >= 0) {

205 
p
 = *
b
;

206 *
	gb
 = 
os_
[
p
].
Ãxt_
;

207 
	gos_
[
p
].~
ObjeùI‹m
();

208 
	gos_
[
p
].
	gÃxt_
 = -2;

209 --
	gsize
;

215 
	gÇme¥aû
 {

216 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
boŞ
 
¡ršg_to_št_key
(cÚ¡ *
fœ¡
,

217 cÚ¡ *
Ï¡
, 
T
& 
x
)

219 ià(
	gfœ¡
 =ğ
Ï¡
 || !
isdig™
((è*
fœ¡
)

220 || (
fœ¡
[0] =ğ'0' && fœ¡ + 1 !ğ
Ï¡
))

221  
çl£
;

223 
	gx
 = *
fœ¡
 - '0';

224 ++
	gfœ¡
; fœ¡ !ğ
Ï¡
 && 
isdig™
((è*
fœ¡
); ++first)

225 
	gx
 = 10 * 
x
 + *
fœ¡
 - '0';

226  
	gfœ¡
 =ğ
Ï¡
;

230 
	gJsÚ
::
h¬d_uniqueify_¬¿y
(
boŞ
 
cÚv”t
, 
nÿp_š
) {

231 ià(!
	gcÚv”t
)

232 
´ecÚd™iÚ
(
is_nuÎ
(è|| 
is_¬¿y
());

234 
»p_ty³
 
	gŞd_u
 = 
u_
;

236 
	gnÿp
 = 
¡d
::
max
(
nÿp_š
, 8);

237 ià(
	gŞd_u
.
	gx
.
	gty³
 =ğ
j_¬¿y
 && 
Şd_u
.
a
.
x
)

238 
nÿp
 = 
¡d
::
max
Òÿp, (
Şd_u
.
a
.
x
->
size
));

240 
	gxÿp
 = 
iû_log2
(
nÿp
);

241 ià(
	gxÿp
 <= (1U << 14))

242 
nÿp
 = 
xÿp
;

244 
	gnÿp
 = ((
nÿp
 - 1) | ((1U << 14) - 1)) + 1;

245 
	gu_
.
	ga
.
	gx
 = 
A¼ayJsÚ
::
make
(
nÿp
);

246 
	gu_
.
	ga
.
	gty³
 = 
j_¬¿y
;

248 ià(
	gŞd_u
.
	gx
.
	gty³
 =ğ
j_¬¿y
 && 
Şd_u
.
a
.
x
 && old_u.a.x->
»fcouÁ
 == 1) {

249 
u_
.
a
.
x
->
size
 = 
Şd_u
.a.x->size;

250 
memıy
(
u_
.
a
.
x
->a, 
Şd_u
.a.x->a, (
JsÚ
è* u_.a.x->
size
);

251 
	gd–‘e
[] 
	g»š‹½»t_ÿ¡
<*>(
	gŞd_u
.
	ga
.
	gx
);

252 } ià(
	gŞd_u
.
	gx
.
	gty³
 =ğ
j_¬¿y
 && 
Şd_u
.
a
.
x
) {

253 
u_
.
a
.
x
->
size
 = 
Şd_u
.a.x->size;

254 
JsÚ
* 
	gÏ¡
 = 
u_
.
a
.
x
->¨+ u_.a.x->
size
;

255 
JsÚ
* 
	g™
 = 
u_
.
a
.
x
->a, *
	go™
 = 
Şd_u
.a.x->a; iˆ!ğ
Ï¡
; ++it, ++oit)

256 
Ãw
((*è
™
è
JsÚ
(*
o™
);

257 
	gŞd_u
.
	ga
.
	gx
->
d”ef
(
j_¬¿y
);

258 } ià(
	gŞd_u
.
	gx
.
	gty³
 =ğ
j_objeù
 && 
Şd_u
.
o
.
x
) {

259 
ObjeùI‹m
 *
ob
 = 
Şd_u
.
o
.
x
->
os_
, *
	gÛ
 = ob + old_u.o.x->
n_
;

260 
	gi
;

261 ; 
	gob
 !ğ
Û
; ++ob)

262 ià(
	gob
->
	gÃxt_
 > -2

263 && 
¡ršg_to_št_key
(
ob
->
v_
.
fœ¡
.
begš
(),

264 
ob
->
v_
.
fœ¡
.
’d
(), 
i
)) {

265 ià(
	gi
 >ğ(
u_
.
a
.
x
->
ÿ·c™y
))

266 
h¬d_uniqueify_¬¿y
(
çl£
, 
i
 + 1);

267 ià(
	gi
 >ğ(
u_
.
a
.
x
->
size
)) {

268 
mem£t
(&
u_
.
a
.
x
->a[u_.a.x->
size
], 0, (
JsÚ
è* (
i
 + 1 - u_.a.x->size));

269 
	gu_
.
	ga
.
	gx
->
	gsize
 = 
i
 + 1;

271 
	gu_
.
	ga
.
	gx
->a[
i
] = 
ob
->
v_
.
£cÚd
;

273 
	gŞd_u
.
	go
.
	gx
->
d”ef
(
j_objeù
);

274 } ià(
	gŞd_u
.
	gx
.
	gty³
 < 0)

275 
	gŞd_u
.
	g¡r
.
d”ef
();

278 
	gJsÚ
::
h¬d_uniqueify_objeù
(
boŞ
 
cÚv”t
) {

279 ià(!
cÚv”t
)

280 
´ecÚd™iÚ
(
is_nuÎ
(è|| 
is_objeù
());

281 
ObjeùJsÚ
* 
	gnoj
;

282 ià(
	gu_
.
	gx
.
	gty³
 =ğ
j_objeù
 && 
u_
.
o
.
x
) {

283 
noj
 = 
Ãw
 
ObjeùJsÚ
(*
u_
.
o
.
x
);

284 
	gu_
.
	go
.
	gx
->
d”ef
(
j_objeù
);

285 } ià(
	gu_
.
	gx
.
	gty³
 =ğ
j_¬¿y
 && 
u_
.
a
.
x
) {

286 
noj
 = 
Ãw
 
ObjeùJsÚ
;

287 
	gi
 = 0; i !ğ
u_
.
a
.
x
->
size
; ++i)

288 
	gnoj
->
fšd_š£¹
(
SŒšg
(
i
), 
u_
.
a
.
x
->a[i]);

289 
	gu_
.
	ga
.
	gx
->
d”ef
(
j_¬¿y
);

291 
	gnoj
 = 
Ãw
 
ObjeùJsÚ
;

292 ià(
	gu_
.
	gx
.
	gty³
 < 0)

293 
	gu_
.
	g¡r
.
d”ef
();

295 
	gu_
.
	go
.
	gx
 = 
noj
;

296 
	gu_
.
	go
.
	gty³
 = 
j_objeù
;

299 
	gJsÚ
::
ş—r
() {

300 
¡©ic_as£¹
(
off£tof
(
»p_ty³
, 
i
.
ty³
è=ğoff£tofÔ•_ty³, 
x
.type), "odd Json::rep_type.i.type offset");

301 
¡©ic_as£¹
(
off£tof
(
»p_ty³
, 
u
.
ty³
è=ğoff£tofÔ•_ty³, 
x
.type), "odd Json::rep_type.u.type offset");

302 
¡©ic_as£¹
(
off£tof
(
»p_ty³
, 
d
.
ty³
è=ğoff£tofÔ•_ty³, 
x
.type), "odd Json::rep_type.d.type offset");

303 
¡©ic_as£¹
(
off£tof
(
»p_ty³
, 
¡r
.
memo_off£t
è=ğoff£tofÔ•_ty³, 
x
.
ty³
), "odd Json::rep_type.str.memo_offset offset");

304 
¡©ic_as£¹
(
off£tof
(
»p_ty³
, 
a
.
ty³
è=ğoff£tofÔ•_ty³, 
x
.type), "odd Json::rep_type.a.type offset");

305 
¡©ic_as£¹
(
off£tof
(
»p_ty³
, 
o
.
ty³
è=ğoff£tofÔ•_ty³, 
x
.type), "odd Json::rep_type.o.type offset");

307 ià(
	gu_
.
	gx
.
	gty³
 =ğ
j_¬¿y
) {

308 ià(
u_
.
a
.
x
 && u_.a.x->
»fcouÁ
 == 1) {

309 
JsÚ
* 
Ï¡
 = 
u_
.
a
.
x
->¨+ u_.a.x->
size
;

310 
JsÚ
* 
	g™
 = 
u_
.
a
.
x
->a; iˆ!ğ
Ï¡
; ++it)

311 
	g™
->~
JsÚ
();

312 
	gu_
.
	ga
.
	gx
->
	gsize
 = 0;

313 } ià(
	gu_
.
	ga
.
	gx
) {

314 
	gu_
.
	ga
.
	gx
->
d”ef
(
j_¬¿y
);

315 
	gu_
.
	ga
.
	gx
 = 0;

317 } ià(
	gu_
.
	gx
.
	gty³
 =ğ
j_objeù
) {

318 ià(
u_
.
o
.
x
 && u_.o.x->
»fcouÁ
 == 1) {

319 
ObjeùI‹m
* 
Ï¡
 = 
u_
.
o
.
x
->
os_
 + u_.o.x->
n_
;

320 
ObjeùI‹m
* 
	g™
 = 
u_
.
o
.
x
->
os_
; iˆ!ğ
Ï¡
; ++it)

321 ià(
	g™
->
	gÃxt_
 != -2)

322 
™
->~
ObjeùI‹m
();

323 
	gu_
.
	go
.
	gx
->
	gn_
 = 
u_
.
o
.
x
->
size
 = 0;

324 
	gu_
.
	go
.
	gx
->
	ghash_
.
assign
(
u_
.
o
.
x
->
hash_
.
size
(), -1);

325 } ià(
	gu_
.
	go
.
	gx
) {

326 
	gu_
.
	go
.
	gx
->
d”ef
(
j_objeù
);

327 
	gu_
.
	go
.
	gx
 = 0;

330 ià(
	gu_
.
	gx
.
	gty³
 < 0)

331 
	gu_
.
	g¡r
.
d”ef
();

332 
mem£t
(&
u_
, 0, (u_));

336 * 
	gJsÚ
::
uniqueify_¬¿y_š£¹
(
boŞ
 
cÚv”t
, 
size_ty³
 
pos
) {

337 
size_ty³
 
	gsize
 = 
u_
.
a
.
x
 ? u_.a.x->
size
 : 0;

338 
uniqueify_¬¿y
(
cÚv”t
, 
size
 + 1);

339 ià(
	gpos
 =ğ(
size_ty³
) -1)

340 
pos
 = 
size
;

341 
´ecÚd™iÚ
(
pos
 >ğ0 &&…o <ğ
size
);

342 ià(
	gpos
 !ğ
size
)

343 
memmove
(&
u_
.
a
.
x
->a[
pos
 + 1], &u_.a.x->a[pos], (
size
 -…osè* (
JsÚ
));

344 ++
	gu_
.
	ga
.
	gx
->
	gsize
;

345  (*è&
	gu_
.
	ga
.
	gx
->a[
pos
];

348 
	gJsÚ
::
¬¿y_™”©Ü
 
JsÚ
::
”a£
×¼ay_™”©Ü 
fœ¡
,‡¼ay_™”©Ü 
Ï¡
) {

349 ià(
	gfœ¡
 < 
	gÏ¡
) {

350 
uniqueify_¬¿y
(
çl£
, 0);

351 
size_ty³
 
	gåos
 = 
fœ¡
 - 
abegš
();

352 
size_ty³
 
	gÍos
 = 
Ï¡
 - 
abegš
();

353 
size_ty³
 
	gsize
 = 
u_
.
a
.
x
->
size
;

354 
size_ty³
 
	gpos
 = 
åos
;…o !ğ
Íos
; ++pos)

355 
	gu_
.
	ga
.
	gx
->a[
pos
].~
JsÚ
();

356 ià(
	gÍos
 !ğ
size
)

357 
memmove
(&
u_
.
a
.
x
->a[
åos
], &u_.a.x->a[
Íos
],

358 (
size
 - 
Íos
è* (
JsÚ
));

359 
	gu_
.
	ga
.
	gx
->
	gsize
 -ğ
Íos
 - 
åos
;

361  
	gfœ¡
;

365 
	gJsÚ
::
»£rve
(
size_ty³
 
n
) {

366 
uniqueify_¬¿y
(
çl£
, 
n
);

370 
	gJsÚ
::
»size
(
size_ty³
 
n
) {

371 
uniqueify_¬¿y
(
çl£
, 
n
);

372 
	gu_
.
	ga
.
	gx
->
	gsize
 > 
	gn
 && u_.a.x->size > 0) {

373 --
	gu_
.
	ga
.
	gx
->
	gsize
;

374 
	gu_
.
	ga
.
	gx
->a[
u_
.
a
.
x
->
size
].~
JsÚ
();

376 
	gu_
.
	ga
.
	gx
->
	gsize
 < 
	gn
)

377 
push_back
(
JsÚ
());

383 
št64_t
 
	gJsÚ
::
h¬d_to_i
() const {

384 
u_
.
x
.
ty³
) {

385 
j_¬¿y
:

386 
j_objeù
:

387  
size
();

388 
	gj_boŞ
:

389 
j_št
:

390  
u_
.
i
.
x
;

391 
	gj_unsigÃd
:

392  
u_
.
u
.
x
;

393 
	gj_doubË
:

394  
št64_t
(
u_
.
d
.
x
);

395 
	gj_nuÎ
:

396 
j_¡ršg
:

398 ià(!
u_
.
x
.x)

400 
šv¬ŸÁ
(
u_
.
x
.
ty³
 <= 0);

401 cÚ¡ *
	gb
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
SŒšg
&>(
u_
.
¡r
).
c_¡r
();

402 *
	gs
;

403 #ià
SIZEOF_LONG
 >= 8

404 
	gx
 = 
¡¹Ş
(
b
, &
s
, 0);

406 
	gx
 = 
¡¹Şl
(
b
, &
s
, 0);

408 ià(
	gs
 =ğ
b
 + 
u_
.
¡r
.
Ëngth
)

409  
x
;

411  (è
¡¹od
(
b
, 0);

415 
ušt64_t
 
	gJsÚ
::
h¬d_to_u
() const {

416 
u_
.
x
.
ty³
) {

417 
j_¬¿y
:

418 
j_objeù
:

419  
size
();

420 
	gj_boŞ
:

421 
j_št
:

422  
u_
.
i
.
x
;

423 
	gj_unsigÃd
:

424  
u_
.
u
.
x
;

425 
	gj_doubË
:

426  
ušt64_t
(
u_
.
d
.
x
);

427 
	gj_nuÎ
:

428 
j_¡ršg
:

430 ià(!
u_
.
x
.x)

432 cÚ¡ * 
	gb
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
SŒšg
&>(
u_
.
¡r
).
c_¡r
();

433 *
	gs
;

434 #ià
SIZEOF_LONG
 >= 8

435 
	gx
 = 
¡¹oul
(
b
, &
s
, 0);

437 
	gx
 = 
¡¹ouÎ
(
b
, &
s
, 0);

439 ià(
	gs
 =ğ
b
 + 
u_
.
¡r
.
Ëngth
)

440  
x
;

442  (
	gušt64_t
è
¡¹od
(
b
, 0);

446 
	gJsÚ
::
h¬d_to_d
() const {

447 
u_
.
x
.
ty³
) {

448 
j_¬¿y
:

449 
j_objeù
:

450  
size
();

451 
	gj_boŞ
:

452 
j_št
:

453  
u_
.
i
.
x
;

454 
	gj_unsigÃd
:

455  
u_
.
u
.
x
;

456 
	gj_doubË
:

457  
u_
.
d
.
x
;

458 
	gj_nuÎ
:

459 
j_¡ršg
:

461 ià(!
u_
.
x
.x)

464  
¡¹od
(
»š‹½»t_ÿ¡
<cÚ¡ 
SŒšg
&>(
u_
.
¡r
).
c_¡r
(), 0);

468 
boŞ
 
	gJsÚ
::
h¬d_to_b
() const {

469 
u_
.
x
.
ty³
) {

470 
j_¬¿y
:

471 
j_objeù
:

472  !
em±y
();

473 
	gj_boŞ
:

474 
j_št
:

475 
j_unsigÃd
:

476  
u_
.
i
.
x
 != 0;

477 
	gj_doubË
:

478  
u_
.
d
.
x
;

479 
	gj_nuÎ
:

480 
j_¡ršg
:

482  
u_
.
¡r
.
Ëngth
 != 0;

486 
SŒšg
 
	gJsÚ
::
h¬d_to_s
() const {

487 
u_
.
x
.
ty³
) {

488 
j_¬¿y
:

489  
¬¿y_¡ršg
;

490 
	gj_objeù
:

491  
objeù_¡ršg
;

492 
	gj_boŞ
:

493  
SŒšg
(
boŞ
(
u_
.
i
.
x
));

494 
	gj_št
:

495  
SŒšg
(
u_
.
i
.
x
);

496 
	gj_unsigÃd
:

497  
SŒšg
(
u_
.
u
.
x
);

498 
	gj_doubË
:

499  
SŒšg
(
u_
.
d
.
x
);

500 
	gj_nuÎ
:

501 
j_¡ršg
:

503 ià(!
u_
.
x
.x)

504  
SŒšg
::
make_em±y
();

506  
SŒšg
(
u_
.
¡r
);

510 cÚ¡ 
	gJsÚ
& JsÚ::
h¬d_g‘
(
SŒ
 
key
) const {

511 
A¼ayJsÚ
 *
aj
;

512 
	gi
;

513 ià(
is_¬¿y
(è&& (
	gaj
 = 
ajsÚ
())

514 && 
¡ršg_to_št_key
(
key
.
begš
(), key.
’d
(), 
i
)

515 && 
	gi
 < (
	gaj
->
	gsize
))

516  
	gaj
->
	ga
[
i
];

518  
make_nuÎ
();

521 cÚ¡ 
	gJsÚ
& JsÚ::
h¬d_g‘
(
size_ty³
 
x
) const {

522 ià(
is_objeù
(è&& 
u_
.
o
.
x
)

523  
g‘
(
SŒšg
(
x
));

525  
make_nuÎ
();

528 
	gJsÚ
& JsÚ::
h¬d_g‘_š£¹
(
size_ty³
 
x
) {

529 ià(
is_objeù
())

530  
g‘_š£¹
(
SŒšg
(
x
));

532 
uniqueify_¬¿y
(
Œue
, 
x
 + 1);

533 ià(
	gu_
.
	ga
.
	gx
->
	gsize
 <ğ
x
) {

534 
mem£t
(&
u_
.
a
.
x
->a[u_.a.x->
size
], 0, (
JsÚ
) * (x + 1 - u_.a.x->size));

535 
	gu_
.
	ga
.
	gx
->
	gsize
 = 
x
 + 1;

537  
	gu_
.
	ga
.
	gx
->a[
x
];

541 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
JsÚ
& 
a
, cÚ¡ 
	gJsÚ
& 
	gb
) {

542 ià((
	ga
.
	gu_
.
	gx
.
	gty³
 > 0 || 
	gb
.u_.x.type > 0)

543 && 
	ga
.
	gu_
.
	gx
.
	gty³
 !ğ
b
.
u_
.
x
.
ty³
)

544  
a
.
u_
.
u
.
x
 =ğ
b
.u_.u.x

545 && 
a
.
u_
.
i
.
x
 >= 0

546 && 
a
.
is_št
()

547 && 
b
.
is_št
();

548 ià(
	ga
.
	gu_
.
	gx
.
	gty³
 =ğ
JsÚ
::
j_št


549 || 
a
.
u_
.
x
.
ty³
 =ğ
JsÚ
::
j_unsigÃd


550 || 
a
.
u_
.
x
.
ty³
 =ğ
JsÚ
::
j_boŞ
)

551  
a
.
u_
.
u
.
x
 =ğ
b
.u_.u.x;

552 ià(
	ga
.
	gu_
.
	gx
.
	gty³
 =ğ
JsÚ
::
j_doubË
)

553  
a
.
u_
.
d
.
x
 =ğ
b
.u_.d.x;

554 ià(
	ga
.
	gu_
.
	gx
.
	gty³
 > 0 || !a.u_.x.x || !
	gb
.u_.x.x)

555  
	ga
.
	gu_
.
	gx
.x =ğ
b
.
u_
.
x
.x;

557  
SŒšg
(
a
.
u_
.
¡r
è=ğSŒšg(
b
.u_.str);

563 
	gJsÚ
::
uÅ¬£_mªuÏtÜ
 
JsÚ
::
deçuÉ_mªuÏtÜ
;

565 
boŞ
 
	gJsÚ
::
uÅ¬£_is_com¶ex
() const {

566 ià(
is_objeù
()) {

567 ià(
ObjeùJsÚ
 *
oj
 = 
ojsÚ
()) {

568 ià(
oj
->
size
 > 5)

569  
Œue
;

570 
ObjeùI‹m
 *
	gob
 = 
oj
->
os_
, *
	gÛ
 = 
ob
 + oj->
n_
;

571 ; 
	gob
 !ğ
Û
; ++ob)

572 ià(
	gob
->
	gÃxt_
 > -2 && !ob->
	gv_
.
	g£cÚd
.
em±y
(è&& !ob->v_.£cÚd.
is_´im™ive
())

573  
	gŒue
;

575 } ià(
is_¬¿y
()) {

576 ià(
A¼ayJsÚ
 *
	gaj
 = 
ajsÚ
()) {

577 ià(
aj
->
size
 > 1024)

578  
Œue
;

579 
JsÚ
* 
	g™
 = 
aj
->
a
; iˆ!ğaj->¨+‡j->
size
; ++it)

580 ià(!
	g™
->
em±y
()

581 && (!
	g™
->
is_´im™ive
()

582 || (
	g™
->
is_¡ršg
(è&& iˆ- 
	gaj
->
	ga
 >ğ4 && 
™
->
as_s
().
Ëngth
() > 40)))

583  
Œue
;

586  
	gçl£
;

589 
	gJsÚ
::
uÅ¬£_šd’t
(
SŒšgAccum
 &
§
, cÚ¡ 
uÅ¬£_mªuÏtÜ
 &
m
, 
d•th
)

591 
	g§
 << '\n';

592 
	gd•th
 *ğ(
m
.
b_width
() ? m.tab_width() : 8);

593 
	g§
.
­³nd_fl
('\t', 
d•th
 / 8);

594 
	g§
.
­³nd_fl
(' ', 
d•th
 % 8);

597 
	gÇme¥aû
 {

598 cÚ¡ * cÚ¡ 
	gupx_nÜm®
[] = {":", ","};

599 cÚ¡ * cÚ¡ 
	gupx_ex·nded
[] = {": ", ","};

600 cÚ¡ * cÚ¡ 
	gupx_£·¿‹d
[] = {": ", ", "};

603 
	gJsÚ
::
h¬d_uÅ¬£
(
SŒšgAccum
 &
§
, cÚ¡ 
uÅ¬£_mªuÏtÜ
 &
m
, 
d•th
) const

605 ià(
is_objeù
(è|| 
is_¬¿y
()) {

606 
boŞ
 
	gex·nded
 = 
d•th
 < 
m
.
šd’t_d•th
(è&& 
uÅ¬£_is_com¶ex
();

607 cÚ¡ * cÚ¡* 
	gupx
;

608 ià(
	gex·nded
)

609 
	gupx
 = 
upx_ex·nded
;

610 ià(
	gm
.
¥aû_£·¿tÜ
())

611 
	gupx
 = 
upx_£·¿‹d
;

613 
	gupx
 = 
upx_nÜm®
;

615 ià(
is_objeù
(è&& !
	gu_
.
	gx
.x)

616 
	g§
 << "{}";

617 ià(
is_objeù
()) {

618 
	g§
 << '{';

619 
boŞ
 
	g»¡
 = 
çl£
;

620 
ObjeùJsÚ
 *
	goj
 = 
ojsÚ
();

621 
ObjeùI‹m
 *
	gob
 = 
oj
->
os_
, *
	gÛ
 = 
ob
 + oj->
n_
;

622 ; 
	gob
 !ğ
Û
; ++ob)

623 ià(
	gob
->
	gÃxt_
 > -2) {

624 ià(
	g»¡
)

625 
	g§
 << 
	gupx
[1];

626 ià(
	gex·nded
)

627 
uÅ¬£_šd’t
(
§
, 
m
, 
d•th
 + 1);

628 
	g§
 << '\"';

629 
	gob
->
	gv_
.
	gfœ¡
.
’code_jsÚ
(
§
);

630 
	g§
 << '\"' << 
	gupx
[0];

631 
	gob
->
	gv_
.
	g£cÚd
.
h¬d_uÅ¬£
(
§
, 
m
, 
d•th
 + 1);

632 
	g»¡
 = 
Œue
;

634 ià(
	gex·nded
)

635 
uÅ¬£_šd’t
(
§
, 
m
, 
d•th
);

636 
	g§
 << '}';

637 } ià(!
	gu_
.
	gx
.x)

638 
	g§
 << "[]";

640 
	g§
 << '[';

641 
boŞ
 
	g»¡
 = 
çl£
;

642 
A¼ayJsÚ
* 
	gaj
 = 
ajsÚ
();

643 
JsÚ
* 
	g™
 = 
aj
->
a
; iˆ!ğaj->¨+‡j->
size
; ++it) {

644 ià(
	g»¡
)

645 
	g§
 << 
	gupx
[1];

646 ià(
	gex·nded
)

647 
uÅ¬£_šd’t
(
§
, 
m
, 
d•th
 + 1);

648 
	g™
->
h¬d_uÅ¬£
(
§
, 
m
, 
d•th
 + 1);

649 
	g»¡
 = 
Œue
;

651 ià(
	gex·nded
)

652 
uÅ¬£_šd’t
(
§
, 
m
, 
d•th
);

653 
	g§
 << ']';

655 } ià(
	gu_
.
	gx
.
	gty³
 =ğ
j_nuÎ
 && !
u_
.
x
.x)

656 
§
.
­³nd
("null", 4);

657 ià(
	gu_
.
	gx
.
	gty³
 <= 0) {

658 
§
 << '\"';

659 
	g»š‹½»t_ÿ¡
<cÚ¡ 
	gSŒšg
&>(
	gu_
.
	g¡r
).
’code_jsÚ
(
§
);

660 
	g§
 << '\"';

661 } ià(
	gu_
.
	gx
.
	gty³
 =ğ
j_boŞ
) {

662 
boŞ
 
b
 = 
u_
.
i
.
x
;

663 
	g§
.
­³nd
(&"çl£\0Œue"[-
b
 & 6], 5 - b);

664 } ià(
	gu_
.
	gx
.
	gty³
 =ğ
j_št
)

665 
§
 << 
u_
.
i
.
x
;

666 ià(
	gu_
.
	gx
.
	gty³
 =ğ
j_unsigÃd
)

667 
§
 << 
u_
.
u
.
x
;

668 ià(
	gu_
.
	gx
.
	gty³
 =ğ
j_doubË
)

669 
§
 << 
u_
.
d
.
x
;

671 ià(
	gd•th
 =ğ0 && 
m
.
Ãwlše_‹rmš©Ü
())

672 
§
 << '\n';

676 
boŞ


677 
	gJsÚ
::
assign_·r£
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
, cÚ¡ 
SŒšg
& 
¡r
)

679 
usšg
 
	g¡d
::
sw­
;

680 
	gJsÚ
::
¡»amšg_·r£r
 
j¥
;

681 
	gfœ¡
 = 
j¥
.
cÚsume
(
fœ¡
, 
Ï¡
, 
¡r
, 
Œue
);

682 ià(
	gfœ¡
 !ğ
Ï¡
 && (*
fœ¡
 == ' ' || *first == '\n' || *first == '\r'

683 || *
fœ¡
 == '\t'))

684 ++
fœ¡
;

685 ià(
	gfœ¡
 =ğ
Ï¡
 && 
j¥
.
sucûss
()) {

686 
sw­
(
j¥
.
»suÉ
(), *
this
);

687  
	gŒue
;

689  
	gçl£
;

692 
šlše
 
boŞ
 
š_¿nge
(
ušt8_t
 
x
, 
low
, 
high
) {

693  (è
	gx
 - 
	glow
 < 
	ghigh
 -†ow;

696 
šlše
 
boŞ
 
š_¿nge
(
x
, 
low
, 
high
) {

697  (è
	gx
 - 
	glow
 < 
	ghigh
 -†ow;

700 
šlše
 cÚ¡ 
ušt8_t
* 
	gJsÚ
::
¡»amšg_·r£r
::
”rÜ_©
(cÚ¡ ušt8_t* 
h”e
) {

701 
¡©e_
 = 
¡_”rÜ
;

702  
	gh”e
;

705 
šlše
 
JsÚ
* 
	gJsÚ
::
¡»amšg_·r£r
::
cu¼’t
() {

706  
¡ack_
.
em±y
(è? &
jsÚ_
 : sck_.
back
();

709 cÚ¡ 
ušt8_t
*

710 
	gJsÚ
::
¡»amšg_·r£r
::
cÚsume
(cÚ¡ 
ušt8_t
* 
fœ¡
,

711 cÚ¡ 
ušt8_t
* 
Ï¡
,

712 cÚ¡ 
SŒšg
& 
¡r
,

713 
boŞ
 
com¶‘e
) {

714 
usšg
 
	g¡d
::
sw­
;

715 
JsÚ
 
	gj
;

717 ià(
	g¡©e_
 >ğ0 && (
¡©e_
 & 
¡_·¹mask
)) {

718 ià((
¡©e_
 & 
¡_¡ršg·¹
è&& s‹_ >ğ
¡_objeù_cŞÚ
)

719 
¡ršg_objeù_key
;

720 ià(
	g¡©e_
 & 
	g¡_¡ršg·¹
)

721 
	g¡ršg_v®ue
;

722 ià(
	g¡©e_
 & 
	g¡_´im™iv•¬t
)

723 
	g´im™ive
;

725 
	gnumb”
;

728 
	g¡©e_
 >ğ0 && 
fœ¡
 !ğ
Ï¡
)

729 *
fœ¡
) {

734 
fœ¡
 !ğ
Ï¡
 && *first <= 32

735 && (*
fœ¡
 == ' ' || *first == '\n' || *first == '\r'

736 || *
fœ¡
 == '\t'))

737 ++
fœ¡
;

741 ià(
¡©e_
 =ğ
¡_¬¿y_d–im
)

742 
¡©e_
 = 
¡_¬¿y_v®ue
;

743 ià(
	g¡©e_
 =ğ
¡_objeù_d–im
)

744 
¡©e_
 = 
¡_objeù_key
;

746 
	g”rÜ_h”e
;

747 ++
	gfœ¡
;

751 ià(
¡©e_
 =ğ
¡_objeù_cŞÚ
) {

752 
¡©e_
 = 
¡_objeù_v®ue
;

753 ++
	gfœ¡
;

756 
	g”rÜ_h”e
;

759 ià(
¡©e_
 <ğ
¡_objeù_v®ue
) {

760 ià(
¡ack_
.
size
(è=ğ
max_d•th
)

761 
”rÜ_h”e
;

762 ++
	gfœ¡
;

763 ià(
	g¡©e_
 =ğ
¡_š™Ÿl
 && 
jsÚ_
.
is_o
()) {

764 
sw­
(
j
, 
jsÚ_
);

765 
	gj
.
ş—r
();

767 
	gj
 = 
JsÚ
::
make_objeù
();

768 
	gv®ue
;

770 
	g”rÜ_h”e
;

773 ià(
¡©e_
 =ğ
¡_objeù_š™Ÿl
 || s‹_ =ğ
¡_objeù_d–im
) {

774 ++
fœ¡
;

775 
	gşo£_v®ue
;

777 
	g”rÜ_h”e
;

780 ià(
¡©e_
 <ğ
¡_objeù_v®ue
) {

781 ià(
¡ack_
.
size
(è=ğ
max_d•th
)

782 
”rÜ_h”e
;

783 ++
	gfœ¡
;

784 ià(
	g¡©e_
 =ğ
¡_š™Ÿl
 && 
jsÚ_
.
is_a
()) {

785 
sw­
(
j
, 
jsÚ_
);

786 
	gj
.
ş—r
();

788 
	gj
 = 
JsÚ
::
make_¬¿y
();

789 
	gv®ue
;

791 
	g”rÜ_h”e
;

794 ià(
¡©e_
 =ğ
¡_¬¿y_š™Ÿl
 || s‹_ =ğ
¡_¬¿y_d–im
) {

795 ++
fœ¡
;

796 
	gşo£_v®ue
;

798 
	g”rÜ_h”e
;

801 ià(
¡©e_
 <ğ
¡_objeù_v®ue
) {

802 
¡r_
 = 
SŒšg
();

803 ++
	gfœ¡
;

804 
	g¡ršg_v®ue
:

805 
fœ¡
 = 
cÚsume_¡ršg
(fœ¡, 
Ï¡
, 
¡r
);

806 ià(
	g¡©e_
 >ğ0 && !(
¡©e_
 & 
¡_¡ršg·¹
)) {

807 
j
 = 
JsÚ
(
¡d
::
move
(
¡r_
));

808 
	gv®ue
;

810 } ià(
	g¡©e_
 =ğ
¡_objeù_š™Ÿl
 || 
¡©e_
 =ğ
¡_objeù_key
) {

811 
¡©e_
 = 
¡_objeù_cŞÚ
;

812 
	g¡r_
 = 
SŒšg
();

813 ++
	gfœ¡
;

814 
	g¡ršg_objeù_key
:

815 
fœ¡
 = 
cÚsume_¡ršg
(fœ¡, 
Ï¡
, 
¡r
);

816 ià(
	g¡©e_
 >ğ0 && !(
¡©e_
 & 
¡_¡ršg·¹
)) {

817 
¡ack_
.
push_back
(&
cu¼’t
()->
g‘_š£¹
(
¡d
::
move
(
¡r_
)));

821 
	g”rÜ_h”e
;

827 ià(
¡©e_
 <ğ
¡_objeù_v®ue
) {

828 
´im™ive
:

829 
fœ¡
 = 
cÚsume_´im™ive
(fœ¡, 
Ï¡
, 
j
);

830 ià(
	g¡©e_
 >ğ0 && !(
¡©e_
 & 
¡_´im™iv•¬t
))

831 
v®ue
;

833 
	g”rÜ_h”e
;

847 ià(
¡©e_
 <ğ
¡_objeù_v®ue
) {

848 
numb”
:

849 
fœ¡
 = 
cÚsume_numb”
(fœ¡, 
Ï¡
, 
¡r
, 
com¶‘e
, 
j
);

850 ià(
	g¡©e_
 >ğ0 && !(
¡©e_
 & 
¡_numb”·¹
))

851 
v®ue
;

853 
	g”rÜ_h”e
;

857 
”rÜ_h”e
:

858  
”rÜ_©
(
fœ¡
);

860 
	gv®ue
: {

861 
JsÚ
* 
jp
 = 
cu¼’t
();

862 ià(
	g¡©e_
 !ğ
¡_š™Ÿl
 && 
jp
->
is_a
()) {

863 
jp
->
push_back
(
¡d
::
move
(
j
));

864 
	gjp
 = &
jp
->
back
();

866 
sw­
(*
jp
, 
j
);

868 ià(
	g¡©e_
 =ğ
¡_objeù_v®ue
)

869 
¡ack_
.
pİ_back
();

870 ià(
	gjp
->
is_a
(è|| jp->
is_o
()) {

871 ià(
	g¡©e_
 !ğ
¡_š™Ÿl
)

872 
¡ack_
.
push_back
(
jp
);

873 
	g¡©e_
 = 
jp
->
is_a
(è? 
¡_¬¿y_š™Ÿl
 : 
¡_objeù_š™Ÿl
;

874 } ià(
	g¡©e_
 =ğ
¡_objeù_v®ue
)

875 
¡©e_
 = 
¡_objeù_d–im
;

876 ià(
	g¡©e_
 =ğ
¡_¬¿y_š™Ÿl
 || 
¡©e_
 =ğ
¡_¬¿y_v®ue
)

877 
¡©e_
 = 
¡_¬¿y_d–im
;

879 
	g¡©e_
 = 
¡_fš®
;

880  
	gfœ¡
;

885 
	gşo£_v®ue
:

886 ià(
¡ack_
.
em±y
()) {

887 
¡©e_
 = 
¡_fš®
;

888  
	gfœ¡
;

890 
	g¡ack_
.
pİ_back
();

891 
	g¡©e_
 = 
cu¼’t
()->
is_a
(è? 
¡_¬¿y_d–im
 : 
¡_objeù_d–im
;

896  
	gfœ¡
;

899 cÚ¡ 
ušt8_t
*

900 
	gJsÚ
::
¡»amšg_·r£r
::
cÚsume_¡ršg
(cÚ¡ 
ušt8_t
* 
fœ¡
,

901 cÚ¡ 
ušt8_t
* 
Ï¡
,

902 cÚ¡ 
SŒšg
& 
¡r
) {

903 
SŒšgAccum
 
	g§
 = SŒšgAccum::
make_Œªsãr
(
¡r_
);

905 ià(
uÆik–y
(
¡©e_
 & 
¡_·¹Ënmask
)) {

906 
	gfœ¡
 = 
cÚsume_¡ršg·¹
(
§
, 
fœ¡
, 
Ï¡
);

907 ià(
	g¡©e_
 =ğ
¡_”rÜ
)

908  
fœ¡
;

911 cÚ¡ 
ušt8_t
* 
	g´ev
 = 
fœ¡
;

912 
	gfœ¡
 !ğ
Ï¡
) {

913 ià(
lik–y
(
š_¿nge
(*
fœ¡
, 32, 128)) && *first != '\\' && *first != '\"')

914 ++
fœ¡
;

915 ià(*
	gfœ¡
 == '\\') {

916 
§
.
­³nd
(
´ev
, 
fœ¡
);

917 
	g´ev
 = 
fœ¡
 = 
cÚsume_back¦ash
(
§
, fœ¡, 
Ï¡
);

918 ià(
	g¡©e_
 =ğ
¡_”rÜ
)

919  
fœ¡
;

920 } ià(*
	gfœ¡
 == '\"')

922 ià(
uÆik–y
(!
š_¿nge
(*
fœ¡
, 0xC2, 0xF5)))

923  
”rÜ_©
(
fœ¡
);

925 
	gwªt
 = 2 + (*
fœ¡
 >= 0xE0) + (*first >= 0xF0);

926 
	gn
 = 
Ï¡
 - 
fœ¡
 < 
wªt
 ?†ast - first : want;

927 ià((
	gn
 > 1 && 
uÆik–y
(!
š_¿nge
(
fœ¡
[1], 0x80, 0xC0)))

928 || (*
	gfœ¡
 >= 0xE0

929 && ((*
fœ¡
 == 0xE0 && first[1] < 0xA0)

930 || (*
fœ¡
 == 0xED && first[1] >= 0xA0)

931 || (*
fœ¡
 == 0xF0 && first[1] < 0x90)

932 || (*
fœ¡
 == 0xF4 && first[1] >= 0x90)

934  
”rÜ_©
(
fœ¡
 + 1);

935 ià(
	gn
 > 2 && 
uÆik–y
(!
š_¿nge
(
fœ¡
[2], 0x80, 0xC0)))

936  
”rÜ_©
(
fœ¡
 + 2);

937 ià(
	gn
 > 3 && 
uÆik–y
(!
š_¿nge
(
fœ¡
[3], 0x80, 0xC0)))

938  
”rÜ_©
(
fœ¡
 + 3);

939 
	gfœ¡
 +ğ
n
;

940 ià(
	gn
 !ğ
wªt
) {

941 
¡©e_
 |ğ
n
;

947 ià(!
	g§
.
em±y
(è|| 
	gfœ¡
 =ğ
Ï¡
)

948 
§
.
­³nd
(
´ev
, 
fœ¡
);

949 ià(
	gfœ¡
 !ğ
Ï¡
) {

950 ià(!
§
.
em±y
())

951 
¡r_
 = 
§
.
ke_¡ršg
();

952 ià(
	g´ev
 >ğ
¡r
.
ubegš
(è&& 
fœ¡
 <ğ¡r.
u’d
())

953 
¡r_
 = 
¡r
.
ç¡_sub¡ršg
(
´ev
, 
fœ¡
);

955 
	g¡r_
 = 
SŒšg
(
´ev
, 
fœ¡
);

956 
	g¡©e_
 &ğ~
¡_¡ršg·¹
;

957  
	gfœ¡
 + 1;

959 
	g¡©e_
 |ğ
¡_¡ršg·¹
;

960 
	g¡r_
 = 
§
.
ke_¡ršg
();

961  
	gfœ¡
;

965 cÚ¡ 
ušt8_t
*

966 
	gJsÚ
::
¡»amšg_·r£r
::
cÚsume_¡ršg·¹
(
SŒšgAccum
& 
§
,

967 cÚ¡ 
ušt8_t
* 
fœ¡
,

968 cÚ¡ 
ušt8_t
* 
Ï¡
) {

969 (
	g¡©e_
 & 
	g¡_·¹Ënmask
è&& 
	gfœ¡
 !ğ
Ï¡
) {

970 
·¹
 = 
¡©e_
 & 
¡_·¹Ënmask
;

971 
ušt8_t
 
	gg
 = 
§
[§.
Ëngth
(è- 
·¹
];

972 ià((
	gg
 !ğ'\\' && (*
fœ¡
 & 0xC0) != 0x80)

973 || (
g
 =ğ'\\' && 
·¹
 =ğ6 && *
fœ¡
 != '\\')

974 || (
g
 =ğ'\\' && 
·¹
 =ğ7 && *
fœ¡
 != 'u')

975 || (
g
 =ğ'\\' && 
·¹
 != 1 &&…art != 6 &&…art != 7

976 && !
isxdig™
(*
fœ¡
))) {

977 
¡©e_
 = 
¡_”rÜ
;

980 
	g§
.
­³nd
(*
fœ¡
);

981 ià((
	gg
 !ğ'\\' && 
·¹
 =ğ1 + (
g
 >= 0xE0) + (tag >= 0xF0))

982 || (
g
 =ğ'\\' && (
·¹
 == 1 ||…art == 5 ||…art == 11))) {

983 
ušt8_t
 
buf
[12];

984 
memıy
(
buf
, 
§
.
’d
(è- 
·¹
 - 1,…art + 1);

985 
	g§
.
adju¡_Ëngth
(-
·¹
 - 1);

986 
	g¡©e_
 -ğ
¡_¡ršg·¹
 | 
·¹
;

987 
	g¡r_
 = 
§
.
ke_¡ršg
();

988 (è
cÚsume_¡ršg
(
buf
, buà+ 
·¹
 + 1, 
SŒšg
());

989 ià(
	g¡©e_
 =ğ
¡_”rÜ
)

991 
	g§
 = 
SŒšgAccum
::
make_Œªsãr
(
¡r_
);

993 ++
	g¡©e_
;

994 ++
	gfœ¡
;

996  
	gfœ¡
;

999 cÚ¡ 
ušt8_t
*

1000 
	gJsÚ
::
¡»amšg_·r£r
::
cÚsume_back¦ash
(
SŒšgAccum
& 
§
,

1001 cÚ¡ 
ušt8_t
* 
fœ¡
,

1002 cÚ¡ 
ušt8_t
* 
Ï¡
) {

1003 cÚ¡ 
ušt8_t
* 
	g´ev
 = 
fœ¡
;

1004 
	gch
 = 0;

1006 ià(
	gfœ¡
 + 1 =ğ
Ï¡
)

1007 
šcom¶‘e
;

1008 ià(
	gfœ¡
[1] =ğ'\"' || 
fœ¡
[1] == '\\' || first[1] == '/')

1009 
ch
 = 
fœ¡
[1];

1010 ià(
	gfœ¡
[1] == 'b')

1011 
ch
 = '\b';

1012 ià(
	gfœ¡
[1] == 'f')

1013 
ch
 = '\f';

1014 ià(
	gfœ¡
[1] == 'n')

1015 
ch
 = '\n';

1016 ià(
	gfœ¡
[1] == 'r')

1017 
ch
 = '\r';

1018 ià(
	gfœ¡
[1] == 't')

1019 
ch
 = '\t';

1020 ià(
	gfœ¡
[1] == 'u') {

1021 
i
 = 2; 
	gi
 < 6; ++i) {

1022 ià(
	gfœ¡
 + 
	gi
 =ğ
Ï¡
)

1023 
šcom¶‘e
;

1024 ià(
š_¿nge
(
fœ¡
[
i
], '0', '9' + 1))

1025 
	gch
 = 16 * 
ch
 + 
fœ¡
[
i
] - '0';

1026 ià(
š_¿nge
(
fœ¡
[
i
], 'A', 'F' + 1))

1027 
	gch
 = 16 * 
ch
 + 
fœ¡
[
i
] - 'A' + 10;

1028 ià(
š_¿nge
(
fœ¡
[
i
], 'a', 'f' + 1))

1029 
	gch
 = 16 * 
ch
 + 
fœ¡
[
i
] - 'a' + 10;

1031  
”rÜ_©
(&
fœ¡
[
i
]);

1033 
	gfœ¡
 += 4;

1035 ià(
uÆik–y
(
š_¿nge
(
ch
, 0xD800, 0xE000))) {

1036 ià(
	gch
 >= 0xDC00)

1037  
”rÜ_©
(&
fœ¡
[1]);

1038 ià(
	gfœ¡
 + 2 =ğ
Ï¡
)

1039 
šcom¶‘e
;

1040 ià(
	gfœ¡
[2] != '\\')

1041  
”rÜ_©
(&
fœ¡
[2]);

1042 ià(
	gfœ¡
 + 3 =ğ
Ï¡
)

1043 
šcom¶‘e
;

1044 ià(
	gfœ¡
[3] != 'u')

1045  
”rÜ_©
(&
fœ¡
[3]);

1046 
	gch2
 = 0;

1047 
	gi
 = 4; i < 8; ++i) {

1048 ià(
	gfœ¡
 + 
	gi
 =ğ
Ï¡
)

1049 
šcom¶‘e
;

1050 ià(
š_¿nge
(
fœ¡
[
i
], '0', '9' + 1))

1051 
	gch2
 = 16 * 
ch2
 + 
fœ¡
[
i
] - '0';

1052 ià(
š_¿nge
(
fœ¡
[
i
], 'A', 'F' + 1))

1053 
	gch2
 = 16 * 
ch2
 + 
fœ¡
[
i
] - 'A' + 10;

1054 ià(
š_¿nge
(
fœ¡
[
i
], 'A', 'F' + 1))

1055 
	gch2
 = 16 * 
ch2
 + 
fœ¡
[
i
] - 'a' + 10;

1057  
”rÜ_©
(&
fœ¡
[
i
]);

1059 ià(!
š_¿nge
(
ch2
, 0xDC00, 0xE000))

1060  
”rÜ_©
(&
fœ¡
[7]);

1061 
	gch
 = 0x10000 + (
ch
 - 0xD800è* 0x400 + (
ch2
 - 0xDC00);

1062 
	gfœ¡
 += 6;

1066 ià(!
	gch
 || !
	g§
.
­³nd_utf8
(
ch
))

1067  
”rÜ_©
(&
fœ¡
[1]);

1068  
	gfœ¡
 + 2;

1070 
	gšcom¶‘e
:

1071 
¡©e_
 |ğ
Ï¡
 - 
´ev
;

1072 
	g§
.
­³nd
(
´ev
, 
Ï¡
);

1073  
	gÏ¡
;

1076 cÚ¡ 
ušt8_t
*

1077 
	gJsÚ
::
¡»amšg_·r£r
::
cÚsume_´im™ive
(cÚ¡ 
ušt8_t
* 
fœ¡
,

1078 cÚ¡ 
ušt8_t
* 
Ï¡
,

1079 
JsÚ
& 
j
) {

1080 cÚ¡ * 
	gt
 = "null\0false\0true";

1081 
	gn
;

1082 ià(
uÆik–y
(
¡©e_
 & 
¡_´im™iv•¬t
)) {

1083 
	gn
 = 
¡©e_
 & 
¡_·¹Ënmask
;

1084 
	g¡©e_
 &ğ~
¡_·¹mask
;

1086 
	gn
 = (*
fœ¡
 == 'n' ? 1 : (*first == 'f' ? 6 : 12));

1087 ++
	gfœ¡
;

1090 ; 
	gfœ¡
 !ğ
Ï¡
 && 
t
[
n
]; ++
	gn
, ++first)

1091 ià(
	gt
[
n
] !ğ*
fœ¡
)

1092  
”rÜ_©
(
fœ¡
);

1094 ià(
	gt
[
n
])

1095 
	g¡©e_
 |ğ
¡_´im™iv•¬t
 | 
n
;

1096 ià(
	gn
 == 4)

1097 
j
 = 
JsÚ
();

1098 ià(
	gn
 == 10)

1099 
j
 = 
JsÚ
(
çl£
);

1101 
	gj
 = 
JsÚ
(
Œue
);

1102  
	gfœ¡
;

1105 cÚ¡ 
ušt8_t
*

1106 
	gJsÚ
::
¡»amšg_·r£r
::
cÚsume_numb”
(cÚ¡ 
ušt8_t
* 
fœ¡
,

1107 cÚ¡ 
ušt8_t
* 
Ï¡
,

1108 cÚ¡ 
SŒšg
& 
¡r
,

1109 
boŞ
 
com¶‘e
,

1110 
JsÚ
& 
j
) {

1111 cÚ¡ 
ušt8_t
* 
	g´ev
 = 
fœ¡
;

1112 
	gpos™iÚ
 = 
¡©e_
 & 
¡_·¹Ënmask
;

1114 
	gpos™iÚ
) {

1116 ià(*
fœ¡
 == '-')

1117 ++
fœ¡
;

1120 ià(
fœ¡
 !ğ
Ï¡
 && *first == '0') {

1121 
pos™iÚ
 = 3;

1122 ++
	gfœ¡
;

1123 } ià(
	gfœ¡
 !ğ
Ï¡
 && 
š_¿nge
(*
fœ¡
, '1', '9' + 1)) {

1124 
	gpos™iÚ
 = 1;

1125 ++
	gfœ¡
;

1127 
fœ¡
 !ğ
Ï¡
 && 
š_¿nge
(*first, '0', '9' + 1))

1128 ++
	gfœ¡
;

1130 
	gpos™iÚ
 = 2;

1133 ià(
fœ¡
 !ğ
Ï¡
 && *first == '.') {

1134 ++
fœ¡
;

1135 
	gdecim®
;

1137 
	gmaybe_expÚ’t
:

1138 ià(
fœ¡
 !ğ
Ï¡
 && (*first == 'e' || *first == 'E')) {

1139 ++
fœ¡
;

1140 
	gexpÚ’t
;

1144 
	gdecim®
:

1146 
pos™iÚ
 = 4;

1147 ià(
	gfœ¡
 !ğ
Ï¡
 && 
š_¿nge
(*
fœ¡
, '0', '9' + 1)) {

1148 ++
	gfœ¡
;

1149 
	gpos™iÚ
 = 5;

1153 
fœ¡
 !ğ
Ï¡
 && 
š_¿nge
(*first, '0', '9' + 1))

1154 ++
	gfœ¡
;

1155 ià(
	gfœ¡
 !ğ
Ï¡
 && 
pos™iÚ
 == 5)

1156 
maybe_expÚ’t
;

1159 
	gexpÚ’t
:

1161 
pos™iÚ
 = 6;

1162 ià(
	gfœ¡
 !ğ
Ï¡
 && (*
fœ¡
 == '+' || *first == '-'))

1163 ++
fœ¡
;

1164 ià(
	gfœ¡
 =ğ
Ï¡
)

1168 
pos™iÚ
 = 8;

1169 ià(
	gfœ¡
 !ğ
Ï¡
 && 
š_¿nge
(*
fœ¡
, '0', '9' + 1)) {

1170 ++
	gfœ¡
;

1171 
	gpos™iÚ
 = 9;

1175 
fœ¡
 !ğ
Ï¡
 && 
š_¿nge
(*first, '0', '9' + 1))

1176 ++
	gfœ¡
;

1180 ià(
	gfœ¡
 !ğ
Ï¡
 || 
com¶‘e
) {

1181 ià(!(
pos™iÚ
 & 1))

1182 
”rÜ_h”e
;

1183 
	gÏ¡
 = 
fœ¡
;

1184 ià(
	g¡©e_
 & 
	g¡_·¹Ënmask
) {

1185 
	g¡r_
.
­³nd
(
´ev
, 
fœ¡
);

1186 
	g´ev
 = 
¡r_
.
ubegš
();

1187 
	gfœ¡
 = 
¡r_
.
u’d
();

1189 ià(
	g´ev
 + 1 =ğ
fœ¡
)

1190 
j
 = 
JsÚ
((*
´ev
 - '0'));

1191 ià(
	gpos™iÚ
 < 4) {

1192 
boŞ
 
	gÃg©ive
 = *
´ev
 == '-';

1193 
	g´ev
 +ğ(
Ãg©ive
);

1194 
ušt64_t
 
	gx
 = 0;

1195 
	g´ev
 !ğ
fœ¡
) {

1196 
x
 = (x * 10è+ *
´ev
 - '0';

1197 ++
	g´ev
;

1199 ià(
	gÃg©ive
)

1200 
	gj
 = 
JsÚ
(-
št64_t
(
x
));

1202 
	gj
 = 
JsÚ
(
x
);

1204 ià(!(
	g¡©e_
 & 
	g¡_·¹Ënmask
))

1205 
	g¡r_
 = 
SŒšg
(
´ev
, 
fœ¡
);

1206 
	gx
 = 
¡¹od
(
¡r_
.
c_¡r
(), 0);

1207 
	gj
 = 
JsÚ
(
x
);

1209 
	g¡©e_
 &ğ~
¡_·¹mask
;

1210 
	g¡r_
 = 
SŒšg
();

1211  
	gÏ¡
;

1214 ià(
	g¡©e_
 & 
	g¡_·¹mask
)

1215 
	g¡r_
.
­³nd
(
´ev
, 
fœ¡
);

1216 ià(
	g´ev
 >ğ
¡r
.
ubegš
(è&& 
fœ¡
 <ğ¡r.
u’d
())

1217 
¡r_
 = 
¡r
.
sub¡ršg
(
´ev
, 
fœ¡
);

1219 
	g¡r_
 = 
SŒšg
(
´ev
, 
fœ¡
);

1220 
	g¡©e_
 = (
¡©e_
 & ~
¡_·¹mask
è| 
¡_numb”·¹
 | 
pos™iÚ
;

1221  
	gfœ¡
;

1223 
	g”rÜ_h”e
:

1224 
¡r_
 = 
SŒšg
();

1225  
”rÜ_©
(
fœ¡
);

	@masstree-beta/json.hh

17 #iâdeà
JSON_HH


18 
	#JSON_HH


	)

19 
	~"¡¿ccum.hh
"

20 
	~"¡r.hh
"

21 
	~<veùÜ
>

22 
	~<ut™y
>

23 
	~<¡dlib.h
>

24 
Çme¥aû
 
	glcdf
 {

26 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
şass
 
	gJsÚ_´oxy_ba£
;

27 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
şass
 
	gJsÚ_objeù_´oxy
;

28 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
şass
 
	gJsÚ_objeù_¡r_´oxy
;

29 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
şass
 
	gJsÚ_¬¿y_´oxy
;

30 
şass
 
	gJsÚ_g‘_´oxy
;

32 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
size_t
 
	gS
 = (
SŒšg
::
»p_ty³
è- (
T
)>

33 
JsÚ_»p_™em
;

34 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gJsÚ_»p_™em
<T, 4> {

35 
T
 
	gx
;

36 
	gty³
;

38 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gJsÚ_»p_™em
<T, 8> {

39 
T
 
	gx
;

40 
	g·ddšg
;

41 
	gty³
;

44 şas 
	cJsÚ
 {

45 
	ejsÚ_ty³
 {

46 
	gj_¡ršg
 = -1, 
	gj_nuÎ
 = 0,

47 
	gj_¬¿y
 = 1, 
	gj_objeù
 = 2,

48 
	gj_št
 = 3, 
	gj_unsigÃd
 = 4, 
	gj_doubË
 = 5, 
	gj_boŞ
 = 6

51 
	gpublic
:

52 
	snuÎ_t
 {

53 
šlše
 
cÚ¡ex´
 
nuÎ_t
() { }

55 cÚ¡ 
nuÎ_t
 
	gnuÎ
;

56 cÚ¡ 
JsÚ
 
	gnuÎ_jsÚ
;

58 
	tsize_ty³
;

60 
	g¡d
::
	t·œ
<cÚ¡ 
	tSŒšg
, 
	tJsÚ
> 
	tobjeù_v®ue_ty³
;

61 
şass
 
	gobjeù_™”©Ü
;

62 
şass
 
	gcÚ¡_objeù_™”©Ü
;

64 
JsÚ
 
	t¬¿y_v®ue_ty³
;

65 
şass
 
	g¬¿y_™”©Ü
;

66 
şass
 
	gcÚ¡_¬¿y_™”©Ü
;

68 
şass
 
	g™”©Ü
;

69 
şass
 
	gcÚ¡_™”©Ü
;

71 
boŞ
 (
	tJsÚ
::*
	tun¥ecif›d_boŞ_ty³
)() const;

72 
şass
 
	guÅ¬£_mªuÏtÜ
;

73 
şass
 
	g¡»amšg_·r£r
;

76 
šlše
 
JsÚ
();

77 
šlše
 
JsÚ
(cÚ¡ JsÚ& 
x
);

78 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
šlše
 
JsÚ
(cÚ¡ 
JsÚ_´oxy_ba£
<
P
>& 
x
);

79 #ià
HAVE_CXX_RVALUE_REFERENCES


80 
šlše
 
JsÚ
(JsÚ&& 
x
);

82 
šlše
 
JsÚ
(cÚ¡ 
nuÎ_t
& 
x
);

83 
šlše
 
JsÚ
(
x
);

84 
šlše
 
JsÚ
(
x
);

85 
šlše
 
JsÚ
(
x
);

86 
šlše
 
JsÚ
(
x
);

87 
šlše
 
JsÚ
(
x
);

88 
šlše
 
JsÚ
(
x
);

89 
šlše
 
JsÚ
(
x
);

90 
šlše
 
JsÚ
(
boŞ
 
x
);

91 
šlše
 
JsÚ
(cÚ¡ 
SŒšg
& 
x
);

92 
šlše
 
JsÚ
(cÚ¡ 
¡d
::
¡ršg
& 
x
);

93 
šlše
 
JsÚ
(
SŒ
 
x
);

94 
šlše
 
JsÚ
(cÚ¡ * 
x
);

95 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
šlše
 
JsÚ
(cÚ¡ 
¡d
::
veùÜ
<
T
>& 
x
);

96 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
šlše
 
JsÚ
(
T
 
fœ¡
, T 
Ï¡
);

97 
	gšlše
 ~
JsÚ
();

99 
šlše
 cÚ¡ 
	gJsÚ
& 
make_nuÎ
();

100 
šlše
 
JsÚ
 
make_¬¿y
();

101 
šlše
 
JsÚ
 
make_¬¿y_»£rve
(
n
);

102 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

103 
šlše
 
JsÚ
 
¬¿y
(
Args
&&... 
»¡
);

104 
šlše
 
JsÚ
 
make_objeù
();

105 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

106 
šlše
 
JsÚ
 
objeù
(
Args
&&... 
»¡
);

107 
šlše
 
JsÚ
 
make_¡ršg
(cÚ¡ 
SŒšg
& 
x
);

108 
šlše
 
JsÚ
 
make_¡ršg
(cÚ¡ 
¡d
::
¡ršg
& 
x
);

109 
šlše
 
JsÚ
 
make_¡ršg
(cÚ¡ * 
s
, 
Ën
);

112 
šlše
 
boŞ
 
Œuthy
() const;

113 
šlše
 
boŞ
 
çlsy
() const;

114 
šlše
 
İ”©Ü
 
un¥ecif›d_boŞ_ty³
() const;

115 
šlše
 
boŞ
 
	gİ”©Ü
!() const;

117 
šlše
 
boŞ
 
is_nuÎ
() const;

118 
šlše
 
boŞ
 
is_št
() const;

119 
šlše
 
boŞ
 
is_i
() const;

120 
šlše
 
boŞ
 
is_unsigÃd
() const;

121 
šlše
 
boŞ
 
is_u
() const;

122 
šlše
 
boŞ
 
is_sigÃd
() const;

123 
šlše
 
boŞ
 
is_nÚÃgšt
() const;

124 
šlše
 
boŞ
 
is_doubË
() const;

125 
šlše
 
boŞ
 
is_d
() const;

126 
šlše
 
boŞ
 
is_numb”
() const;

127 
šlše
 
boŞ
 
is_n
() const;

128 
šlše
 
boŞ
 
is_boŞ
() const;

129 
šlše
 
boŞ
 
is_b
() const;

130 
šlše
 
boŞ
 
is_¡ršg
() const;

131 
šlše
 
boŞ
 
is_s
() const;

132 
šlše
 
boŞ
 
is_¬¿y
() const;

133 
šlše
 
boŞ
 
is_a
() const;

134 
šlše
 
boŞ
 
is_objeù
() const;

135 
šlše
 
boŞ
 
is_o
() const;

136 
šlše
 
boŞ
 
is_´im™ive
() const;

138 
šlše
 
boŞ
 
em±y
() const;

139 
šlše
 
size_ty³
 
size
() const;

140 
šlše
 
boŞ
 
sh¬ed
() const;

142 
ş—r
();

145 
šlše
 
št64_t
 
to_i
() const;

146 
šlše
 
ušt64_t
 
to_u
() const;

147 
šlše
 
ušt64_t
 
to_u64
() const;

148 
šlše
 
boŞ
 
to_i
(& 
x
) const;

149 
šlše
 
boŞ
 
to_i
(& 
x
) const;

150 
šlše
 
boŞ
 
to_i
(& 
x
) const;

151 
šlše
 
boŞ
 
to_i
(& 
x
) const;

152 
šlše
 
boŞ
 
to_i
(& 
x
) const;

153 
šlše
 
boŞ
 
to_i
(& 
x
) const;

154 
šlše
 
št64_t
 
as_i
() const;

155 
šlše
 
št64_t
 
as_i
(št64_ˆ
deçuÉ_v®ue
) const;

156 
šlše
 
ušt64_t
 
as_u
() const;

157 
šlše
 
ušt64_t
 
as_u
(ušt64_ˆ
deçuÉ_v®ue
) const;

159 
šlše
 
to_d
() const;

160 
šlše
 
boŞ
 
to_d
(& 
x
) const;

161 
šlše
 
as_d
() const;

162 
šlše
 
as_d
(
deçuÉ_v®ue
) const;

164 
šlše
 
boŞ
 
to_b
() const;

165 
šlše
 
boŞ
 
to_b
(boŞ& 
x
) const;

166 
šlše
 
boŞ
 
as_b
() const;

167 
šlše
 
boŞ
 
as_b
(boŞ 
deçuÉ_v®ue
) const;

169 
šlše
 
SŒšg
 
to_s
() const;

170 
šlše
 
boŞ
 
to_s
(
SŒ
& 
x
) const;

171 
šlše
 
boŞ
 
to_s
(
SŒšg
& 
x
) const;

172 
šlše
 
	gSŒšg
& 
as_s
();

173 
šlše
 cÚ¡ 
	gSŒšg
& 
as_s
() const;

174 
šlše
 cÚ¡ 
	gSŒšg
& 
as_s
(cÚ¡ 
SŒšg
& 
deçuÉ_v®ue
) const;

177 
šlše
 
size_ty³
 
couÁ
(
SŒ
 
key
) const;

178 
šlše
 cÚ¡ 
	gJsÚ
& 
g‘
(
SŒ
 
key
) const;

179 
šlše
 
	gJsÚ
& 
g‘_š£¹
(cÚ¡ 
SŒšg
& 
key
);

180 
šlše
 
	gJsÚ
& 
g‘_š£¹
(
SŒ
 
key
);

181 
šlše
 
	gJsÚ
& 
g‘_š£¹
(cÚ¡ * 
key
);

183 
šlše
 
g‘_i
(
SŒ
 
key
) const;

184 
šlše
 
g‘_d
(
SŒ
 
key
) const;

185 
šlše
 
boŞ
 
g‘_b
(
SŒ
 
key
) const;

186 
šlše
 
SŒšg
 
g‘_s
(
SŒ
 
key
) const;

188 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, 
JsÚ
& 
x
) const;

189 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, & 
x
) const;

190 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, & 
x
) const;

191 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, & 
x
) const;

192 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, & 
x
) const;

193 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, & 
x
) const;

194 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, & 
x
) const;

195 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, & 
x
) const;

196 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, 
boŞ
& 
x
) const;

197 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, SŒ& 
x
) const;

198 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, 
SŒšg
& 
x
) const;

200 cÚ¡ 
	gJsÚ
& 
	gİ”©Ü
[](
SŒ
 
	gkey
) const;

201 
šlše
 
	gJsÚ_objeù_´oxy
<
	gJsÚ
> 
	gİ”©Ü
[](cÚ¡ 
	gSŒšg
& 
	gkey
);

202 
šlše
 
	gJsÚ_objeù_¡r_´oxy
<
	gJsÚ
> 
	gİ”©Ü
[](cÚ¡ 
	g¡d
::
¡ršg
& 
key
);

203 
šlše
 
	gJsÚ_objeù_¡r_´oxy
<
	gJsÚ
> 
	gİ”©Ü
[](
SŒ
 
	gkey
);

204 
šlše
 
	gJsÚ_objeù_¡r_´oxy
<
	gJsÚ
> 
	gİ”©Ü
[](cÚ¡ * 
	gkey
);

206 
šlše
 cÚ¡ 
	gJsÚ
& 
©
(
SŒ
 
key
) const;

207 
šlše
 
	gJsÚ
& 
©_š£¹
(cÚ¡ 
SŒšg
& 
key
);

208 
šlše
 
	gJsÚ
& 
©_š£¹
(
SŒ
 
key
);

209 
šlše
 
	gJsÚ
& 
©_š£¹
(cÚ¡ * 
key
);

211 
šlše
 
	gJsÚ
& 
£t
(cÚ¡ 
SŒšg
& 
key
, 
JsÚ
 
v®ue
);

212 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

213 
šlše
 
	gJsÚ
& 
£t
(cÚ¡ 
SŒšg
& 
key
, cÚ¡ 
JsÚ_´oxy_ba£
<
P
>& 
v®ue
);

214 
šlše
 
	gJsÚ
& 
un£t
(
SŒ
 
key
);

216 
šlše
 
	gJsÚ
& 
£t_li¡
();

217 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

218 
šlše
 
	gJsÚ
& 
£t_li¡
(cÚ¡ 
SŒšg
& 
key
, 
T
 
v®ue
, 
Args
&&... 
»¡
);

220 
šlše
 
	g¡d
::
·œ
<
objeù_™”©Ü
, 
	gboŞ
> 
š£¹
(cÚ¡ 
objeù_v®ue_ty³
& 
x
);

221 
šlše
 
objeù_™”©Ü
 
š£¹
(objeù_™”©Ü 
pos™iÚ
,

222 cÚ¡ 
objeù_v®ue_ty³
& 
x
);

223 
šlše
 
objeù_™”©Ü
 
”a£
(objeù_™”©Ü 
™
);

224 
šlše
 
size_ty³
 
”a£
(
SŒ
 
key
);

226 
šlše
 
	gJsÚ
& 
m”ge
(cÚ¡ 
JsÚ
& 
x
);

227 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
šlše
 
	gJsÚ
& 
m”ge
(cÚ¡ 
JsÚ_´oxy_ba£
<
P
>& 
x
);

230 
šlše
 cÚ¡ 
	gJsÚ
& 
g‘
(
size_ty³
 
x
) const;

231 
šlše
 
	gJsÚ
& 
g‘_š£¹
(
size_ty³
 
x
);

233 
šlše
 cÚ¡ 
	gJsÚ
& 
	gİ”©Ü
[](
size_ty³
 
	gx
) const;

234 
šlše
 
	gJsÚ_¬¿y_´oxy
<
	gJsÚ
> 
	gİ”©Ü
[](
size_ty³
 
	gx
);

236 
šlše
 cÚ¡ 
	gJsÚ
& 
©
(
size_ty³
 
x
) const;

237 
šlše
 
	gJsÚ
& 
©_š£¹
(
size_ty³
 
x
);

239 
šlše
 cÚ¡ 
	gJsÚ
& 
back
() const;

240 
šlše
 
	gJsÚ
& 
back
();

242 
šlše
 
	gJsÚ
& 
push_back
(
JsÚ
 
x
);

243 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
šlše
 
	gJsÚ
& 
push_back
(cÚ¡ 
JsÚ_´oxy_ba£
<
P
>& 
x
);

244 
šlše
 
pİ_back
();

246 
šlše
 
	gJsÚ
& 
push_back_li¡
();

247 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

248 
šlše
 
	gJsÚ
& 
push_back_li¡
(
T
 
fœ¡
, 
Args
&&... 
»¡
);

250 
šlše
 
¬¿y_™”©Ü
 
š£¹
×¼ay_™”©Ü 
pos™iÚ
, 
JsÚ
 
x
);

251 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

252 
šlše
 
¬¿y_™”©Ü
 
š£¹
×¼ay_™”©Ü 
pos™iÚ
, cÚ¡ 
JsÚ_´oxy_ba£
<
P
>& 
x
);

253 
¬¿y_™”©Ü
 
”a£
×¼ay_™”©Ü 
fœ¡
,‡¼ay_™”©Ü 
Ï¡
);

254 
šlše
 
¬¿y_™”©Ü
 
”a£
×¼ay_™”©Ü 
pos™iÚ
);

256 
»£rve
(
size_ty³
 
n
);

257 
»size
(
size_ty³
 
n
);

259 
šlše
 
JsÚ
* 
¬¿y_d©a
();

260 
šlše
 cÚ¡ 
JsÚ
* 
¬¿y_d©a
() const;

261 
šlše
 cÚ¡ 
JsÚ
* 
¬¿y_cd©a
() const;

262 
šlše
 
JsÚ
* 
’d_¬¿y_d©a
();

263 
šlše
 cÚ¡ 
JsÚ
* 
’d_¬¿y_d©a
() const;

264 
šlše
 cÚ¡ 
JsÚ
* 
’d_¬¿y_cd©a
() const;

267 
šlše
 
cÚ¡_objeù_™”©Ü
 
obegš
() const;

268 
šlše
 
cÚ¡_objeù_™”©Ü
 
Ûnd
() const;

269 
šlše
 
objeù_™”©Ü
 
obegš
();

270 
šlše
 
objeù_™”©Ü
 
Ûnd
();

271 
šlše
 
cÚ¡_objeù_™”©Ü
 
cobegš
() const;

272 
šlše
 
cÚ¡_objeù_™”©Ü
 
cÛnd
() const;

274 
šlše
 
cÚ¡_¬¿y_™”©Ü
 
abegš
() const;

275 
šlše
 
cÚ¡_¬¿y_™”©Ü
 
«nd
() const;

276 
šlše
 
¬¿y_™”©Ü
 
abegš
();

277 
šlše
 
¬¿y_™”©Ü
 
«nd
();

278 
šlše
 
cÚ¡_¬¿y_™”©Ü
 
ÿbegš
() const;

279 
šlše
 
cÚ¡_¬¿y_™”©Ü
 
ÿ’d
() const;

281 
šlše
 
cÚ¡_™”©Ü
 
begš
() const;

282 
šlše
 
cÚ¡_™”©Ü
 
’d
() const;

283 
šlše
 
™”©Ü
 
begš
();

284 
šlše
 
™”©Ü
 
’d
();

285 
šlše
 
cÚ¡_™”©Ü
 
cbegš
() const;

286 
šlše
 
cÚ¡_™”©Ü
 
ûnd
() const;

289 
šlše
 
uÅ¬£_mªuÏtÜ
 
šd’t_d•th
(
x
);

290 
šlše
 
uÅ¬£_mªuÏtÜ
 
b_width
(
x
);

291 
šlše
 
uÅ¬£_mªuÏtÜ
 
Ãwlše_‹rmš©Ü
(
boŞ
 
x
);

292 
šlše
 
uÅ¬£_mªuÏtÜ
 
¥aû_£·¿tÜ
(
boŞ
 
x
);

294 
šlše
 
SŒšg
 
uÅ¬£
() const;

295 
šlše
 
SŒšg
 
uÅ¬£
(cÚ¡ 
uÅ¬£_mªuÏtÜ
& 
m
) const;

296 
šlše
 
uÅ¬£
(
SŒšgAccum
& 
§
) const;

297 
šlše
 
uÅ¬£
(
SŒšgAccum
& 
§
, cÚ¡ 
uÅ¬£_mªuÏtÜ
& 
m
) const;

300 
šlše
 
boŞ
 
assign_·r£
(cÚ¡ 
SŒšg
& 
¡r
);

301 
šlše
 
boŞ
 
assign_·r£
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

303 
šlše
 
JsÚ
 
·r£
(cÚ¡ 
SŒšg
& 
¡r
);

304 
šlše
 
JsÚ
 
·r£
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

307 
šlše
 
	gJsÚ
& 
	gİ”©Ü
=(cÚ¡ 
JsÚ
& 
x
);

308 #ià
HAVE_CXX_RVALUE_REFERENCES


309 
šlše
 
	gJsÚ
& 
	gİ”©Ü
=(
JsÚ
&& 
x
);

311 
šlše
 
	gJsÚ
& 
	gİ”©Ü
=(
x
);

312 
šlše
 
	gJsÚ
& 
	gİ”©Ü
=(
x
);

313 
šlše
 
	gJsÚ
& 
	gİ”©Ü
=(
x
);

314 
šlše
 
	gJsÚ
& 
	gİ”©Ü
=(
x
);

315 
šlše
 
	gJsÚ
& 
	gİ”©Ü
=(
x
);

316 
šlše
 
	gJsÚ
& 
	gİ”©Ü
=(
x
);

317 
šlše
 
	gJsÚ
& 
	gİ”©Ü
=(
x
);

318 
šlše
 
	gJsÚ
& 
	gİ”©Ü
=(
boŞ
 
x
);

319 
šlše
 
	gJsÚ
& 
	gİ”©Ü
=(cÚ¡ 
SŒšg
& 
x
);

320 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
šlše
 
	gJsÚ
& 
	gİ”©Ü
=(cÚ¡ 
JsÚ_´oxy_ba£
<
P
>& 
x
);

322 
šlše
 
	gJsÚ
& 
	gİ”©Ü
++();

323 
šlše
 
	gİ”©Ü
++();

324 
šlše
 
	gJsÚ
& 
	gİ”©Ü
--();

325 
šlše
 
	gİ”©Ü
--();

326 
šlše
 
	gJsÚ
& 
	gİ”©Ü
+=(
x
);

327 
šlše
 
	gJsÚ
& 
	gİ”©Ü
+=(
x
);

328 
šlše
 
	gJsÚ
& 
	gİ”©Ü
+=(
x
);

329 
šlše
 
	gJsÚ
& 
	gİ”©Ü
+=(
x
);

330 
šlše
 
	gJsÚ
& 
	gİ”©Ü
+=(
x
);

331 
šlše
 
	gJsÚ
& 
	gİ”©Ü
+=(
x
);

332 
šlše
 
	gJsÚ
& 
	gİ”©Ü
+=(
x
);

333 
šlše
 
	gJsÚ
& 
	gİ”©Ü
+=(cÚ¡ 
JsÚ
& 
x
);

334 
šlše
 
	gJsÚ
& 
	gİ”©Ü
-=(
x
);

335 
šlše
 
	gJsÚ
& 
	gİ”©Ü
-=(
x
);

336 
šlše
 
	gJsÚ
& 
	gİ”©Ü
-=(
x
);

337 
šlše
 
	gJsÚ
& 
	gİ”©Ü
-=(
x
);

338 
šlše
 
	gJsÚ
& 
	gİ”©Ü
-=(
x
);

339 
šlše
 
	gJsÚ
& 
	gİ”©Ü
-=(
x
);

340 
šlše
 
	gJsÚ
& 
	gİ”©Ü
-=(
x
);

341 
šlše
 
	gJsÚ
& 
	gİ”©Ü
-=(cÚ¡ 
JsÚ
& 
x
);

343 
ä›nd
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
JsÚ
& 
a
, cÚ¡ 
	gJsÚ
& 
	gb
);

345 
šlše
 
sw­
(
JsÚ
& 
x
);

347 
	g´iv©e
:

349 
¡_š™Ÿl
 = 0, 
	g¡_¬¿y_š™Ÿl
 = 1, 
	g¡_¬¿y_d–im
 = 2,

350 
	g¡_¬¿y_v®ue
 = 3, 
	g¡_objeù_š™Ÿl
 = 4, 
	g¡_objeù_d–im
 = 5,

351 
	g¡_objeù_key
 = 6, 
	g¡_objeù_cŞÚ
 = 7, 
	g¡_objeù_v®ue
 = 8,

352 
	gmax_d•th
 = 2048

355 
	sCom¶exJsÚ
 {

356 
	g»fcouÁ
;

357 
	gsize
;

358 
Com¶exJsÚ
()

359 : 
»fcouÁ
(1) {

361 
šlše
 
»f
();

362 
šlše
 
d”ef
(
jsÚ_ty³
 
j
);

363 
	g´iv©e
:

364 
Com¶exJsÚ
(cÚ¡ Com¶exJsÚ& 
x
);

367 
	gA¼ayJsÚ
;

368 
	gObjeùI‹m
;

369 
	gObjeùJsÚ
;

371 
	u»p_ty³
 {

372 
	gJsÚ_»p_™em
<
	gšt64_t
> 
	gi
;

373 
	gJsÚ_»p_™em
<
	gušt64_t
> 
	gu
;

374 
	gJsÚ_»p_™em
<> 
	gd
;

375 
	gSŒšg
::
»p_ty³
 
¡r
;

376 
	gJsÚ_»p_™em
<
	gA¼ayJsÚ
*> 
	ga
;

377 
	gJsÚ_»p_™em
<
	gObjeùJsÚ
*> 
	go
;

378 
	gJsÚ_»p_™em
<
	gCom¶exJsÚ
*> 
	gx
;

379 } 
	gu_
;

381 
šlše
 
d”ef
();

383 
šlše
 
ObjeùJsÚ
* 
ojsÚ
() const;

384 
šlše
 
A¼ayJsÚ
* 
ajsÚ
() const;

386 
št64_t
 
h¬d_to_i
() const;

387 
ušt64_t
 
h¬d_to_u
() const;

388 
h¬d_to_d
() const;

389 
boŞ
 
h¬d_to_b
() const;

390 
SŒšg
 
h¬d_to_s
() const;

391 
šlše
 
fÜû_numb”
();

392 
šlše
 
fÜû_doubË
();

393 
šlše
 
	gJsÚ
& 
add
(
x
);

394 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
šlše
 
	gJsÚ
& 
add
(
T
 
x
);

395 
šlše
 
	gJsÚ
& 
subŒaù
(
x
);

396 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
šlše
 
	gJsÚ
& 
subŒaù
(
T
 
x
);

398 cÚ¡ 
	gJsÚ
& 
h¬d_g‘
(
SŒ
 
key
) const;

399 cÚ¡ 
	gJsÚ
& 
h¬d_g‘
(
size_ty³
 
x
) const;

400 
	gJsÚ
& 
h¬d_g‘_š£¹
(
size_ty³
 
x
);

402 
šlše
 
uniqueify_objeù
(
boŞ
 
cÚv”t
);

403 
h¬d_uniqueify_objeù
(
boŞ
 
cÚv”t
);

404 
šlše
 
uniqueify_¬¿y
(
boŞ
 
cÚv”t
, 
nÿp
);

405 
h¬d_uniqueify_¬¿y
(
boŞ
 
cÚv”t
, 
nÿp
);

406 * 
uniqueify_¬¿y_š£¹
(
boŞ
 
cÚv”t
, 
size_ty³
 
pos
);

408 
uÅ¬£_mªuÏtÜ
 
	gdeçuÉ_mªuÏtÜ
;

409 
boŞ
 
uÅ¬£_is_com¶ex
() const;

410 
uÅ¬£_šd’t
(
SŒšgAccum
 &
§
, cÚ¡ 
uÅ¬£_mªuÏtÜ
 &
m
, 
d•th
);

411 
h¬d_uÅ¬£
(
SŒšgAccum
 &
§
, cÚ¡ 
uÅ¬£_mªuÏtÜ
 &
m
, 
d•th
) const;

413 
boŞ
 
assign_·r£
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
, cÚ¡ 
SŒšg
 &
¡r
);

415 
ä›nd
 
şass
 
	gobjeù_™”©Ü
;

416 
ä›nd
 
şass
 
	gcÚ¡_objeù_™”©Ü
;

417 
ä›nd
 
şass
 
	g¬¿y_™”©Ü
;

418 
ä›nd
 
şass
 
	gcÚ¡_¬¿y_™”©Ü
;

419 
ä›nd
 
JsÚ
 
	gİ”©Ü
+(
	gJsÚ
);

420 
ä›nd
 
JsÚ
 
	gİ”©Ü
-(
	gJsÚ
);

424 
	gJsÚ
::
A¼ayJsÚ
 : 
public
 
Com¶exJsÚ
 {

425 
ÿ·c™y
;

426 
JsÚ
 
	ga
[0];

428 
šlše
 
A¼ayJsÚ
(
ÿp
)

429 : 
ÿ·c™y
(
ÿp
) {

430 
size
 = 0;

432 
A¼ayJsÚ
* 
make
(
n
);

433 
de¡roy
(
A¼ayJsÚ
* 
a
);

436 
	gJsÚ
::
ObjeùI‹m
 {

437 
¡d
::
·œ
<cÚ¡ 
SŒšg
, 
	gJsÚ
> 
	gv_
;

438 
	gÃxt_
;

439 
ex¶ic™
 
ObjeùI‹m
(cÚ¡ 
SŒšg
 &
key
, cÚ¡ 
JsÚ
& 
v®ue
, 
Ãxt
)

440 : 
v_
(
key
, 
v®ue
), 
Ãxt_
(
Ãxt
) {

444 
	gJsÚ
::
ObjeùJsÚ
 : 
public
 
Com¶exJsÚ
 {

445 
ObjeùI‹m
 *
os_
;

446 
	gn_
;

447 
	gÿ·c™y_
;

448 
	g¡d
::
veùÜ
<> 
hash_
;

449 
ObjeùJsÚ
()

450 : 
os_
(), 
n_
(0), 
ÿ·c™y_
(0) {

451 
	gsize
 = 0;

453 
ObjeùJsÚ
(cÚ¡ ObjeùJsÚ& 
x
);

454 ~
ObjeùJsÚ
();

455 
grow
(
boŞ
 
cİy
);

456 
buck‘
(cÚ¡ * 
s
, 
Ën
) const {

457  
	gSŒšg
::
hashcode
(
s
, s + 
Ën
è& (
	ghash_
.
size
() - 1);

459 
	gObjeùI‹m
& 
™em
(
p
) const {

460  
	gos_
[
p
];

462 
fšd
(cÚ¡ * 
s
, 
Ën
) const {

463 ià(
	ghash_
.
size
()) {

464 
	gp
 = 
hash_
[
buck‘
(
s
, 
Ën
)];

465 
	gp
 >= 0) {

466 
ObjeùI‹m
 &
oi
 = 
™em
(
p
);

467 ià(
	goi
.
	gv_
.
	gfœ¡
.
equ®s
(
s
, 
Ën
))

468  
	gp
;

469 
	gp
 = 
oi
.
Ãxt_
;

474 
fšd_š£¹
(cÚ¡ 
SŒšg
& 
key
, cÚ¡ 
JsÚ
& 
v®ue
);

475 
šlše
 
	gJsÚ
& 
g‘_š£¹
(cÚ¡ 
SŒšg
& 
key
) {

476 
	gp
 = 
fšd_š£¹
(
key
, 
make_nuÎ
());

477  
™em
(
p
).
	gv_
.
	g£cÚd
;

479 
	gJsÚ
& 
g‘_š£¹
(
SŒ
 
key
);

480 
”a£
(
p
);

481 
size_ty³
 
”a£
(
SŒ
 
key
);

482 
»hash
();

485 
šlše
 cÚ¡ 
	gJsÚ
& JsÚ::
	$make_nuÎ
() {

486  
nuÎ_jsÚ
;

487 
	}
}

489 
šlše
 
	gJsÚ
::
Com¶exJsÚ
::
	$»f
() {

490 ià(
»fcouÁ
 >= 0)

491 ++
»fcouÁ
;

492 
	}
}

494 
šlše
 
	gJsÚ
::
Com¶exJsÚ
::
	$d”ef
(
jsÚ_ty³
 
j
) {

495 ià(
»fcouÁ
 >= 1 && --refcount == 0) {

496 ià(
j
 =ğ
j_objeù
)

497 
d–‘e
 
¡©ic_ÿ¡
<
ObjeùJsÚ
*>(
this
);

499 
A¼ayJsÚ
::
	`de¡roy
(
¡©ic_ÿ¡
<A¼ayJsÚ*>(
this
));

501 
	}
}

503 
šlše
 
	gJsÚ
::
A¼ayJsÚ
* 
JsÚ
::
	$ajsÚ
() const {

504 
	`´ecÚd™iÚ
(
u_
.
x
.
ty³
 =ğ
j_nuÎ
 || u_.x.ty³ =ğ
j_¬¿y
);

505  
u_
.
a
.
x
;

506 
	}
}

508 
šlše
 
	gJsÚ
::
ObjeùJsÚ
* 
JsÚ
::
	$ojsÚ
() const {

509 
	`´ecÚd™iÚ
(
u_
.
x
.
ty³
 =ğ
j_nuÎ
 || u_.x.ty³ =ğ
j_objeù
);

510  
u_
.
o
.
x
;

511 
	}
}

513 
šlše
 
	gJsÚ
::
	$uniqueify_¬¿y
(
boŞ
 
cÚv”t
, 
nÿp
) {

514 ià(
u_
.
x
.
ty³
 !ğ
j_¬¿y
 || !u_.
a
.x || u_.a.x->
»fcouÁ
 != 1

515 || (
nÿp
 > 0 &&‚ÿ°> 
u_
.
a
.
x
->
ÿ·c™y
))

516 
	`h¬d_uniqueify_¬¿y
(
cÚv”t
, 
nÿp
);

517 
	}
}

519 
šlše
 
	gJsÚ
::
	$uniqueify_objeù
(
boŞ
 
cÚv”t
) {

520 ià(
u_
.
x
.
ty³
 !ğ
j_objeù
 || !u_.
o
.x || u_.o.x->
»fcouÁ
 != 1)

521 
	`h¬d_uniqueify_objeù
(
cÚv”t
);

522 
	}
}

525 şas 
	cJsÚ
::
cÚ¡_objeù_™”©Ü
 { 
public
:

526 
¡d
::
	t·œ
<cÚ¡ 
	tSŒšg
, 
	tJsÚ
> 
	tv®ue_ty³
;

527 cÚ¡ 
	tv®ue_ty³
* 
	tpoš‹r_ty³
;

528 cÚ¡ 
	tv®ue_ty³
& 
	t»ã»nû_ty³
;

529 
	g¡d
::
	tfÜw¬d_™”©Ü_g
 
	t™”©Ü_ÿ‹gÜy
;

531 
cÚ¡_objeù_™”©Ü
() {

533 
boŞ
 (
	tcÚ¡_objeù_™”©Ü
::*
	tun¥ecif›d_boŞ_ty³
)() const;

534 
İ”©Ü
 
un¥ecif›d_boŞ_ty³
() const {

535  
live
(è? &
	gcÚ¡_objeù_™”©Ü
::live : 0;

537 
boŞ
 
live
() const {

538  
	gi_
 >= 0;

540 cÚ¡ 
	gv®ue_ty³
& 
	gİ”©Ü
*() const {

541  
	gj_
->
ojsÚ
()->
™em
(
i_
).
	gv_
;

543 cÚ¡ 
v®ue_ty³
* 
	gİ”©Ü
->() const {

544  &(**
	gthis
);

546 cÚ¡ 
	gSŒšg
& 
key
() const {

547  (**
	gthis
).
	gfœ¡
;

549 cÚ¡ 
	gJsÚ
& 
v®ue
() const {

550  (**
	gthis
).
	g£cÚd
;

552 
	gİ”©Ü
++() {

553 ++
	gi_
;

554 
fix
();

556 
	gİ”©Ü
++() {

557 ++(*
	gthis
);

559 
	g´iv©e
:

560 cÚ¡ 
JsÚ
* 
j_
;

561 
	gi_
;

562 
cÚ¡_objeù_™”©Ü
(cÚ¡ 
JsÚ
* 
j
, 
i
)

563 : 
j_
(
j
), 
i_
(
i
) {

564 ià(
	gi_
 >= 0)

565 
fix
();

567 
fix
() {

568 
ObjeùJsÚ
* 
	goj
 = 
j_
->
ojsÚ
();

569 
	g»Œy
:

570 ià(!
oj
 || 
i_
 >ğoj->
n_
)

571 
i_
 = -1;

572 ià(
	goj
->
™em
(
i_
).
	gÃxt_
 == -2) {

573 ++
i_
;

574 
	g»Œy
;

577 
ä›nd
 
şass
 
	gJsÚ
;

578 
ä›nd
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
cÚ¡_objeù_™”©Ü
&, cÚ¡ 
	gcÚ¡_objeù_™”©Ü
&);

581 şas 
	cJsÚ
::
objeù_™”©Ü
 : 
public
 
cÚ¡_objeù_™”©Ü
 {…ublic:

582 
v®ue_ty³
* 
	tpoš‹r_ty³
;

583 
	gv®ue_ty³
& 
	t»ã»nû_ty³
;

585 
objeù_™”©Ü
() {

587 
	gv®ue_ty³
& 
	gİ”©Ü
*() const {

588 
	gcÚ¡_ÿ¡
<
	gJsÚ
*>(
	gj_
)->
uniqueify_objeù
(
çl£
);

589  
	gj_
->
ojsÚ
()->
™em
(
i_
).
	gv_
;

591 
v®ue_ty³
* 
	gİ”©Ü
->() const {

592  &(**
	gthis
);

594 
	gJsÚ
& 
v®ue
() const {

595  (**
	gthis
).
	g£cÚd
;

597 
	g´iv©e
:

598 
objeù_™”©Ü
(
JsÚ
* 
j
, 
i
)

599 : 
cÚ¡_objeù_™”©Ü
(
j
, 
i
) {

601 
ä›nd
 
şass
 
	gJsÚ
;

604 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
JsÚ
::
cÚ¡_objeù_™”©Ü
& 
a
, cÚ¡ 
	gJsÚ
::cÚ¡_objeù_™”©Ü& 
b
) {

605  
a
.
j_
 =ğ
b
.j_ &&‡.
i_
 == b.i_;

608 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
JsÚ
::
cÚ¡_objeù_™”©Ü
& 
a
, cÚ¡ 
	gJsÚ
::cÚ¡_objeù_™”©Ü& 
b
) {

609  !(
a
 =ğ
b
);

612 şas 
	cJsÚ
::
cÚ¡_¬¿y_™”©Ü
 { 
public
:

613 
JsÚ
::
	tsize_ty³
 
	tdifã»nû_ty³
;

614 
JsÚ
 
	tv®ue_ty³
;

615 cÚ¡ 
	tJsÚ
* 
	tpoš‹r
;

616 cÚ¡ 
	tJsÚ
& 
	t»ã»nû
;

617 
	g¡d
::
	t¿ndom_acûss_™”©Ü_g
 
	t™”©Ü_ÿ‹gÜy
;

619 
cÚ¡_¬¿y_™”©Ü
() {

621 
boŞ
 (
	tcÚ¡_¬¿y_™”©Ü
::*
	tun¥ecif›d_boŞ_ty³
)() const;

622 
İ”©Ü
 
un¥ecif›d_boŞ_ty³
() const {

623  
live
(è? &
	gcÚ¡_¬¿y_™”©Ü
::live : 0;

625 
boŞ
 
live
() const {

626 
A¼ayJsÚ
* 
	gaj
 = 
j_
->
ajsÚ
();

627  
	gaj
 && 
	gi_
 <‡j->
	gsize
;

629 cÚ¡ 
	gJsÚ
& 
	gİ”©Ü
*() const {

630  
	gj_
->
ajsÚ
()->
	ga
[
i_
];

632 cÚ¡ 
	gJsÚ
& 
	gİ”©Ü
[](
difã»nû_ty³
 
	gi
) const {

633  
	gj_
->
ajsÚ
()->
	ga
[
i_
 + 
i
];

635 cÚ¡ 
JsÚ
* 
	gİ”©Ü
->() const {

636  &(**
	gthis
);

638 cÚ¡ 
	gJsÚ
& 
v®ue
() const {

639  **
	gthis
;

641 
	gİ”©Ü
++() {

642 ++
	gi_
;

644 
	gcÚ¡_¬¿y_™”©Ü
& 
	gİ”©Ü
++() {

645 ++
	gi_
;

646  *
	gthis
;

648 
	gİ”©Ü
--() {

649 --
	gi_
;

651 
	gcÚ¡_¬¿y_™”©Ü
& 
	gİ”©Ü
--() {

652 --
	gi_
;

653  *
	gthis
;

655 
	gcÚ¡_¬¿y_™”©Ü
& 
	gİ”©Ü
+=(
difã»nû_ty³
 
x
) {

656 
i_
 +ğ
x
;

657  *
	gthis
;

659 
	gcÚ¡_¬¿y_™”©Ü
& 
	gİ”©Ü
-=(
difã»nû_ty³
 
x
) {

660 
i_
 -ğ
x
;

661  *
	gthis
;

663 
	g´iv©e
:

664 cÚ¡ 
JsÚ
* 
j_
;

665 
	gi_
;

666 
cÚ¡_¬¿y_™”©Ü
(cÚ¡ 
JsÚ
* 
j
, 
i
)

667 : 
j_
(
j
), 
i_
(
i
) {

669 
ä›nd
 
şass
 
	gJsÚ
;

670 
ä›nd
 
şass
 
	gJsÚ
::
¬¿y_™”©Ü
;

671 
ä›nd
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
cÚ¡_¬¿y_™”©Ü
&, cÚ¡ 
	gcÚ¡_¬¿y_™”©Ü
&);

672 
ä›nd
 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gcÚ¡_¬¿y_™”©Ü
&, const const_array_iterator&);

673 
ä›nd
 
difã»nû_ty³
 
	gİ”©Ü
-(cÚ¡ 
	gcÚ¡_¬¿y_™”©Ü
&, const const_array_iterator&);

676 şas 
	cJsÚ
::
¬¿y_™”©Ü
 : 
public
 
cÚ¡_¬¿y_™”©Ü
 {…ublic:

677 cÚ¡ 
	tJsÚ
* 
	tpoš‹r
;

678 cÚ¡ 
	tJsÚ
& 
	t»ã»nû
;

680 
¬¿y_™”©Ü
() {

682 
	gJsÚ
& 
	gİ”©Ü
*() const {

683 
	gcÚ¡_ÿ¡
<
	gJsÚ
*>(
	gj_
)->
uniqueify_¬¿y
(
çl£
, 0);

684  
	gj_
->
ajsÚ
()->
	ga
[
i_
];

686 
	gJsÚ
& 
	gİ”©Ü
[](
difã»nû_ty³
 
	gi
) const {

687 
	gcÚ¡_ÿ¡
<
	gJsÚ
*>(
	gj_
)->
uniqueify_¬¿y
(
çl£
, 0);

688  
	gj_
->
ajsÚ
()->
	ga
[
i_
 + 
i
];

690 
JsÚ
* 
	gİ”©Ü
->() const {

691  &(**
	gthis
);

693 
	gJsÚ
& 
v®ue
() const {

694  **
	gthis
;

696 
	g¬¿y_™”©Ü
& 
	gİ”©Ü
++() {

697 ++
	gi_
;

698  *
	gthis
;

700 
	g¬¿y_™”©Ü
& 
	gİ”©Ü
--() {

701 --
	gi_
;

702  *
	gthis
;

704 
	g¬¿y_™”©Ü
& 
	gİ”©Ü
+=(
difã»nû_ty³
 
x
) {

705 
i_
 +ğ
x
;

706  *
	gthis
;

708 
	g¬¿y_™”©Ü
& 
	gİ”©Ü
-=(
difã»nû_ty³
 
x
) {

709 
i_
 -ğ
x
;

710  *
	gthis
;

712 
	g´iv©e
:

713 
¬¿y_™”©Ü
(
JsÚ
* 
j
, 
i
)

714 : 
cÚ¡_¬¿y_™”©Ü
(
j
, 
i
) {

716 
ä›nd
 
şass
 
	gJsÚ
;

719 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
JsÚ
::
cÚ¡_¬¿y_™”©Ü
& 
a
, cÚ¡ 
	gJsÚ
::cÚ¡_¬¿y_™”©Ü& 
b
) {

720  
a
.
j_
 =ğ
b
.j_ &&‡.
i_
 == b.i_;

723 
šlše
 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gJsÚ
::
cÚ¡_¬¿y_™”©Ü
& 
a
, cÚ¡ JsÚ::cÚ¡_¬¿y_™”©Ü& 
b
) {

724  
a
.
j_
 < 
b
.j_ || (a.j_ =ğb.j_ &&‡.
i_
 < b.i_);

727 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
JsÚ
::
cÚ¡_¬¿y_™”©Ü
& 
a
, cÚ¡ 
	gJsÚ
::cÚ¡_¬¿y_™”©Ü& 
b
) {

728  !(
a
 =ğ
b
);

731 
šlše
 
boŞ
 
	gİ”©Ü
<=(cÚ¡ 
JsÚ
::
cÚ¡_¬¿y_™”©Ü
& 
a
, cÚ¡ 
	gJsÚ
::cÚ¡_¬¿y_™”©Ü& 
b
) {

732  !(
b
 < 
a
);

735 
šlše
 
boŞ
 
	gİ”©Ü
>(cÚ¡ 
	gJsÚ
::
cÚ¡_¬¿y_™”©Ü
& 
a
, cÚ¡ JsÚ::cÚ¡_¬¿y_™”©Ü& 
b
) {

736  
b
 < 
a
;

739 
šlše
 
boŞ
 
	gİ”©Ü
>=(cÚ¡ 
JsÚ
::
cÚ¡_¬¿y_™”©Ü
& 
a
, cÚ¡ 
	gJsÚ
::cÚ¡_¬¿y_™”©Ü& 
b
) {

740  !(
a
 < 
b
);

743 
šlše
 
	gJsÚ
::
cÚ¡_¬¿y_™”©Ü
 
İ”©Ü
+(
JsÚ
::cÚ¡_¬¿y_™”©Ü 
a
, JsÚ::cÚ¡_¬¿y_™”©Ü::
difã»nû_ty³
 
i
) {

744  
a
 +ğ
i
;

746 
šlše
 
	gJsÚ
::
¬¿y_™”©Ü
 
İ”©Ü
+(
JsÚ
::¬¿y_™”©Ü 
a
, JsÚ::¬¿y_™”©Ü::
difã»nû_ty³
 
i
) {

747  
a
 +ğ
i
;

750 
šlše
 
	gJsÚ
::
cÚ¡_¬¿y_™”©Ü
 
İ”©Ü
-(
JsÚ
::cÚ¡_¬¿y_™”©Ü 
a
, JsÚ::cÚ¡_¬¿y_™”©Ü::
difã»nû_ty³
 
i
) {

751  
a
 -ğ
i
;

753 
šlše
 
	gJsÚ
::
¬¿y_™”©Ü
 
İ”©Ü
-(
JsÚ
::¬¿y_™”©Ü 
a
, JsÚ::¬¿y_™”©Ü::
difã»nû_ty³
 
i
) {

754  
a
 -ğ
i
;

757 
šlše
 
	gJsÚ
::
cÚ¡_¬¿y_™”©Ü
::
difã»nû_ty³
 
İ”©Ü
-(cÚ¡ 
JsÚ
::cÚ¡_¬¿y_™”©Ü& 
a
, cÚ¡ JsÚ::cÚ¡_¬¿y_™”©Ü& 
b
) {

758 
´ecÚd™iÚ
(
a
.
j_
 =ğ
b
.j_);

759  
	ga
.
	gi_
 - 
	gb
.i_;

762 şas 
	cJsÚ
::
cÚ¡_™”©Ü
 { 
public
:

763 
¡d
::
	t·œ
<cÚ¡ 
	tSŒšg
, 
	tJsÚ
&> 
	tv®ue_ty³
;

764 cÚ¡ 
	tv®ue_ty³
* 
	tpoš‹r
;

765 cÚ¡ 
	tv®ue_ty³
& 
	t»ã»nû
;

766 
	g¡d
::
	tfÜw¬d_™”©Ü_g
 
	t™”©Ü_ÿ‹gÜy
;

768 
cÚ¡_™”©Ü
()

769 : 
v®ue_
(
SŒšg
(), *(
JsÚ
*) 0) {

771 
boŞ
 (
	tcÚ¡_™”©Ü
::*
	tun¥ecif›d_boŞ_ty³
)() const;

772 
İ”©Ü
 
un¥ecif›d_boŞ_ty³
() const {

773  
live
(è? &
	gcÚ¡_™”©Ü
::live : 0;

775 
boŞ
 
live
() const {

776  
	gi_
 >= 0;

778 cÚ¡ 
	gv®ue_ty³
& 
	gİ”©Ü
*() const {

779  
	gv®ue_
;

781 cÚ¡ 
v®ue_ty³
* 
	gİ”©Ü
->() const {

782  &(**
	gthis
);

784 cÚ¡ 
	gSŒšg
& 
key
() const {

785  (**
	gthis
).
	gfœ¡
;

787 cÚ¡ 
	gJsÚ
& 
v®ue
() const {

788  (**
	gthis
).
	g£cÚd
;

790 
	gİ”©Ü
++() {

791 ++
	gi_
;

792 
fix
();

794 
	gİ”©Ü
++() {

795 ++(*
	gthis
);

797 
	g´iv©e
:

798 cÚ¡ 
JsÚ
* 
j_
;

799 
	gi_
;

800 
v®ue_ty³
 
	gv®ue_
;

801 
cÚ¡_™”©Ü
(cÚ¡ 
JsÚ
* 
j
, 
i
)

802 : 
j_
(
j
), 
i_
(
i
), 
v®ue_
(
SŒšg
(), *(
JsÚ
*) 0) {

803 ià(
	gi_
 >= 0)

804 
fix
();

806 
fix
() {

807 ià(
	gj_
->
	gu_
.
	gx
.
	gty³
 =ğ
j_objeù
) {

808 
ObjeùJsÚ
* 
oj
 = 
j_
->
ojsÚ
();

809 
	g»Œy
:

810 ià(!
oj
 || 
i_
 >ğoj->
n_
)

811 
i_
 = -1;

812 ià(
	goj
->
™em
(
i_
).
	gÃxt_
 == -2) {

813 ++
i_
;

814 
	g»Œy
;

816 
	gv®ue_
.~
·œ
();

817 
Ãw
((*è&
v®ue_
è
v®ue_ty³
(
oj
->
™em
(
i_
).
v_
.
fœ¡
,

818 
oj
->
™em
(
i_
).
v_
.
£cÚd
);

821 
A¼ayJsÚ
 *
	gaj
 = 
j_
->
ajsÚ
();

822 ià(!
	gaj
 || (
	gi_
è>ğ(
aj
->
size
))

823 
i_
 = -1;

825 
	gv®ue_
.~
·œ
();

826 
Ãw
((*è&
v®ue_
è
v®ue_ty³
(
SŒšg
(
i_
), 
aj
->
a
[i_]);

830 
ä›nd
 
şass
 
	gJsÚ
;

831 
ä›nd
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
cÚ¡_™”©Ü
 &, cÚ¡ 
	gcÚ¡_™”©Ü
 &);

834 şas 
	cJsÚ
::
™”©Ü
 : 
public
 
cÚ¡_™”©Ü
 {…ublic:

835 
v®ue_ty³
* 
	tpoš‹r
;

836 
	gv®ue_ty³
& 
	t»ã»nû
;

838 
™”©Ü
() {

840 
	gv®ue_ty³
& 
	gİ”©Ü
*() const {

841 ià(
	gj_
->
	gu_
.
	gx
.x->
	g»fcouÁ
 != 1)

842 
uniqueify
();

843  
	gcÚ¡_ÿ¡
<
	gv®ue_ty³
&>(
	gcÚ¡_™”©Ü
::
İ”©Ü
*());

845 
v®ue_ty³
* 
	gİ”©Ü
->() const {

846  &(**
	gthis
);

848 
	gJsÚ
& 
v®ue
() const {

849  (**
	gthis
).
	g£cÚd
;

851 
	g´iv©e
:

852 
™”©Ü
(
JsÚ
 *
j
, 
i
)

853 : 
cÚ¡_™”©Ü
(
j
, 
i
) {

855 
uniqueify
() const {

856 ià(
	gj_
->
	gu_
.
	gx
.
	gty³
 =ğ
j_objeù
)

857 
cÚ¡_ÿ¡
<
JsÚ
*>(
j_
)->
h¬d_uniqueify_objeù
(
çl£
);

859 
	gcÚ¡_ÿ¡
<
	gJsÚ
*>(
	gj_
)->
h¬d_uniqueify_¬¿y
(
çl£
, 0);

860 
	gcÚ¡_ÿ¡
<
	g™”©Ü
*>(
	gthis
)->
fix
();

862 
ä›nd
 
şass
 
	gJsÚ
;

865 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
JsÚ
::
cÚ¡_™”©Ü
& 
a
, cÚ¡ 
	gJsÚ
::cÚ¡_™”©Ü& 
b
) {

866  
a
.
j_
 =ğ
b
.j_ &&‡.
i_
 == b.i_;

869 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
JsÚ
::
cÚ¡_™”©Ü
& 
a
, cÚ¡ 
	gJsÚ
::cÚ¡_™”©Ü& 
b
) {

870  !(
a
 =ğ
b
);

874 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

875 şas 
	cJsÚ_´oxy_ba£
 {

876 
	gpublic
:

877 cÚ¡ 
JsÚ
& 
cv®ue
() const {

878  
¡©ic_ÿ¡
<cÚ¡ 
P
 *>(
this
)->
cv®ue
();

880 
	gJsÚ
& 
v®ue
() {

881  
	g¡©ic_ÿ¡
<
	gP
 *>(
	gthis
)->
v®ue
();

883 
İ”©Ü
 cÚ¡ 
	gJsÚ
&() const {

884  
cv®ue
();

886 
İ”©Ü
 
	gJsÚ
&() {

887  
v®ue
();

889 
boŞ
 
Œuthy
() const {

890  
cv®ue
().
Œuthy
();

892 
boŞ
 
çlsy
() const {

893  
cv®ue
().
çlsy
();

895 
İ”©Ü
 
	gJsÚ
::
un¥ecif›d_boŞ_ty³
() const {

896  
cv®ue
();

898 
boŞ
 
	gİ”©Ü
!() const {

899  !
cv®ue
();

901 
boŞ
 
is_nuÎ
() const {

902  
cv®ue
().
is_nuÎ
();

904 
boŞ
 
is_št
() const {

905  
cv®ue
().
is_št
();

907 
boŞ
 
is_i
() const {

908  
cv®ue
().
is_i
();

910 
boŞ
 
is_unsigÃd
() const {

911  
cv®ue
().
is_unsigÃd
();

913 
boŞ
 
is_u
() const {

914  
cv®ue
().
is_u
();

916 
boŞ
 
is_sigÃd
() const {

917  
cv®ue
().
is_sigÃd
();

919 
boŞ
 
is_nÚÃgšt
() const {

920  
cv®ue
().
is_nÚÃgšt
();

922 
boŞ
 
is_doubË
() const {

923  
cv®ue
().
is_doubË
();

925 
boŞ
 
is_d
() const {

926  
cv®ue
().
is_d
();

928 
boŞ
 
is_numb”
() const {

929  
cv®ue
().
is_numb”
();

931 
boŞ
 
is_n
() const {

932  
cv®ue
().
is_n
();

934 
boŞ
 
is_boŞ
() const {

935  
cv®ue
().
is_boŞ
();

937 
boŞ
 
is_b
() const {

938  
cv®ue
().
is_b
();

940 
boŞ
 
is_¡ršg
() const {

941  
cv®ue
().
is_¡ršg
();

943 
boŞ
 
is_s
() const {

944  
cv®ue
().
is_s
();

946 
boŞ
 
is_¬¿y
() const {

947  
cv®ue
().
is_¬¿y
();

949 
boŞ
 
is_a
() const {

950  
cv®ue
().
is_a
();

952 
boŞ
 
is_objeù
() const {

953  
cv®ue
().
is_objeù
();

955 
boŞ
 
is_o
() const {

956  
cv®ue
().
is_o
();

958 
boŞ
 
is_´im™ive
() const {

959  
cv®ue
().
is_´im™ive
();

961 
boŞ
 
em±y
() const {

962  
cv®ue
().
em±y
();

964 
	gJsÚ
::
size_ty³
 
size
() const {

965  
cv®ue
().
size
();

967 
št64_t
 
to_i
() const {

968  
cv®ue
().
to_i
();

970 
ušt64_t
 
to_u
() const {

971  
cv®ue
().
to_u
();

973 
ušt64_t
 
to_u64
() const {

974  
cv®ue
().
to_u64
();

976 
boŞ
 
to_i
(& 
x
) const {

977  
cv®ue
().
to_i
(
x
);

979 
boŞ
 
to_i
(& 
x
) const {

980  
cv®ue
().
to_i
(
x
);

982 
boŞ
 
to_i
(& 
x
) const {

983  
cv®ue
().
to_i
(
x
);

985 
boŞ
 
to_i
(& 
x
) const {

986  
cv®ue
().
to_i
(
x
);

988 
boŞ
 
to_i
(& 
x
) const {

989  
cv®ue
().
to_i
(
x
);

991 
boŞ
 
to_i
(& 
x
) const {

992  
cv®ue
().
to_i
(
x
);

994 
št64_t
 
as_i
() const {

995  
cv®ue
().
as_i
();

997 
št64_t
 
as_i
(št64_ˆ
deçuÉ_v®ue
) const {

998  
cv®ue
().
as_i
(
deçuÉ_v®ue
);

1000 
ušt64_t
 
as_u
() const {

1001  
cv®ue
().
as_u
();

1003 
ušt64_t
 
as_u
(ušt64_ˆ
deçuÉ_v®ue
) const {

1004  
cv®ue
().
as_u
(
deçuÉ_v®ue
);

1006 
to_d
() const {

1007  
cv®ue
().
to_d
();

1009 
boŞ
 
to_d
(& 
x
) const {

1010  
cv®ue
().
to_d
(
x
);

1012 
as_d
() const {

1013  
cv®ue
().
as_d
();

1015 
as_d
(
deçuÉ_v®ue
) const {

1016  
cv®ue
().
as_d
(
deçuÉ_v®ue
);

1018 
boŞ
 
to_b
() const {

1019  
cv®ue
().
to_b
();

1021 
boŞ
 
to_b
(boŞ& 
x
) const {

1022  
cv®ue
().
to_b
(
x
);

1024 
boŞ
 
as_b
() const {

1025  
cv®ue
().
as_b
();

1027 
boŞ
 
as_b
(boŞ 
deçuÉ_v®ue
) const {

1028  
cv®ue
().
as_b
(
deçuÉ_v®ue
);

1030 
SŒšg
 
to_s
() const {

1031  
cv®ue
().
to_s
();

1033 
boŞ
 
to_s
(
SŒ
& 
x
) const {

1034  
cv®ue
().
to_s
(
x
);

1036 
boŞ
 
to_s
(
SŒšg
& 
x
) const {

1037  
cv®ue
().
to_s
(
x
);

1039 cÚ¡ 
	gSŒšg
& 
as_s
() const {

1040  
cv®ue
().
as_s
();

1042 cÚ¡ 
	gSŒšg
& 
as_s
(cÚ¡ 
SŒšg
& 
deçuÉ_v®ue
) const {

1043  
cv®ue
().
as_s
(
deçuÉ_v®ue
);

1045 
	gJsÚ
::
size_ty³
 
couÁ
(
SŒ
 
key
) const {

1046  
cv®ue
().
couÁ
(
key
);

1048 cÚ¡ 
	gJsÚ
& 
g‘
(
SŒ
 
key
) const {

1049  
cv®ue
().
g‘
(
key
);

1051 
	gJsÚ
& 
g‘_š£¹
(cÚ¡ 
SŒšg
& 
key
) {

1052  
v®ue
().
g‘_š£¹
(
key
);

1054 
	gJsÚ
& 
g‘_š£¹
(
SŒ
 
key
) {

1055  
v®ue
().
g‘_š£¹
(
key
);

1057 
	gJsÚ
& 
g‘_š£¹
(cÚ¡ * 
key
) {

1058  
v®ue
().
g‘_š£¹
(
key
);

1060 
g‘_i
(
SŒ
 
key
) const {

1061  
cv®ue
().
g‘_i
(
key
);

1063 
g‘_d
(
SŒ
 
key
) const {

1064  
cv®ue
().
g‘_d
(
key
);

1066 
boŞ
 
g‘_b
(
SŒ
 
key
) const {

1067  
cv®ue
().
g‘_b
(
key
);

1069 
SŒšg
 
g‘_s
(
SŒ
 
key
) const {

1070  
cv®ue
().
g‘_s
(
key
);

1072 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, 
JsÚ
& 
x
) const;

1073 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, & 
x
) const;

1074 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, & 
x
) const;

1075 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, & 
x
) const;

1076 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, & 
x
) const;

1077 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, & 
x
) const;

1078 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, & 
x
) const;

1079 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, & 
x
) const;

1080 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, 
boŞ
& 
x
) const;

1081 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, SŒ& 
x
) const;

1082 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
g‘
(
SŒ
 
key
, 
SŒšg
& 
x
) const;

1083 cÚ¡ 
	gJsÚ
& 
	gİ”©Ü
[](
SŒ
 
	gkey
) const {

1084  
cv®ue
().
g‘
(
key
);

1086 
	gJsÚ_objeù_´oxy
<
	gP
> 
	gİ”©Ü
[](cÚ¡ 
	gSŒšg
& 
	gkey
) {

1087  
	gJsÚ_objeù_´oxy
<
	gP
>(*
	g¡©ic_ÿ¡
<P*>(
	gthis
), 
	gkey
);

1089 
	gJsÚ_objeù_¡r_´oxy
<
	gP
> 
	gİ”©Ü
[](
	g¡d
::
¡ršg
 
key
) {

1090  
JsÚ_objeù_¡r_´oxy
<
P
>(*
¡©ic_ÿ¡
<P*>(
this
), 
SŒ
(
key
.
d©a
(), key.
Ëngth
()));

1092 
	gJsÚ_objeù_¡r_´oxy
<
	gP
> 
	gİ”©Ü
[](
SŒ
 
	gkey
) {

1093  
	gJsÚ_objeù_¡r_´oxy
<
	gP
>(*
	g¡©ic_ÿ¡
<P*>(
	gthis
), 
	gkey
);

1095 
	gJsÚ_objeù_¡r_´oxy
<
	gP
> 
	gİ”©Ü
[](cÚ¡ * 
	gkey
) {

1096  
	gJsÚ_objeù_¡r_´oxy
<
	gP
>(*
	g¡©ic_ÿ¡
<P*>(
	gthis
), 
	gkey
);

1098 cÚ¡ 
	gJsÚ
& 
©
(
SŒ
 
key
) const {

1099  
cv®ue
().
©
(
key
);

1101 
	gJsÚ
& 
©_š£¹
(cÚ¡ 
SŒšg
& 
key
) {

1102  
v®ue
().
©_š£¹
(
key
);

1104 
	gJsÚ
& 
©_š£¹
(
SŒ
 
key
) {

1105  
v®ue
().
©_š£¹
(
key
);

1107 
	gJsÚ
& 
©_š£¹
(cÚ¡ * 
key
) {

1108  
v®ue
().
©_š£¹
(
key
);

1110 
šlše
 
	gJsÚ
& 
£t
(cÚ¡ 
SŒšg
& 
key
, 
JsÚ
 
v®ue
) {

1111  
	gthis
->
v®ue
().
£t
(
key
, value);

1113 
	g‹m¶©e
 <
ty³Çme
 
	gQ
>

1114 
šlše
 
	gJsÚ
& 
£t
(cÚ¡ 
SŒšg
& 
key
, cÚ¡ 
JsÚ_´oxy_ba£
<
Q
>& 
v®ue
) {

1115  
	gthis
->
v®ue
().
£t
(
key
, value);

1117 
	gJsÚ
& 
un£t
(
SŒ
 
key
) {

1118  
v®ue
().
un£t
(
key
);

1120 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

1121 
šlše
 
	gJsÚ
& 
£t_li¡
(
Args
&&... 
¬gs
) {

1122  
v®ue
().
£t_li¡
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

1124 
	g¡d
::
·œ
<
JsÚ
::
objeù_™”©Ü
, 
	gboŞ
> 
š£¹
(cÚ¡ JsÚ::
objeù_v®ue_ty³
 &
x
) {

1125  
v®ue
().
š£¹
(
x
);

1127 
	gJsÚ
::
objeù_™”©Ü
 
š£¹
(
JsÚ
::objeù_™”©Ü 
pos™iÚ
, cÚ¡ JsÚ::
objeù_v®ue_ty³
 &
x
) {

1128  
v®ue
().
š£¹
(
pos™iÚ
, 
x
);

1130 
	gJsÚ
::
objeù_™”©Ü
 
”a£
(
JsÚ
::objeù_™”©Ü 
™
) {

1131  
v®ue
().
”a£
(
™
);

1133 
	gJsÚ
::
size_ty³
 
”a£
(
SŒ
 
key
) {

1134  
v®ue
().
”a£
(
key
);

1136 
	gJsÚ
& 
m”ge
(cÚ¡ 
JsÚ
& 
x
) {

1137  
v®ue
().
m”ge
(
x
);

1139 
	g‹m¶©e
 <
ty³Çme
 
	gP2
> 
	gJsÚ
& 
m”ge
(cÚ¡ 
JsÚ_´oxy_ba£
<
P2
>& 
x
) {

1140  
v®ue
().
m”ge
(
x
.
cv®ue
());

1142 cÚ¡ 
	gJsÚ
& 
g‘
(
JsÚ
::
size_ty³
 
x
) const {

1143  
cv®ue
().
g‘
(
x
);

1145 
	gJsÚ
& 
g‘_š£¹
(
JsÚ
::
size_ty³
 
x
) {

1146  
v®ue
().
g‘_š£¹
(
x
);

1148 cÚ¡ 
	gJsÚ
& 
	gİ”©Ü
[](
	gkey
) const {

1149  
cv®ue
().
©
(
key
);

1151 
	gJsÚ_¬¿y_´oxy
<
	gP
> 
	gİ”©Ü
[](
	gkey
) {

1152  
	gJsÚ_¬¿y_´oxy
<
	gP
>(*
	g¡©ic_ÿ¡
<P*>(
	gthis
), 
	gkey
);

1154 cÚ¡ 
	gJsÚ
& 
©
(
JsÚ
::
size_ty³
 
x
) const {

1155  
cv®ue
().
©
(
x
);

1157 
	gJsÚ
& 
©_š£¹
(
JsÚ
::
size_ty³
 
x
) {

1158  
v®ue
().
©_š£¹
(
x
);

1160 cÚ¡ 
	gJsÚ
& 
back
() const {

1161  
cv®ue
().
back
();

1163 
	gJsÚ
& 
back
() {

1164  
v®ue
().
back
();

1166 
	gJsÚ
& 
push_back
(
JsÚ
 
x
) {

1167  
v®ue
().
push_back
(
¡d
::
move
(
x
));

1169 
	g‹m¶©e
 <
ty³Çme
 
	gQ
> 
	gJsÚ
& 
push_back
(cÚ¡ 
JsÚ_´oxy_ba£
<
Q
>& 
x
) {

1170  
v®ue
().
push_back
(
x
);

1172 
pİ_back
() {

1173 
v®ue
().
pİ_back
();

1175 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
> 
	gJsÚ
& 
push_back_li¡
(
Args
&&... 
¬gs
) {

1176  
v®ue
().
push_back_li¡
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

1178 
	gJsÚ
::
¬¿y_™”©Ü
 
š£¹
(
JsÚ
::¬¿y_™”©Ü 
pos™iÚ
, JsÚ 
x
) {

1179  
v®ue
().
š£¹
(
pos™iÚ
, 
¡d
::
move
(
x
));

1181 
	g‹m¶©e
 <
ty³Çme
 
	gQ
> 
	gJsÚ
::
¬¿y_™”©Ü
 
š£¹
(
JsÚ
::¬¿y_™”©Ü 
pos™iÚ
, cÚ¡ 
JsÚ_´oxy_ba£
<
Q
>& 
x
) {

1182  
v®ue
().
š£¹
(
pos™iÚ
, 
x
);

1184 
	gJsÚ
::
¬¿y_™”©Ü
 
”a£
(
JsÚ
::¬¿y_™”©Ü 
fœ¡
, JsÚ::¬¿y_™”©Ü 
Ï¡
) {

1185  
v®ue
().
”a£
(
fœ¡
, 
Ï¡
);

1187 
	gJsÚ
::
¬¿y_™”©Ü
 
”a£
(
JsÚ
::¬¿y_™”©Ü 
pos™iÚ
) {

1188  
v®ue
().
”a£
(
pos™iÚ
);

1190 
»size
(
JsÚ
::
size_ty³
 
n
) {

1191 
v®ue
().
»size
(
n
);

1193 
uÅ¬£
(
SŒšgAccum
& 
§
) const {

1194  
cv®ue
().
uÅ¬£
(
§
);

1196 
uÅ¬£
(
SŒšgAccum
& 
§
, cÚ¡ 
JsÚ
::
uÅ¬£_mªuÏtÜ
& 
m
) const {

1197  
cv®ue
().
uÅ¬£
(
§
, 
m
);

1199 
SŒšg
 
uÅ¬£
() const {

1200  
cv®ue
().
uÅ¬£
();

1202 
SŒšg
 
uÅ¬£
(cÚ¡ 
JsÚ
::
uÅ¬£_mªuÏtÜ
& 
m
) const {

1203  
cv®ue
().
uÅ¬£
(
m
);

1205 
boŞ
 
assign_·r£
(cÚ¡ 
SŒšg
& 
¡r
) {

1206  
v®ue
().
assign_·r£
(
¡r
);

1208 
boŞ
 
assign_·r£
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
) {

1209  
v®ue
().
assign_·r£
(
fœ¡
, 
Ï¡
);

1211 
sw­
(
JsÚ
& 
x
) {

1212 
v®ue
().
sw­
(
x
);

1214 
	gJsÚ
& 
	gİ”©Ü
++() {

1215  ++
v®ue
();

1217 
	gİ”©Ü
++() {

1218 
v®ue
()++;

1220 
	gJsÚ
& 
	gİ”©Ü
--() {

1221  --
v®ue
();

1223 
	gİ”©Ü
--() {

1224 
v®ue
()--;

1226 
	gJsÚ
& 
	gİ”©Ü
+=(
x
) {

1227  
v®ue
(è+ğ
x
;

1229 
	gJsÚ
& 
	gİ”©Ü
+=(
x
) {

1230  
v®ue
(è+ğ
x
;

1232 
	gJsÚ
& 
	gİ”©Ü
+=(
x
) {

1233  
v®ue
(è+ğ
x
;

1235 
	gJsÚ
& 
	gİ”©Ü
+=(
x
) {

1236  
v®ue
(è+ğ
x
;

1238 
	gJsÚ
& 
	gİ”©Ü
+=(
x
) {

1239  
v®ue
(è+ğ
x
;

1241 
	gJsÚ
& 
	gİ”©Ü
+=(
x
) {

1242  
v®ue
(è+ğ
x
;

1244 
	gJsÚ
& 
	gİ”©Ü
+=(
x
) {

1245  
v®ue
(è+ğ
x
;

1247 
	gJsÚ
& 
	gİ”©Ü
+=(cÚ¡ 
JsÚ
& 
x
) {

1248  
v®ue
(è+ğ
x
;

1250 
	gJsÚ
& 
	gİ”©Ü
-=(
x
) {

1251  
v®ue
(è-ğ
x
;

1253 
	gJsÚ
& 
	gİ”©Ü
-=(
x
) {

1254  
v®ue
(è-ğ
x
;

1256 
	gJsÚ
& 
	gİ”©Ü
-=(
x
) {

1257  
v®ue
(è-ğ
x
;

1259 
	gJsÚ
& 
	gİ”©Ü
-=(
x
) {

1260  
v®ue
(è-ğ
x
;

1262 
	gJsÚ
& 
	gİ”©Ü
-=(
x
) {

1263  
v®ue
(è-ğ
x
;

1265 
	gJsÚ
& 
	gİ”©Ü
-=(
x
) {

1266  
v®ue
(è-ğ
x
;

1268 
	gJsÚ
& 
	gİ”©Ü
-=(
x
) {

1269  
v®ue
(è-ğ
x
;

1271 
	gJsÚ
& 
	gİ”©Ü
-=(cÚ¡ 
JsÚ
& 
x
) {

1272  
v®ue
(è-ğ
x
;

1274 
	gJsÚ
::
cÚ¡_objeù_™”©Ü
 
obegš
() const {

1275  
cv®ue
().
obegš
();

1277 
	gJsÚ
::
cÚ¡_objeù_™”©Ü
 
Ûnd
() const {

1278  
cv®ue
().
Ûnd
();

1280 
	gJsÚ
::
objeù_™”©Ü
 
obegš
() {

1281  
v®ue
().
obegš
();

1283 
	gJsÚ
::
objeù_™”©Ü
 
Ûnd
() {

1284  
v®ue
().
Ûnd
();

1286 
	gJsÚ
::
cÚ¡_objeù_™”©Ü
 
cobegš
() const {

1287  
cv®ue
().
cobegš
();

1289 
	gJsÚ
::
cÚ¡_objeù_™”©Ü
 
cÛnd
() const {

1290  
cv®ue
().
cÛnd
();

1292 
	gJsÚ
::
cÚ¡_¬¿y_™”©Ü
 
abegš
() const {

1293  
cv®ue
().
abegš
();

1295 
	gJsÚ
::
cÚ¡_¬¿y_™”©Ü
 
«nd
() const {

1296  
cv®ue
().
«nd
();

1298 
	gJsÚ
::
¬¿y_™”©Ü
 
abegš
() {

1299  
v®ue
().
abegš
();

1301 
	gJsÚ
::
¬¿y_™”©Ü
 
«nd
() {

1302  
v®ue
().
«nd
();

1304 
	gJsÚ
::
cÚ¡_¬¿y_™”©Ü
 
ÿbegš
() const {

1305  
cv®ue
().
ÿbegš
();

1307 
	gJsÚ
::
cÚ¡_¬¿y_™”©Ü
 
ÿ’d
() const {

1308  
cv®ue
().
ÿ’d
();

1310 
	gJsÚ
::
cÚ¡_™”©Ü
 
begš
() const {

1311  
cv®ue
().
begš
();

1313 
	gJsÚ
::
cÚ¡_™”©Ü
 
’d
() const {

1314  
cv®ue
().
’d
();

1316 
	gJsÚ
::
™”©Ü
 
begš
() {

1317  
v®ue
().
begš
();

1319 
	gJsÚ
::
™”©Ü
 
’d
() {

1320  
v®ue
().
’d
();

1322 
	gJsÚ
::
cÚ¡_™”©Ü
 
cbegš
() const {

1323  
cv®ue
().
cbegš
();

1325 
	gJsÚ
::
cÚ¡_™”©Ü
 
ûnd
() const {

1326  
cv®ue
().
ûnd
();

1330 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1331 
şass
 
	gJsÚ_objeù_´oxy
 : 
public
 
JsÚ_´oxy_ba£
<
JsÚ_objeù_´oxy
<
T
> > {

1332 
public
:

1333 cÚ¡ 
JsÚ
& 
cv®ue
() const {

1334  
ba£_
.
g‘
(
key_
);

1336 
	gJsÚ
& 
v®ue
() {

1337  
	gba£_
.
g‘_š£¹
(
key_
);

1339 
	gJsÚ
& 
	gİ”©Ü
=(cÚ¡ 
JsÚ
& 
x
) {

1340  
v®ue
(èğ
x
;

1342 #ià
HAVE_CXX_RVALUE_REFERENCES


1343 
	gJsÚ
& 
	gİ”©Ü
=(
JsÚ
&& 
x
) {

1344  
v®ue
(èğ
¡d
::
move
(
x
);

1347 
	gJsÚ
& 
	gİ”©Ü
=(cÚ¡ 
JsÚ_objeù_´oxy
<
T
>& 
x
) {

1348  
v®ue
(èğ
x
.
cv®ue
();

1350 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
	gJsÚ
& 
	gİ”©Ü
=(cÚ¡ 
JsÚ_´oxy_ba£
<
P
>& 
x
) {

1351  
v®ue
(èğ
x
.
cv®ue
();

1353 
JsÚ_objeù_´oxy
(
T
& 
»f
, cÚ¡ 
SŒšg
& 
key
)

1354 : 
ba£_
(
»f
), 
key_
(
key
) {

1356 
	gT
 &
	gba£_
;

1357 
SŒšg
 
	gkey_
;

1360 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1361 
şass
 
	gJsÚ_objeù_¡r_´oxy
 : 
public
 
JsÚ_´oxy_ba£
<
JsÚ_objeù_¡r_´oxy
<
T
> > {

1362 
public
:

1363 cÚ¡ 
JsÚ
& 
cv®ue
() const {

1364  
ba£_
.
g‘
(
key_
);

1366 
	gJsÚ
& 
v®ue
() {

1367  
	gba£_
.
g‘_š£¹
(
key_
);

1369 
	gJsÚ
& 
	gİ”©Ü
=(cÚ¡ 
JsÚ
& 
x
) {

1370  
v®ue
(èğ
x
;

1372 #ià
HAVE_CXX_RVALUE_REFERENCES


1373 
	gJsÚ
& 
	gİ”©Ü
=(
JsÚ
&& 
x
) {

1374  
v®ue
(èğ
¡d
::
move
(
x
);

1377 
	gJsÚ
& 
	gİ”©Ü
=(cÚ¡ 
JsÚ_objeù_¡r_´oxy
<
T
>& 
x
) {

1378  
v®ue
(èğ
x
.
cv®ue
();

1380 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
	gJsÚ
& 
	gİ”©Ü
=(cÚ¡ 
JsÚ_´oxy_ba£
<
P
>& 
x
) {

1381  
v®ue
(èğ
x
.
cv®ue
();

1383 
JsÚ_objeù_¡r_´oxy
(
T
& 
»f
, 
SŒ
 
key
)

1384 : 
ba£_
(
»f
), 
key_
(
key
) {

1386 
	gT
 &
	gba£_
;

1387 
SŒ
 
	gkey_
;

1390 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1391 
şass
 
	gJsÚ_¬¿y_´oxy
 : 
public
 
JsÚ_´oxy_ba£
<
JsÚ_¬¿y_´oxy
<
T
> > {

1392 
public
:

1393 cÚ¡ 
JsÚ
& 
cv®ue
() const {

1394  
ba£_
.
g‘
(
key_
);

1396 
	gJsÚ
& 
v®ue
() {

1397  
	gba£_
.
g‘_š£¹
(
key_
);

1399 
	gJsÚ
& 
	gİ”©Ü
=(cÚ¡ 
JsÚ
& 
x
) {

1400  
v®ue
(èğ
x
;

1402 #ià
HAVE_CXX_RVALUE_REFERENCES


1403 
	gJsÚ
& 
	gİ”©Ü
=(
JsÚ
&& 
x
) {

1404  
v®ue
(èğ
¡d
::
move
(
x
);

1407 
	gJsÚ
& 
	gİ”©Ü
=(cÚ¡ 
JsÚ_¬¿y_´oxy
<
T
>& 
x
) {

1408  
v®ue
(èğ
x
.
cv®ue
();

1410 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
	gJsÚ
& 
	gİ”©Ü
=(cÚ¡ 
JsÚ_´oxy_ba£
<
P
>& 
x
) {

1411  
v®ue
(èğ
x
.
cv®ue
();

1413 
JsÚ_¬¿y_´oxy
(
T
& 
»f
, 
key
)

1414 : 
ba£_
(
»f
), 
key_
(
key
) {

1416 
	gT
 &
	gba£_
;

1417 
	gkey_
;

1420 
şass
 
	gJsÚ_g‘_´oxy
 : 
public
 
JsÚ_´oxy_ba£
<
JsÚ_g‘_´oxy
> {

1421 
public
:

1422 cÚ¡ 
JsÚ
& 
cv®ue
() const {

1423  
ba£_
;

1425 
İ”©Ü
 
	gJsÚ
::
un¥ecif›d_boŞ_ty³
() const {

1426  
¡©us_
 ? &
JsÚ
::
is_nuÎ
 : 0;

1428 
boŞ
 
	gİ”©Ü
!() const {

1429  !
	g¡©us_
;

1431 
boŞ
 
¡©us
() const {

1432  
	g¡©us_
;

1434 cÚ¡ 
	gJsÚ_g‘_´oxy
& 
¡©us
(
boŞ
& 
x
) const {

1435 
	gx
 = 
¡©us_
;

1436  *
	gthis
;

1438 
JsÚ_g‘_´oxy
(cÚ¡ 
JsÚ
& 
»f
, 
boŞ
 
¡©us
)

1439 : 
ba£_
(
»f
), 
¡©us_
(
¡©us
) {

1441 cÚ¡ 
	gJsÚ
& 
	gba£_
;

1442 
boŞ
 
	g¡©us_
;

1443 
	g´iv©e
:

1444 
JsÚ_g‘_´oxy
& 
İ”©Ü
=(cÚ¡ JsÚ_g‘_´oxy& 
x
);

1447 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1448 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ_´oxy_ba£
<
	gT
>::
	$g‘
(
SŒ
 
key
, 
JsÚ
& 
x
) const {

1449  
	`cv®ue
().
	`g‘
(
key
, 
x
);

1450 
	}
}

1451 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1452 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ_´oxy_ba£
<
	gT
>::
	$g‘
(
SŒ
 
key
, & 
x
) const {

1453  
	`cv®ue
().
	`g‘
(
key
, 
x
);

1454 
	}
}

1455 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1456 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ_´oxy_ba£
<
	gT
>::
	$g‘
(
SŒ
 
key
, & 
x
) const {

1457  
	`cv®ue
().
	`g‘
(
key
, 
x
);

1458 
	}
}

1459 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1460 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ_´oxy_ba£
<
	gT
>::
	$g‘
(
SŒ
 
key
, & 
x
) const {

1461  
	`cv®ue
().
	`g‘
(
key
, 
x
);

1462 
	}
}

1463 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1464 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ_´oxy_ba£
<
	gT
>::
	$g‘
(
SŒ
 
key
, & 
x
) const {

1465  
	`cv®ue
().
	`g‘
(
key
, 
x
);

1466 
	}
}

1467 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1468 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ_´oxy_ba£
<
	gT
>::
	$g‘
(
SŒ
 
key
, & 
x
) const {

1469  
	`cv®ue
().
	`g‘
(
key
, 
x
);

1470 
	}
}

1471 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1472 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ_´oxy_ba£
<
	gT
>::
	$g‘
(
SŒ
 
key
, & 
x
) const {

1473  
	`cv®ue
().
	`g‘
(
key
, 
x
);

1474 
	}
}

1475 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1476 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ_´oxy_ba£
<
	gT
>::
	$g‘
(
SŒ
 
key
, & 
x
) const {

1477  
	`cv®ue
().
	`g‘
(
key
, 
x
);

1478 
	}
}

1479 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1480 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ_´oxy_ba£
<
	gT
>::
	$g‘
(
SŒ
 
key
, 
boŞ
& 
x
) const {

1481  
	`cv®ue
().
	`g‘
(
key
, 
x
);

1482 
	}
}

1483 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1484 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ_´oxy_ba£
<
	gT
>::
	$g‘
(
SŒ
 
key
, SŒ& 
x
) const {

1485  
	`cv®ue
().
	`g‘
(
key
, 
x
);

1486 
	}
}

1487 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1488 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ_´oxy_ba£
<
	gT
>::
	$g‘
(
SŒ
 
key
, 
SŒšg
& 
x
) const {

1489  
	`cv®ue
().
	`g‘
(
key
, 
x
);

1490 
	}
}

1494 
šlše
 
	gJsÚ
::
	$JsÚ
() {

1495 
	`mem£t
(&
u_
, 0, (u_));

1496 
	}
}

1498 
šlše
 
	gJsÚ
::
	$JsÚ
(cÚ¡ 
nuÎ_t
&) {

1499 
	`mem£t
(&
u_
, 0, (u_));

1500 
	}
}

1502 
šlše
 
	gJsÚ
::
	$JsÚ
(cÚ¡ 
JsÚ
& 
x
)

1503 : 
	$u_
(
x
.
u_
) {

1504 ià(
u_
.
x
.
ty³
 < 0)

1505 
u_
.
¡r
.
	`»f
();

1506 ià(
u_
.
x
.x && (u_.x.
ty³
 =ğ
j_¬¿y
 || u_.x.ty³ =ğ
j_objeù
))

1507 
u_
.
x
.x->
	`»f
();

1508 
	}
}

1510 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
šlše
 
	gJsÚ
::
JsÚ
(cÚ¡ 
JsÚ_´oxy_ba£
<
P
>& 
x
)

1511 : 
u_
(
x
.
cv®ue
().u_) {

1512 ià(
u_
.
x
.
ty³
 < 0)

1513 
u_
.
¡r
.
»f
();

1514 ià(
	gu_
.
	gx
.x && (u_.x.
	gty³
 =ğ
j_¬¿y
 || 
u_
.
x
.
ty³
 =ğ
j_objeù
))

1515 
u_
.
x
.x->
»f
();

1517 #ià
HAVE_CXX_RVALUE_REFERENCES


1519 
šlše
 
	gJsÚ
::
	$JsÚ
(
JsÚ
&& 
x
)

1520 : 
	`u_
(
¡d
::
	$move
(
x
.
u_
)) {

1521 
	`mem£t
(&
x
, 0, (x));

1522 
	}
}

1525 
šlše
 
	gJsÚ
::
	$JsÚ
(
x
) {

1526 
u_
.
i
.
x
 = x;

1527 
u_
.
i
.
ty³
 = 
j_št
;

1528 
	}
}

1529 
šlše
 
	gJsÚ
::
	$JsÚ
(
x
) {

1530 
u_
.
u
.
x
 = x;

1531 
u_
.
u
.
ty³
 = 
j_unsigÃd
;

1532 
	}
}

1533 
šlše
 
	gJsÚ
::
	$JsÚ
(
x
) {

1534 
u_
.
i
.
x
 = x;

1535 
u_
.
i
.
ty³
 = 
j_št
;

1536 
	}
}

1537 
šlše
 
	gJsÚ
::
	$JsÚ
(
x
) {

1538 
u_
.
u
.
x
 = x;

1539 
u_
.
u
.
ty³
 = 
j_unsigÃd
;

1540 
	}
}

1541 
šlše
 
	gJsÚ
::
	$JsÚ
(
x
) {

1542 
u_
.
i
.
x
 = x;

1543 
u_
.
i
.
ty³
 = 
j_št
;

1544 
	}
}

1545 
šlše
 
	gJsÚ
::
	$JsÚ
(
x
) {

1546 
u_
.
u
.
x
 = x;

1547 
u_
.
u
.
ty³
 = 
j_unsigÃd
;

1548 
	}
}

1549 
šlše
 
	gJsÚ
::
	$JsÚ
(
x
) {

1550 
u_
.
d
.
x
 = x;

1551 
u_
.
d
.
ty³
 = 
j_doubË
;

1552 
	}
}

1553 
šlše
 
	gJsÚ
::
	$JsÚ
(
boŞ
 
x
) {

1554 
u_
.
i
.
x
 = x;

1555 
u_
.
i
.
ty³
 = 
j_boŞ
;

1556 
	}
}

1557 
šlše
 
	gJsÚ
::
	$JsÚ
(cÚ¡ 
SŒšg
& 
x
) {

1558 
u_
.
¡r
 = 
x
.
	`š‹º®_»p
();

1559 
u_
.
¡r
.
	`»f
();

1560 
	}
}

1561 
šlše
 
	gJsÚ
::
	$JsÚ
(cÚ¡ 
¡d
::
¡ršg
& 
x
) {

1562 
u_
.
¡r
.
	`»£t_»f
();

1563 
SŒšg
 
	`¡r
(
x
);

1564 
¡r
.
	`sw­
(
u_
.str);

1565 
	}
}

1566 
šlše
 
	gJsÚ
::
	$JsÚ
(
SŒ
 
x
) {

1567 
u_
.
¡r
.
	`»£t_»f
();

1568 
SŒšg
 
	`¡r
(
x
);

1569 
¡r
.
	`sw­
(
u_
.str);

1570 
	}
}

1571 
šlše
 
	gJsÚ
::
	$JsÚ
(cÚ¡ * 
x
) {

1572 
u_
.
¡r
.
	`»£t_»f
();

1573 
SŒšg
 
	`¡r
(
x
);

1574 
¡r
.
	`sw­
(
u_
.str);

1575 
	}
}

1577 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1578 
šlše
 
	gJsÚ
::
JsÚ
(cÚ¡ 
¡d
::
veùÜ
<
T
> &
x
) {

1579 
u_
.
a
.
ty³
 = 
j_¬¿y
;

1580 
	gu_
.
	ga
.
	gx
 = 
A¼ayJsÚ
::
make
((
x
.
size
()));

1581 
ty³Çme
 
	g¡d
::
veùÜ
<
T
>::
cÚ¡_™”©Ü
 
™
 = 
x
.
begš
();

1582 
	g™
 !ğ
x
.
’d
(); ++it) {

1583 
Ãw
((*è&
u_
.
a
.
x
->a[u_.a.x->
size
]è
JsÚ
(*
™
);

1584 ++
	gu_
.
	ga
.
	gx
->
	gsize
;

1588 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	sJsÚ_™”©Ü_š™Ÿliz”
 {

1589 
	g‹m¶©e
 <
ty³Çme
 
	gI
>

1590 
šlše
 
run
(
JsÚ
& 
j
, 
I
 
fœ¡
, I 
Ï¡
) {

1591 
	gj
 = 
JsÚ
::
make_¬¿y
(); 
	gfœ¡
 !ğ
Ï¡
; ++first)

1592 
	gj
.
push_back
(
JsÚ
(*
fœ¡
));

1595 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

1596 
	gJsÚ_™”©Ü_š™Ÿliz”
<
	g¡d
::
·œ
<
T
, 
	gU
> > {

1597 
	g‹m¶©e
 <
ty³Çme
 
	gI
>

1598 
šlše
 
run
(
JsÚ
& 
j
, 
I
 
fœ¡
, I 
Ï¡
) {

1599 
	gj
 = 
JsÚ
::
make_objeù
(); 
	gfœ¡
 !ğ
Ï¡
; ++first)

1600 
	gj
.
£t
((*
fœ¡
).fœ¡, (*fœ¡).
£cÚd
);

1606 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1607 
šlše
 
	gJsÚ
::
	$JsÚ
(
T
 
fœ¡
, T 
Ï¡
) {

1608 
u_
.
a
.
ty³
 = 0;

1609 
JsÚ_™”©Ü_š™Ÿliz”
<
ty³Çme
 
¡d
::
™”©Ü_Œa™s
<
T
>::
v®ue_ty³
>::
	`run
(*
this
, 
fœ¡
, 
Ï¡
);

1610 
	}
}

1613 
šlše
 
	gJsÚ
::
	$d”ef
() {

1614 ià(
u_
.
x
.
ty³
 < 0)

1615 
u_
.
¡r
.
	`d”ef
();

1616 ià(
u_
.
x
.x && (u_.x.
ty³
 - 
j_¬¿y
) < 2)

1617 
u_
.
x
.x->
	`d”ef
(
	`jsÚ_ty³
(u_.x.
ty³
));

1618 
	}
}

1621 
šlše
 
	gJsÚ
::~
	$JsÚ
() {

1622 
	`d”ef
();

1623 
	}
}

1626 
šlše
 
JsÚ
 
	gJsÚ
::
	$make_¬¿y
() {

1627 
JsÚ
 
j
;

1628 
j
.
u_
.
x
.
ty³
 = 
j_¬¿y
;

1629  
j
;

1630 
	}
}

1632 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

1633 
šlše
 
JsÚ
 
	gJsÚ
::
	$¬¿y
(
Args
&&... 
¬gs
) {

1634 
JsÚ
 
j
;

1635 
j
.
u_
.
x
.
ty³
 = 
j_¬¿y
;

1636 
j
.
	`»£rve
(...(
¬gs
));

1637 
j
.
	`push_back_li¡
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

1638  
j
;

1639 
	}
}

1641 
šlše
 
JsÚ
 
	gJsÚ
::
	$make_¬¿y_»£rve
(
n
) {

1642 
JsÚ
 
j
;

1643 
j
.
u_
.
a
.
ty³
 = 
j_¬¿y
;

1644 
j
.
u_
.
a
.
x
 = 
n
 ? 
A¼ayJsÚ
::
	`make
(n) : 0;

1645  
j
;

1646 
	}
}

1648 
šlše
 
JsÚ
 
	gJsÚ
::
	$make_objeù
() {

1649 
JsÚ
 
j
;

1650 
j
.
u_
.
o
.
ty³
 = 
j_objeù
;

1651  
j
;

1652 
	}
}

1654 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

1655 
šlše
 
JsÚ
 
	gJsÚ
::
	$objeù
(
Args
&&... 
»¡
) {

1656 
JsÚ
 
j
;

1657 
j
.
u_
.
o
.
ty³
 = 
j_objeù
;

1658 
j
.
	`£t_li¡
(
¡d
::
fÜw¬d
<
Args
>(
»¡
)...);

1659  
j
;

1660 
	}
}

1662 
šlše
 
JsÚ
 
	gJsÚ
::
	$make_¡ršg
(cÚ¡ 
SŒšg
& 
x
) {

1663  
	`JsÚ
(
x
);

1664 
	}
}

1666 
šlše
 
JsÚ
 
	gJsÚ
::
	$make_¡ršg
(cÚ¡ 
¡d
::
¡ršg
& 
x
) {

1667  
	`JsÚ
(
x
);

1668 
	}
}

1670 
šlše
 
JsÚ
 
	gJsÚ
::
	$make_¡ršg
(cÚ¡ *
s
, 
Ën
) {

1671  
	`JsÚ
(
	`SŒšg
(
s
, 
Ën
));

1672 
	}
}

1675 
šlše
 
boŞ
 
	gJsÚ
::
	$Œuthy
() const {

1676  (
u_
.
x
.x ? u_.x.
ty³
 >ğ0 || u_.
¡r
.
Ëngth


1677 : (è(
u_
.
x
.
ty³
 - 1è< (è(
j_št
 - 1));

1678 
	}
}

1680 
šlše
 
boŞ
 
	gJsÚ
::
	$çlsy
() const {

1681  !
	`Œuthy
();

1682 
	}
}

1685 
šlše
 
	gJsÚ
::
İ”©Ü
 
	$un¥ecif›d_boŞ_ty³
() const {

1686  
	`Œuthy
(è? &
JsÚ
::
is_nuÎ
 : 0;

1687 
	}
}

1689 
šlše
 
boŞ
 
	gJsÚ
::
İ”©Ü
!() const {

1690  !
Œuthy
();

1694 
šlše
 
boŞ
 
	gJsÚ
::
	$is_nuÎ
() const {

1695  !
u_
.
x
.x && u_.x.
ty³
 =ğ
j_nuÎ
;

1696 
	}
}

1697 
šlše
 
boŞ
 
	gJsÚ
::
	$is_št
() const {

1698  (
u_
.
x
.
ty³
 - 
j_št
è<ğ(
j_unsigÃd
 - j_int);

1699 
	}
}

1700 
šlše
 
boŞ
 
	gJsÚ
::
	$is_i
() const {

1701  
	`is_št
();

1702 
	}
}

1703 
šlše
 
boŞ
 
	gJsÚ
::
	$is_unsigÃd
() const {

1704  
u_
.
x
.
ty³
 =ğ
j_unsigÃd
;

1705 
	}
}

1706 
šlše
 
boŞ
 
	gJsÚ
::
	$is_u
() const {

1707  
	`is_unsigÃd
();

1708 
	}
}

1709 
šlše
 
boŞ
 
	gJsÚ
::
	$is_sigÃd
() const {

1710  
u_
.
x
.
ty³
 =ğ
j_št
;

1711 
	}
}

1712 
šlše
 
boŞ
 
	gJsÚ
::
	$is_nÚÃgšt
() const {

1713  
u_
.
x
.
ty³
 =ğ
j_unsigÃd


1714 || (
u_
.
x
.
ty³
 =ğ
j_št
 && u_.
i
.x >= 0);

1715 
	}
}

1716 
šlše
 
boŞ
 
	gJsÚ
::
	$is_doubË
() const {

1717  
u_
.
x
.
ty³
 =ğ
j_doubË
;

1718 
	}
}

1719 
šlše
 
boŞ
 
	gJsÚ
::
	$is_d
() const {

1720  
	`is_doubË
();

1721 
	}
}

1722 
šlše
 
boŞ
 
	gJsÚ
::
	$is_numb”
() const {

1723  (
u_
.
x
.
ty³
 - 
j_št
è<ğ(
j_doubË
 - j_int);

1724 
	}
}

1725 
šlše
 
boŞ
 
	gJsÚ
::
	$is_n
() const {

1726  
	`is_numb”
();

1727 
	}
}

1728 
šlše
 
boŞ
 
	gJsÚ
::
	$is_boŞ
() const {

1729  
u_
.
x
.
ty³
 =ğ
j_boŞ
;

1730 
	}
}

1731 
šlše
 
boŞ
 
	gJsÚ
::
	$is_b
() const {

1732  
	`is_boŞ
();

1733 
	}
}

1734 
šlše
 
boŞ
 
	gJsÚ
::
	$is_¡ršg
() const {

1735  
u_
.
x
.x && u_.x.
ty³
 <= 0;

1736 
	}
}

1737 
šlše
 
boŞ
 
	gJsÚ
::
	$is_s
() const {

1738  
	`is_¡ršg
();

1739 
	}
}

1740 
šlše
 
boŞ
 
	gJsÚ
::
	$is_¬¿y
() const {

1741  
u_
.
x
.
ty³
 =ğ
j_¬¿y
;

1742 
	}
}

1743 
šlše
 
boŞ
 
	gJsÚ
::
	$is_a
() const {

1744  
	`is_¬¿y
();

1745 
	}
}

1746 
šlše
 
boŞ
 
	gJsÚ
::
	$is_objeù
() const {

1747  
u_
.
x
.
ty³
 =ğ
j_objeù
;

1748 
	}
}

1749 
šlše
 
boŞ
 
	gJsÚ
::
	$is_o
() const {

1750  
	`is_objeù
();

1751 
	}
}

1753 
šlše
 
boŞ
 
	gJsÚ
::
	$is_´im™ive
() const {

1754  
u_
.
x
.
ty³
 >ğ
j_št
 || (u_.x.x && u_.x.type <= 0);

1755 
	}
}

1759 
šlše
 
boŞ
 
	gJsÚ
::
	$em±y
() const {

1760  (
u_
.
x
.
ty³
è< (
j_št
)

1761 && (!
u_
.
x
.x || u_.x.x->
size
 == 0);

1762 
	}
}

1765 
šlše
 
	gJsÚ
::
size_ty³
 
JsÚ
::
	$size
() const {

1766 
	`´ecÚd™iÚ
((
u_
.
x
.
ty³
è< (
j_št
));

1767  
u_
.
x
.x ? u_.x.x->
size
 : 0;

1768 
	}
}

1770 
šlše
 
boŞ
 
	gJsÚ
::
	$sh¬ed
() const {

1771  
u_
.
x
.x && (u_.x.
ty³
 =ğ
j_¬¿y
 || u_.x.ty³ =ğ
j_objeù
)

1772 && 
u_
.
x
.x->
»fcouÁ
 != 1;

1773 
	}
}

1784 
šlše
 
št64_t
 
	gJsÚ
::
	$to_i
() const {

1785 ià(
	`is_št
())

1786  
u_
.
i
.
x
;

1788  
	`h¬d_to_i
();

1789 
	}
}

1791 
šlše
 
ušt64_t
 
	gJsÚ
::
	$to_u
() const {

1792 ià(
	`is_št
())

1793  
u_
.
u
.
x
;

1795  
	`h¬d_to_u
();

1796 
	}
}

1804 
šlše
 
boŞ
 
	gJsÚ
::
	$to_i
(& 
x
) const {

1805 ià(
	`is_št
()) {

1806 
x
 = 
u_
.
i
.x;

1807  
Œue
;

1808 } ià(
	`is_doubË
(è&& 
u_
.
d
.
x
 == ((u_.d.x))) {

1809 
x
 = (
u_
.
d
.x);

1810  
Œue
;

1812  
çl£
;

1813 
	}
}

1816 
šlše
 
boŞ
 
	gJsÚ
::
	$to_i
(& 
x
) const {

1817 ià(
	`is_št
()) {

1818 
x
 = 
u_
.
u
.x;

1819  
Œue
;

1820 } ià(
	`is_doubË
(è&& 
u_
.
d
.
x
 == ((u_.d.x))) {

1821 
x
 = (
u_
.
d
.x);

1822  
Œue
;

1824  
çl£
;

1825 
	}
}

1828 
šlše
 
boŞ
 
	gJsÚ
::
	$to_i
(& 
x
) const {

1829 ià(
	`is_št
()) {

1830 
x
 = 
u_
.
i
.x;

1831  
Œue
;

1832 } ià(
	`is_doubË
(è&& 
u_
.
d
.
x
 == ((u_.d.x))) {

1833 
x
 = (
u_
.
d
.x);

1834  
Œue
;

1836  
çl£
;

1837 
	}
}

1840 
šlše
 
boŞ
 
	gJsÚ
::
	$to_i
(& 
x
) const {

1841 ià(
	`is_št
()) {

1842 
x
 = 
u_
.
u
.x;

1843  
Œue
;

1844 } ià(
	`is_doubË
(è&& 
u_
.
d
.
x
 == (() u_.d.x)) {

1845 
x
 = (è
u_
.
d
.x;

1846  
Œue
;

1848  
çl£
;

1849 
	}
}

1852 
šlše
 
boŞ
 
	gJsÚ
::
	$to_i
(& 
x
) const {

1853 ià(
	`is_št
()) {

1854 
x
 = 
u_
.
i
.x;

1855  
Œue
;

1856 } ià(
	`is_doubË
(è&& 
u_
.
d
.
x
 == (() u_.d.x)) {

1857 
x
 = (è
u_
.
d
.x;

1858  
Œue
;

1860  
çl£
;

1861 
	}
}

1864 
šlše
 
boŞ
 
	gJsÚ
::
	$to_i
(& 
x
) const {

1865 ià(
	`is_št
()) {

1866 
x
 = 
u_
.
u
.x;

1867  
Œue
;

1868 } ià(
	`is_doubË
(è&& 
u_
.
d
.
x
 == (() u_.d.x)) {

1869 
x
 = (è
u_
.
d
.x;

1870  
Œue
;

1872  
çl£
;

1873 
	}
}

1878 
šlše
 
ušt64_t
 
	gJsÚ
::
	$to_u64
() const {

1879  
	`to_u
();

1880 
	}
}

1885 
šlše
 
št64_t
 
	gJsÚ
::
	$as_i
() const {

1886 
	`´ecÚd™iÚ
(
	`is_št
(è|| 
	`is_doubË
());

1887  
	`is_št
(è? 
u_
.
i
.
x
 : 
	`št64_t
(u_.
d
.x);

1888 
	}
}

1891 
šlše
 
št64_t
 
	gJsÚ
::
	$as_i
(
št64_t
 
deçuÉ_v®ue
) const {

1892 ià(
	`is_št
(è|| 
	`is_doubË
())

1893  
	`as_i
();

1895  
deçuÉ_v®ue
;

1896 
	}
}

1901 
šlše
 
ušt64_t
 
	gJsÚ
::
	$as_u
() const {

1902 
	`´ecÚd™iÚ
(
	`is_št
(è|| 
	`is_doubË
());

1903  
	`is_št
(è? 
u_
.
u
.
x
 : 
	`ušt64_t
(u_.
d
.x);

1904 
	}
}

1907 
šlše
 
ušt64_t
 
	gJsÚ
::
	$as_u
(
ušt64_t
 
deçuÉ_v®ue
) const {

1908 ià(
	`is_št
(è|| 
	`is_doubË
())

1909  
	`as_u
();

1911  
deçuÉ_v®ue
;

1912 
	}
}

1921 
šlše
 
	gJsÚ
::
	$to_d
() const {

1922 ià(
	`is_doubË
())

1923  
u_
.
d
.
x
;

1925  
	`h¬d_to_d
();

1926 
	}
}

1933 
šlše
 
boŞ
 
	gJsÚ
::
	$to_d
(& 
x
) const {

1934 ià(
	`is_doubË
(è|| 
	`is_št
()) {

1935 
x
 = 
	`to_d
();

1936  
Œue
;

1938  
çl£
;

1939 
	}
}

1944 
šlše
 
	gJsÚ
::
	$as_d
() const {

1945 
	`´ecÚd™iÚ
(
	`is_doubË
(è|| 
	`is_št
());

1946 ià(
	`is_doubË
())

1947  
u_
.
d
.
x
;

1948 ià(
u_
.
x
.
ty³
 =ğ
j_št
)

1949  
u_
.
i
.
x
;

1951  
u_
.
u
.
x
;

1952 
	}
}

1955 
šlše
 
	gJsÚ
::
	$as_d
(
deçuÉ_v®ue
) const {

1956 ià(!
	`is_doubË
(è&& !
	`is_št
())

1957  
deçuÉ_v®ue
;

1959  
	`as_d
();

1960 
	}
}

1969 
šlše
 
boŞ
 
	gJsÚ
::
	$to_b
() const {

1970 ià(
	`is_boŞ
())

1971  
u_
.
i
.
x
;

1973  
	`h¬d_to_b
();

1974 
	}
}

1981 
šlše
 
boŞ
 
	gJsÚ
::
	$to_b
(
boŞ
& 
x
) const {

1982 ià(
	`is_boŞ
()) {

1983 
x
 = 
u_
.
i
.x;

1984  
Œue
;

1986  
çl£
;

1987 
	}
}

1992 
šlše
 
boŞ
 
	gJsÚ
::
	$as_b
() const {

1993 
	`´ecÚd™iÚ
(
	`is_boŞ
());

1994  
u_
.
i
.
x
;

1995 
	}
}

1998 
šlše
 
boŞ
 
	gJsÚ
::
	$as_b
(
boŞ
 
deçuÉ_v®ue
) const {

1999 ià(
	`is_boŞ
())

2000  
	`as_b
();

2002  
deçuÉ_v®ue
;

2003 
	}
}

2012 
šlše
 
SŒšg
 
	gJsÚ
::
	$to_s
() const {

2013 ià(
u_
.
x
.
ty³
 <= 0 && u_.x.x)

2014  
	`SŒšg
(
u_
.
¡r
);

2016  
	`h¬d_to_s
();

2017 
	}
}

2024 
šlše
 
boŞ
 
	gJsÚ
::
	$to_s
(
SŒ
& 
x
) const {

2025 ià(
u_
.
x
.
ty³
 <= 0 && u_.x.x) {

2026 
x
.
	`assign
(
u_
.
¡r
.
d©a
, u_.¡r.
Ëngth
);

2027  
Œue
;

2029  
çl£
;

2030 
	}
}

2037 
šlše
 
boŞ
 
	gJsÚ
::
	$to_s
(
SŒšg
& 
x
) const {

2038 ià(
u_
.
x
.
ty³
 <= 0 && u_.x.x) {

2039 
x
.
	`assign
(
u_
.
¡r
);

2040  
Œue
;

2042  
çl£
;

2043 
	}
}

2048 
šlše
 cÚ¡ 
	gSŒšg
& 
	gJsÚ
::
	$as_s
() const {

2049 
	`´ecÚd™iÚ
(
u_
.
x
.
ty³
 <= 0 && u_.x.x);

2050  
»š‹½»t_ÿ¡
<cÚ¡ 
SŒšg
&>(
u_
.
¡r
);

2051 
	}
}

2054 
šlše
 
	gSŒšg
& 
	gJsÚ
::
	$as_s
() {

2055 
	`´ecÚd™iÚ
(
u_
.
x
.
ty³
 <= 0 && u_.x.x);

2056  
»š‹½»t_ÿ¡
<
SŒšg
&>(
u_
.
¡r
);

2057 
	}
}

2060 
šlše
 cÚ¡ 
	gSŒšg
& 
	gJsÚ
::
	$as_s
(cÚ¡ 
SŒšg
& 
deçuÉ_v®ue
) const {

2061 ià(
u_
.
x
.
ty³
 > 0 || !u_.x.x)

2062  
deçuÉ_v®ue
;

2064  
	`as_s
();

2065 
	}
}

2067 
šlše
 
	gJsÚ
::
	$fÜû_numb”
() {

2068 
	`´ecÚd™iÚ
((
u_
.
x
.
ty³
 =ğ
j_nuÎ
 && !u_.x.xè|| u_.x.ty³ =ğ
j_št
 || u_.x.ty³ =ğ
j_doubË
);

2069 ià(
u_
.
x
.
ty³
 =ğ
j_nuÎ
 && !u_.x.x)

2070 
u_
.
x
.
ty³
 = 
j_št
;

2071 
	}
}

2073 
šlše
 
	gJsÚ
::
	$fÜû_doubË
() {

2074 
	`´ecÚd™iÚ
((
u_
.
x
.
ty³
 =ğ
j_nuÎ
 && !u_.x.xè|| u_.x.ty³ =ğ
j_št
 || u_.x.ty³ =ğ
j_doubË
);

2075 ià(
u_
.
x
.
ty³
 =ğ
j_nuÎ
 && !u_.x.x)

2076 
u_
.
x
.
ty³
 = 
j_doubË
;

2077 ià(
u_
.
x
.
ty³
 =ğ
j_št
) {

2078 
u_
.
d
.
x
 = u_.
i
.x;

2079 
u_
.
d
.
ty³
 = 
j_doubË
;

2080 } ià(
u_
.
x
.
ty³
 =ğ
j_unsigÃd
) {

2081 
u_
.
d
.
x
 = u_.
u
.x;

2082 
u_
.
d
.
ty³
 = 
j_doubË
;

2084 
	}
}

2092 
šlše
 
	gJsÚ
::
size_ty³
 
JsÚ
::
	$couÁ
(
SŒ
 
key
) const {

2093 
	`´ecÚd™iÚ
(
u_
.
x
.
ty³
 =ğ
j_nuÎ
 || u_.x.ty³ =ğ
j_objeù
);

2094  
u_
.
o
.
x
 ? 
	`ojsÚ
()->
	`fšd
(
key
.
	`d©a
(), key.
	`Ëngth
()) >= 0 : 0;

2095 
	}
}

2102 
šlše
 cÚ¡ 
	gJsÚ
& JsÚ::
	$g‘
(
SŒ
 
key
) const {

2103 
i
;

2104 
ObjeùJsÚ
 *
oj
;

2105 ià(
	`is_objeù
(è&& (
oj
 = 
	`ojsÚ
())

2106 && (
i
 = 
oj
->
	`fšd
(
key
.
	`d©a
(), key.
	`Ëngth
())) >= 0)

2107  
oj
->
	`™em
(
i
).
v_
.
£cÚd
;

2109  
	`h¬d_g‘
(
key
);

2110 
	}
}

2117 
šlše
 
	gJsÚ
& JsÚ::
	$g‘_š£¹
(cÚ¡ 
SŒšg
 &
key
) {

2118 
	`uniqueify_objeù
(
Œue
);

2119  
	`ojsÚ
()->
	`g‘_š£¹
(
key
);

2120 
	}
}

2123 
šlše
 
	gJsÚ
& JsÚ::
	$g‘_š£¹
(
SŒ
 
key
) {

2124 
	`uniqueify_objeù
(
Œue
);

2125  
	`ojsÚ
()->
	`g‘_š£¹
(
key
);

2126 
	}
}

2129 
šlše
 
	gJsÚ
& JsÚ::
	$g‘_š£¹
(cÚ¡ *
key
) {

2130 
	`uniqueify_objeù
(
Œue
);

2131  
	`ojsÚ
()->
	`g‘_š£¹
(
	`SŒ
(
key
));

2132 
	}
}

2135 
šlše
 
	gJsÚ
::
	$g‘_i
(
SŒ
 
key
) const {

2136  
	`g‘
(
key
).
	`to_i
();

2137 
	}
}

2140 
šlše
 
	gJsÚ
::
	$g‘_d
(
SŒ
 
key
) const {

2141  
	`g‘
(
key
).
	`to_d
();

2142 
	}
}

2145 
šlše
 
boŞ
 
	gJsÚ
::
	$g‘_b
(
SŒ
 
key
) const {

2146  
	`g‘
(
key
).
	`to_b
();

2147 
	}
}

2150 
šlše
 
SŒšg
 
	gJsÚ
::
	$g‘_s
(
SŒ
 
key
) const {

2151  
	`g‘
(
key
).
	`to_s
();

2152 
	}
}

2196 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ
::
	$g‘
(
SŒ
 
key
, 
JsÚ
& 
x
) const {

2197 
i
;

2198 
ObjeùJsÚ
 *
oj
;

2199 ià(
	`is_objeù
(è&& (
oj
 = 
	`ojsÚ
())

2200 && (
i
 = 
oj
->
	`fšd
(
key
.
	`d©a
(), key.
	`Ëngth
())) >= 0) {

2201 
x
 = 
oj
->
	`™em
(
i
).
v_
.
£cÚd
;

2202  
	`JsÚ_g‘_´oxy
(*
this
, 
Œue
);

2204  
	`JsÚ_g‘_´oxy
(*
this
, 
çl£
);

2205 
	}
}

2208 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ
::
	$g‘
(
SŒ
 
key
, &
x
) const {

2209  
	`JsÚ_g‘_´oxy
(*
this
, 
	`g‘
(
key
).
	`to_i
(
x
));

2210 
	}
}

2213 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ
::
	$g‘
(
SŒ
 
key
, & 
x
) const {

2214  
	`JsÚ_g‘_´oxy
(*
this
, 
	`g‘
(
key
).
	`to_i
(
x
));

2215 
	}
}

2218 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ
::
	$g‘
(
SŒ
 
key
, & 
x
) const {

2219  
	`JsÚ_g‘_´oxy
(*
this
, 
	`g‘
(
key
).
	`to_i
(
x
));

2220 
	}
}

2223 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ
::
	$g‘
(
SŒ
 
key
, & 
x
) const {

2224  
	`JsÚ_g‘_´oxy
(*
this
, 
	`g‘
(
key
).
	`to_i
(
x
));

2225 
	}
}

2228 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ
::
	$g‘
(
SŒ
 
key
, & 
x
) const {

2229  
	`JsÚ_g‘_´oxy
(*
this
, 
	`g‘
(
key
).
	`to_i
(
x
));

2230 
	}
}

2233 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ
::
	$g‘
(
SŒ
 
key
, & 
x
) const {

2234  
	`JsÚ_g‘_´oxy
(*
this
, 
	`g‘
(
key
).
	`to_i
(
x
));

2235 
	}
}

2238 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ
::
	$g‘
(
SŒ
 
key
, & 
x
) const {

2239  
	`JsÚ_g‘_´oxy
(*
this
, 
	`g‘
(
key
).
	`to_d
(
x
));

2240 
	}
}

2243 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ
::
	$g‘
(
SŒ
 
key
, 
boŞ
& 
x
) const {

2244  
	`JsÚ_g‘_´oxy
(*
this
, 
	`g‘
(
key
).
	`to_b
(
x
));

2245 
	}
}

2248 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ
::
	$g‘
(
SŒ
 
key
, SŒ& 
x
) const {

2249  
	`JsÚ_g‘_´oxy
(*
this
, 
	`g‘
(
key
).
	`to_s
(
x
));

2250 
	}
}

2253 
šlše
 cÚ¡ 
JsÚ_g‘_´oxy
 
	gJsÚ
::
	$g‘
(
SŒ
 
key
, 
SŒšg
& 
x
) const {

2254  
	`JsÚ_g‘_´oxy
(*
this
, 
	`g‘
(
key
).
	`to_s
(
x
));

2255 
	}
}

2260 
šlše
 cÚ¡ 
	gJsÚ
& JsÚ::
İ”©Ü
[](
SŒ
 
key
) const {

2261  
g‘
(
key
);

2270 
šlše
 
	gJsÚ_objeù_´oxy
<
	gJsÚ
> JsÚ::
İ”©Ü
[](cÚ¡ 
SŒšg
& 
key
) {

2271  
JsÚ_objeù_´oxy
<
JsÚ
>(*
this
, 
	gkey
);

2275 
šlše
 
	gJsÚ_objeù_¡r_´oxy
<
	gJsÚ
> JsÚ::
İ”©Ü
[](cÚ¡ 
¡d
::
¡ršg
& 
key
) {

2276  
JsÚ_objeù_¡r_´oxy
<
JsÚ
>(*
this
, 
SŒ
(
key
.
d©a
(), key.
Ëngth
()));

2280 
šlše
 
	gJsÚ_objeù_¡r_´oxy
<
	gJsÚ
> JsÚ::
İ”©Ü
[](
SŒ
 
key
) {

2281  
JsÚ_objeù_¡r_´oxy
<
JsÚ
>(*
this
, 
	gkey
);

2285 
šlše
 
	gJsÚ_objeù_¡r_´oxy
<
	gJsÚ
> JsÚ::
İ”©Ü
[](cÚ¡ * 
key
) {

2286  
JsÚ_objeù_¡r_´oxy
<
JsÚ
>(*
this
, 
	gkey
);

2291 
šlše
 cÚ¡ 
	gJsÚ
& JsÚ::
	$©
(
SŒ
 
key
) const {

2292 
	`´ecÚd™iÚ
(
	`is_objeù
(è&& 
u_
.
o
.
x
);

2293 
ObjeùJsÚ
 *
oj
 = 
	`ojsÚ
();

2294 
i
 = 
oj
->
	`fšd
(
key
.
	`d©a
(), key.
	`Ëngth
());

2295 
	`´ecÚd™iÚ
(
i
 >= 0);

2296  
oj
->
	`™em
(
i
).
v_
.
£cÚd
;

2297 
	}
}

2303 
šlše
 
	gJsÚ
& JsÚ::
	$©_š£¹
(cÚ¡ 
SŒšg
 &
key
) {

2304 
	`´ecÚd™iÚ
(
	`is_objeù
());

2305  
	`g‘_š£¹
(
key
);

2306 
	}
}

2309 
šlše
 
	gJsÚ
& JsÚ::
	$©_š£¹
(
SŒ
 
key
) {

2310 
	`´ecÚd™iÚ
(
	`is_objeù
());

2311  
	`g‘_š£¹
(
key
);

2312 
	}
}

2315 
šlše
 
	gJsÚ
& JsÚ::
	$©_š£¹
(cÚ¡ *
key
) {

2316 
	`´ecÚd™iÚ
(
	`is_objeù
());

2317  
	`g‘_š£¹
(
	`SŒ
(
key
));

2318 
	}
}

2325 
šlše
 
	gJsÚ
& JsÚ::
	$£t
(cÚ¡ 
SŒšg
& 
key
, 
JsÚ
 
v®ue
) {

2326 
	`uniqueify_objeù
(
Œue
);

2327 
	`ojsÚ
()->
	`g‘_š£¹
(
key
èğ
¡d
::
	`move
(
v®ue
);

2328  *
this
;

2329 
	}
}

2332 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

2333 
šlše
 
	gJsÚ
& JsÚ::
£t
(cÚ¡ 
SŒšg
& 
key
, cÚ¡ 
JsÚ_´oxy_ba£
<
P
>& 
v®ue
) {

2334 
uniqueify_objeù
(
Œue
);

2335 
ojsÚ
()->
g‘_š£¹
(
key
èğ
v®ue
.
cv®ue
();

2336  *
	gthis
;

2342 
šlše
 
	gJsÚ
& JsÚ::
	$un£t
(
SŒ
 
key
) {

2343 ià(
	`is_objeù
()) {

2344 
	`uniqueify_objeù
(
Œue
);

2345 
	`ojsÚ
()->
	`”a£
(
key
);

2347  *
this
;

2348 
	}
}

2355 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

2356 
šlše
 
	gJsÚ
& JsÚ::
	$£t_li¡
(cÚ¡ 
SŒšg
& 
key
, 
T
 
v®ue
, 
Args
&&... 
»¡
) {

2357 
	`£t
(
key
, 
¡d
::
	`move
(
v®ue
));

2358 
	`£t_li¡
(
¡d
::
fÜw¬d
<
Args
>(
»¡
)...);

2359  *
this
;

2360 
	}
}

2363 
šlše
 
	gJsÚ
& JsÚ::
	$£t_li¡
() {

2364  *
this
;

2365 
	}
}

2374 
šlše
 
	g¡d
::
·œ
<
JsÚ
::
objeù_™”©Ü
, 
	gboŞ
> 
	gJsÚ
::
	$š£¹
(cÚ¡ 
objeù_v®ue_ty³
& 
x
) {

2375 
	`´ecÚd™iÚ
(
	`is_objeù
());

2376 
	`uniqueify_objeù
(
çl£
);

2377 
ObjeùJsÚ
 *
oj
 = 
	`ojsÚ
();

2378 
n
 = 
oj
->
n_
, 
i
 = oj->
	`fšd_š£¹
(
x
.
fœ¡
, x.
£cÚd
);

2379  
¡d
::
	`make_·œ
(
	`objeù_™”©Ü
(
this
, 
i
), i =ğ
n
);

2380 
	}
}

2390 
šlše
 
	gJsÚ
::
objeù_™”©Ü
 
JsÚ
::
	$š£¹
(
objeù_™”©Ü
 
pos™iÚ
, cÚ¡ 
objeù_v®ue_ty³
& 
x
) {

2391 (è
pos™iÚ
;

2392  
	`š£¹
(
x
).
fœ¡
;

2393 
	}
}

2398 
šlše
 
	gJsÚ
::
objeù_™”©Ü
 
JsÚ
::
	$”a£
(
JsÚ
::
objeù_™”©Ü
 
™
) {

2399 
	`´ecÚd™iÚ
(
	`is_objeù
(è&& 
™
.
	`live
(è&& it.
j_
 =ğ
this
);

2400 
	`uniqueify_objeù
(
çl£
);

2401 
	`ojsÚ
()->
	`”a£
(
™
.
i_
);

2402 ++
™
;

2403  
™
;

2404 
	}
}

2409 
šlše
 
	gJsÚ
::
size_ty³
 
JsÚ
::
	$”a£
(
SŒ
 
key
) {

2410 
	`´ecÚd™iÚ
(
	`is_objeù
());

2411 
	`uniqueify_objeù
(
çl£
);

2412  
	`ojsÚ
()->
	`”a£
(
key
);

2413 
	}
}

2422 
šlše
 
	gJsÚ
& JsÚ::
	$m”ge
(cÚ¡ 
JsÚ
& 
x
) {

2423 
	`´ecÚd™iÚ
(
	`is_objeù
(è|| 
	`is_nuÎ
());

2424 
	`´ecÚd™iÚ
(
x
.
	`is_objeù
(è|| x.
	`is_nuÎ
());

2425 ià(
x
.
u_
.
o
.x) {

2426 
	`uniqueify_objeù
(
çl£
);

2427 
ObjeùJsÚ
 *
oj
 = 
	`ojsÚ
(), *
xoj
 = 
x
.ojson();

2428 cÚ¡ 
ObjeùI‹m
 *
xb
 = 
xoj
->
os_
, *
xe
 = xb + xoj->
n_
;

2429 ; 
xb
 !ğ
xe
; ++xb)

2430 ià(
xb
->
Ãxt_
 > -2)

2431 
oj
->
	`g‘_š£¹
(
xb
->
v_
.
fœ¡
èğxb->v_.
£cÚd
;

2433  *
this
;

2434 
	}
}

2437 
	g‹m¶©e
 <
ty³Çme
 
	gU
>

2438 
šlše
 
	gJsÚ
& JsÚ::
m”ge
(cÚ¡ 
JsÚ_´oxy_ba£
<
U
>& 
x
) {

2439  
m”ge
(
x
.
cv®ue
());

2451 
šlše
 cÚ¡ 
	gJsÚ
& JsÚ::
	$g‘
(
size_ty³
 
x
) const {

2452 
A¼ayJsÚ
 *
aj
;

2453 ià(
u_
.
x
.
ty³
 =ğ
j_¬¿y
 && (
aj
 = 
	`ajsÚ
()è&& (xè< ×j->
size
))

2454  
aj
->
a
[
x
];

2456  
	`h¬d_g‘
(
x
);

2457 
	}
}

2464 
šlše
 
	gJsÚ
& JsÚ::
	$g‘_š£¹
(
size_ty³
 
x
) {

2465 
A¼ayJsÚ
 *
aj
;

2466 ià(
u_
.
x
.
ty³
 =ğ
j_¬¿y
 && (
aj
 = 
	`ajsÚ
()è&&‡j->
»fcouÁ
 == 1

2467 && (
x
è< (
aj
->
size
))

2468  
aj
->
a
[
x
];

2470  
	`h¬d_g‘_š£¹
(
x
);

2471 
	}
}

2477 
šlše
 cÚ¡ 
	gJsÚ
& JsÚ::
	$©
(
size_ty³
 
x
) const {

2478 
	`´ecÚd™iÚ
(
	`is_¬¿y
());

2479  
	`g‘
(
x
);

2480 
	}
}

2486 
šlše
 
	gJsÚ
& JsÚ::
	$©_š£¹
(
size_ty³
 
x
) {

2487 
	`´ecÚd™iÚ
(
	`is_¬¿y
());

2488  
	`g‘_š£¹
(
x
);

2489 
	}
}

2496 
šlše
 cÚ¡ 
	gJsÚ
& JsÚ::
İ”©Ü
[](
size_ty³
 
x
) const {

2497  
g‘
(
x
);

2507 
šlše
 
	gJsÚ_¬¿y_´oxy
<
	gJsÚ
> JsÚ::
İ”©Ü
[](
size_ty³
 
x
) {

2508  
JsÚ_¬¿y_´oxy
<
JsÚ
>(*
this
, 
	gx
);

2513 
šlše
 cÚ¡ 
	gJsÚ
& JsÚ::
	$back
() const {

2514 
	`´ecÚd™iÚ
(
	`is_¬¿y
(è&& 
u_
.
a
.
x
 && u_.a.x->
size
 > 0);

2515  
u_
.
a
.
x
->a[u_.a.x->
size
 - 1];

2516 
	}
}

2520 
šlše
 
	gJsÚ
& JsÚ::
	$back
() {

2521 
	`´ecÚd™iÚ
(
	`is_¬¿y
(è&& 
u_
.
a
.
x
 && u_.a.x->
size
 > 0);

2522 
	`uniqueify_¬¿y
(
çl£
, 0);

2523  
u_
.
a
.
x
->a[u_.a.x->
size
 - 1];

2524 
	}
}

2531 
šlše
 
	gJsÚ
& JsÚ::
	$push_back
(
JsÚ
 
x
) {

2532 
	`Ãw
(
	`uniqueify_¬¿y_š£¹
(
çl£
, -1)è
	`JsÚ
(
¡d
::
	`move
(
x
));

2533  *
this
;

2534 
	}
}

2537 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
šlše
 
	gJsÚ
& JsÚ::
push_back
(cÚ¡ 
JsÚ_´oxy_ba£
<
P
>& 
x
) {

2538 
Ãw
(
uniqueify_¬¿y_š£¹
(
çl£
, -1)è
JsÚ
(
x
.
cv®ue
());

2539  *
	gthis
;

2544 
šlše
 
	gJsÚ
::
	$pİ_back
() {

2545 
	`´ecÚd™iÚ
(
	`is_¬¿y
(è&& 
u_
.
a
.
x
 && u_.a.x->
size
 > 0);

2546 
	`uniqueify_¬¿y
(
çl£
, 0);

2547 --
u_
.
a
.
x
->
size
;

2548 
u_
.
a
.
x
->a[u_.a.x->
size
].~
	`JsÚ
();

2549 
	}
}

2551 
šlše
 
	gJsÚ
& JsÚ::
	$push_back_li¡
() {

2552  *
this
;

2553 
	}
}

2560 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

2561 
šlše
 
	gJsÚ
& JsÚ::
	$push_back_li¡
(
T
 
fœ¡
, 
Args
&&... 
»¡
) {

2562 
	`push_back
(
¡d
::
	`move
(
fœ¡
));

2563 
	`push_back_li¡
(
¡d
::
fÜw¬d
<
Args
>(
»¡
)...);

2564  *
this
;

2565 
	}
}

2573 
šlše
 
	gJsÚ
::
¬¿y_™”©Ü
 
JsÚ
::
	$š£¹
(
¬¿y_™”©Ü
 
pos™iÚ
, 
JsÚ
 
x
) {

2574 
	`´ecÚd™iÚ
(
pos™iÚ
 >ğ
	`abegš
(è&&…os™iÚ <ğ
	`«nd
());

2575 
size_ty³
 
pos
 = 
pos™iÚ
 - 
	`abegš
();

2576 
	`Ãw
(
	`uniqueify_¬¿y_š£¹
(
çl£
, 
pos
)è
	`JsÚ
(
¡d
::
	`move
(
x
));

2577  
	`abegš
(è+ 
pos
;

2578 
	}
}

2581 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
šlše
 
	gJsÚ
::
¬¿y_™”©Ü
 
JsÚ
::
š£¹
×¼ay_™”©Ü 
pos™iÚ
, cÚ¡ 
JsÚ_´oxy_ba£
<
P
>& 
x
) {

2582 
´ecÚd™iÚ
(
pos™iÚ
 >ğ
abegš
(è&&…os™iÚ <ğ
«nd
());

2583 
size_ty³
 
	gpos
 = 
pos™iÚ
 - 
abegš
();

2584 
Ãw
(
uniqueify_¬¿y_š£¹
(
çl£
, 
pos
)è
JsÚ
(
x
.
cv®ue
());

2585  
abegš
(è+ 
	gpos
;

2588 
šlše
 
	gJsÚ
::
¬¿y_™”©Ü
 
JsÚ
::
	$”a£
(
¬¿y_™”©Ü
 
pos™iÚ
) {

2589  
	`”a£
(
pos™iÚ
,…osition + 1);

2590 
	}
}

2593 
šlše
 
JsÚ
* 
	gJsÚ
::
	$¬¿y_d©a
() {

2594 
	`´ecÚd™iÚ
(
	`is_nuÎ
(è|| 
	`is_¬¿y
());

2595 
	`uniqueify_¬¿y
(
çl£
, 0);

2596  
u_
.
a
.
x
 ? u_.a.x->a : 0;

2597 
	}
}

2599 
šlše
 cÚ¡ 
JsÚ
* 
	gJsÚ
::
	$¬¿y_d©a
() const {

2600 
	`´ecÚd™iÚ
(
	`is_nuÎ
(è|| 
	`is_¬¿y
());

2601  
u_
.
a
.
x
 ? u_.a.x->a : 0;

2602 
	}
}

2604 
šlše
 cÚ¡ 
JsÚ
* 
	gJsÚ
::
	$¬¿y_cd©a
() const {

2605 
	`´ecÚd™iÚ
(
	`is_nuÎ
(è|| 
	`is_¬¿y
());

2606  
u_
.
a
.
x
 ? u_.a.x->a : 0;

2607 
	}
}

2609 
šlše
 
JsÚ
* 
	gJsÚ
::
	$’d_¬¿y_d©a
() {

2610 
	`´ecÚd™iÚ
(
	`is_nuÎ
(è|| 
	`is_¬¿y
());

2611 
	`uniqueify_¬¿y
(
çl£
, 0);

2612  
u_
.
a
.
x
 ? u_.a.x->¨+ u_.a.x->
size
 : 0;

2613 
	}
}

2615 
šlše
 cÚ¡ 
JsÚ
* 
	gJsÚ
::
	$’d_¬¿y_d©a
() const {

2616 
	`´ecÚd™iÚ
(
	`is_nuÎ
(è|| 
	`is_¬¿y
());

2617  
u_
.
a
.
x
 ? u_.a.x->¨+ u_.a.x->
size
 : 0;

2618 
	}
}

2620 
šlše
 cÚ¡ 
JsÚ
* 
	gJsÚ
::
	$’d_¬¿y_cd©a
() const {

2621 
	`´ecÚd™iÚ
(
	`is_nuÎ
(è|| 
	`is_¬¿y
());

2622  
u_
.
a
.
x
 ? u_.a.x->¨+ u_.a.x->
size
 : 0;

2623 
	}
}

2626 
šlše
 
	gJsÚ
::
cÚ¡_objeù_™”©Ü
 
JsÚ
::
	$cobegš
() const {

2627 
	`´ecÚd™iÚ
(
	`is_nuÎ
(è|| 
	`is_objeù
());

2628  
	`cÚ¡_objeù_™”©Ü
(
this
, 0);

2629 
	}
}

2631 
šlše
 
	gJsÚ
::
cÚ¡_objeù_™”©Ü
 
JsÚ
::
	$cÛnd
() const {

2632 
	`´ecÚd™iÚ
(
	`is_nuÎ
(è|| 
	`is_objeù
());

2633  
	`cÚ¡_objeù_™”©Ü
(
this
, -1);

2634 
	}
}

2636 
šlše
 
	gJsÚ
::
cÚ¡_objeù_™”©Ü
 
JsÚ
::
	$obegš
() const {

2637  
	`cobegš
();

2638 
	}
}

2640 
šlše
 
	gJsÚ
::
cÚ¡_objeù_™”©Ü
 
JsÚ
::
	$Ûnd
() const {

2641  
	`cÛnd
();

2642 
	}
}

2644 
šlše
 
	gJsÚ
::
objeù_™”©Ü
 
JsÚ
::
	$obegš
() {

2645 
	`´ecÚd™iÚ
(
	`is_nuÎ
(è|| 
	`is_objeù
());

2646  
	`objeù_™”©Ü
(
this
, 0);

2647 
	}
}

2649 
šlše
 
	gJsÚ
::
objeù_™”©Ü
 
JsÚ
::
	$Ûnd
() {

2650 
	`´ecÚd™iÚ
(
	`is_nuÎ
(è|| 
	`is_objeù
());

2651  
	`objeù_™”©Ü
(
this
, -1);

2652 
	}
}

2654 
šlše
 
	gJsÚ
::
cÚ¡_¬¿y_™”©Ü
 
JsÚ
::
	$ÿbegš
() const {

2655 
	`´ecÚd™iÚ
(
	`is_nuÎ
(è|| 
	`is_¬¿y
());

2656  
	`cÚ¡_¬¿y_™”©Ü
(
this
, 0);

2657 
	}
}

2659 
šlše
 
	gJsÚ
::
cÚ¡_¬¿y_™”©Ü
 
JsÚ
::
	$ÿ’d
() const {

2660 
	`´ecÚd™iÚ
(
	`is_nuÎ
(è|| 
	`is_¬¿y
());

2661 
A¼ayJsÚ
 *
aj
 = 
	`ajsÚ
();

2662  
	`cÚ¡_¬¿y_™”©Ü
(
this
, 
aj
 ?‡j->
size
 : 0);

2663 
	}
}

2665 
šlše
 
	gJsÚ
::
cÚ¡_¬¿y_™”©Ü
 
JsÚ
::
	$abegš
() const {

2666  
	`ÿbegš
();

2667 
	}
}

2669 
šlše
 
	gJsÚ
::
cÚ¡_¬¿y_™”©Ü
 
JsÚ
::
	$«nd
() const {

2670  
	`ÿ’d
();

2671 
	}
}

2673 
šlše
 
	gJsÚ
::
¬¿y_™”©Ü
 
JsÚ
::
	$abegš
() {

2674 
	`´ecÚd™iÚ
(
	`is_nuÎ
(è|| 
	`is_¬¿y
());

2675  
	`¬¿y_™”©Ü
(
this
, 0);

2676 
	}
}

2678 
šlše
 
	gJsÚ
::
¬¿y_™”©Ü
 
JsÚ
::
	$«nd
() {

2679 
	`´ecÚd™iÚ
(
	`is_nuÎ
(è|| 
	`is_¬¿y
());

2680 
A¼ayJsÚ
 *
aj
 = 
	`ajsÚ
();

2681  
	`¬¿y_™”©Ü
(
this
, 
aj
 ?‡j->
size
 : 0);

2682 
	}
}

2684 
šlše
 
	gJsÚ
::
cÚ¡_™”©Ü
 
JsÚ
::
	$cbegš
() const {

2685  
	`cÚ¡_™”©Ü
(
this
, 0);

2686 
	}
}

2688 
šlše
 
	gJsÚ
::
cÚ¡_™”©Ü
 
JsÚ
::
	$ûnd
() const {

2689  
	`cÚ¡_™”©Ü
(
this
, -1);

2690 
	}
}

2692 
šlše
 
	gJsÚ
::
™”©Ü
 
JsÚ
::
	$begš
() {

2693  
	`™”©Ü
(
this
, 0);

2694 
	}
}

2696 
šlše
 
	gJsÚ
::
™”©Ü
 
JsÚ
::
	$’d
() {

2697  
	`™”©Ü
(
this
, -1);

2698 
	}
}

2700 
šlše
 
	gJsÚ
::
cÚ¡_™”©Ü
 
JsÚ
::
	$begš
() const {

2701  
	`cbegš
();

2702 
	}
}

2704 
šlše
 
	gJsÚ
::
cÚ¡_™”©Ü
 
JsÚ
::
	$’d
() const {

2705  
	`ûnd
();

2706 
	}
}

2710 şas 
	cJsÚ
::
uÅ¬£_mªuÏtÜ
 {

2711 
public
:

2712 
uÅ¬£_mªuÏtÜ
()

2713 : 
šd’t_d•th_
(0), 
b_width_
(0), 
Ãwlše_‹rmš©Ü_
(
çl£
),

2714 
¥aû_£·¿tÜ_
(
çl£
) {

2716 
šd’t_d•th
() const {

2717  
	gšd’t_d•th_
;

2719 
uÅ¬£_mªuÏtÜ
 
šd’t_d•th
(
x
) const {

2720 
uÅ¬£_mªuÏtÜ
 
m
(*
this
);

2721 
	gm
.
	gšd’t_d•th_
 = 
x
;

2722  
	gm
;

2724 
b_width
() const {

2725  
	gb_width_
;

2727 
uÅ¬£_mªuÏtÜ
 
b_width
(
x
) const {

2728 
uÅ¬£_mªuÏtÜ
 
m
(*
this
);

2729 
	gm
.
	gb_width_
 = 
x
;

2730  
	gm
;

2732 
boŞ
 
Ãwlše_‹rmš©Ü
() const {

2733  
	gÃwlše_‹rmš©Ü_
;

2735 
uÅ¬£_mªuÏtÜ
 
Ãwlše_‹rmš©Ü
(
boŞ
 
x
) const {

2736 
uÅ¬£_mªuÏtÜ
 
m
(*
this
);

2737 
	gm
.
	gÃwlše_‹rmš©Ü_
 = 
x
;

2738  
	gm
;

2740 
boŞ
 
¥aû_£·¿tÜ
() const {

2741  
	g¥aû_£·¿tÜ_
;

2743 
uÅ¬£_mªuÏtÜ
 
¥aû_£·¿tÜ
(
boŞ
 
x
) const {

2744 
uÅ¬£_mªuÏtÜ
 
m
(*
this
);

2745 
	gm
.
	g¥aû_£·¿tÜ_
 = 
x
;

2746  
	gm
;

2748 
boŞ
 
em±y
() const {

2749  !
	gšd’t_d•th_
 && !
	gÃwlše_‹rmš©Ü_
 && !
	g¥aû_£·¿tÜ_
;

2751 
	g´iv©e
:

2752 
šd’t_d•th_
;

2753 
	gb_width_
;

2754 
boŞ
 
	gÃwlše_‹rmš©Ü_
;

2755 
boŞ
 
	g¥aû_£·¿tÜ_
;

2758 
šlše
 
	gJsÚ
::
uÅ¬£_mªuÏtÜ
 
JsÚ
::
	$šd’t_d•th
(
x
) {

2759  
	`uÅ¬£_mªuÏtÜ
().
	`šd’t_d•th
(
x
);

2760 
	}
}

2761 
šlše
 
	gJsÚ
::
uÅ¬£_mªuÏtÜ
 
JsÚ
::
	$b_width
(
x
) {

2762  
	`uÅ¬£_mªuÏtÜ
().
	`b_width
(
x
);

2763 
	}
}

2764 
šlše
 
	gJsÚ
::
uÅ¬£_mªuÏtÜ
 
JsÚ
::
	$Ãwlše_‹rmš©Ü
(
boŞ
 
x
) {

2765  
	`uÅ¬£_mªuÏtÜ
().
	`Ãwlše_‹rmš©Ü
(
x
);

2766 
	}
}

2767 
šlše
 
	gJsÚ
::
uÅ¬£_mªuÏtÜ
 
JsÚ
::
	$¥aû_£·¿tÜ
(
boŞ
 
x
) {

2768  
	`uÅ¬£_mªuÏtÜ
().
	`¥aû_£·¿tÜ
(
x
);

2769 
	}
}

2772 
šlše
 
SŒšg
 
	gJsÚ
::
	$uÅ¬£
() const {

2773 
SŒšgAccum
 
§
;

2774 
	`h¬d_uÅ¬£
(
§
, 
deçuÉ_mªuÏtÜ
, 0);

2775  
§
.
	`ke_¡ršg
();

2776 
	}
}

2780 
šlše
 
SŒšg
 
	gJsÚ
::
	$uÅ¬£
(cÚ¡ 
uÅ¬£_mªuÏtÜ
 &
m
) const {

2781 
SŒšgAccum
 
§
;

2782 
	`h¬d_uÅ¬£
(
§
, 
m
, 0);

2783  
§
.
	`ke_¡ršg
();

2784 
	}
}

2787 
šlše
 
	gJsÚ
::
	$uÅ¬£
(
SŒšgAccum
 &
§
) const {

2788 
	`h¬d_uÅ¬£
(
§
, 
deçuÉ_mªuÏtÜ
, 0);

2789 
	}
}

2792 
šlše
 
	gJsÚ
::
	$uÅ¬£
(
SŒšgAccum
 &
§
, cÚ¡ 
uÅ¬£_mªuÏtÜ
 &
m
) const {

2793 
	`h¬d_uÅ¬£
(
§
, 
m
, 0);

2794 
	}
}

2799 şas 
	cJsÚ
::
¡»amšg_·r£r
 {

2800 
public
:

2801 
šlše
 
¡»amšg_·r£r
();

2802 
šlše
 
»£t
();

2804 
šlše
 
boŞ
 
dÚe
() const;

2805 
šlše
 
boŞ
 
sucûss
() const;

2806 
šlše
 
boŞ
 
”rÜ
() const;

2808 
šlše
 
size_t
 
cÚsume
(cÚ¡ * 
fœ¡
, size_ˆ
Ëngth
,

2809 cÚ¡ 
SŒšg
& 
¡r
 = String(),

2810 
boŞ
 
com¶‘e
 = 
çl£
);

2811 
šlše
 cÚ¡ * 
cÚsume
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
,

2812 cÚ¡ 
SŒšg
& 
¡r
 = String(),

2813 
boŞ
 
com¶‘e
 = 
çl£
);

2814 cÚ¡ 
ušt8_t
* 
cÚsume
(cÚ¡ ušt8_t* 
fœ¡
, cÚ¡ ušt8_t* 
Ï¡
,

2815 cÚ¡ 
SŒšg
& 
¡r
 = String(),

2816 
boŞ
 
com¶‘e
 = 
çl£
);

2818 
šlše
 
	gJsÚ
& 
»suÉ
();

2819 
šlše
 cÚ¡ 
	gJsÚ
& 
»suÉ
() const;

2821 
	g´iv©e
:

2823 
¡_fš®
 = -2, 
	g¡_”rÜ
 = -1,

2824 
	g¡_·¹Ënmask
 = 0x0F, 
	g¡_·¹mask
 = 0xFF,

2825 
	g¡_¡ršg·¹
 = 0x10, 
	g¡_´im™iv•¬t
 = 0x20, 
	g¡_numb”·¹
 = 0x40,

2827 
	g¡_š™Ÿl
 = 0x000,

2828 
	g¡_¬¿y_š™Ÿl
 = 0x100,

2829 
	g¡_¬¿y_v®ue
 = 0x200,

2830 
	g¡_objeù_v®ue
 = 0x300,

2832 
	g¡_¬¿y_d–im
 = 0x400,

2833 
	g¡_objeù_d–im
 = 0x500,

2834 
	g¡_objeù_š™Ÿl
 = 0x600,

2835 
	g¡_objeù_key
 = 0x700,

2836 
	g¡_objeù_cŞÚ
 = 0x800,

2838 
	gmax_d•th
 = 2048

2841 
	g¡©e_
;

2842 
	g¡d
::
veùÜ
<
JsÚ
*> 
¡ack_
;

2843 
SŒšg
 
	g¡r_
;

2844 
JsÚ
 
	gjsÚ_
;

2846 
šlše
 
JsÚ
* 
cu¼’t
();

2847 cÚ¡ 
ušt8_t
* 
”rÜ_©
(cÚ¡ ušt8_t* 
h”e
);

2848 cÚ¡ 
ušt8_t
* 
cÚsume_¡ršg
(cÚ¡ ušt8_t* 
fœ¡
, cÚ¡ ušt8_t* 
Ï¡
, cÚ¡ 
SŒšg
& 
¡r
);

2849 cÚ¡ 
ušt8_t
* 
cÚsume_back¦ash
(
SŒšgAccum
& 
§
, cÚ¡ ušt8_t* 
fœ¡
, cÚ¡ ušt8_t* 
Ï¡
);

2850 cÚ¡ 
ušt8_t
* 
cÚsume_¡ršg·¹
(
SŒšgAccum
& 
§
, cÚ¡ ušt8_t* 
fœ¡
, cÚ¡ ušt8_t* 
Ï¡
);

2851 cÚ¡ 
ušt8_t
* 
cÚsume_´im™ive
(cÚ¡ ušt8_t* 
fœ¡
, cÚ¡ ušt8_t* 
Ï¡
, 
JsÚ
& 
j
);

2852 cÚ¡ 
ušt8_t
* 
cÚsume_numb”
(cÚ¡ ušt8_t* 
fœ¡
, cÚ¡ ušt8_t* 
Ï¡
, cÚ¡ 
SŒšg
& 
¡r
, 
boŞ
 
com¶‘e
, 
JsÚ
& 
j
);

2855 
šlše
 
	gJsÚ
::
¡»amšg_·r£r
::
	$¡»amšg_·r£r
()

2856 : 
	$¡©e_
(
¡_š™Ÿl
) {

2857 
	}
}

2859 
šlše
 
JsÚ
::
¡»amšg_·r£r
::
	$»£t
() {

2860 
¡©e_
 = 
¡_š™Ÿl
;

2861 
¡ack_
.
	`ş—r
();

2862 
	}
}

2864 
šlše
 
boŞ
 
	gJsÚ
::
¡»amšg_·r£r
::
	$dÚe
() const {

2865  
¡©e_
 < 0;

2866 
	}
}

2868 
šlše
 
boŞ
 
	gJsÚ
::
¡»amšg_·r£r
::
	$sucûss
() const {

2869  
¡©e_
 =ğ
¡_fš®
;

2870 
	}
}

2872 
šlše
 
boŞ
 
	gJsÚ
::
¡»amšg_·r£r
::
	$”rÜ
() const {

2873  
¡©e_
 =ğ
¡_”rÜ
;

2874 
	}
}

2876 
šlše
 
size_t
 
	gJsÚ
::
¡»amšg_·r£r
::
	$cÚsume
(cÚ¡ * 
fœ¡
, 
size_t
 
Ëngth
,

2877 cÚ¡ 
SŒšg
& 
¡r
,

2878 
boŞ
 
com¶‘e
) {

2879 cÚ¡ 
ušt8_t
* 
ufœ¡
 = 
»š‹½»t_ÿ¡
<cÚ¡ ušt8_t*>(
fœ¡
);

2880  
	`cÚsume
(
ufœ¡
, ufœ¡ + 
Ëngth
, 
¡r
, 
com¶‘e
) - ufirst;

2881 
	}
}

2883 
šlše
 cÚ¡ * 
	gJsÚ
::
¡»amšg_·r£r
::
	$cÚsume
(cÚ¡ * 
fœ¡
,

2884 cÚ¡ * 
Ï¡
,

2885 cÚ¡ 
SŒšg
& 
¡r
,

2886 
boŞ
 
com¶‘e
) {

2887  
»š‹½»t_ÿ¡
<const *>

2888 (
	`cÚsume
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>(
fœ¡
),

2889 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>(
Ï¡
), 
¡r
, 
com¶‘e
));

2890 
	}
}

2892 
šlše
 
	gJsÚ
& JsÚ::
¡»amšg_·r£r
::
	$»suÉ
() {

2893  
jsÚ_
;

2894 
	}
}

2896 
šlše
 cÚ¡ 
	gJsÚ
& JsÚ::
¡»amšg_·r£r
::
	$»suÉ
() const {

2897  
jsÚ_
;

2898 
	}
}

2905 
šlše
 
boŞ
 
	gJsÚ
::
	$assign_·r£
(cÚ¡ 
SŒšg
 &
¡r
) {

2906  
	`assign_·r£
(
¡r
.
	`begš
(), sŒ.
	`’d
(), str);

2907 
	}
}

2913 
šlše
 
boŞ
 
	gJsÚ
::
	$assign_·r£
(cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
) {

2914  
	`assign_·r£
(
fœ¡
, 
Ï¡
, 
	`SŒšg
());

2915 
	}
}

2920 
šlše
 
JsÚ
 
	gJsÚ
::
	$·r£
(cÚ¡ 
SŒšg
 &
¡r
) {

2921 
JsÚ
 
j
;

2922 (è
j
.
	`assign_·r£
(
¡r
);

2923  
j
;

2924 
	}
}

2929 
šlše
 
JsÚ
 
	gJsÚ
::
	$·r£
(cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
) {

2930 
JsÚ
 
j
;

2931 (è
j
.
	`assign_·r£
(
fœ¡
, 
Ï¡
);

2932  
j
;

2933 
	}
}

2938 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
=(cÚ¡ 
JsÚ
& 
x
) {

2939 ià(
x
.
u_
.x.
ty³
 < 0)

2940 
x
.
u_
.
¡r
.
»f
();

2941 ià(
	gx
.
	gu_
.x.x && (x.u_.x.
	gty³
 =ğ
j_¬¿y
 || 
x
.
u_
.x.
ty³
 =ğ
j_objeù
))

2942 
x
.
u_
.x.x->
»f
();

2943 
d”ef
();

2944 
	gu_
 = 
x
.
u_
;

2945  *
	gthis
;

2948 #ià
HAVE_CXX_RVALUE_REFERENCES


2949 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
=(
JsÚ
&& 
x
) {

2950 
usšg
 
¡d
::
sw­
;

2951 
sw­
(
u_
, 
x
.u_);

2952  *
	gthis
;

2957 
	g‹m¶©e
 <
ty³Çme
 
	gU
>

2958 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
=(cÚ¡ 
JsÚ_´oxy_ba£
<
U
> &
x
) {

2959  *
this
 = 
x
.
cv®ue
();

2962 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
=(
x
) {

2963 
d”ef
();

2964 
	gu_
.
	gi
.
	gx
 = 
x
;

2965 
	gu_
.
	gi
.
	gty³
 = 
j_št
;

2966  *
	gthis
;

2969 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
=(
x
) {

2970 
d”ef
();

2971 
	gu_
.
	gu
.
	gx
 = 
x
;

2972 
	gu_
.
	gu
.
	gty³
 = 
j_unsigÃd
;

2973  *
	gthis
;

2976 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
=(
x
) {

2977 
d”ef
();

2978 
	gu_
.
	gi
.
	gx
 = 
x
;

2979 
	gu_
.
	gi
.
	gty³
 = 
j_št
;

2980  *
	gthis
;

2983 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
=(
x
) {

2984 
d”ef
();

2985 
	gu_
.
	gu
.
	gx
 = 
x
;

2986 
	gu_
.
	gu
.
	gty³
 = 
j_unsigÃd
;

2987  *
	gthis
;

2990 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
=(
x
) {

2991 
d”ef
();

2992 
	gu_
.
	gi
.
	gx
 = 
x
;

2993 
	gu_
.
	gi
.
	gty³
 = 
j_št
;

2994  *
	gthis
;

2997 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
=(
x
) {

2998 
d”ef
();

2999 
	gu_
.
	gu
.
	gx
 = 
x
;

3000 
	gu_
.
	gu
.
	gty³
 = 
j_unsigÃd
;

3001  *
	gthis
;

3004 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
=(
x
) {

3005 
d”ef
();

3006 
	gu_
.
	gd
.
	gx
 = 
x
;

3007 
	gu_
.
	gd
.
	gty³
 = 
j_doubË
;

3008  *
	gthis
;

3011 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
=(
boŞ
 
x
) {

3012 
d”ef
();

3013 
	gu_
.
	gi
.
	gx
 = 
x
;

3014 
	gu_
.
	gi
.
	gty³
 = 
j_boŞ
;

3015  *
	gthis
;

3018 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
=(cÚ¡ 
SŒšg
& 
x
) {

3019 
d”ef
();

3020 
	gu_
.
	g¡r
 = 
x
.
š‹º®_»p
();

3021 
	gu_
.
	g¡r
.
»f
();

3022  *
	gthis
;

3026 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
++() {

3027  *
this
 += 1;

3029 
šlše
 
	gJsÚ
::
İ”©Ü
++() {

3030 ++(*
this
);

3032 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
--() {

3033  *
this
 += -1;

3035 
šlše
 
	gJsÚ
::
İ”©Ü
--() {

3036 --(*
this
);

3038 
šlše
 
	gJsÚ
& JsÚ::
	$add
(
x
) {

3039 
	`fÜû_doubË
();

3040 
u_
.
d
.
x
 += x;

3041  *
this
;

3042 
	}
}

3043 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

3044 
šlše
 
	gJsÚ
& JsÚ::
	$add
(
T
 
x
) {

3045 
	`fÜû_numb”
();

3046 ià(
	`is_št
())

3047 
u_
.
u
.
x
 += x;

3049 
u_
.
d
.
x
 += x;

3050  *
this
;

3051 
	}
}

3052 
šlše
 
	gJsÚ
& JsÚ::
	$subŒaù
(
x
) {

3053 
	`fÜû_doubË
();

3054 
u_
.
d
.
x
 -= x;

3055  *
this
;

3056 
	}
}

3057 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

3058 
šlše
 
	gJsÚ
& JsÚ::
	$subŒaù
(
T
 
x
) {

3059 
	`fÜû_numb”
();

3060 ià(
	`is_št
())

3061 
u_
.
u
.
x
 -= x;

3063 
u_
.
d
.
x
 -= x;

3064  *
this
;

3065 
	}
}

3066 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
+=(
x
) {

3067  
add
(
x
);

3069 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
+=(
x
) {

3070  
add
(
x
);

3072 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
+=(
x
) {

3073  
add
(
x
);

3075 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
+=(
x
) {

3076  
add
(
x
);

3078 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
+=(
x
) {

3079  
add
(
x
);

3081 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
+=(
x
) {

3082  
add
(
x
);

3084 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
+=(
x
) {

3085  
add
(
x
);

3087 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
-=(
x
) {

3088  
subŒaù
(
x
);

3090 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
-=(
x
) {

3091  
subŒaù
(
x
);

3093 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
-=(
x
) {

3094  
subŒaù
(
x
);

3096 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
-=(
x
) {

3097  
subŒaù
(
x
);

3099 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
-=(
x
) {

3100  
subŒaù
(
x
);

3102 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
-=(
x
) {

3103  
subŒaù
(
x
);

3105 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
-=(
x
) {

3106  
subŒaù
(
x
);

3108 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
+=(cÚ¡ 
JsÚ
& 
x
) {

3109 ià(
x
.
is_unsigÃd
())

3110 
add
(
u_
.
u
.
x
);

3111 ià(
	gx
.
is_št
())

3112 
add
(
u_
.
i
.
x
);

3113 ià(!
	gx
.
is_nuÎ
())

3114 
add
(
x
.
as_d
());

3115  *
	gthis
;

3117 
šlše
 
	gJsÚ
& JsÚ::
İ”©Ü
-=(cÚ¡ 
JsÚ
& 
x
) {

3118 ià(
x
.
is_unsigÃd
())

3119 
subŒaù
(
u_
.
u
.
x
);

3120 ià(
	gx
.
is_št
())

3121 
subŒaù
(
u_
.
i
.
x
);

3122 ià(!
	gx
.
is_nuÎ
())

3123 
subŒaù
(
x
.
as_d
());

3124  *
	gthis
;

3126 
šlše
 
JsÚ
 
	gİ”©Ü
+(JsÚ 
	gx
) {

3127 
	gx
.
fÜû_numb”
();

3128  
	gx
;

3130 
šlše
 
JsÚ
 
	gİ”©Ü
-(JsÚ 
	gx
) {

3131 
	gx
.
fÜû_numb”
();

3132 ià(
	gx
.
is_št
())

3133 
	gx
.
	gu_
.
	gu
.x = -
x
.
u_
.
u
.x;

3135 
	gx
.
	gu_
.
	gd
.x = -
x
.
u_
.
d
.x;

3136  
	gx
;

3140 
šlše
 
	gJsÚ
::
	$sw­
(
JsÚ
& 
x
) {

3141 
usšg
 
¡d
::
sw­
;

3142 
	`sw­
(
u_
, 
x
.u_);

3143 
	}
}

3146 
šlše
 
	gSŒšgAccum
 &
	gİ”©Ü
<<(SŒšgAccum &
	g§
, cÚ¡ 
	gJsÚ
& 
	gjsÚ
) {

3147 
	gjsÚ
.
uÅ¬£
(
§
);

3148  
	g§
;

3151 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

3152 
šlše
 
	gSŒšgAccum
 &
	gİ”©Ü
<<(SŒšgAccum &
	g§
, cÚ¡ 
	gJsÚ_´oxy_ba£
<
	gP
> &
	gjsÚ
) {

3153  (
	g§
 << 
	gjsÚ
.
cv®ue
());

3156 
šlše
 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(
¡d
::o¡»am& 
f
, cÚ¡ 
	gJsÚ
& 
	gjsÚ
) {

3157 
SŒšgAccum
 
	g§
;

3158 
	gjsÚ
.
uÅ¬£
(
§
);

3159  
	gf
.
wr™e
(
§
.
d©a
(), sa.
Ëngth
());

3162 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

3163 
šlše
 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(
¡d
::o¡»am& 
f
, cÚ¡ 
	gJsÚ_´oxy_ba£
<
	gP
>& 
	gjsÚ
) {

3164  (
	gf
 << 
	gjsÚ
.
cv®ue
());

3167 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
JsÚ
& 
a
, cÚ¡ 
	gJsÚ
& 
	gb
);

3169 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

3170 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
JsÚ_´oxy_ba£
<
T
>& 
a
, cÚ¡ 
	gJsÚ
& 
	gb
) {

3171  
	ga
.
cv®ue
(è=ğ
b
;

3174 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

3175 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
JsÚ
& 
a
, cÚ¡ 
	gJsÚ_´oxy_ba£
<
	gT
>& 
	gb
) {

3176  
	ga
 =ğ
b
.
cv®ue
();

3179 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

3180 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
JsÚ_´oxy_ba£
<
T
>& 
a
,

3181 cÚ¡ 
	gJsÚ_´oxy_ba£
<
	gU
>& 
	gb
) {

3182  
	ga
.
cv®ue
(è=ğ
b
.cvalue();

3185 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
JsÚ
& 
a
, cÚ¡ 
	gJsÚ
& 
	gb
) {

3186  !(
	ga
 =ğ
b
);

3189 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

3190 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
JsÚ_´oxy_ba£
<
T
>& 
a
, cÚ¡ 
	gJsÚ
& 
	gb
) {

3191  !(
	ga
 =ğ
b
);

3194 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

3195 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
JsÚ
& 
a
, cÚ¡ 
	gJsÚ_´oxy_ba£
<
	gT
>& 
	gb
) {

3196  !(
	ga
 =ğ
b
);

3199 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

3200 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
JsÚ_´oxy_ba£
<
T
>& 
a
,

3201 cÚ¡ 
	gJsÚ_´oxy_ba£
<
	gU
>& 
	gb
) {

3202  !(
	ga
 =ğ
b
);

3205 
šlše
 
	$sw­
(
JsÚ
& 
a
, JsÚ& 
b
) {

3206 
a
.
	`sw­
(
b
);

3207 
	}
}

	@masstree-beta/jsontest.cc

19 
	~"jsÚ.hh
"

20 
	~<unÜd”ed_m­
>

21 
usšg
 
Çme¥aû
 
	glcdf
;

23 
	#CHECK
(
x
èdØ{ ià(!(x)è{ 
¡d
::
û¼
 << 
__FILE__
 << ":" << 
__LINE__
 << ":e¡ '" << #x << "' faed\n"; 
	`ex™
(1); } } 0)

	)

24 
	#CHECK_JUP
(
x
, 
¡r
èdØ{ ià((x).
	`uÅ¬£
(è!ğ(¡r)è{ 
¡d
::
û¼
 << 
__FILE__
 << ":" << 
__LINE__
 << ": '" #x "' i '" << (xè<< "',‚Ù '" << (¡rè<< "'\n"; 
	`ex™
(1); } } 0)

	)

28 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	$šü
(
T
& 
x
è
	`__©Œibu‹__
((
nošlše
));

29 
‹m¶©e
 <
ty³Çme
 
T
>

30 
	$šü
(
T
& 
x
) {

31 ++
x
;

32 
	}
}

35 
	$b’chm¬k_·r£
() {

36 
¡d
::
veùÜ
<
SŒšg
> 
·r£_exam¶es
;

37 
·r£_exam¶es
.
	`push_back
("{}");

38 
·r£_exam¶es
.
	`push_back
("{\"foo\":\"bar\",\"baz\":\"flim\"}");

39 
·r£_exam¶es
.
	`push_back
("[1,2,3,4,5]");

40 
·r£_exam¶es
.
	`push_back
("[]");

41 
·r£_exam¶es
.
	`push_back
("[{},{\"b\":[]}]");

42 
JsÚ
 
j
;

44 
i
 = 0; i < 10000000; ++i)

45 
j
.
	`assign_·r£
(
·r£_exam¶es
[
	`¿nd
(è%…¬£_exam¶es.
	`size
()]);

47 
usšg
 
¡d
::
sw­
;

48 
JsÚ
::
¡»amšg_·r£r
 
j¥
;

49 
i
 = 0; i < 10000000; ++i) {

50 
j¥
.
	`»£t
();

51 
	`sw­
(
j¥
.
	`»suÉ
(), 
j
);

52 cÚ¡ 
SŒšg
& 
¡r
 = 
·r£_exam¶es
[
	`¿nd
(è%…¬£_exam¶es.
	`size
()];

53 
j¥
.
	`cÚsume
(
¡r
.
	`begš
(), sŒ.
	`’d
(), sŒ, 
Œue
);

56 
	`ex™
(0);

57 
	}
}

59 
	$maš
(
¬gc
, ** 
¬gv
) {

60 (è
¬gc
, (è
¬gv
;

63 
JsÚ
 
j
;

64 
	`CHECK
(
j
.
	`em±y
());

65 
	`CHECK
(!
j
);

67 
j
 = 
JsÚ
::
	`make_objeù
();

68 
	`CHECK
(
j
.
	`em±y
());

69 
	`CHECK
(
j
);

71 
j
.
	`£t
("foo", "bar");

72 
	`CHECK
(
j
["foo"]);

73 
	`CHECK
(
j
["foo"].
	`to_s
() == "bar");

74 
	`CHECK
(
j
.
	`size
() == 1);

76 
j
.
	`£t
("baz", "flim");

77 
	`CHECK
(
j
.
	`size
() == 2);

78 
	`CHECK
(
j
.
	`uÅ¬£
() == "{\"foo\":\"bar\",\"baz\":\"flim\"}");

80 
j
.
	`”a£
("foo");

81 
	`CHECK
(
j
.
	`size
() == 1);

83 
j
.
	`assign_·r£
("2");

84 
	`CHECK
(
j
 == 2);

86 
j
.
	`assign_·r£
("null");

87 
	`CHECK
(
j
 =ğ
	`JsÚ
());

89 
j
.
	`assign_·r£
("\"a\"");

90 
	`CHECK
(
j
 == "a");

92 
j
.
	`assign_·r£
("[1,2]");

93 
	`CHECK
(
j
.
	`uÅ¬£
() == "[1,2]");

95 
j
.
	`assign_·r£
("[[[]],{\"a\":{}}]");

96 
	`CHECK
(
j
.
	`uÅ¬£
() == "[[[]],{\"a\":{}}]");

98 
j
 = 
JsÚ
::
	`·r£
("{\"x22\":{\n\
\"git-revision\":\"ebbd3d4767847300f552b181a10bda57a926f554M\",\n\
\"time\":\"Tue Feb 7 20:20:33 2012\",\n\
\"machine\":\"rtshanks-laptop\",\n\
\"cores\":2,\n\
\"runs\":[\"x22\\/rw2\\/mb\\/0\"]\n\
},\n\
\"x23\":{\n\
\"git-revision\":\"ebbd3d4767847300f552b181a10bda57a926f554M\",\n\
\"time\":\"Tue Feb 7 20:31:05 2012\",\n\
\"machine\":\"rtshanks-laptop\",\n\
\"cores\":2,\n\
\"runs\":[\"x23\\/rw2\\/mb\\/0\",\"x23\\/rw1\\/mb\\/0\",\"x23\\/rw3\\/mb\\/0\"]\n\
},\n\
\"x24\":{\n\
\"git-revision\":\"62e9970ca8ae9c6eebf2d71b7065ea694fb25282M\",\n\
\"time\":\"Sat Feb 11 15:54:01 2012\",\n\
\"machine\":\"rtshanks-laptop\",\n\
\"cores\":2,\n\
\"runs\":[\"x24\\/rw1\\/b\\/0\"]\n\
},\"b\":\"c\",\"c\":\"d\"}");

119 
	`CHECK
(
j
["x22"]["time"] == "Tue Feb 7 20:20:33 2012");

120 
	`CHECK
(
j
["x22"]["cores"] == 2);

122 
JsÚ
::
objeù_™”©Ü
 
™
 = 
j
.
	`obegš
();

123 
	`CHECK
(
™
.
	`key
() == "x22");

124 ++
™
;

125 
	`CHECK
(
™
.
	`key
() == "x23");

126 ++
™
;

127 
	`CHECK
(
™
.
	`key
() == "x24");

128 ++
™
;

129 
	`CHECK
(
™
.
	`key
() == "b");

130 ++
™
;

131 
	`CHECK
(
™
.
	`key
() == "c");

135 
JsÚ
 
jcİy
 = 
j
;

136 
	`CHECK
(
j
.
	`size
() == 5);

137 
couÁ
 = 0;

138 
JsÚ
::
™”©Ü
 
™
 = 
jcİy
.
	`begš
(); iˆ!ğjcİy.
	`’d
(); ++it) {

139 
™
->
£cÚd
 = 
	`JsÚ
();

140 ++
couÁ
;

142 
	`CHECK
(!
jcİy
["x22"]);

143 
	`CHECK
(
j
["x22"]["cores"] == 2);

144 
	`CHECK
(
couÁ
 =ğ
jcİy
.
	`size
());

147 
	`CHECK
(!
j
["x49"]);

148 
	`CHECK
(
j
.
	`size
() == 5);

149 
	`CHECK
(!
j
["x49"]["45"][2]["a"]);

150 
	`CHECK
(
j
.
	`size
() == 5);

151 
j
["x49"]["45"][2]["a"] = 1;

152 
	`CHECK
(
j
.
	`size
() == 6);

153 
	`CHECK
(
j
["x22"].
	`is_objeù
(è&& j.
	`g‘
("x22").is_object());

154 
	`CHECK
(
j
["x23"].
	`is_objeù
(è&& j.
	`g‘
("x23").is_object());

155 
	`CHECK
(
j
["b"].
	`is_¡ršg
(è&& j.
	`g‘
("b").is_string());

156 
	`CHECK
(
j
["x49"].
	`is_objeù
(è&& j.
	`g‘
("x49").is_object());

157 
	`CHECK
(
j
["x49"]["45"].
	`is_¬¿y
());

158 
	`CHECK
(
j
["x49"]["45"].
	`size
(è=ğ3 && j["x49"]["45"][2].
	`is_objeù
());

160 
j
 = 
JsÚ
::
	`make_objeù
();

161 
j
["a"] = j["b"];

162 
	`CHECK
(
j
.
	`size
() == 1);

163 
	`CHECK
(
j
["a"].
	`is_nuÎ
());

164 
	`CHECK
(
j
.
	`couÁ
("a") == 1);

166 
JsÚ
 
k
 = JsÚ::
	`make_¬¿y
();

168 
	`CHECK
(
k
.
	`size
() == 0);

169 
JsÚ
::
¬¿y_™”©Ü
 
™
 = 
k
.
	`abegš
();

170 
	`CHECK
(!
™
.
	`live
());

172 
j
 = 
JsÚ
::
	`make_objeù
();

173 
j
["a"] = 
k
[2];

174 
	`CHECK
(
j
.
	`size
() == 1);

175 
	`CHECK
(
k
.
	`size
() == 0);

176 
	`CHECK
(
j
["a"].
	`is_nuÎ
());

177 
	`CHECK
(
j
.
	`couÁ
("a") == 1);

179 
j
 = 
	`JsÚ
(1);

180 
	`CHECK
(
j
.
	`g‘
("a").
	`is_nuÎ
());

182 
j
.
	`assign_·r£
("{\"a\":1,\"b\":true,\"c\":\"\"}");

184 
i
 = 0;

185 
boŞ
 
b
 = 
çl£
;

186 
SŒšg
 
s
;

187 
	`CHECK
(
j
.
	`g‘
("a", 
i
));

188 
	`CHECK
(
i
 == 1);

189 
	`CHECK
(
j
.
	`g‘
("a", 
i
).g‘("b", 
b
));

190 
	`CHECK
(
b
 =ğ
Œue
);

191 
	`CHECK
(!
j
.
	`g‘
("a", 
s
).
	`¡©us
());

192 
	`CHECK
(!
j
.
	`g‘
("a", 
s
).
	`¡©us
(
b
));

193 
	`CHECK
(
b
 =ğ
çl£
);

194 
	`CHECK
(
j
.
	`g‘
("a", 
k
));

195 
	`CHECK
(
k
 =ğ
	`JsÚ
(1));

196 
	`CHECK
(!
j
.
	`g‘
("cc", 
k
));

199 
j
["a"] = 
	`JsÚ
(5);

200 
j
.
	`£t
("a", 
	`JsÚ
(5));

201 
j
["b"] = 
JsÚ
::
	`·r£
("[]");

204 
JsÚ
 
j1
 = JsÚ::
	`make_objeù
(), 
j2
 = Json::make_object();

205 
j1
.
	`£t
("a", 
j2
);

206 
j2
.
	`£t
("b", 1);

207 
	`CHECK
(
j1
.
	`uÅ¬£
() == "{\"a\":{}}");

208 
	`CHECK
(
j2
.
	`uÅ¬£
() == "{\"b\":1}");

212 
JsÚ
 
j
 = JsÚ::
	`·r£
("{\"a\":true}");

213 ià(
j
["foo"]["bar"])

214 
	`CHECK
(
çl£
);

215 
	`CHECK
(
j
.
	`uÅ¬£
() == "{\"a\":true}");

216 
j
["foo"]["b¬"] = 
Œue
;

217 
	`CHECK
(
j
.
	`uÅ¬£
() == "{\"a\":true,\"foo\":{\"bar\":true}}");

218 
j
["a"]["2"] = 
çl£
;

219 
	`CHECK
(
j
.
	`uÅ¬£
() == "{\"a\":{\"2\":false},\"foo\":{\"bar\":true}}");

220 
j
[3] = 
Œue
;

221 
	`CHECK
(
j
.
	`uÅ¬£
() == "{\"a\":{\"2\":false},\"foo\":{\"bar\":true},\"3\":true}");

222 
	`CHECK
(
j
[3] =ğ
	`JsÚ
(
Œue
));

223 
j
 = 
JsÚ
::
	`·r£
("[1,2,3,4]");

224 
	`CHECK
(
j
["2"] =ğ
	`JsÚ
(3));

225 
	`CHECK
(
j
.
	`uÅ¬£
() == "[1,2,3,4]");

226 
j
["a"] = 
Œue
;

227 
	`CHECK
(
j
.
	`uÅ¬£
() == "{\"0\":1,\"1\":2,\"2\":3,\"3\":4,\"a\":true}");

228 
	`CHECK
(
j
["2"] =ğ
	`JsÚ
(3));

232 
JsÚ
 
j
 = JsÚ::
	`·r£
("{}");

233 
j
.
	`£t
("foo", 
SŒšg
::
	`make_out_of_memÜy
()).set(String::make_out_of_memory(), 2);

234 
	`CHECK
(
j
.
	`uÅ¬£
() == "{\"foo\":\"\360\237\222\243ENOMEM\360\237\222\243\",\"\360\237\222\243ENOMEM\360\237\222\243\":2}");

235 
j
.
	`ş—r
();

236 
	`CHECK
(
j
.
	`uÅ¬£
() == "{}");

237 
	`CHECK
(
j
.
	`g‘
("foo"è=ğ
	`JsÚ
());

241 
JsÚ
 
j
 = JsÚ::
	`¬¿y
(1, 2, 3, 4, 5, 6, 7, 8);

242 
	`CHECK
(
j
.
	`uÅ¬£
() == "[1,2,3,4,5,6,7,8]");

243 
JsÚ
 
jcİy
 = 
j
;

244 
	`CHECK
(
j
.
	`uÅ¬£
() == "[1,2,3,4,5,6,7,8]");

245 
	`CHECK
(
jcİy
.
	`uÅ¬£
() == "[1,2,3,4,5,6,7,8]");

246 
j
.
	`push_back
(9);

247 
	`CHECK
(
j
.
	`uÅ¬£
() == "[1,2,3,4,5,6,7,8,9]");

248 
	`CHECK
(
jcİy
.
	`uÅ¬£
() == "[1,2,3,4,5,6,7,8]");

249 
jcİy
.
	`push_back
(10);

250 
	`CHECK
(
j
.
	`uÅ¬£
() == "[1,2,3,4,5,6,7,8,9]");

251 
	`CHECK
(
jcİy
.
	`uÅ¬£
() == "[1,2,3,4,5,6,7,8,10]");

255 
s
 = 77;

256 
JsÚ
 
j
 = JsÚ::
	`¬¿y
(0, 0, 0);

257 
JsÚ
 
k
 = JsÚ::
	`¬¿y
(0, 
s
, "foo");

258 
	`CHECK
(
j
[1].
	`is_i
());

259 
	`CHECK
(
k
[1].
	`is_u
());

260 
j
[1] = 
k
[1];

261 
	`CHECK
(
j
[1].
	`is_u
());

266 
JsÚ
 
j
 = JsÚ::
	`¬¿y
(1, 2, 3);

268 
i
 = 0; i < 1000000; ++i)

269 
	`šü
(
j
[1].
	`v®ue
());

270 
¡d
::
cout
 << 
j
 << "\n";

275 
JsÚ
::
¡»amšg_·r£r
 
j¥
;

276 cÚ¡ 
ušt8_t
* 
x
 = 
»š‹½»t_ÿ¡
<const uint8_t*>("\"abcdef\"");

278 cÚ¡ 
ušt8_t
* 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 8, 
	`SŒšg
());

279 
	`CHECK
(
r
 =ğ
x
 + 8);

280 
	`CHECK
(
j¥
.
	`sucûss
());

281 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "\"abcdef\"");

283 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("\"\\\"\\\\fartbox\"‡mksdnsndfa");

284 
j¥
.
	`»£t
();

285 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 9, 
	`SŒšg
());

286 
	`CHECK
(
r
 =ğ
x
 + 9);

287 
	`CHECK
(!
j¥
.
	`dÚe
());

288 
r
 = 
j¥
.
	`cÚsume
(
x
 + 9, x + 17, 
	`SŒšg
());

289 
	`CHECK
(
r
 =ğ
x
 + 13);

290 
	`CHECK
(
j¥
.
	`sucûss
());

291 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "\"\\\"\\\\fartbox\"");

293 
j¥
.
	`»£t
();

294 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 3, 
	`SŒšg
());

295 
	`CHECK
(
r
 =ğ
x
 + 3);

296 
r
 = 
j¥
.
	`cÚsume
(
x
 + 3, x + 6, 
	`SŒšg
());

297 
	`CHECK
(
r
 =ğ
x
 + 6);

298 
r
 = 
j¥
.
	`cÚsume
(
x
 + 6, x + 9, 
	`SŒšg
());

299 
	`CHECK
(
r
 =ğ
x
 + 9);

300 
r
 = 
j¥
.
	`cÚsume
(
x
 + 9, x + 13, 
	`SŒšg
());

301 
	`CHECK
(
r
 =ğ
x
 + 13);

302 
	`CHECK
(
j¥
.
	`sucûss
());

303 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "\"\\\"\\\\fartbox\"");

305 
j¥
.
	`»£t
();

306 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("\"\\uD834\\uDD1E\"f");

307 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 15, 
	`SŒšg
());

308 
	`CHECK
(
r
 =ğ
x
 + 14);

309 
	`CHECK
(
j¥
.
	`sucûss
());

310 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "\"\xF0\x9D\x84\x9E\"");

312 
j¥
.
	`»£t
();

313 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 2, 
	`SŒšg
());

314 
	`CHECK
(
r
 =ğ
x
 + 2);

315 
r
 = 
j¥
.
	`cÚsume
(
x
 + 2, x + 4, 
	`SŒšg
());

316 
	`CHECK
(
r
 =ğ
x
 + 4);

317 
r
 = 
j¥
.
	`cÚsume
(
x
 + 4, x + 6, 
	`SŒšg
());

318 
	`CHECK
(
r
 =ğ
x
 + 6);

319 
r
 = 
j¥
.
	`cÚsume
(
x
 + 6, x + 8, 
	`SŒšg
());

320 
	`CHECK
(
r
 =ğ
x
 + 8);

321 
r
 = 
j¥
.
	`cÚsume
(
x
 + 8, x + 10, 
	`SŒšg
());

322 
	`CHECK
(
r
 =ğ
x
 + 10);

323 
r
 = 
j¥
.
	`cÚsume
(
x
 + 10, x + 15, 
	`SŒšg
());

324 
	`CHECK
(
r
 =ğ
x
 + 14);

325 
	`CHECK
(
j¥
.
	`sucûss
());

326 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "\"\xF0\x9D\x84\x9E\"");

328 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("\"\xF0\x9D\x84\x9E\" fart");

329 
j¥
.
	`»£t
();

330 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 3, 
	`SŒšg
());

331 
	`CHECK
(
r
 =ğ
x
 + 3);

332 
r
 = 
j¥
.
	`cÚsume
(
x
 + 5, x + 7, 
	`SŒšg
());

333 
	`CHECK
(
r
 =ğ
x
 + 5);

334 
	`CHECK
(
j¥
.
	`”rÜ
());

336 
j¥
.
	`»£t
();

337 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 7, 
	`SŒšg
());

338 
	`CHECK
(
r
 =ğ
x
 + 6);

339 
	`CHECK
(
j¥
.
	`sucûss
());

340 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "\"\xF0\x9D\x84\x9E\"");

342 
j¥
.
	`»£t
();

343 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 2, 
	`SŒšg
());

344 
	`CHECK
(
r
 =ğ
x
 + 2);

345 
r
 = 
j¥
.
	`cÚsume
(
x
 + 2, x + 4, 
	`SŒšg
());

346 
	`CHECK
(
r
 =ğ
x
 + 4);

347 
r
 = 
j¥
.
	`cÚsume
(
x
 + 4, x + 7, 
	`SŒšg
());

348 
	`CHECK
(
r
 =ğ
x
 + 6);

349 
	`CHECK
(
j¥
.
	`sucûss
());

350 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "\"\xF0\x9D\x84\x9E\"");

352 
j¥
.
	`»£t
();

353 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("{}");

354 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 2, 
	`SŒšg
());

355 
	`CHECK
(
r
 =ğ
x
 + 2);

356 
	`CHECK
(
j¥
.
	`sucûss
());

357 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "{}");

359 
j¥
.
	`»£t
();

360 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("\"ab cde\" ");

361 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 9, 
	`SŒšg
());

362 
	`CHECK
(
r
 =ğ
x
 + 8);

363 
	`CHECK
(
j¥
.
	`sucûss
());

364 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "\"ab cde\"");

366 
j¥
.
	`»£t
();

367 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("{\"a\":\"b\"}");

368 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 9, 
	`SŒšg
());

369 
	`CHECK
(
r
 =ğ
x
 + 9);

370 
	`CHECK
(
j¥
.
	`sucûss
());

371 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "{\"a\":\"b\"}");

373 
j¥
.
	`»£t
();

374 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("[]");

375 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 2, 
	`SŒšg
());

376 
	`CHECK
(
r
 =ğ
x
 + 2);

377 
	`CHECK
(
j¥
.
	`sucûss
());

378 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "[]");

380 
j¥
.
	`»£t
();

381 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("[\"a\",\"b\"]");

382 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 9, 
	`SŒšg
());

383 
	`CHECK
(
r
 =ğ
x
 + 9);

384 
	`CHECK
(
j¥
.
	`sucûss
());

385 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "[\"a\",\"b\"]");

387 
j¥
.
	`»£t
();

388 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("[[\"a\"],[[\"b\"]]]");

389 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 15, 
	`SŒšg
());

390 
	`CHECK
(
r
 =ğ
x
 + 15);

391 
	`CHECK
(
j¥
.
	`sucûss
());

392 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "[[\"a\"],[[\"b\"]]]");

394 
j¥
.
	`»£t
();

395 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("[[],[[]]]");

396 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 9, 
	`SŒšg
());

397 
	`CHECK
(
r
 =ğ
x
 + 9);

398 
	`CHECK
(
j¥
.
	`sucûss
());

399 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "[[],[[]]]");

401 
j¥
.
	`»£t
();

402 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("{\"abc\":\"def\"}");

403 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 3, 
	`SŒšg
());

404 
	`CHECK
(
r
 =ğ
x
 + 3);

405 
r
 = 
j¥
.
	`cÚsume
(
x
 + 3, x + 6, 
	`SŒšg
());

406 
	`CHECK
(
r
 =ğ
x
 + 6);

407 
r
 = 
j¥
.
	`cÚsume
(
x
 + 6, x + 9, 
	`SŒšg
());

408 
	`CHECK
(
r
 =ğ
x
 + 9);

409 
r
 = 
j¥
.
	`cÚsume
(
x
 + 9, x + 12, 
	`SŒšg
());

410 
	`CHECK
(
r
 =ğ
x
 + 12);

411 
r
 = 
j¥
.
	`cÚsume
(
x
 + 12, x + 13, 
	`SŒšg
());

412 
	`CHECK
(
r
 =ğ
x
 + 13);

413 
	`CHECK
(
j¥
.
	`sucûss
());

414 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "{\"abc\":\"def\"}");

416 
j¥
.
	`»£t
();

417 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("{\"abc\":true }");

418 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 3, 
	`SŒšg
());

419 
	`CHECK
(
r
 =ğ
x
 + 3);

420 
r
 = 
j¥
.
	`cÚsume
(
x
 + 3, x + 6, 
	`SŒšg
());

421 
	`CHECK
(
r
 =ğ
x
 + 6);

422 
r
 = 
j¥
.
	`cÚsume
(
x
 + 6, x + 9, 
	`SŒšg
());

423 
	`CHECK
(
r
 =ğ
x
 + 9);

424 
r
 = 
j¥
.
	`cÚsume
(
x
 + 9, x + 12, 
	`SŒšg
());

425 
	`CHECK
(
r
 =ğ
x
 + 12);

426 
r
 = 
j¥
.
	`cÚsume
(
x
 + 12, x + 13, 
	`SŒšg
());

427 
	`CHECK
(
r
 =ğ
x
 + 13);

428 
	`CHECK
(
j¥
.
	`sucûss
());

429 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "{\"abc\":true}");

431 
j¥
.
	`»£t
();

432 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("{\"abc\":‚ull}");

433 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 3, 
	`SŒšg
());

434 
	`CHECK
(
r
 =ğ
x
 + 3);

435 
r
 = 
j¥
.
	`cÚsume
(
x
 + 3, x + 6, 
	`SŒšg
());

436 
	`CHECK
(
r
 =ğ
x
 + 6);

437 
r
 = 
j¥
.
	`cÚsume
(
x
 + 6, x + 9, 
	`SŒšg
());

438 
	`CHECK
(
r
 =ğ
x
 + 9);

439 
r
 = 
j¥
.
	`cÚsume
(
x
 + 9, x + 12, 
	`SŒšg
());

440 
	`CHECK
(
r
 =ğ
x
 + 12);

441 
r
 = 
j¥
.
	`cÚsume
(
x
 + 12, x + 13, 
	`SŒšg
());

442 
	`CHECK
(
r
 =ğ
x
 + 13);

443 
	`CHECK
(
j¥
.
	`sucûss
());

444 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "{\"abc\":null}");

446 
j¥
.
	`»£t
();

447 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("{\"abc\":false}");

448 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 3, 
	`SŒšg
());

449 
	`CHECK
(
r
 =ğ
x
 + 3);

450 
r
 = 
j¥
.
	`cÚsume
(
x
 + 3, x + 6, 
	`SŒšg
());

451 
	`CHECK
(
r
 =ğ
x
 + 6);

452 
r
 = 
j¥
.
	`cÚsume
(
x
 + 6, x + 9, 
	`SŒšg
());

453 
	`CHECK
(
r
 =ğ
x
 + 9);

454 
r
 = 
j¥
.
	`cÚsume
(
x
 + 9, x + 12, 
	`SŒšg
());

455 
	`CHECK
(
r
 =ğ
x
 + 12);

456 
r
 = 
j¥
.
	`cÚsume
(
x
 + 12, x + 13, 
	`SŒšg
());

457 
	`CHECK
(
r
 =ğ
x
 + 13);

458 
	`CHECK
(
j¥
.
	`sucûss
());

459 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "{\"abc\":false}");

461 
j¥
.
	`»£t
();

462 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("{\"abc\": -13 }");

463 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 3, 
	`SŒšg
());

464 
	`CHECK
(
r
 =ğ
x
 + 3);

465 
r
 = 
j¥
.
	`cÚsume
(
x
 + 3, x + 6, 
	`SŒšg
());

466 
	`CHECK
(
r
 =ğ
x
 + 6);

467 
r
 = 
j¥
.
	`cÚsume
(
x
 + 6, x + 9, 
	`SŒšg
());

468 
	`CHECK
(
r
 =ğ
x
 + 9);

469 
r
 = 
j¥
.
	`cÚsume
(
x
 + 9, x + 12, 
	`SŒšg
());

470 
	`CHECK
(
r
 =ğ
x
 + 12);

471 
r
 = 
j¥
.
	`cÚsume
(
x
 + 12, x + 13, 
	`SŒšg
());

472 
	`CHECK
(
r
 =ğ
x
 + 13);

473 
	`CHECK
(
j¥
.
	`sucûss
());

474 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "{\"abc\":-13}");

476 
j¥
.
	`»£t
();

477 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("{\"abc\":0 }");

478 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 3, 
	`SŒšg
());

479 
	`CHECK
(
r
 =ğ
x
 + 3);

480 
r
 = 
j¥
.
	`cÚsume
(
x
 + 3, x + 6, 
	`SŒšg
());

481 
	`CHECK
(
r
 =ğ
x
 + 6);

482 
r
 = 
j¥
.
	`cÚsume
(
x
 + 6, x + 9, 
	`SŒšg
());

483 
	`CHECK
(
r
 =ğ
x
 + 9);

484 
r
 = 
j¥
.
	`cÚsume
(
x
 + 9, x + 12, 
	`SŒšg
());

485 
	`CHECK
(
r
 =ğ
x
 + 12);

486 
r
 = 
j¥
.
	`cÚsume
(
x
 + 12, x + 13, 
	`SŒšg
());

487 
	`CHECK
(
r
 =ğ
x
 + 13);

488 
	`CHECK
(
j¥
.
	`sucûss
());

489 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "{\"abc\":0}");

491 
j¥
.
	`»£t
();

492 
x
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>("[0,1,2,3,4e5,10.2]");

493 
r
 = 
j¥
.
	`cÚsume
(
x
, x + 3, 
	`SŒšg
());

494 
	`CHECK
(
r
 =ğ
x
 + 3);

495 
r
 = 
j¥
.
	`cÚsume
(
x
 + 3, x + 6, 
	`SŒšg
());

496 
	`CHECK
(
r
 =ğ
x
 + 6);

497 
r
 = 
j¥
.
	`cÚsume
(
x
 + 6, x + 9, 
	`SŒšg
());

498 
	`CHECK
(
r
 =ğ
x
 + 9);

499 
r
 = 
j¥
.
	`cÚsume
(
x
 + 9, x + 12, 
	`SŒšg
());

500 
	`CHECK
(
r
 =ğ
x
 + 12);

501 
r
 = 
j¥
.
	`cÚsume
(
x
 + 12, x + 18, 
	`SŒšg
());

502 
	`CHECK
(
r
 =ğ
x
 + 18);

503 
	`CHECK
(
j¥
.
	`sucûss
());

504 
	`CHECK
(
j¥
.
	`»suÉ
().
	`uÅ¬£
() == "[0,1,2,3,400000,10.2]");

508 
s
 = 77;

509 
JsÚ
 
j
 = JsÚ::
	`¬¿y
(0, 
s
, "foo");

510 
	`CHECK
(
j
.
	`is_a
());

511 
	`CHECK
(
j
[1].
	`is_u
());

512 
	`CHECK
(
j
[1] =ğ
s
);

513 
	`CHECK
(
j
[1] == 77);

515 
j
 = 
JsÚ
::
	`¬¿y
((
ušt64_t
è-1, (
št64_t
) -1,

516 (
ušt64_t
è1, (
št64_t
) 1,

517 (
ušt64_t
è2, (
št64_t
) 2);

518 
	`CHECK
(
j
[0] != j[1]);

519 
	`CHECK
(
j
[2] == j[3]);

520 
	`CHECK
(
j
[4] == j[5]);

521 
	`CHECK
(
j
[0] != j[2]);

522 
	`CHECK
(
j
[2] != j[4]);

523 
	`CHECK_JUP
(
j
, "[18446744073709551615,-1,1,1,2,2]");

527 
¡d
::
veùÜ
<> 
v
 = {1, 2, 3, 4, 5};

528 
JsÚ
 
	`j
(
v
.
	`begš
(), v.
	`’d
());

529 
	`CHECK
(
j
.
	`uÅ¬£
() == "[1,2,3,4,5]");

533 
¡d
::
unÜd”ed_m­
<
SŒšg
, SŒšg> 
h
;

534 
h
["a"] = "b";

535 
h
["c"] = "d";

536 
h
["x"] = "e";

537 
JsÚ
 
	`j
(
h
.
	`begš
(), h.
	`’d
());

538 
	`CHECK
(
j
.
	`is_o
());

539 
	`CHECK
(
j
.
	`size
() == 3);

540 
	`CHECK
(
j
["a"] == "b");

541 
	`CHECK
(
j
["c"] == "d");

542 
	`CHECK
(
j
["x"] == "e");

546 
JsÚ
 
j
 = JsÚ::
	`¬¿y
(1, 2, 3, 4, 5, 6, 7, 8);

547 
	`CHECK
(
j
.
	`uÅ¬£
() == "[1,2,3,4,5,6,7,8]");

548 
JsÚ
 
jcİy
 = 
j
;

549 
	`CHECK
(
j
.
	`uÅ¬£
() == "[1,2,3,4,5,6,7,8]");

550 
	`CHECK
(
jcİy
.
	`uÅ¬£
() == "[1,2,3,4,5,6,7,8]");

551 autØ
™
 = 
j
.
	`”a£
(j.
	`abegš
() + 4);

552 
	`CHECK_JUP
(
j
, "[1,2,3,4,6,7,8]");

553 
	`CHECK_JUP
(
jcİy
, "[1,2,3,4,5,6,7,8]");

554 
	`CHECK
(
™
 =ğ
j
.
	`abegš
() + 4);

555 
™
 = 
j
.
	`”a£
(j.
	`«nd
(), j.aend());

556 
	`CHECK_JUP
(
j
, "[1,2,3,4,6,7,8]");

557 
	`CHECK
(
™
 =ğ
j
.
	`«nd
());

558 
™
 = 
j
.
	`”a£
(j.
	`abegš
(), j.abegin());

559 
	`CHECK_JUP
(
j
, "[1,2,3,4,6,7,8]");

560 
	`CHECK
(
™
 =ğ
j
.
	`abegš
());

561 
™
 = 
j
.
	`”a£
(j.
	`abegš
(), j.abegin() + 3);

562 
	`CHECK_JUP
(
j
, "[4,6,7,8]");

563 
	`CHECK
(
™
 =ğ
j
.
	`abegš
());

567 
JsÚ
 
	`j
((
ušt64_t
) 1 << 63);

568 
	`CHECK
(
j
.
	`is_u
());

569 
	`CHECK
(
j
.
	`uÅ¬£
() == "9223372036854775808");

570 
j
 = 
JsÚ
::
	`·r£
("9223372036854775808");

571 
	`CHECK
(
j
.
	`is_u
());

572 
	`CHECK
(
j
.
	`to_u
(è=ğ(
ušt64_t
) 1 << 63);

576 
JsÚ
 
j
 = JsÚ::
	`objeù
("a", 1, "b", 
	`JsÚ
(2), "c", "9137471");

577 
	`CHECK
(
j
.
	`uÅ¬£
() == "{\"a\":1,\"b\":2,\"c\":\"9137471\"}");

581 
JsÚ
 
a
 = JsÚ::
	`·r£
("[{\"a\":1},{\"b\":2},{\"c\":3},{\"d\":4}]");

582 
JsÚ
 
b
 = JsÚ::
	`¬¿y
(
a
[1],‡[3],‡[2],‡[0]);

583 
	`CHECK
(&
a
[0]["a"].
	`cv®ue
(è=ğ&
b
[3]["a"].cvalue());

584 
b
.
	`push_back
(
a
[5]);

585 
	`CHECK
(
b
[4] =ğ
	`JsÚ
());

586 
	`CHECK
(
a
.
	`size
() == 4);

587 
b
 = 
JsÚ
::
	`objeù
("a5", 
a
[5], "a3",‡[3]);

588 
	`CHECK
(
b
.
	`uÅ¬£
() == "{\"a5\":null,\"a3\":{\"d\":4}}");

589 
	`CHECK
(
a
.
	`size
() == 4);

590 
b
.
	`£t_li¡
("a6", 
a
[6], "a2",‡[2]);

591 
	`CHECK
(
b
.
	`uÅ¬£
() == "{\"a5\":null,\"a3\":{\"d\":4},\"a6\":null,\"a2\":{\"c\":3}}");

592 
	`CHECK
(
a
.
	`size
() == 4);

596 
JsÚ
 
a
 = JsÚ::
	`·r£
("[{\"a\":\"\\\"\\\\\\/\"}]");

597 
	`CHECK
(
a
[0]["a"] == "\"\\/");

598 
	`CHECK
(
a
.
	`uÅ¬£
() == "[{\"a\":\"\\\"\\\\\\/\"}]");

601 
	`CHECK
(
	`SŒšg
("\\").
	`’code_jsÚ
() == "\\\\");

602 
	`CHECK
(
	`SŒšg
("\011\002\xE2\x80\xA9\xE2\x80\xAA").
	`’code_jsÚ
() == "\\t\\u0002\\u2029\xE2\x80\xAA");

603 
	`CHECK
(
	`SŒšg
("a").
	`’code_uri_compÚ’t
() == "a");

604 
	`CHECK
(
	`SŒšg
(" ").
	`’code_uri_compÚ’t
() == "%20");

605 
	`CHECK
(
	`SŒšg
("Ab -Ef").
	`’code_uri_compÚ’t
() == "Ab%20-Ef");

607 
¡d
::
cout
 << "Allests…ass!\n";

609 
	}
}

	@masstree-beta/kpermuter.hh

16 #iâdeà
KPERMUTER_HH


17 
	#KPERMUTER_HH


	)

18 
	~"¡ršg.hh
"

20 şas 
	cid’t™y_k³rmu‹r
 {

21 
	msize_
;

22 
	mpublic
:

23 
	$id’t™y_k³rmu‹r
(
size
)

24 : 
	$size_
(
size
) {

27 
	$size
() const {

28  
size_
;

29 
	}
}

30 
	gİ”©Ü
[](
	gi
) const {

31  
	gi
;

33 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
id’t™y_k³rmu‹r
&) const {

34  
Œue
;

36 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
id’t™y_k³rmu‹r
&) const {

37  
çl£
;

41 
	g‹m¶©e
 <
	gC
> 
	ssized_k³rmu‹r_šfo
 {};

42 
	g‹m¶©e
 <> 
	gsized_k³rmu‹r_šfo
<0> {

43 
ušt16_t
 
	t¡Üage_ty³
;

44 
	tv®ue_ty³
;

45 ’um { 
	gš™Ÿl_v®ue
 = 0x0120U, 
	gfuÎ_v®ue
 = 0x2100U };

47 
	g‹m¶©e
 <> 
	gsized_k³rmu‹r_šfo
<1> {

48 
ušt32_t
 
	t¡Üage_ty³
;

49 
	tv®ue_ty³
;

50 ’um { 
	gš™Ÿl_v®ue
 = 0x01234560U, 
	gfuÎ_v®ue
 = 0x65432100U };

52 
	g‹m¶©e
 <> 
	gsized_k³rmu‹r_šfo
<2> {

53 
ušt64_t
 
	t¡Üage_ty³
;

54 
ušt64_t
 
	tv®ue_ty³
;

55 ’um { 
	gš™Ÿl_v®ue
 = (
ušt64_t
) 0x0123456789ABCDE0ULL,

56 
	gfuÎ_v®ue
 = (
ušt64_t
) 0xEDCBA98765432100ULL };

59 
	g‹m¶©e
 <
	gwidth
> cÏs 
	ck³rmu‹r
 {

60 
	mpublic
:

61 
sized_k³rmu‹r_šfo
<(
	twidth
 > 3è+ (width > 7è+ (width > 15)> 
	tšfo
;

62 
ty³Çme
 
	tšfo
::
	t¡Üage_ty³
 storage_type;

63 
ty³Çme
 
	tšfo
::
	tv®ue_ty³
 value_type;

64 ’um { 
	mmax_width
 = (è((
¡Üage_ty³
) * 2 - 1) };

65 ’um { 
	gsize_b™s
 = 4 };

68 
	$k³rmu‹r
() {

69 
	}
}

71 
	$k³rmu‹r
(
v®ue_ty³
 
x
)

72 : 
	$x_
(
x
) {

73 
	}
}

78 
šlše
 
v®ue_ty³
 
	$make_em±y
() {

79 
v®ue_ty³
 
p
 = (v®ue_ty³è
šfo
::
š™Ÿl_v®ue
 >> ((
max_width
 - 
width
) << 2);

80  
p
 & ~(
v®ue_ty³
) 15;

81 
	}
}

87 
šlše
 
v®ue_ty³
 
	$make_sÜ‹d
(
n
) {

88 
v®ue_ty³
 
mask
 = (
n
 =ğ
width
 ? (value_type) 0 : (value_type) 16 << (n << 2)) - 1;

89  (
	`make_em±y
(è<< (
n
 << 2))

90 | ((
v®ue_ty³
è
šfo
::
fuÎ_v®ue
 & 
mask
)

91 | 
n
;

92 
	}
}

95 
	$size
() const {

96  
x_
 & 15;

97 
	}
}

100 
	gİ”©Ü
[](
	gi
) const {

101  (
	gx_
 >> ((
	gi
 << 2) + 4)) & 15;

103 
	$back
() const {

104  (*
this
)[
width
 - 1];

105 
	}
}

106 
v®ue_ty³
 
	$v®ue
() const {

107  
x_
;

108 
	}
}

109 
v®ue_ty³
 
	$v®ue_äom
(
i
) const {

110  
x_
 >> ((
i
 + 1) << 2);

111 
	}
}

113 
	$£t_size
(
n
) {

114 
x_
 = (x_ & ~(
v®ue_ty³
è15è| 
n
;

115 
	}
}

134 
	$š£¹_äom_back
(
i
) {

135 
v®ue
 = 
	`back
();

137 
x_
 = ((x_ + 1è& (((
v®ue_ty³
è16 << (
i
 << 2)) - 1))

139 | ((
v®ue_ty³
è
v®ue
 << ((
i
 << 2) + 4))

141 | ((
x_
 << 4è& ~(((
v®ue_ty³
è256 << (
i
 << 2)) - 1));

142  
v®ue
;

143 
	}
}

149 
	$š£¹_£Ëùed
(
di
, 
si
) {

150 (è
width
;

151 
v®ue
 = (*
this
)[
si
];

152 
v®ue_ty³
 
mask
 = ((v®ue_ty³è256 << (
si
 << 2)) - 1;

154 
x_
 = ((x_ + 1è& (((
v®ue_ty³
è16 << (
di
 << 2)) - 1))

156 | ((
v®ue_ty³
è
v®ue
 << ((
di
 << 2) + 4))

158 | ((
x_
 << 4è& 
mask
 & ~(((
v®ue_ty³
è256 << (
di
 << 2)) - 1))

160 | (
x_
 & ~
mask
);

161 
	}
}

179 
	$»move
(
i
) {

180 (è
width
;

181 ià((
x_
 & 15è=ğ
i
 + 1)

182 --
x_
;

184 
rÙ_amouÁ
 = ((
x_
 & 15è- 
i
 - 1) << 2;

185 
v®ue_ty³
 
rÙ_mask
 =

186 (((
v®ue_ty³
è16 << 
rÙ_amouÁ
è- 1è<< ((
i
 + 1) << 2);

188 
x_
 = ((x_ - 1è& ~
rÙ_mask
)

190 | (((
x_
 & 
rÙ_mask
) >> 4) &„ot_mask)

192 | (((
x_
 & 
rÙ_mask
è<< 
rÙ_amouÁ
) &„ot_mask);

194 
	}
}

212 
	$»move_to_back
(
i
) {

213 
v®ue_ty³
 
mask
 = ~(((v®ue_ty³è16 << (
i
 << 2)) - 1);

215 
v®ue_ty³
 
x
 = 
x_
 & (((v®ue_ty³è16 << (
width
 << 2)) - 1);

217 
x_
 = ((
x
 - 1è& ~
mask
)

219 | ((
x
 >> 4è& 
mask
)

221 | ((
x
 & 
mask
è<< ((
width
 - 
i
 - 1) << 2));

222 
	}
}

238 
	$rÙ©e
(
i
, 
j
) {

239 
v®ue_ty³
 
mask
 = (
i
 =ğ
width
 ? (value_type) 0 : (value_type) 16 << (i << 2)) - 1;

241 
v®ue_ty³
 
x
 = 
x_
 & (((v®ue_ty³è16 << (
width
 << 2)) - 1);

242 
x_
 = (
x
 & 
mask
)

243 | ((
x
 >> ((
j
 - 
i
è<< 2)è& ~
mask
)

244 | ((
x
 & ~
mask
è<< ((
width
 - 
j
) << 2));

245 
	}
}

247 
	$exchªge
(
i
, 
j
) {

248 
v®ue_ty³
 
diff
 = ((
x_
 >> (
i
 << 2)è^ (x_ >> (
j
 << 2))) & 240;

249 
x_
 ^ğ(
diff
 << (
i
 << 2)è| (difà<< (
j
 << 2));

250 
	}
}

252 
	$exchªge_v®ues
(
x
, 
y
) {

253 
v®ue_ty³
 
diff
 = 0, 
p
 = 
x_
;

254 
i
 = 0; i < 
width
; ++i, 
diff
 <<ğ4, 
p
 <<= 4) {

255 
v
 = (
p
 >> (
width
 << 2)) & 15;

256 
diff
 ^ğ-((
v
 =ğ
x
è| (v =ğ
y
)) & (x ^ y);

258 
x_
 ^ğ
diff
;

259 
	}
}

261 
	glcdf
::
SŒšg
 
	$uÅ¬£
() const;

263 
boŞ
 
İ”©Ü
==(cÚ¡ 
k³rmu‹r
<
width
>& 
x
) const {

264  
x_
 =ğ
x
.x_;

265 
	}
}

266 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
k³rmu‹r
<
width
>& 
x
) const {

267  !(*
this
 =ğ
x
);

270 
šlše
 
	$size
(
v®ue_ty³
 
p
) {

271  
p
 & 15;

272 
	}
}

273 
	g´iv©e
:

274 
v®ue_ty³
 
x_
;

277 
	g‹m¶©e
 <
	gwidth
>

278 
	glcdf
::
SŒšg
 
k³rmu‹r
<
width
>::
	$uÅ¬£
() const

280 
buf
[
max_width
 + 3], *
s
 = buf;

281 
v®ue_ty³
 
	`p
(
x_
);

282 
v®ue_ty³
 
	`£’
(0);

283 
n
 = 
p
 & 15;

284 
p
 >>= 4;

285 
i
 = 0; 
Œue
; ++i) {

286 ià(
i
 =ğ
n
)

287 *
s
++ = ':';

288 ià(
i
 =ğ
width
)

290 ià((
p
 & 15) < 10)

291 *
s
++ = '0' + (
p
 & 15);

293 *
s
++ = 'a' + (
p
 & 15) - 10;

294 
£’
 |ğ1 << (
p
 & 15);

295 
p
 >>= 4;

297 ià(
£’
 !ğ(1 << 
width
) - 1) {

298 *
s
++ = '?';

299 *
s
++ = '!';

301  
lcdf
::
	`SŒšg
(
buf
, 
s
);

302 
	}
}

305 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	shas_³rmu‹r_ty³
 {

306 
	m‹m¶©e
 <
ty³Çme
 
	mC
> 
‹¡
Ñy³Çm
C
::
³rmu‹r_ty³
 *);

307 
	m‹m¶©e
 <
	mty³Çme
> 
‹¡
(...);

308 
cÚ¡ex´
 
boŞ
 
	mv®ue
 = (
‹¡
<
T
>(0)) == 1;

311 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gHP
 = 
has_³rmu‹r_ty³
<
T
>::
v®ue
> 
	skey_³rmu‹r
 {};

312 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gkey_³rmu‹r
<T, 
	gŒue
> {

313 
ty³Çme
 
	tT
::
	t³rmu‹r_ty³
 
	tty³
;

314 
ty³
 
³rmutiÚ
(cÚ¡ 
T
& 
n
) {

315  
	gn
.
³rmutiÚ
();

318 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gkey_³rmu‹r
<T, 
	gçl£
> {

319 
id’t™y_k³rmu‹r
 
	tty³
;

320 
ty³
 
³rmutiÚ
(cÚ¡ 
T
& 
n
) {

321  
id’t™y_k³rmu‹r
(
n
.
size
());

	@masstree-beta/ksearch.hh

16 #iâdeà
KSEARCH_HH


17 
	#KSEARCH_HH
 1

	)

18 
	~"k³rmu‹r.hh
"

20 
	g‹m¶©e
 <
ty³Çme
 
	gKA
,y³Çm
	gT
>

21 
	skey_com·¿tÜ
 {

22 
İ”©Ü
()(cÚ¡ 
	mKA
& 
	mka
, cÚ¡ 
	mT
& 
	mn
, 
	mp
) {

23  
	mn
.
com·»_key
(
ka
, 
p
);

27 
	skey_šdexed_pos™iÚ
 {

28 
	mi
;

29 
	mp
;

30 
šlše
 
key_šdexed_pos™iÚ
() {

32 
šlše
 
cÚ¡ex´
 
key_šdexed_pos™iÚ
(
i_
, 
p_
)

33 : 
i
(
i_
), 
p
(
p_
) {

38 
	g‹m¶©e
 <
ty³Çme
 
	gKA
,y³Çm
	gT
,y³Çm
	gF
>

39 
	$key_uµ”_bound_by
(cÚ¡ 
KA
& 
ka
, cÚ¡ 
T
& 
n
, 
F
 
com·¿tÜ
)

41 
ty³Çme
 
key_³rmu‹r
<
T
>::
ty³
 
³rm
 = key_³rmu‹r<T>::
	`³rmutiÚ
(
n
);

42 
l
 = 0, 
r
 = 
³rm
.
	`size
();

43 
l
 < 
r
) {

44 
m
 = (
l
 + 
r
) >> 1;

45 
mp
 = 
³rm
[
m
];

46 
cmp
 = 
	`com·¿tÜ
(
ka
, 
n
, 
mp
);

47 ià(
cmp
 < 0)

48 
r
 = 
m
;

49 ià(
cmp
 == 0)

50  
m
 + 1;

52 
l
 = 
m
 + 1;

54  
l
;

55 
	}
}

57 
	g‹m¶©e
 <
ty³Çme
 
	gKA
,y³Çm
	gT
>

58 
šlše
 
	$key_uµ”_bound
(cÚ¡ 
KA
& 
ka
, cÚ¡ 
T
& 
n
)

60  
	`key_uµ”_bound_by
(
ka
, 
n
, 
key_com·¿tÜ
<
KA
, 
T
>());

61 
	}
}

63 
	g‹m¶©e
 <
ty³Çme
 
	gKA
,y³Çm
	gT
,y³Çm
	gF
>

64 
key_šdexed_pos™iÚ
 
	$key_low”_bound_by
(cÚ¡ 
KA
& 
ka
, cÚ¡ 
T
& 
n
, 
F
 
com·¿tÜ
)

66 
ty³Çme
 
key_³rmu‹r
<
T
>::
ty³
 
³rm
 = key_³rmu‹r<T>::
	`³rmutiÚ
(
n
);

67 
l
 = 0, 
r
 = 
³rm
.
	`size
();

68 
l
 < 
r
) {

69 
m
 = (
l
 + 
r
) >> 1;

70 
mp
 = 
³rm
[
m
];

71 
cmp
 = 
	`com·¿tÜ
(
ka
, 
n
, 
mp
);

72 ià(
cmp
 < 0)

73 
r
 = 
m
;

74 ià(
cmp
 == 0)

75  
	`key_šdexed_pos™iÚ
(
m
, 
mp
);

77 
l
 = 
m
 + 1;

79  
	`key_šdexed_pos™iÚ
(
l
, -1);

80 
	}
}

82 
	g‹m¶©e
 <
ty³Çme
 
	gKA
,y³Çm
	gT
>

83 
šlše
 
key_šdexed_pos™iÚ
 
	$key_low”_bound
(cÚ¡ 
KA
& 
ka
, cÚ¡ 
T
& 
n
)

85  
	`key_low”_bound_by
(
ka
, 
n
, 
key_com·¿tÜ
<
KA
, 
T
>());

86 
	}
}

89 
	g‹m¶©e
 <
ty³Çme
 
	gKA
,y³Çm
	gT
,y³Çm
	gF
>

90 
	$key_fšd_uµ”_bound_by
(cÚ¡ 
KA
& 
ka
, cÚ¡ 
T
& 
n
, 
F
 
com·¿tÜ
)

92 
ty³Çme
 
key_³rmu‹r
<
T
>::
ty³
 
³rm
 = key_³rmu‹r<T>::
	`³rmutiÚ
(
n
);

93 
l
 = 0, 
r
 = 
³rm
.
	`size
();

94 
l
 < 
r
) {

95 
Í
 = 
³rm
[
l
];

96 
cmp
 = 
	`com·¿tÜ
(
ka
, 
n
, 
Í
);

97 ià(
cmp
 < 0)

100 ++
l
;

102  
l
;

103 
	}
}

105 
	g‹m¶©e
 <
ty³Çme
 
	gKA
,y³Çm
	gT
,y³Çm
	gF
>

106 
key_šdexed_pos™iÚ
 
	$key_fšd_low”_bound_by
(cÚ¡ 
KA
& 
ka
, cÚ¡ 
T
& 
n
, 
F
 
com·¿tÜ
)

108 
ty³Çme
 
key_³rmu‹r
<
T
>::
ty³
 
³rm
 = key_³rmu‹r<T>::
	`³rmutiÚ
(
n
);

109 
l
 = 0, 
r
 = 
³rm
.
	`size
();

110 
l
 < 
r
) {

111 
Í
 = 
³rm
[
l
];

112 
cmp
 = 
	`com·¿tÜ
(
ka
, 
n
, 
Í
);

113 ià(
cmp
 < 0)

115 ià(
cmp
 == 0)

116  
	`key_šdexed_pos™iÚ
(
l
, 
Í
);

118 ++
l
;

120  
	`key_šdexed_pos™iÚ
(
l
, -1);

121 
	}
}

124 
	skey_bound_bš¬y
 {

125 
cÚ¡ex´
 
boŞ
 
	mis_bš¬y
 = 
Œue
;

126 
	m‹m¶©e
 <
ty³Çme
 
	mKA
,y³Çm
	mT
>

127 
šlše
 
uµ”
(cÚ¡ 
KA
& 
ka
, cÚ¡ 
T
& 
n
) {

128  
key_uµ”_bound_by
(
ka
, 
n
, 
key_com·¿tÜ
<
KA
, 
T
>());

130 
	m‹m¶©e
 <
ty³Çme
 
	mKA
,y³Çm
	mT
>

131 
šlše
 
key_šdexed_pos™iÚ
 
low”
(cÚ¡ 
KA
& 
ka
, cÚ¡ 
T
& 
n
) {

132  
key_low”_bound_by
(
ka
, 
n
, 
key_com·¿tÜ
<
KA
, 
T
>());

134 
	m‹m¶©e
 <
ty³Çme
 
	mKA
,y³Çm
	mT
,y³Çm
	mF
>

135 
šlše
 
key_šdexed_pos™iÚ
 
low”_by
(cÚ¡ 
KA
& 
ka
, cÚ¡ 
T
& 
n
, 
F
 
com·¿tÜ
) {

136  
key_low”_bound_by
(
ka
, 
n
, 
com·¿tÜ
);

140 
	skey_bound_lš—r
 {

141 
cÚ¡ex´
 
boŞ
 
	mis_bš¬y
 = 
çl£
;

142 
	m‹m¶©e
 <
ty³Çme
 
	mKA
,y³Çm
	mT
>

143 
šlše
 
uµ”
(cÚ¡ 
KA
& 
ka
, cÚ¡ 
T
& 
n
) {

144  
key_fšd_uµ”_bound_by
(
ka
, 
n
, 
key_com·¿tÜ
<
KA
, 
T
>());

146 
	m‹m¶©e
 <
ty³Çme
 
	mKA
,y³Çm
	mT
>

147 
šlše
 
key_šdexed_pos™iÚ
 
low”
(cÚ¡ 
KA
& 
ka
, cÚ¡ 
T
& 
n
) {

148  
key_fšd_low”_bound_by
(
ka
, 
n
, 
key_com·¿tÜ
<
KA
, 
T
>());

150 
	m‹m¶©e
 <
ty³Çme
 
	mKA
,y³Çm
	mT
,y³Çm
	mF
>

151 
šlše
 
key_šdexed_pos™iÚ
 
low”_by
(cÚ¡ 
KA
& 
ka
, cÚ¡ 
T
& 
n
, 
F
 
com·¿tÜ
) {

152  
key_fšd_low”_bound_by
(
ka
, 
n
, 
com·¿tÜ
);

158 
	mbound_m‘hod_ç¡
 = 0,

159 
	mbound_m‘hod_bš¬y
,

160 
	mbound_m‘hod_lš—r


162 
	g‹m¶©e
 <
	gmax_size
, 
	gm‘hod
 = 
bound_m‘hod_ç¡
> 
	skey_bound
 {};

163 
	g‹m¶©e
 <
	gmax_size
> 
	gkey_bound
<max_size, 
	gbound_m‘hod_bš¬y
> {

164 
key_bound_bš¬y
 
	tty³
;

166 
	g‹m¶©e
 <
	gmax_size
> 
	gkey_bound
<max_size, 
	gbound_m‘hod_lš—r
> {

167 
key_bound_lš—r
 
	tty³
;

169 
	g‹m¶©e
 <
	gmax_size
> 
	gkey_bound
<max_size, 
	gbound_m‘hod_ç¡
> {

170 
ty³Çme
 
	tkey_bound
<
	tmax_size
, (max_siz> 16 ? 
	tbound_m‘hod_bš¬y
 : 
	tbound_m‘hod_lš—r
)>::
	tty³
ype;

	@masstree-beta/kvio.cc

23 
	~<¡dlib.h
>

24 
	~<uni¡d.h
>

25 
	~<¡ršg.h
>

26 
	~<sys/£Ëù.h
>

27 
	~<sys/time.h
>

28 
	~<as£¹.h
>

29 
	~<¡dio.h
>

30 
	~<”ºo.h
>

31 
	~"kvio.hh
"

35 
kvout
* 
	$Ãw_kvout
(
fd
, 
buæ’
) {

36 
kvout
* 
kv
 = (kvout*è
	`m®loc
((kvout));

37 
	`as£¹
(
kv
);

38 
	`mem£t
(
kv
, 0, (*kv));

39 
kv
->
ÿ·c™y
 = 
buæ’
;

40 
kv
->
buf
 = (*è
	`m®loc
(kv->
ÿ·c™y
);

41 
	`as£¹
(
kv
->
buf
);

42 
kv
->
fd
 = fd;

43  
kv
;

44 
	}
}

47 
kvout
* 
	$Ãw_bufkvout
() {

48 
kvout
 *
kv
 = (kvout*è
	`m®loc
((kvout));

49 
	`as£¹
(
kv
);

50 
	`mem£t
(
kv
, 0, (*kv));

51 
kv
->
ÿ·c™y
 = 256;

52 
kv
->
buf
 = (*è
	`m®loc
(kv->
ÿ·c™y
);

53 
	`as£¹
(
kv
->
buf
);

54 
kv
->
n
 = 0;

55 
kv
->
fd
 = -1;

56  
kv
;

57 
	}
}

60 
	$kvout_»£t
(
kvout
* 
kv
) {

61 
	`as£¹
(
kv
->
fd
 < 0);

62 
kv
->
n
 = 0;

63 
	}
}

67 
	$ä“_kvout
(
kvout
* 
kv
) {

68 ià(
kv
->
buf
)

69 
	`ä“
(
kv
->
buf
);

70 
kv
->
buf
 = 0;

71 
	`ä“
(
kv
);

72 
	}
}

74 
	$kvæush
(
kvout
* 
kv
) {

75 
	`as£¹
(
kv
->
fd
 >= 0);

76 
size_t
 
£Á
 = 0;

77 
kv
->
n
 > 
£Á
) {

78 
ssize_t
 
cc
 = 
	`wr™e
(
kv
->
fd
, kv->
buf
 + 
£Á
, kv->
n
 - sent);

79 ià(
cc
 <= 0) {

80 ià(
”ºo
 =ğ
EWOULDBLOCK
) {

81 
	`u¦“p
(1);

84 
	`³¼Ü
("kvflush write");

87 
£Á
 +ğ
cc
;

89 
kv
->
n
 = 0;

90 
	}
}

93 
	gkvout
::
	$grow
(
wªt
) {

94 ià(
fd
 >= 0)

95 
	`kvæush
(
this
);

96 ià(
wªt
 == 0)

97 
wªt
 = 
ÿ·c™y
 + 1;

98 
wªt
 > 
ÿ·c™y
)

99 
ÿ·c™y
 *= 2;

100 
buf
 = (*è
	`»®loc
(buf, 
ÿ·c™y
);

101 
	`as£¹
(
buf
);

102 
	}
}

104 
	$kvwr™e
(
kvout
* 
kv
, cÚ¡ * 
buf
, 
n
) {

105 ià(
kv
->
n
 +‚ > kv->
ÿ·c™y
 && kv->
fd
 >= 0)

106 
	`kvæush
(
kv
);

107 ià(
kv
->
n
 +‚ > kv->
ÿ·c™y
)

108 
kv
->
	`grow
(kv->
n
 +‚);

109 
	`memıy
(
kv
->
buf
 + kv->
n
, buf,‚);

110 
kv
->
n
 +=‚;

111  
n
;

112 
	}
}

	@masstree-beta/kvio.hh

16 #iâdeà
KVIO_H


17 
	#KVIO_H


	)

18 
	~<¡ršg
>

19 
	~<veùÜ
>

20 
	~<¡dlib.h
>

21 
	~"¡ršg.hh
"

22 
	~"¡r.hh
"

24 
	skvout
 {

25 
	mfd
;

26 * 
	mbuf
;

27 
	mÿ·c™y
;

28 
	mn
;

30 
šlše
 
­³nd
(
c
);

31 
šlše
 * 
»£rve
(
n
);

32 
šlše
 
adju¡_Ëngth
(
d–
);

33 
šlše
 
£t_’d
(* 
’d
);

34 
grow
(
wªt
);

37 
kvout
* 
Ãw_kvout
(
fd
, 
buæ’
);

38 
kvout
* 
Ãw_bufkvout
();

39 
kvout_»£t
(
kvout
* 
kv
);

40 
ä“_kvout
(
kvout
* 
kv
);

41 
kvwr™e
(
kvout
* 
kv
, cÚ¡ * 
buf
, 
n
);

42 
kvæush
(
kvout
* 
kv
);

44 
šlše
 
	gkvout
::
	$­³nd
(
c
) {

45 ià(
n
 =ğ
ÿ·c™y
)

46 
	`grow
(0);

47 
buf
[
n
] = 
c
;

48 ++
n
;

49 
	}
}

51 
šlše
 * 
	gkvout
::
	$»£rve
(
nch¬s
) {

52 ià(
n
 + 
nch¬s
 > 
ÿ·c™y
)

53 
	`grow
(
n
 + 
nch¬s
);

54  
buf
 + 
n
;

55 
	}
}

57 
šlše
 
	gkvout
::
	$adju¡_Ëngth
(
d–
) {

58 
	`mas¡»e_´ecÚd™iÚ
(
n
 + 
d–
 <ğ
ÿ·c™y
);

59 
n
 +ğ
d–
;

60 
	}
}

62 
šlše
 
	gkvout
::
	$£t_’d
(* 
x
) {

63 
	`mas¡»e_´ecÚd™iÚ
(
x
 >ğ
buf
 && x <ğbuà+ 
ÿ·c™y
);

64 
n
 = 
x
 - 
buf
;

65 
	}
}

	@masstree-beta/kvproto.hh

16 #iâdeà
KVPROTO_HH


17 
	#KVPROTO_HH


	)

18 
	~"comp”.hh
"

21 
	mCmd_NÚe
 = 0,

22 
	mCmd_G‘
 = 2,

23 
	mCmd_Sÿn
 = 4,

24 
	mCmd_Put
 = 6,

25 
	mCmd_R•Ïû
 = 8,

26 
	mCmd_Remove
 = 10,

27 
	mCmd_Checkpošt
 = 12,

28 
	mCmd_Hªdshake
 = 14,

29 
	mCmd_Max


32 
	e»suÉ_t
 {

33 
	mNÙFound
 = -2,

34 
	mR‘ry
,

35 
	mOutOfD©e
,

36 
	mIn£¹ed
,

37 
	mUpd©ed
,

38 
	mFound
,

39 
	mSÿnDÚe


42 
	eck±¿v_Üd”_t
 {

43 
	mck±¿v_šÜd”
 = 0,

44 
	mck±¿v_´eÜd”


47 
	srow_m¬k”
 {

48 ’um { 
	mmt_»move
 = 1, 
	mmt_d–
 = 2 };

49 
	mm¬k”_ty³_
;

52 
	g‹m¶©e
 <
ty³Çme
 
	gR
>

53 
šlše
 
boŞ
 
	$row_is_m¬k”
(cÚ¡ 
R
* 
row
) {

54  
row
->
	`time¡amp
() & 1;

55 
	}
}

	@masstree-beta/kvrandom.cc

16 
	~"kv¿ndom.hh
"

17 
	~"comp”.hh
"

18 
	~<¡dio.h
>

20 cÚ¡ 
ušt32_t
 
	gkv¿ndom_psdes_Ä
::
c1
[] = {

23 cÚ¡ 
ušt32_t
 
	gkv¿ndom_psdes_Ä
::
c2
[] = {

27 
ušt32_t
 
	gkv¿ndom_psdes_Ä
::
	$psdes
(
ušt32_t
 
lwÜd
, ušt32_ˆ
œwÜd
) {

28 
i
 = 0; i < 
n™”
; ++i) {

29 
ušt32_t
 
isw­
 = 
œwÜd
;

30 
ušt32_t
 
Ÿ
 = 
œwÜd
 ^ 
c1
[
i
];

31 
ušt32_t
 

 = 
Ÿ
 & 0xFFFF, 
ih
 = ia >> 16;

32 
ušt32_t
 
ib
 = 

 * iÈ+ ~(
ih
 * ih);

33 
Ÿ
 = (
ib
 >> 16) | (ib << 16);

34 
œwÜd
 = 
lwÜd
 ^ ((
Ÿ
 ^ 
c2
[
i
]è+ 

 * 
ih
);

35 
lwÜd
 = 
isw­
;

37  
œwÜd
;

38 
	}
}

	@masstree-beta/kvrandom.hh

16 #iâdeà
KVRANDOM_HH


17 
	#KVRANDOM_HH
 1

	)

18 
	~<š‰y³s.h
>

19 
	~<¡dlib.h
>

22 şas 
	ckv¿ndom_lcg_Ä_sim¶e
 { 
	mpublic
:

23 ’um { 
mš_v®ue
 = 0, 
	mmax_v®ue
 = 0xFFFFFFFFU };

24 
ušt32_t
 
	tv®ue_ty³
;

25 
ušt32_t
 
	t£ed_ty³
;

26 
	$kv¿ndom_lcg_Ä_sim¶e
()

27 : 
	$£ed_
(
deçuÉ_£ed
) {

28 
	}
}

29 
ex¶ic™
 
	$kv¿ndom_lcg_Ä_sim¶e
(
£ed_ty³
 
£ed
)

30 : 
	$£ed_
(
£ed
) {

31 
	}
}

32 
	$»£t
(
£ed_ty³
 
£ed
) {

33 
£ed_
 = 
£ed
;

34 
	}
}

35 
v®ue_ty³
 
	$Ãxt
() {

36  (
£ed_
 = s“d_ * 
a
 + 
c
);

37 
	}
}

38 
	g´iv©e
:

39 
ušt32_t
 
£ed_
;

40 ’um { 
	gdeçuÉ_£ed
 = 819234718U, 
	ga
 = 1664525U, 
	gc
 = 1013904223U };

46 şas 
	ckv¿ndom_lcg_Ä
 : 
public
 
kv¿ndom_lcg_Ä_sim¶e
 {…ublic:

47 ’um { 
mš_v®ue
 = 0, 
	mmax_v®ue
 = 0x7FFFFFFF };

48 
št32_t
 
	tv®ue_ty³
;

49 
v®ue_ty³
 
	$Ãxt
() {

50 
ušt32_t
 
x0
 = 
kv¿ndom_lcg_Ä_sim¶e
::
	`Ãxt
(),

51 
x1
 = 
kv¿ndom_lcg_Ä_sim¶e
::
	`Ãxt
();

52  (
x0
 >> 15è| ((
x1
 & 0x7FFE) << 16);

53 
	}
}

57 şas 
	ckv¿ndom_psdes_Ä
 { 
	mpublic
:

58 ’um { 
mš_v®ue
 = 0, 
	mmax_v®ue
 = 0xFFFFFFFFU };

59 
ušt32_t
 
	tv®ue_ty³
;

60 
ušt32_t
 
	t£ed_ty³
;

61 
	$kv¿ndom_psdes_Ä
() {

62 
	`»£t
(1);

63 
	}
}

64 
ex¶ic™
 
	$kv¿ndom_psdes_Ä
(
£ed_ty³
 
£ed
) {

65 
	`»£t
(
£ed
);

66 
	}
}

67 
	$»£t
(
£ed_ty³
 
£ed
) {

68 
£ed_
 = 
£ed
;

69 
Ãxt_
 = 1;

70 
	}
}

71 
v®ue_ty³
 
	$Ãxt
() {

72 
ušt32_t
 
v®ue
 = 
	`psdes
(
£ed_
, 
Ãxt_
);

73 ++
Ãxt_
;

74  
v®ue
;

75 
	}
}

76 
v®ue_ty³
 
	gİ”©Ü
[](
ušt32_t
 
	gšdex
) const {

77  
psdes
(
£ed_
, 
šdex
);

79 
	g´iv©e
:

80 
ušt32_t
 
£ed_
;

81 
ušt32_t
 
	gÃxt_
;

82 ’um { 
	gn™”
 = 4 };

83 cÚ¡ 
ušt32_t
 
	gc1
[
n™”
], 
	gc2
[niter];

84 
ušt32_t
 
psdes
(ušt32_ˆ
lwÜd
, ušt32_ˆ
œwÜd
);

88 şas 
	ckv¿ndom_¿ndom
 { 
	mpublic
:

89 
	$kv¿ndom_¿ndom
() {

91 
	$»£t
(
ušt32_t
 
£ed
) {

92 
	`¤ªdom
(
£ed
);

93 
	}
}

94 
št32_t
 
	$Ãxt
() const {

95  
	`¿ndom
();

96 
	}
}

	@masstree-beta/kvrow.hh

16 #iâdeà
KVROW_HH


17 
	#KVROW_HH
 1

	)

18 
	~"kvth»ad.hh
"

19 
	~"kv´Ùo.hh
"

20 
	~"log.hh
"

21 
	~"jsÚ.hh
"

22 
	~<®gÜ™hm
>

24 #ià
MASSTREE_ROW_TYPE_ARRAY


25 
	~"v®ue_¬¿y.hh
"

26 
v®ue_¬¿y
 
	trow_ty³
;

27 #–ià
MASSTREE_ROW_TYPE_ARRAY_VER


28 
	~"v®ue_v”siÚed_¬¿y.hh
"

29 
v®ue_v”siÚed_¬¿y
 
	trow_ty³
;

30 #–ià
MASSTREE_ROW_TYPE_STR


31 
	~"v®ue_¡ršg.hh
"

32 
v®ue_¡ršg
 
	trow_ty³
;

34 
	~"v®ue_bag.hh
"

35 
	gv®ue_bag
<
	tušt16_t
> 
	trow_ty³
;

38 
	g‹m¶©e
 <
ty³Çme
 
	gR
>

39 
	squ”y_h–³r
 {

40 
šlše
 cÚ¡ 
R
* 
¢­shÙ
(cÚ¡ R* 
row
, cÚ¡ 
¡d
::
veùÜ
<
ty³Çme
 R::
šdex_ty³
>&, 
th»adšfo
&) {

41  
	mrow
;

45 
	g‹m¶©e
 <
ty³Çme
 
	gR
> 
şass
 
	gqu”y_jsÚ_sÿÂ”
;

47 
	g‹m¶©e
 <
ty³Çme
 
	gR
>

48 şas 
	cqu”y
 {

49 
	mpublic
:

50 
lcdf
::
	tJsÚ
 Json;

52 
	m‹m¶©e
 <
ty³Çme
 
	mT
>

53 
run_g‘
(
T
& 
bË
, 
JsÚ
& 
»q
, 
th»adšfo
& 
ti
);

54 
	m‹m¶©e
 <
ty³Çme
 
	mT
>

55 
boŞ
 
run_g‘1
(
T
& 
bË
, 
SŒ
 
key
, 
cŞ
, SŒ& 
v®ue
, 
th»adšfo
& 
ti
);

57 
	m‹m¶©e
 <
ty³Çme
 
	mT
>

58 
»suÉ_t
 
run_put
(
T
& 
bË
, 
SŒ
 
key
,

59 cÚ¡ 
JsÚ
* 
fœ¡»q
, cÚ¡ JsÚ* 
Ï¡»q
, 
th»adšfo
& 
ti
);

60 
	m‹m¶©e
 <
ty³Çme
 
	mT
>

61 
»suÉ_t
 
run_»¶aû
(
T
& 
bË
, 
SŒ
 
key
, SŒ 
v®ue
, 
th»adšfo
& 
ti
);

62 
	m‹m¶©e
 <
ty³Çme
 
	mT
>

63 
boŞ
 
run_»move
(
T
& 
bË
, 
SŒ
 
key
, 
th»adšfo
& 
ti
);

65 
	m‹m¶©e
 <
ty³Çme
 
	mT
>

66 
run_sÿn
(
T
& 
bË
, 
JsÚ
& 
»que¡
, 
th»adšfo
& 
ti
);

67 
	m‹m¶©e
 <
ty³Çme
 
	mT
>

68 
run_rsÿn
(
T
& 
bË
, 
JsÚ
& 
»que¡
, 
th»adšfo
& 
ti
);

70 cÚ¡ 
	mlogšfo
::
qu”y_times
& 
	$qu”y_times
() const {

71  
qtimes_
;

74 
´iv©e
:

75 
¡d
::
veùÜ
<
ty³Çme
 
R
::
šdex_ty³
> 
f_
;

76 
logšfo
::
qu”y_times
 
qtimes_
;

77 
qu”y_h–³r
<
R
> 
h–³r_
;

78 
lcdf
::
SŒšg
 
sÿnkey_
;

79 
sÿnkeypos_
;

81 
	`em™_f›lds
(cÚ¡ 
R
* 
v®ue
, 
JsÚ
& 
»q
, 
th»adšfo
& 
ti
);

82 
	`em™_f›lds1
(cÚ¡ 
R
* 
v®ue
, 
JsÚ
& 
»q
, 
th»adšfo
& 
ti
);

83 
	`assign_time¡amp
(
th»adšfo
& 
ti
);

84 
	`assign_time¡amp
(
th»adšfo
& 
ti
, 
kvtime¡amp_t
 
t
);

85 
šlše
 
boŞ
 
	`­¶y_put
(
R
*& 
v®ue
, boŞ 
found
, cÚ¡ 
JsÚ
* 
fœ¡»q
,

86 cÚ¡ 
JsÚ
* 
Ï¡»q
, 
th»adšfo
& 
ti
);

87 
šlše
 
boŞ
 
	`­¶y_»¶aû
(
R
*& 
v®ue
, boŞ 
found
, 
SŒ
 
Ãw_v®ue
,

88 
th»adšfo
& 
ti
);

89 
šlše
 
	`­¶y_»move
(
R
*& 
v®ue
, 
kvtime¡amp_t
& 
node_ts
, 
th»adšfo
& 
ti
);

91 
‹m¶©e
 <
ty³Çme
 
RR
> 
ä›nd
 
şass
 
qu”y_jsÚ_sÿÂ”
;

92 
	}
};

95 
	g‹m¶©e
 <
ty³Çme
 
	gR
>

96 
	gqu”y
<
	gR
>::
	$em™_f›lds
(cÚ¡ 
R
* 
v®ue
, 
JsÚ
& 
»q
, 
th»adšfo
& 
ti
) {

97 cÚ¡ 
R
* 
¢­shÙ
 = 
h–³r_
.
	`¢­shÙ
(
v®ue
, 
f_
, 
ti
);

98 ià(
f_
.
	`em±y
()) {

99 
i
 = 0; i !ğ
¢­shÙ
->
	`ncŞ
(); ++i)

100 
»q
.
	`push_back
(
lcdf
::
SŒšg
::
	`make_¡abË
(
¢­shÙ
->
	`cŞ
(
i
)));

102 
i
 = 0; i !ğ(è
f_
.
	`size
(); ++i)

103 
»q
.
	`push_back
(
lcdf
::
SŒšg
::
	`make_¡abË
(
¢­shÙ
->
	`cŞ
(
f_
[
i
])));

105 
	}
}

107 
	g‹m¶©e
 <
ty³Çme
 
	gR
>

108 
	gqu”y
<
	gR
>::
	$em™_f›lds1
(cÚ¡ 
R
* 
v®ue
, 
JsÚ
& 
»q
, 
th»adšfo
& 
ti
) {

109 cÚ¡ 
R
* 
¢­shÙ
 = 
h–³r_
.
	`¢­shÙ
(
v®ue
, 
f_
, 
ti
);

110 ià((
f_
.
	`em±y
(è&& 
¢­shÙ
->
	`ncŞ
(è=ğ1è|| f_.
	`size
() == 1)

111 
»q
 = 
lcdf
::
SŒšg
::
	`make_¡abË
(
¢­shÙ
->
	`cŞ
(
f_
.
	`em±y
() ? 0 : f_[0]));

112 ià(
f_
.
	`em±y
()) {

113 
i
 = 0; i !ğ
¢­shÙ
->
	`ncŞ
(); ++i)

114 
»q
.
	`push_back
(
lcdf
::
SŒšg
::
	`make_¡abË
(
¢­shÙ
->
	`cŞ
(
i
)));

116 
i
 = 0; i !ğ(è
f_
.
	`size
(); ++i)

117 
»q
.
	`push_back
(
lcdf
::
SŒšg
::
	`make_¡abË
(
¢­shÙ
->
	`cŞ
(
f_
[
i
])));

119 
	}
}

122 
	g‹m¶©e
 <
ty³Çme
 
	gR
>em¶©<ty³Çm
	gT
>

123 
	gqu”y
<
	gR
>::
	$run_g‘
(
T
& 
bË
, 
JsÚ
& 
»q
, 
th»adšfo
& 
ti
) {

124 
ty³Çme
 
T
::
uÆocked_cursÜ_ty³
 
	`Í
(
bË
, 
»q
[2].
	`as_s
());

125 
boŞ
 
found
 = 
Í
.
	`fšd_uÆocked
(
ti
);

126 ià(
found
 && 
	`row_is_m¬k”
(
Í
.
	`v®ue
()))

127 
found
 = 
çl£
;

128 ià(
found
) {

129 
f_
.
	`ş—r
();

130 
i
 = 3; i !ğ
»q
.
	`size
(); ++i)

131 
f_
.
	`push_back
(
»q
[
i
].
	`as_i
());

132 
»q
.
	`»size
(2);

133 
	`em™_f›lds
(
Í
.
	`v®ue
(), 
»q
, 
ti
);

135 
	}
}

137 
	g‹m¶©e
 <
ty³Çme
 
	gR
>em¶©<ty³Çm
	gT
>

138 
boŞ
 
	gqu”y
<
	gR
>::
	$run_g‘1
(
T
& 
bË
, 
SŒ
 
key
, 
cŞ
, SŒ& 
v®ue
, 
th»adšfo
& 
ti
) {

139 
ty³Çme
 
T
::
uÆocked_cursÜ_ty³
 
	`Í
(
bË
, 
key
);

140 
boŞ
 
found
 = 
Í
.
	`fšd_uÆocked
(
ti
);

141 ià(
found
 && 
	`row_is_m¬k”
(
Í
.
	`v®ue
()))

142 
found
 = 
çl£
;

143 ià(
found
)

144 
v®ue
 = 
Í
.
	`v®ue
()->
	`cŞ
(
cŞ
);

145  
found
;

146 
	}
}

149 
	g‹m¶©e
 <
ty³Çme
 
	gR
>

150 
šlše
 
	gqu”y
<
	gR
>::
	$assign_time¡amp
(
th»adšfo
& 
ti
) {

151 
qtimes_
.
ts
 = 
ti
.
	`upd©e_time¡amp
();

152 
qtimes_
.
´ev_ts
 = 0;

153 
	}
}

155 
	g‹m¶©e
 <
ty³Çme
 
	gR
>

156 
šlše
 
	gqu”y
<
	gR
>::
	$assign_time¡amp
(
th»adšfo
& 
ti
, 
kvtime¡amp_t
 
mš_ts
) {

157 
qtimes_
.
ts
 = 
ti
.
	`upd©e_time¡amp
(
mš_ts
);

158 
qtimes_
.
´ev_ts
 = 
mš_ts
;

159 
	}
}

162 
	g‹m¶©e
 <
ty³Çme
 
	gR
>em¶©<ty³Çm
	gT
>

163 
»suÉ_t
 
	gqu”y
<
	gR
>::
	$run_put
(
T
& 
bË
, 
SŒ
 
key
,

164 cÚ¡ 
JsÚ
* 
fœ¡»q
, cÚ¡ JsÚ* 
Ï¡»q
,

165 
th»adšfo
& 
ti
) {

166 
ty³Çme
 
T
::
cursÜ_ty³
 
	`Í
(
bË
, 
key
);

167 
boŞ
 
found
 = 
Í
.
	`fšd_š£¹
(
ti
);

168 ià(!
found
)

169 
ti
.
	`ob£rve_phªtoms
(
Í
.
	`node
());

170 
boŞ
 
š£¹ed
 = 
	`­¶y_put
(
Í
.
	`v®ue
(), 
found
, 
fœ¡»q
, 
Ï¡»q
, 
ti
);

171 
Í
.
	`fšish
(1, 
ti
);

172  
š£¹ed
 ? 
In£¹ed
 : 
Upd©ed
;

173 
	}
}

175 
	g‹m¶©e
 <
ty³Çme
 
	gR
>

176 
šlše
 
boŞ
 
	gqu”y
<
	gR
>::
	$­¶y_put
(
R
*& 
v®ue
, 
boŞ
 
found
, cÚ¡ 
JsÚ
* 
fœ¡»q
,

177 cÚ¡ 
JsÚ
* 
Ï¡»q
, 
th»adšfo
& 
ti
) {

178 ià(
logšfo
* 
log
 = 
ti
.
	`logg”
()) {

179 
log
->
	`acquœe
();

180 
qtimes_
.
•och
 = 
glob®_log_•och
;

183 ià(!
found
) {

184 
š£¹
:

185 
	`assign_time¡amp
(
ti
);

186 
v®ue
 = 
R
::
	`ü—‹
(
fœ¡»q
, 
Ï¡»q
, 
qtimes_
.
ts
, 
ti
);

187  
Œue
;

190 
R
* 
Şd_v®ue
 = 
v®ue
;

191 
	`assign_time¡amp
(
ti
, 
Şd_v®ue
->
	`time¡amp
());

192 ià(
	`row_is_m¬k”
(
Şd_v®ue
)) {

193 
Şd_v®ue
->
	`d—Îoÿ‹_rcu
(
ti
);

194 
š£¹
;

197 
R
* 
upd©ed
 = 
Şd_v®ue
->
	`upd©e
(
fœ¡»q
, 
Ï¡»q
, 
qtimes_
.
ts
, 
ti
);

198 ià(
upd©ed
 !ğ
Şd_v®ue
) {

199 
v®ue
 = 
upd©ed
;

200 
Şd_v®ue
->
	`d—Îoÿ‹_rcu_aá”_upd©e
(
fœ¡»q
, 
Ï¡»q
, 
ti
);

202  
çl£
;

203 
	}
}

205 
	g‹m¶©e
 <
ty³Çme
 
	gR
>em¶©<ty³Çm
	gT
>

206 
»suÉ_t
 
	gqu”y
<
	gR
>::
	$run_»¶aû
(
T
& 
bË
, 
SŒ
 
key
, SŒ 
v®ue
, 
th»adšfo
& 
ti
) {

207 
ty³Çme
 
T
::
cursÜ_ty³
 
	`Í
(
bË
, 
key
);

208 
boŞ
 
found
 = 
Í
.
	`fšd_š£¹
(
ti
);

209 ià(!
found
)

210 
ti
.
	`ob£rve_phªtoms
(
Í
.
	`node
());

211 
boŞ
 
š£¹ed
 = 
	`­¶y_»¶aû
(
Í
.
	`v®ue
(), 
found
, 
v®ue
, 
ti
);

212 
Í
.
	`fšish
(1, 
ti
);

213  
š£¹ed
 ? 
In£¹ed
 : 
Upd©ed
;

214 
	}
}

216 
	g‹m¶©e
 <
ty³Çme
 
	gR
>

217 
šlše
 
boŞ
 
	gqu”y
<
	gR
>::
	$­¶y_»¶aû
(
R
*& 
v®ue
, 
boŞ
 
found
, 
SŒ
 
Ãw_v®ue
,

218 
th»adšfo
& 
ti
) {

219 ià(
logšfo
* 
log
 = 
ti
.
	`logg”
()) {

220 
log
->
	`acquœe
();

221 
qtimes_
.
•och
 = 
glob®_log_•och
;

224 
boŞ
 
š£¹ed
 = !
found
 || 
	`row_is_m¬k”
(
v®ue
);

225 ià(!
found
)

226 
	`assign_time¡amp
(
ti
);

228 
	`assign_time¡amp
(
ti
, 
v®ue
->
	`time¡amp
());

229 
v®ue
->
	`d—Îoÿ‹_rcu
(
ti
);

232 
v®ue
 = 
R
::
	`ü—‹1
(
Ãw_v®ue
, 
qtimes_
.
ts
, 
ti
);

233  
š£¹ed
;

234 
	}
}

236 
	g‹m¶©e
 <
ty³Çme
 
	gR
>em¶©<ty³Çm
	gT
>

237 
boŞ
 
	gqu”y
<
	gR
>::
	$run_»move
(
T
& 
bË
, 
SŒ
 
key
, 
th»adšfo
& 
ti
) {

238 
ty³Çme
 
T
::
cursÜ_ty³
 
	`Í
(
bË
, 
key
);

239 
boŞ
 
found
 = 
Í
.
	`fšd_locked
(
ti
);

240 ià(
found
)

241 
	`­¶y_»move
(
Í
.
	`v®ue
(),†p.
	`node
()->
phªtom_•och_
[0], 
ti
);

242 
Í
.
	`fšish
(-1, 
ti
);

243  
found
;

244 
	}
}

246 
	g‹m¶©e
 <
ty³Çme
 
	gR
>

247 
šlše
 
	gqu”y
<
	gR
>::
	$­¶y_»move
(
R
*& 
v®ue
, 
kvtime¡amp_t
& 
node_ts
,

248 
th»adšfo
& 
ti
) {

249 ià(
logšfo
* 
log
 = 
ti
.
	`logg”
()) {

250 
log
->
	`acquœe
();

251 
qtimes_
.
•och
 = 
glob®_log_•och
;

254 
R
* 
Şd_v®ue
 = 
v®ue
;

255 
	`assign_time¡amp
(
ti
, 
Şd_v®ue
->
	`time¡amp
());

256 ià(
cœcuÏr_št
<
kvtime¡amp_t
>::
	`Ëss_equ®
(
node_ts
, 
qtimes_
.
ts
))

257 
node_ts
 = 
qtimes_
.
ts
 + 2;

258 
Şd_v®ue
->
	`d—Îoÿ‹_rcu
(
ti
);

259 
	}
}

262 
	g‹m¶©e
 <
ty³Çme
 
	gR
>

263 şas 
	cqu”y_jsÚ_sÿÂ”
 {

264 
	mpublic
:

265 
qu”y_jsÚ_sÿÂ”
(
qu”y
<
R
> &
q
, 
lcdf
::
JsÚ
& 
»que¡
)

266 : 
q_
(
q
), 
Æeá_
(
»que¡
[3].
as_i
()), 
	$»que¡_
(
»que¡
) {

267 
¡d
::
	`sw­
(
»que¡
[2].
	`v®ue
().
	`as_s
(), 
fœ¡key_
);

268 
»que¡_
.
	`»size
(2);

269 
q_
.
sÿnkeypos_
 = 0;

271 cÚ¡ 
lcdf
::
SŒšg
& 
	$fœ¡key
() const {

272  
fœ¡key_
;

273 
	}
}

274 
	g‹m¶©e
 <
ty³Çme
 
	gSS
,y³Çm
	gK
>

275 
	$vis™_Ëaf
(cÚ¡ 
SS
&, cÚ¡ 
K
&, 
th»adšfo
&) {

276 
	}
}

277 
boŞ
 
	$vis™_v®ue
(
SŒ
 
key
, 
R
* 
v®ue
, 
th»adšfo
& 
ti
) {

278 ià(
	`row_is_m¬k”
(
v®ue
))

279  
Œue
;

281 
q_
.
sÿnkeypos_
 + 
key
.
	`Ëngth
(è> q_.
sÿnkey_
.length()) {

282 
q_
.
sÿnkey_
 = 
lcdf
::
SŒšg
::
	`make_unš™Ÿlized
(q_.sÿnkey_.
	`Ëngth
() ? q_.scankey_.length() * 2 : 1024);

283 
q_
.
sÿnkeypos_
 = 0;

285 
	`memıy
(
cÚ¡_ÿ¡
<*>(
q_
.
sÿnkey_
.
	`d©a
(è+ q_.
sÿnkeypos_
),

286 
key
.
	`d©a
(), key.
	`Ëngth
());

287 
»que¡_
.
	`push_back
(
q_
.
sÿnkey_
.
	`sub¡r
(q_.
sÿnkeypos_
, 
key
.
	`Ëngth
()));

288 
q_
.
sÿnkeypos_
 +ğ
key
.
	`Ëngth
();

289 
»que¡_
.
	`push_back
(
lcdf
::
	`JsÚ
());

290 
q_
.
	`em™_f›lds1
(
v®ue
, 
»que¡_
.
	`back
(), 
ti
);

291 --
Æeá_
;

292  
Æeá_
 != 0;

293 
	}
}

294 
	g´iv©e
:

295 
qu”y
<
R
> &
q_
;

296 
	gÆeá_
;

297 
	glcdf
::
JsÚ
& 
»que¡_
;

298 
	glcdf
::
SŒšg
 
fœ¡key_
;

301 
	g‹m¶©e
 <
ty³Çme
 
	gR
>em¶©<ty³Çm
	gT
>

302 
	gqu”y
<
	gR
>::
	$run_sÿn
(
T
& 
bË
, 
JsÚ
& 
»que¡
, 
th»adšfo
& 
ti
) {

303 
	`as£¹
(
»que¡
[3].
	`as_i
() > 0);

304 
f_
.
	`ş—r
();

305 
i
 = 4; i !ğ
»que¡
.
	`size
(); ++i)

306 
f_
.
	`push_back
(
»que¡
[
i
].
	`as_i
());

307 
qu”y_jsÚ_sÿÂ”
<
R
> 
	`sÿnf
(*
this
, 
»que¡
);

308 
bË
.
	`sÿn
(
sÿnf
.
	`fœ¡key
(), 
Œue
, sÿnf, 
ti
);

309 
	}
}

311 
	g‹m¶©e
 <
ty³Çme
 
	gR
>em¶©<ty³Çm
	gT
>

312 
	gqu”y
<
	gR
>::
	$run_rsÿn
(
T
& 
bË
, 
JsÚ
& 
»que¡
, 
th»adšfo
& 
ti
) {

313 
	`as£¹
(
»que¡
[3].
	`as_i
() > 0);

314 
f_
.
	`ş—r
();

315 
i
 = 4; i !ğ
»que¡
.
	`size
(); ++i)

316 
f_
.
	`push_back
(
»que¡
[
i
].
	`as_i
());

317 
qu”y_jsÚ_sÿÂ”
<
R
> 
	`sÿnf
(*
this
, 
»que¡
);

318 
bË
.
	`rsÿn
(
sÿnf
.
	`fœ¡key
(), 
Œue
, sÿnf, 
ti
);

319 
	}
}

	@masstree-beta/kvstats.hh

16 #iâdeà
KVSTATS_HH


17 
	#KVSTATS_HH
 1

	)

18 
	~<¡dlib.h
>

20 
	skv¡©s
 {

21 
	mmš
, 
	mmax
, 
	msum
, 
	msumsq
;

22 
	mcouÁ
;

23 
kv¡©s
()

24 : 
mš
(-1), 
max
(-1), 
sum
(0), 
sumsq
(0), 
couÁ
(0) {

26 
add
(
x
) {

27 ià(!
	mcouÁ
 || 
	mx
 < 
	mmš
)

28 
	mmš
 = 
x
;

29 ià(
	mmax
 < 
	mx
)

30 
	mmax
 = 
x
;

31 
	msum
 +ğ
x
;

32 
	msumsq
 +ğ
x
 * x;

33 
	mcouÁ
 += 1;

35 (
	mkv¡©s
::*
	tun¥ecif›d_boŞ_ty³
)();

36 
İ”©Ü
 
un¥ecif›d_boŞ_ty³
() const {

37  
	mcouÁ
 ? &
	mkv¡©s
::
add
 : 0;

39 
´št_»pÜt
(cÚ¡ *
Çme
) const {

40 ià(
	mcouÁ
)

41 
´štf
("%s:‚ %ld,otal %.0f,‡verage %.0f, min %.0f, max %.0f, stddev %.0f\n",

42 
Çme
, 
couÁ
, 
sum
, sum / couÁ, 
mš
, 
max
,

43 
sq¹
((
sumsq
 - 
sum
 * sum / 
couÁ
) / (count - 1)));

45 
avg
() {

46 ià(
	mcouÁ
)

47  
	msum
 / 
	mcouÁ
;

	@masstree-beta/kvtest.hh

16 #iâdeà
KVTEST_HH


17 
	#KVTEST_HH


	)

18 
	~"jsÚ.hh
"

19 
	~"misc.hh
"

20 
	~"kv´Ùo.hh
"

21 
	~<veùÜ
>

22 
	~<f¡»am
>

24 
usšg
 
	glcdf
::
SŒ
;

25 
usšg
 
	glcdf
::
SŒšg
;

26 
usšg
 
	glcdf
::
JsÚ
;

27 
kv‹¡_fœ¡_£ed
;

31 
	g‹m¶©e
 <
ty³Çme
 
	gN
>

32 
šlše
 
	gJsÚ
& 
	$kv‹¡_£t_time
(
JsÚ
& 
»suÉ
, cÚ¡ 
lcdf
::
SŒšg
& 
ba£
, 
N
 
n
, 
d–_t
)

34 
»suÉ
.
	`£t
(
ba£
, 
n
);

35 ià(
d–_t
 > 0)

36 
»suÉ
.
	`£t
(
ba£
 + "_³r_£c", 
n
 / 
d–_t
);

37  
»suÉ
;

38 
	}
}

40 
	g‹m¶©e
 <
ty³Çme
 
	gN
>

41 
šlše
 
JsÚ
 
	$kv‹¡_£t_time
(cÚ¡ 
JsÚ
& 
»suÉ
, cÚ¡ 
lcdf
::
SŒšg
& 
ba£
, 
N
 
n
, 
d–_t
) {

42 
JsÚ
 
	`x
(
»suÉ
);

43 
	`kv‹¡_£t_time
(
x
, 
ba£
, 
n
, 
d–_t
);

44  
x
;

45 
	}
}

47 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

48 
	$kv‹¡_sync_rw1_£ed
(
C
 &
ş›Á
, 
£ed
)

50 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

51 
0
 = 
ş›Á
.
	`now
();

52 
n
;

53 
n
 = 0; !
ş›Á
.
	`timeout
(0è&&‚ <ğş›Á.
	`lim™
(); ++n) {

54 
št32_t
 
x
 = (št32_tè
ş›Á
.
¿nd
.
	`Ãxt
();

55 
ş›Á
.
	`put_sync
(
x
, x + 1);

57 
ş›Á
.
	`wa™_®l
();

58 
1
 = 
ş›Á
.
	`now
();

60 
ş›Á
.
	`puts_dÚe
();

61 
ş›Á
.
	`nÙiû
("now getting\n");

62 
št32_t
 *
a
 = (št32_ˆ*è
	`m®loc
((št32_tè* 
n
);

63 
	`as£¹
(
a
);

64 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

65 
i
 = 0; i < 
n
; ++i)

66 
a
[
i
] = (
št32_t
è
ş›Á
.
¿nd
.
	`Ãxt
();

67 
i
 = 0; i < 
n
; ++i)

68 
¡d
::
	`sw­
(
a
[
i
],‡[
ş›Á
.
¿nd
.
	`Ãxt
(è% 
n
]);

70 
tg0
 = 
ş›Á
.
	`now
();

71 
g
;

72 
g
 = 0; g < 
n
 && !
ş›Á
.
	`timeout
(1); ++g)

73 
ş›Á
.
	`g‘_check_sync
(
a
[
g
],‡[g] + 1);

74 
ş›Á
.
	`wa™_®l
();

75 
tg1
 = 
ş›Á
.
	`now
();

77 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

78 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
n
, 
1
 - 
0
);

79 
	`kv‹¡_£t_time
(
»suÉ
, "g‘s", 
g
, 
tg1
 - 
tg0
);

80 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
 + 
g
, (
1
 - 
0
è+ (
tg1
 - 
tg0
));

81 
ş›Á
.
	`»pÜt
(
»suÉ
);

82 
	`ä“
(
a
);

83 
	}
}

85 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

86 
	$kv‹¡_sync_rw1
(
C
 &
ş›Á
)

88 
	`kv‹¡_sync_rw1_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48);

89 
	}
}

91 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

92 
	$kv‹¡_rw1puts_£ed
(
C
& 
ş›Á
, 
£ed
) {

93 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

94 
0
 = 
ş›Á
.
	`now
();

95 
n
;

96 
n
 = 0; !
ş›Á
.
	`timeout
(0è&&‚ <ğş›Á.
	`lim™
(); ++n) {

97 
št32_t
 
x
 = (št32_tè
ş›Á
.
¿nd
.
	`Ãxt
();

98 
ş›Á
.
	`put
(
x
, x + 1);

100 
ş›Á
.
	`wa™_®l
();

101 
1
 = 
ş›Á
.
	`now
();

102 
ş›Á
.
	`puts_dÚe
();

104 
ş›Á
.
	`»pÜt
(
	`kv‹¡_£t_time
(
	`JsÚ
(), "puts", 
n
, 
1
 - 
0
));

105  
n
;

106 
	}
}

111 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

112 
	$kv‹¡_rw1_£ed
(
C
 &
ş›Á
, 
£ed
)

114 
n
 = 
	`kv‹¡_rw1puts_£ed
(
ş›Á
, 
£ed
);

116 
ş›Á
.
	`nÙiû
("now getting\n");

117 
št32_t
 *
a
 = (št32_ˆ*è
	`m®loc
((št32_tè* 
n
);

118 
	`as£¹
(
a
);

119 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

120 
i
 = 0; i < 
n
; ++i)

121 
a
[
i
] = (
št32_t
è
ş›Á
.
¿nd
.
	`Ãxt
();

122 
i
 = 0; i < 
n
; ++i)

123 
¡d
::
	`sw­
(
a
[
i
],‡[
ş›Á
.
¿nd
.
	`Ãxt
(è% 
n
]);

125 
tg0
 = 
ş›Á
.
	`now
();

126 
g
;

128 
	#BATCH
 8

	)

129 
g
 = 0; g+
BATCH
 < 
n
 && !
ş›Á
.
	`timeout
(1); g += BATCH){

130 
key
[
BATCH
], 
ex³ùed
[BATCH];

131 
i
 = 0; i < 
BATCH
; i++){

132 
key
[
i
] = 
a
[
g
+i];

133 
ex³ùed
[
i
] = 
a
[
g
+i] + 1;

135 
ş›Á
.
	`mªy_g‘_check
(
BATCH
, 
key
, 
ex³ùed
);

138 
g
 = 0; g < 
n
 && !
ş›Á
.
	`timeout
(1); ++g)

139 
ş›Á
.
	`g‘_check
(
a
[
g
],‡[g] + 1);

141 
ş›Á
.
	`wa™_®l
();

142 
tg1
 = 
ş›Á
.
	`now
();

144 
JsÚ
 
»suÉ
 = 
ş›Á
.
	`»pÜt
(
	`JsÚ
());

145 
	`kv‹¡_£t_time
(
»suÉ
, "g‘s", 
g
, 
tg1
 - 
tg0
);

146 
d–_puts
 = 
n
 / 
»suÉ
["puts_³r_£c"].
	`as_d
();

147 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
 + 
g
, 
d–_puts
 + (
tg1
 - 
tg0
));

148 
ş›Á
.
	`»pÜt
(
»suÉ
);

149 
	`ä“
(
a
);

150 
	}
}

152 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

153 
	$kv‹¡_rw1puts
(
C
 &
ş›Á
)

155 
	`kv‹¡_rw1puts_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48);

156 
	}
}

158 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

159 
	$kv‹¡_rw1
(
C
 &
ş›Á
)

161 
	`kv‹¡_rw1_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48);

162 
	}
}

167 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

168 
	$kv‹¡_rw1lÚg_£ed
(
C
 &
ş›Á
, 
£ed
)

170 cÚ¡ * cÚ¡ 
fÜm©s
[] = {

173 
buf
[64];

175 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

176 
0
 = 
ş›Á
.
	`now
();

177 
n
;

178 
n
 = 0; !
ş›Á
.
	`timeout
(0è&&‚ <ğş›Á.
	`lim™
(); ++n) {

179 
fmt
 = 
ş›Á
.
¿nd
.
	`Ãxt
();

180 
št32_t
 
x
 = (št32_tè
ş›Á
.
¿nd
.
	`Ãxt
();

181 
ş›Á
.
	`put
(
SŒ
::
	`¢´štf
(
buf
, (buf), 
fÜm©s
[
fmt
 % 4], 
x
), x + 1);

183 
ş›Á
.
	`wa™_®l
();

184 
1
 = 
ş›Á
.
	`now
();

186 
ş›Á
.
	`puts_dÚe
();

187 
ş›Á
.
	`nÙiû
("now getting\n");

188 
št32_t
 *
a
 = (št32_ˆ*è
	`m®loc
((št32_tè* 
n
 * 2);

189 
	`as£¹
(
a
);

190 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

191 
i
 = 0; i < 
n
 * 2; ++i)

192 
a
[
i
] = (
št32_t
è
ş›Á
.
¿nd
.
	`Ãxt
();

193 
i
 = 0; i < 
n
; ++i) {

194 
x
 = 
ş›Á
.
¿nd
.
	`Ãxt
(è% 
n
;

195 
¡d
::
	`sw­
(
a
[2 * 
i
],‡[2 * 
x
]);

196 
¡d
::
	`sw­
(
a
[2 * 
i
 + 1],‡[2 * 
x
 + 1]);

199 
tg0
 = 
ş›Á
.
	`now
();

200 
g
;

201 
g
 = 0; g < 
n
 && !
ş›Á
.
	`timeout
(1); ++g) {

202 
fmt
 = 
a
[2 * 
g
];

203 
št32_t
 
x
 = (št32_tè
a
[2 * 
g
 + 1];

204 
ş›Á
.
	`g‘_check
(
SŒ
::
	`¢´štf
(
buf
, (buf), 
fÜm©s
[
fmt
 % 4], 
x
), x + 1);

206 
ş›Á
.
	`wa™_®l
();

207 
tg1
 = 
ş›Á
.
	`now
();

209 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

210 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
n
, 
1
 - 
0
);

211 
	`kv‹¡_£t_time
(
»suÉ
, "g‘s", 
g
, 
tg1
 - 
tg0
);

212 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
 + 
g
, (
1
 - 
0
è+ (
tg1
 - 
tg0
));

213 
ş›Á
.
	`»pÜt
(
»suÉ
);

214 
	`ä“
(
a
);

215 
	}
}

217 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

218 
	$kv‹¡_rw1lÚg
(
C
 &
ş›Á
)

220 
	`kv‹¡_rw1lÚg_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48);

221 
	}
}

224 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

225 
	$kv‹¡_rw2_£ed
(
C
 &
ş›Á
, 
£ed
, 
g‘äac
)

227 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

228 cÚ¡ 
c
 = 2654435761U;

229 cÚ¡ 
off£t
 = 
ş›Á
.
¿nd
.
	`Ãxt
();

231 
t0
 = 
ş›Á
.
	`now
();

232 
ušt64_t
 
puts
 = 0, 
g‘s
 = 0;

233 
g‘äac65536
 = (è(
g‘äac
 * 65536 + 0.5);

234 !
ş›Á
.
	`timeout
(0è&& (
puts
 + 
g‘s
è<ğş›Á.
	`lim™
()) {

235 ià(
puts
 =ğ0 || (
ş›Á
.
¿nd
.
	`Ãxt
(è% 65536è>ğ
g‘äac65536
) {

237 
x
 = (
off£t
 + 
puts
è* 
c
;

238 
ş›Á
.
	`put
(
x
, x + 1);

239 ++
puts
;

242 
x
 = (
off£t
 + (
ş›Á
.
¿nd
.
	`Ãxt
(è% 
puts
)è* 
c
;

243 
ş›Á
.
	`g‘_check
(
x
, x + 1);

244 ++
g‘s
;

247 
ş›Á
.
	`wa™_®l
();

248 
t1
 = 
ş›Á
.
	`now
();

250 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("puts", 
puts
).£t("g‘s", 
g‘s
);

251 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
puts
 + 
g‘s
, 
t1
 - 
t0
);

252 
ş›Á
.
	`»pÜt
(
»suÉ
);

253 
	}
}

255 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

256 
	$kv‹¡_rw2
(
C
 &
ş›Á
)

258 
	`kv‹¡_rw2_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48, 0.5);

259 
	}
}

261 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

262 
	$kv‹¡_rw2g90
(
C
 &
ş›Á
)

264 
	`kv‹¡_rw2_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48, 0.9);

265 
	}
}

267 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

268 
	$kv‹¡_rw2g98
(
C
 &
ş›Á
)

270 
	`kv‹¡_rw2_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48, 0.98);

271 
	}
}

274 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

275 
	$kv‹¡_rw2fixed_£ed
(
C
 &
ş›Á
, 
£ed
, 
g‘äac
)

277 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

278 cÚ¡ 
c
 = 2654435761U;

279 cÚ¡ 
off£t
 = 
ş›Á
.
¿nd
.
	`Ãxt
();

281 
t0
 = 
ş›Á
.
	`now
();

282 
ušt64_t
 
puts
 = 0, 
g‘s
 = 0;

283 
g‘äac65536
 = (è(
g‘äac
 * 65536 + 0.5);

284 !
ş›Á
.
	`timeout
(0è&& (
puts
 + 
g‘s
è<ğş›Á.
	`lim™
()) {

285 ià(
puts
 =ğ0 || (
ş›Á
.
¿nd
.
	`Ãxt
(è% 65536è>ğ
g‘äac65536
) {

287 
x
 = (
off£t
 + 
puts
è* 
c
;

288 
x
 %= 100000000;

289 
ş›Á
.
	`put
(
x
, x + 1);

290 ++
puts
;

293 
x
 = (
off£t
 + (
ş›Á
.
¿nd
.
	`Ãxt
(è% 
puts
)è* 
c
;

294 
x
 %= 100000000;

295 
ş›Á
.
	`g‘_check
(
x
, x + 1);

296 ++
g‘s
;

299 
ş›Á
.
	`wa™_®l
();

300 
t1
 = 
ş›Á
.
	`now
();

302 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("puts", 
puts
).£t("g‘s", 
g‘s
);

303 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
puts
 + 
g‘s
, 
t1
 - 
t0
);

304 
ş›Á
.
	`»pÜt
(
»suÉ
);

305 
	}
}

307 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

308 
	$kv‹¡_rw2fixed
(
C
 &
ş›Á
)

310 
	`kv‹¡_rw2fixed_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48, 0.5);

311 
	}
}

313 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

314 
	$kv‹¡_rw2fixedg90
(
C
 &
ş›Á
)

316 
	`kv‹¡_rw2fixed_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48, 0.9);

317 
	}
}

319 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

320 
	$kv‹¡_rw2fixedg98
(
C
 &
ş›Á
)

322 
	`kv‹¡_rw2fixed_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48, 0.98);

323 
	}
}

328 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

329 
	$kv‹¡_rw3
(
C
 &
ş›Á
)

331 
t0
 = 
ş›Á
.
	`now
();

332 
ušt64_t
 
n
;

333 
n
 = 0; !
ş›Á
.
	`timeout
(0è&&‚ <ğş›Á.
	`lim™
(); ++n)

334 
ş›Á
.
	`put_key8
(
n
,‚ + 1);

335 
ş›Á
.
	`wa™_®l
();

337 
ş›Á
.
	`puts_dÚe
();

338 
ş›Á
.
	`nÙiû
("now getting\n");

340 
t1
 = 
ş›Á
.
	`now
();

341 
i
 = 0; i < 
n
; ++i)

342 
ş›Á
.
	`g‘_check_key8
(
i
, i + 1);

343 
ş›Á
.
	`wa™_®l
();

345 
t2
 = 
ş›Á
.
	`now
();

347 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

348 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
n
, 
t1
 - 
t0
);

349 
	`kv‹¡_£t_time
(
»suÉ
, "g‘s", 
n
, 
t2
 - 
t1
);

350 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
 +‚, 
t2
 - 
t0
);

351 
ş›Á
.
	`»pÜt
(
»suÉ
);

352 
	}
}

357 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

358 
	$kv‹¡_rw4
(
C
 &
ş›Á
)

360 cÚ¡ 
tİ
 = 2147483647;

362 
t0
 = 
ş›Á
.
	`now
();

363 
n
;

364 
n
 = 0; !
ş›Á
.
	`timeout
(0è&&‚ <ğş›Á.
	`lim™
(); ++n)

365 
ş›Á
.
	`put_key8
(
tİ
 - 
n
,‚ + 1);

366 
ş›Á
.
	`wa™_®l
();

368 
ş›Á
.
	`puts_dÚe
();

369 
ş›Á
.
	`nÙiû
("now getting\n");

371 
t1
 = 
ş›Á
.
	`now
();

372 
i
 = 0; i < 
n
; ++i)

373 
ş›Á
.
	`g‘_check_key8
(
tİ
 - 
i
, i + 1);

374 
ş›Á
.
	`wa™_®l
();

376 
t2
 = 
ş›Á
.
	`now
();

378 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

379 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
n
, 
t1
 - 
t0
);

380 
	`kv‹¡_£t_time
(
»suÉ
, "g‘s", 
n
, 
t2
 - 
t1
);

381 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
 +‚, 
t2
 - 
t0
);

382 
ş›Á
.
	`»pÜt
(
»suÉ
);

383 
	}
}

388 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

389 
	$kv‹¡_rw4fixed
(
C
 &
ş›Á
)

391 cÚ¡ 
tİ
 = 99999999;

393 
t0
 = 
ş›Á
.
	`now
();

394 
n
;

395 
n
 = 0; !
ş›Á
.
	`timeout
(0è&&‚ <ğş›Á.
	`lim™
(); ++n)

396 
ş›Á
.
	`put_key8
(
tİ
 - 
n
,‚ + 1);

397 
ş›Á
.
	`wa™_®l
();

399 
ş›Á
.
	`puts_dÚe
();

400 
ş›Á
.
	`nÙiû
("now getting\n");

402 
t1
 = 
ş›Á
.
	`now
();

403 
i
 = 0; i < 
n
; ++i)

404 
ş›Á
.
	`g‘_check_key8
(
tİ
 - 
i
, i + 1);

405 
ş›Á
.
	`wa™_®l
();

407 
t2
 = 
ş›Á
.
	`now
();

409 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

410 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
n
, 
t1
 - 
t0
);

411 
	`kv‹¡_£t_time
(
»suÉ
, "g‘s", 
n
, 
t2
 - 
t1
);

412 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
 +‚, 
t2
 - 
t0
);

413 
ş›Á
.
	`»pÜt
(
»suÉ
);

414 
	}
}

418 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

419 
	$kv‹¡_§me_£ed
(
C
 &
ş›Á
, 
£ed
)

421 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

423 
t0
 = 
ş›Á
.
	`now
();

424 
n
;

425 
n
 = 0; !
ş›Á
.
	`timeout
(0è&&‚ <ğş›Á.
	`lim™
(); ++n) {

426 
x
 = 
ş›Á
.
¿nd
.
	`Ãxt
() % 10;

427 
ş›Á
.
	`put
(
x
, x + 1);

429 
ş›Á
.
	`wa™_®l
();

430 
t1
 = 
ş›Á
.
	`now
();

432 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

433 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
n
, 
t1
 - 
t0
);

434 
ş›Á
.
	`»pÜt
(
»suÉ
);

435 
	}
}

437 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

438 
	$kv‹¡_§me
(
C
 &
ş›Á
)

440 
	`kv‹¡_§me_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48);

441 
	}
}

444 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

445 
	$kv‹¡_rwsm®l_£ed
(
C
 &
ş›Á
, 
nkeys
, 
£ed
)

447 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

449 
t0
 = 
ş›Á
.
	`now
();

450 
n
;

451 
n
 = 0; !
ş›Á
.
	`timeout
(0è&&‚ <ğş›Á.
	`lim™
(); ++n) {

452 
x
 = 
ş›Á
.
¿nd
.
	`Ãxt
(è% (8 * 
nkeys
);

453 ià(
x
 & 7)

454 
ş›Á
.
	`g‘
(
x
 >> 3);

456 
ş›Á
.
	`put
(
x
 >> 3, 
n
);

458 
ş›Á
.
	`wa™_®l
();

459 
t1
 = 
ş›Á
.
	`now
();

461 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

462 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
, 
t1
 - 
t0
);

463 
ş›Á
.
	`»pÜt
(
»suÉ
);

464 
	}
}

466 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

467 
	$kv‹¡_rwsm®l24
(
C
 &
ş›Á
)

469 
	`kv‹¡_rwsm®l_£ed
(
ş›Á
, 24, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48);

470 
	}
}

474 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

475 
	$kv‹¡_rw£p_£ed
(
C
 &
ş›Á
, 
nkeys
, 
ş›Áid
, 
£ed
)

477 
n
 = 
ş›Áid
 * (32 + 
nkeys
);‚ < (clientid + 1) * (32 +‚keys); ++n)

478 
ş›Á
.
	`put
(1000000 + 
n
,‚);

480 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

482 
t0
 = 
ş›Á
.
	`now
();

483 
n
;

484 
n
 = 0; !
ş›Á
.
	`timeout
(0è&&‚ <ğş›Á.
	`lim™
(); ++n) {

485 
x
 = 
ş›Á
.
¿nd
.
	`Ãxt
(è% (8 * 
nkeys
);

486 ià(
x
 & 7)

487 
ş›Á
.
	`g‘
(1000000 + 
ş›Áid
 * (32 + 
nkeys
è+ (
x
 >> 3));

489 
ş›Á
.
	`put
(1000000 + 
ş›Áid
 * (32 + 
nkeys
è+ (
x
 >> 3), 
n
);

491 
ş›Á
.
	`wa™_®l
();

492 
t1
 = 
ş›Á
.
	`now
();

494 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

495 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
, 
t1
 - 
t0
);

496 
ş›Á
.
	`»pÜt
(
»suÉ
);

497 
	}
}

499 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

500 
	$kv‹¡_rw£p24
(
C
 &
ş›Á
)

502 
	`kv‹¡_rw£p_£ed
(
ş›Á
, 24, cl›Á.
	`id
(), 
kv‹¡_fœ¡_£ed
 + client.id() % 48);

503 
	}
}

506 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

507 
	$kv‹¡_rw1fixed_£ed
(
C
 &
ş›Á
, 
£ed
)

509 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

510 
0
 = 
ş›Á
.
	`now
();

511 
n
;

512 
n
 = 0; !
ş›Á
.
	`timeout
(0è&&‚ <ğş›Á.
	`lim™
(); ++n) {

513 
št32_t
 
x
 = (št32_tè
ş›Á
.
¿nd
.
	`Ãxt
();

514 
x
 %= 100000000;

515 
ş›Á
.
	`put
(
x
, x + 1);

517 
ş›Á
.
	`wa™_®l
();

518 
1
 = 
ş›Á
.
	`now
();

520 
ş›Á
.
	`puts_dÚe
();

521 
ş›Á
.
	`nÙiû
("now getting\n");

522 
št32_t
 *
a
 = (št32_ˆ*è
	`m®loc
((št32_tè* 
n
);

523 
	`as£¹
(
a
);

524 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

525 
i
 = 0; i < 
n
; ++i) {

526 
a
[
i
] = (
št32_t
è
ş›Á
.
¿nd
.
	`Ãxt
();

527 
a
[
i
] %= 100000000;

529 
i
 = 0; i < 
n
; ++i)

530 
¡d
::
	`sw­
(
a
[
i
],‡[
ş›Á
.
¿nd
.
	`Ãxt
(è% 
n
]);

532 
tg0
 = 
ş›Á
.
	`now
();

533 
g
;

535 
	#BATCH
 8

	)

536 
g
 = 0; g+
BATCH
 < 
n
 && !
ş›Á
.
	`timeout
(1); g += BATCH){

537 
key
[
BATCH
], 
ex³ùed
[BATCH];

538 
i
 = 0; i < 
BATCH
; i++){

539 
key
[
i
] = 
a
[
g
+i];

540 
ex³ùed
[
i
] = 
a
[
g
+i] + 1;

542 
ş›Á
.
	`mªy_g‘_check
(
BATCH
, 
key
, 
ex³ùed
);

545 
g
 = 0; g < 
n
 && !
ş›Á
.
	`timeout
(1); ++g)

546 
ş›Á
.
	`g‘_check
(
a
[
g
],‡[g] + 1);

548 
ş›Á
.
	`wa™_®l
();

549 
tg1
 = 
ş›Á
.
	`now
();

551 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

552 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
n
, 
1
 - 
0
);

553 
	`kv‹¡_£t_time
(
»suÉ
, "g‘s", 
g
, 
tg1
 - 
tg0
);

554 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
 + 
g
, (
1
 - 
0
è+ (
tg1
 - 
tg0
));

555 
ş›Á
.
	`»pÜt
(
»suÉ
);

556 
	`ä“
(
a
);

557 
	}
}

559 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

560 
	$kv‹¡_rw1fixed
(
C
 &
ş›Á
)

562 
	`kv‹¡_rw1fixed_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48);

563 
	}
}

566 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

567 
	$kv‹¡_rw16_£ed
(
C
 &
ş›Á
, 
£ed
)

569 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

570 
0
 = 
ş›Á
.
	`now
();

571 
n
;

572 
key
[256];

573 
v®
[256];

574 
n
 = 0; !
ş›Á
.
	`timeout
(0); ++n) {

575 
št32_t
 
x
 = (št32_tè
ş›Á
.
¿nd
.
	`Ãxt
();

576 
	`¥rštf
(
key
, "%016d", 
x
);

577 
	`¥rštf
(
v®
, "%016d", 
x
 + 1);

578 
ş›Á
.
	`put
(
key
, 
v®
);

580 
ş›Á
.
	`wa™_®l
();

581 
1
 = 
ş›Á
.
	`now
();

583 
ş›Á
.
	`puts_dÚe
();

584 
ş›Á
.
	`nÙiû
("now getting\n");

585 
št32_t
 *
a
 = (št32_ˆ*è
	`m®loc
((št32_tè* 
n
);

586 
	`as£¹
(
a
);

587 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

588 
i
 = 0; i < 
n
; ++i)

589 
a
[
i
] = (
št32_t
è
ş›Á
.
¿nd
.
	`Ãxt
();

590 
i
 = 0; i < 
n
; ++i)

591 
¡d
::
	`sw­
(
a
[
i
],‡[
ş›Á
.
¿nd
.
	`Ãxt
(è% 
n
]);

593 
tg0
 = 
ş›Á
.
	`now
();

594 
g
;

595 
g
 = 0; g < 
n
 && !
ş›Á
.
	`timeout
(1); ++g) {

596 
	`¥rštf
(
key
, "%016d", 
a
[
g
]);

597 
	`¥rštf
(
v®
, "%016d", 
a
[
g
] + 1);

598 
ş›Á
.
	`g‘_check
(
key
, 
v®
);

600 
ş›Á
.
	`wa™_®l
();

601 
tg1
 = 
ş›Á
.
	`now
();

603 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

604 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
n
, 
1
 - 
0
);

605 
	`kv‹¡_£t_time
(
»suÉ
, "g‘s", 
g
, 
tg1
 - 
tg0
);

606 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
 + 
g
, (
1
 - 
0
è+ (
tg1
 - 
tg0
));

607 
ş›Á
.
	`»pÜt
(
»suÉ
);

608 
	`ä“
(
a
);

609 
	}
}

611 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

612 
	$kv‹¡_rw16
(
C
 &
ş›Á
)

614 
	`kv‹¡_rw16_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48);

615 
	}
}

619 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

620 
	$kv‹¡_wd1
(
š™Ÿl_pos
, 
šü
, 
C
 &
ş›Á
)

622 
šü
 = 
¡d
::
	`max
(šü, 
ş›Á
.
	`Áh»ads
() / 2);

623 
pos
 = 
š™Ÿl_pos
 + ((
ş›Á
.
	`id
(è/ 2è% 
šü
);

624 
n
 = 0;

625 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

627 
t0
 = 
ş›Á
.
	`now
();

628 ià(
ş›Á
.
	`id
() % 2) {

629 !
ş›Á
.
	`g‘_sync
(
pos
 + 16 * 
šü
))

631 !
ş›Á
.
	`timeout
(0è&& 
n
 <ğş›Á.
	`lim™
()) {

632 ++
n
;

633 ià(
ş›Á
.
	`»move_sync
(
pos
))

634 
pos
 +ğ
šü
;

635 ià((
n
 % (1 << 6)) == 0)

636 
ş›Á
.
	`rcu_qu›sû
();

638 
»suÉ
.
	`£t
("»mov•os", 
pos
);

640 !
ş›Á
.
	`timeout
(0è&& 
n
 <ğş›Á.
	`lim™
()) {

641 ++
n
;

642 
ş›Á
.
	`put
(
pos
,…os + 1);

643 
pos
 +ğ
šü
;

644 ià((
n
 % (1 << 6)) == 0)

645 
ş›Á
.
	`rcu_qu›sû
();

647 
»suÉ
.
	`£t
("puos", 
pos
);

649 
ş›Á
.
	`wa™_®l
();

650 
t1
 = 
ş›Á
.
	`now
();

652 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
, 
t1
 - 
t0
);

653 
ş›Á
.
	`»pÜt
(
»suÉ
);

654 
	}
}

656 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

657 
	$kv‹¡_wd1_check
(
š™Ÿl_pos
, 
šü
, 
C
 &
ş›Á
)

659 
šü
 = 
¡d
::
	`max
(šü, 
ş›Á
.
	`Áh»ads
() / 2);

660 
pos
 = 
š™Ÿl_pos
 + ((
ş›Á
.
	`id
(è/ 2è% 
šü
);

661 
n
 = 0;

662 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

664 
t0
 = 
ş›Á
.
	`now
();

665 ià(
ş›Á
.
	`id
() % 2 == 0) {

666 
max_»move
 = -1, 
mš_po¡_»move
 = -1, 
max_po¡_»move
 = -1;

667 
bugs
 = 0;

668 
boŞ
 
found_puos
 = 
çl£
;

669 
cÚ¡ex´
 
nb©ch
 = 20;

670 
SŒ
 
gÙ‹n
[
nb©ch
];

671 
gÙ‹nbuf
[
nb©ch
 * 16];

672 
i
 = 0; i < 
nb©ch
; ++i)

673 
gÙ‹n
[
i
].
s
 = &
gÙ‹nbuf
[i * 16];

675 !
ş›Á
.
	`timeout
(0)

676 && (!
found_puos
 || 
pos
 < 
max_po¡_»move
 + 100000)) {

677 
i
 = 0; i < 
nb©ch
; ++i) {

678 
gÙ‹n
[
i
].
Ën
 = 16;

679 
ş›Á
.
	`g‘
(
pos
 + 
i
 * 
šü
, &
gÙ‹n
[i]);

681 
ş›Á
.
	`wa™_®l
();

682 
i
 = 0; i < 
nb©ch
; ++i) {

683 ià(
gÙ‹n
[
i
].
Ën
) {

684 ià(
mš_po¡_»move
 == (-1))

685 
mš_po¡_»move
 = 
max_po¡_»move
 = 
pos
;

686 ià(!
found_puos
)

687 
max_po¡_»move
 = 
pos
;

688 ià(++
bugs
 == 1)

689 
	`årštf
(
¡d”r
, "%u:…»£Á uÃx³ùedly\n", 
pos
);

691 ià(
mš_po¡_»move
 == (-1))

692 
max_»move
 = 
pos
;

694 
found_puos
 = 
Œue
;

696 
pos
 +ğ
šü
;

700 
»suÉ
.
	`£t
("»mov•os", 
max_»move
 + 
šü
);

701 
»suÉ
.
	`£t
("puos", 
max_po¡_»move
 + 
šü
);

702 ià(
bugs
)

703 
»suÉ
.
	`£t
("buggykeys", 
bugs
);

705 
ş›Á
.
	`wa™_®l
();

706 
t1
 = 
ş›Á
.
	`now
();

708 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
, 
t1
 - 
t0
);

709 
ş›Á
.
	`»pÜt
(
»suÉ
);

710 
	}
}

712 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

713 
	$kv‹¡_wd2
(
C
 &
ş›Á
)

715 
sbuf
[32], 
kbuf
[32], 
Ãxt_kbuf
[32];

716 cÚ¡ 
£p
 = 26;

717 cÚ¡ 
p_»move
 = 1000, 
p_put2
 = 10000, 
p_»move2
 = 20000;

718 
x
 = 0;

719 
quick_i¡r
 
	`x¡r
(0);

721 
ş›Á
.
	`put
(
	`SŒ
("n"), cl›Á.
	`Áh»ads
());

722 
	`®ways_as£¹
(
ş›Á
.
	`Áh»ads
() > 1);

725 
	`¢´štf
(
sbuf
, (sbuf), "s%03d", 
ş›Á
.
	`id
());

726 
i
 = 0; i < 
£p
; ++i) {

727 
sbuf
[4] = 'A' + 
i
;

728 
ş›Á
.
	`put
(
	`SŒ
(
sbuf
, 5), Str());

730 
ş›Á
.
	`put
(
	`SŒ
(
sbuf
, 4), 
x¡r
.
	`¡ršg
());

733 
	`¢´štf
(
kbuf
, (kbuf), "k%03d", 
ş›Á
.
	`id
());

734 
i
 = 0; i < 
£p
; ++i) {

735 
kbuf
[4] = 'A' + 
i
;

736 
ş›Á
.
	`put
(
	`SŒ
(
kbuf
, 5), Str());

738 
ş›Á
.
	`put
(
	`SŒ
(
kbuf
, 4), Str());

740 
	`¢´štf
(
Ãxt_kbuf
, Òext_kbuf), "k%03d", (
ş›Á
.
	`id
(è+ 1è% cl›Á.
	`Áh»ads
());

743 
t0
 = 
ş›Á
.
	`now
();

744 
put_¡©us
 = 0;

745 
Äounds
 = 0;

746 !
ş›Á
.
	`timeout
(0)) {

747 ++
Äounds
;

748 
ş›Á
.
	`put
(
	`SŒ
(
kbuf
, 4), 
x¡r
.
	`¡ršg
(), &
put_¡©us
);

749 ià((
ş›Á
.
¿nd
.
	`Ãxt
(è% 65536è< 
p_»move
)

750 
ş›Á
.
	`»move
(
	`SŒ
(
Ãxt_kbuf
, 4));

752 
¿nd
 = 
ş›Á
.¿nd.
	`Ãxt
() % 65536;

753 ià(
¿nd
 < 
p_put2
) {

754 
i
 = 
£p
 - 1; i >= 0; --i) {

755 
Ãxt_kbuf
[4] = 'A' + 
i
;

756 
ş›Á
.
	`put
(
	`SŒ
(
Ãxt_kbuf
, 5), Str());

758 } ià(
¿nd
 < 
p_»move2
) {

759 
i
 = 
£p
 - 1; i >= 0; --i) {

760 
Ãxt_kbuf
[4] = 'A' + 
i
;

761 
ş›Á
.
	`»move
(
	`SŒ
(
Ãxt_kbuf
, 5));

767 
ş›Á
.
	`wa™_®l
();

769 ià(
put_¡©us
 =ğ
In£¹ed
) {

770 ++
x
;

771 
x¡r
.
	`£t
(
x
);

772 
ş›Á
.
	`put
(
	`SŒ
(
sbuf
, 4), 
x¡r
.
	`¡ršg
());

775 
t1
 = 
ş›Á
.
	`now
();

777 
JsÚ
 
»suÉ
;

778 
	`kv‹¡_£t_time
(
»suÉ
, "rounds", 
Äounds
, 
t1
 - 
t0
);

779 
ş›Á
.
	`»pÜt
(
»suÉ
);

780 
	}
}

782 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

783 
	$kv‹¡_wd2_check
(
C
 &
ş›Á
)

785 ià(
ş›Á
.
	`id
() != 0)

788 
n
;

789 
ş›Á
.
	`g‘
(
	`SŒ
("n"), &
n
);

790 
ş›Á
.
	`wa™_®l
();

791 
	`®ways_as£¹
(
n
 > 1);

792 
JsÚ
 
»suÉ
;

794 
buf
[32];

795 
i
 = 0; i < 
n
; ++i) {

796 
s
, 
k
;

797 
	`¢´štf
(
buf
, (buf), "k%03d", 
i
);

798 
ş›Á
.
	`g‘
(
	`SŒ
(
buf
, 4), &
k
);

799 
	`¢´štf
(
buf
, (buf), "s%03d", 
i
);

800 
ş›Á
.
	`g‘
(
	`SŒ
(
buf
, 4), &
s
);

801 
ş›Á
.
	`wa™_®l
();

802 ià(!(
s
 >ğ0 && ( =ğ
k
 || s == k + 1 || k == -1)))

803 
	`årštf
(
¡d”r
, "problem: s%03d=%d vs. k%03d=%d\n",

804 
i
, 
s
, i, 
k
);

805 
»suÉ
.
	`£t
("th»ad" + 
	`SŒšg
(
i
), 
	`JsÚ
().
	`push_back
(
s
).push_back(
k
));

808 
ş›Á
.
	`»pÜt
(
»suÉ
);

809 
	}
}

814 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

815 
	$kv‹¡_Œi1
(
š™Ÿl_pos
, 
šü
, 
C
 &
ş›Á
)

817 
šü
 = 
¡d
::
	`max
(šü, 
ş›Á
.
	`Áh»ads
());

818 
n
 = 0;

819 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

821 
t0
 = 
ş›Á
.
	`now
();

822 
x
 = 0; x < 
ş›Á
.
	`lim™
(); ++x)

823 
y
 = 0, 
z
 = 
x
; y <ğx; ++y, --z, ++
n
)

824 
ş›Á
.
	`put
(
š™Ÿl_pos
 + 
y
 * 
šü
, 
z
);

825 
ş›Á
.
	`wa™_®l
();

826 
t1
 = 
ş›Á
.
	`now
();

828 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
n
, 
t1
 - 
t0
);

829 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
, 
t1
 - 
t0
);

830 
ş›Á
.
	`»pÜt
(
»suÉ
);

831 
	}
}

833 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

834 
	$kv‹¡_Œi1_check
(
š™Ÿl_pos
, 
šü
, 
C
 &
ş›Á
)

836 
šü
 = 
¡d
::
	`max
(šü, 
ş›Á
.
	`Áh»ads
());

837 
n
 = 0;

838 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

840 
t0
 = 
ş›Á
.
	`now
();

841 
x
 = 0; x < 
ş›Á
.
	`lim™
(); ++x, ++
n
)

842 
ş›Á
.
	`g‘_check
(
š™Ÿl_pos
 + 
x
 * 
šü
, cl›Á.
	`lim™
() - 1 - x);

843 
ş›Á
.
	`wa™_®l
();

844 
t1
 = 
ş›Á
.
	`now
();

846 
	`kv‹¡_£t_time
(
»suÉ
, "g‘s", 
n
, 
t1
 - 
t0
);

847 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
, 
t1
 - 
t0
);

848 
ş›Á
.
	`»pÜt
(
»suÉ
);

849 
	}
}

852 
	#PALMN
 128000000

	)

853 ’um { 
	mP®mB©ch
 = 8192 / 24 };

854 
	#PALM_DEBUG
 1

856 
‹m¶©e
 <
ty³Çme
 
C
>

	)

857 
	$kv‹¡_·lma
(
C
 &
ş›Á
)

859 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

860 
t0
 = 
ş›Á
.
	`now
();

861 
i
 = 0; i < 
PALMN
; i++) {

862 
ušt64_t
 
v
 = 
i
 + 1;

863 
ş›Á
.
	`put
(
i
, 
v
);

865 
ş›Á
.
	`wa™_®l
();

866 
t1
 = 
ş›Á
.
	`now
();

867 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
PALMN
, 
t1
 - 
t0
);

868 
ş›Á
.
	`»pÜt
(
»suÉ
);

869 
	}
}

871 
šlše
 
	$com·»_št
(cÚ¡ *
a
, cÚ¡ *
b
)

873  
	`com·»
(*(
ušt64_t
 *)
a
, *(ušt64_ˆ*)
b
);

874 
	}
}

876 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

877 
	$kv‹¡_·lmb_£ed
(
C
 &
ş›Á
, 
£ed
)

879 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

880 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

881 
t0
 = 
ş›Á
.
	`now
();

882 
n
;

883 
nqu”y
 = 0;

884 
ušt64_t
 
a
[
P®mB©ch
];

885 
n
 = 0; !
ş›Á
.
	`timeout
(0); ++n) {

886 
ušt64_t
 
x
 = (ušt64_tè
ş›Á
.
¿nd
.
	`Ãxt
();

887 
x
 %ğ(
PALMN
 / 10);

888 
a
[
nqu”y
++] = 
x
;

889 ià(
nqu”y
 =ğ
P®mB©ch
) {

890 
	`qsÜt
(
a
, 
P®mB©ch
, ×[0]), 
com·»_št
);

891 
j
 = 0; j < 
P®mB©ch
 && !
ş›Á
.
	`timeout
(0); j++) {

892 #ià
PALM_DEBUG


893 
ušt64_t
 
v
 = 
a
[
j
] + 1;

894 
ş›Á
.
	`g‘_check
(
a
[
j
], 
v
);

896 
ş›Á
.
	`g‘
(
a
[
j
]);

899 
nqu”y
 = 0;

902 
ş›Á
.
	`wa™_®l
();

903 
t1
 = 
ş›Á
.
	`now
();

904 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
, 
t1
 - 
t0
);

905 
ş›Á
.
	`»pÜt
(
»suÉ
);

906 
	}
}

908 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

909 
	$kv‹¡_·lmb
(
C
 &
ş›Á
)

911 
	`kv‹¡_·lmb_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48);

912 
	}
}

914 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

915 
	$kv‹¡_ycsbk_£ed
(
C
 &
ş›Á
, 
£ed
)

917 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

918 
0
 = 
ş›Á
.
	`now
();

919 
n
;

920 
key
[512], 
v®
[512];

921 
n
 = 0; !
ş›Á
.
	`timeout
(0) &&‚ < 1000000; ++n) {

922 
	`¡rıy
(
key
, "user");

923 
p
 = 4;

924 
i
 = 0; i < 18; i++, 
p
++)

925 
key
[
p
] = '0' + (
ş›Á
.
¿nd
.
	`Ãxt
() % 10);

926 
key
[
p
] = 0;

927 
št32_t
 
v
 = (št32_tè
ş›Á
.
¿nd
.
	`Ãxt
();

928 
	`¥rštf
(
v®
, "%d", 
v
);

929 
ş›Á
.
	`put
(
	`SŒ
(
key
, 
	`¡¾’
(key)), SŒ(
v®
, strlen(val)));

931 
ş›Á
.
	`wa™_®l
();

932 
1
 = 
ş›Á
.
	`now
();

934 
ş›Á
.
	`puts_dÚe
();

935 
ş›Á
.
	`nÙiû
("now getting\n");

936 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

937 
tg0
 = 
ş›Á
.
	`now
();

938 
g
;

939 
g
 = 0; g < 
n
 && !
ş›Á
.
	`timeout
(1); ++g) {

940 
	`¡rıy
(
key
, "user");

941 
p
 = 4;

942 
i
 = 0; i < 18; i++, 
p
++)

943 
key
[
p
] = '0' + (
ş›Á
.
¿nd
.
	`Ãxt
() % 10);

944 
key
[
p
] = 0;

945 
št32_t
 
v
 = (št32_tè
ş›Á
.
¿nd
.
	`Ãxt
();

946 
	`¥rštf
(
v®
, "%d", 
v
);

947 
ş›Á
.
	`g‘_check
(
	`SŒ
(
key
, 
	`¡¾’
(key)), SŒ(
v®
, strlen(val)));

949 
ş›Á
.
	`wa™_®l
();

950 
tg1
 = 
ş›Á
.
	`now
();

952 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

953 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
n
, 
1
 - 
0
);

954 
	`kv‹¡_£t_time
(
»suÉ
, "g‘s", 
g
, 
tg1
 - 
tg0
);

955 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
 + 
g
, (
1
 - 
0
è+ (
tg1
 - 
tg0
));

956 
ş›Á
.
	`»pÜt
(
»suÉ
);

957 
	}
}

959 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

960 
	$kv‹¡_ycsbk
(
C
 &
ş›Á
)

962 
	`kv‹¡_ycsbk_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48);

963 
	}
}

965 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

967 
	$kv‹¡_bdb
(
C
 &
ş›Á
)

969 ’um { 
Äec
 = 500000, 
keyËn
 = 8, 
d©®’
 = 32 };

970 
key
[
keyËn
 + 1];

971 
v®
[
d©®’
 + 1];

972 
	`mem£t
(
v®
, '^', (val));

973 
v®
[
d©®’
] = 0;

974 
key
[
keyËn
] = 0;

975 
	`¤ªdom
(0);

976 
n
 = 0;‚ < 
Äec
;‚++) {

977 
i
 = 0; i < 
keyËn
; i++)

978 
key
[
i
] = 'a' + 
	`¿ndom
() % 26;

979 
ş›Á
.
	`put
(
key
, 
v®
);

981 
ş›Á
.
	`wa™_®l
();

983 
	`¤ªdom
(0);

984 
t0
 = 
	`now
();

985 
n
;

986 
n
 = 0;‚ < 10000000;‚++) {

987 
i
 = 0; i < 
keyËn
; i++)

988 
key
[
i
] = 'a' + 
	`¿ndom
() % 26;

989 
ş›Á
.
	`g‘_check
(
key
, 
v®
);

990 ià(
n
 % 
Äec
 == 0)

991 
	`¤ªdom
(0);

993 
t1
 = 
	`now
();

994 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

995 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
, 
t1
 - 
t0
);

996 
ş›Á
.
	`»pÜt
(
»suÉ
);

997 
	}
}

999 ’um { 
	mNLÚgP¬ts
 = 16 };

1001 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1003 
	$kv‹¡_lÚg_š™
(
C
 &
ş›Á
)

1005 
	`as£¹
(
ş›Á
.
	`id
(è< 
NLÚgP¬ts
);

1006 
£ed
 = 
kv‹¡_fœ¡_£ed
 + 
ş›Á
.
	`id
();

1007 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

1008 cÚ¡ 
keyËn
 = 
ş›Á
.
	`keyËn
();

1009 cÚ¡ 
´efixL’
 = 
ş›Á
.
	`´efixL’
();

1010 cÚ¡ 
mškÉr
 = 
ş›Á
.
	`mškeyË‰”
();

1011 cÚ¡ 
maxkÉr
 = 
ş›Á
.
	`maxkeyË‰”
();

1012 
	`as£¹
(
´efixL’
 < 
keyËn
);

1013 cÚ¡ 
ušt32_t
 
nkeysP”P¬t
 = 
ş›Á
.
	`nkeys
(è/ 
NLÚgP¬ts
;

1014 
key
[512], 
v®
[512];

1015 
v®
[8] = 0;

1016 
	`mem£t
(
key
, '^', 
´efixL’
);

1017 
t0
 = 
	`now
();

1018 
n
;

1019 
n
 = 0;‚ < 
nkeysP”P¬t
; ++n){

1020 
i
 = 
´efixL’
; i < 
keyËn
; i++)

1021 
key
[
i
] = 
mškÉr
 + 
ş›Á
.
¿nd
.
	`Ãxt
(è% (
maxkÉr
 - minkltr + 1);

1022 
key
[
keyËn
] = 0;

1023 
	`memıy
(
v®
, 
key
 + 
keyËn
 - 8, 8);

1024 
ş›Á
.
	`put
(
key
, 
v®
);

1025 
ş›Á
.
¿nd
.
	`Ãxt
();

1027 
ş›Á
.
	`wa™_®l
();

1028 
t1
 = 
	`now
();

1030 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

1031 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
n
, 
t1
 - 
t0
);

1032 
ş›Á
.
	`»pÜt
(
»suÉ
);

1033 
	}
}

1035 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1037 
	$kv‹¡_lÚg_go
(
C
 &
ş›Á
)

1039 cÚ¡ 
keyËn
 = 
ş›Á
.
	`keyËn
();

1040 cÚ¡ 
´efixL’
 = 
ş›Á
.
	`´efixL’
();

1041 
	`as£¹
(
´efixL’
 < 
keyËn
);

1042 cÚ¡ 
ušt32_t
 
nKeysP”P¬t
 = 
ş›Á
.
	`nkeys
(è/ 
NLÚgP¬ts
;

1043 cÚ¡ 
mškÉr
 = 
ş›Á
.
	`mškeyË‰”
();

1044 cÚ¡ 
maxkÉr
 = 
ş›Á
.
	`maxkeyË‰”
();

1045 
key
[512], 
v®
[512];

1046 
	`mem£t
(
key
, '^', 
´efixL’
);

1047 
v®
[8] = 0;

1048 
t0
 = 
	`now
();

1049 
n
 = 0;

1050 
cur_cid
 = 
ş›Á
.
	`id
(è% 
NLÚgP¬ts
;

1051 !
ş›Á
.
	`timeout
(0)) {

1052 
ş›Á
.
¿nd
.
	`»£t
(
kv‹¡_fœ¡_£ed
 + 
cur_cid
);

1053 
ušt32_t
 
İ
;

1054 
İ
 = 0; !
ş›Á
.
	`timeout
(0è&& o°< 
nKeysP”P¬t
; op++){

1055 
i
 = 
´efixL’
; i < 
keyËn
; i++)

1056 
key
[
i
] = 
mškÉr
 + 
ş›Á
.
¿nd
.
	`Ãxt
(è% (
maxkÉr
 - minkltr + 1);

1057 
	`memıy
(
v®
, 
key
 + 
keyËn
 - 8, 8);

1058 
key
[
keyËn
] = 0;

1059 ià(
ş›Á
.
¿nd
.
	`Ãxt
(è% 100 < cl›Á.
	`g‘¿tio
())

1060 
ş›Á
.
	`g‘_check
(
key
, 
v®
);

1062 
ş›Á
.
	`put
(
key
, 
v®
);

1064 
cur_cid
 = (cur_cid + 1è% 
NLÚgP¬ts
;

1065 
n
 +ğ
İ
;

1067 
ş›Á
.
	`wa™_®l
();

1068 
t1
 = 
	`now
();

1070 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

1071 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
, 
t1
 - 
t0
);

1072 
ş›Á
.
	`»pÜt
(
»suÉ
);

1073 
	}
}

1075 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1077 
	$kv‹¡_wsÿË
(
C
 &
ş›Á
)

1079 
t0
 = 
	`now
();

1080 
ş›Á
.
¿nd
.
	`»£t
(
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48);

1081 
n
;

1082 
n
 = 0; !
ş›Á
.
	`timeout
(0);‚++){

1083 
x
 = 
ş›Á
.
¿nd
.
	`Ãxt
();

1084 
ş›Á
.
	`put
(
x
, x + 1);

1086 
ş›Á
.
	`wa™_®l
();

1087 
t1
 = 
	`now
();

1088 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

1089 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
n
, 
t1
 -
t0
);

1090 
ş›Á
.
	`»pÜt
(
»suÉ
);

1091 
	}
}

1093 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1095 
	$kv‹¡_rusÿË_š™
(
C
 &
ş›Á
)

1097 
t0
 = 
	`now
();

1098 
ş›Á
.
¿nd
.
	`»£t
(
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48);

1099 cÚ¡ 
rusÿË_·¹sz
 = 
ş›Á
.
	`rusÿË_·¹sz
();

1100 cÚ¡ 
fœ¡key
 = 
rusÿË_·¹sz
 * 
ş›Á
.
	`rusÿË_š™_·¹_no
();

1102 *
keys
 = (*è
	`m®loc
((è* 
rusÿË_·¹sz
);

1103 
	`®ways_as£¹
(
keys
);

1104 
i
 = 0; i < 
rusÿË_·¹sz
; i++)

1105 
keys
[
i
] = i + 
fœ¡key
;

1106 
i
 = 0; i < 
rusÿË_·¹sz
; i++)

1107 
¡d
::
	`sw­
(
keys
[
i
], keys[
ş›Á
.
¿nd
.
	`Ãxt
(è% 
rusÿË_·¹sz
]);

1108 
i
 = 0; i < 
rusÿË_·¹sz
; i++){

1109 
x
 = 
keys
[
i
];

1110 
ş›Á
.
	`put
(
x
, x + 1);

1112 
ş›Á
.
	`wa™_®l
();

1113 
t1
 = 
	`now
();

1114 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

1115 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
rusÿË_·¹sz
, 
t1
 - 
t0
);

1116 
ş›Á
.
	`»pÜt
(
»suÉ
);

1117 
	`ä“
(
keys
);

1118 
	}
}

1120 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1122 
	$kv‹¡_rsÿË
(
C
 &
ş›Á
)

1124 
ş›Á
.
¿nd
.
	`»£t
(
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48);

1125 cÚ¡ 
n£qkeys
 = 
ş›Á
.
	`n£qkeys
();

1126 
t0
 = 
	`now
();

1127 
n
;

1128 
n
 = 0; !
ş›Á
.
	`timeout
(0);‚++){

1129 
x
 = 
ş›Á
.
¿nd
.
	`Ãxt
(è% 
n£qkeys
;

1130 
ş›Á
.
	`g‘_check
(
x
, x + 1);

1132 
ş›Á
.
	`wa™_®l
();

1133 
t1
 = 
	`now
();

1134 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

1135 
	`kv‹¡_£t_time
(
»suÉ
, "g‘s", 
n
, 
t1
 - 
t0
);

1136 
ş›Á
.
	`»pÜt
(
»suÉ
);

1137 
	}
}

1139 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1141 
	$kv‹¡_usÿË
(
C
 &
ş›Á
)

1143 
ş›Á
.
¿nd
.
	`»£t
(
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
());

1144 cÚ¡ 
n£qkeys
 = 
ş›Á
.
	`n£qkeys
();

1145 
t0
 = 
	`now
();

1146 
n
;

1147 
n
 = 0; !
ş›Á
.
	`timeout
(0);‚++){

1148 
x
 = 
ş›Á
.
¿nd
.
	`Ãxt
(è% 
n£qkeys
;

1149 
ş›Á
.
	`put
(
x
, x + 1);

1151 
ş›Á
.
	`wa™_®l
();

1152 
t1
 = 
	`now
();

1153 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

1154 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
n
, 
t1
 - 
t0
);

1155 
ş›Á
.
	`»pÜt
(
»suÉ
);

1156 
	}
}

1158 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1159 
	$kv‹¡_udp1_£ed
(
C
 &
ş›Á
, 
£ed
)

1161 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

1162 
0
 = 
ş›Á
.
	`now
();

1163 
n
;

1164 
n
 = 0; !
ş›Á
.
	`timeout
(0); ++n)

1165 
ş›Á
.
	`put
(0, 1);

1166 
ş›Á
.
	`wa™_®l
();

1167 
1
 = 
ş›Á
.
	`now
();

1169 
ş›Á
.
	`puts_dÚe
();

1170 
ş›Á
.
	`nÙiû
("now getting\n");

1171 
št32_t
 *
a
 = (št32_ˆ*è
	`m®loc
((št32_tè* 
n
);

1172 
	`as£¹
(
a
);

1173 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

1174 
i
 = 0; i < 
n
; ++i)

1175 
a
[
i
] = (
št32_t
è
ş›Á
.
¿nd
.
	`Ãxt
();

1176 
i
 = 0; i < 
n
; ++i)

1177 
¡d
::
	`sw­
(
a
[
i
],‡[
ş›Á
.
¿nd
.
	`Ãxt
(è% 
n
]);

1179 
tg0
 = 
ş›Á
.
	`now
();

1180 
g
;

1181 
g
 = 0; !
ş›Á
.
	`timeout
(1); ++g)

1182 
ş›Á
.
	`g‘_check
(0, 1);

1183 
ş›Á
.
	`wa™_®l
();

1184 
tg1
 = 
ş›Á
.
	`now
();

1186 
JsÚ
 
»suÉ
 = 
	`JsÚ
();

1187 
	`kv‹¡_£t_time
(
»suÉ
, "puts", 
n
, 
1
 - 
0
);

1188 
	`kv‹¡_£t_time
(
»suÉ
, "g‘s", 
g
, 
tg1
 - 
tg0
);

1189 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
n
 + 
g
, (
1
 - 
0
è+ (
tg1
 - 
tg0
));

1190 
ş›Á
.
	`»pÜt
(
»suÉ
);

1191 
	`ä“
(
a
);

1192 
	}
}

1194 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1195 
	$kv‹¡_udp1
(
C
 &
ş›Á
)

1197 
	`kv‹¡_udp1_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
	`id
() % 48);

1198 
	}
}

1203 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1204 
	$kv‹¡_w1_£ed
(
C
 &
ş›Á
, 
£ed
)

1206 
n
;

1207 ià(
ş›Á
.
	`lim™
(è=ğ~(
ušt64_t
) 0)

1208 
n
 = 4000000;

1210 
n
 = 
¡d
::
	`mš
(
ş›Á
.
	`lim™
(), (
ušt64_t
è
INT_MAX
);

1211 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

1213 
t0
 = 
	`now
();

1214 
i
 = 0; i < 
n
; i++) {

1215 
x
 = 
ş›Á
.
¿nd
.
	`Ãxt
();

1216 
ş›Á
.
	`put_key10
(
x
, x + 1);

1218 
ş›Á
.
	`wa™_®l
();

1219 
t1
 = 
	`now
();

1221 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("tÙ®", (è(
n
 / (
t1
 - 
t0
)))

1222 .
	`£t
("puts", 
n
)

1223 .
	`£t
("puts_³r_£c", 
n
 / (
t1
 - 
t0
));

1224 
ş›Á
.
	`»pÜt
(
»suÉ
);

1225 
	}
}

1231 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1232 
	$kv‹¡_r1_£ed
(
C
 &
ş›Á
, 
£ed
)

1234 
n
;

1235 ià(
ş›Á
.
	`lim™
(è=ğ~(
ušt64_t
) 0)

1236 
n
 = 4000000;

1238 
n
 = 
¡d
::
	`mš
(
ş›Á
.
	`lim™
(), (
ušt64_t
è
INT_MAX
);

1239 *
a
 = (*è
	`m®loc
((è* 
n
);

1240 
	`®ways_as£¹
(
a
);

1242 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

1243 
i
 = 0; i < 
n
; i++)

1244 
a
[
i
] = 
ş›Á
.
¿nd
.
	`Ãxt
();

1245 
i
 = 0; i < 
n
; i++) {

1246 
i1
 = 
ş›Á
.
¿nd
.
	`Ãxt
(è% 
n
;

1247 
tmp
 = 
a
[
i
];

1248 
a
[
i
] =‡[
i1
];

1249 
a
[
i1
] = 
tmp
;

1252 
t0
 = 
	`now
();

1253 
i
 = 0; i < 
n
; i++)

1254 
ş›Á
.
	`g‘_check_key10
(
a
[
i
],‡[i] + 1);

1255 
ş›Á
.
	`wa™_®l
();

1256 
t1
 = 
	`now
();

1258 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("tÙ®", (è(
n
 / (
t1
 - 
t0
)))

1259 .
	`£t
("g‘s", 
n
)

1260 .
	`£t
("g‘s_³r_£c", 
n
 / (
t1
 - 
t0
));

1261 
ş›Á
.
	`»pÜt
(
»suÉ
);

1262 
	}
}

1267 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1268 
	$kv‹¡_wcŞ1©
(
C
 &
ş›Á
, 
cŞ
, 
£ed
, 
maxkeys
)

1270 
n
;

1271 ià(
ş›Á
.
	`lim™
(è=ğ~(
ušt64_t
) 0)

1272 
n
 = 4000000;

1274 
n
 = 
¡d
::
	`mš
(
ş›Á
.
	`lim™
(), (
ušt64_t
è
INT_MAX
);

1275 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

1277 
t0
 = 
	`now
();

1278 
i
 = 0; i < 
n
; i++) {

1279 
x
 = 
ş›Á
.
¿nd
.
	`Ãxt
(è% 
maxkeys
;

1280 
ş›Á
.
	`put_cŞ_key10
(
x
, 
cŞ
, x + 1);

1282 
ş›Á
.
	`wa™_®l
();

1283 
t1
 = 
	`now
();

1285 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("tÙ®", (è(
n
 / (
t1
 - 
t0
)))

1286 .
	`£t
("puts", 
n
)

1287 .
	`£t
("puts_³r_£c", 
n
 / (
t1
 - 
t0
));

1288 
ş›Á
.
	`»pÜt
(
»suÉ
);

1289 
	}
}

1295 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1296 
	$kv‹¡_rcŞ1©
(
C
 &
ş›Á
, 
cŞ
, 
£ed
, 
maxkeys
)

1298 
n
;

1299 ià(
ş›Á
.
	`lim™
(è=ğ~(
ušt64_t
) 0)

1300 
n
 = 4000000;

1302 
n
 = 
¡d
::
	`mš
(
ş›Á
.
	`lim™
(), (
ušt64_t
è
INT_MAX
);

1303 *
a
 = (*è
	`m®loc
((è* 
n
);

1304 
	`®ways_as£¹
(
a
);

1306 
ş›Á
.
¿nd
.
	`»£t
(
£ed
);

1307 
i
 = 0; i < 
n
; i++)

1308 
a
[
i
] = 
ş›Á
.
¿nd
.
	`Ãxt
(è% 
maxkeys
;

1309 
i
 = 0; i < 
n
 && 0; i++) {

1310 
i1
 = 
ş›Á
.
¿nd
.
	`Ãxt
(è% 
n
;

1311 
tmp
 = 
a
[
i
];

1312 
a
[
i
] =‡[
i1
];

1313 
a
[
i1
] = 
tmp
;

1316 
t0
 = 
	`now
();

1317 
i
 = 0; i < 
n
; i++)

1318 
ş›Á
.
	`g‘_cŞ_check_key10
(
a
[
i
], 
cŞ
,‡[i] + 1);

1319 
ş›Á
.
	`wa™_®l
();

1320 
t1
 = 
	`now
();

1322 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("tÙ®", (è(
n
 / (
t1
 - 
t0
)))

1323 .
	`£t
("g‘s", 
n
)

1324 .
	`£t
("g‘s_³r_£c", 
n
 / (
t1
 - 
t0
));

1325 
ş›Á
.
	`»pÜt
(
»suÉ
);

1326 
	}
}

1329 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1330 
	$kv‹¡_sÿn1
(
C
 &
ş›Á
, 
wr™”_qu›t
)

1332 
n
, 
wq65536
 = (
wr™”_qu›t
 * 65536);

1333 ià(
ş›Á
.
	`lim™
(è=ğ~(
ušt64_t
) 0)

1334 
n
 = 10000;

1336 
n
 = 
¡d
::
	`mš
(
ş›Á
.
	`lim™
(), (
ušt64_t
) 97655);

1337 
JsÚ
 
»suÉ
;

1339 ià(
ş›Á
.
	`id
() % 24 == 0) {

1340 
i
 = 0; i < 
n
; ++i)

1341 
ş›Á
.
	`put_key8
(
i
 * 1024, i);

1342 
ş›Á
.
	`wa™_®l
();

1344 
pos
 = 0, 
mypos
 = 0, 
sÿn¡•s
 = 0;

1345 
quick_i¡r
 
key
;

1346 
¡d
::
veùÜ
<
SŒ
> 
keys
, 
v®ues
;

1347 
JsÚ
 
”rj
;

1348 !
ş›Á
.
	`timeout
(0è&& 
”rj
.
	`size
() < 1000) {

1349 
key
.
	`£t
(
pos
, 8);

1350 
ş›Á
.
	`sÿn_sync
(
key
.
	`¡ršg
(), 100, 
keys
, 
v®ues
);

1351 ià(
keys
.
	`size
() == 0) {

1352 ià(
mypos
 < 
n
 * 1024)

1353 
”rj
.
	`push_back
("missšg " + 
	`SŒšg
(
mypos
è+ "hrough " + SŒšg((
n
 - 1) * 1024));

1354 
pos
 = 
mypos
 = 0;

1356 
size_t
 
i
 = 0; i < 
keys
.
	`size
(); ++i) {

1357 
v®
 = 
keys
[
i
].
	`to_i
();

1358 ià(
v®
 < 0) {

1359 
”rj
.
	`push_back
("uÃx³ùed key " + 
	`SŒšg
(
keys
[
i
].
s
, keys[i].
Ën
));

1362 ià(
v®
 < 
pos
)

1363 
”rj
.
	`push_back
("gÙ " + 
	`SŒšg
(
keys
[
i
].
s
, keys[i].
Ën
è+ ",ƒx³ùed " + SŒšg(
pos
) + " or†ater");

1364 
pos
 = 
v®
 + 1;

1365 
v®
 > 
mypos
) {

1366 
”rj
.
	`push_back
("gÙ " + 
	`SŒšg
(
keys
[
i
].
s
, keys[i].
Ën
è+ ", missšg " + SŒšg(
mypos
è+ " @" + SŒšg(
sÿn¡•s
) + "+" + String(i));

1367 
mypos
 += 1024;

1369 ià(
v®
 =ğ
mypos
) {

1370 
mypos
 = 
v®
 + 1024;

1371 ++
sÿn¡•s
;

1375 
ş›Á
.
	`rcu_qu›sû
();

1377 ià(
”rj
.
	`size
() >= 1000)

1378 
”rj
.
	`push_back
("too manyƒrrors, giving up");

1379 
»suÉ
.
	`£t
("ok", 
”rj
.
	`em±y
()).£t("sÿn¡•s", 
sÿn¡•s
);

1380 ià(
”rj
)

1381 
»suÉ
.
	`£t
("”rÜs", 
”rj
);

1384 
d–
 = 1 + (
ş›Á
.
	`id
(è% 30è* 32, 
rounds
 = 0;

1385 !
ş›Á
.
	`timeout
(0)) {

1386 
fœ¡
 = (
ş›Á
.
¿nd
.
	`Ãxt
(è% 
n
è* 1024 + 
d–
;

1387 
¿nd
 = 
ş›Á
.¿nd.
	`Ãxt
() % 65536;

1388 ià(
¿nd
 < 
wq65536
) {

1389 
d
 = 0; d < 31; ++d)

1390 
	`»Ïx_ãnû
();

1391 } ià(
rounds
 > 100 && (
¿nd
 % 2) == 1) {

1392 
d
 = 0; d < 31; ++d)

1393 
ş›Á
.
	`»move_key8
(
d
 + 
fœ¡
);

1395 
d
 = 0; d < 31; ++d)

1396 
ş›Á
.
	`put_key8
(
d
 + 
fœ¡
, d + first);

1398 ++
rounds
;

1399 
ş›Á
.
	`rcu_qu›sû
();

1403 
ş›Á
.
	`»pÜt
(
»suÉ
);

1404 
	}
}

1407 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1408 
	$kv‹¡_rsÿn1
(
C
 &
ş›Á
, 
wr™”_qu›t
)

1410 
n
, 
wq65536
 = (
wr™”_qu›t
 * 65536);

1411 ià(
ş›Á
.
	`lim™
(è=ğ~(
ušt64_t
) 0)

1412 
n
 = 10000;

1414 
n
 = 
¡d
::
	`mš
(
ş›Á
.
	`lim™
(), (
ušt64_t
) 97655);

1415 
JsÚ
 
»suÉ
;

1417 ià(
ş›Á
.
	`id
() % 24 == 0) {

1418 
i
 = 1; i <ğ
n
; ++i)

1419 
ş›Á
.
	`put_key8
(
i
 * 1024, i);

1420 
ş›Á
.
	`wa™_®l
();

1422 
pos
 = (
n
 + 1è* 1024, 
mypos
 =‚ * 1024, 
sÿn¡•s
 = 0;

1423 
quick_i¡r
 
key
;

1424 
¡d
::
veùÜ
<
SŒ
> 
keys
, 
v®ues
;

1425 
JsÚ
 
”rj
;

1426 !
ş›Á
.
	`timeout
(0è&& 
”rj
.
	`size
() < 1000) {

1427 
key
.
	`£t
(
pos
, 8);

1428 
ş›Á
.
	`rsÿn_sync
(
key
.
	`¡ršg
(), 100, 
keys
, 
v®ues
);

1429 ià(
keys
.
	`size
() == 0) {

1430 ià(
mypos
 > 0)

1431 
”rj
.
	`push_back
("missšg 1024hrough " + 
	`SŒšg
(
mypos
è+ " @" + SŒšg(
sÿn¡•s
));

1432 
pos
 = (
n
 + 1è* 1024, 
mypos
 =‚ * 1024;

1434 
size_t
 
i
 = 0; i < 
keys
.
	`size
(); ++i) {

1435 
v®
 = 
keys
[
i
].
	`to_i
();

1436 ià(
v®
 < 0) {

1437 
”rj
.
	`push_back
("uÃx³ùed key " + 
	`SŒšg
(
keys
[
i
].
s
, keys[i].
Ën
));

1440 ià(
v®
 > 
pos
)

1441 
”rj
.
	`push_back
("gÙ " + 
	`SŒšg
(
keys
[
i
].
s
, keys[i].
Ën
è+ ",ƒx³ùed " + SŒšg(
pos
) + " or†ess");

1442 
pos
 = 
v®
 - 1;

1443 
v®
 < 
mypos
) {

1444 
SŒšg
 
Ï¡
;

1445 ià(
i
)

1446 
Ï¡
 = 
	`SŒšg
(
keys
[
i
-1].
s
, keys[i-1].
Ën
);

1448 
Ï¡
 = 
	`SŒšg
(
key
.
	`¡ršg
().
s
, key.¡ršg().
Ën
);

1449 
”rj
.
	`push_back
("gÙ " + 
	`SŒšg
(
keys
[
i
].
s
, keys[i].
Ën
è+ ", missšg " + SŒšg(
mypos
è+ " @" + SŒšg(
sÿn¡•s
è+ "+" + SŒšg(iè+ ",†a¡ " + 
Ï¡
);

1450 
mypos
 -= 1024;

1452 ià(
v®
 =ğ
mypos
) {

1453 
mypos
 = 
v®
 - 1024;

1454 ++
sÿn¡•s
;

1458 
ş›Á
.
	`rcu_qu›sû
();

1460 ià(
”rj
.
	`size
() >= 1000)

1461 
”rj
.
	`push_back
("too manyƒrrors, giving up");

1462 
»suÉ
.
	`£t
("ok", 
”rj
.
	`em±y
()).£t("sÿn¡•s", 
sÿn¡•s
);

1463 ià(
”rj
)

1464 
»suÉ
.
	`£t
("”rÜs", 
”rj
);

1467 
d–
 = 1 + (
ş›Á
.
	`id
(è% 30è* 32, 
rounds
 = 0;

1468 !
ş›Á
.
	`timeout
(0)) {

1469 
fœ¡
 = (
ş›Á
.
¿nd
.
	`Ãxt
(è% 
n
 + 1è* 1024 + 
d–
;

1470 
¿nd
 = 
ş›Á
.¿nd.
	`Ãxt
() % 65536;

1471 ià(
¿nd
 < 
wq65536
) {

1472 
d
 = 0; d < 31; ++d)

1473 
	`»Ïx_ãnû
();

1474 } ià(
rounds
 > 100 && (
¿nd
 % 2) == 1) {

1475 
d
 = 0; d < 31; ++d)

1476 
ş›Á
.
	`»move_key8
(
d
 + 
fœ¡
);

1478 
d
 = 0; d < 31; ++d)

1479 
ş›Á
.
	`put_key8
(
d
 + 
fœ¡
, d + first);

1481 ++
rounds
;

1482 
ş›Á
.
	`rcu_qu›sû
();

1486 
ş›Á
.
	`»pÜt
(
»suÉ
);

1487 
	}
}

1490 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1491 
	$kv‹¡_¥l™»move1
(
C
 &
ş›Á
)

1494 
Ëaf_width
 = 15, 
š‹ºode_width
 = 15;

1495 
num_keys
 = 
Ëaf_width
 * (
š‹ºode_width
 + 1) + 1;

1496 
Œigg”_key
 = 
num_keys
 - 15;

1497 
rounds
 = 0;

1498 
JsÚ
 
»suÉ
, 
”rj
;

1500 ià(
ş›Á
.
	`id
() == 0) {

1502 
i
 = 0; i < 
num_keys
; ++i)

1503 
ş›Á
.
	`put_key16
(
i
 + 100, i + 101);

1504 
ş›Á
.
	`rcu_qu›sû
();

1505 
i
 = 
Œigg”_key
 + 1; i < 
num_keys
 + 10; ++i)

1506 
ş›Á
.
	`»move_key16
(
i
 + 100);

1507 
ş›Á
.
	`rcu_qu›sû
();

1508 
i
 = 0; i < 
Ëaf_width
 * 
š‹ºode_width
; ++i)

1509 
ş›Á
.
	`put_key16
(
i
, i + 1);

1511 
ş›Á
.
	`put
(ş›Á.
	`Áh»ads
(), client.nthreads() + 1);

1512 
i
 = 1; i < 
ş›Á
.
	`Áh»ads
(); ++i)

1513 
ş›Á
.
	`put
(
i
, i + 1);

1514 
i
 = 1; i < 
ş›Á
.
	`Áh»ads
(); ++i) {

1515 !
ş›Á
.
	`timeout
(0è&& cl›Á.
	`g‘_sync
(
i
))

1518 
ş›Á
.
	`»move_key16
(
Œigg”_key
);

1519 
ş›Á
.
	`»move
(ş›Á.
	`Áh»ads
());

1520 ià(
ş›Á
.
	`timeout
(0))

1523 
i
 = 0; i < 
num_keys
; ++i) {

1524 
ş›Á
.
	`»move_key16
(
i
);

1525 
ş›Á
.
	`»move_key16
(
i
 + 100);

1527 
i
 = 0; i < 10; ++i)

1528 
ş›Á
.
	`rcu_qu›sû
();

1529 ++
rounds
;

1533 
quick_i¡r
 
	`me
(
ş›Á
.
	`id
()), 
	`Œigg”
(
Œigg”_key
, 16);

1535 !
ş›Á
.
	`timeout
(0è&& !ş›Á.
	`g‘_sync_key16
(
Œigg”_key
))

1536 
ş›Á
.
	`rcu_qu›sû
();

1537 ià(
ş›Á
.
	`timeout
(0))

1540 
i
 = 0; !
ş›Á
.
	`g‘_sync
(
me
.
	`¡ršg
()); ++i) {

1541 ià(!
ş›Á
.
	`g‘_sync
(
Œigg”
.
	`¡ršg
()è&& !ş›Á.
	`timeout
(0)) {

1542 ià(
”rj
.
	`size
() == 100)

1543 
”rj
.
	`push_back
("moreƒrrors");

1544 ià(
”rj
.
	`size
() < 100)

1545 
”rj
.
	`push_back
("key " + 
	`SŒšg
(
Œigg”
.
	`¡ršg
()è+ " missšg‡á” " + SŒšg(
rounds
è+ "„ounds, couÁ” " + SŒšg(
i
));

1548 
ş›Á
.
	`rcu_qu›sû
();

1551 !
ş›Á
.
	`timeout
(0è&& !ş›Á.
	`g‘_sync
(
me
.
	`¡ršg
()))

1552 
ş›Á
.
	`rcu_qu›sû
();

1553 
ş›Á
.
	`»move
(
me
.
	`¡ršg
());

1554 !
ş›Á
.
	`timeout
(0è&& cl›Á.
	`g‘_sync
(ş›Á.
	`Áh»ads
()))

1555 
ş›Á
.
	`rcu_qu›sû
();

1556 ià(
ş›Á
.
	`timeout
(0))

1559 
i
 = 0; i < 10; ++i)

1560 
ş›Á
.
	`rcu_qu›sû
();

1561 ++
rounds
;

1565 
»suÉ
.
	`£t
("ok", 
”rj
.
	`em±y
()).£t("rounds", 
rounds
);

1566 ià(
”rj
)

1567 
»suÉ
.
	`£t
("”rÜs", 
”rj
);

1568 
ş›Á
.
	`»pÜt
(
»suÉ
);

1569 
	}
}

1571 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1572 
	$kv‹¡_u¾_£ed
(
C
 &
ş›Á
)

1574 ià(!
ş›Á
.
	`·¿m
("fe").
	`is_s
()) {

1575 
ş›Á
.
	`»pÜt
(
JsÚ
::
	`objeù
("ok", 
çl£
, "error", "need 'file=URLFILE'…arameter"));

1579 
¡d
::
if¡»am
 
	`šfe_u¾_š™
(
ş›Á
.
	`·¿m
("fe").
	`to_s
());

1580 
¡d
::
if¡»am
 
	`šfe_u¾_d–_g‘
(
ş›Á
.
	`·¿m
("fe").
	`to_s
());

1581 
¡d
::
¡ršg
 
İs
;

1582 
¡d
::
¡ršg
 
u¾
;

1583 
couÁ_i
 = 0;

1584 
couÁ_d
 = 0;

1585 
couÁ_g
 = 0;

1587 
t0
 = 
ş›Á
.
	`now
();

1588 
couÁ_i
 < 
ş›Á
.
	`lim™
(è&& 
šfe_u¾_š™
.
	`good
()) {

1591 
i
 = 0; i !ğ10 && 
šfe_u¾_š™
 >> 
İs
 >> 
u¾
; ++i, ++
couÁ_i
)

1592 
ş›Á
.
	`put
(
u¾
, 2014);

1593 
i
 = 0; i !ğ5 && 
šfe_u¾_d–_g‘
 >> 
İs
 >> 
u¾
; ++i, ++
couÁ_d
)

1594 
ş›Á
.
	`»move
(
u¾
);

1596 
ş›Á
.
	`wa™_®l
();

1597 
ş›Á
.
	`puts_dÚe
();

1598 
t1
 = 
ş›Á
.
	`now
();

1599 
šfe_u¾_š™
.
	`şo£
();

1600 
ş›Á
.
	`nÙiû
("\ninsert done\n");

1603 
t2
 = 
ş›Á
.
	`now
();

1604 
couÁ_d
 + 
couÁ_g
 !ğ
couÁ_i
 && 
šfe_u¾_d–_g‘
 >> 
İs
 >> 
u¾
) {

1605 
ş›Á
.
	`g‘_check
(
	`SŒ
(
u¾
), 2014);

1606 ++
couÁ_g
;

1608 
ş›Á
.
	`wa™_®l
();

1609 
t3
 = 
ş›Á
.
	`now
();

1615 
JsÚ
 
»suÉ
 = JsÚ::
	`objeù
("puts", 
couÁ_i
, "»moves", 
couÁ_d
);

1616 
	`kv‹¡_£t_time
(
»suÉ
, "g‘s", 
couÁ_g
, 
t3
 - 
t2
);

1617 
	`kv‹¡_£t_time
(
»suÉ
, "İs", 
couÁ_i
 + 
couÁ_d
, 
t1
 - 
t0
);

1618 
ş›Á
.
	`»pÜt
(
»suÉ
);

1619 
	}
}

1621 
	g‹m¶©e
 <
ty³Çme
 
	gC
>

1622 
	$kv‹¡_u¾
(
C
 &
ş›Á
)

1624 
	`kv‹¡_u¾_£ed
(
ş›Á
);

1625 
	}
}

	@masstree-beta/kvthread.cc

16 
	~"kvth»ad.hh
"

17 
	~<¡ršg.h
>

18 
	~<¡dio.h
>

19 
	~<¡dlib.h
>

20 
	~<Ãw
>

21 
	~<sys/mmª.h
>

22 #ià
HAVE_SUPERPAGE
 && !
NOSUPERPAGE


23 
	~<sys/ty³s.h
>

24 
	~<dœ’t.h
>

27 
th»adšfo
 *
	gth»adšfo
::
®Éh»ads
;

28 #ià
ENABLE_ASSERTIONS


29 
	gth»adšfo
::
no_poŞ_v®ue
;

32 
šlše
 
	gth»adšfo
::
	$th»adšfo
(
pu½o£
, 
šdex
) {

33 
	`mem£t
(
this
, 0, (*this));

34 
pu½o£_
 = 
pu½o£
;

35 
šdex_
 = 
šdex
;

37 *
limbo_¥aû
 = 
	`®loÿ‹
((
limbo_group
), 
memg_limbo
);

38 
	`m¬k
(
tc_limbo_¦Ùs
, 
limbo_group
::
ÿ·c™y
);

39 
limbo_h—d_
 = 
limbo__
 = 
	`Ãw
(
limbo_¥aû
è
limbo_group
;

40 
ts_
 = 2;

41 
	}
}

43 
th»adšfo
 *
	gth»adšfo
::
	$make
(
pu½o£
, 
šdex
) {

44 
th»ads_š™Ÿlized
;

46 
th»adšfo
* 
ti
 = 
	`Ãw
(
	`m®loc
(8192)è
	`th»adšfo
(
pu½o£
, 
šdex
);

47 
ti
->
Ãxt_
 = 
®Éh»ads
;

48 
®Éh»ads
 = 
ti
;

50 ià(!
th»ads_š™Ÿlized
) {

51 #ià
ENABLE_ASSERTIONS


52 cÚ¡ * 
s
 = 
	`g‘’v
("_");

53 
no_poŞ_v®ue
 = 
s
 && 
	`¡r¡r
(s, "valgrind") != 0;

55 
th»ads_š™Ÿlized
 = 1;

58  
ti
;

59 
	}
}

61 
	gth»adšfo
::
	$»fl_rcu
() {

62 ià(!
limbo__
->
Ãxt_
) {

63 *
limbo_¥aû
 = 
	`®loÿ‹
((
limbo_group
), 
memg_limbo
);

64 
	`m¬k
(
tc_limbo_¦Ùs
, 
limbo_group
::
ÿ·c™y
);

65 
limbo__
->
Ãxt_
 = 
	`Ãw
(
limbo_¥aû
è
limbo_group
;

67 
limbo__
 =†imbo__->
Ãxt_
;

68 
	`as£¹
(
limbo__
->
h—d_
 =ğ0 &&†imbo__->
_
 == 0);

69 
	}
}

71 
šlše
 
	glimbo_group
::
	$ş—n_uÁ
(
th»adšfo
& 
ti
, 
mrcu_•och_ty³
 
•och_bound
,

72 
couÁ
) {

73 
•och_ty³
 
•och
 = 0;

74 
h—d_
 !ğ
_
) {

75 ià(
e_
[
h—d_
].
±r_
) {

76 
ti
.
	`ä“_rcu
(
e_
[
h—d_
].
±r_
,ƒ_[h—d_].
u_
.
g
);

77 
ti
.
	`m¬k
(
tc_gc
);

78 --
couÁ
;

79 ià(!
couÁ
) {

80 
e_
[
h—d_
].
±r_
 = 
nuÎ±r
;

81 
e_
[
h—d_
].
u_
.
•och
 =ƒpoch;

85 
•och
 = 
e_
[
h—d_
].
u_
.epoch;

86 ià(
	`sigÃd_•och_ty³
(
•och_bound
 - 
•och
) < 0)

89 ++
h—d_
;

91 ià(
h—d_
 =ğ
_
)

92 
h—d_
 = 
_
 = 0;

93  
couÁ
;

94 
	}
}

96 
	gth»adšfo
::
	$h¬d_rcu_qu›sû
() {

97 
limbo_group
* 
em±y_h—d
 = 
nuÎ±r
;

98 
limbo_group
* 
em±y_
 = 
nuÎ±r
;

99 
couÁ
 = 
rcu_ä“_couÁ
;

101 
mrcu_•och_ty³
 
•och_bound
 = 
aùive_•och
 - 1;

102 ià(
limbo_h—d_
->
h—d_
 =ğlimbo_h—d_->
_


103 || 
	`mrcu_sigÃd_•och_ty³
(
•och_bound
 - 
limbo_h—d_
->
	`fœ¡_•och
()) < 0)

104 
dÚe
;

107 
couÁ
) {

108 
couÁ
 = 
limbo_h—d_
->
	`ş—n_uÁ
(*
this
, 
•och_bound
, count);

109 ià(
limbo_h—d_
->
h—d_
 !ğlimbo_h—d_->
_
)

111 ià(!
em±y_h—d
)

112 
em±y_h—d
 = 
limbo_h—d_
;

113 
em±y_
 = 
limbo_h—d_
;

114 ià(
limbo_h—d_
 =ğ
limbo__
) {

115 
limbo_h—d_
 = 
limbo__
 = 
em±y_h—d
;

116 
dÚe
;

118 
limbo_h—d_
 =†imbo_h—d_->
Ãxt_
;

121 ià(
em±y_h—d
) {

122 
em±y_
->
Ãxt_
 = 
limbo__
->next_;

123 
limbo__
->
Ãxt_
 = 
em±y_h—d
;

126 
dÚe
:

127 ià(!
couÁ
)

128 
³rfÜm_gc_•och_
 = 
•och_bound
;

130 
³rfÜm_gc_•och_
 = 
•och_bound
 + 1;

131 
	}
}

133 
	gth»adšfo
::
	$»pÜt_rcu
(*
±r
) const

135 
limbo_group
 *
lg
 = 
limbo_h—d_
;†g;†g =†g->
Ãxt_
) {

136 
¡©us
 = 0;

137 
limbo_group
::
•och_ty³
 
e
 = 0;

138 
i
 = 0; i < 
lg
->
ÿ·c™y
; ++i) {

139 ià(
i
 =ğ
lg
->
h—d_
)

140 
¡©us
 = 1;

141 ià(
i
 =ğ
lg
->
_
) {

142 
¡©us
 = 0;

143 
e
 = 0;

145 ià(
lg
->
e_
[
i
].
±r_
 =ğ
±r
)

146 
	`årštf
(
¡d”r
, "th»ad %d:„cu %p@%d: % a %x @%" 
PRIu64
 "\n",

147 
šdex_
, 
lg
, 
i
, 
¡©us
 ? "waiting" : "freed",

148 
lg
->
e_
[
i
].
u_
.
g
, 
e
);

149 ià(!
lg
->
e_
[
i
].
±r_
)

150 
e
 = 
lg
->
e_
[
i
].
u_
.
•och
;

153 
	}
}

155 
	gth»adšfo
::
	$»pÜt_rcu_®l
(*
±r
)

157 
th»adšfo
 *
ti
 = 
®Éh»ads
;i;˜ğti->
	`Ãxt
())

158 
ti
->
	`»pÜt_rcu
(
±r
);

159 
	}
}

162 #ià
HAVE_SUPERPAGE
 && !
NOSUPERPAGE


163 
size_t
 
	$»ad_su³½age_size
() {

164 ià(
DIR
* 
d
 = 
	`İ’dœ
("/sys/kernel/mm/hugepages")) {

165 
size_t
 
n
 = (size_t) -1;

166 
dœ’t
* 
de
 = 
	`»addœ
(
d
))

167 ià(
de
->
d_ty³
 =ğ
DT_DIR


168 && 
	`¡ºcmp
(
de
->
d_Çme
, "hugepages-", 10) == 0

169 && 
de
->
d_Çme
[10] >= '0' && de->d_name[10] <= '9') {

170 
size_t
 
x
 = 
	`¡¹Ş
(&
de
->
d_Çme
[10], 0, 10) << 10;

171 
n
 = (
x
 <‚ ? x :‚);

173 
	`şo£dœ
(
d
);

174  
n
;

177 
	}
}

179 
size_t
 
	gsu³½age_size
 = 0;

182 
	$š™Ÿlize_poŞ
(* 
poŞ
, 
size_t
 
sz
, size_ˆ
un™
) {

183 * 
p
 = 
»š‹½»t_ÿ¡
<*>(
poŞ
);

184 ** 
ÃxŒ
 = 
»š‹½»t_ÿ¡
<**>(
p
);

185 
size_t
 
off
 = 
un™
; ofà+ un™ <ğ
sz
; off += unit) {

186 *
ÃxŒ
 = 
p
 + 
off
;

187 
ÃxŒ
 = 
»š‹½»t_ÿ¡
<**>(
p
 + 
off
);

189 *
ÃxŒ
 = 0;

190 
	}
}

192 
	gth»adšfo
::
	$»fl_poŞ
(
Æ
) {

193 
	`as£¹
(!
poŞ_
[
Æ
 - 1]);

195 ià(!
	`u£_poŞ
()) {

196 
poŞ_
[
Æ
 - 1] = 
	`m®loc
ÒÈ* 
CACHE_LINE_SIZE
);

197 ià(
poŞ_
[
Æ
 - 1])

198 *
»š‹½»t_ÿ¡
<**>(
poŞ_
[
Æ
 - 1]) = 0;

202 * 
poŞ
 = 0;

203 
size_t
 
poŞ_size
 = 0;

204 
r
;

206 #ià
HAVE_SUPERPAGE
 && !
NOSUPERPAGE


207 ià(!
su³½age_size
)

208 
su³½age_size
 = 
	`»ad_su³½age_size
();

209 ià(
su³½age_size
 !ğ(
size_t
) -1) {

210 
poŞ_size
 = 
su³½age_size
;

211 #ià
MADV_HUGEPAGE


212 ià((
r
 = 
	`posix_mem®ign
(&
poŞ
, 
poŞ_size
,…ool_size)) != 0) {

213 
	`årštf
(
¡d”r
, "posix_mem®igÀsu³½age: %s\n", 
	`¡»¼Ü
(
r
));

214 
poŞ
 = 0;

215 
su³½age_size
 = (
size_t
) -1;

216 } ià(
	`madvi£
(
poŞ
, 
poŞ_size
, 
MADV_HUGEPAGE
) != 0) {

217 
	`³¼Ü
("madvise superpage");

218 
su³½age_size
 = (
size_t
) -1;

220 #–ià
MAP_HUGETLB


221 
poŞ
 = 
	`mm­
(0, 
poŞ_size
, 
PROT_READ
 | 
PROT_WRITE
,

222 
MAP_PRIVATE
 | 
MAP_ANONYMOUS
 | 
MAP_HUGETLB
, -1, 0);

223 ià(
poŞ
 =ğ
MAP_FAILED
) {

224 
	`³¼Ü
("mmap superpage");

225 
poŞ
 = 0;

226 
su³½age_size
 = (
size_t
) -1;

229 
su³½age_size
 = (
size_t
) -1;

234 ià(!
poŞ
) {

235 
poŞ_size
 = 2 << 20;

236 ià((
r
 = 
	`posix_mem®ign
(&
poŞ
, 
CACHE_LINE_SIZE
, 
poŞ_size
)) != 0) {

237 
	`årštf
(
¡d”r
, "posix_mem®ign: %s\n", 
	`¡»¼Ü
(
r
));

238 
	`abÜt
();

242 
	`š™Ÿlize_poŞ
(
poŞ
, 
poŞ_size
, 
Æ
 * 
CACHE_LINE_SIZE
);

243 
poŞ_
[
Æ
 - 1] = 
poŞ
;

244 
	}
}

	@masstree-beta/kvthread.hh

16 #iâdeà
KVTHREAD_HH


17 
	#KVTHREAD_HH
 1

	)

18 
	~"mtcouÁ”s.hh
"

19 
	~"comp”.hh
"

20 
	~"cœcuÏr_št.hh
"

21 
	~"time¡amp.hh
"

22 
	~"memdebug.hh
"

23 
	~<as£¹.h
>

24 
	~<±h»ad.h
>

25 
	~<sys/mmª.h
>

26 
	~<¡dlib.h
>

28 
şass
 
	gth»adšfo
;

29 
şass
 
	glogšfo
;

31 
ušt64_t
 
	tmrcu_•och_ty³
;

32 
št64_t
 
	tmrcu_sigÃd_•och_ty³
;

34 vŞ©
mrcu_•och_ty³
 
glob®•och
;

35 vŞ©
mrcu_•och_ty³
 
aùive_•och
;

37 
	slimbo_group
 {

38 
mrcu_•och_ty³
 
	t•och_ty³
;

39 
mrcu_sigÃd_•och_ty³
 
	tsigÃd_•och_ty³
;

41 
	slimbo_–em’t
 {

42 * 
	m±r_
;

44 
memg
 
	mg
;

45 
•och_ty³
 
	m•och
;

46 } 
	mu_
;

49 ’um { 
	mÿ·c™y
 = (4076 - (
•och_ty³
è- (
limbo_group
*)è/ (
limbo_–em’t
) };

50 
	mh—d_
;

51 
	m_
;

52 
•och_ty³
 
	m•och_
;

53 
limbo_group
* 
	mÃxt_
;

54 
limbo_–em’t
 
	me_
[
ÿ·c™y
];

55 
limbo_group
()

56 : 
h—d_
(0), 
_
(0), 
Ãxt_
() {

58 
•och_ty³
 
fœ¡_•och
() const {

59 
as£¹
(
h—d_
 !ğ
_
);

60  
	me_
[
h—d_
].
	mu_
.
	m•och
;

62 
push_back
(* 
±r
, 
memg
 
g
, 
mrcu_•och_ty³
 
•och
) {

63 
as£¹
(
_
 + 2 <ğ
ÿ·c™y
);

64 ià(
	mh—d_
 =ğ
_
 || 
•och_
 !ğ
•och
) {

65 
e_
[
_
].
±r_
 = 
nuÎ±r
;

66 
	me_
[
_
].
	mu_
.
	m•och
 = 
•och
;

67 
	m•och_
 = 
•och
;

68 ++
	m_
;

70 
	me_
[
_
].
	m±r_
 = 
±r
;

71 
	me_
[
_
].
	mu_
.
	mg
 = 
g
;

72 ++
	m_
;

74 
šlše
 
ş—n_uÁ
(
th»adšfo
& 
ti
, 
mrcu_•och_ty³
 
•och_bound
, 
couÁ
);

77 
	g‹m¶©e
 <
	gN
> 
	shas_th»adcouÁ”
 {

78 
boŞ
 
‹¡
(
th»adcouÁ”
 
ci
) {

79  (
	mci
è< (
	mN
);

82 
	g‹m¶©e
 <> 
	ghas_th»adcouÁ”
<0> {

83 
boŞ
 
‹¡
(
th»adcouÁ”
) {

84  
	gçl£
;

88 
	smrcu_ÿÎback
 {

89 
	mvœtu®
 ~
mrcu_ÿÎback
() {

91 
vœtu®
 
İ”©Ü
()(
	mth»adšfo
& 
	mti
) = 0;

94 şas 
	cth»adšfo
 {

95 
	mpublic
:

97 
TI_MAIN
, 
	mTI_PROCESS
, 
	mTI_LOG
, 
	mTI_CHECKPOINT


100 
th»adšfo
* 
	g®Éh»ads
;

102 
th»adšfo
* 
	$Ãxt
() const {

103  
Ãxt_
;

104 
	}
}

106 
th»adšfo
* 
make
(
pu½o£
, 
šdex
);

110 
	$pu½o£
() const {

111  
pu½o£_
;

112 
	}
}

113 
	$šdex
() const {

114  
šdex_
;

115 
	}
}

116 
logšfo
* 
	$logg”
() const {

117  
logg”_
;

118 
	}
}

119 
	$£t_logg”
(
logšfo
* 
logg”
) {

120 
	`as£¹
(!
logg”_
 && 
logg”
);

121 
logg”_
 = 
logg”
;

122 
	}
}

125 
kvtime¡amp_t
 
	$İ”©iÚ_time¡amp
() const {

126  
	`time¡amp
();

127 
	}
}

128 
kvtime¡amp_t
 
	$upd©e_time¡amp
() const {

129  
ts_
;

130 
	}
}

131 
kvtime¡amp_t
 
	$upd©e_time¡amp
(
kvtime¡amp_t
 
x
) const {

132 ià(
cœcuÏr_št
<
kvtime¡amp_t
>::
	`Ëss_equ®
(
ts_
, 
x
))

134 
ts_
 = (
x
 | 1) + 1;

135  
ts_
;

136 
	}
}

137 
	g‹m¶©e
 <
ty³Çme
 
	gN
> 
	$ob£rve_phªtoms
(
N
* 
n
) {

138 ià(
cœcuÏr_št
<
kvtime¡amp_t
>::
	`Ëss
(
ts_
, 
n
->
phªtom_•och_
[0]))

139 
ts_
 = 
n
->
phªtom_•och_
[0];

140 
	}
}

143 
	$m¬k
(
th»adcouÁ”
 
ci
) {

144 ià(
has_th»adcouÁ”
<(
ncouÁ”s
)>::
	`‹¡
(
ci
))

145 ++
couÁ”s_
[
ci
];

146 
	}
}

147 
	$m¬k
(
th»adcouÁ”
 
ci
, 
št64_t
 
d–
) {

148 ià(
has_th»adcouÁ”
<(
ncouÁ”s
)>::
	`‹¡
(
ci
))

149 
couÁ”s_
[
ci
] +ğ
d–
;

150 
	}
}

151 
	$£t_couÁ”
(
th»adcouÁ”
 
ci
, 
ušt64_t
 
v®ue
) {

152 ià(
has_th»adcouÁ”
<(
ncouÁ”s
)>::
	`‹¡
(
ci
))

153 
couÁ”s_
[
ci
] = 
v®ue
;

154 
	}
}

155 
boŞ
 
	$has_couÁ”
(
th»adcouÁ”
 
ci
) const {

156  
has_th»adcouÁ”
<(
ncouÁ”s
)>::
	`‹¡
(
ci
);

157 
	}
}

158 
ušt64_t
 
	$couÁ”
(
th»adcouÁ”
 
ci
) const {

159  
has_th»adcouÁ”
<(
ncouÁ”s
)>::
	`‹¡
(
ci
è? 
couÁ”s_
[ci] : 0;

160 
	}
}

162 
	saccouÁšg_»Ïx_ãnû_funùiÚ
 {

163 
th»adšfo
* 
	gti_
;

164 
th»adcouÁ”
 
	gci_
;

165 
accouÁšg_»Ïx_ãnû_funùiÚ
(
th»adšfo
* 
ti
, 
th»adcouÁ”
 
ci
)

166 : 
ti_
(
ti
), 
ci_
(
ci
) {

168 
İ”©Ü
()() {

169 
»Ïx_ãnû
();

170 
	gti_
->
m¬k
(
ci_
);

177 
accouÁšg_»Ïx_ãnû_funùiÚ
 
	$accouÁšg_»Ïx_ãnû
(
th»adcouÁ”
 
ci
) {

178  
	`accouÁšg_»Ïx_ãnû_funùiÚ
(
this
, 
ci
);

179 
	}
}

181 
	s¡abË_accouÁšg_»Ïx_ãnû_funùiÚ
 {

182 
th»adšfo
* 
	gti_
;

183 
¡abË_accouÁšg_»Ïx_ãnû_funùiÚ
(
th»adšfo
* 
ti
)

184 : 
ti_
(
ti
) {

186 
‹m¶©e
 <
ty³Çme
 
V
>

187 
İ”©Ü
()(
V
 
v
) {

188 
»Ïx_ãnû
();

189 
	gti_
->
m¬k
(
th»adcouÁ”
(
tc_¡abË
 + (
v
.
i¦—f
(è<< 1è+ v.
¥l™tšg
()));

196 
¡abË_accouÁšg_»Ïx_ãnû_funùiÚ
 
	$¡abË_ãnû
() {

197  
	`¡abË_accouÁšg_»Ïx_ãnû_funùiÚ
(
this
);

198 
	}
}

200 
accouÁšg_»Ïx_ãnû_funùiÚ
 
	$lock_ãnû
(
th»adcouÁ”
 
ci
) {

201  
	`accouÁšg_»Ïx_ãnû_funùiÚ
(
this
, 
ci
);

202 
	}
}

205 * 
	$®loÿ‹
(
size_t
 
sz
, 
memg
 
g
) {

206 * 
p
 = 
	`m®loc
(
sz
 + 
memdebug_size
);

207 
p
 = 
memdebug
::
	`make
Õ, 
sz
, 
g
);

208 ià(
p
)

209 
	`m¬k
(
	`th»adcouÁ”
(
tc_®loc
 + (
g
 > 
memg_v®ue
)), 
sz
);

210  
p
;

211 
	}
}

212 
	$d—Îoÿ‹
(* 
p
, 
size_t
 
sz
, 
memg
 
g
) {

214 
	`as£¹
(
p
);

215 
p
 = 
memdebug
::
	`check_ä“
Õ, 
sz
, 
g
);

216 
	`ä“
(
p
);

217 
	`m¬k
(
	`th»adcouÁ”
(
tc_®loc
 + (
g
 > 
memg_v®ue
)), -
sz
);

218 
	}
}

219 
	$d—Îoÿ‹_rcu
(* 
p
, 
size_t
 
sz
, 
memg
 
g
) {

220 
	`as£¹
(
p
);

221 
memdebug
::
	`check_rcu
(
p
, 
sz
, 
g
);

222 
	`»cÜd_rcu
(
p
, 
g
);

223 
	`m¬k
(
	`th»adcouÁ”
(
tc_®loc
 + (
g
 > 
memg_v®ue
)), -
sz
);

224 
	}
}

226 * 
	$poŞ_®loÿ‹
(
size_t
 
sz
, 
memg
 
g
) {

227 
Æ
 = (
sz
 + 
memdebug_size
 + 
CACHE_LINE_SIZE
 - 1) / CACHE_LINE_SIZE;

228 
	`as£¹
(
Æ
 <ğ
poŞ_max_Æšes
);

229 ià(
	`uÆik–y
(!
poŞ_
[
Æ
 - 1]))

230 
	`»fl_poŞ
(
Æ
);

231 * 
p
 = 
poŞ_
[
Æ
 - 1];

232 ià(
p
) {

233 
poŞ_
[
Æ
 - 1] = *
»š‹½»t_ÿ¡
<**>(
p
);

234 
p
 = 
memdebug
::
	`make
Õ, 
sz
, 
	`memg
(
g
 + 
Æ
));

235 
	`m¬k
(
	`th»adcouÁ”
(
tc_®loc
 + (
g
 > 
memg_v®ue
)),

236 
Æ
 * 
CACHE_LINE_SIZE
);

238  
p
;

239 
	}
}

240 
	$poŞ_d—Îoÿ‹
(* 
p
, 
size_t
 
sz
, 
memg
 
g
) {

241 
Æ
 = (
sz
 + 
memdebug_size
 + 
CACHE_LINE_SIZE
 - 1) / CACHE_LINE_SIZE;

242 
	`as£¹
(
p
 && 
Æ
 <ğ
poŞ_max_Æšes
);

243 
p
 = 
memdebug
::
	`check_ä“
Õ, 
sz
, 
	`memg
(
g
 + 
Æ
));

244 ià(
	`u£_poŞ
()) {

245 *
»š‹½»t_ÿ¡
<**>(
p
èğ
poŞ_
[
Æ
 - 1];

246 
poŞ_
[
Æ
 - 1] = 
p
;

248 
	`ä“
(
p
);

249 
	`m¬k
(
	`th»adcouÁ”
(
tc_®loc
 + (
g
 > 
memg_v®ue
)),

250 -
Æ
 * 
CACHE_LINE_SIZE
);

251 
	}
}

252 
	$poŞ_d—Îoÿ‹_rcu
(* 
p
, 
size_t
 
sz
, 
memg
 
g
) {

253 
Æ
 = (
sz
 + 
memdebug_size
 + 
CACHE_LINE_SIZE
 - 1) / CACHE_LINE_SIZE;

254 
	`as£¹
(
p
 && 
Æ
 <ğ
poŞ_max_Æšes
);

255 
memdebug
::
	`check_rcu
(
p
, 
sz
, 
	`memg
(
g
 + 
Æ
));

256 
	`»cÜd_rcu
(
p
, 
	`memg
(
g
 + 
Æ
));

257 
	`m¬k
(
	`th»adcouÁ”
(
tc_®loc
 + (
g
 > 
memg_v®ue
)),

258 -
Æ
 * 
CACHE_LINE_SIZE
);

259 
	}
}

262 ’um { 
	grcu_ä“_couÁ
 = 128 };

263 
	$rcu_¡¬t
() {

264 ià(
gc_•och_
 !ğ
glob®•och
)

265 
gc_•och_
 = 
glob®•och
;

266 
	}
}

267 
	$rcu_¡İ
() {

268 ià(
³rfÜm_gc_•och_
 !ğ
aùive_•och
)

269 
	`h¬d_rcu_qu›sû
();

270 
gc_•och_
 = 0;

271 
	}
}

272 
	$rcu_qu›sû
() {

273 
	`rcu_¡¬t
();

274 ià(
³rfÜm_gc_•och_
 !ğ
aùive_•och
)

275 
	`h¬d_rcu_qu›sû
();

276 
	}
}

277 ::
mrcu_ÿÎback
 
	tmrcu_ÿÎback
;

278 
	$rcu_»gi¡”
(
mrcu_ÿÎback
* 
cb
) {

279 
	`»cÜd_rcu
(
cb
, 
	`memg
(-1));

280 
	}
}

283 
	g±h»ad_t
& 
	$±h»ad
() {

284  
±h»adid_
;

285 
	}
}

286 
±h»ad_t
 
	$±h»ad
() const {

287  
±h»adid_
;

288 
	}
}

290 
	$»pÜt_rcu
(* 
±r
) const;

291 
	`»pÜt_rcu_®l
(* 
±r
);

292 
šlše
 
mrcu_•och_ty³
 
	`mš_aùive_•och
();

294 
´iv©e
:

297 
mrcu_•och_ty³
 
gc_•och_
;

298 
mrcu_•och_ty³
 
³rfÜm_gc_•och_
;

299 
logšfo
 *
logg”_
;

301 
th»adšfo
 *
Ãxt_
;

302 
pu½o£_
;

303 
šdex_
;

306 
±h»ad_t
 
±h»adid_
;

308 
·ddšg1
[
CACHE_LINE_SIZE
];

309 
	}
};

311 ’um { 
	gpoŞ_max_Æšes
 = 20 };

312 * 
	gpoŞ_
[
poŞ_max_Æšes
];

314 
limbo_group
* 
	glimbo_h—d_
;

315 
limbo_group
* 
	glimbo__
;

316 
mubË
 
kvtime¡amp_t
 
	gts_
;

319 ’um { 
	gncouÁ”s
 = 0 };

320 
ušt64_t
 
	gcouÁ”s_
[
ncouÁ”s
];

322 
»fl_poŞ
(
Æ
);

323 
»fl_rcu
();

325 
	$ä“_rcu
(*
p
, 
memg
 
g
) {

326 ià((
g
 & 
memg_poŞ_mask
) == 0) {

327 
p
 = 
memdebug
::
	`check_ä“_aá”_rcu
Õ, 
g
);

328 ::
	`ä“
(
p
);

329 } ià(
g
 =ğ
	`memg
(-1))

330 (*
¡©ic_ÿ¡
<
mrcu_ÿÎback
*>(
p
))(*
this
);

332 
p
 = 
memdebug
::
	`check_ä“_aá”_rcu
Õ, 
g
);

333 
Æ
 = 
g
 & 
memg_poŞ_mask
;

334 *
»š‹½»t_ÿ¡
<**>(
p
èğ
poŞ_
[
Æ
 - 1];

335 
poŞ_
[
Æ
 - 1] = 
p
;

337 
	}
}

339 
	$»cÜd_rcu
(* 
±r
, 
memg
 
g
) {

340 ià(
limbo__
->
_
 + 2 >†imbo__->
ÿ·c™y
)

341 
	`»fl_rcu
();

342 
ušt64_t
 
•och
 = 
glob®•och
;

343 
limbo__
->
	`push_back
(
±r
, 
g
, 
•och
);

344 
	}
}

346 #ià
ENABLE_ASSERTIONS


347 
	gno_poŞ_v®ue
;

349 
boŞ
 
	$u£_poŞ
() {

350 #ià
ENABLE_ASSERTIONS


351  !
no_poŞ_v®ue
;

353  
Œue
;

355 
	}
}

357 
šlše
 
th»adšfo
(
pu½o£
, 
šdex
);

358 
th»adšfo
(cÚ¡h»adšfo&èğ
d–‘e
;

359 ~
	$th»adšfo
(è{
	}
}

360 
	gth»adšfo
& 
	gİ”©Ü
=(cÚ¡ 
th»adšfo
&èğ
d–‘e
;

362 
h¬d_rcu_qu›sû
();

364 
ä›nd
 
	glimbo_group
;

367 
šlše
 
mrcu_•och_ty³
 
	gth»adšfo
::
	$mš_aùive_•och
() {

368 
mrcu_•och_ty³
 
«
 = 
glob®•och
;

369 
th»adšfo
* 
ti
 = 
®Éh»ads
;i;˜ğti->
	`Ãxt
()) {

370 
	`´eãtch
((cÚ¡ *è
ti
->
	`Ãxt
());

371 
mrcu_•och_ty³
 
‹
 = 
ti
->
gc_•och_
;

372 ià(
‹
 && 
	`mrcu_sigÃd_•och_ty³
Ñ- 
«
) < 0)

373 
«
 = 
‹
;

375  
«
;

376 
	}
}

	@masstree-beta/log.cc

16 
	~"log.hh
"

17 
	~"kvth»ad.hh
"

18 
	~"kvrow.hh
"

19 
	~"fe.hh
"

20 
	~"qu”y_mas¡»e.hh
"

21 
	~"mas¡»e_tcursÜ.hh
"

22 
	~"mas¡»e_š£¹.hh
"

23 
	~"mas¡»e_»move.hh
"

24 
	~"misc.hh
"

25 
	~"msg·ck.hh
"

26 
	~<sys/ty³s.h
>

27 
	~<sys/¡©.h
>

28 
	~<fú.h
>

29 
	~<uni¡d.h
>

30 
	~<”ºo.h
>

31 
usšg
 
	glcdf
::
SŒšg
;

33 
kv•och_t
 
	gglob®_log_•och
;

34 
kv•och_t
 
	gglob®_wake_•och
;

35 
timev®
 
	glog_•och_š‹rv®
;

36 
timev®
 
	glog_•och_time
;

37 
Mas¡»e
::
deçuÉ_bË
* 
Œ“
;

38 vŞ©
boŞ
 
»cov”šg
;

40 
kv•och_t
 
	g»c_ckp_mš_•och
;

41 
kv•och_t
 
	g»c_ckp_max_•och
;

42 
	glog»¶ay
::
šfo_ty³
 *
»c_log_šfos
;

43 
kv•och_t
 
	g»c_»¶ay_mš_•och
;

44 
kv•och_t
 
	g»c_»¶ay_max_•och
;

45 
kv•och_t
 
	g»c_»¶ay_mš_qu›sûÁ_Ï¡_•och
;

47 
	slog»c_ba£
 {

48 
ušt32_t
 
	mcommªd_
;

49 
ušt32_t
 
	msize_
;

51 
size_t
 
size
() {

52  (
	mlog»c_ba£
);

54 
size_t
 
¡Üe
(*
buf
, 
ušt32_t
 
commªd
) {

56 
log»c_ba£
 *
	mÌ
 = 
»š‹½»t_ÿ¡
<log»c_ba£ *>(
buf
);

57 
	mÌ
->
	mcommªd_
 = 
commªd
;

58 
	mÌ
->
	msize_
 = (*
Ì
);

59  (*
	mÌ
);

61 
boŞ
 
check
(cÚ¡ *
buf
) {

62 cÚ¡ 
log»c_ba£
 *
	mÌ
 = 
»š‹½»t_ÿ¡
<cÚ¡†og»c_ba£ *>(
buf
);

63  
	mÌ
->
	msize_
 >ğ(*
Ì
);

65 
ušt32_t
 
commªd
(cÚ¡ *
buf
) {

66 cÚ¡ 
log»c_ba£
 *
	mÌ
 = 
»š‹½»t_ÿ¡
<cÚ¡†og»c_ba£ *>(
buf
);

67  
	mÌ
->
	mcommªd_
;

71 
	slog»c_•och
 {

72 
ušt32_t
 
	mcommªd_
;

73 
ušt32_t
 
	msize_
;

74 
kv•och_t
 
	m•och_
;

76 
size_t
 
size
() {

77  (
	mlog»c_•och
);

79 
size_t
 
¡Üe
(*
buf
, 
ušt32_t
 
commªd
, 
kv•och_t
 
•och
) {

81 
log»c_•och
 *
	mÌ
 = 
»š‹½»t_ÿ¡
<log»c_•och *>(
buf
);

82 
	mÌ
->
	mcommªd_
 = 
commªd
;

83 
	mÌ
->
	msize_
 = (*
Ì
);

84 
	mÌ
->
	m•och_
 = 
•och
;

85  (*
	mÌ
);

87 
boŞ
 
check
(cÚ¡ *
buf
) {

88 cÚ¡ 
log»c_•och
 *
	mÌ
 = 
»š‹½»t_ÿ¡
<cÚ¡†og»c_•och *>(
buf
);

89  
	mÌ
->
	msize_
 >ğ(*
Ì
);

93 
	slog»c_kv
 {

94 
ušt32_t
 
	mcommªd_
;

95 
ušt32_t
 
	msize_
;

96 
kvtime¡amp_t
 
	mts_
;

97 
ušt32_t
 
	mkeyËn_
;

98 
	mbuf_
[0];

100 
size_t
 
size
(
ušt32_t
 
keyËn
, ušt32_ˆ
v®Ën
) {

101  (
	mlog»c_kv
è+ 
	mkeyËn
 + 
	mv®Ën
;

103 
size_t
 
¡Üe
(*
buf
, 
ušt32_t
 
commªd
,

104 
SŒ
 
key
, SŒ 
v®
,

105 
kvtime¡amp_t
 
ts
) {

107 
log»c_kv
 *
	mÌ
 = 
»š‹½»t_ÿ¡
<log»c_kv *>(
buf
);

108 
	mÌ
->
	mcommªd_
 = 
commªd
;

109 
	mÌ
->
	msize_
 = (*
Ì
è+ 
key
.
Ën
 + 
v®
.len;

110 
	mÌ
->
	mts_
 = 
ts
;

111 
	mÌ
->
	mkeyËn_
 = 
key
.
Ën
;

112 
memıy
(
Ì
->
buf_
, 
key
.
s
, key.
Ën
);

113 
memıy
(
Ì
->
buf_
 + 
key
.
Ën
, 
v®
.
s
, val.len);

114  (*
	mÌ
è+ 
	mkey
.
	mËn
 + 
	mv®
.len;

116 
boŞ
 
check
(cÚ¡ *
buf
) {

117 cÚ¡ 
log»c_kv
 *
	mÌ
 = 
»š‹½»t_ÿ¡
<cÚ¡†og»c_kv *>(
buf
);

118  
	mÌ
->
	msize_
 >ğ(*
Ì
)

119 && 
Ì
->
size_
 >ğ(*Ìè+†r->
keyËn_
;

123 
	slog»c_kvd–
 {

124 
ušt32_t
 
	mcommªd_
;

125 
ušt32_t
 
	msize_
;

126 
kvtime¡amp_t
 
	mts_
;

127 
kvtime¡amp_t
 
	m´ev_ts_
;

128 
ušt32_t
 
	mkeyËn_
;

129 
	mbuf_
[0];

131 
size_t
 
size
(
ušt32_t
 
keyËn
, ušt32_ˆ
v®Ën
) {

132  (
	mlog»c_kvd–
è+ 
	mkeyËn
 + 
	mv®Ën
;

134 
size_t
 
¡Üe
(*
buf
, 
ušt32_t
 
commªd
,

135 
SŒ
 
key
, SŒ 
v®
,

136 
kvtime¡amp_t
 
´ev_ts
, kvtime¡amp_ˆ
ts
) {

138 
log»c_kvd–
 *
	mÌ
 = 
»š‹½»t_ÿ¡
<log»c_kvd– *>(
buf
);

139 
	mÌ
->
	mcommªd_
 = 
commªd
;

140 
	mÌ
->
	msize_
 = (*
Ì
è+ 
key
.
Ën
 + 
v®
.len;

141 
	mÌ
->
	mts_
 = 
ts
;

142 
	mÌ
->
	m´ev_ts_
 = 
´ev_ts
;

143 
	mÌ
->
	mkeyËn_
 = 
key
.
Ën
;

144 
memıy
(
Ì
->
buf_
, 
key
.
s
, key.
Ën
);

145 
memıy
(
Ì
->
buf_
 + 
key
.
Ën
, 
v®
.
s
, val.len);

146  (*
	mÌ
è+ 
	mkey
.
	mËn
 + 
	mv®
.len;

148 
boŞ
 
check
(cÚ¡ *
buf
) {

149 cÚ¡ 
log»c_kvd–
 *
	mÌ
 = 
»š‹½»t_ÿ¡
<cÚ¡†og»c_kvd– *>(
buf
);

150  
	mÌ
->
	msize_
 >ğ(*
Ì
)

151 && 
Ì
->
size_
 >ğ(*Ìè+†r->
keyËn_
;

156 
log£t
* 
	glog£t
::
	$make
(
size
) {

157 
	`¡©ic_as£¹
((
logšfo
è=ğ2 * 
CACHE_LINE_SIZE
, "unexpected sizeof(loginfo)");

158 
	`as£¹
(
size
 > 0 && size <= 64);

159 * 
x
 = 
Ãw
 [(
logšfo
è* 
size
 + Öogšfo::
log£t_šfo
è+ 
CACHE_LINE_SIZE
];

160 * 
ls_pos
 = 
x
 + (
logšfo
::
log£t_šfo
);

161 
ušŒ_t
 
Ëá
 = 
»š‹½»t_ÿ¡
<ušŒ_t>(
ls_pos
è% 
CACHE_LINE_SIZE
;

162 ià(
Ëá
)

163 
ls_pos
 +ğ
CACHE_LINE_SIZE
 - 
Ëá
;

164 
log£t
* 
ls
 = 
»š‹½»t_ÿ¡
<log£t*>(
ls_pos
);

165 
ls
->
li_
[-1].
lsi_
.
size_
 = 
size
;

166 
ls
->
li_
[-1].
lsi_
.
®loÿtiÚ_off£t_
 = (è(
x
 - 
ls_pos
);

167 
i
 = 0; i !ğ
size
; ++i)

168 
	`Ãw
((*è&
ls
->
li_
[
i
]è
	`logšfo
(ls, i);

169  
ls
;

170 
	}
}

172 
	glog£t
::
	$ä“
(
log£t
* 
ls
) {

173 
i
 = 0; i !ğ
ls
->
	`size
(); ++i)

174 
ls
->
li_
[
i
].~
	`logšfo
();

175 
d–‘e
[] (
»š‹½»t_ÿ¡
<*>(
ls
è+†s->
li_
[-1].
lsi_
.
®loÿtiÚ_off£t_
);

176 
	}
}

179 
	glogšfo
::
	$logšfo
(
log£t
* 
ls
, 
logšdex
) {

180 
f_
.
lock_
 = 0;

181 
f_
.
wa™šg_
 = 0;

182 
f_
.
f’ame_
 = 
	`SŒšg
().
	`š‹º®_»p
();

183 
f_
.
f’ame_
.
	`»f
();

185 
Ën_
 = 20 * 1024 * 1024;

186 
pos_
 = 0;

187 
buf_
 = (*è
	`m®loc
(
Ën_
);

188 
	`®ways_as£¹
(
buf_
);

189 
log_•och_
 = 0;

190 
qu›sûÁ_•och_
 = 0;

191 
wake_•och_
 = 0;

192 
æushed_•och_
 = 0;

194 
ti_
 = 0;

195 
f_
.
log£t_
 = 
ls
;

196 
logšdex_
 = 
logšdex
;

198 (è
·ddšg1_
;

199 
	}
}

201 
	glogšfo
::~
	$logšfo
() {

202 
f_
.
f’ame_
.
	`d”ef
();

203 
	`ä“
(
buf_
);

204 
	}
}

206 * 
	glogšfo
::
	$ŒampŞše
(* 
x
) {

207 
logšfo
* 
li
 = 
»š‹½»t_ÿ¡
<logšfo*>(
x
);

208 
li
->
ti_
->
	`±h»ad
(èğ
	`±h»ad_£lf
();

209  
li
->
	`run
();

210 
	}
}

212 
	glogšfo
::
	$š™Ÿlize
(cÚ¡ 
SŒšg
& 
logfe
) {

213 
	`as£¹
(!
ti_
);

215 
f_
.
f’ame_
.
	`d”ef
();

216 
f_
.
f’ame_
 = 
logfe
.
	`š‹º®_»p
();

217 
f_
.
f’ame_
.
	`»f
();

219 
ti_
 = 
th»adšfo
::
	`make
Ñh»adšfo::
TI_LOG
, 
logšdex_
);

220 
r
 = 
	`±h»ad_ü—‹
(&
ti_
->
	`±h»ad
(), 0, 
ŒampŞše
, 
this
);

221 
	`®ways_as£¹
(
r
 == 0);

222 
	}
}

225 
	$check_•och
() {

226 
timev®
 
tv
;

227 
	`g‘timeofday
(&
tv
, 0);

228 ià(
	`tim”cmp
(&
tv
, &
log_•och_time
, >)) {

229 
log_•och_time
 = 
tv
;

230 
	`tim”add
(&
log_•och_time
, &
log_•och_š‹rv®
, &log_epoch_time);

231 
glob®_log_•och
 = glob®_log_•och.
	`Ãxt_nÚz”o
();

233 
	}
}

235 * 
	glogšfo
::
	$run
() {

237 
log»¶ay
 
	`»¶ay”
(
f_
.
f’ame_
);

238 
»¶ay”
.
	`»¶ay
(
ti_
->
	`šdex
(),i_);

241 
fd
 = 
	`İ’
(
	`SŒšg
(
f_
.
f’ame_
).
	`c_¡r
(),

242 
O_WRONLY
 | 
O_APPEND
 | 
O_CREAT
, 0666);

243 
	`®ways_as£¹
(
fd
 >= 0);

244 *
x_buf
 = (*è
	`m®loc
(
Ën_
);

245 
	`®ways_as£¹
(
x_buf
);

248 
ušt32_t
 
nb
 = 0;

249 
	`acquœe
();

250 
kv•och_t
 
ge
 = 
glob®_log_•och
, 
we
 = 
glob®_wake_•och
;

251 ià(
wake_•och_
 !ğ
we
) {

252 
wake_•och_
 = 
we
;

253 
qu›sûÁ_•och_
 = 0;

258 ià(!
»cov”šg
 && 
pos_
 =ğ0 && !
qu›sûÁ_•och_


259 && 
ge
 !ğ
log_•och_
 && g!ğ
we
 && !
f_
.
wa™šg_
) {

260 
qu›sûÁ_•och_
 = 
log_•och_
 = 
ge
;

261 *
p
 = 
buf_
;

262 
p
 +ğ
log»c_•och
::
	`¡Üe
Õ, 
logcmd_•och
, 
log_•och_
);

263 ià(
log_•och_
 =ğ
wake_•och_
)

264 
p
 +ğ
log»c_ba£
::
	`¡Üe
Õ, 
logcmd_wake
);

265 
p
 +ğ
log»c_ba£
::
	`¡Üe
Õ, 
logcmd_qu›sû
);

266 
pos_
 = 
p
 - 
buf_
;

268 ià(!
»cov”šg
 && 
pos_
 > 0) {

269 
ušt32_t
 
x_pos
 = 
pos_
;

270 
¡d
::
	`sw­
(
buf_
, 
x_buf
);

271 
pos_
 = 0;

272 
kv•och_t
 
x_•och
 = 
log_•och_
;

273 
	`»Ëa£
();

274 
ssize_t
 
r
 = 
	`wr™e
(
fd
, 
x_buf
, 
x_pos
);

275 
	`®ways_as£¹
(
r
 =ğ
	`ssize_t
(
x_pos
));

276 
	`fsync
(
fd
);

277 
æushed_•och_
 = 
x_•och
;

279 
nb
 = 
x_pos
;

281 
	`»Ëa£
();

282 ià(
nb
 < 
Ën_
 / 4)

283 
	`Çpms
(200);

284 ià(
ti_
->
	`šdex
() == 0)

285 
	`check_•och
();

289 
	}
}

294 
	glogšfo
::
	$»cÜd
(
commªd
, cÚ¡ 
qu”y_times
& 
qtimes
,

295 
SŒ
 
key
, SŒ 
v®ue
) {

296 
	`as£¹
(!
»cov”šg
);

297 
size_t
 
n
 = 
log»c_kvd–
::
	`size
(
key
.
Ën
, 
v®ue
.len)

298 + 
log»c_•och
::
	`size
(è+ 
log»c_ba£
::size();

299 
wa™li¡
 
wa™
 = { &wait };

300 
¡®ls
 = 0;

302 ià(
Ën_
 - 
pos_
 >ğ
n


303 && (
wa™
.
Ãxt
 =ğ&wa™ || 
f_
.
wa™šg_
 == &wait)) {

304 
kv•och_t
 
we
 = 
glob®_wake_•och
;

307 ià(
qtimes
.
•och
 !ğ
log_•och_
) {

308 
log_•och_
 = 
qtimes
.
•och
;

309 
pos_
 +ğ
log»c_•och
::
	`¡Üe
(
buf_
 +…os_, 
logcmd_•och
, 
qtimes
.
•och
);

312 ià(
qu›sûÁ_•och_
) {

317 ià(
æushed_•och_
 =ğ
qu›sûÁ_•och_
)

318 
æushed_•och_
 = 
qtimes
.
•och
;

319 
qu›sûÁ_•och_
 = 0;

320 
we
 < 
qtimes
.
•och
)

321 
we
 = 
	`cmpxchg
(&
glob®_wake_•och
, we, 
qtimes
.
•och
);

329 ià(
we
 !ğ
wake_•och_
 && 
qtimes
.
•och
 < we)

330 
we
 = 
qtimes
.
•och
;

331 ià(
we
 !ğ
wake_•och_
) {

332 
wake_•och_
 = 
we
;

333 
pos_
 +ğ
log»c_ba£
::
	`¡Üe
(
buf_
 +…os_, 
logcmd_wake
);

336 ià(
commªd
 =ğ
logcmd_put
 && 
qtimes
.
´ev_ts


337 && !(
qtimes
.
´ev_ts
 & 1))

338 
pos_
 +ğ
log»c_kvd–
::
	`¡Üe
(
buf_
 +…os_,

339 
logcmd_modify
, 
key
, 
v®ue
,

340 
qtimes
.
´ev_ts
, qtimes.
ts
);

342 
pos_
 +ğ
log»c_kv
::
	`¡Üe
(
buf_
 +…os_,

343 
commªd
, 
key
, 
v®ue
, 
qtimes
.
ts
);

345 ià(
f_
.
wa™šg_
 =ğ&
wa™
)

346 
f_
.
wa™šg_
 = 
wa™
.
Ãxt
;

347 
	`»Ëa£
();

352 ià(
wa™
.
Ãxt
 == &wait) {

353 
wa™li¡
** 
p
 = &
f_
.
wa™šg_
;

354 *
p
)

355 
p
 = &(*p)->
Ãxt
;

356 *
p
 = &
wa™
;

357 
wa™
.
Ãxt
 = 0;

359 
	`»Ëa£
();

360 ià(
¡®ls
 == 0)

361 
	`´štf
("stall\n");

362 ià(
¡®ls
 % 25 == 0)

363 
	`´štf
("¡®È%d\n", 
¡®ls
);

364 ++
¡®ls
;

365 
	`Çpms
(50);

366 
	`acquœe
();

368 
	}
}

370 
	glogšfo
::
	$»cÜd
(
commªd
, cÚ¡ 
qu”y_times
& 
qtimes
, 
SŒ
 
key
,

371 cÚ¡ 
lcdf
::
JsÚ
* 
»q
, cÚ¡†cdf::JsÚ* 
’d_»q
) {

372 
lcdf
::
SŒšgAccum
 
	`§
(128);

373 
msg·ck
::
uÅ¬£r
<
lcdf
::
SŒšgAccum
> 
	`cu
(
§
);

374 
cu
.
	`wr™e_¬¿y_h—d”
(
’d_»q
 - 
»q
);

375 ; 
»q
 !ğ
’d_»q
; ++req)

376 
cu
 << *
»q
;

377 
	`»cÜd
(
commªd
, 
qtimes
, 
key
, 
	`SŒ
(
§
.
	`d©a
(), sa.
	`Ëngth
()));

378 
	}
}

383 
	glog»¶ay
::
	$log»¶ay
(cÚ¡ 
SŒšg
 &
f’ame
)

384 : 
	`f’ame_
(
f’ame
), 
	`”ºo_
(0), 
	$buf_
()

386 
fd
 = 
	`İ’
(
f’ame_
.
	`c_¡r
(), 
O_RDONLY
);

387 ià(
fd
 == -1) {

388 
ç
:

389 
”ºo_
 = 
”ºo
;

390 
buf_
 = 0;

391 ià(
fd
 != -1)

392 (è
	`şo£
(
fd
);

396 
¡©
 
sb
;

397 
r
 = 
	`f¡©
(
fd
, &
sb
);

398 ià(
r
 == -1)

399 
ç
;

401 
size_
 = 
sb
.
¡_size
;

402 ià(
size_
 != 0) {

405 
buf_
 = (*è::
	`mm­
(0, 
size_
, 
PROT_READ
, 
MAP_FILE
 | 
MAP_PRIVATE
,

406 
fd
, 0);

407 ià(
buf_
 =ğ
MAP_FAILED
)

408 
ç
;

411 (è
	`şo£
(
fd
);

412 
	}
}

414 
	glog»¶ay
::~
	$log»¶ay
()

416 
	`unm­
();

417 
	}
}

420 
	glog»¶ay
::
	$unm­
()

422 
r
 = 0;

423 ià(
buf_
) {

424 
r
 = 
	`munm­
(
buf_
, 
size_
);

425 
buf_
 = 0;

427  
r
;

428 
	}
}

431 
	slog»cÜd
 {

432 
ušt32_t
 
	mcommªd
;

433 
SŒ
 
	mkey
;

434 
SŒ
 
	mv®
;

435 
kvtime¡amp_t
 
	mts
;

436 
kvtime¡amp_t
 
	m´ev_ts
;

437 
kv•och_t
 
	m•och
;

439 cÚ¡ *
exŒaù
(cÚ¡ *
buf
, cÚ¡ *
’d
);

441 
	m‹m¶©e
 <
ty³Çme
 
	mT
>

442 
run
(
T
& 
bË
, 
¡d
::
veùÜ
<
lcdf
::
JsÚ
>& 
j»po
, 
th»adšfo
& 
ti
);

444 
	m´iv©e
:

445 
šlše
 
­¶y
(
row_ty³
*& 
v®ue
, 
boŞ
 
found
,

446 
¡d
::
veùÜ
<
lcdf
::
JsÚ
>& 
j»po
, 
th»adšfo
& 
ti
);

450 
	glog»cÜd
::
	$exŒaù
(cÚ¡ *
buf
, cÚ¡ *
’d
)

452 cÚ¡ 
log»c_ba£
 *
Ì
 = 
»š‹½»t_ÿ¡
<cÚ¡†og»c_ba£ *>(
buf
);

453 ià(
	`uÆik–y
(
	`size_t
(
’d
 - 
buf
è< (*
Ì
)

454 || 
Ì
->
size_
 < (*lr)

455 || 
	`size_t
(
’d
 - 
buf
è< 
Ì
->
size_


456 || 
Ì
->
commªd_
 =ğ
logcmd_nÚe
)) {

457 
ç
:

458 
commªd
 = 
logcmd_nÚe
;

459  
’d
;

462 
commªd
 = 
Ì
->
commªd_
;

463 ià(
commªd
 =ğ
logcmd_put
 || commªd =ğ
logcmd_»¶aû


464 || 
commªd
 =ğ
logcmd_»move
) {

465 cÚ¡ 
log»c_kv
 *
lk
 = 
»š‹½»t_ÿ¡
<cÚ¡†og»c_kv *>(
buf
);

466 ià(
	`uÆik–y
(
lk
->
size_
 < (*lk)

467 || 
lk
->
keyËn_
 > 
MASSTREE_MAXKEYLEN


468 || (*
lk
è+†k->
keyËn_
 >†k->
size_
))

469 
ç
;

470 
ts
 = 
lk
->
ts_
;

471 
key
.
	`assign
(
lk
->
buf_
,†k->
keyËn_
);

472 
v®
.
	`assign
(
lk
->
buf_
 +†k->
keyËn_
,†k->
size_
 - (*lk) -†k->keylen_);

473 } ià(
commªd
 =ğ
logcmd_modify
) {

474 cÚ¡ 
log»c_kvd–
 *
lk
 = 
»š‹½»t_ÿ¡
<cÚ¡†og»c_kvd– *>(
buf
);

475 ià(
	`uÆik–y
(
lk
->
keyËn_
 > 
MASSTREE_MAXKEYLEN


476 || (*
lk
è+†k->
keyËn_
 >†k->
size_
))

477 
ç
;

478 
ts
 = 
lk
->
ts_
;

479 
´ev_ts
 = 
lk
->
´ev_ts_
;

480 
key
.
	`assign
(
lk
->
buf_
,†k->
keyËn_
);

481 
v®
.
	`assign
(
lk
->
buf_
 +†k->
keyËn_
,†k->
size_
 - (*lk) -†k->keylen_);

482 } ià(
commªd
 =ğ
logcmd_•och
) {

483 cÚ¡ 
log»c_•och
 *
Ìe
 = 
»š‹½»t_ÿ¡
<cÚ¡†og»c_•och *>(
buf
);

484 ià(
	`uÆik–y
(
Ìe
->
size_
 < 
log»c_•och
::
	`size
()))

485 
ç
;

486 
•och
 = 
Ìe
->
•och_
;

489  
buf
 + 
Ì
->
size_
;

490 
	}
}

492 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

493 
	glog»cÜd
::
run
(
T
& 
bË
, 
¡d
::
veùÜ
<
lcdf
::
JsÚ
>& 
j»po
, 
th»adšfo
& 
ti
) {

494 
row_m¬k”
 
	gm
;

495 ià(
	gcommªd
 =ğ
logcmd_»move
) {

496 
ts
 |= 1;

497 
	gm
.
	gm¬k”_ty³_
 = 
row_m¬k”
::
mt_»move
;

498 
	gv®
 = 
SŒ
((cÚ¡ *è&
m
, (m));

501 
ty³Çme
 
	gT
::
cursÜ_ty³
 
Í
(
bË
, 
key
);

502 
boŞ
 
	gfound
 = 
Í
.
fšd_š£¹
(
ti
);

503 ià(!
	gfound
)

504 
	gti
.
ob£rve_phªtoms
(
Í
.
node
());

505 
­¶y
(
Í
.
v®ue
(), 
found
, 
j»po
, 
ti
);

506 
	gÍ
.
fšish
(1, 
ti
);

509 
	glcdf
::
JsÚ
* 
·r£_chªge£t
(
SŒ
 
chªge£t
,

510 
¡d
::
veùÜ
<
lcdf
::
JsÚ
>& 
j»po
) {

511 
msg·ck
::
·r£r
 
mp
(
chªge£t
.
ud©a
());

512 
	gšdex
 = 0;

513 
SŒ
 
	gv®ue
;

514 
size_t
 
	gpos
 = 0;

515 
	gmp
.
pos™iÚ
(è!ğ
chªge£t
.
’d
()) {

516 ià(
pos
 =ğ
j»po
.
size
())

517 
j»po
.
»size
(
pos
 + 2);

518 
	gmp
 >> 
	gšdex
 >> 
	gv®ue
;

519 
	gj»po
[
pos
] = 
šdex
;

520 
	gj»po
[
pos
 + 1] = 
SŒšg
::
make_¡abË
(
v®ue
);

521 
	gpos
 += 2;

523  
	gj»po
.
d©a
(è+ 
	gpos
;

526 
šlše
 
	glog»cÜd
::
­¶y
(
row_ty³
*& 
v®ue
, 
boŞ
 
found
,

527 
¡d
::
veùÜ
<
lcdf
::
JsÚ
>& 
j»po
, 
th»adšfo
& 
ti
) {

528 
row_ty³
** 
	gcur_v®ue
 = &
v®ue
;

529 ià(!
	gfound
)

530 *
	gcur_v®ue
 = 0;

533 *
	gcur_v®ue
 && 
row_is_d–_m¬k”
(*
cur_v®ue
)

534 && (*
	gcur_v®ue
)->
time¡amp
(è> 
	gts
)

535 
	gcur_v®ue
 = &
row_g‘_d–_m¬k”
(*
cur_v®ue
)->
´ev_
;

538 ià(*
	gcur_v®ue
 && (*cur_v®ue)->
time¡amp
(è>ğ
ts
)

542 ià(
	gcommªd
 !ğ
logcmd_modify
)

543 
row_ty³
* 
Şd_v®ue
 = *
cur_v®ue
) {

544 ià(
row_is_d–_m¬k”
(
Şd_v®ue
)) {

545 
ti
.
m¬k
(
tc_»¶ay_»move_d–
);

546 *
	gcur_v®ue
 = 
row_g‘_d–_m¬k”
(
Şd_v®ue
)->
´ev_
;

548 *
	gcur_v®ue
 = 0;

549 
	gŞd_v®ue
->
d—Îoÿ‹
(
ti
);

553 ià(
	gcommªd
 =ğ
logcmd_»¶aû
)

554 *
cur_v®ue
 = 
row_ty³
::
ü—‹1
(
v®
, 
ts
, 
ti
);

555 ià(
	gcommªd
 !ğ
logcmd_modify


556 || (*
cur_v®ue
 && (*cur_v®ue)->
time¡amp
(è=ğ
´ev_ts
)) {

557 
lcdf
::
JsÚ
* 
’d_»q
 = 
·r£_chªge£t
(
v®
, 
j»po
);

558 ià(
	gcommªd
 !ğ
logcmd_modify
)

559 *
cur_v®ue
 = 
row_ty³
::
ü—‹
(
j»po
.
d©a
(), 
’d_»q
, 
ts
, 
ti
);

561 
row_ty³
* 
	gŞd_v®ue
 = *
cur_v®ue
;

562 *
	gcur_v®ue
 = 
Şd_v®ue
->
upd©e
(
j»po
.
d©a
(), 
’d_»q
, 
ts
, 
ti
);

563 ià(*
	gcur_v®ue
 !ğ
Şd_v®ue
)

564 
Şd_v®ue
->
d—Îoÿ‹
(
ti
);

569 
	gv®
.
	gs
 -ğ(
row_d–_m¬k”
<
row_ty³
>);

570 
	gv®
.
	gËn
 +ğ(
row_d–_m¬k”
<
row_ty³
>);

571 
row_ty³
* 
	gÃw_v®ue
 =„ow_ty³::
ü—‹1
(
v®
, 
ts
 | 1, 
ti
);

572 
	grow_d–_m¬k”
<
	grow_ty³
>* 
	gdm
 = 
row_g‘_d–_m¬k”
(
Ãw_v®ue
, 
Œue
);

573 
	gdm
->
	gm¬k”_ty³_
 = 
row_m¬k”
::
mt_d–
;

574 
	gdm
->
	g´ev_ts_
 = 
´ev_ts
;

575 
	gdm
->
	g´ev_
 = *
cur_v®ue
;

576 *
	gcur_v®ue
 = 
Ãw_v®ue
;

577 
	gti
.
m¬k
(
tc_»¶ay_ü—‹_d–
);

581 
	gv®ue
 && 
row_is_d–_m¬k”
(
v®ue
)) {

582 
row_ty³
 **
	g´ev
 = 0, **
	gŒav
 = &
v®ue
;

583 *
	gŒav
 && 
row_is_d–_m¬k”
(*
Œav
)) {

584 
	g´ev
 = 
Œav
;

585 
	gŒav
 = &
row_g‘_d–_m¬k”
(*
Œav
)->
´ev_
;

587 ià(
	g´ev
 && *
	gŒav


588 && 
row_g‘_d–_m¬k”
(*
´ev
)->
	g´ev_ts_
 =ğ(*
Œav
)->
time¡amp
()) {

589 
row_ty³
 *
Şd_´ev
 = *
´ev
;

590 
SŒ
 
	g»q
 = 
Şd_´ev
->
cŞ
(0);

591 
	g»q
.
	gs
 +ğ(
row_d–_m¬k”
<
row_ty³
>);

592 
	g»q
.
	gËn
 -ğ(
row_d–_m¬k”
<
row_ty³
>);

593 cÚ¡ 
	glcdf
::
JsÚ
* 
’d_»q
 = 
·r£_chªge£t
(
»q
, 
j»po
);

594 *
	g´ev
 = (*
Œav
)->
upd©e
(
j»po
.
d©a
(), 
’d_»q
, 
Şd_´ev
->
time¡amp
(è- 1, 
ti
);

595 ià(*
	g´ev
 !ğ*
Œav
)

596 (*
Œav
)->
d—Îoÿ‹
(
ti
);

597 
	gŞd_´ev
->
d—Îoÿ‹
(
ti
);

598 
	gti
.
m¬k
(
tc_»¶ay_»move_d–
);

605 
	glog»¶ay
::
šfo_ty³


606 
log»¶ay
::
	$šfo
() const

608 
šfo_ty³
 
x
;

609 
x
.
fœ¡_•och
 = x.
Ï¡_•och
 = x.
wake_•och
 = x.
mš_po¡_qu›sûÁ_wake_•och
 = 0;

610 
x
.
qu›sûÁ
 = 
Œue
;

612 cÚ¡ *
buf
 = 
buf_
, *
’d
 = buf_ + 
size_
;

613 
off_t
 
Ä
 = 0;

614 
boŞ
 
log_cÜru±
 = 
çl£
;

615 
buf
 + (
log»c_ba£
è<ğ
’d
) {

616 cÚ¡ 
log»c_ba£
 *
Ì
 = 
»š‹½»t_ÿ¡
<cÚ¡†og»c_ba£ *>(
buf
);

617 ià(
	`uÆik–y
(
Ì
->
size_
 < (
log»c_ba£
))) {

618 
log_cÜru±
 = 
Œue
;

620 } ià(
	`uÆik–y
(
buf
 + 
Ì
->
size_
 > 
’d
))

622 
x
.
qu›sûÁ
 = 
Ì
->
commªd_
 =ğ
logcmd_qu›sû
;

623 ià(
Ì
->
commªd_
 =ğ
logcmd_•och
) {

624 cÚ¡ 
log»c_•och
 *
Ìe
 =

625 
»š‹½»t_ÿ¡
<cÚ¡ 
log»c_•och
 *>(
buf
);

626 ià(
	`uÆik–y
(
Ìe
->
size_
 < (*lre))) {

627 
log_cÜru±
 = 
Œue
;

630 ià(!
x
.
fœ¡_•och
)

631 
x
.
fœ¡_•och
 = 
Ìe
->
•och_
;

632 
x
.
Ï¡_•och
 = 
Ìe
->
•och_
;

633 ià(
x
.
wake_•och
 && x.wake_•och > x.
Ï¡_•och
)

634 
x
.
wake_•och
 = 0;

635 } ià(
Ì
->
commªd_
 =ğ
logcmd_wake
)

636 
x
.
wake_•och
 = x.
Ï¡_•och
;

637 #ià!
NDEBUG


638 ià(
Ì
->
commªd_
 !ğ
logcmd_put


639 && 
Ì
->
commªd_
 !ğ
logcmd_»¶aû


640 && 
Ì
->
commªd_
 !ğ
logcmd_modify


641 && 
Ì
->
commªd_
 !ğ
logcmd_»move


642 && 
Ì
->
commªd_
 !ğ
logcmd_qu›sû
) {

643 
log_cÜru±
 = 
Œue
;

647 
buf
 +ğ
Ì
->
size_
;

648 ++
Ä
;

651 
	`årštf
(
¡d”r
, "»¶ay %s: %" 
PRIdOFF_T
 "„ecÜds, fœ¡ %" 
PRIu64
 ",†ast %" PRIu64 ", wake %" PRIu64 "%s%s @%zu\n",

652 
f’ame_
.
	`c_¡r
(), 
Ä
, 
x
.
fœ¡_•och
.
	`v®ue
(),

653 
x
.
Ï¡_•och
.
	`v®ue
(), x.
wake_•och
.value(),

654 
x
.
qu›sûÁ
 ? ", quiescent" : "",

655 
log_cÜru±
 ? ", CORRUPT" : "", 
buf
 - 
buf_
);

656  
x
;

657 
	}
}

659 
kv•och_t


660 
	glog»¶ay
::
	$mš_po¡_qu›sûÁ_wake_•och
(
kv•och_t
 
qu›sûÁ_•och
) const

662 
kv•och_t
 
e
 = 0;

663 cÚ¡ *
buf
 = 
buf_
, *
’d
 = buf_ + 
size_
;

664 
boŞ
 
log_cÜru±
 = 
çl£
;

665 
buf
 + (
log»c_ba£
è<ğ
’d
) {

666 cÚ¡ 
log»c_ba£
 *
Ì
 = 
»š‹½»t_ÿ¡
<cÚ¡†og»c_ba£ *>(
buf
);

667 ià(
	`uÆik–y
(
Ì
->
size_
 < (
log»c_ba£
))) {

668 
log_cÜru±
 = 
Œue
;

670 } ià(
	`uÆik–y
(
buf
 + 
Ì
->
size_
 > 
’d
))

672 ià(
Ì
->
commªd_
 =ğ
logcmd_•och
) {

673 cÚ¡ 
log»c_•och
 *
Ìe
 =

674 
»š‹½»t_ÿ¡
<cÚ¡ 
log»c_•och
 *>(
buf
);

675 ià(
	`uÆik–y
(
Ìe
->
size_
 < (*lre))) {

676 
log_cÜru±
 = 
Œue
;

679 
e
 = 
Ìe
->
•och_
;

680 } ià(
Ì
->
commªd_
 =ğ
logcmd_wake


681 && 
e


682 && 
e
 >ğ
qu›sûÁ_•och
)

683  
e
;

684 
buf
 +ğ
Ì
->
size_
;

686 (è
log_cÜru±
;

688 
	}
}

690 
ušt64_t


691 
	glog»¶ay
::
	$»¶ayªdş—n1
(
kv•och_t
 
mš_•och
, kv•och_ˆ
max_•och
,

692 
th»adšfo
 *
ti
)

694 
ušt64_t
 
Ä
 = 0;

695 cÚ¡ *
pos
 = 
buf_
, *
’d
 = buf_ + 
size_
;

696 cÚ¡ *
»pbegš
 = 0, *
»³nd
 = 0;

697 
log»cÜd
 
Ì
;

698 
¡d
::
veùÜ
<
lcdf
::
JsÚ
> 
j»po
;

701 
pos
 < 
’d
) {

702 cÚ¡ *
Ãxos
 = 
Ì
.
	`exŒaù
(
pos
, 
’d
);

703 ià(
Ì
.
commªd
 =ğ
logcmd_nÚe
) {

704 
	`årštf
(
¡d”r
, "»¶ay %s: %" 
PRIu64
 "ƒntries„eplayed, CORRUPT @%zu\n",

705 
f’ame_
.
	`c_¡r
(), 
Ä
, 
pos
 - 
buf_
);

708 ià(
Ì
.
commªd
 =ğ
logcmd_•och
) {

709 ià((
mš_•och
 && 
Ì
.
•och
 < min_epoch)

710 || (!
mš_•och
 && !
»pbegš
))

711 
»pbegš
 = 
pos
;

712 ià(
Ì
.
•och
 >ğ
max_•och
) {

713 
	`®ways_as£¹
(
»pbegš
);

714 
»³nd
 = 
Ãxos
;

718 ià(!
Ì
.
•och
 || (
mš_•och
 &&†r.epoch < min_epoch)) {

719 
pos
 = 
Ãxos
;

720 ià(
»pbegš
)

721 
»³nd
 = 
Ãxos
;

727 
	`as£¹
(
»pbegš
);

728 
»³nd
 = 
Ãxos
;

729 ià(
Ì
.
key
.
Ën
) {

730 ià(
Ì
.
commªd
 =ğ
logcmd_put


731 || 
Ì
.
commªd
 =ğ
logcmd_»¶aû


732 || 
Ì
.
commªd
 =ğ
logcmd_modify


733 || 
Ì
.
commªd
 =ğ
logcmd_»move
)

734 
Ì
.
	`run
(
Œ“
->
	`bË
(), 
j»po
, *
ti
);

735 ++
Ä
;

736 ià(
Ä
 % 100000 == 0)

737 
	`årštf
(
¡d”r
,

738 "»¶ay %s: %" 
PRIu64
 "ƒntries„eplayed\n",

739 
f’ame_
.
	`c_¡r
(), 
Ä
);

742 
pos
 = 
Ãxos
;

746 ià(!
»pbegš
)

747 
»pbegš
 = 
»³nd
 = 
buf_
;

748 ià(!
»³nd
) {

749 
	`årštf
(
¡d”r
, "»¶ay %s: su½ri£„•’d\n", 
f’ame_
.
	`c_¡r
());

750 
»³nd
 = 
pos
;

753 
tm¶og
[256];

754 
r
 = 
	`¢´štf
(
tm¶og
, Ñm¶og), "%s.tmp", 
f’ame_
.
	`c_¡r
());

755 
	`®ways_as£¹
(
r
 >ğ0 && 
	`size_t
Ôè< (
tm¶og
));

757 
	`´štf
("»¶ay %s:runÿ‹ from %" 
PRIdOFF_T
 "Ø%" 
PRIdSIZE_T
 " [%" PRIdSIZE_T ",%" PRIdSIZE_T ")\n",

758 
f’ame_
.
	`c_¡r
(), 
size_
, 
»³nd
 - 
»pbegš
,

759 
»pbegš
 - 
buf_
, 
»³nd
 - buf_);

761 
boŞ
 
Ãed_cİy
 = 
»pbegš
 !ğ
buf_
;

762 
fd
;

763 ià(!
Ãed_cİy
)

764 
fd
 = 
	`»¶ay_Œunÿ‹
(
»³nd
 - 
»pbegš
);

766 
fd
 = 
	`»¶ay_cİy
(
tm¶og
, 
»pbegš
, 
»³nd
);

768 
r
 = 
	`fsync
(
fd
);

769 
	`®ways_as£¹
(
r
 == 0);

770 
r
 = 
	`şo£
(
fd
);

771 
	`®ways_as£¹
(
r
 == 0);

774 ià(
	`unm­
() != 0)

775 
	`abÜt
();

777 ià(
Ãed_cİy
) {

778 
r
 = 
	`»Çme
(
tm¶og
, 
f’ame_
.
	`c_¡r
());

779 ià(
r
 != 0) {

780 
	`årštf
(
¡d”r
, "»¶ay %s: %s\n", 
f’ame_
.
	`c_¡r
(), 
	`¡»¼Ü
(
”ºo
));

781 
	`abÜt
();

785  
Ä
;

786 
	}
}

789 
	glog»¶ay
::
	$»¶ay_Œunÿ‹
(
size_t
 
Ën
)

791 
fd
 = 
	`İ’
(
f’ame_
.
	`c_¡r
(), 
O_RDWR
);

792 ià(
fd
 < 0) {

793 
	`årštf
(
¡d”r
, "»¶ay %s: %s\n", 
f’ame_
.
	`c_¡r
(), 
	`¡»¼Ü
(
”ºo
));

794 
	`abÜt
();

797 
¡©
 
sb
;

798 
r
 = 
	`f¡©
(
fd
, &
sb
);

799 ià(
r
 != 0) {

800 
	`årštf
(
¡d”r
, "»¶ay %s: %s\n", 
f’ame_
.
	`c_¡r
(), 
	`¡»¼Ü
(
”ºo
));

801 
	`abÜt
();

802 } ià(
sb
.
¡_size
 < 
	`off_t
(
Ën
)) {

803 
	`årštf
(
¡d”r
, "»¶ay %s: bad†’gth %" 
PRIdOFF_T
 "\n", 
f’ame_
.
	`c_¡r
(), 
sb
.
¡_size
);

804 
	`abÜt
();

807 
r
 = 
	`árunÿ‹
(
fd
, 
Ën
);

808 ià(
r
 != 0) {

809 
	`årštf
(
¡d”r
, "»¶ay %s:runÿ‹: %s\n", 
f’ame_
.
	`c_¡r
(), 
	`¡»¼Ü
(
”ºo
));

810 
	`abÜt
();

813 
off_t
 
off
 = 
	`l£ek
(
fd
, 
Ën
, 
SEEK_SET
);

814 ià(
off
 =ğ(
off_t
) -1) {

815 
	`årštf
(
¡d”r
, "»¶ay %s: s“k: %s\n", 
f’ame_
.
	`c_¡r
(), 
	`¡»¼Ü
(
”ºo
));

816 
	`abÜt
();

819  
fd
;

820 
	}
}

823 
	glog»¶ay
::
	$»¶ay_cİy
(cÚ¡ *
tm²ame
, cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
)

825 
fd
 = 
	`ü—t
(
tm²ame
, 0666);

826 ià(
fd
 < 0) {

827 
	`årštf
(
¡d”r
, "»¶ay %s: c»©e: %s\n", 
tm²ame
, 
	`¡»¼Ü
(
”ºo
));

828 
	`abÜt
();

831 
ssize_t
 
w
 = 
	`§ã_wr™e
(
fd
, 
fœ¡
, 
Ï¡
 - first);

832 
	`®ways_as£¹
(
w
 >ğ0 && w =ğ
Ï¡
 - 
fœ¡
);

834  
fd
;

835 
	}
}

838 
	glog»¶ay
::
	$»¶ay
(
which
, 
th»adšfo
 *
ti
)

840 
	`wa™uÁpha£
(
REC_LOG_TS
);

842 ià(
buf_
) {

843 
šfo_ty³
 
x
 = 
	`šfo
();

844 
	`±h»ad_mu‹x_lock
(&
»c_mu
);

845 
»c_log_šfos
[
which
] = 
x
;

846 
	`±h»ad_mu‹x_uÆock
(&
»c_mu
);

848 
	`šaùive
();

850 
	`wa™uÁpha£
(
REC_LOG_ANALYZE_WAKE
);

851 ià(
buf_
) {

852 ià(
»c_»¶ay_mš_qu›sûÁ_Ï¡_•och


853 && 
»c_»¶ay_mš_qu›sûÁ_Ï¡_•och
 <ğ
»c_log_šfos
[
which
].
wake_•och
)

854 
»c_log_šfos
[
which
].
mš_po¡_qu›sûÁ_wake_•och
 =

855 
	`mš_po¡_qu›sûÁ_wake_•och
(
»c_»¶ay_mš_qu›sûÁ_Ï¡_•och
);

857 
	`šaùive
();

859 
	`wa™uÁpha£
(
REC_LOG_REPLAY
);

860 ià(
buf_
) {

861 
ti
->
	`rcu_¡¬t
();

862 
ušt64_t
 
Ä
 = 
	`»¶ayªdş—n1
(
»c_»¶ay_mš_•och
, 
»c_»¶ay_max_•och
, 
ti
);

863 
ti
->
	`rcu_¡İ
();

864 
	`´štf
("»cov”ed %" 
PRIu64
 "„ecÜd äom %s\n", 
Ä
, 
f’ame_
.
	`c_¡r
());

866 
	`šaùive
();

867 
	}
}

	@masstree-beta/log.hh

16 #iâdeà
MASSTREE_LOG_HH


17 
	#MASSTREE_LOG_HH


	)

18 
	~"kvth»ad.hh
"

19 
	~"¡ršg.hh
"

20 
	~"kv´Ùo.hh
"

21 
	~"¡r.hh
"

22 
	~<±h»ad.h
>

23 
şass
 
	glog£t
;

24 
usšg
 
	glcdf
::
SŒ
;

25 
Çme¥aû
 
	glcdf
 { 
şass
 
	gJsÚ
; }

29 şas 
	clogšfo
 {

30 
	mpublic
:

31 
š™Ÿlize
(cÚ¡ 
lcdf
::
SŒšg
& 
logfe
);

33 
šlše
 
acquœe
();

34 
šlše
 
»Ëa£
();

36 
šlše
 
kv•och_t
 
	$æushed_•och
() const;

37 
šlše
 
boŞ
 
	$qu›sûÁ
() const;

40 
	squ”y_times
 {

41 
kv•och_t
 
•och
;

42 
kvtime¡amp_t
 
ts
;

43 
kvtime¡amp_t
 
´ev_ts
;

46 
	`»cÜd
(
commªd
, cÚ¡ 
qu”y_times
& 
qt
, 
SŒ
 
key
, SŒ 
v®ue
);

47 
	`»cÜd
(
commªd
, cÚ¡ 
qu”y_times
& 
qt
, 
SŒ
 
key
,

48 cÚ¡ 
lcdf
::
JsÚ
* 
»q
, cÚ¡†cdf::JsÚ* 
’d_»q
);

50 
´iv©e
:

51 
	swa™li¡
 {

52 
wa™li¡
* 
Ãxt
;

53 
	}
};

54 
	säÚt
 {

55 
ušt32_t
 
	glock_
;

56 
wa™li¡
* 
	gwa™šg_
;

57 
	glcdf
::
SŒšg
::
»p_ty³
 
f’ame_
;

58 
log£t
* 
	glog£t_
;

60 
	slog£t_šfo
 {

61 
št32_t
 
	gsize_
;

62 
	g®loÿtiÚ_off£t_
;

65 
äÚt
 
	gf_
;

66 
	g·ddšg1_
[
CACHE_LINE_SIZE
 - (
äÚt
)];

68 
kv•och_t
 
	glog_•och_
;

69 
kv•och_t
 
	gqu›sûÁ_•och_
;

70 
kv•och_t
 
	gwake_•och_
;

71 
kv•och_t
 
	gæushed_•och_
;

75 *
	gbuf_
;

76 
ušt32_t
 
	gpos_
;

77 
ušt32_t
 
	gËn_
;

87 
th»adšfo
 *
	gti_
;

88 
	glogšdex_
;

91 
	gÿche_lše_2_
[
CACHE_LINE_SIZE
 - 4 * (
kv•och_t
è- (
log£t_šfo
)];

92 
log£t_šfo
 
	glsi_
;

96 
logšfo
(
log£t
* 
ls
, 
logšdex
);

97 ~
logšfo
();

98 * 
run
();

99 * 
ŒampŞše
(*);

101 
ä›nd
 
şass
 
	glog£t
;

104 şas 
	clog£t
 {

105 
	mpublic
:

106 
log£t
* 
make
(
size
);

107 
ä“
(
log£t
* 
ls
);

109 
šlše
 
	$size
() const;

110 
šlše
 
logšfo
& 
	`log
(
i
);

111 
šlše
 cÚ¡ 
logšfo
& 
	$log
(
i
) const;

113 
´iv©e
:

114 
logšfo
 
li_
[0];

117 
kv•och_t
 
glob®_log_•och
;

118 
kv•och_t
 
glob®_wake_•och
;

119 
timev®
 
log_•och_š‹rv®
;

121 
	elogcommªd
 {

122 
logcmd_nÚe
 = 0,

123 
logcmd_put
 = 0x5455506B,

124 
logcmd_»¶aû
 = 0x3155506B,

125 
logcmd_modify
 = 0x444F4D6B,

126 
logcmd_»move
 = 0x4D45526B,

127 
logcmd_•och
 = 0x4F50456B,

128 
logcmd_qu›sû
 = 0x4955516B,

129 
logcmd_wake
 = 0x4B41576B

133 şas 
	clog»¶ay
 {

134 
public
:

135 
	`log»¶ay
(cÚ¡ 
lcdf
::
SŒšg
 &
f’ame
);

136 ~
	`log»¶ay
();

137 
	`unm­
();

139 
	sšfo_ty³
 {

140 
kv•och_t
 
fœ¡_•och
;

141 
kv•och_t
 
Ï¡_•och
;

142 
kv•och_t
 
wake_•och
;

143 
kv•och_t
 
mš_po¡_qu›sûÁ_wake_•och
;

144 
boŞ
 
qu›sûÁ
;

146 
šfo_ty³
 
	$šfo
() const;

147 
kv•och_t
 
	$mš_po¡_qu›sûÁ_wake_•och
(
kv•och_t
 
qu›sûÁ_•och
) const;

149 
	`»¶ay
(
i
, 
th»adšfo
 *
ti
);

151 
´iv©e
:

152 
lcdf
::
SŒšg
 
f’ame_
;

153 
”ºo_
;

154 
off_t
 
size_
;

155 *
buf_
;

157 
ušt64_t
 
	`»¶ayªdş—n1
(
kv•och_t
 
mš_•och
, kv•och_ˆ
max_•och
,

158 
th»adšfo
 *
ti
);

159 
	`»¶ay_Œunÿ‹
(
size_t
 
Ën
);

160 
	`»¶ay_cİy
(cÚ¡ *
tm²ame
, cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
);

161 
	}
};

163 ’um { 
	mREC_NONE
, 
	mREC_CKP
, 
	mREC_LOG_TS
, 
	mREC_LOG_ANALYZE_WAKE
,

164 
	mREC_LOG_REPLAY
, 
	mREC_DONE
 };

165 
»ıha£
(
Çùive
, 
¡©e
);

166 
wa™uÁpha£
(
pha£
);

167 
šaùive
();

168 
±h»ad_mu‹x_t
 
»c_mu
;

169 
log»¶ay
::
šfo_ty³
 *
»c_log_šfos
;

170 
kv•och_t
 
»c_ckp_mš_•och
;

171 
kv•och_t
 
»c_ckp_max_•och
;

172 
kv•och_t
 
»c_»¶ay_mš_•och
;

173 
kv•och_t
 
»c_»¶ay_max_•och
;

174 
kv•och_t
 
»c_»¶ay_mš_qu›sûÁ_Ï¡_•och
;

177 
šlše
 
	glogšfo
::
	$acquœe
() {

178 
	`‹¡_ªd_£t_acquœe
(&
f_
.
lock_
);

179 
	}
}

181 
šlše
 
	glogšfo
::
	$»Ëa£
() {

182 
	`‹¡_ªd_£t_»Ëa£
(&
f_
.
lock_
);

183 
	}
}

185 
šlše
 
kv•och_t
 
	glogšfo
::
	$æushed_•och
() const {

186  
æushed_•och_
;

187 
	}
}

189 
šlše
 
boŞ
 
	glogšfo
::
	$qu›sûÁ
() const {

190  
qu›sûÁ_•och_
 && qu›sûÁ_•och_ =ğ
æushed_•och_
;

191 
	}
}

193 
šlše
 
	glog£t
::
	$size
() const {

194  
li_
[-1].
lsi_
.
size_
;

195 
	}
}

197 
šlše
 
	glogšfo
& 
	glog£t
::
	$log
(
i
) {

198 
	`as£¹
((
i
è< (
	`size
()));

199  
li_
[
i
];

200 
	}
}

202 
šlše
 cÚ¡ 
	glogšfo
& 
	glog£t
::
	$log
(
i
) const {

203 
	`as£¹
((
i
è< (
	`size
()));

204  
li_
[
i
];

205 
	}
}

208 
	g‹m¶©e
 <
ty³Çme
 
	gR
>

209 
	grow_d–_m¬k”
 : 
public
 
row_m¬k”
 {

210 
kvtime¡amp_t
 
´ev_ts_
;

211 
R
 *
	g´ev_
;

212 
	gs_
[0];

215 
	g‹m¶©e
 <
ty³Çme
 
	gR
>

216 
šlše
 
boŞ
 
	$row_is_d–_m¬k”
(cÚ¡ 
R
* 
row
) {

217 ià(
	`row_is_m¬k”
(
row
)) {

218 cÚ¡ 
row_m¬k”
* 
m
 =

219 
»š‹½»t_ÿ¡
<cÚ¡ 
row_m¬k”
 *>(
row
->
	`cŞ
(0).
s
);

220  
m
->
m¬k”_ty³_
 =ğm->
mt_d–
;

222  
çl£
;

223 
	}
}

225 
	g‹m¶©e
 <
ty³Çme
 
	gR
>

226 
šlše
 
	grow_d–_m¬k”
<
	gR
>* 
	$row_g‘_d–_m¬k”
(cÚ¡ 
R
* 
row
, 
boŞ
 
fÜû
 = 
çl£
) {

227 (è
fÜû
;

228 
	`as£¹
(
fÜû
 || 
	`row_is_d–_m¬k”
(
row
));

229  
»š‹½»t_ÿ¡
<
row_d–_m¬k”
<
R
>*>

230 (
cÚ¡_ÿ¡
<*>(
row
->
	`cŞ
(0).
s
));

231 
	}
}

	@masstree-beta/masstree.hh

16 #iâdeà
MASSTREE_HH


17 
	#MASSTREE_HH


	)

18 
	~"comp”.hh
"

19 
	~"¡r.hh
"

20 
	~"k£¬ch.hh
"

22 
Çme¥aû
 
	gMas¡»e
 {

23 
usšg
 
	glcdf
::
SŒ
;

24 
usšg
 
	glcdf
::
SŒšg
;

26 
şass
 
	gkey_uÅ¬£_´šbË_¡ršg
;

27 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
şass
 
	gv®ue_´št
;

29 
	g‹m¶©e
 <
	gLW
 = 15, 
	gIW
 = 
LW
> 
	snod•¬ams
 {

30 
cÚ¡ex´
 
Ëaf_width
 = 
LW
;

31 
cÚ¡ex´
 
	gš‹ºode_width
 = 
IW
;

32 
cÚ¡ex´
 
boŞ
 
	gcÚcu¼’t
 = 
Œue
;

33 
cÚ¡ex´
 
boŞ
 
	g´eãtch
 = 
Œue
;

34 
cÚ¡ex´
 
	gbound_m‘hod
 = 
bound_m‘hod_bš¬y
;

35 
cÚ¡ex´
 
	gdebug_Ëv–
 = 0;

36 
ušt64_t
 
	tikey_ty³
;

37 
ušt32_t
 
	tnodev”siÚ_v®ue_ty³
;

38 
cÚ¡ex´
 
boŞ
 
	gÃed_phªtom_•och
 = 
Œue
;

39 
ušt64_t
 
	tphªtom_•och_ty³
;

40 
cÚ¡ex´
 
ssize_t
 
	g´št_max_šd’t_d•th
 = 12;

41 
key_uÅ¬£_´šbË_¡ršg
 
	tkey_uÅ¬£_ty³
;

44 
	g‹m¶©e
 <
	gLW
, 
	gIW
> 
cÚ¡ex´
 
	gnod•¬ams
<LW, IW>::
Ëaf_width
;

45 
	g‹m¶©e
 <
	gLW
, 
	gIW
> 
cÚ¡ex´
 
	gnod•¬ams
<LW, IW>::
š‹ºode_width
;

46 
	g‹m¶©e
 <
	gLW
, 
	gIW
> 
cÚ¡ex´
 
	gnod•¬ams
<LW, IW>::
debug_Ëv–
;

48 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
şass
 
	gnode_ba£
;

49 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
şass
 
	gËaf
;

50 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
şass
 
	gš‹ºode
;

51 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
şass
 
	gËafv®ue
;

52 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
şass
 
	gkey
;

53 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
şass
 
	gbasic_bË
;

54 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
şass
 
	guÆocked_tcursÜ
;

55 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
şass
 
	gtcursÜ
;

57 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

58 şas 
	cbasic_bË
 {

59 
	gpublic
:

60 
P
 
	t·¿m‘”s_ty³
;

61 
	gnode_ba£
<
	tP
> 
	tnode_ty³
;

62 
	gËaf
<
	tP
> 
	tËaf_ty³
;

63 
ty³Çme
 
	tP
::
	tv®ue_ty³
 value_type;

64 
ty³Çme
 
	tP
::
	tth»adšfo_ty³
 
	tth»adšfo
;

65 
	guÆocked_tcursÜ
<
	tP
> 
	tuÆocked_cursÜ_ty³
;

66 
	gtcursÜ
<
	tP
> 
	tcursÜ_ty³
;

68 
šlše
 
basic_bË
();

70 
š™Ÿlize
(
th»adšfo
& 
ti
);

71 
de¡roy
(
th»adšfo
& 
ti
);

73 
šlše
 
node_ty³
* 
roÙ
() const;

74 
šlše
 
node_ty³
* 
fix_roÙ
();

76 
boŞ
 
g‘
(
SŒ
 
key
, 
v®ue_ty³
& 
v®ue
, 
th»adšfo
& 
ti
) const;

78 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

79 
sÿn
(
SŒ
 
fœ¡key
, 
boŞ
 
m©chfœ¡
, 
F
& 
sÿÂ”
, 
th»adšfo
& 
ti
) const;

80 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

81 
sÿn
(
SŒ
 
fœ¡key
, 
boŞ
 
m©chfœ¡
, 
F
& 
sÿÂ”
, 
sÿn_lim™
, 
th»adšfo
& 
ti
) const;

82 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

83 
rsÿn
(
SŒ
 
fœ¡key
, 
boŞ
 
m©chfœ¡
, 
F
& 
sÿÂ”
, 
th»adšfo
& 
ti
) const;

84 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

85 
rsÿn
(
SŒ
 
fœ¡key
, 
boŞ
 
m©chfœ¡
, 
F
& 
sÿÂ”
, 
sÿn_lim™
, 
th»adšfo
& 
ti
) const;

87 
šlše
 
´št
(
FILE
* 
f
 = 0) const;

89 
	g´iv©e
:

90 
node_ty³
* 
roÙ_
;

92 
	g‹m¶©e
 <
ty³Çme
 
	gH
,y³Çm
	gF
>

93 
sÿn
(
H
 
h–³r
, 
SŒ
 
fœ¡key
, 
boŞ
 
m©chfœ¡
,

94 
F
& 
sÿÂ”
, 
th»adšfo
& 
ti
) const;

95 
	g‹m¶©e
 <
ty³Çme
 
	gH
,y³Çm
	gF
>

96 
sÿn_w™h_lim™
(
H
 
h–³r
, 
SŒ
 
fœ¡key
, 
boŞ
 
m©chfœ¡
,

97 
F
& 
sÿÂ”
, 
sÿn_lim™
, 
th»adšfo
& 
ti
) const;

99 
ä›nd
 
şass
 
	guÆocked_tcursÜ
<
	gP
>;

100 
ä›nd
 
şass
 
	gtcursÜ
<
	gP
>;

	@masstree-beta/masstree_get.hh

16 #iâdeà
MASSTREE_GET_HH


17 
	#MASSTREE_GET_HH


	)

18 
	~"mas¡»e_tcursÜ.hh
"

19 
	~"mas¡»e_key.hh
"

20 
Çme¥aû
 
	gMas¡»e
 {

22 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

23 
boŞ
 
	guÆocked_tcursÜ
<
	gP
>::
fšd_uÆocked
(
th»adšfo
& 
ti
)

25 
m©ch
;

26 
key_šdexed_pos™iÚ
 
	gkx
;

27 
	gnode_ba£
<
	gP
>* 
	groÙ
 = 
cÚ¡_ÿ¡
<
node_ba£
<
P
>*>(
roÙ_
);

29 
	g»Œy
:

30 
n_
 = 
roÙ
->
»ach_Ëaf
(
ka_
, 
v_
, 
ti
);

32 
	gfÜw¬d
:

33 ià(
v_
.
d–‘ed
())

34 
»Œy
;

36 
	gn_
->
´eãtch
();

37 
	g³rm_
 = 
n_
->
³rmutiÚ
();

38 
	gkx
 = 
Ëaf
<
P
>::
bound_ty³
::
low”
(
ka_
, *
this
);

39 ià(
	gkx
.
	gp
 >= 0) {

40 
lv_
 = 
n_
->lv_[
kx
.
p
];

41 
	glv_
.
´eãtch
(
n_
->
keyËnx_
[
kx
.
p
]);

42 
	gm©ch
 = 
n_
->
ksuf_m©ches
(
kx
.
p
, 
ka_
);

44 
	gm©ch
 = 0;

45 ià(
	gn_
->
has_chªged
(
v_
)) {

46 
	gti
.
m¬k
(
th»adcouÁ”
(
tc_¡abË_Ëaf_š£¹
 + 
n_
->
sim¶e_has_¥l™
(
v_
)));

47 
	gn_
 = 
n_
->
advªû_to_key
(
ka_
, 
v_
, 
ti
);

48 
	gfÜw¬d
;

51 ià(
	gm©ch
 < 0) {

52 
	gka_
.
shiá_by
(-
m©ch
);

53 
	groÙ
 = 
lv_
.
Ïy”
();

54 
	g»Œy
;

56  
	gm©ch
;

59 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

60 
šlše
 
boŞ
 
	gbasic_bË
<
	gP
>::
g‘
(
SŒ
 
key
, 
v®ue_ty³
 &
v®ue
,

61 
th»adšfo
& 
ti
) const

63 
	guÆocked_tcursÜ
<
	gP
> 
Í
(*
this
, 
key
);

64 
boŞ
 
	gfound
 = 
Í
.
fšd_uÆocked
(
ti
);

65 ià(
	gfound
)

66 
	gv®ue
 = 
Í
.
v®ue
();

67  
	gfound
;

70 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

71 
boŞ
 
	gtcursÜ
<
	gP
>::
fšd_locked
(
th»adšfo
& 
ti
)

73 
node_ba£
<
P
>* 
roÙ
 = 
cÚ¡_ÿ¡
<node_ba£<P>*>(
roÙ_
);

74 
nodev”siÚ_ty³
 
	gv
;

75 
³rmu‹r_ty³
 
	g³rm
;

77 
	g»Œy
:

78 
n_
 = 
roÙ
->
»ach_Ëaf
(
ka_
, 
v
, 
ti
);

80 
	gfÜw¬d
:

81 ià(
v
.
d–‘ed
())

82 
»Œy
;

84 
	gn_
->
´eãtch
();

85 
	g³rm
 = 
n_
->
³rmutiÚ
();

86 
ãnû
();

87 
	gkx_
 = 
Ëaf
<
P
>::
bound_ty³
::
low”
(
ka_
, *
n_
);

88 ià(
	gkx_
.
	gp
 >= 0) {

89 
Ëafv®ue
<
P
> 
lv
 = 
n_
->
lv_
[
kx_
.
p
];

90 
	glv
.
´eãtch
(
n_
->
keyËnx_
[
kx_
.
p
]);

91 
	g¡©e_
 = 
n_
->
ksuf_m©ches
(
kx_
.
p
, 
ka_
);

92 ià(
	g¡©e_
 < 0 && !
	gn_
->
has_chªged
(
v
è&& 
	glv
.
Ïy”
()->
is_roÙ
()) {

93 
	gka_
.
shiá_by
(-
¡©e_
);

94 
	groÙ
 = 
lv
.
Ïy”
();

95 
	g»Œy
;

98 
	g¡©e_
 = 0;

100 
	gn_
->
lock
(
v
, 
ti
.
lock_ãnû
(
tc_Ëaf_lock
));

101 ià(
	gn_
->
has_chªged
(
v
è||‚_->
³rmutiÚ
(è!ğ
³rm
) {

102 
ti
.
m¬k
(
th»adcouÁ”
(
tc_¡abË_Ëaf_š£¹
 + 
n_
->
sim¶e_has_¥l™
(
v
)));

103 
	gn_
->
uÆock
();

104 
	gn_
 = 
n_
->
advªû_to_key
(
ka_
, 
v
, 
ti
);

105 
	gfÜw¬d
;

106 } ià(
uÆik–y
(
¡©e_
 < 0)) {

107 
	gka_
.
shiá_by
(-
¡©e_
);

108 
	gn_
->
	glv_
[
kx_
.
p
] = 
roÙ
 = 
n_
->
lv_
[kx_.p].
Ïy”
()->
maybe_·»Á
();

109 
	gn_
->
uÆock
();

110 
	g»Œy
;

111 } ià(
uÆik–y
(
n_
->
d–‘ed_Ïy”
())) {

112 
	gka_
.
unshiá_®l
();

113 
	groÙ
 = 
cÚ¡_ÿ¡
<
node_ba£
<
P
>*>(
roÙ_
);

114 
	g»Œy
;

116  
	g¡©e_
;

	@masstree-beta/masstree_insert.hh

16 #iâdeà
MASSTREE_INSERT_HH


17 
	#MASSTREE_INSERT_HH


	)

18 
	~"mas¡»e_g‘.hh
"

19 
	~"mas¡»e_¥l™.hh
"

20 
Çme¥aû
 
	gMas¡»e
 {

22 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

23 
boŞ
 
	gtcursÜ
<
	gP
>::
fšd_š£¹
(
th»adšfo
& 
ti
)

25 
fšd_locked
(
ti
);

26 
	gÜigš®_n_
 = 
n_
;

27 
	gÜigš®_v_
 = 
n_
->
fuÎ_uÆocked_v”siÚ_v®ue
();

30 ià(
	g¡©e_
)

31  
	gŒue
;

34 
	g¡©e_
 = 2;

37 ià(
	gkx_
.
	gp
 >= 0)

38  
make_Ãw_Ïy”
(
ti
);

41 ià(
uÆik–y
(
n_
->
mod¡©e_
 !ğ
Ëaf
<
P
>::
mod¡©e_š£¹
)) {

42 
mas¡»e_šv¬ŸÁ
(
n_
->
mod¡©e_
 =ğ
Ëaf
<
P
>::
mod¡©e_»move
);

43 
	gn_
->
m¬k_š£¹
();

44 
	gn_
->
	gmod¡©e_
 = 
Ëaf
<
P
>::
mod¡©e_š£¹
;

48 ià(
	gn_
->
size
(è<‚_->
	gwidth
) {

49 
	gkx_
.
	gp
 = 
³rmu‹r_ty³
(
n_
->
³rmutiÚ_
).
back
();

51 ià(
lik–y
(
kx_
.
p
 !ğ0è|| !
n_
->
´ev_
 ||‚_->
ikey_bound
(è=ğ
ka_
.
ikey
()) {

52 
n_
->
assign
(
kx_
.
p
, 
ka_
, 
ti
);

53  
	gçl£
;

58  
make_¥l™
(
ti
);

61 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

62 
boŞ
 
	gtcursÜ
<
	gP
>::
make_Ãw_Ïy”
(
th»adšfo
& 
ti
) {

63 
key_ty³
 
oka
(
n_
->
ksuf
(
kx_
.
p
));

64 
	gka_
.
shiá
();

65 
	gkcmp
 = 
oka
.
com·»
(
ka_
);

68 
Ëaf_ty³
* 
	gtwig_h—d
 = 
n_
;

69 
Ëaf_ty³
* 
	gtwig_
 = 
n_
;

70 
	gkcmp
 == 0) {

71 
Ëaf_ty³
* 
Æ
 =†—f_ty³::
make_roÙ
(0, 
twig_
, 
ti
);

72 
	gÆ
->
assign_š™Ÿlize_fÜ_Ïy”
(0, 
oka
);

73 ià(
	gtwig_h—d
 !ğ
n_
)

74 
twig_
->
lv_
[0] = 
Æ
;

76 
	gtwig_h—d
 = 
Æ
;

77 
	gÆ
->
	g³rmutiÚ_
 = 
³rmu‹r_ty³
::
make_sÜ‹d
(1);

78 
	gtwig_
 = 
Æ
;

79 
	gÃw_nodes_
.
em¶aû_back
(
Æ
,‚l->
fuÎ_uÆocked_v”siÚ_v®ue
());

80 
	goka
.
shiá
();

81 
	gka_
.
shiá
();

82 
	gkcmp
 = 
oka
.
com·»
(
ka_
);

86 
size_t
 
	gksufsize
;

87 ià(
	gka_
.
has_suffix
(è|| 
	goka
.has_suffix())

88 
	gksufsize
 = (
¡d
::
max
(0, 
ka_
.
suffix_Ëngth
())

89 + 
	g¡d
::
max
(0, 
oka
.
suffix_Ëngth
())è* (
	gn_
->
	gwidth
 / 2)

90 + 
	gn_
->
	giksuf_
[0].
ov”h—d
(
n_
->
width
);

92 
	gksufsize
 = 0;

93 
Ëaf_ty³
 *
	gÆ
 =†—f_ty³::
make_roÙ
(
ksufsize
, 
twig_
, 
ti
);

94 
	gÆ
->
assign_š™Ÿlize
(0, 
kcmp
 < 0 ? 
oka
 : 
ka_
, 
ti
);

95 
	gÆ
->
assign_š™Ÿlize
(1, 
kcmp
 < 0 ? 
ka_
 : 
oka
, 
ti
);

96 
	gÆ
->
	glv_
[
kcmp
 > 0] = 
n_
->
lv_
[
kx_
.
p
];

97 
	gÆ
->
lock
(*
Æ
, 
ti
.
lock_ãnû
(
tc_Ëaf_lock
));

98 ià(
	gkcmp
 < 0)

99 
	gÆ
->
	g³rmutiÚ_
 = 
³rmu‹r_ty³
::
make_sÜ‹d
(1);

101 
³rmu‹r_ty³
 
	g³rmÆ
 =…”mu‹r_ty³::
make_sÜ‹d
(2);

102 
	g³rmÆ
.
»move_to_back
(0);

103 
	gÆ
->
	g³rmutiÚ_
 = 
³rmÆ
.
v®ue
();

112 
	gn_
->
m¬k_š£¹
();

113 
ãnû
();

114 ià(
	gtwig_
 !ğ
n_
)

115 
twig_
->
lv_
[0] = 
Æ
;

116 ià(
	gtwig_h—d
 !ğ
n_
)

117 
n_
->
lv_
[
kx_
.
p
] = 
twig_h—d
;

119 
	gn_
->
	glv_
[
kx_
.
p
] = 
Æ
;

120 
	gn_
->
	gkeyËnx_
[
kx_
.
p
] = 
n_
->
Ïy”_keyËnx
;

121 
	gupd©ed_v_
 = 
n_
->
fuÎ_uÆocked_v”siÚ_v®ue
();

122 
	gn_
->
uÆock
();

123 
	gn_
 = 
Æ
;

124 
	gkx_
.
	gi
 = 
kx_
.
p
 = 
kcmp
 < 0;

125  
	gçl£
;

128 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

129 
	gtcursÜ
<
	gP
>::
fšish_š£¹
()

131 
³rmu‹r_ty³
 
³rm
(
n_
->
³rmutiÚ_
);

132 
mas¡»e_šv¬ŸÁ
(
³rm
.
back
(è=ğ
kx_
.
p
);

133 
	g³rm
.
š£¹_äom_back
(
kx_
.
i
);

134 
ãnû
();

135 
	gn_
->
	g³rmutiÚ_
 = 
³rm
.
v®ue
();

138 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

139 
šlše
 
	gtcursÜ
<
	gP
>::
fšish
(
¡©e
, 
th»adšfo
& 
ti
)

141 ià(
	g¡©e
 < 0 && 
	g¡©e_
 == 1) {

142 ià(
fšish_»move
(
ti
))

144 } ià(
	g¡©e
 > 0 && 
	g¡©e_
 == 2)

145 
fšish_š£¹
();

147 ià(
	gn_
 =ğ
Üigš®_n_
)

148 
upd©ed_v_
 = 
n_
->
fuÎ_uÆocked_v”siÚ_v®ue
();

150 
	gÃw_nodes_
.
em¶aû_back
(
n_
,‚_->
fuÎ_uÆocked_v”siÚ_v®ue
());

151 
	gn_
->
uÆock
();

	@masstree-beta/masstree_key.hh

16 #iâdeà
MASSTREE_KEY_HH


17 
	#MASSTREE_KEY_HH


	)

18 
	~"mas¡»e.hh
"

19 
	~"¡ršg_¦iû.hh
"

21 
Çme¥aû
 
	gMas¡»e
 {

35 
	g‹m¶©e
 <
ty³Çme
 
	gI
>

36 şas 
	ckey
 {

37 
	gpublic
:

38 
cÚ¡ex´
 
nikey
 = 1;

40 
I
 
	tikey_ty³
;

42 
cÚ¡ex´
 
	gikey_size
 = (
ikey_ty³
);

45 
key
() {

48 
key
(
SŒ
 
s
)

49 : 
ikey0_
(
¡ršg_¦iû
<
ikey_ty³
>::
make_com·¿bË
(
s
.s, s.
Ën
)),

50 
Ën_
(
s
.
Ën
), 
s_
(s.s), 
fœ¡_
(s.s) {

54 
key
(cÚ¡ * 
s
, 
Ën
)

55 : 
ikey0_
(
¡ršg_¦iû
<
ikey_ty³
>::
make_com·¿bË
(
s
, 
Ën
)),

56 
Ën_
(
Ën
), 
s_
(
s
), 
fœ¡_
(s) {

62 
ex¶ic™
 
key
(
ikey_ty³
 
ikey
)

63 : 
ikey0_
(
ikey
),

64 
Ën_
(
ikey
 ? 
ikey_size
 - 
ùz
(ikeyè/ 8 : 0), 
s_
(0), 
fœ¡_
(0) {

69 
key
(
ikey_ty³
 
ikey
, 
Ën
)

70 : 
ikey0_
(
ikey
),

71 
Ën_
(
¡d
::
mš
(
Ën
, 
ikey_size
)), 
s_
(0), 
fœ¡_
(0) {

74 
key
(
ikey_ty³
 
ikey
, 
SŒ
 
suf
)

75 : 
ikey0_
(
ikey
),

76 
Ën_
(
ikey_size
 + 
suf
.
Ën
), 
s_
(suf.
s
 - ikey_size), 
fœ¡_
(s_) {

80 
boŞ
 
em±y
() const {

81  
	gikey0_
 =ğ0 && 
Ën_
 == 0;

84 
ikey_ty³
 
ikey
() const {

85  
	gikey0_
;

88 
Ëngth
() const {

89  
	gËn_
;

92 
boŞ
 
has_suffix
() const {

93  
	gËn_
 > 
	gikey_size
;

97 
SŒ
 
suffix
() const {

98  
SŒ
(
s_
 + 
ikey_size
, 
Ën_
 - ikey_size);

102 
suffix_Ëngth
() const {

103  
	gËn_
 - 
	gikey_size
;

108 
shiá
() {

109 
	gs_
 +ğ
ikey_size
;

110 
	gËn_
 -ğ
ikey_size
;

111 
	gikey0_
 = 
¡ršg_¦iû
<
ikey_ty³
>::
make_com·¿bË_¦İpy
(
s_
, 
Ën_
);

115 
shiá_by
(
d–
) {

116 
	gs_
 +ğ
d–
;

117 
	gËn_
 -ğ
d–
;

118 
	gikey0_
 = 
¡ršg_¦iû
<
ikey_ty³
>::
make_com·¿bË_¦İpy
(
s_
, 
Ën_
);

121 
boŞ
 
is_shiáed
() const {

122  
	gfœ¡_
 !ğ
s_
;

125 
unshiá_®l
() {

126 ià(
	gs_
 !ğ
fœ¡_
) {

127 
Ën_
 +ğ
s_
 - 
fœ¡_
;

128 
	gs_
 = 
fœ¡_
;

129 
	gikey0_
 = 
¡ršg_¦iû
<
ikey_ty³
>::
make_com·¿bË
(
s_
, 
Ën_
);

133 
com·»
(
ikey_ty³
 
ikey
, 
keyËnx
) const {

134 
	gcmp
 = ::
com·»
(
this
->
ikey
(), ikey);

135 ià(
	gcmp
 == 0) {

136 
®
 = 
this
->
Ëngth
();

137 ià(
	g®
 > 
	gikey_size
)

138 
	gcmp
 = 
keyËnx
 <ğ
ikey_size
;

140 
	gcmp
 = 
®
 - 
keyËnx
;

142  
	gcmp
;

144 
com·»
(cÚ¡ 
key
<
I
>& 
x
) const {

145  
com·»
(
x
.
ikey
(), x.
Ëngth
());

148 
uÅ¬£
(* 
d©a
, 
d©®’
) const {

149 
	gıËn
 = 
¡d
::
mš
(
Ën_
, 
d©®’
);

150 
	g¡ršg_¦iû
<
	gikey_ty³
>::
uÅ¬£_com·¿bË
(
d©a
, 
ıËn
, 
ikey0_
, 
ikey_size
);

151 ià(
	gıËn
 > 
	gikey_size
)

152 
memıy
(
d©a
 + 
ikey_size
, 
s_
 + ikey_size, 
ıËn
 - ikey_size);

153  
	gıËn
;

155 
SŒšg
 
uÅ¬£
() const {

156 
SŒšg
 
	gs
 = SŒšg::
make_unš™Ÿlized
(
Ën_
);

157 
uÅ¬£
(
s
.
mubË_d©a
(), s.
Ëngth
());

158  
	gs
;

160 
uÅ¬£_´šbË
(* 
d©a
, 
d©®’
) const {

161 
SŒšg
 
	gs
 = 
uÅ¬£
().
´šbË
();

162 
	gıËn
 = 
¡d
::
mš
(
s
.
Ëngth
(), 
d©®’
);

163 
memıy
(
d©a
, 
s
.d©a(), 
ıËn
);

164  
	gıËn
;

166 
SŒšg
 
uÅ¬£_ikey
(
ikey_ty³
 
ikey
) {

167 
	gkey
<
	gikey_ty³
> 
k
(
ikey
);

168  
	gk
.
uÅ¬£
();

172 
SŒ
 
´efix_¡ršg
() const {

173  
SŒ
(
fœ¡_
, 
s_
);

175 
´efix_Ëngth
() const {

176  
	gs_
 - 
	gfœ¡_
;

178 
SŒ
 
fuÎ_¡ršg
() const {

179  
SŒ
(
fœ¡_
, 
s_
 + 
Ën_
);

181 
İ”©Ü
 
SŒ
() const {

182  
fuÎ_¡ršg
();

184 
boŞ
 
šüem’t
() {

186 ià(
has_suffix
()) {

187 ++
	gikey0_
;

188 
	gËn_
 = 1;

189  
uÆik–y
(!
ikey0_
);

191 ++
	gËn_
;

192  
	gçl£
;

195 
assign_¡Üe_ikey
(
ikey_ty³
 
ikey
) {

196 
	gikey0_
 = 
ikey
;

197 *
	g»š‹½»t_ÿ¡
<
	gikey_ty³
*>(
	gcÚ¡_ÿ¡
<*>(
	gs_
)èğ
ho¡_to_Ãt_Üd”
(
ikey
);

199 
assign_¡Üe_suffix
(
SŒ
 
s
) {

200 
memıy
(
cÚ¡_ÿ¡
<*>(
s_
 + 
ikey_size
), 
s
.s, s.
Ën
);

201  
	gikey_size
 + 
	gs
.
	gËn
;

203 
assign_¡Üe_Ëngth
(
Ën
) {

204 
	gËn_
 = 
Ën
;

206 
unshiá
() {

207 
mas¡»e_´ecÚd™iÚ
(
is_shiáed
());

208 
	gs_
 -ğ
ikey_size
;

209 
	gikey0_
 = 
¡ršg_¦iû
<
ikey_ty³
>::
make_com·¿bË_¦İpy
(
s_
, 
ikey_size
);

210 
	gËn_
 = 
ikey_size
 + 1;

212 
shiá_ş—r
() {

213 
	gikey0_
 = 0;

214 
	gËn_
 = 0;

215 
	gs_
 +ğ
ikey_size
;

217 
shiá_ş—r_»v”£
() {

218 
	gikey0_
 = ~
ikey_ty³
(0);

219 
	gËn_
 = 
ikey_size
 + 1;

220 
	gs_
 +ğ
ikey_size
;

223 
	g´iv©e
:

224 
ikey_ty³
 
ikey0_
;

225 
	gËn_
;

226 cÚ¡ * 
	gs_
;

227 cÚ¡ * 
	gfœ¡_
;

230 
	g‹m¶©e
 <
ty³Çme
 
	gI
> 
cÚ¡ex´
 
	gkey
<I>::
ikey_size
;

234 
	g‹m¶©e
 <
ty³Çme
 
	gI
>

235 
šlše
 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
¡»am
,

236 cÚ¡ 
	gMas¡»e
::
key
<
I
>& 
x
) {

237  
¡»am
 << 
x
.
uÅ¬£
();

	@masstree-beta/masstree_print.hh

16 #iâdeà
MASSTREE_PRINT_HH


17 
	#MASSTREE_PRINT_HH


	)

18 
	~"mas¡»e_¡ruù.hh
"

19 
	~<¡dio.h
>

20 
	~<š‰y³s.h
>

22 
Çme¥aû
 
	gMas¡»e
 {

24 şas 
	ckey_uÅ¬£_´šbË_¡ršg
 {

25 
	gpublic
:

26 
‹m¶©e
 <
ty³Çme
 
K
>

27 
uÅ¬£_key
(
key
<
K
> key, * 
buf
, 
buæ’
) {

28 
SŒšg
 
	gs
 = 
key
.
uÅ¬£
().
´šbË
();

29 
	gıËn
 = 
¡d
::
mš
(
s
.
Ëngth
(), 
buæ’
);

30 
memıy
(
buf
, 
s
.
d©a
(), 
ıËn
);

31  
	gıËn
;

35 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

36 şas 
	cv®ue_´št
 {

37 
	gpublic
:

38 
´št
(
T
 
v®ue
, 
FILE
* 
f
, cÚ¡ * 
´efix
,

39 
šd’t
, 
SŒ
 
key
, 
kvtime¡amp_t
 
š™Ÿl_time¡amp
,

40 * 
suffix
) {

41 
	gv®ue
->
´št
(
f
, 
´efix
, 
šd’t
, 
key
, 
š™Ÿl_time¡amp
, 
suffix
);

45 
	g‹m¶©e
 <>

46 
şass
 
	gv®ue_´št
<*> {

47 
	gpublic
:

48 
´št
(* 
v®ue
, 
FILE
* 
f
, cÚ¡ * 
´efix
,

49 
šd’t
, 
SŒ
 
key
, 
kvtime¡amp_t
,

50 * 
suffix
) {

51 
årštf
(
f
, "%s%*s%.*s = %p%s\n",

52 
´efix
, 
šd’t
, "", 
key
.
Ën
, key.
s
, 
v®ue
, 
suffix
);

56 
	g‹m¶©e
 <>

57 
şass
 
	gv®ue_´št
<
	gušt64_t
> {

58 
	gpublic
:

59 
´št
(
ušt64_t
 
v®ue
, 
FILE
* 
f
, cÚ¡ * 
´efix
,

60 
šd’t
, 
SŒ
 
key
, 
kvtime¡amp_t
,

61 * 
suffix
) {

62 
årštf
(
f
, "%s%*s%.* ğ%" 
PRIu64
 "%s\n",

63 
´efix
, 
šd’t
, "", 
key
.
Ën
, key.
s
, 
v®ue
, 
suffix
);

67 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

68 
	gËaf
<
	gP
>::
	$´št
(
FILE
 *
f
, cÚ¡ *
´efix
, 
d•th
, 
kd•th
) const

70 
f
 = f ? f : 
¡d”r
;

71 
´efix
 =…refix ?…refix : "";

72 
ty³Çme
 
node_ba£
<
P
>::
nodev”siÚ_ty³
 
v
;

73 
³rmu‹r_ty³
 
³rm
;

75 
v
 = *
this
;

76 
	`ãnû
();

77 
³rm
 = 
³rmutiÚ_
;

78 } 
this
->
	`has_chªged
(
v
));

79 
šd’t
 = 2 * 
d•th
;

80 ià(
d•th
 > 
P
::
´št_max_šd’t_d•th
 && P::print_max_indent_depth > 0)

81 
šd’t
 = 2 * 
P
::
´št_max_šd’t_d•th
;

84 
buf
[1024];

85 
l
 = 0;

86 ià(
ksuf_
 && 
exŒasize64_
 < -1)

87 
l
 = 
	`¢´štf
(
buf
, (buf), " [ksuài%dx%d]", -
exŒasize64_
 - 1, (è
ksuf_
->
	`ÿ·c™y
() / 64);

88 ià(
ksuf_
)

89 
l
 = 
	`¢´štf
(
buf
, (buf), " [ksuàx%d]", (è
ksuf_
->
	`ÿ·c™y
() / 64);

90 ià(
exŒasize64_
)

91 
l
 = 
	`¢´štf
(
buf
, (buf), " [ksuài%d]", 
exŒasize64_
);

92 ià(
P
::
debug_Ëv–
 > 0) {

93 
kvtime¡amp_t
 
ùs
 = 
	`time¡amp_sub
(
ü—‹d_©_
[0], 
š™Ÿl_time¡amp
);

94 
l
 +ğ
	`¢´štf
(&
buf
[l], (bufè-†, " @" 
PRIKVTSPARTS
, 
	`KVTS_HIGHPART
(
ùs
), 
	`KVTS_LOWPART
(cts));

96 cÚ¡ * cÚ¡ 
mod¡©es
[] = {"", "-", "D"};

97 
	`årštf
(
f
, "%s%*¦—à%p: %d %s, v”siÚ %" 
PRIx64
 "%s,…ermutation %s,…arent %p,…rev %p,‚ext %p%.*s\n",

98 
´efix
, 
šd’t
, "", 
this
,

99 
³rm
.
	`size
(),…erm.size() == 1 ? "key" : "keys",

100 (
ušt64_t
è
v
.
	`v”siÚ_v®ue
(),

101 
mod¡©e_
 <ğ2 ? 
mod¡©es
[modstate_] : "??",

102 
³rm
.
	`uÅ¬£
().
	`c_¡r
(),

103 
·»Á_
, 
´ev_
, 
Ãxt_
.
±r
,

104 
l
, 
buf
);

107 ià(
v
.
	`d–‘ed
(è|| (
³rm
[0] !ğ0 && 
´ev_
))

108 
	`årštf
(
f
, "%s%*s% ğ[] #0\n", 
´efix
, 
šd’t
 + 2, "", 
	`key_ty³
(
	`ikey_bound
()).
	`uÅ¬£
().
	`c_¡r
());

110 
keybuf
[
MASSTREE_MAXKEYLEN
];

111 
xbuf
[15];

112 
idx
 = 0; idx < 
³rm
.
	`size
(); ++idx) {

113 
p
 = 
³rm
[
idx
];

114 
l
 = 
P
::
key_uÅ¬£_ty³
::
	`uÅ¬£_key
(
this
->
	`g‘_key
(
p
), 
keybuf
, (keybuf));

115 
	`¥rštf
(
xbuf
, " #%x/%d", 
p
, 
keyËnx_
[p]);

116 
Ëafv®ue_ty³
 
lv
 = 
lv_
[
p
];

117 ià(
this
->
	`has_chªged
(
v
)) {

118 
	`årštf
(
f
, "%s%*s[NODE CHANGED]\n", 
´efix
, 
šd’t
 + 2, "");

120 } ià(!
lv
)

121 
	`årštf
(
f
, "%s%*s%.* ğ[]%s\n", 
´efix
, 
šd’t
 + 2, "", 
l
, 
keybuf
, 
xbuf
);

122 ià(
	`is_Ïy”
(
p
)) {

123 
	`årštf
(
f
, "%s%*s%.* ğSUBTREE%s\n", 
´efix
, 
šd’t
 + 2, "", 
l
, 
keybuf
, 
xbuf
);

124 
node_ba£
<
P
> *
n
 = 
lv
.
	`Ïy”
();

125 !
n
->
	`is_roÙ
())

126 
n
 =‚->
	`maybe_·»Á
();

127 
n
->
	`´št
(
f
, 
´efix
, 
d•th
 + 1, 
kd•th
 + 
key_ty³
::
ikey_size
);

129 
ty³Çme
 
P
::
v®ue_ty³
 
tvx
 = 
lv
.
	`v®ue
();

130 
P
::
v®ue_´št_ty³
::
	`´št
(
tvx
, 
f
, 
´efix
, 
šd’t
 + 2, 
	`SŒ
(
keybuf
, 
l
), 
š™Ÿl_time¡amp
, 
xbuf
);

134 ià(
v
.
	`d–‘ed
())

135 
	`årštf
(
f
, "%s%*s[DELETED]\n", 
´efix
, 
šd’t
 + 2, "");

136 
	}
}

138 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

139 
	gš‹ºode
<
	gP
>::
	$´št
(
FILE
* 
f
, cÚ¡ * 
´efix
, 
d•th
, 
kd•th
) const

141 
f
 = f ? f : 
¡d”r
;

142 
´efix
 =…refix ?…refix : "";

143 
š‹ºode
<
P
> 
	`cİy
(*
this
);

144 
i
 = 0; i < 100 && (
cİy
.
	`has_chªged
(*
this
è||his->
	`š£¹šg
(è||his->
	`¥l™tšg
()); ++i)

145 
	`memıy
(&
cİy
, 
this
, (copy));

146 
šd’t
 = 2 * 
d•th
;

147 ià(
d•th
 > 
P
::
´št_max_šd’t_d•th
 && P::print_max_indent_depth > 0)

148 
šd’t
 = 2 * 
P
::
´št_max_šd’t_d•th
;

151 
buf
[1024];

152 
l
 = 0;

153 ià(
P
::
debug_Ëv–
 > 0) {

154 
kvtime¡amp_t
 
ùs
 = 
	`time¡amp_sub
(
ü—‹d_©_
[0], 
š™Ÿl_time¡amp
);

155 
l
 = 
	`¢´štf
(
buf
, (buf), " @" 
PRIKVTSPARTS
, 
	`KVTS_HIGHPART
(
ùs
), 
	`KVTS_LOWPART
(cts));

157 
	`årštf
(
f
, "%s%*sš‹ºod%p[%u]%s: %d keys, v”siÚ %" 
PRIx64
 ",…arent %p%.*s\n",

158 
´efix
, 
šd’t
, "", 
this
,

159 
height_
, 
this
->
	`d–‘ed
() ? " [DELETED]" : "",

160 
cİy
.
	`size
(), (
ušt64_t
ècİy.
	`v”siÚ_v®ue
(), cİy.
·»Á_
,

161 
l
, 
buf
);

164 
keybuf
[
MASSTREE_MAXKEYLEN
];

165 
p
 = 0;… < 
cİy
.
	`size
(); ++p) {

166 ià(
cİy
.
chd_
[
p
])

167 
cİy
.
chd_
[
p
]->
	`´št
(
f
, 
´efix
, 
d•th
 + 1, 
kd•th
);

169 
	`årštf
(
f
, "%s%*s[]\n", 
´efix
, 
šd’t
, "");

170 
l
 = 
P
::
key_uÅ¬£_ty³
::
	`uÅ¬£_key
(
cİy
.
	`g‘_key
(
p
), 
keybuf
, (keybuf));

171 
	`årštf
(
f
, "%s%*s%p[%u.%d] %.*s\n",

172 
´efix
, 
šd’t
, "", 
this
, 
height_
, 
p
, 
l
, 
keybuf
);

174 ià(
cİy
.
chd_
[cİy.
	`size
()])

175 
cİy
.
chd_
[cİy.
	`size
()]->
	`´št
(
f
, 
´efix
, 
d•th
 + 1, 
kd•th
);

177 
	`årštf
(
f
, "%s%*s[]\n", 
´efix
, 
šd’t
, "");

178 
	}
}

180 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

181 
	gbasic_bË
<
	gP
>::
	$´št
(
FILE
* 
f
) const {

182 
roÙ_
->
	`´št
(
f
 ? f : 
¡dout
, "", 0, 0);

183 
	}
}

	@masstree-beta/masstree_remove.hh

16 #iâdeà
MASSTREE_REMOVE_HH


17 
	#MASSTREE_REMOVE_HH


	)

18 
	~"mas¡»e_g‘.hh
"

19 
	~"bŒ“_Ëaæšk.hh
"

20 
	~"cœcuÏr_št.hh
"

21 
Çme¥aû
 
	gMas¡»e
 {

23 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

24 
boŞ
 
	gtcursÜ
<
	gP
>::
gc_Ïy”
(
th»adšfo
& 
ti
)

26 
fšd_locked
(
ti
);

27 
mas¡»e_´ecÚd™iÚ
(!
n_
->
d–‘ed
(è&& !n_->
d–‘ed_Ïy”
());

32 ià(
	gka_
.
has_suffix
())

33  
	gçl£
;

40 
	gkx_
.
	gi
 +ğ
has_v®ue
();

41 ià(
	gkx_
.
	gi
 >ğ
n_
->
size
())

42  
çl£
;

43 
³rmu‹r_ty³
 
³rm
(
n_
->
³rmutiÚ_
);

44 
	gkx_
.
	gp
 = 
³rm
[
kx_
.
i
];

45 ià(
	gn_
->
	gikey0_
[
kx_
.
p
] !ğ
ka_
.
ikey
(è|| !
n_
->
is_Ïy”
(kx_.p))

46  
çl£
;

49 
node_ty³
 *
	gÏy”
;

51 
	gÏy”
 = 
n_
->
lv_
[
kx_
.
p
].
Ïy”
();

52 ià(!
	gÏy”
->
is_roÙ
()) {

53 
	gn_
->
	glv_
[
kx_
.
p
] = 
Ïy”
->
maybe_·»Á
();

57 ià(
	gÏy”
->
i¦—f
())

60 
š‹ºode_ty³
 *
	gš
 = 
¡©ic_ÿ¡
<š‹ºode_ty³ *>(
Ïy”
);

61 ià(
	gš
->
size
() > 0)

62  
	gçl£
;

63 
	gš
->
lock
(*
Ïy”
, 
ti
.
lock_ãnû
(
tc_š‹ºode_lock
));

64 ià(!
	gš
->
is_roÙ
(è|| in->
size
() > 0)

65 
	guÆock_Ïy”
;

67 
node_ty³
 *
	gchd
 = 
š
->
chd_
[0];

68 
	gchd
->
make_Ïy”_roÙ
();

69 
	gn_
->
	glv_
[
kx_
.
p
] = 
chd
;

70 
	gš
->
m¬k_¥l™
();

71 
	gš
->
£t_·»Á
(
chd
);

73 
	gš
->
uÆock
();

74 
	gš
->
d—Îoÿ‹_rcu
(
ti
);

78 
Ëaf_ty³
* 
	glf
 = 
¡©ic_ÿ¡
<Ëaf_ty³*>(
Ïy”
);

79 ià(
	glf
->
size
() > 0)

80  
	gçl£
;

81 
	glf
->
lock
(*
lf
, 
ti
.
lock_ãnû
(
tc_Ëaf_lock
));

82 ià(!
	glf
->
is_roÙ
(è||†f->
size
() > 0)

83 
	guÆock_Ïy”
;

86 
mas¡»e_šv¬ŸÁ
(!
lf
->
´ev_
 && !lf->
Ãxt_
.
±r
);

87 
mas¡»e_šv¬ŸÁ
(!
lf
->
d–‘ed
());

88 
mas¡»e_šv¬ŸÁ
(!
lf
->
d–‘ed_Ïy”
());

89 ià(
	gP
::
Ãed_phªtom_•och


90 && 
cœcuÏr_št
<
ty³Çme
 
P
::
phªtom_•och_ty³
>::
Ëss
(
n_
->
phªtom_•och_
[0], 
lf
->phantom_epoch_[0]))

91 
	gn_
->
	gphªtom_•och_
[0] = 
lf
->
phªtom_•och_
[0];

92 
	glf
->
m¬k_d–‘ed_Ïy”
();

93 
	glf
->
uÆock
();

94 
	glf
->
d—Îoÿ‹_rcu
(
ti
);

95  
	gŒue
;

98 
	guÆock_Ïy”
:

99 
Ïy”
->
uÆock
();

100  
	gçl£
;

103 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

104 
	ggc_Ïy”_rcu_ÿÎback
 : 
public
 
P
::
th»adšfo_ty³
::
mrcu_ÿÎback
 {

105 
ty³Çme
 
	tP
::
	tth»adšfo_ty³
 
	tth»adšfo
;

106 
	gnode_ba£
<
	gP
>* 
	groÙ_
;

107 
	gËn_
;

108 
	gs_
[0];

109 
gc_Ïy”_rcu_ÿÎback
(
node_ba£
<
P
>* 
roÙ
, 
SŒ
 
´efix
)

110 : 
roÙ_
(
roÙ
), 
Ën_
(
´efix
.
Ëngth
()) {

111 
memıy
(
s_
, 
´efix
.
d©a
(), 
Ën_
);

113 
İ”©Ü
()(
	gth»adšfo
& 
	gti
);

114 
size_t
 
size
() const {

115  
	gËn_
 + (*
	gthis
);

117 
make
(
node_ba£
<
P
>* 
roÙ
, 
SŒ
 
´efix
, 
th»adšfo
& 
ti
);

120 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

121 
	ggc_Ïy”_rcu_ÿÎback
<
	gP
>::
İ”©Ü
()(
th»adšfo
& 
ti
)

123 !
roÙ_
->
is_roÙ
())

124 
roÙ_
 =„oÙ_->
maybe_·»Á
();

125 ià(!
	groÙ_
->
d–‘ed
()) {

126 
	gtcursÜ
<
	gP
> 
Í
(
roÙ_
, 
s_
, 
Ën_
);

127 
boŞ
 
	gdo_»move
 = 
Í
.
gc_Ïy”
(
ti
);

128 ià(!
	gdo_»move
 || !
	gÍ
.
fšish_»move
(
ti
))

129 
	gÍ
.
	gn_
->
uÆock
();

130 
	gti
.
d—Îoÿ‹
(
this
, 
size
(), 
memg_mas¡»e_gc
);

134 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

135 
	ggc_Ïy”_rcu_ÿÎback
<
	gP
>::
make
(
node_ba£
<
P
>* 
roÙ
, 
SŒ
 
´efix
,

136 
th»adšfo
& 
ti
)

138 
size_t
 
	gsz
 = 
´efix
.
Ën
 + (
gc_Ïy”_rcu_ÿÎback
<
P
>);

139 *
	gd©a
 = 
ti
.
®loÿ‹
(
sz
, 
memg_mas¡»e_gc
);

140 
	ggc_Ïy”_rcu_ÿÎback
<
	gP
> *
	gcb
 =

141 
Ãw
(
d©a
è
gc_Ïy”_rcu_ÿÎback
<
P
>(
roÙ
, 
	g´efix
);

142 
	gti
.
rcu_»gi¡”
(
cb
);

145 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

146 
boŞ
 
	gtcursÜ
<
	gP
>::
fšish_»move
(
th»adšfo
& 
ti
) {

147 ià(
n_
->
mod¡©e_
 =ğ
Ëaf
<
P
>::
mod¡©e_š£¹
) {

148 
n_
->
m¬k_š£¹
();

149 
	gn_
->
	gmod¡©e_
 = 
Ëaf
<
P
>::
mod¡©e_»move
;

152 
³rmu‹r_ty³
 
³rm
(
n_
->
³rmutiÚ_
);

153 
	g³rm
.
»move
(
kx_
.
i
);

154 
	gn_
->
	g³rmutiÚ_
 = 
³rm
.
v®ue
();

155 ià(
	g³rm
.
size
())

156  
	gçl£
;

158  
»move_Ëaf
(
n_
, 
roÙ_
, 
ka_
.
´efix_¡ršg
(), 
ti
);

161 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

162 
boŞ
 
	gtcursÜ
<
	gP
>::
»move_Ëaf
(
Ëaf_ty³
* 
Ëaf
, 
node_ty³
* 
roÙ
,

163 
SŒ
 
´efix
, 
th»adšfo
& 
ti
)

165 ià(!
	gËaf
->
	g´ev_
) {

166 ià(!
	gËaf
->
	gÃxt_
.
	g±r
 && !
	g´efix
.
em±y
())

167 
	ggc_Ïy”_rcu_ÿÎback
<
	gP
>::
make
(
roÙ
, 
´efix
, 
ti
);

168  
	gçl£
;

172 
	gËaf
->
m¬k_d–‘ed
();

173 
	gËaf
->
d—Îoÿ‹_rcu
(
ti
);

177 
	gP
::
Ãed_phªtom_•och
) {

178 
Ëaf_ty³
 *
´ev
 = 
Ëaf
->
´ev_
;

179 
ty³Çme
 
	gP
::
phªtom_•och_ty³
 
´ev_ts
 = 
´ev
->
phªtom_•och
();

180 
	gcœcuÏr_št
<
ty³Çme
 
	gP
::
phªtom_•och_ty³
>::
Ëss
(
´ev_ts
, 
Ëaf
->
phªtom_•och
())

181 && !
boŞ_cmpxchg
(&
´ev
->
phªtom_•och_
[0], 
´ev_ts
, 
Ëaf
->
phªtom_•och
()))

182 
	g´ev_ts
 = 
´ev
->
phªtom_•och
();

183 
ãnû
();

184 ià(
	g´ev
 =ğ
Ëaf
->
´ev_
)

189 
	gbŒ“_Ëaæšk
<
	gËaf_ty³
>::
uÆšk
(
Ëaf
);

193 
ikey_ty³
 
	gikey
 = 
Ëaf
->
ikey_bound
();

194 
node_ty³
* 
	gn
 = 
Ëaf
;

195 
node_ty³
* 
	g»¶aûm’t
 = 
nuÎ±r
;

198 
š‹ºode_ty³
 *
	gp
 = 
n
->
locked_·»Á
(
ti
);

199 
	gp
->
m¬k_š£¹
();

200 
mas¡»e_šv¬ŸÁ
(!
p
->
d–‘ed
());

202 
	gkp
 = 
š‹ºode_ty³
::
bound_ty³
::
uµ”
(
ikey
, *
p
);

203 
mas¡»e_šv¬ŸÁ
(
kp
 =ğ0 || 
p
->
ikey0_
[k°- 1] <ğ
ikey
);

204 
mas¡»e_šv¬ŸÁ
(
p
->
chd_
[
kp
] =ğ
n
);

206 
	gp
->
	gchd_
[
kp
] = 
»¶aûm’t
;

208 ià(
	g»¶aûm’t
) {

209 
	g»¶aûm’t
->
£t_·»Á
(
p
);

210 } ià(
	gkp
 > 0) {

211 
	gp
->
shiá_down
(
kp
 - 1, kp, 
p
->
nkeys_
 - kp);

212 --
	gp
->
	gnkeys_
;

215 ià(
	gkp
 <ğ1 && 
p
->
nkeys_
 > 0 && !p->
chd_
[0]) {

216 
»dœeù
(
p
, 
ikey
,…->
ikey0_
[0], 
ti
);

217 
	gikey
 = 
p
->
ikey0_
[0];

220 
	gn
->
uÆock
();

222 ià(
	gp
->
	gnkeys_
 > (p->
	gchd_
[0] =ğ
nuÎ±r
)

223 || 
p
->
is_roÙ
()) {

224 
p
->
uÆock
();

225  
	gŒue
;

228 
	gp
->
m¬k_d–‘ed
();

229 
	gp
->
d—Îoÿ‹_rcu
(
ti
);

230 
	gn
 = 
p
;

231 
	g»¶aûm’t
 = 
p
->
chd_
[p->
nkeys_
];

232 
	gp
->
	gchd_
[
p
->
nkeys_
] = 
nuÎ±r
;

236 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

237 
	gtcursÜ
<
	gP
>::
»dœeù
(
š‹ºode_ty³
* 
n
, 
ikey_ty³
 
ikey
,

238 
ikey_ty³
 
»¶aûm’t_ikey
, 
th»adšfo
& 
ti
)

240 
	gkp
 = -1;

242 
š‹ºode_ty³
* 
	gp
 = 
n
->
locked_·»Á
(
ti
);

243 ià(
	gkp
 >= 0)

244 
n
->
uÆock
();

245 
	gn
 = 
p
;

246 
	gkp
 = 
š‹ºode_ty³
::
bound_ty³
::
uµ”
(
ikey
, *
n
);

247 ià(
	gkp
 > 0) {

249 
	gn
->
	gikey0_
[
kp
 - 1] = 
»¶aûm’t_ikey
;

251 } 
	gkp
 =ğ0 || (
kp
 =ğ1 && !
n
->
chd_
[0]));

252 
	gn
->
uÆock
();

255 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

256 
	gde¡roy_rcu_ÿÎback
 : 
public
 
P
::
th»adšfo_ty³
::
mrcu_ÿÎback
 {

257 
ty³Çme
 
	tP
::
	tth»adšfo_ty³
 
	tth»adšfo
;

258 
ty³Çme
 
	tnode_ba£
<
	tP
>::
	tËaf_ty³
†eaf_type;

259 
ty³Çme
 
	tnode_ba£
<
	tP
>::
	tš‹ºode_ty³
 internode_type;

260 
	gnode_ba£
<
	gP
>* 
	groÙ_
;

261 
	gcouÁ_
;

262 
de¡roy_rcu_ÿÎback
(
node_ba£
<
P
>* 
roÙ
)

263 : 
roÙ_
(
roÙ
), 
couÁ_
(0) {

265 
İ”©Ü
()(
	gth»adšfo
& 
	gti
);

266 
make
(
node_ba£
<
P
>* 
roÙ
, 
SŒ
 
´efix
, 
th»adšfo
& 
ti
);

267 
	g´iv©e
:

268 
šlše
 
node_ba£
<
P
>** 
lšk_±r
Òode_ba£<P>* 
n
);

269 
šlše
 
’queue
(
node_ba£
<
P
>* 
n
,‚ode_ba£<P>**& 
p
);

272 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

273 
šlše
 
	gnode_ba£
<
	gP
>** 
	gde¡roy_rcu_ÿÎback
<P>::
lšk_±r
(
node_ba£
<
P
>* 
n
) {

274 ià(
n
->
i¦—f
())

275  &
¡©ic_ÿ¡
<
Ëaf_ty³
*>(
n
)->
·»Á_
;

277  &
	g¡©ic_ÿ¡
<
	gš‹ºode_ty³
*>(
	gn
)->
	g·»Á_
;

280 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

281 
šlše
 
	gde¡roy_rcu_ÿÎback
<
	gP
>::
’queue
(
node_ba£
<
P
>* 
n
,

282 
node_ba£
<
P
>**& 
p
) {

283 *
	gp
 = 
n
;

284 
	gp
 = 
lšk_±r
(
n
);

287 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

288 
	gde¡roy_rcu_ÿÎback
<
	gP
>::
İ”©Ü
()(
th»adšfo
& 
ti
) {

289 ià(++
couÁ_
 == 1) {

290 !
roÙ_
->
is_roÙ
())

291 
roÙ_
 =„oÙ_->
maybe_·»Á
();

292 
	groÙ_
->
lock
();

293 
	groÙ_
->
m¬k_d–‘ed_Œ“
();

294 
	groÙ_
->
uÆock
();

295 
	gti
.
rcu_»gi¡”
(
this
);

299 
	gnode_ba£
<
	gP
>* 
	gwÜkq
;

300 
	gnode_ba£
<
	gP
>** 
	gp
 = &
wÜkq
;

301 
’queue
(
roÙ_
, 
p
);

303 
	gnode_ba£
<
	gP
>* 
	gn
 = 
wÜkq
) {

304 
node_ba£
<
P
>** 
lškp
 = 
lšk_±r
(
n
);

305 ià(
	glškp
 !ğ
p
)

306 
wÜkq
 = *
lškp
;

308 
	gwÜkq
 = 0;

309 
	gp
 = &
wÜkq
;

312 ià(
	gn
->
i¦—f
()) {

313 
Ëaf_ty³
* 
	gl
 = 
¡©ic_ÿ¡
<Ëaf_ty³*>(
n
);

314 
ty³Çme
 
	gËaf_ty³
::
³rmu‹r_ty³
 
³rm
 = 
l
->
³rmutiÚ
();

315 
	gi
 = 0; i !ğ
l
->
size
(); ++i) {

316 
	gp
 = 
³rm
[
i
];

317 ià(
	gl
->
is_Ïy”
(
p
))

318 
’queue
(
l
->
lv_
[
p
].
Ïy”
(), 
p
);

320 
	gl
->
d—Îoÿ‹
(
ti
);

322 
š‹ºode_ty³
* 
	gš
 = 
¡©ic_ÿ¡
<š‹ºode_ty³*>(
n
);

323 
	gi
 = 0; i !ğ
š
->
size
() + 1; ++i)

324 ià(
	gš
->
	gchd_
[
i
])

325 
’queue
(
š
->
chd_
[
i
], 
p
);

326 
	gš
->
d—Îoÿ‹
(
ti
);

329 
	gti
.
d—Îoÿ‹
(
this
, Ñhis), 
memg_mas¡»e_gc
);

332 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

333 
	gbasic_bË
<
	gP
>::
de¡roy
(
th»adšfo
& 
ti
) {

334 ià(
roÙ_
) {

335 * 
d©a
 = 
ti
.
®loÿ‹
((
de¡roy_rcu_ÿÎback
<
P
>), 
memg_mas¡»e_gc
);

336 
	gde¡roy_rcu_ÿÎback
<
	gP
>* 
	gcb
 = 
Ãw
(
d©a
è
de¡roy_rcu_ÿÎback
<
P
>(
roÙ_
);

337 
	gti
.
rcu_»gi¡”
(
cb
);

338 
	groÙ_
 = 0;

	@masstree-beta/masstree_scan.hh

16 #iâdeà
MASSTREE_SCAN_HH


17 
	#MASSTREE_SCAN_HH


	)

18 
	~"mas¡»e_tcursÜ.hh
"

19 
	~"mas¡»e_¡ruù.hh
"

20 
Çme¥aû
 
	gMas¡»e
 {

22 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

23 şas 
	csÿn¡ack–t
 {

24 
	gpublic
:

25 
Ëaf
<
	tP
> 
	tËaf_ty³
;

26 
ty³Çme
 
	tËaf_ty³
::
	tËafv®ue_ty³
†eafvalue_type;

27 
ty³Çme
 
	tËaf_ty³
::
	tbound_ty³
 bound_type;

28 
ty³Çme
 
	tP
::
	tikey_ty³
 ikey_type;

29 
	gkey
<
	tikey_ty³
> 
	tkey_ty³
;

30 
ty³Çme
 
	tËaf_ty³
::
	t³rmu‹r_ty³
…ermuter_type;

31 
ty³Çme
 
	tP
::
	tth»adšfo_ty³
 
	tth»adšfo
;

32 
ty³Çme
 
	tnode_ba£
<
	tP
>::
	tnodev”siÚ_ty³
‚odeversion_type;

34 
	gËaf
<
	gP
>* 
node
() const {

35  
	gn_
;

37 
ty³Çme
 
	gnodev”siÚ_ty³
::
v®ue_ty³
 
fuÎ_v”siÚ_v®ue
() const {

38  (
v_
.
v”siÚ_v®ue
(è<< 
³rmu‹r_ty³
::
size_b™s
è+ 
³rm_
.
size
();

40 
size
() const {

41  
	g³rm_
.
size
();

43 
³rmu‹r_ty³
 
³rmutiÚ
() const {

44  
	g³rm_
;

46 
İ”©Ü
()(cÚ¡ 
	gkey_ty³
 &
	gk
, cÚ¡ 
	gsÿn¡ack–t
<
	gP
> &
	gn
, 
	gp
) {

47  
	gn
.
	gn_
->
com·»_key
(
k
, 
p
);

50 
	g´iv©e
:

51 
node_ba£
<
P
>* 
roÙ_
;

52 
	gËaf
<
	gP
>* 
	gn_
;

53 
nodev”siÚ_ty³
 
	gv_
;

54 
³rmu‹r_ty³
 
	g³rm_
;

55 
	gki_
;

56 
	gsm®l_veùÜ
<
	gnode_ba£
<
	gP
>*, 2> 
	gnode_¡ack_
;

58 ’um { 
	gsÿn_em™
, 
	gsÿn_fšd_Ãxt
, 
	gsÿn_down
, 
	gsÿn_up
, 
	gsÿn_»Œy
 };

60 
sÿn¡ack–t
() {

63 
	g‹m¶©e
 <
ty³Çme
 
	gH
>

64 
fšd_š™Ÿl
(
H
& 
h–³r
, 
key_ty³
& 
ka
, 
boŞ
 
em™_equ®
,

65 
Ëafv®ue_ty³
& 
’Œy
, 
th»adšfo
& 
ti
);

66 
	g‹m¶©e
 <
ty³Çme
 
	gH
>

67 
fšd_»Œy
(
H
& 
h–³r
, 
key_ty³
& 
ka
, 
th»adšfo
& 
ti
);

68 
	g‹m¶©e
 <
ty³Çme
 
	gH
>

69 
fšd_Ãxt
(
H
& 
h–³r
, 
key_ty³
& 
ka
, 
Ëafv®ue_ty³
& 
’Œy
);

71 
kp
() const {

72 ià((
	gki_
è< (
	g³rm_
.
size
()))

73  
	g³rm_
[
ki_
];

78 
	g‹m¶©e
 <
ty³Çme
 
	gPX
> 
ä›nd
 
şass
 
	gbasic_bË
;

81 
	sfÜw¬d_sÿn_h–³r
 {

82 
boŞ
 
š™Ÿl_ksuf_m©ch
(
ksuf_com·»
, boŞ 
em™_equ®
) const {

83  
	gksuf_com·»
 > 0 || (ksuf_com·» =ğ0 && 
em™_equ®
);

85 
	g‹m¶©e
 <
ty³Çme
 
	gK
> 
boŞ
 
is_du¶iÿ‹
(cÚ¡ 
K
 &
k
,

86 
ty³Çme
 
K
::
ikey_ty³
 
ikey
,

87 
keyËnx
) const {

88  
	gk
.
com·»
(
ikey
, 
keyËnx
) >= 0;

90 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gN
> 
low”
(cÚ¡ 
K
 &
k
, cÚ¡ 
N
 *
n
) const {

91  
	gN
::
bound_ty³
::
low”_by
(
k
, *
n
, *n).
	gi
;

93 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gN
>

94 
key_šdexed_pos™iÚ
 
low”_w™h_pos™iÚ
(cÚ¡ 
K
 &
k
, cÚ¡ 
N
 *
n
) const {

95  
	gN
::
bound_ty³
::
low”_by
(
k
, *
n
, *n);

97 
found
() const {

99 
Ãxt
(
ki
) const {

100  
	gki
 + 1;

102 
	g‹m¶©e
 <
ty³Çme
 
	gN
,y³Çm
	gK
>

103 
N
 *
advªû
(cÚ¡ N *
n
, cÚ¡ 
K
 &) const {

104  
	gn
->
§ã_Ãxt
();

106 
	g‹m¶©e
 <
ty³Çme
 
	gN
,y³Çm
	gK
>

107 
ty³Çme
 
	gN
::
nodev”siÚ_ty³
 
¡abË
(cÚ¡ 
N
 *
n
, cÚ¡ 
K
 &) const {

108  
	gn
->
¡abË
();

110 
	g‹m¶©e
 <
ty³Çme
 
	gK
> 
shiá_ş—r
(
K
 &
ka
) const {

111 
	gka
.
shiá_ş—r
();

115 
	s»v”£_sÿn_h–³r
 {

124 
»v”£_sÿn_h–³r
()

125 : 
uµ”_bound_
(
çl£
) {

127 
boŞ
 
š™Ÿl_ksuf_m©ch
(
ksuf_com·»
, boŞ 
em™_equ®
) const {

128  
	gksuf_com·»
 < 0 || (ksuf_com·» =ğ0 && 
em™_equ®
);

130 
	g‹m¶©e
 <
ty³Çme
 
	gK
> 
boŞ
 
is_du¶iÿ‹
(cÚ¡ 
K
 &
k
,

131 
ty³Çme
 
K
::
ikey_ty³
 
ikey
,

132 
keyËnx
) const {

133  
	gk
.
com·»
(
ikey
, 
keyËnx
è<ğ0 && !
uµ”_bound_
;

135 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gN
> 
low”
(cÚ¡ 
K
 &
k
, cÚ¡ 
N
 *
n
) const {

136 ià(
	guµ”_bound_
)

137  
	gn
->
size
() - 1;

138 
key_šdexed_pos™iÚ
 
	gkx
 = 
N
::
bound_ty³
::
low”_by
(
k
, *
n
, *n);

139  
	gkx
.
	gi
 - (kx.
	gp
 < 0);

141 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gN
>

142 
key_šdexed_pos™iÚ
 
low”_w™h_pos™iÚ
(cÚ¡ 
K
 &
k
, cÚ¡ 
N
 *
n
) const {

143 
key_šdexed_pos™iÚ
 
	gkx
 = 
N
::
bound_ty³
::
low”_by
(
k
, *
n
, *n);

144 
	gkx
.
	gi
 -ğ
kx
.
p
 < 0;

145  
	gkx
;

147 
Ãxt
(
ki
) const {

148  
	gki
 - 1;

150 
found
() const {

151 
	guµ”_bound_
 = 
çl£
;

153 
	g‹m¶©e
 <
ty³Çme
 
	gN
,y³Çm
	gK
>

154 
N
 *
advªû
(cÚ¡ N *
n
, 
K
 &
k
) const {

155 
	gk
.
assign_¡Üe_ikey
(
n
->
ikey_bound
());

156 
	gk
.
assign_¡Üe_Ëngth
(0);

157  
	gn
->
	g´ev_
;

159 
	g‹m¶©e
 <
ty³Çme
 
	gN
,y³Çm
	gK
>

160 
ty³Çme
 
	gN
::
nodev”siÚ_ty³
 
¡abË
(
N
 *&
n
, cÚ¡ 
K
 &
k
) const {

162 
ty³Çme
 
	gN
::
nodev”siÚ_ty³
 
v
 = 
n
->
¡abË
();

163 
N
 *
	gÃxt
 = 
n
->
§ã_Ãxt
();

164 
	gcmp
;

165 ià(!
	gÃxt


166 || (
	gcmp
 = ::
com·»
(
k
.
ikey
(), 
Ãxt
->
ikey_bound
())) < 0

167 || (
	gcmp
 =ğ0 && 
k
.
Ëngth
() == 0))

168  
v
;

169 
	gn
 = 
Ãxt
;

172 
	g‹m¶©e
 <
ty³Çme
 
	gK
> 
shiá_ş—r
(
K
 &
ka
) const {

173 
	gka
.
shiá_ş—r_»v”£
();

174 
	guµ”_bound_
 = 
Œue
;

176 
	g´iv©e
:

177 
mubË
 
boŞ
 
uµ”_bound_
;

181 
	g‹m¶©e
 <
ty³Çme
 
	gP
>em¶©<ty³Çm
	gH
>

182 
	gsÿn¡ack–t
<
	gP
>::
	$fšd_š™Ÿl
(
H
& 
h–³r
, 
key_ty³
& 
ka
, 
boŞ
 
em™_equ®
,

183 
Ëafv®ue_ty³
& 
’Œy
, 
th»adšfo
& 
ti
)

185 
key_šdexed_pos™iÚ
 
kx
;

186 
keyËnx
 = 0;

187 
suffixbuf
[
MASSTREE_MAXKEYLEN
];

188 
SŒ
 
suffix
;

190 
»Œy_roÙ
:

191 
n_
 = 
roÙ_
->
	`»ach_Ëaf
(
ka
, 
v_
, 
ti
);

193 
»Œy_node
:

194 ià(
v_
.
	`d–‘ed
())

195 
»Œy_roÙ
;

196 
n_
->
	`´eãtch
();

197 
³rm_
 = 
n_
->
	`³rmutiÚ
();

199 
kx
 = 
h–³r
.
	`low”_w™h_pos™iÚ
(
ka
, 
this
);

200 ià(
kx
.
p
 >= 0) {

201 
keyËnx
 = 
n_
->
keyËnx_
[
kx
.
p
];

202 
	`ãnû
();

203 
’Œy
 = 
n_
->
lv_
[
kx
.
p
];

204 
’Œy
.
	`´eãtch
(
keyËnx
);

205 ià(
n_
->
	`keyËnx_has_ksuf
(
keyËnx
)) {

206 
suffix
 = 
n_
->
	`ksuf
(
kx
.
p
);

207 
	`memıy
(
suffixbuf
, 
suffix
.
s
, suffix.
Ën
);

208 
suffix
.
s
 = 
suffixbuf
;

211 ià(
n_
->
	`has_chªged
(
v_
)) {

212 
ti
.
	`m¬k
(
tc_Ëaf_»Œy
);

213 
n_
 =‚_->
	`advªû_to_key
(
ka
, 
v_
, 
ti
);

214 
»Œy_node
;

217 
ki_
 = 
kx
.
i
;

218 ià(
kx
.
p
 >= 0) {

219 ià(
n_
->
	`keyËnx_is_Ïy”
(
keyËnx
)) {

220 
node_¡ack_
.
	`push_back
(
roÙ_
);

221 
node_¡ack_
.
	`push_back
(
n_
);

222 
roÙ_
 = 
’Œy
.
	`Ïy”
();

223  
sÿn_down
;

224 } ià(
n_
->
	`keyËnx_has_ksuf
(
keyËnx
)) {

225 
ksuf_com·»
 = 
suffix
.
	`com·»
(
ka
.
	`suffix
());

226 ià(
h–³r
.
	`š™Ÿl_ksuf_m©ch
(
ksuf_com·»
, 
em™_equ®
)) {

227 
keyËn
 = 
ka
.
	`assign_¡Üe_suffix
(
suffix
);

228 
ka
.
	`assign_¡Üe_Ëngth
(
keyËn
);

229  
sÿn_em™
;

231 } ià(
em™_equ®
)

232  
sÿn_em™
;

234 
ki_
 = 
h–³r
.
	`Ãxt
(ki_);

236  
sÿn_fšd_Ãxt
;

237 
	}
}

239 
	g‹m¶©e
 <
ty³Çme
 
	gP
>em¶©<ty³Çm
	gH
>

240 
	gsÿn¡ack–t
<
	gP
>::
	$fšd_»Œy
(
H
& 
h–³r
, 
key_ty³
& 
ka
, 
th»adšfo
& 
ti
)

242 
»Œy
:

243 
n_
 = 
roÙ_
->
	`»ach_Ëaf
(
ka
, 
v_
, 
ti
);

244 ià(
v_
.
	`d–‘ed
())

245 
»Œy
;

247 
n_
->
	`´eãtch
();

248 
³rm_
 = 
n_
->
	`³rmutiÚ
();

249 
ki_
 = 
h–³r
.
	`low”
(
ka
, 
this
);

250  
sÿn_fšd_Ãxt
;

251 
	}
}

253 
	g‹m¶©e
 <
ty³Çme
 
	gP
>em¶©<ty³Çm
	gH
>

254 
	gsÿn¡ack–t
<
	gP
>::
	$fšd_Ãxt
(
H
 &
h–³r
, 
key_ty³
 &
ka
, 
Ëafv®ue_ty³
 &
’Œy
)

256 
kp
;

258 ià(
v_
.
	`d–‘ed
())

259  
sÿn_»Œy
;

261 
»Œy_’Œy
:

262 
kp
 = 
this
->
	`kp
();

263 ià(
kp
 >= 0) {

264 
ikey_ty³
 
ikey
 = 
n_
->
ikey0_
[
kp
];

265 
keyËnx
 = 
n_
->
keyËnx_
[
kp
];

266 
keyËn
 = 
keyËnx
;

267 
	`ãnû
();

268 
’Œy
 = 
n_
->
lv_
[
kp
];

269 
’Œy
.
	`´eãtch
(
keyËnx
);

270 ià(
n_
->
	`keyËnx_has_ksuf
(
keyËnx
))

271 
keyËn
 = 
ka
.
	`assign_¡Üe_suffix
(
n_
->
	`ksuf
(
kp
));

273 ià(
n_
->
	`has_chªged
(
v_
))

274 
chªged
;

275 ià(
h–³r
.
	`is_du¶iÿ‹
(
ka
, 
ikey
, 
keyËnx
)) {

276 
ki_
 = 
h–³r
.
	`Ãxt
(ki_);

277 
»Œy_’Œy
;

281 
ka
.
	`assign_¡Üe_ikey
(
ikey
);

282 
h–³r
.
	`found
();

283 ià(
n_
->
	`keyËnx_is_Ïy”
(
keyËnx
)) {

284 
node_¡ack_
.
	`push_back
(
roÙ_
);

285 
node_¡ack_
.
	`push_back
(
n_
);

286 
roÙ_
 = 
’Œy
.
	`Ïy”
();

287  
sÿn_down
;

289 
ka
.
	`assign_¡Üe_Ëngth
(
keyËn
);

290  
sÿn_em™
;

294 ià(!
n_
->
	`has_chªged
(
v_
)) {

295 
n_
 = 
h–³r
.
	`advªû
Ò_, 
ka
);

296 ià(!
n_
)

297  
sÿn_up
;

298 
n_
->
	`´eãtch
();

301 
chªged
:

302 
v_
 = 
h–³r
.
	`¡abË
(
n_
, 
ka
);

303 
³rm_
 = 
n_
->
	`³rmutiÚ
();

304 
ki_
 = 
h–³r
.
	`low”
(
ka
, 
this
);

305  
sÿn_fšd_Ãxt
;

306 
	}
}

308 
	g‹m¶©e
 <
ty³Çme
 
	gP
>em¶©<ty³Çm
	gH
,y³Çm
	gF
>

309 
	gbasic_bË
<
	gP
>::
	$sÿn
(
H
 
h–³r
,

310 
SŒ
 
fœ¡key
, 
boŞ
 
em™_fœ¡key
,

311 
F
& 
sÿÂ”
,

312 
th»adšfo
& 
ti
) const {

313  
	`sÿn_w™h_lim™
(
h–³r
, 
fœ¡key
, 
em™_fœ¡key
, 
sÿÂ”
, -1, 
ti
);

314 
	}
}

316 
	g‹m¶©e
 <
ty³Çme
 
	gP
>em¶©<ty³Çm
	gH
,y³Çm
	gF
>

317 
	gbasic_bË
<
	gP
>::
	$sÿn_w™h_lim™
(
H
 
h–³r
,

318 
SŒ
 
fœ¡key
, 
boŞ
 
em™_fœ¡key
,

319 
F
& 
sÿÂ”
, 
sÿn_lim™
,

320 
th»adšfo
& 
ti
) const

322 
ty³Çme
 
	tP
::
	tikey_ty³
 ikey_type;

323 
ty³Çme
 
	tnode_ty³
::
	tkey_ty³
 key_type;

324 
ty³Çme
 
	tnode_ty³
::
	tËaf_ty³
::
	tËafv®ue_ty³
†eafvalue_type;

326 
ikey_ty³
 
x
[(
MASSTREE_MAXKEYLEN
 + (ikey_type) - 1)/(ikey_type)];

327 
s
[
MASSTREE_MAXKEYLEN
];

328 } 
keybuf
;

329 
	`mas¡»e_´ecÚd™iÚ
(
fœ¡key
.
Ën
 <ğ(è(
keybuf
));

330 
	`memıy
(
keybuf
.
s
, 
fœ¡key
.s, fœ¡key.
Ën
);

331 
key_ty³
 
	`ka
(
keybuf
.
s
, 
fœ¡key
.
Ën
);

333 
sÿn¡ack–t
<
	tP
> 
	tmy¡ack_ty³
;

334 
my¡ack_ty³
 
¡ack
;

335 
¡ack
.
roÙ_
 =„oot_;

336 
Ëafv®ue_ty³
 
’Œy
 =†—fv®ue_ty³::
	`make_em±y
();

338 
sÿncouÁ
 = 0;

339 
boŞ
 
lim™
 = 
sÿn_lim™
 > 0;

340 
¡©e
;

343 
¡©e
 = 
¡ack
.
	`fšd_š™Ÿl
(
h–³r
, 
ka
, 
em™_fœ¡key
, 
’Œy
, 
ti
);

344 
sÿÂ”
.
	`vis™_Ëaf
(
¡ack
, 
ka
, 
ti
);

345 ià(
¡©e
 !ğ
my¡ack_ty³
::
sÿn_down
)

347 
ka
.
	`shiá
();

351 
¡©e
) {

352 
my¡ack_ty³
::
sÿn_em™
:

353 ++
sÿncouÁ
;

354 ià(!
sÿÂ”
.
	`vis™_v®ue
(
ka
, 
’Œy
.
	`v®ue
(), 
ti
))

355 
dÚe
;

356 ià(
lim™
 && (
sÿncouÁ
 =ğ
sÿn_lim™
))

357 
dÚe
;

358 
¡ack
.
ki_
 = 
h–³r
.
	`Ãxt
(stack.ki_);

359 
¡©e
 = 
¡ack
.
	`fšd_Ãxt
(
h–³r
, 
ka
, 
’Œy
);

362 
my¡ack_ty³
::
sÿn_fšd_Ãxt
:

363 
fšd_Ãxt
:

364 
¡©e
 = 
¡ack
.
	`fšd_Ãxt
(
h–³r
, 
ka
, 
’Œy
);

365 ià(
¡©e
 !ğ
my¡ack_ty³
::
sÿn_up
)

366 
sÿÂ”
.
	`vis™_Ëaf
(
¡ack
, 
ka
, 
ti
);

369 
my¡ack_ty³
::
sÿn_up
:

371 ià(
¡ack
.
node_¡ack_
.
	`em±y
())

372 
dÚe
;

373 
¡ack
.
n_
 = 
¡©ic_ÿ¡
<
Ëaf
<
P
>*>(¡ack.
node_¡ack_
.
	`back
());

374 
¡ack
.
node_¡ack_
.
	`pİ_back
();

375 
¡ack
.
roÙ_
 = sck.
node_¡ack_
.
	`back
();

376 
¡ack
.
node_¡ack_
.
	`pİ_back
();

377 
ka
.
	`unshiá
();

378 } 
	`uÆik–y
(
ka
.
	`em±y
()));

379 
¡ack
.
v_
 = 
h–³r
.
	`¡abË
(¡ack.
n_
, 
ka
);

380 
¡ack
.
³rm_
 = sck.
n_
->
	`³rmutiÚ
();

381 
¡ack
.
ki_
 = 
h–³r
.
	`low”
(
ka
, &stack);

382 
fšd_Ãxt
;

384 
my¡ack_ty³
::
sÿn_down
:

385 
h–³r
.
	`shiá_ş—r
(
ka
);

386 
»Œy
;

388 
my¡ack_ty³
::
sÿn_»Œy
:

389 
»Œy
:

390 
¡©e
 = 
¡ack
.
	`fšd_»Œy
(
h–³r
, 
ka
, 
ti
);

395 
dÚe
:

396  
sÿncouÁ
;

397 
	}
}

399 
	g‹m¶©e
 <
ty³Çme
 
	gP
>em¶©<ty³Çm
	gF
>

400 
	gbasic_bË
<
	gP
>::
	$sÿn
(
SŒ
 
fœ¡key
, 
boŞ
 
em™_fœ¡key
,

401 
F
& 
sÿÂ”
,

402 
th»adšfo
& 
ti
) const

404  
	`sÿn
(
	`fÜw¬d_sÿn_h–³r
(), 
fœ¡key
, 
em™_fœ¡key
, 
sÿÂ”
, 
ti
);

405 
	}
}

407 
	g‹m¶©e
 <
ty³Çme
 
	gP
>em¶©<ty³Çm
	gF
>

408 
	gbasic_bË
<
	gP
>::
	$sÿn
(
SŒ
 
fœ¡key
, 
boŞ
 
em™_fœ¡key
,

409 
F
& 
sÿÂ”
, 
sÿn_lim™
,

410 
th»adšfo
& 
ti
) const

412  
	`sÿn_w™h_lim™
(
	`fÜw¬d_sÿn_h–³r
(), 
fœ¡key
, 
em™_fœ¡key
, 
sÿÂ”
, 
sÿn_lim™
, 
ti
);

413 
	}
}

415 
	g‹m¶©e
 <
ty³Çme
 
	gP
>em¶©<ty³Çm
	gF
>

416 
	gbasic_bË
<
	gP
>::
	$rsÿn
(
SŒ
 
fœ¡key
, 
boŞ
 
em™_fœ¡key
,

417 
F
& 
sÿÂ”
,

418 
th»adšfo
& 
ti
) const

420  
	`sÿn
(
	`»v”£_sÿn_h–³r
(), 
fœ¡key
, 
em™_fœ¡key
, 
sÿÂ”
, 
ti
);

421 
	}
}

423 
	g‹m¶©e
 <
ty³Çme
 
	gP
>em¶©<ty³Çm
	gF
>

424 
	gbasic_bË
<
	gP
>::
	$rsÿn
(
SŒ
 
fœ¡key
, 
boŞ
 
em™_fœ¡key
,

425 
F
& 
sÿÂ”
, 
sÿn_lim™
,

426 
th»adšfo
& 
ti
) const

428  
	`sÿn_w™h_lim™
(
	`»v”£_sÿn_h–³r
(), 
fœ¡key
, 
em™_fœ¡key
, 
sÿÂ”
, 
sÿn_lim™
, 
ti
);

429 
	}
}

	@masstree-beta/masstree_split.hh

16 #iâdeà
MASSTREE_SPLIT_HH


17 
	#MASSTREE_SPLIT_HH


	)

18 
	~"mas¡»e_tcursÜ.hh
"

19 
	~"bŒ“_Ëaæšk.hh
"

20 
Çme¥aû
 
	gMas¡»e
 {

23 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

24 
šlše
 
ty³Çme
 
	gP
::
ikey_ty³


25 
Ëaf
<
P
>::
ikey_aá”_š£¹
(cÚ¡ 
³rmu‹r_ty³
& 
³rm
, 
i
,

26 cÚ¡ 
key_ty³
& 
ka
, 
ka_i
) const

28 ià(
	gi
 < 
	gka_i
)

29  
	gthis
->
	gikey0_
[
³rm
[
i
]];

30 ià(
	gi
 =ğ
ka_i
)

31  
ka
.
ikey
();

33  
	gthis
->
	gikey0_
[
³rm
[
i
 - 1]];

49 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

50 
	gËaf
<
	gP
>::
¥l™_što
(
Ëaf
<
P
>* 
Ä
, 
p
, cÚ¡ 
key_ty³
& 
ka
,

51 
ikey_ty³
& 
¥l™_ikey
, 
th»adšfo
& 
ti
)

62 
mas¡»e_´ecÚd™iÚ
(!
this
->
cÚcu¼’t
 || (this->
locked
(è&& 
Ä
->locked()));

63 
mas¡»e_´ecÚd™iÚ
(
this
->
size
(è>ğthis->
width
 - 1);

65 
	gwidth
 = 
this
->
size
();

66 
	gmid
 = 
this
->
width
 / 2 + 1;

67 ià(
	gp
 =ğ0 && !
this
->
´ev_
)

68 
mid
 = 1;

69 ià(
	gp
 =ğ
width
 && !
this
->
Ãxt_
.
±r
)

70 
mid
 = 
width
;

73 
³rmu‹r_ty³
 
³rml
(
this
->
³rmutiÚ_
);

74 
ikey_ty³
 
	gmid_ikey
 = 
ikey_aá”_š£¹
(
³rml
, 
mid
, 
ka
, 
p
);

75 ià(
	gmid_ikey
 =ğ
ikey_aá”_š£¹
(
³rml
, 
mid
 - 1, 
ka
, 
p
)) {

76 
	gmidl
 = 
mid
 - 2, 
	gmidr
 = mid + 1;

78 ià(
	gmidr
 <ğ
width


79 && 
mid_ikey
 !ğ
ikey_aá”_š£¹
(
³rml
, 
midr
, 
ka
, 
p
)) {

80 
	gmid
 = 
midr
;

82 } ià(
	gmidl
 >= 0

83 && 
mid_ikey
 !ğ
ikey_aá”_š£¹
(
³rml
, 
midl
, 
ka
, 
p
)) {

84 
	gmid
 = 
midl
 + 1;

87 --
	gmidl
, ++
	gmidr
;

89 
mas¡»e_šv¬ŸÁ
(
mid
 > 0 && mid <ğ
width
);

92 
ty³Çme
 
	g³rmu‹r_ty³
::
v®ue_ty³
 
pv
 = 
³rml
.
v®ue_äom
(
mid
 - (
p
 < mid));

93 
	gx
 = 
mid
; x <ğ
width
; ++x)

94 ià(
	gx
 =ğ
p
)

95 
Ä
->
assign_š™Ÿlize
(
x
 - 
mid
, 
ka
, 
ti
);

97 
	gÄ
->
assign_š™Ÿlize
(
x
 - 
mid
, 
this
, 
pv
 & 15, 
ti
);

98 
	gpv
 >>= 4;

100 
³rmu‹r_ty³
 
	g³rmr
 =…”mu‹r_ty³::
make_sÜ‹d
(
width
 + 1 - 
mid
);

101 ià(
	gp
 >ğ
mid
)

102 
³rmr
.
»move_to_back
(
p
 - 
mid
);

103 
	gÄ
->
	g³rmutiÚ_
 = 
³rmr
.
v®ue
();

105 
	gbŒ“_Ëaæšk
<
	gËaf
<
	gP
>, P::
cÚcu¼’t
>::
lšk_¥l™
(
this
, 
Ä
);

107 
	g¥l™_ikey
 = 
Ä
->
ikey0_
[0];

108  
	gp
 >ğ
mid
 ? 1 + (mid =ğ
width
) : 0;

111 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

112 
	gš‹ºode
<
	gP
>::
¥l™_što
(
š‹ºode
<
P
> *
Ä
, 
p
, 
ikey_ty³
 
ka
,

113 
node_ba£
<
P
> *
v®ue
, 
ikey_ty³
& 
¥l™_ikey
,

114 
¥l™_ty³
)

130 
mas¡»e_´ecÚd™iÚ
(!
this
->
cÚcu¼’t
 || (this->
locked
(è&& 
Ä
->locked()));

132 
	gmid
 = (
¥l™_ty³
 =ğ2 ? 
this
->
width
 : (this->width + 1) / 2);

133 
	gÄ
->
	gnkeys_
 = 
this
->
width
 + 1 - (
mid
 + 1);

135 ià(
	gp
 < 
	gmid
) {

136 
	gÄ
->
	gchd_
[0] = 
this
->
chd_
[
mid
];

137 
	gÄ
->
shiá_äom
(0, 
this
, 
mid
,his->
width
 - mid);

138 
	g¥l™_ikey
 = 
this
->
ikey0_
[
mid
 - 1];

139 } ià(
	gp
 =ğ
mid
) {

140 
Ä
->
chd_
[0] = 
v®ue
;

141 
	gÄ
->
shiá_äom
(0, 
this
, 
mid
,his->
width
 - mid);

142 
	g¥l™_ikey
 = 
ka
;

144 
	gÄ
->
	gchd_
[0] = 
this
->
chd_
[
mid
 + 1];

145 
	gÄ
->
shiá_äom
(0, 
this
, 
mid
 + 1, 
p
 - (mid + 1));

146 
	gÄ
->
assign
(
p
 - (
mid
 + 1), 
ka
, 
v®ue
);

147 
	gÄ
->
shiá_äom
(
p
 + 1 - (
mid
 + 1), 
this
,…,his->
width
 -…);

148 
	g¥l™_ikey
 = 
this
->
ikey0_
[
mid
];

151 
	gi
 = 0; i <ğ
Ä
->
nkeys_
; ++i)

152 
	gÄ
->
	gchd_
[
i
]->
£t_·»Á
(
Ä
);

154 
	gthis
->
m¬k_¥l™
();

155 ià(
	gp
 < 
	gmid
) {

156 
	gthis
->
	gnkeys_
 = 
mid
 - 1;

157  
	gp
;

159 
	gthis
->
	gnkeys_
 = 
mid
;

165 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

166 
boŞ
 
	gtcursÜ
<
	gP
>::
make_¥l™
(
th»adšfo
& 
ti
)

172 ià(
n_
->
size
(è<‚_->
width
) {

173 
³rmu‹r_ty³
 
³rm
(
n_
->
³rmutiÚ_
);

174 
	g³rm
.
exchªge
(
³rm
.
size
(), 
n_
->
width
 - 1);

175 
	gkx_
.
	gp
 = 
³rm
.
back
();

176 ià(
	gkx_
.
	gp
 != 0) {

177 
n_
->
³rmutiÚ_
 = 
³rm
.
v®ue
();

178 
ãnû
();

179 
	gn_
->
assign
(
kx_
.
p
, 
ka_
, 
ti
);

180  
	gçl£
;

184 
node_ty³
* 
	gchd
 = 
Ëaf_ty³
::
make
(
n_
->
ksuf_u£d_ÿ·c™y
(),‚_->
phªtom_•och
(), 
ti
);

185 
	gchd
->
assign_v”siÚ
(*
n_
);

186 
ikey_ty³
 
	gxikey
[2];

187 
	g¥l™_ty³
 = 
n_
->
¥l™_što
(
¡©ic_ÿ¡
<
Ëaf_ty³
*>(
chd
),

188 
kx_
.
i
, 
ka_
, 
xikey
[0], 
ti
);

189 
boŞ
 
	g£n£
 = 
çl£
;

190 
node_ty³
* 
	gn
 = 
n_
;

191 
ušt32_t
 
	gheight
 = 0;

194 
mas¡»e_šv¬ŸÁ
(!
n
->
cÚcu¼’t
 || (n->
locked
(è&& 
chd
->locked(è&& (n->
i¦—f
(è||‚->
¥l™tšg
())));

195 
š‹ºode_ty³
 *
	gÃxt_chd
 = 0;

197 
š‹ºode_ty³
 *
	gp
 = 
n
->
locked_·»Á
(
ti
);

199 
	gkp
 = -1;

200 ià(
	gn
->
·»Á_exi¡s
(
p
)) {

201 
	gkp
 = 
š‹ºode_ty³
::
bound_ty³
::
uµ”
(
xikey
[
£n£
], *
p
);

202 
	gp
->
m¬k_š£¹
();

205 ià(
	gkp
 < 0 || 
	gp
->
	gheight_
 > 
	gheight
 + 1) {

206 
š‹ºode_ty³
 *
	gÂ
 = iÁ”node_ty³::
make
(
height
 + 1, 
ti
);

207 
	gÂ
->
	gchd_
[0] = 
n
;

208 
	gÂ
->
assign
(0, 
xikey
[
£n£
], 
chd
);

209 
	gÂ
->
	gnkeys_
 = 1;

210 ià(
	gkp
 < 0) {

211 
	gÂ
->
make_Ïy”_roÙ
();

213 
	gÂ
->
£t_·»Á
(
p
);

214 
	gp
->
	gchd_
[
kp
] = 
Â
;

216 
ãnû
();

217 
	gn
->
£t_·»Á
(
Â
);

219 ià(
	gp
->
size
(è>ğ
p
->
width
) {

220 
Ãxt_chd
 = 
š‹ºode_ty³
::
make
(
height
 + 1, 
ti
);

221 
	gÃxt_chd
->
assign_v”siÚ
(*
p
);

222 
	gÃxt_chd
->
m¬k_nÚroÙ
();

223 
	gkp
 = 
p
->
¥l™_što
(
Ãxt_chd
, 
kp
, 
xikey
[
£n£
],

224 
chd
, 
xikey
[!
£n£
], 
¥l™_ty³
);

226 ià(
	gkp
 >= 0) {

227 
p
->
shiá_up
(
kp
 + 1, kp,…->
size
() - kp);

228 
	gp
->
assign
(
kp
, 
xikey
[
£n£
], 
chd
);

229 
ãnû
();

230 ++
	gp
->
	gnkeys_
;

234 ià(
	gn
->
i¦—f
()) {

235 
Ëaf_ty³
 *
	gÆ
 = 
¡©ic_ÿ¡
<Ëaf_ty³ *>(
n
);

236 
Ëaf_ty³
 *
	gÄ
 = 
¡©ic_ÿ¡
<Ëaf_ty³ *>(
chd
);

237 
³rmu‹r_ty³
 
³rml
(
Æ
->
³rmutiÚ_
);

238 
	gwidth
 = 
³rml
.
size
();

239 
	g³rml
.
£t_size
(
width
 - 
Ä
->
size
());

241 ià(
	gwidth
 !ğ
Æ
->
width
)

242 
³rml
.
exchªge
Õ”ml.
size
(), 
Æ
->
width
 - 1);

243 
	gÆ
->
m¬k_¥l™
();

244 
	gÆ
->
	g³rmutiÚ_
 = 
³rml
.
v®ue
();

245 ià(
	g¥l™_ty³
 == 0) {

246 
kx_
.
p
 = 
³rml
.
back
();

247 
	gÆ
->
assign
(
kx_
.
p
, 
ka_
, 
ti
);

249 
	gkx_
.
	gi
 = 
kx_
.
p
 = kx_.
i
 - 
³rml
.
size
();

250 
	gn_
 = 
Ä
;

253 ià(
	gÆ
 !ğ
n_
) {

254 
as£¹
(
Ä
 =ğ
n_
);

256 
	gupd©ed_v_
 = 
Æ
->
fuÎ_uÆocked_v”siÚ_v®ue
();

258 
	gÃw_nodes_
.
em¶aû_back
(
Ä
,‚r->
fuÎ_uÆocked_v”siÚ_v®ue
());

261 ià(
	gn
 !ğ
n_
)

262 
n
->
uÆock
();

263 ià(
	gchd
 !ğ
n_
)

264 
chd
->
uÆock
();

265 ià(
	gÃxt_chd
) {

266 
	gn
 = 
p
;

267 
	gchd
 = 
Ãxt_chd
;

268 
	g£n£
 = !
£n£
;

269 ++
	gheight
;

270 } ià(
	gp
) {

271 
	gp
->
uÆock
();

277  
	gçl£
;

	@masstree-beta/masstree_stats.hh

16 #iâdeà
MASSTREE_STATS_HH


17 
	#MASSTREE_STATS_HH


	)

18 
	~"mas¡»e.hh
"

19 
	~"jsÚ.hh
"

21 
Çme¥aû
 
	gMas¡»e
 {

23 
	g‹m¶©e
 <
ty³Çme
 
	gP
,y³Çm
	gTI
>

24 
node_jsÚ_¡©s
(
node_ba£
<
P
>* 
n
, 
lcdf
::
JsÚ
& 
j
, 
Ïy”
, 
d•th
,

25 
TI
& 
ti
)

27 ià(!
	gn
)

29 ià(
	gn
->
i¦—f
()) {

30 
	gËaf
<
	gP
>* 
	glf
 = 
¡©ic_ÿ¡
<
Ëaf
<
P
>*>(
n
);

32 
	gj
[&"l1_node_by_d•th"[!
Ïy”
 * 3]][
d•th
] += 1;

33 
	gj
[&"l1_Ëaf_by_d•th"[!
Ïy”
 * 3]][
d•th
] += 1;

34 
	gj
[&"l1_Ëaf_by_size"[!
Ïy”
 * 3]][
lf
->
size
()] += 1;

37 
ty³Çme
 
	gËaf
<
	gP
>::
³rmu‹r_ty³
 
³rm
(
lf
->
³rmutiÚ_
);

38 
	gn
 = 0, 
	gnksuf
 = 0;

39 
size_t
 
	gaùive_ksuf_Ën
 = 0;

40 
	gi
 = 0; i < 
	g³rm
.
size
(); ++i)

41 ià(
	glf
->
is_Ïy”
(
³rm
[
i
])) {

42 
	glcdf
::
JsÚ
 
x
 = 
j
["l1_size"];

43 
	gj
["l1_size"] = 0;

44 
node_jsÚ_¡©s
(
lf
->
lv_
[
³rm
[
i
]].
Ïy”
(), 
j
,†ay” + 1, 0, 
ti
);

45 
	gj
["l1_size_sum"] +ğ
j
["l1_size"].
to_i
();

46 
	gj
["l1_size"] = 
x
;

47 
	gj
["l1_count"] += 1;

49 ++
	gn
;

50 
	gl
 = (
ty³Çme
 
P
::
ikey_ty³
è* 
Ïy”


51 + 
lf
->
keyËnx_
[
³rm
[
i
]];

52 ià(
	glf
->
has_ksuf
(
³rm
[
i
])) {

53 
size_t
 
	gksuf_Ën
 = 
lf
->
ksuf
(
³rm
[
i
]).
Ën
;

54 
	gl
 +ğ
ksuf_Ën
 - 1;

55 
	gaùive_ksuf_Ën
 +ğ
ksuf_Ën
;

56 ++
	gnksuf
;

58 
	gj
["key_by_Ëngth"][
l
] += 1;

60 
	gj
["size"] +ğ
n
;

61 
	gj
["l1_size"] +ğ
n
;

62 
	gj
["key_by_Ïy”"][
Ïy”
] +ğ
n
;

65 ià(
	glf
->
®loÿ‹d_size
(è!ğ
lf
->
mš_®loÿ‹d_size
()

66 && 
lf
->
ksuf_ex‹º®
()) {

67 
j
["overridden_ksuf"] += 1;

68 
	gj
["ov”ridd’_ksuf_ÿ·c™y"] +ğ
lf
->
®loÿ‹d_size
(è-†f->
mš_®loÿ‹d_size
();

70 ià(
	glf
->
ksuf_ÿ·c™y
()) {

71 
	gj
["ksuf"] += 1;

72 
	gj
["ksuf_ÿ·c™y"] +ğ
lf
->
ksuf_ÿ·c™y
();

73 
	gj
["ksuf_Ën"] +ğ
aùive_ksuf_Ën
;

74 
	gj
["ksuf_by_Ïy”"][
Ïy”
] += 1;

75 ià(!
	gaùive_ksuf_Ën
) {

76 
	gj
["unu£d_ksuf_ÿ·c™y"] +ğ
lf
->
ksuf_ÿ·c™y
();

77 
	gj
["unu£d_ksuf_by_Ïy”"][
Ïy”
] += 1;

78 ià(
	glf
->
ksuf_ex‹º®
())

79 
	gj
["unused_ksuf_external"] += 1;

81 
	gj
["u£d_ksuf_by_Ïy”"][
Ïy”
] += 1;

84 
	gš‹ºode
<
	gP
> *
	gš
 = 
¡©ic_ÿ¡
<
š‹ºode
<
P
> *>(
n
);

85 
	gi
 = 0; i <ğ
š
->
size
(); ++i)

86 ià(
	gš
->
	gchd_
[
i
])

87 
node_jsÚ_¡©s
(
š
->
chd_
[
i
], 
j
, 
Ïy”
, 
d•th
 + 1, 
ti
);

88 
	gj
[&"l1_node_by_d•th"[!
Ïy”
 * 3]][
d•th
] += 1;

89 
	gj
[&"l1_š‹ºode_by_size"[!
Ïy”
 * 3]][
š
->
size
()] += 1;

93 
	g‹m¶©e
 <
ty³Çme
 
	gP
,y³Çm
	gTI
>

94 
jsÚ_¡©s
(
lcdf
::
JsÚ
& 
j
, 
basic_bË
<
P
>& 
bË
, 
TI
& 
ti
)

96 
usšg
 
	glcdf
::
JsÚ
;

97 
	gj
["size"] = 0.0;

98 
	gj
["l1_count"] = 0;

99 
	gj
["l1_size"] = 0;

100 cÚ¡ * cÚ¡ 
	gj¬¿ys
[] = {

106 cÚ¡ * cÚ¡* 
	gx
 = 
j¬¿ys
; x != jarrays + (jarrays) / (*jarrays); ++x)

107 
	gj
[*
x
] = 
JsÚ
::
make_¬¿y
();

109 
node_jsÚ_¡©s
(
bË
.
roÙ
(), 
j
, 0, 0, 
ti
);

111 
	gj
.
un£t
("l1_size");

112 cÚ¡ * cÚ¡* 
	gx
 = 
j¬¿ys
; x != jarrays + (jarrays) / (*jarrays); ++x) {

113 
	gJsÚ
& 
	ga
 = 
j
[*
x
];

114 
JsÚ
* 
	g™
 = 
a
.
¬¿y_d©a
(); iˆ!ğa.
’d_¬¿y_d©a
(); ++it)

115 ià(!*
	g™
)

116 *
	g™
 = 
JsÚ
((
size_t
) 0);

117 ià(
	ga
.
em±y
())

118 
	gj
.
un£t
(*
x
);

122 
	g‹m¶©e
 <
ty³Çme
 
	gP
,y³Çm
	gTI
>

123 
	glcdf
::
JsÚ
 
jsÚ_¡©s
(
basic_bË
<
P
>& 
bË
, 
TI
& 
ti
) {

124 
	glcdf
::
JsÚ
 
j
;

125 
jsÚ_¡©s
(
j
, 
bË
, 
ti
);

126  
	gj
;

	@masstree-beta/masstree_struct.hh

16 #iâdeà
MASSTREE_STRUCT_HH


17 
	#MASSTREE_STRUCT_HH


	)

18 
	~"mas¡»e.hh
"

19 
	~"nodev”siÚ.hh
"

20 
	~"¡ršgbag.hh
"

21 
	~"mtcouÁ”s.hh
"

22 
	~"time¡amp.hh
"

23 
Çme¥aû
 
	gMas¡»e
 {

25 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

26 
	smake_nodev”siÚ
 {

27 
	gnodev”siÚ_·¿m‘”s
<
	tty³Çme
 
	tP
::
	tnodev”siÚ_v®ue_ty³
> 
	t·¿m‘”s_ty³
;

28 
ty³Çme
 
	tmass
::
	tcÚd™iÚ®
<
	tP
::
	tcÚcu¼’t
,

29 
	tnodev”siÚ
<
	t·¿m‘”s_ty³
>,

30 
	tsšgËth»aded_nodev”siÚ
<
	t·¿m‘”s_ty³
> >::
	tty³
ype;

33 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

34 
	smake_´eãtch”
 {

35 
ty³Çme
 
	tmass
::
	tcÚd™iÚ®
<
	tP
::
	t´eãtch
,

36 
	tv®ue_´eãtch”
<
	tty³Çme
 
	tP
::
	tv®ue_ty³
>,

37 
	tdo_nÙhšg
>::
	tty³
ype;

40 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

41 
şass
 
	gnode_ba£
 : 
public
 
make_nodev”siÚ
<
P
>::
ty³
 {

42 
public
:

43 
cÚ¡ex´
 
boŞ
 
cÚcu¼’t
 = 
P
::concurrent;

44 
cÚ¡ex´
 
	gnikey
 = 1;

45 
	gËaf
<
	tP
> 
	tËaf_ty³
;

46 
	gš‹ºode
<
	tP
> 
	tš‹ºode_ty³
;

47 
	gnode_ba£
<
	tP
> 
	tba£_ty³
;

48 
ty³Çme
 
	tP
::
	tv®ue_ty³
 value_type;

49 
	gËafv®ue
<
	tP
> 
	tËafv®ue_ty³
;

50 
ty³Çme
 
	tP
::
	tikey_ty³
 ikey_type;

51 
	gkey
<
	tikey_ty³
> 
	tkey_ty³
;

52 
ty³Çme
 
	tmake_nodev”siÚ
<
	tP
>::
	tty³
 
	tnodev”siÚ_ty³
;

53 
ty³Çme
 
	tP
::
	tth»adšfo_ty³
 
	tth»adšfo
;

55 
node_ba£
(
boŞ
 
i¦—f
)

56 : 
nodev”siÚ_ty³
(
i¦—f
) {

59 
šlše
 
ba£_ty³
* 
·»Á
() const {

61 ià(
this
->
i¦—f
())

62  
¡©ic_ÿ¡
<cÚ¡ 
Ëaf_ty³
*>(
this
)->
·»Á_
;

64  
	g¡©ic_ÿ¡
<cÚ¡ 
	gš‹ºode_ty³
*>(
	gthis
)->
	g·»Á_
;

66 
šlše
 
boŞ
 
·»Á_exi¡s
(
ba£_ty³
* 
p
) const {

67  
	gp
 !ğ
nuÎ±r
;

69 
šlše
 
boŞ
 
has_·»Á
() const {

70  
·»Á_exi¡s
(
·»Á
());

72 
šlše
 
š‹ºode_ty³
* 
locked_·»Á
(
th»adšfo
& 
ti
) const;

73 
šlše
 
£t_·»Á
(
ba£_ty³
* 
p
) {

74 ià(
	gthis
->
i¦—f
())

75 
	g¡©ic_ÿ¡
<
	gËaf_ty³
*>(
	gthis
)->
	g·»Á_
 = 
p
;

77 
	g¡©ic_ÿ¡
<
	gš‹ºode_ty³
*>(
	gthis
)->
	g·»Á_
 = 
p
;

79 
šlše
 
make_Ïy”_roÙ
() {

80 
£t_·»Á
(
nuÎ±r
);

81 
	gthis
->
m¬k_roÙ
();

83 
šlše
 
ba£_ty³
* 
maybe_·»Á
() const {

84 
ba£_ty³
* 
	gx
 = 
·»Á
();

85  
·»Á_exi¡s
(
x
è? 
	gx
 : 
cÚ¡_ÿ¡
<
ba£_ty³
*>(
this
);

88 
šlše
 
Ëaf_ty³
* 
»ach_Ëaf
(cÚ¡ 
key_ty³
& 
k
, 
nodev”siÚ_ty³
& 
v”siÚ
,

89 
th»adšfo
& 
ti
) const;

91 
´eãtch_fuÎ
() const {

92 
	gi
 = 0; i < 
	g¡d
::
mš
(16 * 
¡d
::mš(
P
::
Ëaf_width
, P::
š‹ºode_width
) + 1, 4 * 64); i += 64)

93 ::
´eãtch
((cÚ¡ *è
this
 + 
i
);

96 
´št
(
FILE
* 
f
, cÚ¡ * 
´efix
, 
d•th
, 
kd•th
) const;

99 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

100 
şass
 
	gš‹ºode
 : 
public
 
node_ba£
<
P
> {

101 
public
:

102 
cÚ¡ex´
 
width
 = 
P
::
š‹ºode_width
;

103 
ty³Çme
 
	tnode_ba£
<
	tP
>::
	tnodev”siÚ_ty³
‚odeversion_type;

104 
	gkey
<
	tty³Çme
 
	tP
::
	tikey_ty³
> 
	tkey_ty³
;

105 
ty³Çme
 
	tP
::
	tikey_ty³
 ikey_type;

106 
ty³Çme
 
	tkey_bound
<
	twidth
, 
	tP
::
	tbound_m‘hod
>::
	tty³
 
	tbound_ty³
;

107 
ty³Çme
 
	tP
::
	tth»adšfo_ty³
 
	tth»adšfo
;

109 
ušt8_t
 
	gnkeys_
;

110 
ušt32_t
 
	gheight_
;

111 
ikey_ty³
 
	gikey0_
[
width
];

112 
	gnode_ba£
<
	gP
>* 
	gchd_
[
width
 + 1];

113 
	gnode_ba£
<
	gP
>* 
	g·»Á_
;

114 
kvtime¡amp_t
 
	gü—‹d_©_
[
P
::
debug_Ëv–
 > 0];

116 
š‹ºode
(
ušt32_t
 
height
)

117 : 
node_ba£
<
P
>(
çl£
), 
nkeys_
(0), 
height_
(
height
), 
·»Á_
() {

120 
	gš‹ºode
<
	gP
>* 
make
(
ušt32_t
 
height
, 
th»adšfo
& 
ti
) {

121 * 
	g±r
 = 
ti
.
poŞ_®loÿ‹
((
š‹ºode
<
P
>),

122 
memg_mas¡»e_š‹ºode
);

123 
	gš‹ºode
<
	gP
>* 
	gn
 = 
Ãw
(
±r
è
š‹ºode
<
P
>(
height
);

124 
as£¹
(
n
);

125 ià(
	gP
::
debug_Ëv–
 > 0)

126 
n
->
ü—‹d_©_
[0] = 
ti
.
İ”©iÚ_time¡amp
();

127  
	gn
;

130 
size
() const {

131  
	gnkeys_
;

134 
key_ty³
 
g‘_key
(
p
) const {

135  
key_ty³
(
ikey0_
[
p
]);

137 
ikey_ty³
 
ikey
(
p
) const {

138  
	gikey0_
[
p
];

140 
com·»_key
(
ikey_ty³
 
a
, 
bp
) const {

141  ::
com·»
(
a
, 
ikey
(
bp
));

143 
com·»_key
(cÚ¡ 
key_ty³
& 
a
, 
bp
) const {

144  ::
com·»
(
a
.
ikey
(), ikey(
bp
));

146 
šlše
 
¡abË_Ï¡_key_com·»
(cÚ¡ 
key_ty³
& 
k
, 
nodev”siÚ_ty³
 
v
,

147 
th»adšfo
& 
ti
) const;

149 
´eãtch
() const {

150 
	gi
 = 64; i < 
	g¡d
::
mš
(16 * 
width
 + 1, 4 * 64); i += 64)

151 ::
´eãtch
((cÚ¡ *è
this
 + 
i
);

154 
´št
(
FILE
* 
f
, cÚ¡ * 
´efix
, 
d•th
, 
kd•th
) const;

156 
d—Îoÿ‹
(
th»adšfo
& 
ti
) {

157 
	gti
.
poŞ_d—Îoÿ‹
(
this
, (*this), 
memg_mas¡»e_š‹ºode
);

159 
d—Îoÿ‹_rcu
(
th»adšfo
& 
ti
) {

160 
	gti
.
poŞ_d—Îoÿ‹_rcu
(
this
, (*this), 
memg_mas¡»e_š‹ºode
);

163 
	g´iv©e
:

164 
assign
(
p
, 
ikey_ty³
 
ikey
, 
node_ba£
<
P
>* 
chd
) {

165 
	gchd
->
£t_·»Á
(
this
);

166 
	gchd_
[
p
 + 1] = 
chd
;

167 
	gikey0_
[
p
] = 
ikey
;

170 
shiá_äom
(
p
, cÚ¡ 
š‹ºode
<
P
>* 
x
, 
xp
, 
n
) {

171 
mas¡»e_´ecÚd™iÚ
(
x
 !ğ
this
);

172 ià(
	gn
) {

173 
memıy
(
ikey0_
 + 
p
, 
x
->ikey0_ + 
xp
, (ikey0_[0]è* 
n
);

174 
memıy
(
chd_
 + 
p
 + 1, 
x
->chd_ + 
xp
 + 1, (chd_[0]è* 
n
);

177 
shiá_up
(
p
, 
xp
, 
n
) {

178 
memmove
(
ikey0_
 + 
p
, ikey0_ + 
xp
, (ikey0_[0]è* 
n
);

179 
	gnode_ba£
<
	gP
> **
	ga
 = 
chd_
 + 
p
 + 
n
, **
	gb
 = chd_ + 
xp
 +‚; 
	gn
; --a, --b, --n)

180 *
	ga
 = *
b
;

182 
shiá_down
(
p
, 
xp
, 
n
) {

183 
memmove
(
ikey0_
 + 
p
, ikey0_ + 
xp
, (ikey0_[0]è* 
n
);

184 
	gnode_ba£
<
	gP
> **
	ga
 = 
chd_
 + 
p
 + 1, **
	gb
 = chd_ + 
xp
 + 1; 
	gn
; ++a, ++b, --n)

185 *
	ga
 = *
b
;

188 
¥l™_što
(
š‹ºode
<
P
>* 
Ä
, 
p
, 
ikey_ty³
 
ka
, 
node_ba£
<P>* 
v®ue
,

189 
ikey_ty³
& 
¥l™_ikey
, 
¥l™_ty³
);

191 
	g‹m¶©e
 <
ty³Çme
 
	gPP
> 
ä›nd
 
şass
 
	gtcursÜ
;

194 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

195 şas 
	cËafv®ue
 {

196 
	gpublic
:

197 
ty³Çme
 
	tP
::
	tv®ue_ty³
 value_type;

198 
ty³Çme
 
	tmake_´eãtch”
<
	tP
>::
	tty³
 
	t´eãtch”_ty³
;

200 
Ëafv®ue
() {

202 
Ëafv®ue
(
v®ue_ty³
 
v
) {

203 
	gu_
.
	gv
 = 
v
;

205 
Ëafv®ue
(
node_ba£
<
P
>* 
n
) {

206 
	gu_
.
	gx
 = 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
n
);

209 
	gËafv®ue
<
	gP
> 
make_em±y
() {

210  
	gËafv®ue
<
	gP
>(
v®ue_ty³
());

213 
boŞ
 (
	tËafv®ue
<
	tP
>::*
	tun¥ecif›d_boŞ_ty³
)() const;

214 
İ”©Ü
 
un¥ecif›d_boŞ_ty³
() const {

215  
	gu_
.
	gx
 ? &
	gËafv®ue
<
	gP
>::
em±y
 : 0;

217 
boŞ
 
em±y
() const {

218  !
	gu_
.
	gx
;

221 
v®ue_ty³
 
v®ue
() const {

222  
	gu_
.
	gv
;

224 
	gv®ue_ty³
& 
v®ue
() {

225  
	gu_
.
	gv
;

228 
	gnode_ba£
<
	gP
>* 
Ïy”
() const {

229  
	g»š‹½»t_ÿ¡
<
	gnode_ba£
<
	gP
>*>(
	gu_
.
	gx
);

232 
´eãtch
(
keyËnx
) const {

233 ià(!
	gËaf
<
	gP
>::
keyËnx_is_Ïy”
(
keyËnx
))

234 
´eãtch”_ty³
()(
u_
.
v
);

236 
	gu_
.
	gn
->
´eãtch_fuÎ
();

239 
	g´iv©e
:

241 
node_ba£
<
P
>* 
n
;

242 
v®ue_ty³
 
	gv
;

243 
ušŒ_t
 
	gx
;

244 } 
	gu_
;

247 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

248 
şass
 
	gËaf
 : 
public
 
node_ba£
<
P
> {

249 
public
:

250 
cÚ¡ex´
 
width
 = 
P
::
Ëaf_width
;

251 
ty³Çme
 
	tnode_ba£
<
	tP
>::
	tnodev”siÚ_ty³
‚odeversion_type;

252 
	gkey
<
	tty³Çme
 
	tP
::
	tikey_ty³
> 
	tkey_ty³
;

253 
ty³Çme
 
	tnode_ba£
<
	tP
>::
	tËafv®ue_ty³
†eafvalue_type;

254 
	gk³rmu‹r
<
	tP
::
	tËaf_width
> 
	t³rmu‹r_ty³
;

255 
ty³Çme
 
	tP
::
	tikey_ty³
 ikey_type;

256 
ty³Çme
 
	tkey_bound
<
	twidth
, 
	tP
::
	tbound_m‘hod
>::
	tty³
 
	tbound_ty³
;

257 
ty³Çme
 
	tP
::
	tth»adšfo_ty³
 
	tth»adšfo
;

258 
	g¡ršgbag
<
	tušt8_t
> 
	tš‹º®_ksuf_ty³
;

259 
	g¡ršgbag
<
	tušt16_t
> 
	tex‹º®_ksuf_ty³
;

260 
ty³Çme
 
	tP
::
	tphªtom_•och_ty³
…hantom_epoch_type;

261 
cÚ¡ex´
 
	gksuf_keyËnx
 = 64;

262 
cÚ¡ex´
 
	gÏy”_keyËnx
 = 128;

265 
	gmod¡©e_š£¹
 = 0, 
	gmod¡©e_»move
 = 1, 
	gmod¡©e_d–‘ed_Ïy”
 = 2

268 
št8_t
 
	gexŒasize64_
;

269 
ušt8_t
 
	gmod¡©e_
;

270 
ušt8_t
 
	gkeyËnx_
[
width
];

271 
ty³Çme
 
	g³rmu‹r_ty³
::
¡Üage_ty³
 
³rmutiÚ_
;

272 
ikey_ty³
 
	gikey0_
[
width
];

273 
Ëafv®ue_ty³
 
	glv_
[
width
];

274 
ex‹º®_ksuf_ty³
* 
	gksuf_
;

276 
	gËaf
<
	gP
>* 
	g±r
;

277 
ušŒ_t
 
	gx
;

278 } 
	gÃxt_
;

279 
	gËaf
<
	gP
>* 
	g´ev_
;

280 
	gnode_ba£
<
	gP
>* 
	g·»Á_
;

281 
phªtom_•och_ty³
 
	gphªtom_•och_
[
P
::
Ãed_phªtom_•och
];

282 
kvtime¡amp_t
 
	gü—‹d_©_
[
P
::
debug_Ëv–
 > 0];

283 
š‹º®_ksuf_ty³
 
	giksuf_
[0];

285 
Ëaf
(
size_t
 
sz
, 
phªtom_•och_ty³
 
phªtom_•och
)

286 : 
node_ba£
<
P
>(
Œue
), 
mod¡©e_
(
mod¡©e_š£¹
),

287 
³rmutiÚ_
(
³rmu‹r_ty³
::
make_em±y
()),

288 
ksuf_
(), 
·»Á_
(), 
	giksuf_
{} {

289 
mas¡»e_´ecÚd™iÚ
(
sz
 % 64 == 0 && sz / 64 < 128);

290 
	gexŒasize64_
 = ((
sz
è>> 6è- ((((*
this
)) + 63) >> 6);

291 ià(
	gexŒasize64_
 > 0)

292 
Ãw
((*)&
iksuf_
[0]è
š‹º®_ksuf_ty³
(
width
, 
sz
 - (*
this
));

293 ià(
	gP
::
Ãed_phªtom_•och
)

294 
phªtom_•och_
[0] = 
phªtom_•och
;

297 
	gËaf
<
	gP
>* 
make
(
ksufsize
, 
phªtom_•och_ty³
 
phªtom_•och
, 
th»adšfo
& 
ti
) {

298 
size_t
 
	gsz
 = 
iû
((
Ëaf
<
P
>è+ 
¡d
::
mš
(
ksufsize
, 128), 64);

299 * 
	g±r
 = 
ti
.
poŞ_®loÿ‹
(
sz
, 
memg_mas¡»e_Ëaf
);

300 
	gËaf
<
	gP
>* 
	gn
 = 
Ãw
(
±r
è
Ëaf
<
P
>(
sz
, 
	gphªtom_•och
);

301 
as£¹
(
n
);

302 ià(
	gP
::
debug_Ëv–
 > 0)

303 
n
->
ü—‹d_©_
[0] = 
ti
.
İ”©iÚ_time¡amp
();

304  
	gn
;

306 
	gËaf
<
	gP
>* 
make_roÙ
(
ksufsize
, 
Ëaf
<
P
>* 
·»Á
, 
th»adšfo
& 
ti
) {

307 
	gËaf
<
	gP
>* 
	gn
 = 
make
(
ksufsize
, 
·»Á
 ?…¬’t->
phªtom_•och
(è: 
phªtom_•och_ty³
(), 
ti
);

308 
	gn
->
	gÃxt_
.
	g±r
 = 
n
->
´ev_
 = 0;

309 
	gn
->
make_Ïy”_roÙ
();

310  
	gn
;

313 
size_t
 
mš_®loÿ‹d_size
() {

314  ((
	gËaf
<
	gP
>è+ 63è& ~
size_t
(63);

316 
size_t
 
®loÿ‹d_size
() const {

317 
	ges
 = (
exŒasize64_
 >= 0 ?ƒxtrasize64_ : -extrasize64_ - 1);

318  ((*
	gthis
è+ 
	ges
 * 64 + 63è& ~
size_t
(63);

320 
phªtom_•och_ty³
 
phªtom_•och
() const {

321  
	gP
::
Ãed_phªtom_•och
 ? 
phªtom_•och_
[0] : 
phªtom_•och_ty³
();

324 
size
() const {

325  
	g³rmu‹r_ty³
::
size
(
³rmutiÚ_
);

327 
³rmu‹r_ty³
 
³rmutiÚ
() const {

328  
³rmu‹r_ty³
(
³rmutiÚ_
);

330 
ty³Çme
 
	gnodev”siÚ_ty³
::
v®ue_ty³
 
fuÎ_v”siÚ_v®ue
() const {

331 
¡©ic_as£¹
((
nodev”siÚ_ty³
::
Œa™s_ty³
::
tİ_¡abË_b™s
è>ğ(
³rmu‹r_ty³
::
size_b™s
), "notƒnough bitso‡dd sizeo version");

332  (
	gthis
->
v”siÚ_v®ue
(è<< 
	g³rmu‹r_ty³
::
size_b™s
è+ 
size
();

334 
ty³Çme
 
	gnodev”siÚ_ty³
::
v®ue_ty³
 
fuÎ_uÆocked_v”siÚ_v®ue
() const {

335 
¡©ic_as£¹
((
nodev”siÚ_ty³
::
Œa™s_ty³
::
tİ_¡abË_b™s
è>ğ(
³rmu‹r_ty³
::
size_b™s
), "notƒnough bitso‡dd sizeo version");

336 
ty³Çme
 
	gnode_ba£
<
	gP
>::
nodev”siÚ_ty³
 
v
(*
this
);

337 ià(
	gv
.
locked
())

340 
	gv
.
uÆock
();

341  (
	gv
.
v”siÚ_v®ue
(è<< 
	g³rmu‹r_ty³
::
size_b™s
è+ 
size
();

344 
usšg
 
	gnode_ba£
<
	gP
>::
has_chªged
;

345 
boŞ
 
has_chªged
(
nodev”siÚ_ty³
 
Şdv
,

346 
ty³Çme
 
³rmu‹r_ty³
::
¡Üage_ty³
 
Şd³rm
) const {

347  
this
->
has_chªged
(
Şdv
è|| 
Şd³rm
 !ğ
³rmutiÚ_
;

350 
key_ty³
 
g‘_key
(
p
) const {

351 
	gkeyËnx
 = 
keyËnx_
[
p
];

352 ià(!
keyËnx_has_ksuf
(
keyËnx
))

353  
key_ty³
(
ikey0_
[
p
], 
keyËnx
);

355  
key_ty³
(
ikey0_
[
p
], 
ksuf
(p));

357 
ikey_ty³
 
ikey
(
p
) const {

358  
	gikey0_
[
p
];

360 
ikey_ty³
 
ikey_bound
() const {

361  
	gikey0_
[0];

363 
com·»_key
(cÚ¡ 
key_ty³
& 
a
, 
bp
) const {

364  
	ga
.
com·»
(
ikey
(
bp
), 
keyËnx_
[bp]);

366 
šlše
 
¡abË_Ï¡_key_com·»
(cÚ¡ 
key_ty³
& 
k
, 
nodev”siÚ_ty³
 
v
,

367 
th»adšfo
& 
ti
) const;

369 
šlše
 
	gËaf
<
	gP
>* 
advªû_to_key
(cÚ¡ 
key_ty³
& 
k
, 
nodev”siÚ_ty³
& 
v”siÚ
,

370 
th»adšfo
& 
ti
) const;

372 
boŞ
 
keyËnx_is_Ïy”
(
keyËnx
) {

373  
	gkeyËnx
 > 127;

375 
boŞ
 
keyËnx_has_ksuf
(
keyËnx
) {

376  
	gkeyËnx
 =ğ
ksuf_keyËnx
;

379 
boŞ
 
is_Ïy”
(
p
) const {

380  
keyËnx_is_Ïy”
(
keyËnx_
[
p
]);

382 
boŞ
 
has_ksuf
(
p
) const {

383  
keyËnx_has_ksuf
(
keyËnx_
[
p
]);

385 
SŒ
 
ksuf
(
p
, 
keyËnx
) const {

386 (è
	gkeyËnx
;

387 
mas¡»e_´ecÚd™iÚ
(
keyËnx_has_ksuf
(
keyËnx
));

388  
	gksuf_
 ? ksuf_->
g‘
(
p
è: 
iksuf_
[0].get(p);

390 
SŒ
 
ksuf
(
p
) const {

391  
ksuf
(
p
, 
keyËnx_
[p]);

393 
boŞ
 
ksuf_equ®s
(
p
, cÚ¡ 
key_ty³
& 
ka
) const {

394  
ksuf_equ®s
(
p
, 
ka
, 
keyËnx_
[p]);

396 
boŞ
 
ksuf_equ®s
(
p
, cÚ¡ 
key_ty³
& 
ka
, 
keyËnx
) const {

397 ià(!
keyËnx_has_ksuf
(
keyËnx
))

398  
	gŒue
;

399 
SŒ
 
	gs
 = 
ksuf
(
p
, 
keyËnx
);

400  
	gs
.
	gËn
 =ğ
ka
.
suffix
().
Ën


401 && 
¡ršg_¦iû
<
ušŒ_t
>::
equ®s_¦İpy
(
s
.s, 
ka
.
suffix
().s, s.
Ën
);

404 
ksuf_m©ches
(
p
, cÚ¡ 
key_ty³
& 
ka
) const {

405 
	gkeyËnx
 = 
keyËnx_
[
p
];

406 ià(
	gkeyËnx
 < 
	gksuf_keyËnx
)

408 ià(
	gkeyËnx
 =ğ
Ïy”_keyËnx
)

409  -(è(
ikey_ty³
);

410 
SŒ
 
	gs
 = 
ksuf
(
p
, 
keyËnx
);

411  
	gs
.
	gËn
 =ğ
ka
.
suffix
().
Ën


412 && 
¡ršg_¦iû
<
ušŒ_t
>::
equ®s_¦İpy
(
s
.s, 
ka
.
suffix
().s, s.
Ën
);

414 
ksuf_com·»
(
p
, cÚ¡ 
key_ty³
& 
ka
) const {

415 
	gkeyËnx
 = 
keyËnx_
[
p
];

416 ià(!
keyËnx_has_ksuf
(
keyËnx
))

418  
ksuf
(
p
, 
keyËnx
).
com·»
(
ka
.
suffix
());

421 
size_t
 
ksuf_u£d_ÿ·c™y
() const {

422 ià(
	gksuf_
)

423  
	gksuf_
->
u£d_ÿ·c™y
();

424 ià(
	gexŒasize64_
 > 0)

425  
	giksuf_
[0].
u£d_ÿ·c™y
();

429 
size_t
 
ksuf_ÿ·c™y
() const {

430 ià(
	gksuf_
)

431  
	gksuf_
->
ÿ·c™y
();

432 ià(
	gexŒasize64_
 > 0)

433  
	giksuf_
[0].
ÿ·c™y
();

437 
boŞ
 
ksuf_ex‹º®
() const {

438  
	gksuf_
;

440 
SŒ
 
ksuf_¡Üage
(
p
) const {

441 ià(
	gksuf_
)

442  
	gksuf_
->
g‘
(
p
);

443 ià(
	gexŒasize64_
 > 0)

444  
	giksuf_
[0].
g‘
(
p
);

446  
SŒ
();

449 
boŞ
 
d–‘ed_Ïy”
() const {

450  
	gmod¡©e_
 =ğ
mod¡©e_d–‘ed_Ïy”
;

453 
´eãtch
() const {

454 
	gi
 = 64; i < 
	g¡d
::
mš
(16 * 
width
 + 1, 4 * 64); i += 64)

455 ::
´eãtch
((cÚ¡ *è
this
 + 
i
);

456 ià(
	gexŒasize64_
 > 0)

457 ::
´eãtch
((cÚ¡ *è&
iksuf_
[0]);

458 ià(
	gexŒasize64_
 < 0) {

459 ::
´eãtch
((cÚ¡ *è
ksuf_
);

460 ::
´eãtch
((cÚ¡ *è
ksuf_
 + 
CACHE_LINE_SIZE
);

464 
´št
(
FILE
* 
f
, cÚ¡ * 
´efix
, 
d•th
, 
kd•th
) const;

466 
	gËaf
<
	gP
>* 
§ã_Ãxt
() const {

467  
	g»š‹½»t_ÿ¡
<
	gËaf
<
	gP
>*>(
	gÃxt_
.
	gx
 & ~(
	gušŒ_t
) 1);

470 
d—Îoÿ‹
(
th»adšfo
& 
ti
) {

471 ià(
	gksuf_
)

472 
	gti
.
d—Îoÿ‹
(
ksuf_
, ksuf_->
ÿ·c™y
(),

473 
memg_mas¡»e_ksuffixes
);

474 ià(
	gexŒasize64_
 != 0)

475 
iksuf_
[0].~
¡ršgbag
();

476 
	gti
.
poŞ_d—Îoÿ‹
(
this
, 
®loÿ‹d_size
(), 
memg_mas¡»e_Ëaf
);

478 
d—Îoÿ‹_rcu
(
th»adšfo
& 
ti
) {

479 ià(
	gksuf_
)

480 
	gti
.
d—Îoÿ‹_rcu
(
ksuf_
, ksuf_->
ÿ·c™y
(),

481 
memg_mas¡»e_ksuffixes
);

482 
	gti
.
poŞ_d—Îoÿ‹_rcu
(
this
, 
®loÿ‹d_size
(), 
memg_mas¡»e_Ëaf
);

485 
	g´iv©e
:

486 
šlše
 
m¬k_d–‘ed_Ïy”
() {

487 
mod¡©e_
 = 
mod¡©e_d–‘ed_Ïy”
;

490 
šlše
 
assign
(
p
, cÚ¡ 
key_ty³
& 
ka
, 
th»adšfo
& 
ti
) {

491 
	glv_
[
p
] = 
Ëafv®ue_ty³
::
make_em±y
();

492 
	gikey0_
[
p
] = 
ka
.
ikey
();

493 ià(!
	gka
.
has_suffix
())

494 
	gkeyËnx_
[
p
] = 
ka
.
Ëngth
();

496 
	gkeyËnx_
[
p
] = 
ksuf_keyËnx
;

497 
assign_ksuf
(
p
, 
ka
.
suffix
(), 
çl£
, 
ti
);

500 
šlše
 
assign_š™Ÿlize
(
p
, cÚ¡ 
key_ty³
& 
ka
, 
th»adšfo
& 
ti
) {

501 
	glv_
[
p
] = 
Ëafv®ue_ty³
::
make_em±y
();

502 
	gikey0_
[
p
] = 
ka
.
ikey
();

503 ià(!
	gka
.
has_suffix
())

504 
	gkeyËnx_
[
p
] = 
ka
.
Ëngth
();

506 
	gkeyËnx_
[
p
] = 
ksuf_keyËnx
;

507 
assign_ksuf
(
p
, 
ka
.
suffix
(), 
Œue
, 
ti
);

510 
šlše
 
assign_š™Ÿlize
(
p
, 
Ëaf
<
P
>* 
x
, 
xp
, 
th»adšfo
& 
ti
) {

511 
	glv_
[
p
] = 
x
->
lv_
[
xp
];

512 
	gikey0_
[
p
] = 
x
->
ikey0_
[
xp
];

513 
	gkeyËnx_
[
p
] = 
x
->
keyËnx_
[
xp
];

514 ià(
	gx
->
has_ksuf
(
xp
))

515 
assign_ksuf
(
p
, 
x
->
ksuf
(
xp
), 
Œue
, 
ti
);

517 
šlše
 
assign_š™Ÿlize_fÜ_Ïy”
(
p
, cÚ¡ 
key_ty³
& 
ka
) {

518 
as£¹
(
ka
.
has_suffix
());

519 
	gikey0_
[
p
] = 
ka
.
ikey
();

520 
	gkeyËnx_
[
p
] = 
Ïy”_keyËnx
;

522 
assign_ksuf
(
p
, 
SŒ
 
s
, 
boŞ
 
š™Ÿlizšg
, 
th»adšfo
& 
ti
);

524 
šlše
 
ikey_ty³
 
ikey_aá”_š£¹
(cÚ¡ 
³rmu‹r_ty³
& 
³rm
, 
i
,

525 cÚ¡ 
key_ty³
& 
ka
, 
ka_i
) const;

526 
¥l™_što
(
Ëaf
<
P
>* 
Ä
, 
p
, cÚ¡ 
key_ty³
& 
ka
, 
ikey_ty³
& 
¥l™_ikey
,

527 
th»adšfo
& 
ti
);

529 
	g‹m¶©e
 <
ty³Çme
 
	gPP
> 
ä›nd
 
şass
 
	gtcursÜ
;

533 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

534 
	gbasic_bË
<
	gP
>::
	$š™Ÿlize
(
th»adšfo
& 
ti
) {

535 
	`mas¡»e_´ecÚd™iÚ
(!
roÙ_
);

536 
roÙ_
 = 
node_ty³
::
Ëaf_ty³
::
	`make_roÙ
(0, 0, 
ti
);

537 
	}
}

543 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

544 
	gš‹ºode
<
	gP
>* 
	gnode_ba£
<P>::
	$locked_·»Á
(
th»adšfo
& 
ti
) const

546 
node_ba£
<
P
>* 
p
;

547 
	`mas¡»e_´ecÚd™iÚ
(!
this
->
cÚcu¼’t
 ||his->
	`locked
());

549 
p
 = 
this
->
	`·»Á
();

550 ià(!
this
->
	`·»Á_exi¡s
(
p
))

552 
nodev”siÚ_ty³
 
pv
 = 
p
->
	`lock
(*p, 
ti
.
	`lock_ãnû
(
tc_š‹ºode_lock
));

553 ià(
p
 =ğ
this
->
	`·»Á
()) {

554 
	`mas¡»e_šv¬ŸÁ
(!
p
->
	`i¦—f
());

557 
p
->
	`uÆock
(
pv
);

558 
	`»Ïx_ãnû
();

560  
¡©ic_ÿ¡
<
š‹ºode
<
P
>*>(
p
);

561 
	}
}

564 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

565 
	gnode_ba£
<
	gP
>::
	$´št
(
FILE
* 
f
, cÚ¡ * 
´efix
, 
d•th
, 
kd•th
) const

567 ià(
this
->
	`i¦—f
())

568 
¡©ic_ÿ¡
<cÚ¡ 
Ëaf
<
P
>*>(
this
)->
	`´št
(
f
, 
´efix
, 
d•th
, 
kd•th
);

570 
¡©ic_ÿ¡
<cÚ¡ 
š‹ºode
<
P
>*>(
this
)->
	`´št
(
f
, 
´efix
, 
d•th
, 
kd•th
);

571 
	}
}

577 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

578 
šlše
 

579 
	gš‹ºode
<
	gP
>::
	$¡abË_Ï¡_key_com·»
(cÚ¡ 
key_ty³
& 
k
, 
nodev”siÚ_ty³
 
v
,

580 
th»adšfo
& 
ti
) const

583 
cmp
 = 
	`com·»_key
(
k
, 
	`size
() - 1);

584 ià(
	`lik–y
(!
this
->
	`has_chªged
(
v
)))

585  
cmp
;

586 
v
 = 
this
->
	`¡abË_ªnÙ©ed
(
ti
.
	`¡abË_ãnû
());

588 
	}
}

590 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

591 
šlše
 

592 
	gËaf
<
	gP
>::
	$¡abË_Ï¡_key_com·»
(cÚ¡ 
key_ty³
& 
k
, 
nodev”siÚ_ty³
 
v
,

593 
th»adšfo
& 
ti
) const

596 
ty³Çme
 
Ëaf
<
P
>::
³rmu‹r_ty³
 
	`³rm
(
³rmutiÚ_
);

597 
p
 = 
³rm
[³rm.
	`size
() - 1];

598 
cmp
 = 
	`com·»_key
(
k
, 
p
);

599 ià(
	`lik–y
(!
this
->
	`has_chªged
(
v
)))

600  
cmp
;

601 
v
 = 
this
->
	`¡abË_ªnÙ©ed
(
ti
.
	`¡abË_ãnû
());

603 
	}
}

609 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

610 
šlše
 
	gËaf
<
	gP
>* 
	gnode_ba£
<P>::
	$»ach_Ëaf
(cÚ¡ 
key_ty³
& 
ka
,

611 
nodev”siÚ_ty³
& 
v”siÚ
,

612 
th»adšfo
& 
ti
) const

614 cÚ¡ 
node_ba£
<
P
> *
n
[2];

615 
ty³Çme
 
node_ba£
<
P
>::
nodev”siÚ_ty³
 
v
[2];

616 
boŞ
 
£n£
;

621 
»Œy
:

622 
£n£
 = 
çl£
;

623 
n
[
£n£
] = 
this
;

625 
v
[
£n£
] = 
n
[£n£]->
	`¡abË_ªnÙ©ed
(
ti
.
	`¡abË_ãnû
());

626 ià(
v
[
£n£
].
	`is_roÙ
())

628 
ti
.
	`m¬k
(
tc_roÙ_»Œy
);

629 
n
[
£n£
] =‚[£n£]->
	`maybe_·»Á
();

633 !
v
[
£n£
].
	`i¦—f
()) {

634 cÚ¡ 
š‹ºode
<
P
> *
š
 = 
¡©ic_ÿ¡
<cÚ¡ iÁ”node<P>*>(
n
[
£n£
]);

635 
š
->
	`´eãtch
();

636 
kp
 = 
š‹ºode
<
P
>::
bound_ty³
::
	`uµ”
(
ka
, *
š
);

637 
n
[!
£n£
] = 
š
->
chd_
[
kp
];

638 ià(!
n
[!
£n£
])

639 
»Œy
;

640 
v
[!
£n£
] = 
n
[!£n£]->
	`¡abË_ªnÙ©ed
(
ti
.
	`¡abË_ãnû
());

642 ià(
	`lik–y
(!
š
->
	`has_chªged
(
v
[
£n£
]))) {

643 
£n£
 = !sense;

647 
ty³Çme
 
node_ba£
<
P
>::
nodev”siÚ_ty³
 
Şdv
 = 
v
[
£n£
];

648 
v
[
£n£
] = 
š
->
	`¡abË_ªnÙ©ed
(
ti
.
	`¡abË_ãnû
());

649 ià(
Şdv
.
	`has_¥l™
(
v
[
£n£
])

650 && 
š
->
	`¡abË_Ï¡_key_com·»
(
ka
, 
v
[
£n£
], 
ti
) > 0) {

651 
ti
.
	`m¬k
(
tc_roÙ_»Œy
);

652 
»Œy
;

654 
ti
.
	`m¬k
(
tc_š‹ºode_»Œy
);

657 
v”siÚ
 = 
v
[
£n£
];

658  
cÚ¡_ÿ¡
<
Ëaf
<
P
> *>(
¡©ic_ÿ¡
<cÚ¡†—f<P> *>(
n
[
£n£
]));

659 
	}
}

667 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

668 
	gËaf
<
	gP
>*†—f<P>::
	$advªû_to_key
(cÚ¡ 
key_ty³
& 
ka
, 
nodev”siÚ_ty³
& 
v
,

669 
th»adšfo
& 
ti
) const

671 cÚ¡ 
Ëaf
<
P
>* 
n
 = 
this
;

672 
nodev”siÚ_ty³
 
Şdv
 = 
v
;

673 
v
 = 
n
->
	`¡abË_ªnÙ©ed
(
ti
.
	`¡abË_ãnû
());

674 ià(
v
.
	`has_¥l™
(
Şdv
)

675 && 
n
->
	`¡abË_Ï¡_key_com·»
(
ka
, 
v
, 
ti
) > 0) {

676 
Ëaf
<
P
> *
Ãxt
;

677 
ti
.
	`m¬k
(
tc_Ëaf_w®k
);

678 
	`lik–y
(!
v
.
	`d–‘ed
()è&& (
Ãxt
 = 
n
->
	`§ã_Ãxt
())

679 && 
	`com·»
(
ka
.
	`ikey
(), 
Ãxt
->
	`ikey_bound
()) >= 0) {

680 
n
 = 
Ãxt
;

681 
v
 = 
n
->
	`¡abË_ªnÙ©ed
(
ti
.
	`¡abË_ãnû
());

684  
cÚ¡_ÿ¡
<
Ëaf
<
P
>*>(
n
);

685 
	}
}

700 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

701 
	gËaf
<
	gP
>::
	$assign_ksuf
(
p
, 
SŒ
 
s
, 
boŞ
 
š™Ÿlizšg
, 
th»adšfo
& 
ti
) {

702 ià((
ksuf_
 && ksuf_->
	`assign
(
p
, 
s
))

703 || (
exŒasize64_
 > 0 && 
iksuf_
[0].
	`assign
(
p
, 
s
)))

706 
ex‹º®_ksuf_ty³
* 
oksuf
 = 
ksuf_
;

708 
³rmu‹r_ty³
 
	`³rm
(
³rmutiÚ_
);

709 
n
 = 
š™Ÿlizšg
 ? 
p
 : 
³rm
.
	`size
();

711 
size_t
 
csz
 = 0;

712 
i
 = 0; i < 
n
; ++i) {

713 
mp
 = 
š™Ÿlizšg
 ? 
i
 : 
³rm
[i];

714 ià(
mp
 !ğ
p
 && 
	`has_ksuf
(mp))

715 
csz
 +ğ
	`ksuf
(
mp
).
Ën
;

718 
size_t
 
sz
 = 
	`iû_log2
(
ex‹º®_ksuf_ty³
::
	`§ã_size
(
width
, 
csz
 + 
s
.
Ën
));

719 ià(
oksuf
)

720 
sz
 = 
¡d
::
	`max
(sz, 
oksuf
->
	`ÿ·c™y
());

722 * 
±r
 = 
ti
.
	`®loÿ‹
(
sz
, 
memg_mas¡»e_ksuffixes
);

723 
ex‹º®_ksuf_ty³
* 
nksuf
 = 
	`Ãw
(
±r
è
	`ex‹º®_ksuf_ty³
(
width
, 
sz
);

724 
i
 = 0; i < 
n
; ++i) {

725 
mp
 = 
š™Ÿlizšg
 ? 
i
 : 
³rm
[i];

726 ià(
mp
 !ğ
p
 && 
	`has_ksuf
(mp)) {

727 
boŞ
 
ok
 = 
nksuf
->
	`assign
(
mp
, 
	`ksuf
(mp));

728 
	`as£¹
(
ok
); () ok;

731 
boŞ
 
ok
 = 
nksuf
->
	`assign
(
p
, 
s
);

732 
	`as£¹
(
ok
); () ok;

733 
	`ãnû
();

740 
	`mas¡»e_šv¬ŸÁ
(
mod¡©e_
 !ğ
mod¡©e_»move
);

742 
ksuf_
 = 
nksuf
;

743 
	`ãnû
();

745 ià(
exŒasize64_
 >= 0)

746 
exŒasize64_
 = -extrasize64_ - 1;

748 ià(
oksuf
)

749 
ti
.
	`d—Îoÿ‹_rcu
(
oksuf
, oksuf->
	`ÿ·c™y
(),

750 
memg_mas¡»e_ksuffixes
);

751 
	}
}

753 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

754 
šlše
 
	gbasic_bË
<
	gP
>::
	$basic_bË
()

755 : 
	$roÙ_
(0) {

756 
	}
}

758 
‹m¶©e
 <
ty³Çme
 
P
>

759 
šlše
 
node_ba£
<
P
>* 
basic_bË
<P>::
	$roÙ
() const {

760  
roÙ_
;

761 
	}
}

763 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

764 
šlše
 
	gnode_ba£
<
	gP
>* 
	gbasic_bË
<P>::
	$fix_roÙ
() {

765 
node_ba£
<
P
>* 
roÙ
 = 
roÙ_
;

766 ià(
	`uÆik–y
(!
roÙ
->
	`is_roÙ
())) {

767 
node_ba£
<
P
>* 
Şd_roÙ
 = 
roÙ
;

768 
roÙ
 =„oÙ->
	`maybe_·»Á
();

769 (è
	`cmpxchg
(&
roÙ_
, 
Şd_roÙ
, 
roÙ
);

771  
roÙ
;

772 
	}
}

	@masstree-beta/masstree_tcursor.hh

16 #iâdeà
MASSTREE_TCURSOR_HH


17 
	#MASSTREE_TCURSOR_HH
 1

	)

18 
	~"sm®l_veùÜ.hh
"

19 
	~"mas¡»e_key.hh
"

20 
	~"mas¡»e_¡ruù.hh
"

21 
Çme¥aû
 
	gMas¡»e
 {

22 
	g‹m¶©e
 <
ty³Çme
 
	gP
> 
	ggc_Ïy”_rcu_ÿÎback
;

24 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

25 şas 
	cuÆocked_tcursÜ
 {

26 
	gpublic
:

27 
ty³Çme
 
	tP
::
	tv®ue_ty³
 value_type;

28 
	gkey
<
	tty³Çme
 
	tP
::
	tikey_ty³
> 
	tkey_ty³
;

29 
ty³Çme
 
	tP
::
	tth»adšfo_ty³
 
	tth»adšfo
;

30 
ty³Çme
 
	tËaf
<
	tP
>::
	tnodev”siÚ_ty³
‚odeversion_type;

31 
ty³Çme
 
	tnodev”siÚ_ty³
::
	tv®ue_ty³
 
	tnodev”siÚ_v®ue_ty³
;

32 
ty³Çme
 
	tËaf
<
	tP
>::
	t³rmu‹r_ty³
…ermuter_type;

34 
šlše
 
uÆocked_tcursÜ
(cÚ¡ 
basic_bË
<
P
>& 
bË
, 
SŒ
 
¡r
)

35 : 
ka_
(
¡r
), 
lv_
(
Ëafv®ue
<
P
>::
make_em±y
()),

36 
roÙ_
(
bË
.
roÙ
()) {

38 
šlše
 
uÆocked_tcursÜ
(
basic_bË
<
P
>& 
bË
, 
SŒ
 
¡r
)

39 : 
ka_
(
¡r
), 
lv_
(
Ëafv®ue
<
P
>::
make_em±y
()),

40 
roÙ_
(
bË
.
fix_roÙ
()) {

42 
šlše
 
uÆocked_tcursÜ
(cÚ¡ 
basic_bË
<
P
>& 
bË
,

43 cÚ¡ * 
s
, 
Ën
)

44 : 
ka_
(
s
, 
Ën
), 
lv_
(
Ëafv®ue
<
P
>::
make_em±y
()),

45 
roÙ_
(
bË
.
roÙ
()) {

47 
šlše
 
uÆocked_tcursÜ
(
basic_bË
<
P
>& 
bË
,

48 cÚ¡ * 
s
, 
Ën
)

49 : 
ka_
(
s
, 
Ën
), 
lv_
(
Ëafv®ue
<
P
>::
make_em±y
()),

50 
roÙ_
(
bË
.
fix_roÙ
()) {

52 
šlše
 
uÆocked_tcursÜ
(cÚ¡ 
basic_bË
<
P
>& 
bË
,

53 cÚ¡ * 
s
, 
Ën
)

54 : 
ka_
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
), 
Ën
),

55 
lv_
(
Ëafv®ue
<
P
>::
make_em±y
()), 
roÙ_
(
bË
.
roÙ
()) {

57 
šlše
 
uÆocked_tcursÜ
(
basic_bË
<
P
>& 
bË
,

58 cÚ¡ * 
s
, 
Ën
)

59 : 
ka_
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
), 
Ën
),

60 
lv_
(
Ëafv®ue
<
P
>::
make_em±y
()), 
roÙ_
(
bË
.
fix_roÙ
()) {

63 
boŞ
 
fšd_uÆocked
(
th»adšfo
& 
ti
);

65 
šlše
 
v®ue_ty³
 
v®ue
() const {

66  
	glv_
.
v®ue
();

68 
šlše
 
	gËaf
<
	gP
>* 
node
() const {

69  
	gn_
;

71 
šlše
 
³rmu‹r_ty³
 
³rmutiÚ
() const {

72  
	g³rm_
;

74 
šlše
 
com·»_key
(cÚ¡ 
key_ty³
& 
a
, 
bp
) const {

75  
	gn_
->
com·»_key
(
a
, 
bp
);

77 
šlše
 
nodev”siÚ_v®ue_ty³
 
fuÎ_v”siÚ_v®ue
() const {

78 
¡©ic_as£¹
((
nodev”siÚ_ty³
::
Œa™s_ty³
::
tİ_¡abË_b™s
è>ğ(
Ëaf
<
P
>::
³rmu‹r_ty³
::
size_b™s
), "notƒnough bitso‡dd sizeo version");

79  (
	gv_
.
v”siÚ_v®ue
(è<< 
	gËaf
<
	gP
>::
³rmu‹r_ty³
::
size_b™s
è+ 
³rm_
.
size
();

82 
	g´iv©e
:

83 
Ëaf
<
P
>* 
n_
;

84 
key_ty³
 
	gka_
;

85 
ty³Çme
 
	gËaf
<
	gP
>::
nodev”siÚ_ty³
 
v_
;

86 
³rmu‹r_ty³
 
	g³rm_
;

87 
	gËafv®ue
<
	gP
> 
	glv_
;

88 cÚ¡ 
	gnode_ba£
<
	gP
>* 
	groÙ_
;

91 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

92 şas 
	ctcursÜ
 {

93 
	gpublic
:

94 
node_ba£
<
	tP
> 
	tnode_ty³
;

95 
	gËaf
<
	tP
> 
	tËaf_ty³
;

96 
	gš‹ºode
<
	tP
> 
	tš‹ºode_ty³
;

97 
ty³Çme
 
	tP
::
	tv®ue_ty³
 value_type;

98 
	gËafv®ue
<
	tP
> 
	tËafv®ue_ty³
;

99 
ty³Çme
 
	tËaf_ty³
::
	t³rmu‹r_ty³
…ermuter_type;

100 
ty³Çme
 
	tP
::
	tikey_ty³
 ikey_type;

101 
	gkey
<
	tikey_ty³
> 
	tkey_ty³
;

102 
ty³Çme
 
	tËaf
<
	tP
>::
	tnodev”siÚ_ty³
‚odeversion_type;

103 
ty³Çme
 
	tnodev”siÚ_ty³
::
	tv®ue_ty³
 
	tnodev”siÚ_v®ue_ty³
;

104 
ty³Çme
 
	tP
::
	tth»adšfo_ty³
 
	tth»adšfo
;

105 
cÚ¡ex´
 
	gÃw_nodes_size
 = 1;

106 
	gsm®l_veùÜ
<
	t¡d
::
	t·œ
<
	tËaf_ty³
*, 
	tnodev”siÚ_v®ue_ty³
>, 
	tÃw_nodes_size
> 
	tÃw_nodes_ty³
;

108 
tcursÜ
(
basic_bË
<
P
>& 
bË
, 
SŒ
 
¡r
)

109 : 
ka_
(
¡r
), 
roÙ_
(
bË
.
fix_roÙ
()) {

111 
tcursÜ
(
basic_bË
<
P
>& 
bË
, cÚ¡ * 
s
, 
Ën
)

112 : 
ka_
(
s
, 
Ën
), 
roÙ_
(
bË
.
fix_roÙ
()) {

114 
tcursÜ
(
basic_bË
<
P
>& 
bË
, cÚ¡ * 
s
, 
Ën
)

115 : 
ka_
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
), 
Ën
), 
roÙ_
(
bË
.
fix_roÙ
()) {

117 
tcursÜ
(
node_ba£
<
P
>* 
roÙ
, cÚ¡ * 
s
, 
Ën
)

118 : 
ka_
(
s
, 
Ën
), 
roÙ_
(
roÙ
) {

120 
tcursÜ
(
node_ba£
<
P
>* 
roÙ
, cÚ¡ * 
s
, 
Ën
)

121 : 
ka_
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
), 
Ën
), 
roÙ_
(
roÙ
) {

124 
šlše
 
boŞ
 
has_v®ue
() const {

125  
	gkx_
.
	gp
 >= 0;

127 
šlše
 
	gv®ue_ty³
 &
v®ue
() const {

128  
	gn_
->
	glv_
[
kx_
.
p
].
v®ue
();

131 
šlše
 
boŞ
 
is_fœ¡_Ïy”
() const {

132  !
	gka_
.
is_shiáed
();

135 
šlše
 
	gËaf
<
	gP
>* 
node
() const {

136  
	gn_
;

139 
šlše
 
Ëaf_ty³
 *
Üigš®_node
() const {

140  
	gÜigš®_n_
;

143 
šlše
 
nodev”siÚ_v®ue_ty³
 
Üigš®_v”siÚ_v®ue
() const {

144  
	gÜigš®_v_
;

147 
šlše
 
nodev”siÚ_v®ue_ty³
 
upd©ed_v”siÚ_v®ue
() const {

148  
	gupd©ed_v_
;

151 
šlše
 cÚ¡ 
	gÃw_nodes_ty³
 &
Ãw_nodes
() const {

152  
	gÃw_nodes_
;

155 
šlše
 
boŞ
 
fšd_locked
(
th»adšfo
& 
ti
);

156 
šlše
 
boŞ
 
fšd_š£¹
(
th»adšfo
& 
ti
);

158 
šlše
 
fšish
(
ªsw”
, 
th»adšfo
& 
ti
);

160 
šlše
 
nodev”siÚ_v®ue_ty³
 
´evious_fuÎ_v”siÚ_v®ue
() const;

161 
šlše
 
nodev”siÚ_v®ue_ty³
 
Ãxt_fuÎ_v”siÚ_v®ue
(
¡©e
) const;

163 
	g´iv©e
:

164 
Ëaf_ty³
 *
n_
;

165 
key_ty³
 
	gka_
;

166 
key_šdexed_pos™iÚ
 
	gkx_
;

167 
	gnode_ba£
<
	gP
>* 
	groÙ_
;

168 
	g¡©e_
;

170 
Ëaf_ty³
 *
	gÜigš®_n_
;

171 
nodev”siÚ_v®ue_ty³
 
	gÜigš®_v_
;

172 
nodev”siÚ_v®ue_ty³
 
	gupd©ed_v_
;

173 
Ãw_nodes_ty³
 
	gÃw_nodes_
;

175 
šlše
 
node_ty³
* 
»£t_»Œy
() {

176 
	gka_
.
unshiá_®l
();

177  
	groÙ_
;

180 
boŞ
 
make_Ãw_Ïy”
(
th»adšfo
& 
ti
);

181 
boŞ
 
make_¥l™
(
th»adšfo
& 
ti
);

182 
šlše
 
fšish_š£¹
();

183 
šlše
 
boŞ
 
fšish_»move
(
th»adšfo
& 
ti
);

185 
»dœeù
(
š‹ºode_ty³
* 
n
, 
ikey_ty³
 
ikey
,

186 
ikey_ty³
 
»¶aûm’t
, 
th»adšfo
& 
ti
);

192 
boŞ
 
»move_Ëaf
(
Ëaf_ty³
* 
Ëaf
, 
node_ty³
* 
roÙ
,

193 
SŒ
 
´efix
, 
th»adšfo
& 
ti
);

195 
boŞ
 
gc_Ïy”
(
th»adšfo
& 
ti
);

196 
ä›nd
 
	ggc_Ïy”_rcu_ÿÎback
<
	gP
>;

199 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

200 
šlše
 
ty³Çme
 
	gtcursÜ
<
	gP
>::
nodev”siÚ_v®ue_ty³


201 
tcursÜ
<
P
>::
	$´evious_fuÎ_v”siÚ_v®ue
() const {

202 
	`¡©ic_as£¹
((
nodev”siÚ_ty³
::
Œa™s_ty³
::
tİ_¡abË_b™s
è>ğ(
Ëaf
<
P
>::
³rmu‹r_ty³
::
size_b™s
), "notƒnough bitso‡dd sizeo version");

203  (
n_
->
	`uÆocked_v”siÚ_v®ue
(è<< 
Ëaf
<
P
>::
³rmu‹r_ty³
::
size_b™s
è+‚_->
	`size
();

204 
	}
}

206 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

207 
šlše
 
ty³Çme
 
	gtcursÜ
<
	gP
>::
nodev”siÚ_v®ue_ty³


208 
tcursÜ
<
P
>::
	$Ãxt_fuÎ_v”siÚ_v®ue
(
¡©e
) const {

209 
	`¡©ic_as£¹
((
nodev”siÚ_ty³
::
Œa™s_ty³
::
tİ_¡abË_b™s
è>ğ(
Ëaf
<
P
>::
³rmu‹r_ty³
::
size_b™s
), "notƒnough bitso‡dd sizeo version");

210 
ty³Çme
 
node_ba£
<
P
>::
nodev”siÚ_ty³
 
	`v
(*
n_
);

211 
v
.
	`uÆock
();

212 
nodev”siÚ_v®ue_ty³
 
»suÉ
 = (
v
.
	`v”siÚ_v®ue
(è<< 
Ëaf
<
P
>::
³rmu‹r_ty³
::
size_b™s
è+ 
n_
->
	`size
();

213 ià(
¡©e
 < 0 && (
¡©e_
 & 1))

214  
»suÉ
 - 1;

215 ià(
¡©e
 > 0 && 
¡©e_
 == 2)

216  
»suÉ
 + 1;

218  
»suÉ
;

219 
	}
}

	@masstree-beta/memdebug.cc

16 
	~"memdebug.hh
"

17 
	~<¡dio.h
>

18 
	~<as£¹.h
>

20 #ià
HAVE_MEMDEBUG


21 
	gmemdebug
::
	$Ïndm¬k
(* 
buf
, 
size_t
 
bufsz
) const {

22 ià(
this
->
magic
 !ğ
magic_v®ue
 &&his->magiø!ğ
magic_ä“_v®ue
)

23 
	`¢´štf
(
buf
, 
bufsz
, "???");

24 ià(
this
->
fe
)

25 
	`¢´štf
(
buf
, 
bufsz
, "%s:%d", 
this
->
fe
,his->
lše
);

26 ià(
this
->
lše
)

27 
	`¢´štf
(
buf
, 
bufsz
, "%d", 
this
->
lše
);

29 
	`¢´štf
(
buf
, 
bufsz
, "0");

30 
	}
}

33 
	gmemdebug
::
	$h¬d_ä“_checks
(cÚ¡ 
memdebug
 *
m
, 
size_t
 
sz
, 
memg
 
g
,

34 
aá”_rcu
, cÚ¡ *
İ
) {

35 
buf
[256];

36 
m
->
	`Ïndm¬k
(
buf
, (buf));

37 ià(
m
->
magic
 =ğ
magic_ä“_v®ue
)

38 
	`årštf
(
¡d”r
, "%s(%p): double free, was @%s\n",

39 
İ
, 
m
 + 1, 
buf
);

40 ià(
m
->
magic
 !ğ
magic_v®ue
)

41 
	`årštf
(
¡d”r
, "%s(%p): freeing unallocated…ointer (%x)\n",

42 
İ
, 
m
 + 1, m->
magic
);

43 
	`as£¹
(
m
->
magic
 =ğ
magic_v®ue
);

44 ià(
g
 && 
m
->tag !=ag)

45 
	`årštf
(
¡d”r
, "%s(%p):ƒxpectedype %x, saw %x, "

46 "®loÿ‹d %s\n", 
İ
, 
m
 + 1, 
g
, m->g, 
buf
);

47 ià(!
aá”_rcu
 && 
m
->
size
 !ğ
sz
)

48 
	`årštf
(
¡d”r
, "%s(%p):ƒxpected size %lu, saw %lu, "

49 "®loÿ‹d %s\n", 
İ
, 
m
 + 1,

50 (è
sz
, (è
m
->
size
, 
buf
);

51 ià(
m
->
aá”_rcu
 !=‡fter_rcu)

52 
	`årštf
(
¡d”r
, "%s(%p): double free‡fter„cu,‡llocated @%s\n",

53 
İ
, 
m
 + 1, 
buf
);

54 ià(
g
)

55 
	`as£¹
(
m
->
g
 ==ag);

56 ià(!
aá”_rcu
)

57 
	`as£¹
(
m
->
size
 =ğ
sz
);

58 
	`as£¹
(
m
->
aá”_rcu
 ==‡fter_rcu);

59 
	}
}

62 
	gmemdebug
::
	$h¬d_as£¹_u£
(cÚ¡ * 
±r
, 
memg
 
®lowed
) {

63 cÚ¡ 
memdebug
* 
m
 = 
»š‹½»t_ÿ¡
<cÚ¡ memdebug*>(
±r
) - 1;

64 
buf
[256];

65 
m
->
	`Ïndm¬k
(
buf
, (buf));

66 ià(
m
->
magic
 =ğ
magic_ä“_v®ue
)

67 
	`årštf
(
¡d”r
, "%p: useag %x‡fter free,‡llocated %s\n",

68 
m
 + 1, 
®lowed
, 
buf
);

69 ià(
m
->
magic
 !ğ
magic_v®ue
)

70 
	`årštf
(
¡d”r
, "%p:…ointer is unallocated,‚otag %x\n",

71 
m
 + 1, 
®lowed
);

72 
	`as£¹
(
m
->
magic
 =ğ
magic_v®ue
);

73 ià(
®lowed
 !ğ0 && (
m
->
g
 ^‡Îowedè> 
memg_poŞ_mask
)

74 
	`årštf
(
¡d”r
, "%p:ƒxpectedag %x, gotag %x,‡llocated %s\n",

75 
m
 + 1, 
®lowed
, m->
g
, 
buf
);

76 ià(
®lowed
 != 0)

77 
	`as£¹
((
m
->
g
 ^ 
®lowed
è<ğ
memg_poŞ_mask
);

78 
	}
}

	@masstree-beta/memdebug.hh

16 #iâdeà
MEMDEBUG_HH


17 
	#MEMDEBUG_HH
 1

	)

18 
	~"mtcouÁ”s.hh
"

19 
	~<¡ddef.h
>

21 
	smemdebug
 {

22 
šlše
 * 
make
(* 
±r
, 
size_t
 
sz
, 
memg
 
g
);

23 
šlše
 
£t_Ïndm¬k
(* 
±r
, cÚ¡ * 
fe
, 
lše
);

24 
šlše
 * 
check_ä“
(* 
±r
, 
size_t
 
sz
, 
memg
 
g
);

25 
šlše
 
check_rcu
(* 
±r
, 
size_t
 
sz
, 
memg
 
g
);

26 
šlše
 * 
check_ä“_aá”_rcu
(* 
±r
, 
memg
 
g
);

27 
šlše
 
boŞ
 
check_u£
(cÚ¡ * 
±r
, 
memg
 
®lowed
);

28 
šlše
 
as£¹_u£
(cÚ¡ * 
±r
, 
memg
 
®lowed
);

30 #ià
HAVE_MEMDEBUG


31 
	m´iv©e
:

33 
magic_v®ue
 = 389612313 ,

34 
	mmagic_ä“_v®ue
 = 2015593488

36 
	mmagic
;

37 
memg
 
	mg
;

38 
size_t
 
	msize
;

39 
	maá”_rcu
;

40 
	mlše
;

41 cÚ¡ * 
	mfe
;

43 
ä“_checks
(cÚ¡ 
memdebug
* 
m
, 
size_t
 
size
, 
memg
 
g
,

44 
aá”_rcu
, cÚ¡ * 
İ
) {

45 ià(
	mm
->
	mmagic
 !ğ
magic_v®ue


46 || 
m
->
g
 !=ag

47 || (!
aá”_rcu
 && 
m
->
size
 != size)

48 || 
m
->
aá”_rcu
 !=‡fter_rcu)

49 
h¬d_ä“_checks
(
m
, 
size
, 
g
, 
aá”_rcu
, 
İ
);

51 
Ïndm¬k
(* 
buf
, 
size_t
 
size
) const;

52 
h¬d_ä“_checks
(cÚ¡ 
memdebug
* 
m
, 
size_t
 
size
, 
memg
 
g
,

53 
aá”_rcu
, cÚ¡ * 
İ
);

54 
h¬d_as£¹_u£
(cÚ¡ * 
±r
, 
memg
 
®lowed
);

59 #ià
HAVE_MEMDEBUG


60 
	mmemdebug_size
 = (
memdebug
)

62 
memdebug_size
 = 0

66 
šlše
 * 
	gmemdebug
::
	$make
(* 
±r
, 
size_t
 
sz
, 
memg
 
g
) {

67 #ià
HAVE_MEMDEBUG


68 ià(
±r
) {

69 
memdebug
* 
m
 = 
»š‹½»t_ÿ¡
<memdebug*>(
±r
);

70 
m
->
magic
 = 
magic_v®ue
;

71 
m
->
g
 =ag;

72 
m
->
size
 = 
sz
;

73 
m
->
aá”_rcu
 = 0;

74 
m
->
lše
 = 0;

75 
m
->
fe
 = 0;

76  
m
 + 1;

78  
±r
;

80 (è
sz
, (è
g
;

81  
±r
;

83 
	}
}

85 
šlše
 
	gmemdebug
::
	$£t_Ïndm¬k
(* 
±r
, cÚ¡ * 
fe
, 
lše
) {

86 #ià
HAVE_MEMDEBUG


87 ià(
±r
) {

88 
memdebug
* 
m
 = 
»š‹½»t_ÿ¡
<memdebug*>(
±r
) - 1;

89 
m
->
fe
 = file;

90 
m
->
lše
 =†ine;

93 (è
±r
, (è
fe
, (è
lše
;

95 
	}
}

97 
šlše
 * 
	gmemdebug
::
	$check_ä“
(* 
±r
, 
size_t
 
sz
, 
memg
 
g
) {

98 #ià
HAVE_MEMDEBUG


99 
memdebug
* 
m
 = 
»š‹½»t_ÿ¡
<memdebug*>(
±r
) - 1;

100 
	`ä“_checks
(
m
, 
sz
, 
g
, 
çl£
, "deallocate");

101 
m
->
magic
 = 
magic_ä“_v®ue
;

102  
m
;

104 (è
sz
, (è
g
;

105  
±r
;

107 
	}
}

109 
šlše
 
	gmemdebug
::
	$check_rcu
(* 
±r
, 
size_t
 
sz
, 
memg
 
g
) {

110 #ià
HAVE_MEMDEBUG


111 
memdebug
* 
m
 = 
»š‹½»t_ÿ¡
<memdebug*>(
±r
) - 1;

112 
	`ä“_checks
(
m
, 
sz
, 
g
, 
çl£
, "deallocate_rcu");

113 
m
->
aá”_rcu
 = 1;

115 (è
±r
, (è
sz
, (è
g
;

117 
	}
}

119 
šlše
 * 
	gmemdebug
::
	$check_ä“_aá”_rcu
(* 
±r
, 
memg
 
g
) {

120 #ià
HAVE_MEMDEBUG


121 
memdebug
* 
m
 = 
»š‹½»t_ÿ¡
<memdebug*>(
±r
) - 1;

122 
	`ä“_checks
(
m
, 0, 
g
, 
Œue
, "free_after_rcu");

123 
m
->
magic
 = 
magic_ä“_v®ue
;

124  
m
;

126 (è
g
;

127  
±r
;

129 
	}
}

131 
šlše
 
boŞ
 
	gmemdebug
::
	$check_u£
(cÚ¡ * 
±r
, 
memg
 
®lowed
) {

132 #ià
HAVE_MEMDEBUG


133 cÚ¡ 
memdebug
* 
m
 = 
»š‹½»t_ÿ¡
<cÚ¡ memdebug*>(
±r
) - 1;

134  
m
->
magic
 =ğ
magic_v®ue
 && (
®lowed
 =ğ0 || (m->
g
 ^‡Îowedè<ğ
memg_poŞ_mask
);

136 (è
±r
, (è
®lowed
;

137  
Œue
;

139 
	}
}

141 
šlše
 
	gmemdebug
::
	$as£¹_u£
(cÚ¡ * 
±r
, 
memg
 
®lowed
) {

142 #ià
HAVE_MEMDEBUG


143 ià(!
	`check_u£
(
±r
, 
®lowed
))

144 
	`h¬d_as£¹_u£
(
±r
, 
®lowed
);

146 (è
±r
, (è
®lowed
;

148 
	}
}

	@masstree-beta/misc.cc

16 
	~"misc.hh
"

17 
	~<uni¡d.h
>

18 
	~"kvth»ad.hh
"

20 
	$şp_·r£_suffixdoubË
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
v¡r
,

21 
com¶aš
, *)

23 cÚ¡ *
po¡
;

24 ià(*
v¡r
 =ğ0 || 
	`is¥aû
(() *vstr))

25 
po¡
 = 
v¡r
;

27 
şp
->
v®
.
d
 = 
	`¡¹od
(
v¡r
, (**è&
po¡
);

28 ià(
v¡r
 !ğ
po¡
 && (*post == 'K' || *post == 'k'))

29 
şp
->
v®
.
d
 *ğ1000, ++
po¡
;

30 ià(
v¡r
 !ğ
po¡
 && (*post == 'M' || *post == 'm'))

31 
şp
->
v®
.
d
 *ğ1000000, ++
po¡
;

32 ià(
v¡r
 !ğ
po¡
 && (*post == 'B' || *post == 'b' || *post == 'G' || *post == 'g'))

33 
şp
->
v®
.
d
 *ğ1000000000, ++
po¡
;

34 ià(*
v¡r
 !ğ0 && *
po¡
 == 0)

36 ià(
com¶aš
)

37  
	`CÍ_O±iÚE¼Ü
(
şp
, "%<%O%>ƒx³ù ¨»®‚umb”,‚Ù %<%s%>", 
v¡r
);

40 
	}
}

	@masstree-beta/misc.hh

16 #iâdeà
MISC_HH


17 
	#MISC_HH


	)

18 
	~<¡dio.h
>

19 
	~<time.h
>

20 
	~<sys/time.h
>

21 
	~<¡ršg.h
>

22 
	~<m©h.h
>

23 
	~"¡r.hh
"

24 
	~"time¡amp.hh
"

25 
	~"şp.h
"

27 
šlše
 
	$x®¬m
(
d
) {

28 

, 
å
 = 
	`modf
(
d
, &ip);

29 
™im”v®
 
x
;

30 
	`tim”ş—r
(&
x
.
™_š‹rv®
);

31 
x
.
™_v®ue
.
tv_£c
 = (è

;

32 
x
.
™_v®ue
.
tv_u£c
 = (è(
å
 * 1000000);

33 
	`£t™im”
(
ITIMER_REAL
, &
x
, 0);

34 
	}
}

36 
šlše
 
	$Çpms
(
n
)

38 
»t
;

39 
time¥ec
 
»q
, 
»m
;

41 
»q
.
tv_£c
 = 
n
 / 1000;

42 
»q
.
tv_n£c
 = (
n
 % 1000) * 1000000;

43 
»t
 = 
	`Çno¦“p
(&
»q
, &
»m
);

44 if(
»t
 =ğ-1 && 
”ºo
 !ğ
EINTR
){

45 
	`³¼Ü
("nanosleep");

46 
	`ex™
(
EXIT_FAILURE
);

48 
	}
}

50 
	squick_i¡r
 {

51 
	mbuf_
[32];

52 *
	mbbuf_
;

53 
quick_i¡r
() {

54 
£t
(0);

56 
quick_i¡r
(
x
, 
mšËn
 = 0) {

57 
£t
(
x
, 
mšËn
);

59 
£t
(
x
, 
mšËn
 = 0){

60 
bbuf_
 = 
buf_
 + (buf_) - 1;

62 *--
	mbbuf_
 = (
x
 % 10) + '0';

63 
	mx
 /= 10;

64 } --
	mmšËn
 > 0 || 
	mx
 != 0);

66 
	mlcdf
::
SŒ
 
¡ršg
() const {

67  
lcdf
::
SŒ
(
bbuf_
, 
buf_
 + (buf_) - 1);

69 cÚ¡ *
c_¡r
() {

70 
	mbuf_
[(
buf_
) - 1] = 0;

71  
	mbbuf_
;

73 
boŞ
 
	mİ”©Ü
==(
lcdf
::
SŒ
 
s
) const {

74  
s
.
Ën
 =ğ(
buf_
 + (buf_è- 1è- 
bbuf_


75 && 
memcmp
(
s
.s, 
bbuf_
, s.
Ën
) == 0;

77 
boŞ
 
	mİ”©Ü
!=(
lcdf
::
SŒ
 
s
) const {

78  !(*
this
 =ğ
s
);

82 
	gCÍ_P¬£r
;

83 
şp_·r£_suffixdoubË
(
CÍ_P¬£r
 *
şp
, cÚ¡ *
v¡r
,

84 
com¶aš
, *
u£r_d©a
);

	@masstree-beta/msgpack.cc

1 
	~"msg·ck.hh
"

2 
Çme¥aû
 
	gmsg·ck
 {

4 
	gÇme¥aû
 {

5 cÚ¡ 
ušt8_t
 
	gnby‹s
[] = {

19 cÚ¡ 
ušt8_t
* 
	g¡»amšg_·r£r
::
cÚsume
(cÚ¡ ušt8_t* 
fœ¡
,

20 cÚ¡ 
ušt8_t
* 
Ï¡
,

21 cÚ¡ 
SŒšg
& 
¡r
) {

22 
usšg
 
	g¡d
::
sw­
;

23 
JsÚ
* 
	gjx
;

24 
	gn
 = 0;

26 ià(
	g¡©e_
 < 0)

27  
	gfœ¡
;

28 ià(
	g¡©e_
 =ğ
¡_·¹Ÿl
 || 
¡©e_
 =ğ
¡_¡ršg
) {

29 
Â“d
;

30 ià(
	g¡©e_
 =ğ
¡_·¹Ÿl
)

31 
Â“d
 = 
nby‹s
[
¡r_
.
ud©a
()[0] - 0xC0];

33 
	gÂ“d
 = 
¡ack_
.
back
().
size
;

34 cÚ¡ 
ušt8_t
* 
	gÃxt
;

35 ià(
	gÏ¡
 - 
	gfœ¡
 < 
	gÂ“d
 - 
	g¡r_
.
Ëngth
())

36 
	gÃxt
 = 
Ï¡
;

38 
	gÃxt
 = 
fœ¡
 + (
Â“d
 - 
¡r_
.
Ëngth
());

39 
	g¡r_
.
­³nd
(
fœ¡
, 
Ãxt
);

40 ià(
	g¡r_
.
Ëngth
(è!ğ
Â“d
)

41  
Ãxt
;

42 
	gfœ¡
 = 
Ãxt
;

43 ià(
	g¡©e_
 =ğ
¡_¡ršg
) {

44 
¡ack_
.
pİ_back
();

45 
	gjx
 = 
¡ack_
.
em±y
(è? &
jsÚ_
 : sck_.
back
().
jp
;

46 *
	gjx
 = 
¡r_
;

47 
	gÃxt
;

49 
	g¡©e_
 = 
¡_nÜm®
;

50 
cÚsume
(
¡r_
.
ubegš
(), sŒ_.
u’d
(), str_);

51 ià(
	g¡©e_
 !ğ
¡_nÜm®
)

52  
Ãxt
;

56 
	gfœ¡
 !ğ
Ï¡
) {

57 
jx
 = 
¡ack_
.
em±y
(è? &
jsÚ_
 : sck_.
back
().
jp
;

59 ià(
	gfÜm©
::
is_fixšt
(*
fœ¡
)) {

60 *
jx
 = (
št8_t
(*
fœ¡
));

61 ++
	gfœ¡
;

62 } ià(*
	gfœ¡
 =ğ
fÜm©
::
âuÎ
) {

63 *
jx
 = 
JsÚ
();

64 ++
	gfœ¡
;

65 } ià(
	gfÜm©
::
is_boŞ
(*
fœ¡
)) {

66 *
jx
 = 
boŞ
(*
fœ¡
 - 
fÜm©
::
fçl£
);

67 ++
	gfœ¡
;

68 } ià(
	gfÜm©
::
is_fixm­
(*
fœ¡
)) {

69 
n
 = *
fœ¡
 - 
fÜm©
::
ffixm­
;

70 ++
	gfœ¡
;

71 
	gm­
:

72 ià(
jx
->
is_o
())

73 
jx
->
ş—r
();

75 *
	gjx
 = 
JsÚ
::
make_objeù
();

76 } ià(
	gfÜm©
::
is_fix¬¿y
(*
fœ¡
)) {

77 
n
 = *
fœ¡
 - 
fÜm©
::
ffix¬¿y
;

78 ++
	gfœ¡
;

79 
	g¬¿y
:

80 ià(!
jx
->
is_a
())

81 *
jx
 = 
JsÚ
::
make_¬¿y_»£rve
(
n
);

82 
	gjx
->
»size
(
n
);

83 } ià(
	gfÜm©
::
is_fix¡r
(*
fœ¡
)) {

84 
n
 = *
fœ¡
 - 
fÜm©
::
ffix¡r
;

85 ++
	gfœ¡
;

86 
	g¿w
:

87 ià(
Ï¡
 - 
fœ¡
 < 
n
) {

88 
¡r_
 = 
SŒšg
(
fœ¡
, 
Ï¡
);

89 
	g¡ack_
.
push_back
(
£Ëm
{0, 
n
});

90 
	g¡©e_
 = 
¡_¡ršg
;

91  
	gÏ¡
;

93 ià(
	gfœ¡
 < 
	g¡r
.
ubegš
(è|| fœ¡ + 
	gn
 >ğ
¡r
.
u’d
())

94 *
jx
 = 
SŒšg
(
fœ¡
, 
n
);

96 cÚ¡ * 
	gs
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
fœ¡
);

97 *
	gjx
 = 
¡r
.
ç¡_sub¡ršg
(
s
, s + 
n
);

99 
	gfœ¡
 +ğ
n
;

101 
ušt8_t
 
	gty³
 = *
fœ¡
 - 
fÜm©
::
âuÎ
;

102 ià(!
	gnby‹s
[
ty³
])

103 
	g”rÜ
;

104 ià(
	gÏ¡
 - 
	gfœ¡
 < 
	gnby‹s
[
ty³
]) {

105 
	g¡r_
 = 
SŒšg
(
fœ¡
, 
Ï¡
);

106 
	g¡©e_
 = 
¡_·¹Ÿl
;

107  
	gÏ¡
;

109 
	gfœ¡
 +ğ
nby‹s
[
ty³
];

110 
	gty³
) {

111 
	gfÜm©
::
fæßt32
 - 
fÜm©
::
âuÎ
:

112 *
jx
 = 
»ad_š_Ãt_Üd”
<>(
fœ¡
 - 4);

114 
	gfÜm©
::
fæßt64
 - 
fÜm©
::
âuÎ
:

115 *
jx
 = 
»ad_š_Ãt_Üd”
<>(
fœ¡
 - 8);

117 
	gfÜm©
::
fušt8
 - 
fÜm©
::
âuÎ
:

118 *
jx
 = (
fœ¡
[-1]);

120 
	gfÜm©
::
fušt16
 - 
fÜm©
::
âuÎ
:

121 *
jx
 = 
»ad_š_Ãt_Üd”
<
ušt16_t
>(
fœ¡
 - 2);

123 
	gfÜm©
::
fušt32
 - 
fÜm©
::
âuÎ
:

124 *
jx
 = 
»ad_š_Ãt_Üd”
<
ušt32_t
>(
fœ¡
 - 4);

126 
	gfÜm©
::
fušt64
 - 
fÜm©
::
âuÎ
:

127 *
jx
 = 
»ad_š_Ãt_Üd”
<
ušt64_t
>(
fœ¡
 - 8);

129 
	gfÜm©
::
fšt8
 - 
fÜm©
::
âuÎ
:

130 *
jx
 = 
št8_t
(
fœ¡
[-1]);

132 
	gfÜm©
::
fšt16
 - 
fÜm©
::
âuÎ
:

133 *
jx
 = 
»ad_š_Ãt_Üd”
<
št16_t
>(
fœ¡
 - 2);

135 
	gfÜm©
::
fšt32
 - 
fÜm©
::
âuÎ
:

136 *
jx
 = 
»ad_š_Ãt_Üd”
<
št32_t
>(
fœ¡
 - 4);

138 
	gfÜm©
::
fšt64
 - 
fÜm©
::
âuÎ
:

139 *
jx
 = 
»ad_š_Ãt_Üd”
<
št64_t
>(
fœ¡
 - 8);

141 
	gfÜm©
::
fbš8
 - 
fÜm©
::
âuÎ
:

142 
fÜm©
::
f¡r8
 - fÜm©::
âuÎ
:

143 
n
 = 
fœ¡
[-1];

144 
	g¿w
;

145 
	gfÜm©
::
fbš16
 - 
fÜm©
::
âuÎ
:

146 
fÜm©
::
f¡r16
 - fÜm©::
âuÎ
:

147 
n
 = 
»ad_š_Ãt_Üd”
<
ušt16_t
>(
fœ¡
 - 2);

148 
	g¿w
;

149 
	gfÜm©
::
fbš32
 - 
fÜm©
::
âuÎ
:

150 
fÜm©
::
f¡r32
 - fÜm©::
âuÎ
:

151 
n
 = 
»ad_š_Ãt_Üd”
<
ušt32_t
>(
fœ¡
 - 4);

152 
	g¿w
;

153 
	gfÜm©
::
ç¼ay16
 - 
fÜm©
::
âuÎ
:

154 
n
 = 
»ad_š_Ãt_Üd”
<
ušt16_t
>(
fœ¡
 - 2);

155 
	g¬¿y
;

156 
	gfÜm©
::
ç¼ay32
 - 
fÜm©
::
âuÎ
:

157 
n
 = 
»ad_š_Ãt_Üd”
<
ušt32_t
>(
fœ¡
 - 4);

158 
	g¬¿y
;

159 
	gfÜm©
::
fm­16
 - 
fÜm©
::
âuÎ
:

160 
n
 = 
»ad_š_Ãt_Üd”
<
ušt16_t
>(
fœ¡
 - 2);

161 
	gm­
;

162 
	gfÜm©
::
fm­32
 - 
fÜm©
::
âuÎ
:

163 
n
 = 
»ad_š_Ãt_Üd”
<
ušt32_t
>(
fœ¡
 - 4);

164 
	gm­
;

169 
	gÃxt
:

170 ià(
jx
 =ğ&
jokey_
) {

172 ià(!
jx
->
is_s
(è&& !jx->
is_i
())

173 
”rÜ
;

174 
£Ëm
* 
	gtİ
 = &
¡ack_
.
back
();

175 
JsÚ
* 
	gjo
 = (
tİ
 =ğ
¡ack_
.
begš
(è? &
jsÚ_
 :İ[-1].
jp
);

176 
	gtİ
->
	gjp
 = &
jo
->
g‘_š£¹
(
jx
->
to_s
());

180 ià(
	gjx
->
is_a
(è&& 
	gn
 != 0)

181 
¡ack_
.
push_back
(
£Ëm
{&
jx
->
©_š£¹
(0), 
n
 - 1});

182 ià(
	gjx
->
is_o
(è&& 
	gn
 != 0)

183 
¡ack_
.
push_back
(
£Ëm
{&
jokey_
, 
n
 - 1});

185 !
	g¡ack_
.
em±y
(è&& sck_.
back
().
	gsize
 == 0)

186 
¡ack_
.
pİ_back
();

187 ià(
	g¡ack_
.
em±y
()) {

188 
	g¡©e_
 = 
¡_fš®
;

189  
	gfœ¡
;

191 
£Ëm
* 
	gtİ
 = &
¡ack_
.
back
();

192 --
	gtİ
->
	gsize
;

193 
JsÚ
* 
	gjo
 = (
tİ
 =ğ
¡ack_
.
begš
(è? &
jsÚ_
 :İ[-1].
jp
);

194 ià(
	gjo
->
is_a
())

195 ++
	gtİ
->
	gjp
;

197 
	gtİ
->
	gjp
 = &
jokey_
;

201 
	g¡©e_
 = 
¡_nÜm®
;

202  
	gfœ¡
;

204 
	g”rÜ
:

205 
¡©e_
 = 
¡_”rÜ
;

206  
	gfœ¡
;

209 
	g·r£r
&…¬£r::
İ”©Ü
>>(
SŒ
& 
x
) {

210 
ušt32_t
 
Ën
;

211 ià((
	gušt32_t
è*
	gs_
 - 
	gfÜm©
::
ffix¡r
 < 
fÜm©
::
nfix¡r
) {

212 
Ën
 = *
s_
 - 
fÜm©
::
ffix¡r
;

213 ++
	gs_
;

214 } ià(*
	gs_
 =ğ
fÜm©
::
fbš8
 || *
s_
 =ğfÜm©::
f¡r8
) {

215 
Ën
 = 
s_
[1];

216 
	gs_
 += 2;

217 } ià(*
	gs_
 =ğ
fÜm©
::
fbš16
 || *
s_
 =ğfÜm©::
f¡r16
) {

218 
Ën
 = 
»ad_š_Ãt_Üd”
<
ušt16_t
>(
s_
 + 1);

219 
	gs_
 += 3;

221 
as£¹
(*
s_
 =ğ
fÜm©
::
fbš32
 || *s_ =ğfÜm©::
f¡r32
);

222 
	gËn
 = 
»ad_š_Ãt_Üd”
<
ušt32_t
>(
s_
 + 1);

223 
	gs_
 += 5;

225 
	gx
.
assign
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s_
), 
Ën
);

226 
	gs_
 +ğ
Ën
;

227  *
	gthis
;

230 
	g·r£r
&…¬£r::
İ”©Ü
>>(
SŒšg
& 
x
) {

231 
SŒ
 
s
;

232 *
	gthis
 >> 
	gs
;

233 ià(
	g¡r_
)

234 
	gx
 = 
¡r_
.
sub¡ršg
(
s
.
begš
(), s.
’d
());

236 
	gx
.
assign
(
s
.
begš
(), s.
’d
());

237  *
	gthis
;

	@masstree-beta/msgpack.hh

1 #iâdeà
GSTORE_MSGPACK_HH


2 
	#GSTORE_MSGPACK_HH


	)

3 
	~"jsÚ.hh
"

4 
	~"sm®l_veùÜ.hh
"

5 
	~"¡¿ccum.hh
"

6 
	~<veùÜ
>

7 
Çme¥aû
 
	gmsg·ck
 {

8 
usšg
 
	glcdf
::
JsÚ
;

9 
usšg
 
	glcdf
::
SŒ
;

10 
usšg
 
	glcdf
::
SŒšg
;

11 
usšg
 
	glcdf
::
SŒšgAccum
;

13 
Çme¥aû
 
	gfÜm©
 {

15 
	gffixušt
 = 0x00, 
	gnfixušt
 = 0x80,

16 
	gffixm­
 = 0x80, 
	gnfixm­
 = 0x10,

17 
	gffix¬¿y
 = 0x90, 
	gnfix¬¿y
 = 0x10,

18 
	gffix¡r
 = 0xA0, 
	gnfix¡r
 = 0x20,

19 
	gâuÎ
 = 0xC0,

20 
	gfçl£
 = 0xC2, 
	gárue
 = 0xC3,

21 
	gfbš8
 = 0xC4, 
	gfbš16
 = 0xC5, 
	gfbš32
 = 0xC6,

22 
	gãxt8
 = 0xC7, 
	gãxt16
 = 0xC8, 
	gãxt32
 = 0xC9,

23 
	gfæßt32
 = 0xCA, 
	gfæßt64
 = 0xCB,

24 
	gfušt8
 = 0xCC, 
	gfušt16
 = 0xCD, 
	gfušt32
 = 0xCE, 
	gfušt64
 = 0xCF,

25 
	gfšt8
 = 0xD0, 
	gfšt16
 = 0xD1, 
	gfšt32
 = 0xD2, 
	gfšt64
 = 0xD3,

26 
	gffixext1
 = 0xD4, 
	gffixext2
 = 0xD5, 
	gffixext4
 = 0xD6,

27 
	gffixext8
 = 0xD7, 
	gffixext16
 = 0xD8,

28 
	gf¡r8
 = 0xD9, 
	gf¡r16
 = 0xDA, 
	gf¡r32
 = 0xDB,

29 
	gç¼ay16
 = 0xDC, 
	gç¼ay32
 = 0xDD,

30 
	gfm­16
 = 0xDE, 
	gfm­32
 = 0xDF,

31 
	gffixÃgšt
 = 0xE0, 
	gnfixÃgšt
 = 0x20,

32 
	gnfixšt
 = 
nfixušt
 + 
nfixÃgšt


35 
šlše
 
boŞ
 
š_¿nge
(
ušt8_t
 
x
, 
low
, 
n
) {

36  (è
	gx
 - 
	glow
 < 
	gn
;

38 
šlše
 
boŞ
 
š_w¿µed_¿nge
(
ušt8_t
 
x
, 
low
, 
n
) {

39  (è(
	gšt8_t
è
	gx
 - 
	glow
 < 
	gn
;

42 
šlše
 
boŞ
 
is_fixšt
(
ušt8_t
 
x
) {

43  
š_w¿µed_¿nge
(
x
, -
nfixÃgšt
, 
nfixšt
);

45 
šlše
 
boŞ
 
is_nuÎ_Ü_boŞ
(
ušt8_t
 
x
) {

46  
š_¿nge
(
x
, 
âuÎ
, 4);

48 
šlše
 
boŞ
 
is_boŞ
(
ušt8_t
 
x
) {

49  
š_¿nge
(
x
, 
fçl£
, 2);

51 
šlše
 
boŞ
 
is_fix¡r
(
ušt8_t
 
x
) {

52  
š_¿nge
(
x
, 
ffix¡r
, 
nfix¡r
);

54 
šlše
 
boŞ
 
is_fix¬¿y
(
ušt8_t
 
x
) {

55  
š_¿nge
(
x
, 
ffix¬¿y
, 
nfix¬¿y
);

57 
šlše
 
boŞ
 
is_fixm­
(
ušt8_t
 
x
) {

58  
š_¿nge
(
x
, 
ffixm­
, 
nfixm­
);

61 
šlše
 * 
wr™e_nuÎ
(* 
s
) {

62 *
	gs
++ = 
âuÎ
;

63  
	gs
;

65 
šlše
 * 
wr™e_boŞ
(* 
s
, 
boŞ
 
x
) {

66 *
	gs
++ = 
fçl£
 + 
x
;

67  
	gs
;

70 
	g‹m¶©e
 <
size_t
 
	gs
> 
	ssized_wr™”
 {};

71 
	g‹m¶©e
 <> 
	gsized_wr™”
<4> {

72 
šlše
 * 
wr™e_unsigÃd
(* 
s
, 
ušt32_t
 
x
) {

73 ià(
	gx
 < 
	gnfixušt
)

74 *
	gs
++ = 
x
;

75 ià(
	gx
 < 256) {

76 *
	gs
++ = 
fušt8
;

77 *
	gs
++ = 
x
;

78 } ià(
	gx
 < 65536) {

79 *
	gs
++ = 
fušt16
;

80 
	gs
 = 
wr™e_š_Ãt_Üd”
<
ušt16_t
>(
s
, (
	gušt16_t
è
	gx
);

82 *
	gs
++ = 
fušt32
;

83 
	gs
 = 
wr™e_š_Ãt_Üd”
<
ušt32_t
>(
s
, 
	gx
);

85  
	gs
;

87 
šlše
 * 
wr™e_sigÃd
(* 
s
, 
št32_t
 
x
) {

88 ià((
	gušt32_t
è
	gx
 + 
	gnfixÃgšt
 < 
	gnfixšt
)

89 *
	gs
++ = 
x
;

90 ià((
	gušt32_t
è
	gx
 + 128 < 256) {

91 *
	gs
++ = 
fšt8
;

92 *
	gs
++ = 
x
;

93 } ià((
	gušt32_t
è
	gx
 + 32768 < 65536) {

94 *
	gs
++ = 
fšt16
;

95 
	gs
 = 
wr™e_š_Ãt_Üd”
<
št16_t
>(
s
, (
	gšt16_t
è
	gx
);

97 *
	gs
++ = 
fšt32
;

98 
	gs
 = 
wr™e_š_Ãt_Üd”
<
št32_t
>(
s
, 
	gx
);

100  
	gs
;

103 
	g‹m¶©e
 <> 
	gsized_wr™”
<8> {

104 
šlše
 * 
wr™e_unsigÃd
(* 
s
, 
ušt64_t
 
x
) {

105 ià(
	gx
 < 4294967296ULL)

106  
	gsized_wr™”
<4>::
wr™e_unsigÃd
(
s
, (
ušt32_t
è
x
);

108 *
	gs
++ = 
fušt64
;

109  
	gwr™e_š_Ãt_Üd”
<
	gušt64_t
>(
	gs
, 
	gx
);

112 
šlše
 * 
wr™e_sigÃd
(* 
s
, 
št64_t
 
x
) {

113 ià(
	gx
 + 2147483648ULL < 4294967296ULL)

114  
	gsized_wr™”
<4>::
wr™e_sigÃd
(
s
, (
št32_t
è
x
);

116 *
	gs
++ = 
fšt64
;

117  
	gwr™e_š_Ãt_Üd”
<
	gšt64_t
>(
	gs
, 
	gx
);

121 
šlše
 * 
wr™e_št
(* 
s
, 
x
) {

122  
	gsized_wr™”
<(
	gx
)>::
wr™e_sigÃd
(
s
, 
x
);

124 
šlše
 * 
wr™e_št
(* 
s
, 
x
) {

125  
	gsized_wr™”
<(
	gx
)>::
wr™e_unsigÃd
(
s
, 
x
);

127 
šlše
 * 
wr™e_št
(* 
s
, 
x
) {

128  
	gsized_wr™”
<(
	gx
)>::
wr™e_sigÃd
(
s
, 
x
);

130 
šlše
 * 
wr™e_št
(* 
s
, 
x
) {

131  
	gsized_wr™”
<(
	gx
)>::
wr™e_unsigÃd
(
s
, 
x
);

133 #ià
HAVE_LONG_LONG
 && 
SIZEOF_LONG_LONG
 <= 8

134 
šlše
 * 
wr™e_št
(* 
s
, 
x
) {

135  
	gsized_wr™”
<(
	gx
)>::
wr™e_sigÃd
(
s
, 
x
);

137 
šlše
 * 
wr™e_št
(* 
s
, 
x
) {

138  
	gsized_wr™”
<(
	gx
)>::
wr™e_unsigÃd
(
s
, 
x
);

141 
šlše
 * 
wr™e_wide_št64
(* 
s
, 
ušt64_t
 
x
) {

142 *
	gs
++ = 
fušt64
;

143  
	gwr™e_š_Ãt_Üd”
<
	gušt64_t
>(
	gs
, 
	gx
);

145 
šlše
 * 
wr™e_wide_št64
(* 
s
, 
št64_t
 
x
) {

146 *
	gs
++ = 
fšt64
;

147  
	gwr™e_š_Ãt_Üd”
<
	gšt64_t
>(
	gs
, 
	gx
);

149 
šlše
 * 
wr™e_æßt
(* 
s
, 
x
) {

150 *
	gs
++ = 
fæßt32
;

151  
	gwr™e_š_Ãt_Üd”
<>(
	gs
, 
	gx
);

153 
šlše
 * 
wr™e_doubË
(* 
s
, 
x
) {

154 *
	gs
++ = 
fæßt64
;

155  
	gwr™e_š_Ãt_Üd”
<>(
	gs
, 
	gx
);

157 
šlše
 * 
wr™e_¡ršg
(* 
s
, cÚ¡ *
d©a
, 
Ën
) {

158 ià(
	gËn
 < 
	gnfix¡r
)

159 *
	gs
++ = 0xA0 + 
Ën
;

160 ià(
	gËn
 < 256) {

161 *
	gs
++ = 
f¡r8
;

162 *
	gs
++ = 
Ën
;

163 } ià(
	gËn
 < 65536) {

164 *
	gs
++ = 
f¡r16
;

165 
	gs
 = 
wr™e_š_Ãt_Üd”
<
ušt16_t
>(
s
, (
	gušt16_t
è
	gËn
);

167 *
	gs
++ = 
f¡r32
;

168 
	gs
 = 
wr™e_š_Ãt_Üd”
<
ušt32_t
>(
s
, 
	gËn
);

170 
memıy
(
s
, 
d©a
, 
Ën
);

171  
	gs
 + 
	gËn
;

173 
šlše
 * 
wr™e_¡ršg
(* 
s
, 
SŒ
 
x
) {

174  
wr™e_¡ršg
(
s
, 
x
.
d©a
(), x.
Ëngth
());

176 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

177 
šlše
 * 
wr™e_¡ršg
(* 
s
, cÚ¡ 
lcdf
::
SŒšg_ba£
<
T
>& 
x
) {

178  
wr™e_¡ršg
(
s
, 
x
.
d©a
(), x.
Ëngth
());

180 
šlše
 * 
wr™e_¬¿y_h—d”
(* 
s
, 
ušt32_t
 
size
) {

181 ià(
	gsize
 < 
	gnfix¬¿y
) {

182 *
	gs
++ = 
ffix¬¿y
 + 
size
;

183  
	gs
;

184 } ià(
	gsize
 < 65536) {

185 *
	gs
++ = 
ç¼ay16
;

186  
	gwr™e_š_Ãt_Üd”
<
	gušt16_t
>(
	gs
, (ušt16_tè
	gsize
);

188 *
	gs
++ = 
ç¼ay32
;

189  
	gwr™e_š_Ãt_Üd”
<
	gušt32_t
>(
	gs
, (ušt32_tè
	gsize
);

192 
šlše
 * 
wr™e_m­_h—d”
(* 
s
, 
ušt32_t
 
size
) {

193 ià(
	gsize
 < 
	gnfixm­
) {

194 *
	gs
++ = 
ffixm­
 + 
size
;

195  
	gs
;

196 } ià(
	gsize
 < 65536) {

197 *
	gs
++ = 
fm­16
;

198  
	gwr™e_š_Ãt_Üd”
<
	gušt16_t
>(
	gs
, (ušt16_tè
	gsize
);

200 *
	gs
++ = 
fm­32
;

201  
	gwr™e_š_Ãt_Üd”
<
	gušt32_t
>(
	gs
, (ušt32_tè
	gsize
);

206 
	s¬¿y_t
 {

207 
ušt32_t
 
	gsize
;

208 
¬¿y_t
(
ušt32_t
 
s
)

209 : 
size
(
s
) {

213 
šlše
 
¬¿y_t
 
¬¿y
(
ušt32_t
 
size
) {

214  
¬¿y_t
(
size
);

217 
	sobjeù_t
 {

218 
ušt32_t
 
	gsize
;

219 
objeù_t
(
ušt32_t
 
s
)

220 : 
size
(
s
) {

224 
šlše
 
objeù_t
 
objeù
(
ušt32_t
 
size
) {

225  
objeù_t
(
size
);

228 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

229 şas 
	cuÅ¬£r
 {

230 
	gpublic
:

231 
šlše
 
uÅ¬£r
(
T
& 
ba£
)

232 : 
ba£_
(
ba£
) {

234 
‹m¶©e
 <
ty³Çme
 
X
>

235 
šlše
 
uÅ¬£r
(
T
& 
ba£
, cÚ¡ 
X
& 
x
)

236 : 
ba£_
(
ba£
) {

237 *
this
 << 
x
;

240 
šlše
 
ş—r
() {

241 
	gba£_
.
ş—r
();

244 
šlše
 
	guÅ¬£r
<
	gT
>& 
nuÎ
() {

245 
	gba£_
.
­³nd
((è
fÜm©
::
âuÎ
);

246  *
	gthis
;

248 
šlše
 
	guÅ¬£r
<
	gT
>& 
	gİ”©Ü
<<(cÚ¡ 
	gJsÚ
::
nuÎ_t
&) {

249  
nuÎ
();

251 
šlše
 
	guÅ¬£r
<
	gT
>& 
	gİ”©Ü
<<(
	gx
) {

252 * 
	gs
 = 
ba£_
.
»£rve
((
x
) + 1);

253 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_št
(
s
, 
x
));

254  *
	gthis
;

256 
šlše
 
	guÅ¬£r
<
	gT
>& 
	gİ”©Ü
<<(
	gx
) {

257 * 
	gs
 = 
ba£_
.
»£rve
((
x
) + 1);

258 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_št
(
s
, 
x
));

259  *
	gthis
;

261 
šlše
 
	guÅ¬£r
<
	gT
>& 
	gİ”©Ü
<<(
	gx
) {

262 * 
	gs
 = 
ba£_
.
»£rve
((
x
) + 1);

263 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_št
(
s
, 
x
));

264  *
	gthis
;

266 
šlše
 
	guÅ¬£r
<
	gT
>& 
	gİ”©Ü
<<(
	gx
) {

267 * 
	gs
 = 
ba£_
.
»£rve
((
x
) + 1);

268 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_št
(
s
, 
x
));

269  *
	gthis
;

271 #ià
HAVE_LONG_LONG
 && 
SIZEOF_LONG_LONG
 <= 8

272 
šlše
 
	guÅ¬£r
<
	gT
>& 
	gİ”©Ü
<<(
	gx
) {

273 * 
	gs
 = 
ba£_
.
»£rve
((
x
) + 1);

274 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_št
(
s
, 
x
));

275  *
	gthis
;

277 
šlše
 
	guÅ¬£r
<
	gT
>& 
	gİ”©Ü
<<(
	gx
) {

278 * 
	gs
 = 
ba£_
.
»£rve
((
x
) + 1);

279 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_št
(
s
, 
x
));

280  *
	gthis
;

283 
šlše
 
	guÅ¬£r
<
	gT
>& 
wr™e_wide
(
št64_t
 
x
) {

284 * 
	gs
 = 
ba£_
.
»£rve
((
x
) + 1);

285 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_wide_št64
(
s
, 
x
));

286  *
	gthis
;

288 
šlše
 
	guÅ¬£r
<
	gT
>& 
wr™e_wide
(
ušt64_t
 
x
) {

289 * 
	gs
 = 
ba£_
.
»£rve
((
x
) + 1);

290 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_wide_št64
(
s
, 
x
));

291  *
	gthis
;

293 
šlše
 
	guÅ¬£r
<
	gT
>& 
	gİ”©Ü
<<(
	gx
) {

294 * 
	gs
 = 
ba£_
.
»£rve
((
x
) + 1);

295 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_æßt
(
s
, 
x
));

296  *
	gthis
;

298 
šlše
 
	guÅ¬£r
<
	gT
>& 
	gİ”©Ü
<<(
	gx
) {

299 * 
	gs
 = 
ba£_
.
»£rve
((
x
) + 1);

300 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_doubË
(
s
, 
x
));

301  *
	gthis
;

303 
šlše
 
	guÅ¬£r
<
	gT
>& 
	gİ”©Ü
<<(
SŒ
 
	gx
) {

304 * 
	gs
 = 
ba£_
.
»£rve
(5 + 
x
.
Ëngth
());

305 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_¡ršg
(
s
, 
x
.
d©a
(), x.
Ëngth
()));

306  *
	gthis
;

308 
	g‹m¶©e
 <
ty³Çme
 
	gX
>

309 
šlše
 
	guÅ¬£r
<
	gT
>& 
	gİ”©Ü
<<(cÚ¡ 
	glcdf
::
SŒšg_ba£
<
X
>& 
x
) {

310 * 
s
 = 
ba£_
.
»£rve
(5 + 
x
.
Ëngth
());

311 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_¡ršg
(
s
, 
x
.
d©a
(), x.
Ëngth
()));

312  *
	gthis
;

314 
šlše
 
	guÅ¬£r
<
	gT
>& 
	gİ”©Ü
<<(
¬¿y_t
 
	gx
) {

315 * 
	gs
 = 
ba£_
.
»£rve
(5);

316 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_¬¿y_h—d”
(
s
, 
x
.
size
));

317  *
	gthis
;

319 
šlše
 
	guÅ¬£r
<
	gT
>& 
wr™e_¬¿y_h—d”
(
ušt32_t
 
size
) {

320 * 
	gs
 = 
ba£_
.
»£rve
(5);

321 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_¬¿y_h—d”
(
s
, 
size
));

322  *
	gthis
;

324 
šlše
 
	guÅ¬£r
<
	gT
>& 
	gİ”©Ü
<<(
objeù_t
 
	gx
) {

325 * 
	gs
 = 
ba£_
.
»£rve
(5);

326 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_m­_h—d”
(
s
, 
x
.
size
));

327  *
	gthis
;

329 
	guÅ¬£r
<
	gT
>& 
	gİ”©Ü
<<(cÚ¡ 
	gJsÚ
& 
	gj
);

330 
	g‹m¶©e
 <
ty³Çme
 
	gX
>

331 
šlše
 
	guÅ¬£r
<
	gT
>& 
wr™e
(cÚ¡ 
X
& 
x
) {

332  *
	gthis
 << 
	gx
;

335 
	g´iv©e
:

336 
T
& 
ba£_
;

339 şas 
	c¡»amšg_·r£r
 {

340 
	gpublic
:

341 
šlše
 
¡»amšg_·r£r
();

342 
šlše
 
»£t
();

344 
šlše
 
boŞ
 
em±y
() const;

345 
šlše
 
boŞ
 
dÚe
() const;

346 
šlše
 
boŞ
 
sucûss
() const;

347 
šlše
 
boŞ
 
”rÜ
() const;

349 
šlše
 
size_t
 
cÚsume
(cÚ¡ * 
fœ¡
, size_ˆ
Ëngth
,

350 cÚ¡ 
SŒšg
& 
¡r
 = String());

351 
šlše
 cÚ¡ * 
cÚsume
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
,

352 cÚ¡ 
SŒšg
& 
¡r
 = String());

353 cÚ¡ 
ušt8_t
* 
cÚsume
(cÚ¡ ušt8_t* 
fœ¡
, cÚ¡ ušt8_t* 
Ï¡
,

354 cÚ¡ 
SŒšg
& 
¡r
 = String());

356 
šlše
 
	gJsÚ
& 
»suÉ
();

357 
šlše
 cÚ¡ 
	gJsÚ
& 
»suÉ
() const;

359 
	g´iv©e
:

361 
¡_fš®
 = -2, 
	g¡_”rÜ
 = -1, 
	g¡_nÜm®
 = 0, 
	g¡_·¹Ÿl
 = 1,

362 
	g¡_¡ršg
 = 2

364 
	s£Ëm
 {

365 
JsÚ
* 
	gjp
;

366 
	gsize
;

368 
	g¡©e_
;

369 
	gsm®l_veùÜ
<
	g£Ëm
, 2> 
	g¡ack_
;

370 
SŒšg
 
	g¡r_
;

371 
JsÚ
 
	gjsÚ_
;

372 
JsÚ
 
	gjokey_
;

375 şas 
	c·r£r
 {

376 
	gpublic
:

377 
ex¶ic™
 
šlše
 
·r£r
(cÚ¡ * 
s
)

378 : 
s_
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
)), 
¡r_
() {

380 
ex¶ic™
 
šlše
 
·r£r
(cÚ¡ * 
s
)

381 : 
s_
(
s
), 
¡r_
() {

383 
ex¶ic™
 
šlše
 
·r£r
(cÚ¡ 
SŒšg
& 
¡r
)

384 : 
s_
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>(
¡r
.
begš
())), 
¡r_
(str) {

386 
šlše
 cÚ¡ * 
pos™iÚ
() const {

387  
	g»š‹½»t_ÿ¡
<cÚ¡ *>(
	gs_
);

390 
šlše
 
boŞ
 
Œy_»ad_nuÎ
() {

391 ià(*
	gs_
 =ğ
fÜm©
::
âuÎ
) {

392 ++
s_
;

393  
	gŒue
;

395  
	gçl£
;

397 
šlše
 
»ad_tšy_št
() {

398 
as£¹
(
fÜm©
::
is_fixšt
(*
s_
));

399  (
	gšt8_t
è*
	gs_
++;

401 
šlše
 
	g·r£r
& 
»ad_tšy_št
(& 
x
) {

402 
	gx
 = 
»ad_tšy_št
();

403  *
	gthis
;

405 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

406 
šlše
 
	g·r£r
& 
»ad_št
(
T
& 
x
) {

407 ià(
	gfÜm©
::
is_fixšt
(*
s_
)) {

408 
x
 = (
št8_t
è*
s_
;

409 ++
	gs_
;

411 
as£¹
((
ušt32_t
è*
s_
 - 
fÜm©
::
fušt8
 < 8);

412 
h¬d_»ad_št
(
x
);

414  *
	gthis
;

416 
šlše
 
	g·r£r
& 
	gİ”©Ü
>>(& 
	gx
) {

417  
»ad_št
(
x
);

419 
šlše
 
	g·r£r
& 
	gİ”©Ü
>>(& 
	gx
) {

420  
»ad_št
(
x
);

422 
šlše
 
	g·r£r
& 
	gİ”©Ü
>>(& 
	gx
) {

423  
»ad_št
(
x
);

425 
šlše
 
	g·r£r
& 
	gİ”©Ü
>>(& 
	gx
) {

426  
»ad_št
(
x
);

428 
šlše
 
	g·r£r
& 
	gİ”©Ü
>>(& 
	gx
) {

429  
»ad_št
(
x
);

431 
šlše
 
	g·r£r
& 
	gİ”©Ü
>>(& 
	gx
) {

432  
»ad_št
(
x
);

434 
šlše
 
	g·r£r
& 
	gİ”©Ü
>>(
	gboŞ
& 
	gx
) {

435 
as£¹
(
fÜm©
::
is_boŞ
(*
s_
));

436 
	gx
 = *
s_
 - 
fÜm©
::
fçl£
;

437 ++
	gs_
;

438  *
	gthis
;

440 
šlše
 
	g·r£r
& 
	gİ”©Ü
>>(& 
	gx
) {

441 
as£¹
(*
s_
 =ğ
fÜm©
::
fæßt64
);

442 
	gx
 = 
»ad_š_Ãt_Üd”
<>(
s_
 + 1);

443 
	gs_
 += 9;

444  *
	gthis
;

446 
	g·r£r
& 
	gİ”©Ü
>>(
	gSŒ
& 
	gx
);

447 
	g·r£r
& 
	gİ”©Ü
>>(
	gSŒšg
& 
	gx
);

448 
šlše
 
	g·r£r
& 
»ad_¬¿y_h—d”
(& 
size
) {

449 ià(
	gfÜm©
::
is_fix¬¿y
(*
s_
)) {

450 
size
 = *
s_
 - 
fÜm©
::
ffix¬¿y
;

451 
	gs_
 += 1;

452 } ià(*
	gs_
 =ğ
fÜm©
::
ç¼ay16
) {

453 
size
 = 
»ad_š_Ãt_Üd”
<
ušt16_t
>(
s_
 + 1);

454 
	gs_
 += 3;

456 
as£¹
(*
s_
 =ğ
fÜm©
::
ç¼ay32
);

457 
	gsize
 = 
»ad_š_Ãt_Üd”
<
ušt32_t
>(
s_
 + 1);

458 
	gs_
 += 5;

460  *
	gthis
;

462 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	g·r£r
& 
	gİ”©Ü
>>(::
¡d
::
veùÜ
<
T
>& 
x
);

463 
šlše
 
	g·r£r
& 
	gİ”©Ü
>>(
	gJsÚ
& 
	gj
);

465 
šlše
 
	g·r£r
& 
sk_´im™ives
(
n
) {

466 ; 
	gn
 != 0; --n) {

467 ià(
	gfÜm©
::
is_fixšt
(*
s_
è|| 
fÜm©
::
is_nuÎ_Ü_boŞ
(*s_))

468 
s_
 += 1;

469 ià(
	gfÜm©
::
is_fix¡r
(*
s_
))

470 
s_
 +ğ1 + (*s_ - 
fÜm©
::
ffix¡r
);

471 ià(*
	gs_
 =ğ
fÜm©
::
fušt8
 || *
s_
 =ğfÜm©::
fšt8
)

472 
s_
 += 2;

473 ià(*
	gs_
 =ğ
fÜm©
::
fušt16
 || *
s_
 =ğfÜm©::
fšt16
)

474 
s_
 += 3;

475 ià(*
	gs_
 =ğ
fÜm©
::
fušt32
 || *
s_
 =ğfÜm©::
fšt32


476 || *
s_
 =ğ
fÜm©
::
fæßt32
)

477 
s_
 += 5;

478 ià(*
	gs_
 =ğ
fÜm©
::
f¡r8
 || *
s_
 =ğfÜm©::
fbš8
)

479 
s_
 += 2 + s_[1];

480 ià(*
	gs_
 =ğ
fÜm©
::
f¡r16
 || *
s_
 =ğfÜm©::
fbš16
)

481 
s_
 +ğ3 + 
»ad_š_Ãt_Üd”
<
ušt16_t
>(s_ + 1);

482 ià(*
	gs_
 =ğ
fÜm©
::
f¡r32
 || *
s_
 =ğfÜm©::
fbš32
)

483 
s_
 +ğ5 + 
»ad_š_Ãt_Üd”
<
ušt32_t
>(s_ + 1);

485  *
	gthis
;

487 
šlše
 
	g·r£r
& 
sk_´im™ive
() {

488  
sk_´im™ives
(1);

490 
šlše
 
	g·r£r
& 
sk_¬¿y_size
() {

491 ià(
	gfÜm©
::
is_fix¬¿y
(*
s_
))

492 
s_
 += 1;

493 ià(*
	gs_
 =ğ
fÜm©
::
ç¼ay16
)

494 
s_
 += 3;

496 
as£¹
(*
s_
 =ğ
fÜm©
::
ç¼ay32
);

497 
	gs_
 += 5;

499  *
	gthis
;

501 
	g´iv©e
:

502 cÚ¡ 
ušt8_t
* 
s_
;

503 
SŒšg
 
	g¡r_
;

504 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
h¬d_»ad_št
(
T
& 
x
);

507 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

508 
	g·r£r
::
	$h¬d_»ad_št
(
T
& 
x
) {

509 *
s_
) {

510 
fÜm©
::
fušt8
:

511 
x
 = 
s_
[1];

512 
s_
 += 2;

514 
fÜm©
::
fušt16
:

515 
x
 = 
»ad_š_Ãt_Üd”
<
ušt16_t
>(
s_
 + 1);

516 
s_
 += 3;

518 
fÜm©
::
fušt32
:

519 
x
 = 
»ad_š_Ãt_Üd”
<
ušt32_t
>(
s_
 + 1);

520 
s_
 += 5;

522 
fÜm©
::
fušt64
:

523 
x
 = 
»ad_š_Ãt_Üd”
<
ušt64_t
>(
s_
 + 1);

524 
s_
 += 9;

526 
fÜm©
::
fšt8
:

527 
x
 = (
št8_t
è
s_
[1];

528 
s_
 += 2;

530 
fÜm©
::
fšt16
:

531 
x
 = 
»ad_š_Ãt_Üd”
<
št16_t
>(
s_
 + 1);

532 
s_
 += 3;

534 
fÜm©
::
fšt32
:

535 
x
 = 
»ad_š_Ãt_Üd”
<
št32_t
>(
s_
 + 1);

536 
s_
 += 5;

538 
fÜm©
::
fšt64
:

539 
x
 = 
»ad_š_Ãt_Üd”
<
št64_t
>(
s_
 + 1);

540 
s_
 += 9;

543 
	}
}

545 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

546 
	guÅ¬£r
<
	gT
>& uÅ¬£r<T>::
İ”©Ü
<<(cÚ¡ 
JsÚ
& 
j
) {

547 ià(
j
.
is_nuÎ
())

548 
ba£_
.
­³nd
((
fÜm©
::
âuÎ
));

549 ià(
	gj
.
is_b
())

550 
	gba£_
.
­³nd
((
fÜm©
::
fçl£
 + 
j
.
as_b
()));

551 ià(
	gj
.
is_u
()) {

552 * 
	gx
 = 
ba£_
.
»£rve
(9);

553 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_št
(
x
, 
j
.
as_u
()));

554 } ià(
	gj
.
is_i
()) {

555 * 
	gx
 = 
ba£_
.
»£rve
(9);

556 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_št
(
x
, 
j
.
as_i
()));

557 } ià(
	gj
.
is_d
()) {

558 * 
	gx
 = 
ba£_
.
»£rve
(9);

559 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_doubË
(
x
, 
j
.
as_d
()));

560 } ià(
	gj
.
is_s
()) {

561 * 
	gx
 = 
ba£_
.
»£rve
(
j
.
as_s
().
Ëngth
() + 5);

562 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_¡ršg
(
x
, 
j
.
as_s
()));

563 } ià(
	gj
.
is_a
()) {

564 * 
	gx
 = 
ba£_
.
»£rve
(5);

565 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_¬¿y_h—d”
(
x
, 
j
.
size
()));

566 autØ
	g™
 = 
j
.
ÿbegš
(); iˆ!ğj.
ÿ’d
(); ++it)

567 *
	gthis
 << *
	g™
;

568 } ià(
	gj
.
is_o
()) {

569 * 
	gx
 = 
ba£_
.
»£rve
(5);

570 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_m­_h—d”
(
x
, 
j
.
size
()));

571 autØ
	g™
 = 
j
.
cobegš
(); iˆ!ğj.
cÛnd
(); ++it) {

572 * 
	gx
 = 
ba£_
.
»£rve
(
™
.
key
().
Ëngth
() + 5);

573 
	gba£_
.
£t_’d
(
fÜm©
::
wr™e_¡ršg
(
x
, 
™
.
key
()));

574 *
	gthis
 << 
	g™
.
v®ue
();

577 
	gba£_
.
­³nd
((
fÜm©
::
âuÎ
));

578  *
	gthis
;

581 
šlše
 
SŒšg
 
	$uÅ¬£
(cÚ¡ 
JsÚ
& 
j
) {

582 
SŒšgAccum
 
§
;

583 
uÅ¬£r
<
SŒšgAccum
>(
§
, 
j
);

584  
§
.
	`ke_¡ršg
();

585 
	}
}

586 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gX
>

587 
šlše
 
	gT
& 
	$uÅ¬£
(
T
& 
s
, cÚ¡ 
X
& 
x
) {

588 
uÅ¬£r
<
T
>(
s
è<< 
x
;

589  
s
;

590 
	}
}

591 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gX
>

592 
šlše
 
	gT
& 
	$uÅ¬£_wide
(
T
& 
s
, cÚ¡ 
X
& 
x
) {

593 
uÅ¬£r
<
T
>(
s
).
	`wr™e_wide
(
x
);

594  
s
;

595 
	}
}

597 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

598 
	g·r£r
&…¬£r::
İ”©Ü
>>(::
¡d
::
veùÜ
<
T
>& 
x
) {

599 
ušt32_t
 
sz
;

600 ià((
	gušt32_t
è*
	gs_
 - 
	gfÜm©
::
ffix¬¿y
 < 
fÜm©
::
nfix¬¿y
) {

601 
sz
 = *
s_
 - 
fÜm©
::
ffix¬¿y
;

602 ++
	gs_
;

603 } ià(*
	gs_
 =ğ
fÜm©
::
ç¼ay16
) {

604 
sz
 = 
»ad_š_Ãt_Üd”
<
ušt16_t
>(
s_
 + 1);

605 
	gs_
 += 3;

607 
as£¹
(*
s_
 =ğ
fÜm©
::
ç¼ay32
);

608 
	gsz
 = 
»ad_š_Ãt_Üd”
<
ušt32_t
>(
s_
 + 1);

609 
	gs_
 += 5;

611 ; 
	gsz
 != 0; --sz) {

612 
	gx
.
push_back
(
T
());

613 
·r£
(
x
.
back
());

615  *
	gthis
;

618 
šlše
 
	g¡»amšg_·r£r
::
	$¡»amšg_·r£r
()

619 : 
	$¡©e_
(
¡_nÜm®
) {

620 
	}
}

622 
šlše
 
¡»amšg_·r£r
::
	$»£t
() {

623 
¡©e_
 = 
¡_nÜm®
;

624 
¡ack_
.
	`ş—r
();

625 
	}
}

627 
šlše
 
boŞ
 
	g¡»amšg_·r£r
::
	$em±y
() const {

628  
¡©e_
 =ğ
¡_nÜm®
 && 
¡ack_
.
	`em±y
();

629 
	}
}

631 
šlše
 
boŞ
 
	g¡»amšg_·r£r
::
	$dÚe
() const {

632  
¡©e_
 < 0;

633 
	}
}

635 
šlše
 
boŞ
 
	g¡»amšg_·r£r
::
	$sucûss
() const {

636  
¡©e_
 =ğ
¡_fš®
;

637 
	}
}

639 
šlše
 
boŞ
 
	g¡»amšg_·r£r
::
	$”rÜ
() const {

640  
¡©e_
 =ğ
¡_”rÜ
;

641 
	}
}

643 
šlše
 cÚ¡ * 
	g¡»amšg_·r£r
::
	$cÚsume
(cÚ¡ * 
fœ¡
,

644 cÚ¡ * 
Ï¡
,

645 cÚ¡ 
SŒšg
& 
¡r
) {

646  
»š‹½»t_ÿ¡
<const *>

647 (
	`cÚsume
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>(
fœ¡
),

648 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>(
Ï¡
), 
¡r
));

649 
	}
}

651 
šlše
 
size_t
 
	g¡»amšg_·r£r
::
	$cÚsume
(cÚ¡ * 
fœ¡
, 
size_t
 
Ëngth
,

652 cÚ¡ 
SŒšg
& 
¡r
) {

653 cÚ¡ 
ušt8_t
* 
ufœ¡
 = 
»š‹½»t_ÿ¡
<cÚ¡ ušt8_t*>(
fœ¡
);

654  
	`cÚsume
(
ufœ¡
, ufœ¡ + 
Ëngth
, 
¡r
) - ufirst;

655 
	}
}

657 
šlše
 
	gJsÚ
& 
	g¡»amšg_·r£r
::
	$»suÉ
() {

658  
jsÚ_
;

659 
	}
}

661 
šlše
 cÚ¡ 
	gJsÚ
& 
	g¡»amšg_·r£r
::
	$»suÉ
() const {

662  
jsÚ_
;

663 
	}
}

665 
šlše
 
	g·r£r
&…¬£r::
İ”©Ü
>>(
JsÚ
& 
j
) {

666 
usšg
 
¡d
::
sw­
;

667 
¡»amšg_·r£r
 
	g¥
;

668 !
	g¥
.
dÚe
())

669 
	gs_
 = 
¥
.
cÚsume
(
s_
, s_ + 4096, 
¡r_
);

670 ià(
	g¥
.
sucûss
())

671 
sw­
(
j
, 
¥
.
»suÉ
());

672  *
	gthis
;

675 
šlše
 
JsÚ
 
	$·r£
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
) {

676 
¡»amšg_·r£r
 
¥
;

677 
fœ¡
 = 
¥
.
	`cÚsume
(fœ¡, 
Ï¡
, 
	`SŒšg
());

678 ià(
¥
.
	`sucûss
())

679  
¥
.
	`»suÉ
();

680  
	`JsÚ
();

681 
	}
}

683 
šlše
 
JsÚ
 
	$·r£
(cÚ¡ 
SŒšg
& 
¡r
) {

684 
¡»amšg_·r£r
 
¥
;

685 
¥
.
	`cÚsume
(
¡r
.
	`begš
(), sŒ.
	`’d
(), str);

686 ià(
¥
.
	`sucûss
())

687  
¥
.
	`»suÉ
();

688  
	`JsÚ
();

689 
	}
}

	@masstree-beta/msgpacktest.cc

1 
	~"msg·ck.hh
"

2 
usšg
 
Çme¥aû
 
	glcdf
;

4 ’um { 
	m¡©us_ok
, 
	m¡©us_”rÜ
, 
	m¡©us_šcom¶‘e
 };

6 
__©Œibu‹__
((
nÜ‘uº
))

7 
	$‹¡_”rÜ
(cÚ¡ * 
fe
, 
lše
,

8 cÚ¡ * 
d©a
, 
Ën
,

9 
SŒšg
 
divisiÚ
, SŒšg 
mes§ge
) {

10 
¡d
::
û¼
 << 
fe
 << ":" << 
lše
 << " ("

11 << 
	`SŒšg
(
d©a
, d©¨+ 
Ën
).
	`´šbË
() << ")"

12 << (
divisiÚ
 ? " " : "") << division << ": "

13 << 
mes§ge
 << "\n";

14 
	`ex™
(1);

15 
	}
}

17 
	$Ú‘e¡
(cÚ¡ * 
fe
, 
lše
,

18 cÚ¡ * 
d©a
, 
Ën
,

19 
SŒšg
 
divisiÚ
, cÚ¡ * 
ke
, 
ex³ùed_ke
,

20 cÚ¡ * 
uÅ¬£
, 
¡©us
,

21 
msg·ck
::
¡»amšg_·r£r
& 
a
) {

22 ià(
ex³ùed_ke
 >ğ0 && 
ke
 !ğ
d©a
 +ƒxpected_take)

23 
	`‹¡_”rÜ
(
fe
, 
lše
, 
d©a
, 
Ën
, 
divisiÚ
, "acû±ook " + 
	`SŒšg
(
ke
 - d©aè+ " ch¬s,ƒx³ùed " + SŒšg(
ex³ùed_ke
));

25 ià(
¡©us
 =ğ
¡©us_ok
 && !
a
.
	`sucûss
())

26 
	`‹¡_”rÜ
(
fe
, 
lše
, 
d©a
, 
Ën
, 
divisiÚ
, "accept‚ot done");

27 ià(
¡©us
 =ğ
¡©us_”rÜ
 && !
a
.
	`”rÜ
())

28 
	`‹¡_”rÜ
(
fe
, 
lše
, 
d©a
, 
Ën
, 
divisiÚ
, "accept‚otƒrror");

29 ià(
¡©us
 =ğ
¡©us_šcom¶‘e
 && 
a
.
	`dÚe
())

30 
	`‹¡_”rÜ
(
fe
, 
lše
, 
d©a
, 
Ën
, 
divisiÚ
, "accept‚ot incomplete");

32 ià(
uÅ¬£
 && 
a
.
	`»suÉ
().
	`uÅ¬£
() != unparse)

33 
	`‹¡_”rÜ
(
fe
, 
lše
, 
d©a
, 
Ën
, 
divisiÚ
, "»suÉ wa " + 
a
.
	`»suÉ
().
	`uÅ¬£
(è+ "\n\‹x³ùed " + 
	`SŒšg
(
uÅ¬£
));

34 
	}
}

36 
	$‹¡
(cÚ¡ * 
fe
, 
lše
,

37 cÚ¡ * 
d©a
, 
Ën
, 
ex³ùed_ke
,

38 cÚ¡ * 
uÅ¬£
, 
¡©us
 = 
¡©us_ok
) {

39 
	`as£¹
(
ex³ùed_ke
 <ğ
Ën
);

41 
msg·ck
::
¡»amšg_·r£r
 
a
;

42 cÚ¡ * 
ke
;

43 
ke
 = 
a
.
	`cÚsume
(
d©a
, d©¨+ 
Ën
);

44 
	`Ú‘e¡
(
fe
, 
lše
, 
d©a
, 
Ën
, "", 
ke
, 
ex³ùed_ke
, 
uÅ¬£
, 
¡©us
, 
a
);

46 ià(
Ën
 > 1) {

47 
a
.
	`»£t
();

48 
ke
 = 
d©a
;

49 
ke
 !ğ
d©a
 + 
Ën
) {

50 cÚ¡ * 
x
 = 
a
.
	`cÚsume
(
ke
,ake + 1);

51 ià(
x
 !ğ
ke
 + (k< 
d©a
 + 
ex³ùed_ke
))

52 
	`‹¡_”rÜ
(
fe
, 
lše
, 
d©a
, 
Ën
, "by 1s", "acû±ook unusu®‡mouÁ‡á” " + 
	`SŒšg
(
x
 - data));

53 ++
ke
;

55 
	`Ú‘e¡
(
fe
, 
lše
, 
d©a
, 
Ën
, "by 1s", 
ke
, -1, 
uÅ¬£
, 
¡©us
, 
a
);

57 
	}
}

59 
	#TEST
(...è
	`‹¡
(
__FILE__
, 
__LINE__
, ## 
__VA_ARGS__
)

	)

61 
	$check_cÜ»ùÃss
() {

62 
	`TEST
("\0", 1, 1, "0");

63 
	`TEST
("\xFF ", 3, 1, "-1");

64 
	`TEST
("\xC0 ", 3, 1, "null");

65 
	`TEST
("\xC2 ", 3, 1, "false");

66 
	`TEST
("\xC3 ", 3, 1, "true");

67 
	`TEST
("\xD0\xEE", 2, 2, "-18");

68 
	`TEST
("\x81\xA7" "compact\xC3", 11, 10, "{\"compact\":true}");

69 
	`TEST
("\x81\x00\x81\xA7" "compact\xC3", 13, 12, "{\"0\":{\"compact\":true}}");

70 
	`TEST
("\x82\x00\x81\xA7" "compact\xC3\xA1" "a\xC2", 16, 15, "{\"0\":{\"compact\":true},\"a\":false}");

71 
	`TEST
("\x93\x00\x01\x02", 5, 4, "[0,1,2]");

72 
	`TEST
("\x90 ", 5, 1, "[]");

73 
	`TEST
("\xDC\x00\x00 ", 5, 3, "[]");

74 
	`TEST
("\224\002\322\000\001\242\321\262p|00356|1000000000\245?!?#*\225\001\322\000\001\242\322\242t|\242t}\332\000Rt|<user_id:5>|<time:10>|<poster_id:5> s|<user_id>|<poster_id>…|<poster_id>|<time>",

75 130, 32, "[2,107217,\"p|00356|1000000000\",\"?!?#*\"]", 
¡©us_ok
);

76 
	`TEST
("\xCF\x80\0\0\0\0\0\0\0", 9, 9, "9223372036854775808");

79 
msg·ck
::
¡»amšg_·r£r
 
a
;

80 
JsÚ
 
j
 = JsÚ::
	`¬¿y
(0, 0, 0);

81 
	`sw­
(
j
, 
a
.
	`»suÉ
());

82 
a
.
	`»£t
();

83 
a
.
	`cÚsume
("\x91\xC2", 2);

84 
	`as£¹
(
a
.
	`sucûss
(è&&‡.
	`»suÉ
().
	`uÅ¬£
() == "[false]");

85 
a
.
	`»£t
();

86 
a
.
	`cÚsume
("\xC0", 1);

87 
	`as£¹
(
a
.
	`sucûss
(è&&‡.
	`»suÉ
().
	`uÅ¬£
() == "null");

88 
a
.
	`»£t
();

89 
a
.
	`cÚsume
("\x82\xA7" "compact\xC3\x00\x00", 12);

90 
	`as£¹
(
a
.
	`sucûss
(è&&‡.
	`»suÉ
().
	`uÅ¬£
() == "{\"compact\":true,\"0\":0}");

91 
a
.
	`»£t
();

92 
a
.
	`cÚsume
("\x82\xA7" "compact\xC3\x00\x00", 12);

93 
	`as£¹
(
a
.
	`sucûss
(è&&‡.
	`»suÉ
().
	`uÅ¬£
() == "{\"compact\":true,\"0\":0}");

97 
SŒšgAccum
 
§
;

98 
msg·ck
::
uÅ¬£r
<
SŒšgAccum
> 
	`up
(
§
);

99 
up
.
	`ş—r
();

100 
up
 << -32;

101 
	`as£¹
(
§
.
	`ke_¡ršg
() == "\xE0");

102 
up
.
	`ş—r
();

103 
up
 << -33;

104 
	`as£¹
(
§
.
	`ke_¡ršg
() == "\xD0\xDF");

105 
up
.
	`ş—r
();

106 
up
 << 127;

107 
	`as£¹
(
§
.
	`ke_¡ršg
() == "\x7F");

108 
up
.
	`ş—r
();

109 
up
 << 128;

110 
	`as£¹
(
§
.
	`ke_¡ršg
(è=ğ
	`SŒšg
("\xD1\x00\x80", 3));

111 
up
 << -32768;

112 
	`as£¹
(
§
.
	`ke_¡ršg
(è=ğ
	`SŒšg
("\xD1\x80\x00", 3));

113 
up
 << -32769;

114 
	`as£¹
(
§
.
	`ke_¡ršg
(è=ğ
	`SŒšg
("\xD2\xFF\xFF\x7F\xFF", 5));

118 
SŒšgAccum
 
§
;

119 
msg·ck
::
uÅ¬£r
<
SŒšgAccum
> 
	`up
(
§
);

120 
up
.
	`ş—r
();

121 
up
 << 
msg·ck
::
	`¬¿y
(2è<< 
	`JsÚ
((
ušt64_t
) 1 << 63)

122 << 
	`JsÚ
((
št64_t
) 1 << 63);

123 
SŒšg
 
»suÉ
 = 
§
.
	`ke_¡ršg
();

124 
	`TEST
(
»suÉ
.
	`c_¡r
(),„esuÉ.
	`Ëngth
(),„esult.length(),

128 
¡d
::
cout
 << "Allests…ass!\n";

129 
	}
}

131 
JsÚ
 
__©Œibu‹__
((
nošlše
)è
	$·r£_jsÚ
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
) {

132  
JsÚ
::
	`·r£
(
fœ¡
, 
Ï¡
);

133 
	}
}

135 
JsÚ
 
__©Œibu‹__
((
nošlše
)è
	$·r£_jsÚ
(cÚ¡ 
SŒšg
& 
¡r
) {

136  
JsÚ
::
	`·r£
(
¡r
);

137 
	}
}

139 cÚ¡ 
	g§m¶e_jsÚ
[] = "{\"name\": \"Deborah Estrin\", \"email\": \"estrin@usc.edu\", \"affiliation\": \"University of Southern California\", \"roles\": [\"pc\"]}";

141 cÚ¡ 
	g§m¶e_msg·ck
[] = "\204\244name\256Deborah Estrin\245email\256estrin@usc.edu\253affiliation\331!University of Southern California\245roles\221\242pc";

143 
	g·r£_jsÚ_loİ_size
 = 10000000;

145 
	$·r£_jsÚ_loİ_1
() {

146 
tÙ®_size
 = 0;

147 cÚ¡ * 
§m¶e_jsÚ_’d
 = 
§m¶e_jsÚ
 + 
	`¡¾’
(sample_json);

148 
i
 = 0; i !ğ
·r£_jsÚ_loİ_size
; ++i) {

149 
JsÚ
 
j
 = JsÚ::
	`·r£
(
§m¶e_jsÚ
, 
§m¶e_jsÚ_’d
);

150 
tÙ®_size
 +ğ
j
.
	`size
();

152 
	`as£¹
(
tÙ®_size
 =ğ4 * 
·r£_jsÚ_loİ_size
);

153 
	}
}

155 
	$·r£_jsÚ_loİ_2
() {

156 
tÙ®_size
 = 0;

157 cÚ¡ * 
§m¶e_jsÚ_’d
 = 
§m¶e_jsÚ
 + 
	`¡¾’
(sample_json);

158 
i
 = 0; i !ğ
·r£_jsÚ_loİ_size
; ++i) {

159 
JsÚ
 
j
 = JsÚ::
	`·r£
(
	`SŒšg
(
§m¶e_jsÚ
, 
§m¶e_jsÚ_’d
));

160 
tÙ®_size
 +ğ
j
.
	`size
();

162 
	`as£¹
(
tÙ®_size
 =ğ4 * 
·r£_jsÚ_loİ_size
);

163 
	}
}

165 
	$·r£_jsÚ_loİ_3
() {

166 
tÙ®_size
 = 0;

167 
SŒšg
 
	`§m¶e_jsÚ_¡r
(
§m¶e_jsÚ
);

168 
i
 = 0; i !ğ
·r£_jsÚ_loİ_size
; ++i) {

169 
JsÚ
 
j
 = JsÚ::
	`·r£
(
§m¶e_jsÚ_¡r
);

170 
tÙ®_size
 +ğ
j
.
	`size
();

172 
	`as£¹
(
tÙ®_size
 =ğ4 * 
·r£_jsÚ_loİ_size
);

173 
	}
}

175 
	$·r£_msg·ck_loİ_1
() {

176 
tÙ®_size
 = 0;

177 cÚ¡ * 
§m¶e_msg·ck_’d
 = 
§m¶e_msg·ck
 + 
	`¡¾’
(sample_msgpack);

178 
i
 = 0; i !ğ
·r£_jsÚ_loİ_size
; ++i) {

179 
JsÚ
 
j
 = 
msg·ck
::
	`·r£
(
§m¶e_msg·ck
, 
§m¶e_msg·ck_’d
);

180 
tÙ®_size
 +ğ
j
.
	`size
();

182 
	`as£¹
(
tÙ®_size
 =ğ4 * 
·r£_jsÚ_loİ_size
);

183 
	}
}

185 
	$·r£_msg·ck_loİ_2
() {

186 
tÙ®_size
 = 0;

187 cÚ¡ * 
§m¶e_msg·ck_’d
 = 
§m¶e_msg·ck
 + 
	`¡¾’
(sample_msgpack);

188 
i
 = 0; i !ğ
·r£_jsÚ_loİ_size
; ++i) {

189 
JsÚ
 
j
 = 
msg·ck
::
	`·r£
(
	`SŒšg
(
§m¶e_msg·ck
, 
§m¶e_msg·ck_’d
));

190 
tÙ®_size
 +ğ
j
.
	`size
();

192 
	`as£¹
(
tÙ®_size
 =ğ4 * 
·r£_jsÚ_loİ_size
);

193 
	}
}

195 
	$·r£_msg·ck_loİ_3
() {

196 
tÙ®_size
 = 0;

197 
SŒšg
 
	`§m¶e_msg·ck_¡r
(
§m¶e_msg·ck
);

198 
i
 = 0; i !ğ
·r£_jsÚ_loİ_size
; ++i) {

199 
JsÚ
 
j
 = 
msg·ck
::
	`·r£
(
§m¶e_msg·ck_¡r
);

200 
tÙ®_size
 +ğ
j
.
	`size
();

202 
	`as£¹
(
tÙ®_size
 =ğ4 * 
·r£_jsÚ_loİ_size
);

203 
	}
}

205 
	$maš
(
¬gc
, ** 
¬gv
) {

206 (è
¬gc
, (è
¬gv
;

208 
	`check_cÜ»ùÃss
();

209 
	}
}

	@masstree-beta/mtclient.cc

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

19 
	~<¡d¬g.h
>

20 
	~<uni¡d.h
>

21 
	~<lim™s.h
>

22 
	~<sys/sock‘.h
>

23 
	~<Ãtš‘/š.h
>

24 
	~<Ãtš‘/tı.h
>

25 
	~<sys/£Ëù.h
>

26 
	~<sys/wa™.h
>

27 
	~<as£¹.h
>

28 
	~<¡ršg.h
>

29 
	~<±h»ad.h
>

30 
	~<ùy³.h
>

31 
	~<sys/ty³s.h
>

32 
	~<sys/time.h
>

33 
	~<sys/£Ëù.h
>

34 
	~<¬·/š‘.h
>

35 
	~<m©h.h
>

36 
	~<fú.h
>

37 
	~"kv¡©s.hh
"

38 
	~"kvio.hh
"

39 
	~"jsÚ.hh
"

40 
	~"kv‹¡.hh
"

41 
	~"mtş›Á.hh
"

42 
	~"kv¿ndom.hh
"

43 
	~"şp.h
"

45 cÚ¡ *
	g£rv”
 = "127.0.0.1";

47 (*
	tg‘_async_cb
)(
	tchd
 *
	tc
, 
	tasync
 *
	ta
,

48 
	tboŞ
 
	thas_v®
, cÚ¡ 
	tSŒ
 &
	tv®
);

49 (*
	tput_async_cb
)(
	tchd
 *
	tc
, 
	tasync
 *
	ta
,

50 
	t¡©us
);

51 (*
	t»move_async_cb
)(
	tchd
 *
	tc
, 
	tasync
 *
	ta
,

52 
	t¡©us
);

54 
	sasync
 {

55 
cmd
;

56 
£q
;

58 
g‘_async_cb
 
g‘_â
;

59 
put_async_cb
 
put_â
;

60 
»move_async_cb
 
»move_â
;

62 
key
[16];

63 
wª‹d
[16];

64 
wª‹dËn
;

65 
acked
;

67 
	#MAXWINDOW
 512

	)

68 
wšdow
 = 
MAXWINDOW
;

70 
	schd
 {

71 
s
;

72 
udp
;

73 
KVCÚn
 *
cÚn
;

75 
async
 
a
[
MAXWINDOW
];

77 
£q0_
;

78 
£q1_
;

79 
n£Á_
;

80 
chdno
;

82 
šlše
 
	`check_æush
();

85 
	`checkasync
(
chd
 *
c
, 
fÜû
);

87 
šlše
 
chd
::
	$check_æush
() {

88 ià((
£q1_
 & ((
wšdow
 - 1) >> 1)) == 0)

89 
cÚn
->
	`æush
();

90 
£q1_
 - 
£q0_
 >ğ
wšdow
)

91 
	`checkasync
(
this
, 1);

92 
	}
}

94 
ag‘
(
chd
 *, cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
wª‹d
, 
g‘_async_cb
 
â
);

95 
ag‘
(
chd
 *
c
, 
ikey
, 
iwª‹d
, 
g‘_async_cb
 
â
);

96 
ag‘_cŞ
(
chd
 *
c
, cÚ¡ 
SŒ
& 
key
, 
cŞ
, cÚ¡ SŒ& 
wª‹d
,

97 
g‘_async_cb
 
â
);

98 
g‘
(
chd
 *
c
, cÚ¡ 
SŒ
 &
key
, *
v®
, 
max
);

100 
asyncg‘cb
(
chd
 *, 
async
 *
a
, 
boŞ
, cÚ¡ 
SŒ
 &
v®
);

101 
asyncg‘cb_št
(
chd
 *, 
async
 *
a
, 
boŞ
, cÚ¡ 
SŒ
 &
v®
);

103 
­ut
(
chd
 *
c
, cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
v®
,

104 
put_async_cb
 
â
 = 0, cÚ¡ 
SŒ
 &
wª‹d
 = Str());

105 
­ut_cŞ
(
chd
 *
c
, cÚ¡ 
SŒ
 &
key
, 
cŞ
, cÚ¡ SŒ &
v®
,

106 
put_async_cb
 
â
 = 0, cÚ¡ 
SŒ
 &
wª‹d
 = Str());

107 
put
(
chd
 *
c
, cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
v®
);

108 
asynıutcb
(
chd
 *, 
async
 *
a
, 
¡©us
);

110 
¬emove
(
chd
 *
c
, cÚ¡ 
SŒ
 &
key
, 
»move_async_cb
 
â
);

111 
boŞ
 
»move
(
chd
 *
c
, cÚ¡ 
SŒ
 &
key
);

113 
udp1
(
chd
 *);

114 
w1b
(
chd
 *);

115 
u1
(
chd
 *);

116 
ov”1
(
chd
 *);

117 
ov”2
(
chd
 *);

118 
»c1
(
chd
 *);

119 
»c2
(
chd
 *);

120 
ıa
(
chd
 *);

121 
ıb
(
chd
 *);

122 
ıc
(
chd
 *);

123 
ıd
(
chd
 *);

124 
vŞt1a
(
chd
 *);

125 
vŞt1b
(
chd
 *);

126 
vŞt2a
(
chd
 *);

127 
vŞt2b
(
chd
 *);

128 
sÿÁe¡
(
chd
 *);

130 
	gchd»n
 = 1;

131 
ušt64_t
 
	gnkeys
 = 0;

132 
	g´efixL’
 = 0;

133 
	gkeyËn
 = 0;

134 
ušt64_t
 
	glim™
 = ~uint64_t(0);

135 
	gdu¿tiÚ
 = 10;

136 
	gdu¿tiÚ2
 = 0;

137 
	gudpæag
 = 0;

138 
	gqu›t
 = 0;

139 
	gfœ¡_£rv”_pÜt
 = 2117;

141 
boŞ
 
	gsh¬e_£rv”_pÜt
 = 
çl£
;

142 vŞ©
boŞ
 
	gtimeout
[2] = {
çl£
, false};

143 
	gfœ¡_loÿl_pÜt
 = 0;

144 cÚ¡ *
	gšput
 = 
NULL
;

145 
	grsš™_·¹
 = 0;

146 
	gkv‹¡_fœ¡_£ed
 = 0;

147 
	grsÿË_·¹sz
 = 0;

148 
	gg‘¿tio
 = -1;

149 
	gmškeyË‰”
 = '0';

150 
	gmaxkeyË‰”
 = '9';

153 
	skv‹¡_ş›Á
 {

154 
kv‹¡_ş›Á
(
chd
& 
c
)

155 : 
c_
(&
c
) {

157 
chd
* child() const {

158  
c_
;

160 
id
() const {

161  
	mc_
->
	mchdno
;

163 
Áh»ads
() const {

164  ::
chd»n
;

166 
mškeyË‰”
() const {

167  ::
mškeyË‰”
;

169 
maxkeyË‰”
() const {

170  ::
maxkeyË‰”
;

172 
»gi¡”_timeouts
(
n
) {

173 (è
	mn
;

175 
boŞ
 
timeout
(
which
) const {

176  ::
timeout
[
which
];

178 
ušt64_t
 
lim™
() const {

179  ::
lim™
;

181 
g‘¿tio
() const {

182 
as£¹
(::
g‘¿tio
 >= 0);

183  ::
g‘¿tio
;

185 
ušt64_t
 
nkeys
() const {

186  ::
nkeys
;

188 
keyËn
() const {

189  ::
keyËn
;

191 
´efixL’
() const {

192  ::
´efixL’
;

194 
now
() const {

195  ::
now
();

198 
g‘
(
ikey
, 
SŒ
 *
v®ue
) {

199 
quick_i¡r
 
key
(
ikey
);

200 
ag‘
(
c_
, 
key
.
¡ršg
(),

201 
SŒ
(
»š‹½»t_ÿ¡
<cÚ¡ *>(&
v®ue
), (value)),

202 
asyncg‘cb
);

204 
g‘
(cÚ¡ 
SŒ
 &
key
, *
iv®ue
) {

205 
ag‘
(
c_
, 
key
,

206 
SŒ
(
»š‹½»t_ÿ¡
<cÚ¡ *>(&
iv®ue
), (ivalue)),

207 
asyncg‘cb_št
);

209 
boŞ
 
g‘_sync
(
ikey
) {

210 
	mgÙ
[512];

211 
quick_i¡r
 
key
(
ikey
);

212  ::
g‘
(
c_
, 
key
.
¡ršg
(), 
gÙ
, (got)) >= 0;

214 
g‘_check
(
ikey
, 
›x³ùed
) {

215 
ag‘
(
c_
, 
ikey
, 
›x³ùed
, 0);

217 
g‘_check
(cÚ¡ *
key
, cÚ¡ *
v®
) {

218 
ag‘
(
c_
, 
SŒ
(
key
), SŒ(
v®
), 0);

220 
g‘_check
(cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
v®
) {

221 
ag‘
(
c_
, 
key
, 
v®
, 0);

223 
g‘_check_key8
(
ikey
, 
›x³ùed
) {

224 
quick_i¡r
 
key
(
ikey
, 8), 
ex³ùed
(
›x³ùed
);

225 
ag‘
(
c_
, 
key
.
¡ršg
(), 
ex³ùed
.string(), 0);

227 
g‘_check_key10
(
ikey
, 
›x³ùed
) {

228 
quick_i¡r
 
key
(
ikey
, 10), 
ex³ùed
(
›x³ùed
);

229 
ag‘
(
c_
, 
key
.
¡ršg
(), 
ex³ùed
.string(), 0);

231 
mªy_g‘_check
(, [], []) {

232 
as£¹
(0);

234 
g‘_cŞ_check
(cÚ¡ 
SŒ
 &
key
, 
cŞ
, cÚ¡ SŒ &
v®ue
) {

235 
ag‘_cŞ
(
c_
, 
key
, 
cŞ
, 
v®ue
, 0);

237 
g‘_cŞ_check
(
ikey
, 
cŞ
, 
iv®ue
) {

238 
quick_i¡r
 
key
(
ikey
), 
v®ue
(
iv®ue
);

239 
g‘_cŞ_check
(
key
.
¡ršg
(), 
cŞ
, 
v®ue
.string());

241 
g‘_cŞ_check_key10
(
ikey
, 
cŞ
, 
iv®ue
) {

242 
quick_i¡r
 
key
(
ikey
, 10), 
v®ue
(
iv®ue
);

243 
g‘_cŞ_check
(
key
.
¡ršg
(), 
cŞ
, 
v®ue
.string());

245 
g‘_check_sync
(
ikey
, 
›x³ùed
) {

246 
	mkey
[512], 
	mv®
[512], 
	mgÙ
[512];

247 
¥rštf
(
key
, "%010ld", 
ikey
);

248 
¥rštf
(
v®
, "%ld", 
›x³ùed
);

249 
mem£t
(
gÙ
, 0, (got));

250 ::
g‘
(
c_
, 
SŒ
(
key
), 
gÙ
, (got));

251 ià(
¡rcmp
(
v®
, 
gÙ
)) {

252 
årštf
(
¡d”r
, "key %s,ƒx³ùed %s, gÙ %s\n", 
key
, 
v®
, 
gÙ
);

253 
®ways_as£¹
(0);

257 
put
(cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
v®ue
) {

258 
­ut
(
c_
, 
key
, 
v®ue
);

260 
put
(cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
v®ue
, *
¡©us
) {

261 
­ut
(
c_
, 
key
, 
v®ue
,

262 
asynıutcb
,

263 
SŒ
(
»š‹½»t_ÿ¡
<cÚ¡ *>(&
¡©us
), (status)));

265 
put
(cÚ¡ *
key
, cÚ¡ *
v®ue
) {

266 
­ut
(
c_
, 
SŒ
(
key
), SŒ(
v®ue
));

268 
put
(cÚ¡ 
SŒ
 &
key
, 
iv®ue
) {

269 
quick_i¡r
 
v®ue
(
iv®ue
);

270 
­ut
(
c_
, 
key
, 
v®ue
.
¡ršg
());

272 
put
(
ikey
, 
iv®ue
) {

273 
quick_i¡r
 
key
(
ikey
), 
v®ue
(
iv®ue
);

274 
­ut
(
c_
, 
key
.
¡ršg
(), 
v®ue
.string());

276 
put_key8
(
ikey
, 
iv®ue
) {

277 
quick_i¡r
 
key
(
ikey
, 8), 
v®ue
(
iv®ue
);

278 
­ut
(
c_
, 
key
.
¡ršg
(), 
v®ue
.string());

280 
put_key10
(
ikey
, 
iv®ue
) {

281 
quick_i¡r
 
key
(
ikey
, 10), 
v®ue
(
iv®ue
);

282 
­ut
(
c_
, 
key
.
¡ršg
(), 
v®ue
.string());

284 
put_cŞ
(cÚ¡ 
SŒ
 &
key
, 
cŞ
, cÚ¡ SŒ &
v®ue
) {

285 
­ut_cŞ
(
c_
, 
key
, 
cŞ
, 
v®ue
);

287 
put_cŞ
(
ikey
, 
cŞ
, 
iv®ue
) {

288 
quick_i¡r
 
key
(
ikey
), 
v®ue
(
iv®ue
);

289 
put_cŞ
(
key
.
¡ršg
(), 
cŞ
, 
v®ue
.string());

291 
put_cŞ_key10
(
ikey
, 
cŞ
, 
iv®ue
) {

292 
quick_i¡r
 
key
(
ikey
, 10), 
v®ue
(
iv®ue
);

293 
put_cŞ
(
key
.
¡ršg
(), 
cŞ
, 
v®ue
.string());

295 
put_sync
(
ikey
, 
iv®ue
) {

296 
quick_i¡r
 
key
(
ikey
, 10), 
v®ue
(
iv®ue
);

297 ::
put
(
c_
, 
key
.
¡ršg
(), 
v®ue
.string());

300 
»move
(cÚ¡ 
SŒ
 &
key
) {

301 
¬emove
(
c_
, 
key
, 0);

303 
»move
(
ikey
) {

304 
quick_i¡r
 
key
(
ikey
);

305 
»move
(
key
.
¡ršg
());

307 
boŞ
 
»move_sync
(
ikey
) {

308 
quick_i¡r
 
key
(
ikey
);

309  ::
»move
(
c_
, 
key
.
¡ršg
());

312 
rusÿË_·¹sz
() const {

313  ::
rsÿË_·¹sz
;

315 
rusÿË_š™_·¹_no
() const {

316  ::
rsš™_·¹
;

318 
n£qkeys
() const {

319  16 * ::
rsÿË_·¹sz
;

321 
wa™_®l
() {

322 
checkasync
(
c_
, 2);

324 
puts_dÚe
() {

326 
rcu_qu›sû
() {

328 
nÙiû
(
SŒšg
 
s
) {

329 ià(!
	mqu›t
) {

330 ià(!
	ms
.
em±y
(è&& s.
back
() == '\n')

331 
s
 = s.
sub¡r
(0, -1);

332 ià(
	ms
.
em±y
(è|| 
is¥aû
((è
s
[0]))

333 
årštf
(
¡d”r
, "%d%.*s\n", 
c_
->
chdno
, 
s
.
Ëngth
(), s.
d©a
());

335 
årštf
(
¡d”r
, "%d %.*s\n", 
c_
->
chdno
, 
s
.
Ëngth
(), s.
d©a
());

338 
nÙiû
(cÚ¡ *
fmt
, ...) {

339 ià(!
	mqu›t
) {

340 
va_li¡
 
	mv®
;

341 
va_¡¬t
(
v®
, 
fmt
);

342 
SŒšg
 
	mx
;

343 ià(!*
	mfmt
 || 
is¥aû
((è*
fmt
))

344 
	mx
 = 
SŒšg
(
c_
->
chdno
è+ 
fmt
;

346 
	mx
 = 
SŒšg
(
c_
->
chdno
è+ SŒšg(" "è+ 
fmt
;

347 
vårštf
(
¡d”r
, 
x
.
c_¡r
(), 
v®
);

348 
va_’d
(
v®
);

351 cÚ¡ 
	mJsÚ
& 
»pÜt
(cÚ¡ 
JsÚ
& 
x
) {

352  
	m»pÜt_
.
m”ge
(
x
);

354 
fšish
() {

355 ià(!
	mqu›t
) {

356 
	mlcdf
::
SŒšgAccum
 
§
;

357 
	mdv
;

358 ià(
	m»pÜt_
.
couÁ
("puts"))

359 
	m§
 << "Ù® " << 
	m»pÜt_
.
g‘
("puts");

360 ià(
	m»pÜt_
.
g‘
("puts_³r_£c", 
dv
))

361 
	m§
.
¢´štf
(100, " %.0àput/s", 
dv
);

362 ià(
	m»pÜt_
.
g‘
("g‘s_³r_£c", 
dv
))

363 
	m§
.
¢´štf
(100, " %.0àg‘/s", 
dv
);

364 ià(!
	m§
.
em±y
())

365 
nÙiû
(
§
.
ke_¡ršg
());

367 
´štf
("%s\n", 
»pÜt_
.
uÅ¬£
().
c_¡r
());

369 
kv¿ndom_¿ndom
 
	m¿nd
;

370 
chd
 *
	mc_
;

371 
JsÚ
 
	m»pÜt_
;

375 
	#TESTRUNNER_CLIENT_TYPE
 
kv‹¡_ş›Á
&

	)

376 
	~"‹¡ruÂ”.hh
"

378 
MAKE_TESTRUNNER
(
rw1
, 
kv‹¡_rw1
(
ş›Á
));

379 
MAKE_TESTRUNNER
(
rw2
, 
kv‹¡_rw2
(
ş›Á
));

380 
MAKE_TESTRUNNER
(
rw3
, 
kv‹¡_rw3
(
ş›Á
));

381 
MAKE_TESTRUNNER
(
rw4
, 
kv‹¡_rw4
(
ş›Á
));

382 
MAKE_TESTRUNNER
(
rw1fixed
, 
kv‹¡_rw1fixed
(
ş›Á
));

383 
MAKE_TESTRUNNER
(
rw16
, 
kv‹¡_rw16
(
ş›Á
));

384 
MAKE_TESTRUNNER
(
sync_rw1
, 
kv‹¡_sync_rw1
(
ş›Á
));

385 
MAKE_TESTRUNNER
(
r1
, 
kv‹¡_r1_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
id
()));

386 
MAKE_TESTRUNNER
(
w1
, 
kv‹¡_w1_£ed
(
ş›Á
, 
kv‹¡_fœ¡_£ed
 + cl›Á.
id
()));

387 
MAKE_TESTRUNNER
(
w1b
, w1b(
ş›Á
.
chd
()));

388 
MAKE_TESTRUNNER
(
u1
, u1(
ş›Á
.
chd
()));

389 
MAKE_TESTRUNNER
(
wd1
, 
kv‹¡_wd1
(10000000, 1, 
ş›Á
));

390 
MAKE_TESTRUNNER
(
wd1m1
, 
kv‹¡_wd1
(100000000, 1, 
ş›Á
));

391 
MAKE_TESTRUNNER
(
wd1m2
, 
kv‹¡_wd1
(1000000000, 4, 
ş›Á
));

392 
MAKE_TESTRUNNER
(
wd1check
, 
kv‹¡_wd1_check
(10000000, 1, 
ş›Á
));

393 
MAKE_TESTRUNNER
(
wd1m1check
, 
kv‹¡_wd1_check
(100000000, 1, 
ş›Á
));

394 
MAKE_TESTRUNNER
(
wd1m2check
, 
kv‹¡_wd1_check
(1000000000, 4, 
ş›Á
));

395 
MAKE_TESTRUNNER
(
wd2
, 
kv‹¡_wd2
(
ş›Á
));

396 
MAKE_TESTRUNNER
(
wd2check
, 
kv‹¡_wd2_check
(
ş›Á
));

397 
MAKE_TESTRUNNER
(
Œi1
, 
kv‹¡_Œi1
(10000000, 1, 
ş›Á
));

398 
MAKE_TESTRUNNER
(
Œi1check
, 
kv‹¡_Œi1_check
(10000000, 1, 
ş›Á
));

399 
MAKE_TESTRUNNER
(
§me
, 
kv‹¡_§me
(
ş›Á
));

400 
MAKE_TESTRUNNER
(
wcŞ1
, 
kv‹¡_wcŞ1©
(
ş›Á
, cl›Á.
id
(è% 24, 
kv‹¡_fœ¡_£ed
 + client.id() % 48, 5000000));

401 
MAKE_TESTRUNNER
(
rcŞ1
, 
kv‹¡_rcŞ1©
(
ş›Á
, cl›Á.
id
(è% 24, 
kv‹¡_fœ¡_£ed
 + client.id() % 48, 5000000));

402 
MAKE_TESTRUNNER
(
wcŞ1o1
, 
kv‹¡_wcŞ1©
(
ş›Á
, (ş›Á.
id
(è+ 1è% 24, 
kv‹¡_fœ¡_£ed
 + client.id() % 48, 5000000));

403 
MAKE_TESTRUNNER
(
rcŞ1o1
, 
kv‹¡_rcŞ1©
(
ş›Á
, (ş›Á.
id
(è+ 1è% 24, 
kv‹¡_fœ¡_£ed
 + client.id() % 48, 5000000));

404 
MAKE_TESTRUNNER
(
wcŞ1o2
, 
kv‹¡_wcŞ1©
(
ş›Á
, (ş›Á.
id
(è+ 2è% 24, 
kv‹¡_fœ¡_£ed
 + client.id() % 48, 5000000));

405 
MAKE_TESTRUNNER
(
rcŞ1o2
, 
kv‹¡_rcŞ1©
(
ş›Á
, (ş›Á.
id
(è+ 2è% 24, 
kv‹¡_fœ¡_£ed
 + client.id() % 48, 5000000));

406 
MAKE_TESTRUNNER
(
ov”1
, ov”1(
ş›Á
.
chd
()));

407 
MAKE_TESTRUNNER
(
ov”2
, ov”2(
ş›Á
.
chd
()));

408 
MAKE_TESTRUNNER
(
»c1
,„ec1(
ş›Á
.
chd
()));

409 
MAKE_TESTRUNNER
(
»c2
,„ec2(
ş›Á
.
chd
()));

410 
MAKE_TESTRUNNER
(
ıa
, c·(
ş›Á
.
chd
()));

411 
MAKE_TESTRUNNER
(
ıb
, cpb(
ş›Á
.
chd
()));

412 
MAKE_TESTRUNNER
(
ıc
, cpc(
ş›Á
.
chd
()));

413 
MAKE_TESTRUNNER
(
ıd
, cpd(
ş›Á
.
chd
()));

414 
MAKE_TESTRUNNER
(
vŞt1a
, vŞt1a(
ş›Á
.
chd
()));

415 
MAKE_TESTRUNNER
(
vŞt1b
, vŞt1b(
ş›Á
.
chd
()));

416 
MAKE_TESTRUNNER
(
vŞt2a
, vŞt2a(
ş›Á
.
chd
()));

417 
MAKE_TESTRUNNER
(
vŞt2b
, vŞt2b(
ş›Á
.
chd
()));

418 
MAKE_TESTRUNNER
(
sÿÁe¡
, sÿÁe¡(
ş›Á
.
chd
()));

419 
MAKE_TESTRUNNER
(
wsÿË
, 
kv‹¡_wsÿË
(
ş›Á
));

420 
MAKE_TESTRUNNER
(
rusÿË_š™
, 
kv‹¡_rusÿË_š™
(
ş›Á
));

421 
MAKE_TESTRUNNER
(
rsÿË
, 
kv‹¡_rsÿË
(
ş›Á
));

422 
MAKE_TESTRUNNER
(
usÿË
, 
kv‹¡_usÿË
(
ş›Á
));

423 
MAKE_TESTRUNNER
(
lÚg_š™
, 
kv‹¡_lÚg_š™
(
ş›Á
));

424 
MAKE_TESTRUNNER
(
lÚg_go
, 
kv‹¡_lÚg_go
(
ş›Á
));

425 
MAKE_TESTRUNNER
(
udp1
, 
kv‹¡_udp1
(
ş›Á
));

427 
run_chd
(
‹¡ruÂ”
*, 
chdno
);

431 
	$u§ge
()

433 
	`årštf
(
¡d”r
, "Usage: mtclient [-s serverip] [-w window] [--udp] "\

436 
‹¡ruÂ”
::
	`´št_Çmes
(
¡d”r
, 5);

437 
	`ex™
(1);

438 
	}
}

441 
	$£‰imeout
()

443 ià(!
timeout
[0]) {

444 
timeout
[0] = 
Œue
;

445 ià(
du¿tiÚ2
)

446 
	`®¬m
((è
	`û
(
du¿tiÚ2
));

448 
timeout
[1] = 
Œue
;

449 
	}
}

451 ’um { 
	mşp_v®_suffixdoubË
 = 
CÍ_V®Fœ¡U£r
 };

452 ’um { 
	mİt_th»ads
 = 1, 
	mİt_th»ads_d•»ÿ‹d
, 
	mİt_du¿tiÚ
, 
	mİt_du¿tiÚ2
,

453 
	mİt_wšdow
, 
	mİt_£rv”
, 
	mİt_fœ¡_£rv”_pÜt
, 
	mİt_qu›t
, 
	mİt_udp
,

454 
	mİt_fœ¡_loÿl_pÜt
, 
	mİt_sh¬e_£rv”_pÜt
, 
	mİt_šput
,

455 
	mİt_rsš™_·¹
, 
	mİt_fœ¡_£ed
, 
	mİt_rsÿË_·¹sz
, 
	mİt_keyËn
,

456 
	mİt_lim™
, 
	mİt_´efix_Ën
, 
	mİt_nkeys
, 
	mİt_g‘_¿tio
, 
	mİt_mškeyË‰”
,

457 
	mİt_maxkeyË‰”
, 
	mİt_nofÜk
 };

458 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

459 { "th»ads", 'j', 
İt_th»ads
, 
CÍ_V®IÁ
, 0 },

460 { 0, 'n', 
İt_th»ads_d•»ÿ‹d
, 
CÍ_V®IÁ
, 0 },

461 { "du¿tiÚ", 'd', 
İt_du¿tiÚ
, 
CÍ_V®DoubË
, 0 },

462 { "du¿tiÚ2", 0, 
İt_du¿tiÚ2
, 
CÍ_V®DoubË
, 0 },

463 { "d2", 0, 
İt_du¿tiÚ2
, 
CÍ_V®DoubË
, 0 },

464 { "wšdow", 'w', 
İt_wšdow
, 
CÍ_V®UnsigÃd
, 0 },

465 { "£rv”-", 's', 
İt_£rv”
, 
CÍ_V®SŒšg
, 0 },

466 { "fœ¡-£rv”-pÜt", 0, 
İt_fœ¡_£rv”_pÜt
, 
CÍ_V®IÁ
, 0 },

467 { "f¥", 0, 
İt_fœ¡_£rv”_pÜt
, 
CÍ_V®IÁ
, 0 },

468 { "qu›t", 'q', 
İt_qu›t
, 0, 
CÍ_Neg©e
 },

469 { "udp", 'u', 
İt_udp
, 0, 
CÍ_Neg©e
 },

470 { "fœ¡-loÿl-pÜt", 0, 
İt_fœ¡_loÿl_pÜt
, 
CÍ_V®IÁ
, 0 },

471 { "æp", 0, 
İt_fœ¡_loÿl_pÜt
, 
CÍ_V®IÁ
, 0 },

472 { "sh¬e-£rv”-pÜt", 0, 
İt_sh¬e_£rv”_pÜt
, 0, 
CÍ_Neg©e
 },

473 { "s¥", 0, 
İt_sh¬e_£rv”_pÜt
, 0, 
CÍ_Neg©e
 },

474 { "šput", 'i', 
İt_šput
, 
CÍ_V®SŒšg
, 0 },

475 { "rsš™_·¹", 0, 
İt_rsš™_·¹
, 
CÍ_V®IÁ
, 0 },

476 { "fœ¡_£ed", 0, 
İt_fœ¡_£ed
, 
CÍ_V®IÁ
, 0 },

477 { "rsÿË_·¹sz", 0, 
İt_rsÿË_·¹sz
, 
CÍ_V®IÁ
, 0 },

478 { "keyËn", 0, 
İt_keyËn
, 
CÍ_V®IÁ
, 0 },

479 { "lim™", 'l', 
İt_lim™
, 
şp_v®_suffixdoubË
, 0 },

480 { "´efixL’", 0, 
İt_´efix_Ën
, 
CÍ_V®IÁ
, 0 },

481 { "nkeys", 0, 
İt_nkeys
, 
CÍ_V®IÁ
, 0 },

482 { "g‘¿tio", 0, 
İt_g‘_¿tio
, 
CÍ_V®IÁ
, 0 },

483 { "mškeyË‰”", 0, 
İt_mškeyË‰”
, 
CÍ_V®SŒšg
, 0 },

484 { "maxkeyË‰”", 0, 
İt_maxkeyË‰”
, 
CÍ_V®SŒšg
, 0 },

485 { "no-fÜk", 0, 
İt_nofÜk
, 0, 0 }

489 
	$maš
(
¬gc
, *
¬gv
[])

491 
i
, 
pid
, 
¡©us
;

492 
‹¡ruÂ”
* 
‹¡
 = 0;

493 
pes
[512];

494 
dofÜk
 = 1;

496 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, (è
	`¬¿ysize
(
İtiÚs
), options);

497 
	`CÍ_AddTy³
(
şp
, 
şp_v®_suffixdoubË
, 
CÍ_Di§ÎowO±iÚs
, 
şp_·r£_suffixdoubË
, 0);

498 
İt
;

499 (
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
) {

500 
İt
) {

501 
İt_th»ads
:

502 
chd»n
 = 
şp
->
v®
.
i
;

504 
İt_th»ads_d•»ÿ‹d
:

505 
	`CÍ_O±iÚE¼Ü
(
şp
, "%<%O%> is deprecated, use %<-j%>");

506 
chd»n
 = 
şp
->
v®
.
i
;

508 
İt_du¿tiÚ
:

509 
du¿tiÚ
 = 
şp
->
v®
.
d
;

511 
İt_du¿tiÚ2
:

512 
du¿tiÚ2
 = 
şp
->
v®
.
d
;

514 
İt_wšdow
:

515 
wšdow
 = 
şp
->
v®
.
u
;

516 
	`®ways_as£¹
(
wšdow
 <ğ
MAXWINDOW
);

517 
	`®ways_as£¹
((
wšdow
 & (window - 1)) == 0);

519 
İt_£rv”
:

520 
£rv”
 = 
şp
->
v¡r
;

522 
İt_fœ¡_£rv”_pÜt
:

523 
fœ¡_£rv”_pÜt
 = 
şp
->
v®
.
i
;

525 
İt_qu›t
:

526 
qu›t
 = !
şp
->
Ãg©ed
;

528 
İt_udp
:

529 
udpæag
 = !
şp
->
Ãg©ed
;

531 
İt_fœ¡_loÿl_pÜt
:

532 
fœ¡_loÿl_pÜt
 = 
şp
->
v®
.
i
;

534 
İt_sh¬e_£rv”_pÜt
:

535 
sh¬e_£rv”_pÜt
 = !
şp
->
Ãg©ed
;

537 
İt_šput
:

538 
šput
 = 
şp
->
v¡r
;

540 
İt_rsš™_·¹
:

541 
rsš™_·¹
 = 
şp
->
v®
.
i
;

543 
İt_fœ¡_£ed
:

544 
kv‹¡_fœ¡_£ed
 = 
şp
->
v®
.
i
;

546 
İt_rsÿË_·¹sz
:

547 
rsÿË_·¹sz
 = 
şp
->
v®
.
i
;

549 
İt_keyËn
:

550 
keyËn
 = 
şp
->
v®
.
i
;

552 
İt_lim™
:

553 
lim™
 = (
ušt64_t
è
şp
->
v®
.
d
;

555 
İt_´efix_Ën
:

556 
´efixL’
 = 
şp
->
v®
.
i
;

558 
İt_nkeys
:

559 
nkeys
 = 
şp
->
v®
.
i
;

561 
İt_g‘_¿tio
:

562 
g‘¿tio
 = 
şp
->
v®
.
i
;

564 
İt_mškeyË‰”
:

565 
mškeyË‰”
 = 
şp
->
v¡r
[0];

567 
İt_maxkeyË‰”
:

568 
maxkeyË‰”
 = 
şp
->
v¡r
[0];

570 
İt_nofÜk
:

571 
dofÜk
 = !
şp
->
Ãg©ed
;

573 
CÍ_NÙO±iÚ
:

574 
‹¡
 = 
‹¡ruÂ”
::
	`fšd
(
şp
->
v¡r
);

575 ià(!
‹¡
)

576 
	`u§ge
();

578 
CÍ_BadO±iÚ
:

579 
	`u§ge
();

583 if(
chd»n
 < 1 || (chd»À!ğ1 && !
dofÜk
))

584 
	`u§ge
();

585 ià(!
‹¡
)

586 
‹¡
 = 
‹¡ruÂ”
::
	`fœ¡
();

588 
	`´štf
("%s, w %d,est %s, children %d\n",

589 
udpæag
 ? "udp" : "tı", 
wšdow
,

590 
‹¡
->
	`Çme
().
	`c_¡r
(), 
chd»n
);

592 
	`fæush
(
¡dout
);

594 ià(
dofÜk
) {

595 
i
 = 0; i < 
chd»n
; i++){

596 
±mp
[2];

597 
r
 = 
	`pe
(
±mp
);

598 
	`®ways_as£¹
(
r
 == 0);

599 
pid
 = 
	`fÜk
();

600 if(
pid
 < 0){

601 
	`³¼Ü
("fork");

602 
	`ex™
(1);

604 if(
pid
 == 0){

605 
	`şo£
(
±mp
[0]);

606 
	`dup2
(
±mp
[1], 1);

607 
	`şo£
(
±mp
[1]);

608 
	`sigÇl
(
SIGALRM
, 
£‰imeout
);

609 
	`®¬m
((è
	`û
(
du¿tiÚ
));

610 
	`run_chd
(
‹¡
, 
i
);

611 
	`ex™
(0);

613 
pes
[
i
] = 
±mp
[0];

614 
	`şo£
(
±mp
[1]);

616 
i
 = 0; i < 
chd»n
; i++){

617 if(
	`wa™
(&
¡©us
) <= 0){

618 
	`³¼Ü
("wait");

619 
	`ex™
(1);

621 ià(
	`WIFSIGNALED
(
¡©us
))

622 
	`årštf
(
¡d”r
, "chd %d d›d by sigÇÈ%d\n", 
i
, 
	`WTERMSIG
(
¡©us
));

625 
±mp
[2];

626 
r
 = 
	`pe
(
±mp
);

627 
	`®ways_as£¹
(
r
 == 0);

628 
pes
[0] = 
±mp
[0];

629 
¡dout_fd
 = 
	`dup
(
STDOUT_FILENO
);

630 
	`®ways_as£¹
(
¡dout_fd
 > 0);

631 
r
 = 
	`dup2
(
±mp
[1], 
STDOUT_FILENO
);

632 
	`®ways_as£¹
(
r
 >= 0);

633 
	`şo£
(
±mp
[1]);

634 
	`sigÇl
(
SIGALRM
, 
£‰imeout
);

635 
	`®¬m
((è
	`û
(
du¿tiÚ
));

636 
	`run_chd
(
‹¡
, 0);

637 
	`fæush
(
¡dout
);

638 
r
 = 
	`dup2
(
¡dout_fd
, 
STDOUT_FILENO
);

639 
	`®ways_as£¹
(
r
 >= 0);

640 
	`şo£
(
¡dout_fd
);

643 
tÙ®
 = 0;

644 
kv¡©s
 
puts
, 
g‘s
, 
sÿns
, 
puts_³r_£c
, 
g‘s_³r_£c
, 
sÿns_³r_£c
;

645 
i
 = 0; i < 
chd»n
; i++){

646 
buf
[2048];

647 
cc
 = 
	`»ad
(
pes
[
i
], 
buf
, (buf)-1);

648 
	`as£¹
(
cc
 > 0);

649 
buf
[
cc
] = 0;

650 
	`´štf
("%s", 
buf
);

651 
JsÚ
 
bufj
 = JsÚ::
	`·r£
(
buf
, buà+ 
cc
);

652 
iv
;

653 
dv
;

654 ià(
bufj
.
	`to_i
(
iv
))

655 
tÙ®
 +ğ
iv
;

656 ià(
bufj
.
	`is_objeù
()) {

657 ià(
bufj
.
	`g‘
("İs", 
iv
)

658 || 
bufj
.
	`g‘
("tÙ®", 
iv
)

659 || 
bufj
.
	`g‘
("couÁ", 
iv
))

660 
tÙ®
 +ğ
iv
;

661 ià(
bufj
.
	`g‘
("puts", 
iv
))

662 
puts
.
	`add
(
iv
);

663 ià(
bufj
.
	`g‘
("g‘s", 
iv
))

664 
g‘s
.
	`add
(
iv
);

665 ià(
bufj
.
	`g‘
("sÿns", 
iv
))

666 
sÿns
.
	`add
(
iv
);

667 ià(
bufj
.
	`g‘
("puts_³r_£c", 
dv
))

668 
puts_³r_£c
.
	`add
(
dv
);

669 ià(
bufj
.
	`g‘
("g‘s_³r_£c", 
dv
))

670 
g‘s_³r_£c
.
	`add
(
dv
);

671 ià(
bufj
.
	`g‘
("sÿns_³r_£c", 
dv
))

672 
sÿns_³r_£c
.
	`add
(
dv
);

676 
	`´štf
("tÙ® %Îd\n", 
tÙ®
);

677 
puts
.
	`´št_»pÜt
("puts");

678 
g‘s
.
	`´št_»pÜt
("gets");

679 
sÿns
.
	`´št_»pÜt
("scans");

680 
puts_³r_£c
.
	`´št_»pÜt
("puts/s");

681 
g‘s_³r_£c
.
	`´št_»pÜt
("gets/s");

682 
sÿns_³r_£c
.
	`´št_»pÜt
("scans/s");

684 
	`ex™
(0);

685 
	}
}

688 
	$run_chd
(
‹¡ruÂ”
* 
‹¡
, 
chdno
)

690 
sockaddr_š
 
sš
;

691 
»t
, 
yes
 = 1;

692 
chd
 
c
;

694 
	`bz”o
(&
c
, (c));

695 
c
.
chdno
 = childno;

697 if(
udpæag
){

698 
c
.
udp
 = 1;

699 
c
.
s
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

701 
c
.
s
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 0);

703 ià(
fœ¡_loÿl_pÜt
) {

704 
	`bz”o
(&
sš
, (sin));

705 
sš
.
sš_çmy
 = 
AF_INET
;

706 
sš
.
sš_pÜt
 = 
	`htÚs
(
fœ¡_loÿl_pÜt
 + (
chdno
 % 48));

707 
»t
 = ::
	`bšd
(
c
.
s
, (
sockaddr
 *è&
sš
, (sin));

708 ià(
»t
 < 0) {

709 
	`³¼Ü
("bind");

710 
	`ex™
(1);

714 
	`as£¹
(
c
.
s
 >= 0);

715 
	`£tsockİt
(
c
.
s
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
yes
, (yes));

717 
	`bz”o
(&
sš
, (sin));

718 
sš
.
sš_çmy
 = 
AF_INET
;

719 ià(
udpæag
 && !
sh¬e_£rv”_pÜt
)

720 
sš
.
sš_pÜt
 = 
	`htÚs
(
fœ¡_£rv”_pÜt
 + (
chdno
 % 48));

722 
sš
.
sš_pÜt
 = 
	`htÚs
(
fœ¡_£rv”_pÜt
);

723 
sš
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
£rv”
);

724 
»t
 = 
	`cÚÃù
(
c
.
s
, (
sockaddr
 *è&
sš
, (sin));

725 if(
»t
 < 0){

726 
	`³¼Ü
("connect");

727 
	`ex™
(1);

730 
c
.
cÚn
 = 
Ãw
 
	`KVCÚn
(c.
s
, !
udpæag
);

731 
kv‹¡_ş›Á
 
	`ş›Á
(
c
);

733 
‹¡
->
	`run
(
ş›Á
);

735 
	`checkasync
(&
c
, 2);

737 
d–‘e
 
c
.
cÚn
;

738 
	`şo£
(
c
.
s
);

739 
	}
}

741 
	gKVCÚn
::
	$h¬d_check
(
Œyh¬d
) {

742 
	`mas¡»e_´ecÚd™iÚ
(
šbuåos_
 =ğ
šbuæ’_
);

743 ià(
·r£r_
.
	`em±y
()) {

744 
šbuåos_
 = 
šbuæ’_
 = 0;

745 autØ
x
 : 
Şdšbuf_
)

746 
d–‘e
[] 
x
;

747 
Şdšbuf_
.
	`ş—r
();

748 } ià(
šbuåos_
 =ğ
šbufsz
) {

749 
Şdšbuf_
.
	`push_back
(
šbuf_
);

750 
šbuf_
 = 
Ãw
 [
šbufsz
];

751 
šbuåos_
 = 
šbuæ’_
 = 0;

753 ià(
Œyh¬d
 == 1) {

754 
fd_£t
 
rfds
;

755 
	`FD_ZERO
(&
rfds
);

756 
	`FD_SET
(
šfd_
, &
rfds
);

757 
timev®
 
tv
 = {0, 0};

758 ià(
	`£Ëù
(
šfd_
 + 1, &
rfds
, 
NULL
, NULL, &
tv
) <= 0)

761 
	`kvæush
(
out_
);

763 
ssize_t
 
r
 = 
	`»ad
(
šfd_
, 
šbuf_
 + 
šbuåos_
, 
šbufsz
 - inbufpos_);

764 ià(
r
 != -1)

765 
šbuæ’_
 +ğ
r
;

766 
	}
}

769 
	$g‘
(
chd
 *
c
, cÚ¡ 
SŒ
 &
key
, *
v®
, 
max
)

771 
	`as£¹
(
c
->
£q0_
 =ğc->
£q1_
);

773 
s£q
 = 
c
->
£q1_
;

774 ++
c
->
£q1_
;

775 ++
c
->
n£Á_
;

777 
c
->
cÚn
->
	`£ndg‘whŞe
(
key
, 
s£q
);

778 
c
->
cÚn
->
	`æush
();

780 cÚ¡ 
JsÚ
& 
»suÉ
 = 
c
->
cÚn
->
	`»ûive
();

781 
	`®ways_as£¹
(
»suÉ
 &&„esuÉ[0] =ğ
s£q
);

782 ++
c
->
£q0_
;

783 ià(!
»suÉ
[2])

785 
	`®ways_as£¹
(
»suÉ
.
	`size
(è=ğ3 &&„esuÉ[2].
	`is_s
()

786 && 
»suÉ
[2].
	`as_s
().
	`Ëngth
(è<ğ
max
);

787 
	`memıy
(
v®
, 
»suÉ
[2].
	`as_s
().
	`d©a
(),„esuÉ[2].as_s().
	`Ëngth
());

788  
»suÉ
[2].
	`as_s
().
	`Ëngth
();

789 
	}
}

793 
	$nocheck
(
chd
 *, 
async
 *, 
boŞ
, cÚ¡ 
SŒ
 &)

795 
	}
}

799 
	$asyncg‘cb
(
chd
 *, 
async
 *
a
, 
boŞ
, cÚ¡ 
SŒ
 &
v®
)

801 
SŒ
 *
¥Œ
;

802 
	`as£¹
(
a
->
wª‹dËn
 =ğ(
SŒ
 *));

803 
	`memıy
(&
¥Œ
, 
a
->
wª‹d
, (
SŒ
 *));

804 
¥Œ
->
Ën
 = 
¡d
::
	`mš
(¥Œ->Ën, 
v®
.len);

805 
	`memıy
(
cÚ¡_ÿ¡
<*>(
¥Œ
->
s
), 
v®
.s, s±r->
Ën
);

806 
	}
}

810 
	$asyncg‘cb_št
(
chd
 *, 
async
 *
a
, 
boŞ
, cÚ¡ 
SŒ
 &
v®
)

812 *
v±r
;

813 
	`as£¹
(
a
->
wª‹dËn
 == (*));

814 
	`memıy
(&
v±r
, 
a
->
wª‹d
, (*));

815 
x
 = 0;

816 ià(
v®
.
Ën
 <= 0)

817 
x
 = -1;

819 
i
 = 0; i < 
v®
.
Ën
; ++i)

820 ià(
v®
.
s
[
i
] >= '0' && val.s[i] <= '9')

821 
x
 = (x * 10è+ (
v®
.
s
[
i
] - '0');

823 
x
 = -1;

826 *
v±r
 = 
x
;

827 
	}
}

831 
	$deçuÉg‘
(
chd
 *, 
async
 *
a
, 
boŞ
 
have_v®
, cÚ¡ 
SŒ
 &
v®
)

834 
wª‹d_ava
 = 
¡d
::
	`mš
(
a
->
wª‹dËn
, (×->
wª‹d
)));

835 ià(!
have_v®


836 || 
a
->
wª‹dËn
 !ğ
v®
.
Ën


837 || 
	`memcmp
(
v®
.
s
, 
a
->
wª‹d
, 
wª‹d_ava
) != 0)

838 
	`årštf
(
¡d”r
, "oops wanted %.*s(%d) got %.*s(%d)\n",

839 
wª‹d_ava
, 
a
->
wª‹d
,‡->
wª‹dËn
, 
v®
.
Ën
, v®.
s
, val.len);

841 
	`®ways_as£¹
(
a
->
wª‹dËn
 =ğ
v®
.
Ën
);

842 
	`®ways_as£¹
(
	`memcmp
(
v®
.
s
, 
a
->
wª‹d
, 
wª‹d_ava
) == 0);

844 
	}
}

848 
	$asynıutcb
(
chd
 *, 
async
 *
a
, 
¡©us
)

850 *
¥Œ
;

851 
	`as£¹
(
a
->
wª‹dËn
 == (*));

852 
	`memıy
(&
¥Œ
, 
a
->
wª‹d
, (*));

853 *
¥Œ
 = 
¡©us
;

854 
	}
}

861 
	$checkasync
(
chd
 *
c
, 
fÜû
)

863 
c
->
£q0_
 !ğc->
£q1_
) {

864 ià(
fÜû
)

865 
c
->
cÚn
->
	`æush
();

866 ià(
c
->
cÚn
->
	`check
(
fÜû
 ? 2 : 1) > 0) {

867 cÚ¡ 
JsÚ
& 
»suÉ
 = 
c
->
cÚn
->
	`»ûive
();

868 
	`®ways_as£¹
(
»suÉ
);

872 
r£q
 = 
»suÉ
[0].
	`as_i
();

873 
	`®ways_as£¹
(
r£q
 - 
c
->
£q0_
 < c->
£q1_
 - c->seq0_);

874 
async
 *
a
 = &
c
->a[
r£q
 & (
wšdow
 - 1)];

875 
	`®ways_as£¹
(
a
->
£q
 =ğ
r£q
);

878 
	`®ways_as£¹
(
a
->
acked
 == 0);

879 
a
->
acked
 = 1;

880 
c
->
£q0_
 !ğc->
£q1_
 && c->
a
[c->£q0_ & (
wšdow
 - 1)].
acked
)

881 ++
c
->
£q0_
;

885 
async
 
tm·
 = *
a
;

887 if(
tm·
.
cmd
 =ğ
Cmd_G‘
){

889 
SŒšg
 
s
 = 
»suÉ
.
	`size
(è> 2 ?„esuÉ[2].
	`as_s
(è: 
	`SŒšg
();

890 ià(
tm·
.
g‘_â
)

891 (
tm·
.
g‘_â
)(
c
, &tm·, 
»suÉ
.
	`size
(è> 2, 
s
);

892 } ià(
tm·
.
cmd
 =ğ
Cmd_Put
 ||m·.cmd =ğ
Cmd_R•Ïû
) {

894 ià(
tm·
.
put_â
)

895 (
tm·
.
put_â
)(
c
, &tm·, 
»suÉ
[2].
	`as_i
());

896 } if(
tm·
.
cmd
 =ğ
Cmd_Sÿn
){

898 
	`®ways_as£¹
((
»suÉ
.
	`size
(è- 2è/ 2 <ğ
tm·
.
wª‹dËn
);

899 } ià(
tm·
.
cmd
 =ğ
Cmd_Remove
) {

901 ià(
tm·
.
»move_â
)

902 (
tm·
.
»move_â
)(
c
, &tm·, 
»suÉ
[2].
	`as_i
());

904 
	`®ways_as£¹
(0);

907 ià(
fÜû
 < 2)

908 
fÜû
 = 0;

909 } ià(!
fÜû
)

912 
	}
}

917 
	$ag‘
(
chd
 *
c
, cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
wª‹d
, 
g‘_async_cb
 
â
)

919 
c
->
	`check_æush
();

921 
c
->
cÚn
->
	`£ndg‘whŞe
(
key
, c->
£q1_
);

922 ià(
c
->
udp
)

923 
c
->
cÚn
->
	`æush
();

925 
async
 *
a
 = &
c
->a[c->
£q1_
 & (
wšdow
 - 1)];

926 
a
->
cmd
 = 
Cmd_G‘
;

927 
a
->
£q
 = 
c
->
£q1_
;

928 
a
->
g‘_â
 = (
â
 ? fÀ: 
deçuÉg‘
);

929 
	`as£¹
(
key
.
Ën
 < ((
a
->key)));

930 
	`memıy
(
a
->
key
, key.
s
, key.
Ën
);

931 
a
->
key
[key.
Ën
] = 0;

932 
a
->
wª‹dËn
 = 
wª‹d
.
Ën
;

933 
wª‹dava
 = 
¡d
::
	`mš
(
wª‹d
.
Ën
, ((
a
->wanted)));

934 
	`memıy
(
a
->
wª‹d
, wª‹d.
s
, 
wª‹dava
);

935 
a
->
acked
 = 0;

937 ++
c
->
£q1_
;

938 ++
c
->
n£Á_
;

939 
	}
}

941 
	$ag‘_cŞ
(
chd
 *
c
, cÚ¡ 
SŒ
& 
key
, 
cŞ
, cÚ¡ SŒ& 
wª‹d
,

942 
g‘_async_cb
 
â
)

944 
c
->
	`check_æush
();

946 
c
->
cÚn
->
	`£ndg‘cŞ
(
key
, 
cŞ
, c->
£q1_
);

947 ià(
c
->
udp
)

948 
c
->
cÚn
->
	`æush
();

950 
async
 *
a
 = &
c
->a[c->
£q1_
 & (
wšdow
 - 1)];

951 
a
->
cmd
 = 
Cmd_G‘
;

952 
a
->
£q
 = 
c
->
£q1_
;

953 
a
->
g‘_â
 = (
â
 ? fÀ: 
deçuÉg‘
);

954 
	`as£¹
(
key
.
Ën
 < ((
a
->key)));

955 
	`memıy
(
a
->
key
, key.
s
, key.
Ën
);

956 
a
->
key
[key.
Ën
] = 0;

957 
a
->
wª‹dËn
 = 
wª‹d
.
Ën
;

958 
wª‹dava
 = 
¡d
::
	`mš
(
wª‹d
.
Ën
, ((
a
->wanted)));

959 
	`memıy
(
a
->
wª‹d
, wª‹d.
s
, 
wª‹dava
);

960 
a
->
acked
 = 0;

962 ++
c
->
£q1_
;

963 ++
c
->
n£Á_
;

964 
	}
}

967 
	$ag‘
(
chd
 *
c
, 
ikey
, 
iwª‹d
, 
g‘_async_cb
 
â
)

969 
quick_i¡r
 
	`key
(
ikey
), 
	`wª‹d
(
iwª‹d
);

970 
	`ag‘
(
c
, 
key
.
	`¡ršg
(), 
wª‹d
.¡ršg(), 
â
);

971 
	}
}

974 
	$put
(
chd
 *
c
, cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
v®
)

976 
	`®ways_as£¹
(
c
->
£q0_
 =ğc->
£q1_
);

978 
s£q
 = 
c
->
£q1_
;

979 
c
->
cÚn
->
	`£ndputwhŞe
(
key
, 
v®
, 
s£q
);

980 
c
->
cÚn
->
	`æush
();

982 cÚ¡ 
JsÚ
& 
»suÉ
 = 
c
->
cÚn
->
	`»ûive
();

983 
	`®ways_as£¹
(
»suÉ
 &&„esuÉ[0] =ğ
s£q
);

985 ++
c
->
£q0_
;

986 ++
c
->
£q1_
;

987 ++
c
->
n£Á_
;

989 
	}
}

992 
	$­ut
(
chd
 *
c
, cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
v®
,

993 
put_async_cb
 
â
, cÚ¡ 
SŒ
 &
wª‹d
)

995 
c
->
	`check_æush
();

997 
c
->
cÚn
->
	`£ndputwhŞe
(
key
, 
v®
, c->
£q1_
);

998 ià(
c
->
udp
)

999 
c
->
cÚn
->
	`æush
();

1001 
async
 *
a
 = &
c
->a[c->
£q1_
 & (
wšdow
 - 1)];

1002 
a
->
cmd
 = 
Cmd_Put
;

1003 
a
->
£q
 = 
c
->
£q1_
;

1004 
	`as£¹
(
key
.
Ën
 < ((
a
->key)) - 1);

1005 
	`memıy
(
a
->
key
, key.
s
, key.
Ën
);

1006 
a
->
key
[key.
Ën
] = 0;

1007 
a
->
put_â
 = 
â
;

1008 ià(
â
) {

1009 
	`as£¹
(
wª‹d
.
Ën
 <ğ((
a
->wanted)));

1010 
a
->
wª‹dËn
 = 
wª‹d
.
Ën
;

1011 
	`memıy
(
a
->
wª‹d
, wª‹d.
s
, wª‹d.
Ën
);

1013 
a
->
wª‹dËn
 = -1;

1014 
a
->
wª‹d
[0] = 0;

1016 
a
->
acked
 = 0;

1018 ++
c
->
£q1_
;

1019 ++
c
->
n£Á_
;

1020 
	}
}

1022 
	$­ut_cŞ
(
chd
 *
c
, cÚ¡ 
SŒ
 &
key
, 
cŞ
, cÚ¡ SŒ &
v®
,

1023 
put_async_cb
 
â
, cÚ¡ 
SŒ
 &
wª‹d
)

1025 
c
->
	`check_æush
();

1027 
c
->
cÚn
->
	`£ndputcŞ
(
key
, 
cŞ
, 
v®
, c->
£q1_
);

1028 ià(
c
->
udp
)

1029 
c
->
cÚn
->
	`æush
();

1031 
async
 *
a
 = &
c
->a[c->
£q1_
 & (
wšdow
 - 1)];

1032 
a
->
cmd
 = 
Cmd_Put
;

1033 
a
->
£q
 = 
c
->
£q1_
;

1034 
	`as£¹
(
key
.
Ën
 < ((
a
->key)) - 1);

1035 
	`memıy
(
a
->
key
, key.
s
, key.
Ën
);

1036 
a
->
key
[key.
Ën
] = 0;

1037 
a
->
put_â
 = 
â
;

1038 ià(
â
) {

1039 
	`as£¹
(
wª‹d
.
Ën
 <ğ((
a
->wanted)));

1040 
a
->
wª‹dËn
 = 
wª‹d
.
Ën
;

1041 
	`memıy
(
a
->
wª‹d
, wª‹d.
s
, wª‹d.
Ën
);

1043 
a
->
wª‹dËn
 = -1;

1044 
a
->
wª‹d
[0] = 0;

1046 
a
->
acked
 = 0;

1048 ++
c
->
£q1_
;

1049 ++
c
->
n£Á_
;

1050 
	}
}

1052 
boŞ
 
	$»move
(
chd
 *
c
, cÚ¡ 
SŒ
 &
key
)

1054 
	`®ways_as£¹
(
c
->
£q0_
 =ğc->
£q1_
);

1056 
s£q
 = 
c
->
£q1_
;

1057 
c
->
cÚn
->
	`£nd»move
(
key
, 
s£q
);

1058 
c
->
cÚn
->
	`æush
();

1060 cÚ¡ 
JsÚ
& 
»suÉ
 = 
c
->
cÚn
->
	`»ûive
();

1061 
	`®ways_as£¹
(
»suÉ
 &&„esuÉ[0] =ğ
s£q
);

1063 ++
c
->
£q0_
;

1064 ++
c
->
£q1_
;

1065 ++
c
->
n£Á_
;

1066  
»suÉ
[2].
	`to_b
();

1067 
	}
}

1070 
	$¬emove
(
chd
 *
c
, cÚ¡ 
SŒ
 &
key
, 
»move_async_cb
 
â
)

1072 
c
->
	`check_æush
();

1074 
c
->
cÚn
->
	`£nd»move
(
key
, c->
£q1_
);

1075 ià(
c
->
udp
)

1076 
c
->
cÚn
->
	`æush
();

1078 
async
 *
a
 = &
c
->a[c->
£q1_
 & (
wšdow
 - 1)];

1079 
a
->
cmd
 = 
Cmd_Remove
;

1080 
a
->
£q
 = 
c
->
£q1_
;

1081 
	`as£¹
(
key
.
Ën
 < ((
a
->key)) - 1);

1082 
	`memıy
(
a
->
key
, key.
s
, key.
Ën
);

1083 
a
->
key
[key.
Ën
] = 0;

1084 
a
->
acked
 = 0;

1085 
a
->
»move_â
 = 
â
;

1087 ++
c
->
£q1_
;

1088 ++
c
->
n£Á_
;

1089 
	}
}

1092 
	$xcom·r
(cÚ¡ *
xa
, cÚ¡ *
xb
)

1094 *
a
 = (*è
xa
;

1095 *
b
 = (*è
xb
;

1096 if(*
a
 =ğ*
b
)

1098 if(*
a
 < *
b
)

1101 
	}
}

1106 
	$w1b
(
chd
 *
c
)

1108 
n
;

1109 ià(
lim™
 =ğ~(
ušt64_t
) 0)

1110 
n
 = 4000000;

1112 
n
 = 
¡d
::
	`mš
(
lim™
, (
ušt64_t
è
INT_MAX
);

1113 *
a
 = (*è
	`m®loc
((è* 
n
);

1114 
	`®ways_as£¹
(
a
);

1115 *
dÚe
 = (*è
	`m®loc
(
n
);

1117 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1122 
i
 = 0; i < 
n
; i++){

1123 
a
[
i
] = 
	`¿ndom
();

1124 
dÚe
[
i
] = 0;

1127 
	`qsÜt
(
a
, 
n
, ×[0]), 
xcom·r
);

1128 
	`®ways_as£¹
(
a
[0] <=‡[1] &&‡[1] <=‡[2] &&‡[2] <=‡[3]);

1130 
t0
 = 
	`now
(), 
t1
;

1132 
¡ride
 = 
n
 / 2; stride > 0; stride /= 2){

1133 
i
 = 
¡ride
; i < 
n
; i += stride){

1134 if(
dÚe
[
i
] == 0){

1135 
dÚe
[
i
] = 1;

1136 
key
[512], 
v®
[512];

1137 
	`¥rštf
(
key
, "%010ld", 
a
[
i
]);

1138 
	`¥rštf
(
v®
, "%ld", 
a
[
i
] + 1);

1139 
	`­ut
(
c
, 
	`SŒ
(
key
), SŒ(
v®
));

1143 
i
 = 0; i < 
n
; i++){

1144 if(
dÚe
[
i
] == 0){

1145 
dÚe
[
i
] = 1;

1146 
key
[512], 
v®
[512];

1147 
	`¥rštf
(
key
, "%010ld", 
a
[
i
]);

1148 
	`¥rštf
(
v®
, "%ld", 
a
[
i
] + 1);

1149 
	`­ut
(
c
, 
	`SŒ
(
key
), SŒ(
v®
));

1153 
	`checkasync
(
c
, 2);

1154 
t1
 = 
	`now
();

1156 
	`ä“
(
dÚe
);

1157 
	`ä“
(
a
);

1158 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("tÙ®", (è(
n
 / (
t1
 - 
t0
)))

1159 .
	`£t
("puts", 
n
)

1160 .
	`£t
("puts_³r_£c", 
n
 / (
t1
 - 
t0
));

1161 
	`´štf
("%s\n", 
»suÉ
.
	`uÅ¬£
().
	`c_¡r
());

1162 
	}
}

1168 
	$u1
(
chd
 *
c
)

1170 
i
, 
n
;

1171 
t0
 = 
	`now
();

1173 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1175 
i
 = 0; i < 10000000; i++){

1176 
key
[512], 
v®
[512];

1177 
x
 = 
	`¿ndom
() % 10000000;

1178 
	`¥rštf
(
key
, "%ld", 
x
);

1179 
	`¥rštf
(
v®
, "%ld", 
x
 + 1);

1180 
	`­ut
(
c
, 
	`SŒ
(
key
), SŒ(
v®
));

1182 
n
 = 
i
;

1184 
	`checkasync
(
c
, 2);

1186 
t1
 = 
	`now
();

1187 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("tÙ®", (è(
n
 / (
t1
 - 
t0
)))

1188 .
	`£t
("puts", 
n
)

1189 .
	`£t
("puts_³r_£c", 
n
 / (
t1
 - 
t0
));

1190 
	`´štf
("%s\n", 
»suÉ
.
	`uÅ¬£
().
	`c_¡r
());

1191 
	}
}

1193 
	#CPN
 10000000

	)

1196 
	$ıa
(
chd
 *
c
)

1198 
i
, 
n
;

1199 
t0
 = 
	`now
();

1201 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1203 
i
 = 0; i < 
CPN
; i++){

1204 
key
[512], 
v®
[512];

1205 
x
 = 
	`¿ndom
();

1206 
	`¥rštf
(
key
, "%ld", 
x
);

1207 
	`¥rštf
(
v®
, "%ld", 
x
 + 1);

1208 
	`­ut
(
c
, 
	`SŒ
(
key
), SŒ(
v®
));

1210 
n
 = 
i
;

1212 
	`checkasync
(
c
, 2);

1214 
t1
 = 
	`now
();

1215 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("tÙ®", (è(
n
 / (
t1
 - 
t0
)))

1216 .
	`£t
("puts", 
n
)

1217 .
	`£t
("puts_³r_£c", 
n
 / (
t1
 - 
t0
));

1218 
	`´štf
("%s\n", 
»suÉ
.
	`uÅ¬£
().
	`c_¡r
());

1220 
	}
}

1223 
	$ıc
(
chd
 *
c
)

1225 
i
, 
n
;

1226 
t0
 = 
	`now
();

1228 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1230 
i
 = 0; !
timeout
[0]; i++){

1231 
key
[512], 
v®
[512];

1232 ià(
i
 % 
CPN
 == 0)

1233 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1234 
x
 = 
	`¿ndom
();

1235 
	`¥rštf
(
key
, "%ld", 
x
);

1236 
	`¥rštf
(
v®
, "%ld", 
x
 + 1);

1237 
	`ag‘
(
c
, 
	`SŒ
(
key
), SŒ(
v®
), 
NULL
);

1239 
n
 = 
i
;

1241 
	`checkasync
(
c
, 2);

1243 
t1
 = 
	`now
();

1244 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("tÙ®", (è(
n
 / (
t1
 - 
t0
)))

1245 .
	`£t
("g‘s", 
n
)

1246 .
	`£t
("g‘s_³r_£c", 
n
 / (
t1
 - 
t0
));

1247 
	`´štf
("%s\n", 
»suÉ
.
	`uÅ¬£
().
	`c_¡r
());

1248 
	}
}

1251 
	$ıd
(
chd
 *
c
)

1253 
i
, 
n
;

1254 
t0
 = 
	`now
();

1256 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1258 
i
 = 0; !
timeout
[0]; i++){

1259 
key
[512], 
v®
[512];

1260 ià(
i
 % 
CPN
 == 0)

1261 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1262 
x
 = 
	`¿ndom
();

1263 
	`¥rštf
(
key
, "%ld", 
x
);

1264 
	`¥rštf
(
v®
, "%ld", 
x
 + 1);

1265 
	`­ut
(
c
, 
	`SŒ
(
key
), SŒ(
v®
));

1267 
n
 = 
i
;

1269 
	`checkasync
(
c
, 2);

1271 
t1
 = 
	`now
();

1272 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("tÙ®", (è(
n
 / (
t1
 - 
t0
)))

1273 .
	`£t
("puts", 
n
)

1274 .
	`£t
("puts_³r_£c", 
n
 / (
t1
 - 
t0
));

1275 
	`´štf
("%s\n", 
»suÉ
.
	`uÅ¬£
().
	`c_¡r
());

1276 
	}
}

1282 
	$ov”1
(
chd
 *
c
)

1284 
»t
, 
™”
;

1286 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1288 
™”
 = 0;

1289 !
timeout
[0]){

1290 
key1
[64], 
key2
[64], 
v®1
[64], 
v®2
[64];

1291 
time_t
 
xt
 = 
	`time
(0);

1292 
xt
 =ğ
	`time
(0))

1294 
	`¥rštf
(
key1
, "%d", 
™”
);

1295 
	`¥rštf
(
v®1
, "%ld", 
	`¿ndom
());

1296 
	`put
(
c
, 
	`SŒ
(
key1
), SŒ(
v®1
));

1297 
	`Çpms
(500);

1298 
»t
 = 
	`g‘
(
c
, 
	`SŒ
(
key1
), 
v®2
, (val2));

1299 
	`®ways_as£¹
(
»t
 > 0);

1300 
	`¥rštf
(
key2
, "%d-%d", 
™”
, 
c
->
chdno
);

1301 
	`put
(
c
, 
	`SŒ
(
key2
), SŒ(
v®2
));

1302 if(
c
->
chdno
 == 0)

1303 
	`´štf
("%d: %s\n", 
™”
, 
v®2
);

1304 
™”
++;

1306 
	`checkasync
(
c
, 2);

1307 
	`´štf
("0\n");

1308 
	}
}

1312 
	$ov”2
(
chd
 *
c
)

1314 
™”
;

1316 
™”
 = 0; ; iter++){

1317 
key1
[64], 
key2
[64], 
v®1
[64], 
v®2
[64];

1318 
»t
;

1319 
	`¥rštf
(
key1
, "%d", 
™”
);

1320 
»t
 = 
	`g‘
(
c
, 
	`SŒ
(
key1
), 
v®1
, (val1));

1321 if(
»t
 == -1)

1323 
	`¥rštf
(
key2
, "%d-%d", 
™”
, 
c
->
chdno
);

1324 
»t
 = 
	`g‘
(
c
, 
	`SŒ
(
key2
), 
v®2
, (val2));

1325 if(
»t
 == -1)

1327 if(
c
->
chdno
 == 0)

1328 
	`´štf
("%d: %s\n", 
™”
, 
v®2
);

1329 
	`®ways_as£¹
(
	`¡rcmp
(
v®1
, 
v®2
) == 0);

1332 
	`checkasync
(
c
, 2);

1333 
	`årštf
(
¡d”r
, "chd %d checked %d\n", 
c
->
chdno
, 
™”
);

1334 
	`´štf
("0\n");

1335 
	}
}

1341 
	$»c1
(
chd
 *
c
)

1343 
i
;

1344 
t0
 = 
	`now
(), 
t1
;

1346 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1348 
i
 = 0; !
timeout
[0]; i++){

1349 
key
[512], 
v®
[512];

1350 
x
 = 
	`¿ndom
();

1351 
	`¥rštf
(
key
, "%ld-%d-%d", 
x
, 
i
, 
c
->
chdno
);

1352 
	`¥rštf
(
v®
, "%ld", 
x
);

1353 
	`­ut
(
c
, 
	`SŒ
(
key
), SŒ(
v®
));

1355 
	`checkasync
(
c
, 2);

1356 
t1
 = 
	`now
();

1358 
	`årštf
(
¡d”r
, "child %d: done %d %.0f…ut/s\n",

1359 
c
->
chdno
,

1360 
i
,

1361 
i
 / (
t1
 - 
t0
));

1362 
	`´štf
("%.0f\n", 
i
 / (
t1
 - 
t0
));

1363 
	}
}

1366 
	$»c2
(
chd
 *
c
)

1368 
i
;

1370 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1372 
i
 = 0; ; i++){

1373 
key
[512], 
v®
[512], 
wª‹d
[512];

1374 
x
 = 
	`¿ndom
();

1375 
	`¥rštf
(
key
, "%ld-%d-%d", 
x
, 
i
, 
c
->
chdno
);

1376 
	`¥rštf
(
wª‹d
, "%ld", 
x
);

1377 
»t
 = 
	`g‘
(
c
, 
	`SŒ
(
key
), 
v®
, (val));

1378 if(
»t
 == -1)

1380 
v®
[
»t
] = 0;

1381 if(
	`¡rcmp
(
v®
, 
wª‹d
) != 0){

1382 
	`årštf
(
¡d”r
, "oİ key % gÙ % wª‹d %s\n", 
key
, 
v®
, 
wª‹d
);

1383 
	`ex™
(1);

1387 
i0
 = 
i
;

1388 
i
 = 
i0
+1; i < i0 + 10000; i++){

1389 
key
[512], 
v®
[512];

1390 
x
 = 
	`¿ndom
();

1391 
	`¥rštf
(
key
, "%ld-%d-%d", 
x
, 
i
, 
c
->
chdno
);

1392 
v®
[0] = 0;

1393 
»t
 = 
	`g‘
(
c
, 
	`SŒ
(
key
), 
v®
, (val));

1394 if(
»t
 != -1){

1395 
	`´štf
("child %d: oops first missing %d but %d…resent\n",

1396 
c
->
chdno
, 
i0
, 
i
);

1397 
	`ex™
(1);

1400 
	`checkasync
(
c
, 2);

1402 
	`årštf
(
¡d”r
, "cÜ»ù…»fix oà%d„ecÜds\n", 
i0
);

1403 
	`´štf
("0\n");

1404 
	}
}

1408 
	$ıb
(
chd
 *
c
)

1410 ià(
c
->
chdno
 == 0)

1411 
c
->
cÚn
->
	`checkpošt
(c->
chdno
);

1412 
	`checkasync
(
c
, 2);

1413 
	}
}

1423 
	#VOLT1N
 500000

	)

1424 
	#VOLT1SIZE
 (12*1024)

	)

1426 
	$vŞt1a
(
chd
 *
c
)

1428 
i
, 
j
;

1429 
t0
 = 
	`now
(), 
t1
;

1430 *
v®
 = (*è
	`m®loc
(
VOLT1SIZE
 + 1);

1431 
	`®ways_as£¹
(
v®
);

1433 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1435 
i
 = 0; i < 
VOLT1SIZE
; i++)

1436 
v®
[
i
] = 'a' + (i % 26);

1437 
v®
[
VOLT1SIZE
] = '\0';

1441 *
keys
 = (*è
	`m®loc
((è* 
VOLT1N
);

1442 
	`®ways_as£¹
(
keys
);

1443 
i
 = 0; i < 
VOLT1N
; i++)

1444 
keys
[
i
] = i;

1445 
i
 = 0; i < 
VOLT1N
; i++){

1446 
x
 = 
	`¿ndom
(è% 
VOLT1N
;

1447 
tmp
 = 
keys
[
i
];

1448 
keys
[
i
] = keys[
x
];

1449 
keys
[
x
] = 
tmp
;

1452 
i
 = 0; i < 
VOLT1N
; i++){

1453 
key
[100];

1454 
	`¥rštf
(
key
, "%-50d", 
keys
[
i
]);

1455 
j
 = 0; j < 20; j++)

1456 
v®
[
j
] = 'a' + (j % 26);

1457 
	`¥rštf
(
v®
, ">%d", 
keys
[
i
]);

1458 
j
 = 
	`¡¾’
(
v®
);

1459 
v®
[
j
] = '<';

1460 
	`®ways_as£¹
(
	`¡¾’
(
v®
è=ğ
VOLT1SIZE
);

1461 
	`®ways_as£¹
(
	`¡¾’
(
key
) == 50);

1462 
	`®ways_as£¹
(
	`isdig™
(
key
[0]));

1463 
	`­ut
(
c
, 
	`SŒ
(
key
), SŒ(
v®
));

1465 
	`checkasync
(
c
, 2);

1466 
t1
 = 
	`now
();

1468 
	`ä“
(
v®
);

1469 
	`ä“
(
keys
);

1471 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("tÙ®", (è(
i
 / (
t1
 - 
t0
)));

1472 
	`´štf
("%s\n", 
»suÉ
.
	`uÅ¬£
().
	`c_¡r
());

1473 
	}
}

1483 
	$vŞt1b
(
chd
 *
c
)

1485 
i
, 
n
, 
j
;

1486 
t0
 = 
	`now
(), 
t1
;

1487 *
wª‹d
 = (*è
	`m®loc
(
VOLT1SIZE
 + 1);

1488 
	`®ways_as£¹
(
wª‹d
);

1490 
i
 = 0; i < 
VOLT1SIZE
; i++)

1491 
wª‹d
[
i
] = 'a' + (i % 26);

1492 
wª‹d
[
VOLT1SIZE
] = '\0';

1494 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1496 
i
 = 0; !
timeout
[0]; i++){

1497 
key
[100];

1498 
x
 = 
	`¿ndom
(è% 
VOLT1N
;

1499 
	`¥rštf
(
key
, "%-50d", 
x
);

1500 
j
 = 0; j < 20; j++)

1501 
wª‹d
[
j
] = 'a' + (j % 26);

1502 
	`¥rštf
(
wª‹d
, ">%d", 
x
);

1503 
j
 = 
	`¡¾’
(
wª‹d
);

1504 
wª‹d
[
j
] = '<';

1505 if(
i
 > 1)

1506 
	`checkasync
(
c
, 1);

1507 if((
	`¿ndom
() % 2) == 0)

1508 
	`ag‘
(
c
, 
	`SŒ
(
key
, 50), SŒ(
wª‹d
, 
VOLT1SIZE
), 0);

1510 
	`­ut
(
c
, 
	`SŒ
(
key
, 50), SŒ(
wª‹d
, 
VOLT1SIZE
));

1512 
n
 = 
i
;

1514 
	`checkasync
(
c
, 2);

1515 
t1
 = 
	`now
();

1517 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("tÙ®", (è(
n
 / (
t1
 - 
t0
)));

1518 
	`´štf
("%s\n", 
»suÉ
.
	`uÅ¬£
().
	`c_¡r
());

1519 
	}
}

1528 
	#VOLT2N
 500000

	)

1529 
	#VOLT2INTS
 50

	)

1531 
	$vŞt2a
(
chd
 *
c
)

1533 
i
, 
j
, 
n
 = 0;

1534 
t0
 = 
	`now
(), 
t1
;

1536 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1540 *
keys
 = (*è
	`m®loc
((è* 
VOLT2N
);

1541 
	`®ways_as£¹
(
keys
);

1542 
i
 = 0; i < 
VOLT2N
; i++)

1543 
keys
[
i
] = i;

1544 
i
 = 0; i < 
VOLT2N
; i++){

1545 
x
 = 
	`¿ndom
(è% 
VOLT2N
;

1546 
tmp
 = 
keys
[
i
];

1547 
keys
[
i
] = keys[
x
];

1548 
keys
[
x
] = 
tmp
;

1551 
subkeys
[
VOLT2INTS
];

1552 
i
 = 0; i < 
VOLT2INTS
; i++)

1553 
subkeys
[
i
] = i;

1554 
i
 = 0; i < 
VOLT2INTS
; i++){

1555 
x
 = 
	`¿ndom
(è% 
VOLT2INTS
;

1556 
tmp
 = 
subkeys
[
i
];

1557 
subkeys
[
i
] = subkeys[
x
];

1558 
subkeys
[
x
] = 
tmp
;

1561 
i
 = 0; i < 
VOLT2N
; i++){

1562 
j
 = 0; j < 
VOLT2INTS
; j++){

1563 
v®
[32], 
key
[100];

1564 
k
;

1565 
	`¥rštf
(
key
, "%d-%d", 
keys
[
i
], 
subkeys
[
j
]);

1566 
k
 = 
	`¡¾’
(
key
); k < 50; k++)

1567 
key
[
k
] = ' ';

1568 
key
[50] = '\0';

1569 
	`¥rštf
(
v®
, "%ld", 
	`¿ndom
());

1570 
	`­ut
(
c
, 
	`SŒ
(
key
), SŒ(
v®
));

1571 
n
++;

1574 
	`checkasync
(
c
, 2);

1575 
t1
 = 
	`now
();

1577 
	`ä“
(
keys
);

1578 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("tÙ®", (è(
n
 / (
t1
 - 
t0
)));

1579 
	`´štf
("%s\n", 
»suÉ
.
	`uÅ¬£
().
	`c_¡r
());

1580 
	}
}

1584 
	$vŞt2b1
(
chd
 *
c
, 
async
 *
a
, 
boŞ
, cÚ¡ 
SŒ
 &
v®
)

1586 
k
 = 
	`©oi
(
a
->
key
);

1587 
v
 = 
	`©oi
(
v®
.
s
);

1588 if((
v
 % 2) == 1){

1589 
key
[100], 
v®
[100];

1590 
	`¥rštf
(
key
, "%d-%ld", 
k
, 
	`¿ndom
(è% 
VOLT2INTS
);

1591 
i
 = 
	`¡¾’
(
key
); i < 50; i++)

1592 
key
[
i
] = ' ';

1593 
	`¥rštf
(
v®
, "%ld", 
	`¿ndom
());

1594 
	`­ut
(
c
, 
	`SŒ
(
key
, 50), SŒ(
v®
));

1596 
	}
}

1599 
	$vŞt2b
(
chd
 *
c
)

1601 
i
, 
n
;

1602 
t0
 = 
	`now
(), 
t1
;

1603 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1604 
i
 = 0; !
timeout
[0]; i++){

1605 
key
[100];

1606 
x
 = 
	`¿ndom
(è% 
VOLT2N
;

1607 
y
 = 
	`¿ndom
(è% 
VOLT2INTS
;

1608 
	`¥rštf
(
key
, "%d-%d", 
x
, 
y
);

1609 
j
;

1610 
j
 = 
	`¡¾’
(
key
); j < 50; j++)

1611 
key
[
j
] = ' ';

1612 
	`ag‘
(
c
, 
	`SŒ
(
key
, 50), SŒ(), 
vŞt2b1
);

1614 
n
 = 
i
;

1616 
	`checkasync
(
c
, 2);

1617 
t1
 = 
	`now
();

1619 
JsÚ
 
»suÉ
 = 
	`JsÚ
().
	`£t
("tÙ®", (è(
n
 / (
t1
 - 
t0
)));

1620 
	`´štf
("%s\n", 
»suÉ
.
	`uÅ¬£
().
	`c_¡r
());

1621 
	}
}

1623 
usšg
 
	g¡d
::
veùÜ
;

1624 
usšg
 
	g¡d
::
¡ršg
;

1627 
	$sÿÁe¡
(
chd
 *
c
)

1629 
i
;

1631 
	`¤ªdom
(
kv‹¡_fœ¡_£ed
 + 
c
->
chdno
);

1633 
i
 = 100; i < 200; i++){

1634 
key
[32], 
v®
[32];

1635 
kl
 = 
	`¥rštf
(
key
, "k%04d", 
i
);

1636 
	`¥rštf
(
v®
, "v%04d", 
i
);

1637 
	`­ut
(
c
, 
	`SŒ
(
key
, 
kl
), SŒ(
v®
));

1640 
	`checkasync
(
c
, 2);

1642 
i
 = 90; i < 210; i++){

1643 
key
[32];

1644 
	`¥rštf
(
key
, "k%04d", 
i
);

1645 
wª‹d
 = 
	`¿ndom
() % 10;

1646 
c
->
cÚn
->
	`£ndsÿnwhŞe
(
key
, 
wª‹d
, 1);

1647 
c
->
cÚn
->
	`æush
();

1650 cÚ¡ 
JsÚ
& 
»suÉ
 = 
c
->
cÚn
->
	`»ûive
();

1651 
	`®ways_as£¹
(
»suÉ
 &&„esult[0] == 1);

1652 
n
 = (
»suÉ
.
	`size
() - 2) / 2;

1653 if(
i
 <ğ200 - 
wª‹d
){

1654 
	`®ways_as£¹
(
n
 =ğ
wª‹d
);

1655 } if(
i
 <= 200){

1656 
	`®ways_as£¹
(
n
 =ğ200 - 
i
);

1658 
	`®ways_as£¹
(
n
 == 0);

1660 
k0
 = (
i
 < 100 ? 100 : i);

1661 
j
, 
ki
, 
off
 = 2;

1662 
j
 = 
k0
, 
ki
 = 0; j < k0 + 
wª‹d
 && j < 200; j++, ki++, 
off
 += 2){

1663 
xkey
[32], 
xv®
[32];

1664 
	`¥rštf
(
xkey
, "k%04d", 
j
);

1665 
	`¥rštf
(
xv®
, "v%04d", 
j
);

1666 ià(!
»suÉ
[
off
].
	`as_s
().
	`equ®s
(
xkey
)) {

1667 
	`årštf
(
¡d”r
, "As£¹iÚ faed @%d: sŒcmp(%s, %sè=ğ0\n", 
ki
, 
»suÉ
[
off
].
	`as_s
().
	`c_¡r
(), 
xkey
);

1668 
	`®ways_as£¹
(0);

1670 
	`®ways_as£¹
(
»suÉ
[
off
 + 1].
	`as_s
().
	`equ®s
(
xv®
));

1675 
	`¥rštf
(
key
, "k%04d-a", 
i
);

1676 
c
->
cÚn
->
	`£ndsÿnwhŞe
(
key
, 1, 1);

1677 
c
->
cÚn
->
	`æush
();

1679 cÚ¡ 
JsÚ
& 
»suÉ
 = 
c
->
cÚn
->
	`»ûive
();

1680 
	`®ways_as£¹
(
»suÉ
 &&„esult[0] == 1);

1681 
n
 = (
»suÉ
.
	`size
() - 2) / 2;

1682 if(
i
 >= 100 && i < 199){

1683 
	`®ways_as£¹
(
n
 == 1);

1684 
	`¥rštf
(
key
, "k%04d", 
i
+1);

1685 
	`®ways_as£¹
(
»suÉ
[2].
	`as_s
().
	`equ®s
(
key
));

1690 
c
->
cÚn
->
	`£ndsÿnwhŞe
("k015", 10, 1);

1691 
c
->
cÚn
->
	`æush
();

1693 cÚ¡ 
JsÚ
& 
»suÉ
 = 
c
->
cÚn
->
	`»ûive
();

1694 
	`®ways_as£¹
(
»suÉ
 &&„esult[0] == 1);

1695 
n
 = (
»suÉ
.
	`size
() - 2) / 2;

1696 
	`®ways_as£¹
(
n
 == 10);

1697 
	`®ways_as£¹
(
»suÉ
[2].
	`as_s
().
	`equ®s
("k0150"));

1698 
	`®ways_as£¹
(
»suÉ
[3].
	`as_s
().
	`equ®s
("v0150"));

1700 
	`årštf
(
¡d”r
, "scantest OK\n");

1701 
	`´štf
("0\n");

1702 
	}
}

	@masstree-beta/mtclient.hh

16 #iâdeà
KVC_HH


17 
	#KVC_HH
 1

	)

18 
	~"kv´Ùo.hh
"

19 
	~"kvrow.hh
"

20 
	~"jsÚ.hh
"

21 
	~"msg·ck.hh
"

22 
	~<sys/sock‘.h
>

23 
	~<Ãtdb.h
>

24 
	~<Ãtš‘/š.h
>

25 
	~<¬·/š‘.h
>

26 
	~<Ãtš‘/tı.h
>

27 
	~<¡ršg
>

28 
	~<queue
>

29 
	~<veùÜ
>

31 şas 
	cKVCÚn
 {

32 
	mpublic
:

33 
KVCÚn
(cÚ¡ *
£rv”
, 
pÜt
, 
rg‘_cÜe
 = -1)

34 : 
šbuf_
(
Ãw
 [
šbufsz
]), 
šbuåos_
(0), 
šbuæ’_
(0),

35 
j_
(
JsÚ
::
	$make_¬¿y
()) {

36 
ho¡’t
 *
’t
 = 
	`g‘ho¡byÇme
(
£rv”
);

37 
	`®ways_as£¹
(
’t
);

38 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 0);

39 
	`®ways_as£¹
(
fd
 > 0);

40 
fdtoşo£_
 = 
fd
;

41 
yes
 = 1;

42 
	`®ways_as£¹
(
fd
 >= 0);

43 
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
yes
, (yes));

45 
sockaddr_š
 
sš
;

46 
	`mem£t
(&
sš
, 0, (sin));

47 
sš
.
sš_çmy
 = 
AF_INET
;

48 
sš
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

49 
	`memıy
(&
sš
.
sš_addr
.
s_addr
, 
’t
->
h_addr
,ƒÁ->
h_Ëngth
);

50 
r
 = 
	`cÚÃù
(
fd
, (cÚ¡ 
sockaddr
 *)&
sš
, (sin));

51 ià(
r
) {

52 
	`³¼Ü
("connect");

53 
	`ex™
(
EXIT_FAILURE
);

56 
šfd_
 = 
fd
;

57 
out_
 = 
	`Ãw_kvout
(
fd
, 64*1024);

58 
	`hªdshake
(
rg‘_cÜe
);

60 
	$KVCÚn
(
fd
, 
boŞ
 
tı
)

61 : 
	`šbuf_
(
Ãw
 [
šbufsz
]), 
	`šbuåos_
(0), 
	`šbuæ’_
(0), 
	`šfd_
(
fd
),

62 
	`j_
(
JsÚ
::
	$make_¬¿y
()) {

63 
out_
 = 
	`Ãw_kvout
(
fd
, 64*1024);

64 
fdtoşo£_
 = -1;

65 ià(
tı
)

66 
	`hªdshake
(-1);

67 
	}
}

68 ~
	$KVCÚn
() {

69 ià(
fdtoşo£_
 >= 0)

70 
	`şo£
(
fdtoşo£_
);

71 
	`ä“_kvout
(
out_
);

72 
d–‘e
[] 
šbuf_
;

73 autØ
x
 : 
Şdšbuf_
)

74 
d–‘e
[] 
x
;

75 
	}
}

76 
	$£ndg‘whŞe
(
SŒ
 
key
, 
£q
) {

77 
j_
.
	`»size
(3);

78 
j_
[0] = 
£q
;

79 
j_
[1] = 
Cmd_G‘
;

80 
j_
[2] = 
SŒšg
::
	`make_¡abË
(
key
);

81 
	`£nd
();

82 
	}
}

83 
	$£ndg‘cŞ
(
SŒ
 
key
, 
cŞ
, 
£q
) {

84 
j_
.
	`»size
(4);

85 
j_
[0] = 
£q
;

86 
j_
[1] = 
Cmd_G‘
;

87 
j_
[2] = 
SŒšg
::
	`make_¡abË
(
key
);

88 
j_
[3] = 
cŞ
;

89 
	`£nd
();

90 
	}
}

91 
£ndg‘
(
SŒ
 
key
, cÚ¡ 
¡d
::
veùÜ
<>& 
f
, 
£q
) {

92 
	gj_
.
»size
(4);

93 
	gj_
[0] = 
£q
;

94 
	gj_
[1] = 
Cmd_G‘
;

95 
	gj_
[2] = 
SŒšg
::
make_¡abË
(
key
);

96 
	gj_
[3] = 
JsÚ
(
f
.
begš
(), f.
’d
());

97 
£nd
();

100 
	$£ndputcŞ
(
SŒ
 
key
, 
cŞ
, SŒ 
v®
, 
£q
) {

101 
j_
.
	`»size
(5);

102 
j_
[0] = 
£q
;

103 
j_
[1] = 
Cmd_Put
;

104 
j_
[2] = 
SŒšg
::
	`make_¡abË
(
key
);

105 
j_
[3] = 
cŞ
;

106 
j_
[4] = 
SŒšg
::
	`make_¡abË
(
v®
);

107 
	`£nd
();

108 
	}
}

109 
	$£ndputwhŞe
(
SŒ
 
key
, SŒ 
v®
, 
£q
) {

110 
j_
.
	`»size
(3);

111 
j_
[0] = 
£q
;

112 
j_
[1] = 
Cmd_R•Ïû
;

113 
j_
[2] = 
SŒšg
::
	`make_¡abË
(
key
);

114 
j_
[3] = 
SŒšg
::
	`make_¡abË
(
v®
);

115 
	`£nd
();

116 
	}
}

117 
	$£nd»move
(
SŒ
 
key
, 
£q
) {

118 
j_
.
	`»size
(3);

119 
j_
[0] = 
£q
;

120 
j_
[1] = 
Cmd_Remove
;

121 
j_
[2] = 
SŒšg
::
	`make_¡abË
(
key
);

122 
	`£nd
();

123 
	}
}

125 
	$£ndsÿnwhŞe
(
SŒ
 
fœ¡key
, 
num·œs
, 
£q
) {

126 
j_
.
	`»size
(4);

127 
j_
[0] = 
£q
;

128 
j_
[1] = 
Cmd_Sÿn
;

129 
j_
[2] = 
SŒšg
::
	`make_¡abË
(
fœ¡key
);

130 
j_
[3] = 
num·œs
;

131 
	`£nd
();

132 
	}
}

133 
£ndsÿn
(
SŒ
 
fœ¡key
, cÚ¡ 
¡d
::
veùÜ
<>& 
f
,

134 
num·œs
, 
£q
) {

135 
	gj_
.
»size
(5);

136 
	gj_
[0] = 
£q
;

137 
	gj_
[1] = 
Cmd_Sÿn
;

138 
	gj_
[2] = 
SŒšg
::
make_¡abË
(
fœ¡key
);

139 
	gj_
[3] = 
num·œs
;

140 
	gj_
[4] = 
JsÚ
(
f
.
begš
(), f.
’d
());

141 
£nd
();

144 
	$checkpošt
(
chdno
) {

145 
	`®ways_as£¹
(
chdno
 == 0);

146 
	`årštf
(
¡d”r
, "asking for‡ checkpoint\n");

147 
j_
.
	`»size
(2);

148 
j_
[0] = 0;

149 
j_
[1] = 
Cmd_Checkpošt
;

150 
	`£nd
();

151 
	`æush
();

153 
	`´štf
("sent\n");

154 (è
	`»ûive
();

155 
	}
}

157 
	$æush
() {

158 
	`kvæush
(
out_
);

159 
	}
}

161 
	$check
(
Œyh¬d
) {

162 ià(
šbuåos_
 =ğ
šbuæ’_
 && 
Œyh¬d
)

163 
	`h¬d_check
(
Œyh¬d
);

164  
šbuæ’_
 - 
šbuåos_
;

165 
	}
}

167 cÚ¡ 
	gJsÚ
& 
	$»ûive
() {

168 !
·r£r_
.
	`dÚe
(è&& 
	`check
(2))

169 
šbuåos_
 +ğ
·r£r_
.
	`cÚsume
(
šbuf_
 + inbufpos_,

170 
šbuæ’_
 - 
šbuåos_
,

171 
SŒšg
::
	`make_¡abË
(
šbuf_
, 
šbufsz
));

172 ià(
·r£r_
.
	`sucûss
(è&&…¬£r_.
	`»suÉ
().
	`is_a
())

173 
·r£r_
.
	`»£t
();

175 
·r£r_
.
	`»suÉ
(èğ
	`JsÚ
();

176  
·r£r_
.
	`»suÉ
();

177 
	}
}

179 
	g´iv©e
:

180 ’um { 
šbufsz
 = 64 * 1024, 
	gšbuäefl
 = 56 * 1024 };

181 * 
	gšbuf_
;

182 
	gšbuåos_
;

183 
	gšbuæ’_
;

184 
	g¡d
::
veùÜ
<*> 
Şdšbuf_
;

185 
	gšfd_
;

187 
kvout
 *
	gout_
;

189 
JsÚ
 
	gj_
;

190 
	gmsg·ck
::
¡»amšg_·r£r
 
·r£r_
;

192 
	gfdtoşo£_
;

193 
	g·¹™iÚ_
;

195 
	$hªdshake
(
rg‘_cÜe
) {

196 
j_
.
	`»size
(3);

197 
j_
[0] = 0;

198 
j_
[1] = 
Cmd_Hªdshake
;

199 
j_
[2] = 
JsÚ
::
	`make_objeù
().
	`£t
("cÜe", 
rg‘_cÜe
)

200 .
	`£t
("maxkeyËn", 
MASSTREE_MAXKEYLEN
);

201 
	`£nd
();

202 
	`kvæush
(
out_
);

204 cÚ¡ 
JsÚ
& 
»suÉ
 = 
	`»ûive
();

205 ià(!
»suÉ
.
	`is_a
()

206 || 
»suÉ
[1] !ğ
Cmd_Hªdshake
 + 1

207 || !
»suÉ
[2]) {

208 
	`årštf
(
¡d”r
, "Incompatible kvdb…rotocol\n");

209 
	`ex™
(
EXIT_FAILURE
);

211 
·¹™iÚ_
 = 
»suÉ
[3].
	`as_i
();

212 
	}
}

213 
šlše
 
	$£nd
() {

214 
msg·ck
::
	`uÅ¬£
(*
out_
, 
j_
);

215 
	}
}

216 
h¬d_check
(
Œyh¬d
);

	@masstree-beta/mtcounters.hh

16 #iâdeà
MTCOUNTERS_HH


17 
	#MTCOUNTERS_HH
 1

	)

19 
	ememg
 {

23 
	mmemg_nÚe
 = 0x000,

24 
	mmemg_v®ue
 = 0x100,

25 
	mmemg_limbo
 = 0x500,

26 
	mmemg_mas¡»e_Ëaf
 = 0x1000,

27 
	mmemg_mas¡»e_š‹ºode
 = 0x1100,

28 
	mmemg_mas¡»e_ksuffixes
 = 0x1200,

29 
	mmemg_mas¡»e_gc
 = 0x1300,

30 
	mmemg_poŞ_mask
 = 0xFF

33 
	eth»adcouÁ”
 {

35 
	mtc_®loc
,

36 
	mtc_®loc_v®ue
 = 
tc_®loc
,

37 
	mtc_®loc_Ùh”
 = 
tc_®loc
 + 1,

39 
	mtc_gc
,

40 
	mtc_limbo_¦Ùs
,

41 
	mtc_»¶ay_ü—‹_d–
,

42 
	mtc_»¶ay_»move_d–
,

43 
	mtc_roÙ_»Œy
,

44 
	mtc_š‹ºode_»Œy
,

45 
	mtc_Ëaf_»Œy
,

46 
	mtc_Ëaf_w®k
,

48 
	mtc_¡abË
,

49 
	mtc_¡abË_š‹ºode_š£¹
 = 
tc_¡abË
 + 0,

50 
	mtc_¡abË_š‹ºode_¥l™
 = 
tc_¡abË
 + 1,

51 
	mtc_¡abË_Ëaf_š£¹
 = 
tc_¡abË
 + 2,

52 
	mtc_¡abË_Ëaf_¥l™
 = 
tc_¡abË
 + 3,

54 
	mtc_š‹ºode_lock
,

55 
	mtc_Ëaf_lock
,

56 
	mtc_max


	@masstree-beta/mtd.cc

20 
	~<¡dio.h
>

21 
	~<¡d¬g.h
>

22 
	~<ùy³.h
>

23 
	~<¡dlib.h
>

24 
	~<uni¡d.h
>

25 
	~<sys/sock‘.h
>

26 
	~<Ãtš‘/š.h
>

27 
	~<Ãtš‘/tı.h
>

28 
	~<sys/£Ëù.h
>

29 
	~<sys/mmª.h
>

30 
	~<sys/¡©.h
>

31 
	~<lim™s.h
>

32 #ià
HAVE_SYS_EPOLL_H


33 
	~<sys/•Şl.h
>

35 #ià
__lšux__


36 
	~<asm-g’”ic/mmª.h
>

38 
	~<fú.h
>

39 
	~<as£¹.h
>

40 
	~<¡ršg.h
>

41 
	~<±h»ad.h
>

42 
	~<m©h.h
>

43 
	~<sigÇl.h
>

44 
	~<”ºo.h
>

45 #ifdeà
__lšux__


46 
	~<m®loc.h
>

48 
	~"nodev”siÚ.hh
"

49 
	~"kv¡©s.hh
"

50 
	~"jsÚ.hh
"

51 
	~"kv‹¡.hh
"

52 
	~"kv¿ndom.hh
"

53 
	~"şp.h
"

54 
	~"log.hh
"

55 
	~"checkpošt.hh
"

56 
	~"fe.hh
"

57 
	~"kv´Ùo.hh
"

58 
	~"qu”y_mas¡»e.hh
"

59 
	~"mas¡»e_tcursÜ.hh
"

60 
	~"mas¡»e_š£¹.hh
"

61 
	~"mas¡»e_»move.hh
"

62 
	~"mas¡»e_sÿn.hh
"

63 
	~"msg·ck.hh
"

64 
	~<®gÜ™hm
>

65 
	~<deque
>

66 
usšg
 
	glcdf
::
SŒšgAccum
;

68 ’um { 
	mCKS‹_Qu™
, 
	mCKS‹_Unš™
, 
	mCKS‹_R—dy
, 
	mCKS‹_Go
 };

70 vŞ©
boŞ
 
	gtimeout
[2] = {
çl£
, false};

71 
	gdu¿tiÚ
[2] = {10, 0};

73 
	gMas¡»e
::
deçuÉ_bË
 *
Œ“
;

76 
	gud±h»ads
 = 0;

77 
	gtıth»ads
 = 0;

78 
	gnckth»ads
 = 0;

79 
	g‹¡th»ads
 = 0;

80 
	gÆogg”
 = 0;

81 
	g¡d
::
veùÜ
<> 
cÜes
;

83 
boŞ
 
	gloggšg
 = 
Œue
;

84 
boŞ
 
	gpšth»ads
 = 
çl£
;

85 
boŞ
 
	g»cov”y_Úly
 = 
çl£
;

86 vŞ©
ušt64_t
 
	gglob®•och
 = 1;

87 vŞ©
ušt64_t
 
	gaùive_•och
 = 1;

88 
	gpÜt
 = 2117;

89 
ušt64_t
 
	g‹¡_lim™
 = ~uint64_t(0);

90 
	gdİršt
 = 0;

91 
	gkv‹¡_fœ¡_£ed
 = 31949;

93 vŞ©
sig_©omic_t
 
	ggo_qu™
 = 0;

94 
	gqu™_pe
[2];

96 
	g¡d
::
veùÜ
<cÚ¡ *> 
logdœs
;

97 
	g¡d
::
veùÜ
<cÚ¡ *> 
ckpdœs
;

99 
log£t
* 
	glogs
;

100 vŞ©
boŞ
 
	g»cov”šg
 = 
çl£
;

102 
	gcheckpošt_š‹rv®
 = 1000000;

103 
kv•och_t
 
	gckp_g’
 = 0;

104 
ck¡©e
 *
	gcks
 = 
NULL
;

105 
±h»ad_cÚd_t
 
	g»c_cÚd
;

106 
±h»ad_mu‹x_t
 
	g»c_mu
;

107 
	g»c_Çùive
;

108 
	g»c_¡©e
 = 
REC_NONE
;

110 
kvtime¡amp_t
 
	gš™Ÿl_time¡amp
;

112 
±h»ad_cÚd_t
 
	gcheckpošt_cÚd
;

113 
±h»ad_mu‹x_t
 
	gcheckpošt_mu
;

115 
´•¬e_th»ad
(
th»adšfo
 *
ti
);

116 * 
	gtı_th»ad_pes
;

117 * 
tı_th»adfunc
(* 
ti
);

118 * 
udp_th»adfunc
(* 
ti
);

120 
log_š™
();

121 
»cov”
(
th»adšfo
*);

122 
kv•och_t
 
»ad_checkpošt
(
th»adšfo
*, cÚ¡ *
·th
);

124 * 
cÚc_checkpoš‹r
(* 
ti
);

125 
»cov”checkpošt
(
th»adšfo
* 
ti
);

127 *
ÿnûlšg
(*);

128 
ÿtchšt
();

129 
•ochšc
();

132 
	$‹¡_timeout
() {

133 
size_t
 
n
;

134 
n
 = 0;‚ < 
	`¬¿ysize
(
timeout
) &&imeout[n]; ++n)

136 ià(
n
 < 
	`¬¿ysize
(
timeout
)) {

137 
timeout
[
n
] = 
Œue
;

138 ià(
n
 + 1 < 
	`¬¿ysize
(
timeout
è&& 
du¿tiÚ
[n + 1])

139 
	`x®¬m
(
du¿tiÚ
[
n
 + 1]);

141 
	}
}

143 
	skv‹¡_ş›Á
 {

144 
kv‹¡_ş›Á
()

145 : 
checks_
(0), 
kvo_
() {

147 
kv‹¡_ş›Á
(cÚ¡ *
‹¡Çme
)

148 : 
‹¡Çme_
(
‹¡Çme
), 
checks_
(0), 
kvo_
() {

151 
id
() const {

152  
	mti_
->
šdex
();

154 
Áh»ads
() const {

155  
	m‹¡th»ads
;

157 
£t_th»ad
(
th»adšfo
 *
ti
) {

158 
	mti_
 = 
ti
;

160 
»gi¡”_timeouts
(
n
) {

161 
®ways_as£¹
(
n
 <ğ(è
¬¿ysize
(::
timeout
));

162 
	mi
 = 1; i < 
	mn
; ++i)

163 ià(
	mdu¿tiÚ
[
i
] == 0)

164 
du¿tiÚ
[
i
] = 0;

166 
boŞ
 
timeout
(
which
) const {

167  ::
timeout
[
which
];

169 
ušt64_t
 
lim™
() const {

170  
	m‹¡_lim™
;

172 
JsÚ
 
·¿m
(cÚ¡ 
SŒšg
&) const {

173  
JsÚ
();

175 
now
() const {

176  ::
now
();

179 
g‘
(
ikey
, 
SŒ
 *
v®ue
);

180 
g‘
(cÚ¡ 
SŒ
 &
key
);

181 
g‘
(
ikey
) {

182 
quick_i¡r
 
key
(
ikey
);

183 
g‘
(
key
.
¡ršg
());

185 
g‘_check
(cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
ex³ùed
);

186 
g‘_check
(cÚ¡ *
key
, cÚ¡ *
ex³ùed
) {

187 
g‘_check
(
SŒ
(
key
, 
¡¾’
(key)), SŒ(
ex³ùed
, strlen(expected)));

189 
g‘_check
(
ikey
, 
›x³ùed
) {

190 
quick_i¡r
 
key
(
ikey
), 
ex³ùed
(
›x³ùed
);

191 
g‘_check
(
key
.
¡ršg
(), 
ex³ùed
.string());

193 
g‘_check_key8
(
ikey
, 
›x³ùed
) {

194 
quick_i¡r
 
key
(
ikey
, 8), 
ex³ùed
(
›x³ùed
);

195 
g‘_check
(
key
.
¡ršg
(), 
ex³ùed
.string());

197 
g‘_check_key10
(
ikey
, 
›x³ùed
) {

198 
quick_i¡r
 
key
(
ikey
, 10), 
ex³ùed
(
›x³ùed
);

199 
g‘_check
(
key
.
¡ršg
(), 
ex³ùed
.string());

201 
g‘_cŞ_check
(cÚ¡ 
SŒ
 &
key
, 
cŞ
, cÚ¡ SŒ &
ex³ùed
);

202 
g‘_cŞ_check_key10
(
ikey
, 
cŞ
, 
›x³ùed
) {

203 
quick_i¡r
 
key
(
ikey
, 10), 
ex³ùed
(
›x³ùed
);

204 
g‘_cŞ_check
(
key
.
¡ršg
(), 
cŞ
, 
ex³ùed
.string());

206 
boŞ
 
g‘_sync
(
ikey
);

208 
put
(cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
v®ue
);

209 
put
(cÚ¡ *
key
, cÚ¡ *
v®
) {

210 
put
(
SŒ
(
key
, 
¡¾’
(key)), SŒ(
v®
, strlen(val)));

212 
put
(
ikey
, 
iv®ue
) {

213 
quick_i¡r
 
key
(
ikey
), 
v®ue
(
iv®ue
);

214 
put
(
key
.
¡ršg
(), 
v®ue
.string());

216 
put_key8
(
ikey
, 
iv®ue
) {

217 
quick_i¡r
 
key
(
ikey
, 8), 
v®ue
(
iv®ue
);

218 
put
(
key
.
¡ršg
(), 
v®ue
.string());

220 
put_key10
(
ikey
, 
iv®ue
) {

221 
quick_i¡r
 
key
(
ikey
, 10), 
v®ue
(
iv®ue
);

222 
put
(
key
.
¡ršg
(), 
v®ue
.string());

224 
put_cŞ
(cÚ¡ 
SŒ
 &
key
, 
cŞ
, cÚ¡ SŒ &
v®ue
);

225 
put_cŞ_key10
(
ikey
, 
cŞ
, 
iv®ue
) {

226 
quick_i¡r
 
key
(
ikey
, 10), 
v®ue
(
iv®ue
);

227 
put_cŞ
(
key
.
¡ršg
(), 
cŞ
, 
v®ue
.string());

230 
boŞ
 
»move_sync
(
ikey
);

232 
puts_dÚe
() {

234 
wa™_®l
() {

236 
rcu_qu›sû
() {

238 
SŒšg
 
make_mes§ge
(
SŒšgAccum
 &
§
) const;

239 
nÙiû
(cÚ¡ *
fmt
, ...);

240 
ç
(cÚ¡ *
fmt
, ...);

241 cÚ¡ 
	mJsÚ
& 
»pÜt
(cÚ¡ 
JsÚ
& 
x
) {

242  
	m»pÜt_
.
m”ge
(
x
);

244 
fšish
() {

245 
årštf
(
¡d”r
, "%d: %s\n", 
ti_
->
šdex
(), 
»pÜt_
.
uÅ¬£
().
c_¡r
());

247 
th»adšfo
 *
	mti_
;

248 
	mqu”y
<
	mrow_ty³
> 
	mq_
[10];

249 cÚ¡ *
	m‹¡Çme_
;

250 
kv¿ndom_lcg_Ä
 
	m¿nd
;

251 
	mchecks_
;

252 
JsÚ
 
	m»pÜt_
;

253 
kvout
 *
	mkvo_
;

254 vŞ©
	mçšg
;

257 vŞ©
	gkv‹¡_ş›Á
::
çšg
;

259 
	gkv‹¡_ş›Á
::
	$g‘
(
ikey
, 
SŒ
 *
v®ue
)

261 
quick_i¡r
 
	`key
(
ikey
);

262 ià(!
q_
[0].
	`run_g‘1
(
Œ“
->
	`bË
(), 
key
.
	`¡ršg
(), 0, *
v®ue
, *
ti_
))

263 *
v®ue
 = 
	`SŒ
();

264 
	}
}

266 
	gkv‹¡_ş›Á
::
	$g‘
(cÚ¡ 
SŒ
 &
key
)

268 
SŒ
 
v®
;

269 (è
q_
[0].
	`run_g‘1
(
Œ“
->
	`bË
(), 
key
, 0, 
v®
, *
ti_
);

270 
	}
}

272 
	gkv‹¡_ş›Á
::
	$g‘_check
(cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
ex³ùed
)

274 
SŒ
 
v®
;

275 ià(!
q_
[0].
	`run_g‘1
(
Œ“
->
	`bË
(), 
key
, 0, 
v®
, *
ti_
)) {

276 
	`ç
("g‘(%.*sèçed (ex³ùed %.*s)\n", 
key
.
Ën
, key.
s
, 
ex³ùed
.len,ƒxpected.s);

279 ià(
v®
.
Ën
 !ğ
ex³ùed
.ËÀ|| 
	`memcmp
(v®.
s
,ƒxpected.s, val.len) != 0)

280 
	`ç
("g‘(%.*sè»tuºed uÃx³ùed v®u%.* Óx³ùed %.*s)\n", 
key
.
Ën
, key.
s
,

281 
¡d
::
	`mš
(
v®
.
Ën
, 40), v®.
s
, std::mš(
ex³ùed
.len, 40),ƒxpected.s);

283 ++
checks_
;

284 
	}
}

286 
	gkv‹¡_ş›Á
::
	$g‘_cŞ_check
(cÚ¡ 
SŒ
 &
key
, 
cŞ
, cÚ¡ SŒ &
ex³ùed
)

288 
SŒ
 
v®
;

289 ià(!
q_
[0].
	`run_g‘1
(
Œ“
->
	`bË
(), 
key
, 
cŞ
, 
v®
, *
ti_
)) {

290 
	`ç
("g‘.%d(%.*sèçed (ex³ùed %.*s)\n", 
cŞ
, 
key
.
Ën
, key.
s
,

291 
ex³ùed
.
Ën
,ƒx³ùed.
s
);

294 ià(
v®
.
Ën
 !ğ
ex³ùed
.ËÀ|| 
	`memcmp
(v®.
s
,ƒxpected.s, val.len) != 0)

295 
	`ç
("get.%d(%.*s)„eturned unexpected value %.*s (expected %.*s)\n",

296 
cŞ
, 
key
.
Ën
, key.
s
, 
¡d
::
	`mš
(
v®
.len, 40), val.s,

297 
¡d
::
	`mš
(
ex³ùed
.
Ën
, 40),ƒx³ùed.
s
);

299 ++
checks_
;

300 
	}
}

302 
boŞ
 
	gkv‹¡_ş›Á
::
	$g‘_sync
(
ikey
) {

303 
quick_i¡r
 
	`key
(
ikey
);

304 
SŒ
 
v®
;

305  
q_
[0].
	`run_g‘1
(
Œ“
->
	`bË
(), 
key
.
	`¡ršg
(), 0, 
v®
, *
ti_
);

306 
	}
}

308 
	gkv‹¡_ş›Á
::
	$put
(cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
v®ue
) {

309 
çšg
)

311 
q_
[0].
	`run_»¶aû
(
Œ“
->
	`bË
(), 
key
, 
v®ue
, *
ti_
);

312 ià(
ti_
->
	`logg”
())

313 
ti_
->
	`logg”
()->
	`»cÜd
(
logcmd_»¶aû
, 
q_
[0].
	`qu”y_times
(), 
key
, 
v®ue
);

314 
	}
}

316 
	gkv‹¡_ş›Á
::
	$put_cŞ
(cÚ¡ 
SŒ
 &
key
, 
cŞ
, cÚ¡ SŒ &
v®ue
) {

317 
çšg
)

319 #ià!
MASSTREE_ROW_TYPE_STR


320 ià(!
kvo_
)

321 
kvo_
 = 
	`Ãw_kvout
(-1, 2048);

322 
JsÚ
 
»q
[2] = {
	`JsÚ
(
cŞ
), JsÚ(
SŒšg
::
	`make_¡abË
(
v®ue
))};

323 (è
q_
[0].
	`run_put
(
Œ“
->
	`bË
(), 
key
, &
»q
[0], &»q[2], *
ti_
);

324 ià(
ti_
->
	`logg”
())

325 
ti_
->
	`logg”
()->
	`»cÜd
(
logcmd_put
, 
q_
[0].
	`qu”y_times
(), 
key
,

326 &
»q
[0], &req[2]);

328 (è
key
, (è
cŞ
, (è
v®ue
;

329 
	`as£¹
(0);

331 
	}
}

333 
boŞ
 
	gkv‹¡_ş›Á
::
	$»move_sync
(
ikey
) {

334 
quick_i¡r
 
	`key
(
ikey
);

335 
boŞ
 
»moved
 = 
q_
[0].
	`run_»move
(
Œ“
->
	`bË
(), 
key
.
	`¡ršg
(), *
ti_
);

336 ià(
»moved
 && 
ti_
->
	`logg”
())

337 
ti_
->
	`logg”
()->
	`»cÜd
(
logcmd_»move
, 
q_
[0].
	`qu”y_times
(), 
key
.
	`¡ršg
(), 
	`SŒ
());

338  
»moved
;

339 
	}
}

341 
SŒšg
 
	gkv‹¡_ş›Á
::
	$make_mes§ge
(
SŒšgAccum
 &
§
) const {

342 cÚ¡ *
begš
 = 
§
.
	`begš
();

343 
begš
 !ğ
§
.
	`’d
(è&& 
	`is¥aû
(() *begin))

344 ++
begš
;

345 
SŒšg
 
s
 = 
	`SŒšg
(
begš
, 
§
.
	`’d
());

346 ià(!
s
.
	`em±y
(è&& s.
	`back
() != '\n')

347 
s
 += '\n';

348  
s
;

349 
	}
}

351 
	gkv‹¡_ş›Á
::
	$nÙiû
(cÚ¡ *
fmt
, ...) {

352 
va_li¡
 
v®
;

353 
	`va_¡¬t
(
v®
, 
fmt
);

354 
SŒšg
 
m
 = 
	`make_mes§ge
(
	`SŒšgAccum
().
	`v¢´štf
(500, 
fmt
, 
v®
));

355 
	`va_’d
(
v®
);

356 ià(
m
)

357 
	`årštf
(
¡d”r
, "%d: %s", 
ti_
->
	`šdex
(), 
m
.
	`c_¡r
());

358 
	}
}

360 
	gkv‹¡_ş›Á
::
	$ç
(cÚ¡ *
fmt
, ...) {

361 
nodev”siÚ32
 
	`çšg_lock
(
çl£
);

362 
nodev”siÚ32
 
	`ç_mes§ge_lock
(
çl£
);

363 
SŒšg
 
ç_mes§ge
;

364 
çšg
 = 1;

366 
va_li¡
 
v®
;

367 
	`va_¡¬t
(
v®
, 
fmt
);

368 
SŒšg
 
m
 = 
	`make_mes§ge
(
	`SŒšgAccum
().
	`v¢´štf
(500, 
fmt
, 
v®
));

369 
	`va_’d
(
v®
);

370 ià(!
m
)

371 
m
 = "unknown failure";

373 
ç_mes§ge_lock
.
	`lock
();

374 ià(
ç_mes§ge
 !ğ
m
) {

375 
ç_mes§ge
 = 
m
;

376 
	`årštf
(
¡d”r
, "%d: %s", 
ti_
->
	`šdex
(), 
m
.
	`c_¡r
());

378 
ç_mes§ge_lock
.
	`uÆock
();

380 ià(
dİršt
) {

381 
çšg_lock
.
	`lock
();

382 
	`årštf
(
¡dout
, "%d: %s", 
ti_
->
	`šdex
(), 
m
.
	`c_¡r
());

383 
Œ“
->
	`´št
(
¡dout
);

384 
	`fæush
(
¡dout
);

387 
	`®ways_as£¹
(0);

388 
	}
}

390 * 
	$‹¡go
(* 
x
) {

391 
kv‹¡_ş›Á
 *
kc
 = 
»š‹½»t_ÿ¡
<kv‹¡_ş›Á*>(
x
);

392 
kc
->
ti_
->
	`±h»ad
(èğ
	`±h»ad_£lf
();

393 
	`´•¬e_th»ad
(
kc
->
ti_
);

395 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "rw1") == 0)

396 
	`kv‹¡_rw1
(*
kc
);

397 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "rw2") == 0)

398 
	`kv‹¡_rw2
(*
kc
);

399 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "rw3") == 0)

400 
	`kv‹¡_rw3
(*
kc
);

401 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "rw4") == 0)

402 
	`kv‹¡_rw4
(*
kc
);

403 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "rwsmall24") == 0)

404 
	`kv‹¡_rwsm®l24
(*
kc
);

405 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "rwsep24") == 0)

406 
	`kv‹¡_rw£p24
(*
kc
);

407 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "palma") == 0)

408 
	`kv‹¡_·lma
(*
kc
);

409 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "palmb") == 0)

410 
	`kv‹¡_·lmb
(*
kc
);

411 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "rw16") == 0)

412 
	`kv‹¡_rw16
(*
kc
);

413 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "rw5") == 0

414 || 
	`¡rcmp
(
kc
->
‹¡Çme_
, "rw1fixed") == 0)

415 
	`kv‹¡_rw1fixed
(*
kc
);

416 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "ycsbk") == 0)

417 
	`kv‹¡_ycsbk
(*
kc
);

418 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "wd1") == 0)

419 
	`kv‹¡_wd1
(10000000, 1, *
kc
);

420 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "wd1check") == 0)

421 
	`kv‹¡_wd1_check
(10000000, 1, *
kc
);

422 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "w1") == 0)

423 
	`kv‹¡_w1_£ed
(*
kc
, 
kv‹¡_fœ¡_£ed
 + kc->
	`id
());

424 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "r1") == 0)

425 
	`kv‹¡_r1_£ed
(*
kc
, 
kv‹¡_fœ¡_£ed
 + kc->
	`id
());

426 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "wcol1") == 0)

427 
	`kv‹¡_wcŞ1©
(*
kc
, kc->
	`id
(è% 24, 
kv‹¡_fœ¡_£ed
 + kc->id() % 48, 5000000);

428 ià(
	`¡rcmp
(
kc
->
‹¡Çme_
, "rcol1") == 0)

429 
	`kv‹¡_rcŞ1©
(*
kc
, kc->
	`id
(è% 24, 
kv‹¡_fœ¡_£ed
 + kc->id() % 48, 5000000);

431 
kc
->
	`ç
("unknowÀ‹¡ '%s'", kc->
‹¡Çme_
);

433 
	}
}

435 cÚ¡ * cÚ¡ 
	gkv¡©s_Çme
[] = {

439 
	$ruÁe¡
(cÚ¡ *
‹¡Çme
, 
Áh»ads
) {

440 
¡d
::
veùÜ
<
kv‹¡_ş›Á
> 
	`ş›Ás
(
Áh»ads
, 
	`kv‹¡_ş›Á
(
‹¡Çme
));

441 ::
‹¡th»ads
 = 
Áh»ads
;

442 
i
 = 0; i < 
Áh»ads
; ++i)

443 
ş›Ás
[
i
].
	`£t_th»ad
(
th»adšfo
::
	`make
Ñh»adšfo::
TI_PROCESS
, i));

444 
	`bz”o
((*)
timeout
, (timeout));

445 
	`sigÇl
(
SIGALRM
, 
‹¡_timeout
);

446 ià(
du¿tiÚ
[0])

447 
	`x®¬m
(
du¿tiÚ
[0]);

448 
i
 = 0; i < 
Áh»ads
; ++i) {

449 
r
 = 
	`±h»ad_ü—‹
(&
ş›Ás
[
i
].
ti_
->
	`±h»ad
(), 0, 
‹¡go
, &clients[i]);

450 
	`®ways_as£¹
(
r
 == 0);

452 
i
 = 0; i < 
Áh»ads
; ++i)

453 
	`±h»ad_još
(
ş›Ás
[
i
].
ti_
->
	`±h»ad
(), 0);

455 
kv¡©s
 
kvs
[
	`¬¿ysize
(
kv¡©s_Çme
)];

456 
i
 = 0; i < 
Áh»ads
; ++i)

457 
j
 = 0; j < (è
	`¬¿ysize
(
kv¡©s_Çme
); ++j)

458 ià(
x
 = 
ş›Ás
[
i
].
»pÜt_
.
	`g‘_d
(
kv¡©s_Çme
[
j
]))

459 
kvs
[
j
].
	`add
(
x
);

460 
j
 = 0; j < (è
	`¬¿ysize
(
kv¡©s_Çme
); ++j)

461 
kvs
[
j
].
	`´št_»pÜt
(
kv¡©s_Çme
[j]);

462 
	}
}

465 
	scÚn
 {

466 
	mfd
;

467 ’um { 
	mšbufsz
 = 20 * 1024, 
	mšbuäefl
 = 16 * 1024 };

469 
cÚn
(
s
)

470 : 
fd
(
s
), 
šbuf_
(
Ãw
 [
šbufsz
]),

471 
šbuåos_
(0), 
šbuæ’_
(0), 
kvout
(
Ãw_kvout
(
s
, 20 * 1024)),

472 
šbuáÙ®_
(0) {

474 ~
cÚn
() {

475 
şo£
(
fd
);

476 
ä“_kvout
(
kvout
);

477 
	md–‘e
[] 
	mšbuf_
;

478 * 
	mx
 : 
Şdšbuf_
)

479 
d–‘e
[] 
x
;

482 
	mJsÚ
& 
»ûive
() {

483 !
	m·r£r_
.
dÚe
(è&& 
check
(2))

484 
	mšbuåos_
 +ğ
·r£r_
.
cÚsume
(
šbuf_
 + 
šbuåos_
,

485 
šbuæ’_
 - 
šbuåos_
,

486 
SŒšg
::
make_¡abË
(
šbuf_
, 
šbufsz
));

487 ià(
	m·r£r_
.
sucûss
(è&&…¬£r_.
»suÉ
().
is_a
())

488 
	m·r£r_
.
»£t
();

490 
	m·r£r_
.
»suÉ
(èğ
JsÚ
();

491  
	m·r£r_
.
»suÉ
();

494 
check
(
Œyh¬d
) {

495 ià(
	mšbuåos_
 =ğ
šbuæ’_
 && 
Œyh¬d
)

496 
h¬d_check
(
Œyh¬d
);

497  
	mšbuæ’_
 - 
	mšbuåos_
;

500 
ušt64_t
 
xpos™iÚ
() const {

501  
	mšbuáÙ®_
 + 
	mšbuåos_
;

503 
SŒ
 
»ûÁ_¡ršg
(
ušt64_t
 
xpos™iÚ
) const {

504 ià(
	mxpos™iÚ
 - 
	mšbuáÙ®_
 <ğ(
šbuåos_
))

505  
SŒ
(
šbuf_
 + (
xpos™iÚ
 - 
šbuáÙ®_
),

506 
šbuf_
 + 
šbuåos_
);

508  
SŒ
();

511 
	m´iv©e
:

512 * 
šbuf_
;

513 
	mšbuåos_
;

514 
	mšbuæ’_
;

515 
	m¡d
::
veùÜ
<*> 
Şdšbuf_
;

516 
	mmsg·ck
::
¡»amšg_·r£r
 
·r£r_
;

517 
	mpublic
:

518 
kvout
 *kvout;

519 
	m´iv©e
:

520 
ušt64_t
 
šbuáÙ®_
;

522 
h¬d_check
(
Œyh¬d
);

525 
	gcÚn
::
	$h¬d_check
(
Œyh¬d
) {

526 
	`mas¡»e_´ecÚd™iÚ
(
šbuåos_
 =ğ
šbuæ’_
);

527 ià(
·r£r_
.
	`em±y
()) {

528 
šbuáÙ®_
 +ğ
šbuåos_
;

529 
šbuåos_
 = 
šbuæ’_
 = 0;

530 autØ
x
 : 
Şdšbuf_
)

531 
d–‘e
[] 
x
;

532 
Şdšbuf_
.
	`ş—r
();

533 } ià(
šbuåos_
 =ğ
šbufsz
) {

534 
Şdšbuf_
.
	`push_back
(
šbuf_
);

535 
šbuf_
 = 
Ãw
 [
šbufsz
];

536 
šbuáÙ®_
 +ğ
šbuåos_
;

537 
šbuåos_
 = 
šbuæ’_
 = 0;

539 ià(
Œyh¬d
 == 1) {

540 
fd_£t
 
rfds
;

541 
	`FD_ZERO
(&
rfds
);

542 
	`FD_SET
(
fd
, &
rfds
);

543 
timev®
 
tv
 = {0, 0};

544 ià(
	`£Ëù
(
fd
 + 1, &
rfds
, 
NULL
, NULL, &
tv
) <= 0)

547 
	`kvæush
(
kvout
);

549 
ssize_t
 
r
 = 
	`»ad
(
fd
, 
šbuf_
 + 
šbuåos_
, 
šbufsz
 - inbufpos_);

550 ià(
r
 != -1)

551 
šbuæ’_
 +ğ
r
;

552 
	}
}

554 
	scÚnšfo
 {

555 
	ms
;

556 
JsÚ
 
	mhªdshake
;

562 ’um { 
	mşp_v®_suffixdoubË
 = 
CÍ_V®Fœ¡U£r
 };

563 ’um { 
	mİt_nŞog
 = 1, 
	mİt_pš
, 
	mİt_logdœ
, 
	mİt_pÜt
, 
	mİt_ckpdœ
, 
	mİt_du¿tiÚ
,

564 
	mİt_‹¡
, 
	mİt_‹¡_Çme
, 
	mİt_th»ads
, 
	mİt_cÜes
,

565 
	mİt_´št
, 
	mİt_nÜun
, 
	mİt_checkpošt
, 
	mİt_lim™
, 
	mİt_•och_š‹rv®
 };

566 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

567 { "no-log", 0, 
İt_nŞog
, 0, 0 },

568 { 0, 'n', 
İt_nŞog
, 0, 0 },

569 { "no-run", 0, 
İt_nÜun
, 0, 0 },

570 { "pš", 'p', 
İt_pš
, 0, 
CÍ_Neg©e
 },

571 { "logdœ", 0, 
İt_logdœ
, 
CÍ_V®SŒšg
, 0 },

572 { "ld", 0, 
İt_logdœ
, 
CÍ_V®SŒšg
, 0 },

573 { "checkpošt", 'c', 
İt_checkpošt
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 | 
CÍ_Neg©e
 },

574 { "ckp", 0, 
İt_checkpošt
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 | 
CÍ_Neg©e
 },

575 { "ckpdœ", 0, 
İt_ckpdœ
, 
CÍ_V®SŒšg
, 0 },

576 { "ckdœ", 0, 
İt_ckpdœ
, 
CÍ_V®SŒšg
, 0 },

577 { "cd", 0, 
İt_ckpdœ
, 
CÍ_V®SŒšg
, 0 },

578 { "pÜt", 0, 
İt_pÜt
, 
CÍ_V®IÁ
, 0 },

579 { "du¿tiÚ", 'd', 
İt_du¿tiÚ
, 
CÍ_V®DoubË
, 0 },

580 { "lim™", 'l', 
İt_lim™
, 
şp_v®_suffixdoubË
, 0 },

581 { "‹¡", 0, 
İt_‹¡
, 
CÍ_V®SŒšg
, 0 },

582 { "‹¡-rw1", 0, 
İt_‹¡_Çme
, 0, 0 },

583 { "‹¡-rw2", 0, 
İt_‹¡_Çme
, 0, 0 },

584 { "‹¡-rw3", 0, 
İt_‹¡_Çme
, 0, 0 },

585 { "‹¡-rw4", 0, 
İt_‹¡_Çme
, 0, 0 },

586 { "‹¡-rw5", 0, 
İt_‹¡_Çme
, 0, 0 },

587 { "‹¡-rw16", 0, 
İt_‹¡_Çme
, 0, 0 },

588 { "‹¡-·lm", 0, 
İt_‹¡_Çme
, 0, 0 },

589 { "‹¡-ycsbk", 0, 
İt_‹¡_Çme
, 0, 0 },

590 { "‹¡-rw1fixed", 0, 
İt_‹¡_Çme
, 0, 0 },

591 { "th»ads", 'j', 
İt_th»ads
, 
CÍ_V®IÁ
, 0 },

592 { "cÜes", 0, 
İt_cÜes
, 
CÍ_V®SŒšg
, 0 },

593 { "´št", 0, 
İt_´št
, 0, 
CÍ_Neg©e
 },

594 { "•och-š‹rv®", 0, 
İt_•och_š‹rv®
, 
CÍ_V®DoubË
, 0 }

598 
	$maš
(
¬gc
, *
¬gv
[])

600 
usšg
 
¡d
::
sw­
;

601 
s
, 
»t
, 
yes
 = 1, 
i
 = 1, 
fœ¡cÜe
 = -1, 
cÜe¡ride
 = 1;

602 cÚ¡ *
dÙe¡
 = 0;

603 
Æogg”
 = 
tıth»ads
 = 
ud±h»ads
 = 
nckth»ads
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

604 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, (è
	`¬¿ysize
(
İtiÚs
), options);

605 
	`CÍ_AddTy³
(
şp
, 
şp_v®_suffixdoubË
, 
CÍ_Di§ÎowO±iÚs
, 
şp_·r£_suffixdoubË
, 0);

606 
İt
;

607 
•och_š‹rv®_ms
 = 1000;

608 (
İt
 = 
	`CÍ_Next
(
şp
)) >= 0) {

609 
İt
) {

610 
İt_nŞog
:

611 
loggšg
 = 
çl£
;

613 
İt_pš
:

614 
pšth»ads
 = !
şp
->
Ãg©ed
;

616 
İt_th»ads
:

617 
Æogg”
 = 
tıth»ads
 = 
ud±h»ads
 = 
nckth»ads
 = 
şp
->
v®
.
i
;

619 
İt_logdœ
: {

620 cÚ¡ *
s
 = 
	`¡¹ok
((*è
şp
->
v¡r
, ",");

621 ; 
s
; s = 
	`¡¹ok
(
NULL
, ","))

622 
logdœs
.
	`push_back
(
s
);

625 
İt_ckpdœ
: {

626 cÚ¡ *
s
 = 
	`¡¹ok
((*è
şp
->
v¡r
, ",");

627 ; 
s
; s = 
	`¡¹ok
(
NULL
, ","))

628 
ckpdœs
.
	`push_back
(
s
);

631 
İt_checkpošt
:

632 ià(
şp
->
Ãg©ed
 || (şp->
have_v®
 && cÍ->
v®
.
d
 <= 0))

633 
checkpošt_š‹rv®
 = -1;

634 ià(
şp
->
have_v®
)

635 
checkpošt_š‹rv®
 = 
şp
->
v®
.
d
;

637 
checkpošt_š‹rv®
 = 30;

639 
İt_pÜt
:

640 
pÜt
 = 
şp
->
v®
.
i
;

642 
İt_du¿tiÚ
:

643 
du¿tiÚ
[0] = 
şp
->
v®
.
d
;

645 
İt_lim™
:

646 
‹¡_lim™
 = (
ušt64_t
è
şp
->
v®
.
d
;

648 
İt_‹¡
:

649 
dÙe¡
 = 
şp
->
v¡r
;

651 
İt_‹¡_Çme
:

652 
dÙe¡
 = 
şp
->
İtiÚ
->
lÚg_Çme
 + 5;

654 
İt_´št
:

655 
dİršt
 = !
şp
->
Ãg©ed
;

657 
İt_cÜes
:

658 ià(
fœ¡cÜe
 >ğ0 || 
cÜes
.
	`size
() > 0) {

659 
	`CÍ_O±iÚE¼Ü
(
şp
, "%<%O%>‡lready given");

660 
	`ex™
(
EXIT_FAILURE
);

662 cÚ¡ *
¶us
 = 
	`¡rchr
(
şp
->
v¡r
, '+');

663 
JsÚ
 
ij
 = JsÚ::
	`·r£
(
şp
->
v¡r
),

664 
aj
 = 
JsÚ
::
	`·r£
(
	`SŒšg
("["è+ SŒšg(
şp
->
v¡r
) + String("]")),

665 
pj1
 = 
JsÚ
::
	`·r£
(
¶us
 ? 
	`SŒšg
(
şp
->
v¡r
,…lus) : "x"),

666 
pj2
 = 
JsÚ
::
	`·r£
(
¶us
 ? 
	`SŒšg
(plus + 1) : "x");

667 
i
 = 0; 
aj
 && i <‡j.
	`size
(); ++i)

668 ià(!
aj
[
i
].
	`is_št
(è||‡j[i].
	`to_i
() < 0)

669 
aj
 = 
	`JsÚ
();

670 ià(
ij
 && ij.
	`is_št
(è&& ij.
	`to_i
() >= 0)

671 
fœ¡cÜe
 = 
ij
.
	`to_i
(), 
cÜe¡ride
 = 1;

672 ià(
pj1
 && 
pj2
 &&…j1.
	`is_št
(è&&…j1.
	`to_i
() >= 0 &&…j2.is_int())

673 
fœ¡cÜe
 = 
pj1
.
	`to_i
(), 
cÜe¡ride
 = 
pj2
.to_i();

674 ià(
aj
) {

675 
i
 = 0; i < 
aj
.
	`size
(); ++i)

676 
cÜes
.
	`push_back
(
aj
[
i
].
	`to_i
());

678 
	`CÍ_O±iÚE¼Ü
(
şp
, "bad %<%O%>,ƒxpected %<CORE1%>, %<CORE1+STRIDE%>, or %<CORE1,CORE2,...%>");

679 
	`ex™
(
EXIT_FAILURE
);

683 
İt_nÜun
:

684 
»cov”y_Úly
 = 
Œue
;

686 
İt_•och_š‹rv®
:

687 
•och_š‹rv®_ms
 = 
şp
->
v®
.
d
;

690 
	`årštf
(
¡d”r
, "Usage: mtd [-np] [--ld dir1[,dir2,...]] [--cd dir1[,dir2,...]]\n");

691 
	`ex™
(
EXIT_FAILURE
);

694 
	`CÍ_D–‘eP¬£r
(
şp
);

695 ià(
logdœs
.
	`em±y
())

696 
logdœs
.
	`push_back
(".");

697 ià(
ckpdœs
.
	`em±y
())

698 
ckpdœs
.
	`push_back
(".");

699 ià(
fœ¡cÜe
 < 0)

700 
fœ¡cÜe
 = 
cÜes
.
	`size
(è? cÜes.
	`back
() + 1 : 0;

701 ; (è
cÜes
.
	`size
(è< 
ud±h»ads
; 
fœ¡cÜe
 +ğ
cÜe¡ride
)

702 
cÜes
.
	`push_back
(
fœ¡cÜe
);

705 
	`sigÇl
(
SIGINT
, 
ÿtchšt
);

708 
glob®_log_•och
 = 1;

709 
glob®_wake_•och
 = 0;

710 
log_•och_š‹rv®
.
tv_£c
 = 0;

711 
log_•och_š‹rv®
.
tv_u£c
 = 200000;

714 ià(!
dÙe¡
) {

715 ià(!
•och_š‹rv®_ms
) {

716 
	`´štf
("WARNING:ƒpoch interval is 0, it means‚o GC isƒxecuted\n");

718 
	`sigÇl
(
SIGALRM
, 
•ochšc
);

719 
™im”v®
 
‘im”
;

720 
‘im”
.
™_š‹rv®
.
tv_£c
 = 
•och_š‹rv®_ms
 / 1000;

721 
‘im”
.
™_š‹rv®
.
tv_u£c
 = 
	`fmod
(
•och_š‹rv®_ms
, 1000) * 1000;

722 
‘im”
.
™_v®ue
.
tv_£c
 = 
•och_š‹rv®_ms
 / 1000;

723 
‘im”
.
™_v®ue
.
tv_u£c
 = 
	`fmod
(
•och_š‹rv®_ms
, 1000) * 1000;

724 
»t
 = 
	`£t™im”
(
ITIMER_REAL
, &
‘im”
, 
NULL
);

725 
	`®ways_as£¹
(
»t
 == 0);

730 
»t
 = 
	`±h»ad_cÚd_š™
(&
»c_cÚd
, 0);

731 
	`®ways_as£¹
(
»t
 == 0);

732 
»t
 = 
	`±h»ad_mu‹x_š™
(&
»c_mu
, 0);

733 
	`®ways_as£¹
(
»t
 == 0);

736 
»t
 = 
	`±h»ad_cÚd_š™
(&
checkpošt_cÚd
, 0);

737 
	`®ways_as£¹
(
»t
 == 0);

738 
»t
 = 
	`±h»ad_mu‹x_š™
(&
checkpošt_mu
, 0);

739 
	`®ways_as£¹
(
»t
 == 0);

741 
th»adšfo
 *
maš_ti
 =h»adšfo::
	`make
Ñh»adšfo::
TI_MAIN
, -1);

742 
maš_ti
->
	`±h»ad
(èğ
	`±h»ad_£lf
();

744 
š™Ÿl_time¡amp
 = 
	`time¡amp
();

745 
Œ“
 = 
Ãw
 
Mas¡»e
::
deçuÉ_bË
;

746 
Œ“
->
	`š™Ÿlize
(*
maš_ti
);

747 
	`´štf
("%s, %s,…š-th»ad %s, ", 
Œ“
->
	`Çme
(), 
row_ty³
::name(),

748 
pšth»ads
 ? "enabled" : "disabled");

749 if(
loggšg
){

750 
	`´štf
("loggingƒnabled\n");

751 
	`log_š™
();

752 
	`»cov”
(
maš_ti
);

754 
	`´štf
("logging disabled\n");

758 ià(
ud±h»ads
 == 0)

759 
	`´štf
("0 udphreads\n");

760 ià(
ud±h»ads
 == 1)

761 
	`´štf
("1 ud°th»ad (pÜˆ%d)\n", 
pÜt
);

763 
	`´štf
("%d ud°th»ad ÕÜt %d-%d)\n", 
ud±h»ads
, 
pÜt
,…ort + udpthreads - 1);

764 
i
 = 0; i < 
ud±h»ads
; i++){

765 
th»adšfo
 *
ti
 =h»adšfo::
	`make
Ñh»adšfo::
TI_PROCESS
, 
i
);

766 
»t
 = 
	`±h»ad_ü—‹
(&
ti
->
	`±h»ad
(), 0, 
udp_th»adfunc
,i);

767 
	`®ways_as£¹
(
»t
 == 0);

770 ià(
dÙe¡
) {

771 ià(
	`¡rcmp
(
dÙe¡
, "palm") == 0) {

772 
	`ruÁe¡
("palma", 1);

773 
	`ruÁe¡
("·lmb", 
tıth»ads
);

775 
	`ruÁe¡
(
dÙe¡
, 
tıth»ads
);

776 
Œ“
->
	`¡©s
(
¡d”r
);

777 ià(
dİršt
)

778 
Œ“
->
	`´št
(
¡dout
);

779 
	`ex™
(0);

784 
s
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 0);

785 
	`®ways_as£¹
(
s
 >= 0);

786 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
yes
, (yes));

787 
	`£tsockİt
(
s
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
yes
, (yes));

789 
sockaddr_š
 
sš
;

790 
sš
.
sš_çmy
 = 
AF_INET
;

791 
sš
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

792 
sš
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

793 
»t
 = 
	`bšd
(
s
, (
sockaddr
 *è&
sš
, (sin));

794 ià(
»t
 < 0) {

795 
	`³¼Ü
("bind");

796 
	`ex™
(
EXIT_FAILURE
);

799 
»t
 = 
	`li¡’
(
s
, 100);

800 ià(
»t
 < 0) {

801 
	`³¼Ü
("listen");

802 
	`ex™
(
EXIT_FAILURE
);

805 
th»adšfo
 **
tıti
 = 
Ãw
h»adšfØ*[
tıth»ads
];

806 
tı_th»ad_pes
 = 
Ãw
 [
tıth»ads
 * 2];

807 
	`´štf
("%dıh»ad ÕÜˆ%d)\n", 
tıth»ads
, 
pÜt
);

808 
i
 = 0; i < 
tıth»ads
; i++){

809 
th»adšfo
 *
ti
 =h»adšfo::
	`make
Ñh»adšfo::
TI_PROCESS
, 
i
);

810 
»t
 = 
	`pe
(&
tı_th»ad_pes
[
i
 * 2]);

811 
	`®ways_as£¹
(
»t
 == 0);

812 
»t
 = 
	`±h»ad_ü—‹
(&
ti
->
	`±h»ad
(), 0, 
tı_th»adfunc
,i);

813 
	`®ways_as£¹
(
»t
 == 0);

814 
tıti
[
i
] = 
ti
;

817 
»t
 = 
	`pe
(
qu™_pe
);

818 
	`®ways_as£¹
(
»t
 == 0);

819 
±h»ad_t
 
ÿnûlšg_tid
;

820 
»t
 = 
	`±h»ad_ü—‹
(&
ÿnûlšg_tid
, 
NULL
, 
ÿnûlšg
, NULL);

821 
	`®ways_as£¹
(
»t
 == 0);

823 
Ãxt
 = 0;

825 
s1
;

826 
sockaddr_š
 
sš1
;

827 
sockËn_t
 
sšËn
 = (
sš1
);

829 
	`bz”o
(&
sš1
, (sin1));

830 
s1
 = 
	`acû±
(
s
, (
sockaddr
 *è&
sš1
, &
sšËn
);

831 
	`®ways_as£¹
(
s1
 >= 0);

832 
	`£tsockİt
(
s1
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
yes
, (yes));

835 
buf
[
BUFSIZ
];

836 
ssize_t
 
Ä
 = 
	`»ad
(
s1
, 
buf
, 
BUFSIZ
);

837 ià(
Ä
 == -1) {

838 
	`³¼Ü
("read");

839 
kl_cÚÃùiÚ
:

840 
	`şo£
(
s1
);

844 
msg·ck
::
¡»amšg_·r£r
 
¥
;

845 ià(
Ä
 =ğ0 || 
¥
.
	`cÚsume
(
buf
,‚rè!ğ(
size_t
)‚r

846 || !
¥
.
	`»suÉ
().
	`is_a
(è|| sp.»suÉ().
	`size
() < 2

847 || !
¥
.
	`»suÉ
()[1].
	`is_i
(è|| sp.»suÉ()[1].
	`as_i
(è!ğ
Cmd_Hªdshake
) {

848 
	`årštf
(
¡d”r
, "failed handshake\n");

849 
kl_cÚÃùiÚ
;

852 
rg‘_cÜe
 = -1;

853 ià(
¥
.
	`»suÉ
().
	`size
(è>ğ3 && sp.»suÉ()[2].
	`is_o
()

854 && 
¥
.
	`»suÉ
()[2]["cÜe"].
	`is_i
())

855 
rg‘_cÜe
 = 
¥
.
	`»suÉ
()[2]["cÜe"].
	`as_i
();

856 ià(
rg‘_cÜe
 < 0 ||¬g‘_cÜ>ğ
tıth»ads
) {

857 
rg‘_cÜe
 = 
Ãxt
 % 
tıth»ads
;

858 ++
Ãxt
;

861 
cÚnšfo
* 
ci
 = 
Ãw
 conninfo;

862 
ci
->
s
 = 
s1
;

863 
	`sw­
(
ci
->
hªdshake
, 
¥
.
	`»suÉ
());

865 
ssize_t
 
w
 = 
	`wr™e
(
tı_th»ad_pes
[2*
rg‘_cÜe
 + 1], &
ci
, (ci));

866 
	`®ways_as£¹
((
size_t
è
w
 =ğ(
ci
));

868 
	}
}

871 
	$ÿtchšt
()

873 
go_qu™
 = 1;

874 
cmd
 = 0;

876 
r
 = 
	`wr™e
(
qu™_pe
[1], &
cmd
, (cmd));

877 ()
r
;

878 
	}
}

880 
šlše
 cÚ¡ *
	$th»adty³
(
ty³
) {

881 
ty³
) {

882 
th»adšfo
::
TI_MAIN
:

884 
th»adšfo
::
TI_PROCESS
:

886 
th»adšfo
::
TI_LOG
:

888 
th»adšfo
::
TI_CHECKPOINT
:

891 
	`®ways_as£¹
(0 && "Unknownhreadtype");

894 
	}
}

897 
	$ÿnûlšg
(*)

899 
cmd
;

900 
r
 = 
	`»ad
(
qu™_pe
[0], &
cmd
, (cmd));

901 (è
r
;

902 
	`as£¹
(
r
 =ğ(
cmd
) && cmd == 0);

904 
	`±h»ad_mu‹x_lock
(&
checkpošt_mu
);

905 
	`±h»ad_cÚd_sigÇl
(&
checkpošt_cÚd
);

906 
	`±h»ad_mu‹x_uÆock
(&
checkpošt_mu
);

908 
	`årštf
(
¡d”r
, "\n");

911 
th»adšfo
 *
ti
 =h»adšfo::
®Éh»ads
;i;˜ğti->
	`Ãxt
())

912 ià(
ti
->
	`pu½o£
(è!ğ
th»adšfo
::
TI_MAIN


913 && 
ti
->
	`pu½o£
(è!ğ
th»adšfo
::
TI_CHECKPOINT
) {

914 
r
 = 
	`±h»ad_ÿnûl
(
ti
->
	`±h»ad
());

915 
	`®ways_as£¹
(
r
 == 0);

919 
th»adšfo
 *
ti
 =h»adšfo::
®Éh»ads
;i;˜ğti->
	`Ãxt
())

920 ià(
ti
->
	`pu½o£
(è!ğ
th»adšfo
::
TI_MAIN
) {

921 
	`årštf
(
¡d”r
, "joininghread %s:%d\n",

922 
	`th»adty³
(
ti
->
	`pu½o£
()),i->
	`šdex
());

923 
r
 = 
	`±h»ad_još
(
ti
->
	`±h»ad
(), 0);

924 
	`®ways_as£¹
(
r
 == 0);

926 
Œ“
->
	`¡©s
(
¡d”r
);

927 
	`ex™
(0);

928 
	}
}

931 
	$•ochšc
()

933 
glob®•och
 += 2;

934 
aùive_•och
 = 
th»adšfo
::
	`mš_aùive_•och
();

935 
	}
}

938 
	$hªdshake
(
JsÚ
& 
»que¡
, 
th»adšfo
& 
ti
) {

939 
	`®ways_as£¹
(
»que¡
.
	`is_a
(è&&„eque¡.
	`size
() >= 2

940 && 
»que¡
[1].
	`is_i
(è&&„eque¡[1].
	`as_i
(è=ğ
Cmd_Hªdshake


941 && (
»que¡
.
	`size
(è=ğ2 ||„eque¡[2].
	`is_o
()));

942 ià(
»que¡
.
	`size
() >= 2

943 && 
»que¡
[2]["maxkeyËn"].
	`is_i
()

944 && 
»que¡
[2]["maxkeyËn"].
	`as_i
(è> 
MASSTREE_MAXKEYLEN
) {

945 
»que¡
[2] = 
çl£
;

946 
»que¡
[3] = "bad maxkeylen";

947 
»que¡
.
	`»size
(4);

949 
»que¡
[2] = 
Œue
;

950 
»que¡
[3] = 
ti
.
	`šdex
();

951 
»que¡
[4] = 
row_ty³
::
	`Çme
();

952 
»que¡
.
	`»size
(5);

954 
»que¡
[1] = 
Cmd_Hªdshake
 + 1;

955  
»que¡
[2].
	`as_b
() ? 1 : -1;

956 
	}
}

959 
Úego
(
qu”y
<
row_ty³
>& 
q
, 
JsÚ
& 
»que¡
, 
SŒ
 
»que¡_¡r
, 
th»adšfo
& 
ti
) {

960 
	gcommªd
 = 
»que¡
[1].
as_i
();

961 ià(
	gcommªd
 =ğ
Cmd_Checkpošt
) {

963 
±h»ad_mu‹x_lock
(&
checkpošt_mu
);

964 
±h»ad_cÚd_brßdÿ¡
(&
checkpošt_cÚd
);

965 
±h»ad_mu‹x_uÆock
(&
checkpošt_mu
);

966 
	g»que¡
.
»size
(2);

967 } ià(
	gcommªd
 =ğ
Cmd_G‘
) {

968 
q
.
run_g‘
(
Œ“
->
bË
(), 
»que¡
, 
ti
);

969 } ià(
	gcommªd
 =ğ
Cmd_Put
 && 
»que¡
.
size
() > 3

970 && (
»que¡
.
size
() % 2) == 1) {

971 
SŒ
 
key
(
»que¡
[2].
as_s
());

972 cÚ¡ 
JsÚ
* 
	g»q
 = 
»que¡
.
¬¿y_d©a
() + 3;

973 cÚ¡ 
JsÚ
* 
	g’d_»q
 = 
»que¡
.
’d_¬¿y_d©a
();

974 
	g»que¡
[2] = 
q
.
run_put
(
Œ“
->
bË
(), 
»que¡
[2].
as_s
(),

975 
»q
, 
’d_»q
, 
ti
);

976 ià(
	gti
.
logg”
(è&& 
	g»que¡_¡r
) {

978 
	gmsg·ck
::
·r£r
 
mp
(
»que¡_¡r
.
d©a
());

979 
	gmp
.
sk_¬¿y_size
().
sk_´im™ives
(3);

980 
	gti
.
logg”
()->
»cÜd
(
logcmd_put
, 
q
.
qu”y_times
(), 
key
, 
SŒ
(
mp
.
pos™iÚ
(), 
»que¡_¡r
.
’d
()));

981 } ià(
	gti
.
logg”
())

982 
	gti
.
logg”
()->
»cÜd
(
logcmd_put
, 
q
.
qu”y_times
(), 
key
, 
»q
, 
’d_»q
);

983 
	g»que¡
.
»size
(3);

984 } ià(
	gcommªd
 =ğ
Cmd_R•Ïû
) {

985 
SŒ
 
key
(
»que¡
[2].
as_s
()), 
v®ue
(request[3].as_s());

986 
	g»que¡
[2] = 
q
.
run_»¶aû
(
Œ“
->
bË
(), 
key
, 
v®ue
, 
ti
);

987 ià(
	gti
.
logg”
())

988 
	gti
.
logg”
()->
»cÜd
(
logcmd_»¶aû
, 
q
.
qu”y_times
(), 
key
, 
v®ue
);

989 
	g»que¡
.
»size
(3);

990 } ià(
	gcommªd
 =ğ
Cmd_Remove
) {

991 
SŒ
 
key
(
»que¡
[2].
as_s
());

992 
boŞ
 
	g»moved
 = 
q
.
run_»move
(
Œ“
->
bË
(), 
key
, 
ti
);

993 ià(
	g»moved
 && 
	gti
.
logg”
())

994 
	gti
.
logg”
()->
»cÜd
(
logcmd_»move
, 
q
.
qu”y_times
(), 
key
, 
SŒ
());

995 
	g»que¡
[2] = 
»moved
;

996 
	g»que¡
.
»size
(3);

997 } ià(
	gcommªd
 =ğ
Cmd_Sÿn
) {

998 
q
.
run_sÿn
(
Œ“
->
bË
(), 
»que¡
, 
ti
);

1000 
	g»que¡
[1] = -1;

1001 
	g»que¡
.
»size
(2);

1004 
	g»que¡
[1] = 
commªd
 + 1;

1008 #ià
HAVE_SYS_EPOLL_H


1009 
	stıfds
 {

1010 
	m•Şlfd
;

1012 
tıfds
(
pefd
) {

1013 
	m•Şlfd
 = 
•Şl_ü—‹
(10);

1014 ià(
	m•Şlfd
 < 0) {

1015 
³¼Ü
("epoll_create");

1016 
ex™
(
EXIT_FAILURE
);

1018 
•Şl_ev’t
 
	mev
;

1019 
	mev
.
	mev’ts
 = 
EPOLLIN
;

1020 
	mev
.
	md©a
.
	m±r
 = (*) 1;

1021 
	mr
 = 
•Şl_ùl
(
•Şlfd
, 
EPOLL_CTL_ADD
, 
pefd
, &
ev
);

1022 
®ways_as£¹
(
r
 == 0);

1025 ’um { 
	mmax_ev’ts
 = 100 };

1026 
•Şl_ev’t
 
	tev’t£t
[
max_ev’ts
];

1027 
wa™
(
ev’t£t
 &
es
) {

1028  
•Şl_wa™
(
•Şlfd
, 
es
, 
max_ev’ts
, -1);

1031 
cÚn
 *
ev’t_cÚn
(
ev’t£t
 &
es
, 
i
) const {

1032  (
	mcÚn
 *è
	mes
[
i
].
	md©a
.
	m±r
;

1035 
add
(
fd
, 
cÚn
 *
c
) {

1036 
•Şl_ev’t
 
	mev
;

1037 
	mev
.
	mev’ts
 = 
EPOLLIN
;

1038 
	mev
.
	md©a
.
	m±r
 = 
c
;

1039 
	mr
 = 
•Şl_ùl
(
•Şlfd
, 
EPOLL_CTL_ADD
, 
fd
, &
ev
);

1040 
®ways_as£¹
(
r
 == 0);

1043 
»move
(
fd
) {

1044 
	mr
 = 
•Şl_ùl
(
•Şlfd
, 
EPOLL_CTL_DEL
, 
fd
, 
NULL
);

1045 
®ways_as£¹
(
r
 == 0);

1049 şas 
	ctıfds
 {

1050 
	mnfds_
;

1051 
fd_£t
 
	mrfds_
;

1052 
	m¡d
::
veùÜ
<
cÚn
 *> 
cÚns_
;

1054 
	mpublic
:

1055 
	$tıfds
(
pefd
)

1056 : 
	`nfds_
(
pefd
 + 1) {

1057 
	`®ways_as£¹
(
pefd
 < 
FD_SETSIZE
);

1058 
	`FD_ZERO
(&
rfds_
);

1059 
	`FD_SET
(
pefd
, &
rfds_
);

1060 
cÚns_
.
	`»size
(
nfds_
, 0);

1061 
cÚns_
[
pefd
] = (
cÚn
 *) 1;

1064 
fd_£t
 
	tev’t£t
;

1065 
	$wa™
(
ev’t£t
 &
es
) {

1066 
es
 = 
rfds_
;

1067 
r
 = 
	`£Ëù
(
nfds_
, &
es
, 0, 0, 0);

1068  
r
 > 0 ? 
nfds_
 :„;

1069 
	}
}

1071 
cÚn
 *
	$ev’t_cÚn
(
ev’t£t
 &
es
, 
i
) const {

1072  
	`FD_ISSET
(
i
, &
es
è? 
cÚns_
[i] : 0;

1073 
	}
}

1075 
	$add
(
fd
, 
cÚn
 *
c
) {

1076 
	`®ways_as£¹
(
fd
 < 
FD_SETSIZE
);

1077 
	`FD_SET
(
fd
, &
rfds_
);

1078 ià(
fd
 >ğ
nfds_
) {

1079 
nfds_
 = 
fd
 + 1;

1080 
cÚns_
.
	`»size
(
nfds_
, 0);

1082 
cÚns_
[
fd
] = 
c
;

1083 
	}
}

1085 
	$»move
(
fd
) {

1086 
	`®ways_as£¹
(
fd
 < 
FD_SETSIZE
);

1087 
	`FD_CLR
(
fd
, &
rfds_
);

1088 ià(
fd
 =ğ
nfds_
 - 1) {

1089 
nfds_
 > 0 && !
	`FD_ISSET
Òfds_ - 1, &
rfds_
))

1090 --
nfds_
;

1092 
	}
}

1096 
	$´•¬e_th»ad
(
th»adšfo
 *
ti
) {

1097 #ià
__lšux__


1098 ià(
pšth»ads
) {

1099 
ıu_£t_t
 
cs
;

1100 
	`CPU_ZERO
(&
cs
);

1101 
	`CPU_SET
(
cÜes
[
ti
->
	`šdex
()], &
cs
);

1102 
	`®ways_as£¹
(
	`sched_£ffš™y
(0, (
cs
), &cs) == 0);

1105 
	`®ways_as£¹
(!
pšth»ads
 && "pinthreads‚ot supported\n");

1107 ià(
loggšg
)

1108 
ti
->
	`£t_logg”
(&
logs
->
	`log
Ñi->
	`šdex
(è% 
Æogg”
));

1109 
	}
}

1111 * 
	$tı_th»adfunc
(* 
x
) {

1112 
th»adšfo
* 
ti
 = 
»š‹½»t_ÿ¡
<th»adšfo*>(
x
);

1113 
ti
->
	`±h»ad
(èğ
	`±h»ad_£lf
();

1114 
	`´•¬e_th»ad
(
ti
);

1116 
myfd
 = 
tı_th»ad_pes
[2 * 
ti
->
	`šdex
()];

1117 
tıfds
 
	`¦oİ
(
myfd
);

1118 
tıfds
::
ev’t£t
 
ev’ts
;

1119 
¡d
::
deque
<
cÚn
*> 
»ady
;

1120 
qu”y
<
row_ty³
> 
q
;

1123 
Ãv
 = 
¦oİ
.
	`wa™
(
ev’ts
);

1124 
i
 = 0; i < 
Ãv
; i++)

1125 ià(
cÚn
 *
c
 = 
¦oİ
.
	`ev’t_cÚn
(
ev’ts
, 
i
))

1126 
»ady
.
	`push_back
(
c
);

1128 !
»ady
.
	`em±y
()) {

1129 
cÚn
* 
c
 = 
»ady
.
	`äÚt
();

1130 
»ady
.
	`pİ_äÚt
();

1132 ià(
c
 =ğ(
cÚn
 *) 1) {

1134 
	#MAX_NEWCONN
 100

	)

1135 
cÚnšfo
* 
ci
[
MAX_NEWCONN
];

1136 
ssize_t
 
Ën
 = 
	`»ad
(
myfd
, 
ci
, (ci));

1137 
	`®ways_as£¹
(
Ën
 > 0 &&†en % () == 0);

1138 
j
 = 0; j * (*
ci
è< (
size_t
è
Ën
; ++j) {

1139 
cÚn
 *
c
 = 
Ãw
 
	`cÚn
(
ci
[
j
]->
s
);

1140 
¦oİ
.
	`add
(
c
->
fd
, c);

1141 
»t
 = 
	`hªdshake
(
ci
[
j
]->
hªdshake
, *
ti
);

1142 
msg·ck
::
	`uÅ¬£
(*
c
->
kvout
, 
ci
[
j
]->
hªdshake
);

1143 
	`kvæush
(
c
->
kvout
);

1144 ià(
»t
 < 0) {

1145 
¦oİ
.
	`»move
(
c
->
fd
);

1146 
d–‘e
 
c
;

1148 
d–‘e
 
ci
[
j
];

1150 } ià(
c
) {

1152 
ušt64_t
 
xpos™iÚ
 = 
c
->
	`xpos™iÚ
();

1153 
JsÚ
& 
»que¡
 = 
c
->
	`»ûive
();

1154 
»t
;

1155 ià(
	`uÆik–y
(!
»que¡
))

1156 
şo£d
;

1157 
ti
->
	`rcu_¡¬t
();

1158 
»t
 = 
	`Úego
(
q
, 
»que¡
, 
c
->
	`»ûÁ_¡ršg
(
xpos™iÚ
), *
ti
);

1159 
ti
->
	`rcu_¡İ
();

1160 
msg·ck
::
	`uÅ¬£
(*
c
->
kvout
, 
»que¡
);

1161 
»que¡
.
	`ş—r
();

1162 ià(
	`lik–y
(
»t
 >= 0)) {

1163 ià(
c
->
	`check
(0))

1164 
»ady
.
	`push_back
(
c
);

1166 
	`kvæush
(
c
->
kvout
);

1169 
	`´štf
("socket„eadƒrror\n");

1170 
şo£d
:

1171 
	`kvæush
(
c
->
kvout
);

1172 
¦oİ
.
	`»move
(
c
->
fd
);

1173 
d–‘e
 
c
;

1178 
	}
}

1181 * 
	$udp_th»adfunc
(* 
x
) {

1182 
th»adšfo
* 
ti
 = 
»š‹½»t_ÿ¡
<th»adšfo*>(
x
);

1183 
ti
->
	`±h»ad
(èğ
	`±h»ad_£lf
();

1184 
	`´•¬e_th»ad
(
ti
);

1186 
sockaddr_š
 
sš
;

1187 
	`bz”o
(&
sš
, (sin));

1188 
sš
.
sš_çmy
 = 
AF_INET
;

1189 
sš
.
sš_pÜt
 = 
	`htÚs
(
pÜt
 + 
ti
->
	`šdex
());

1191 
s
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

1192 
	`®ways_as£¹
(
s
 >= 0);

1193 
»t
 = 
	`bšd
(
s
, (
sockaddr
 *è&
sš
, (sin));

1194 
	`®ways_as£¹
(
»t
 == 0 && "bind failed");

1195 
sobuæ’
 = 512*1024;

1196 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
sobuæ’
, (sobuflen));

1198 
SŒšg
 
buf
 = SŒšg::
	`make_unš™Ÿlized
(4096);

1199 
kvout
 *kvouˆğ
	`Ãw_bufkvout
();

1200 
msg·ck
::
¡»amšg_·r£r
 
·r£r
;

1201 
SŒšgAccum
 
§
;

1203 
qu”y
<
row_ty³
> 
q
;

1205 
sockaddr_š
 
sš
;

1206 
sockËn_t
 
sšËn
 = (
sš
);

1207 
ssize_t
 
cc
 = 
	`»cväom
(
s
, 
cÚ¡_ÿ¡
<*>(
buf
.
	`d©a
()), buf.
	`Ëngth
(),

1208 0, (
sockaddr
 *è&
sš
, &
sšËn
);

1209 if(
cc
 < 0){

1210 
	`³¼Ü
("udpgo„ead");

1211 
	`ex™
(
EXIT_FAILURE
);

1213 
	`kvout_»£t
(
kvout
);

1215 
·r£r
.
	`»£t
();

1216 
cÚsumed
 = 
·r£r
.
	`cÚsume
(
buf
.
	`d©a
(), buf.
	`Ëngth
(), buf);

1219 ià(
·r£r
.
	`sucûss
(è&&…¬£r.
	`»suÉ
().
	`is_a
()) {

1220 
ti
->
	`rcu_¡¬t
();

1221 ià(
	`Úego
(
q
, 
·r£r
.
	`»suÉ
(), 
	`SŒ
(
buf
.
	`d©a
(), 
cÚsumed
), *
ti
) >= 0) {

1222 
§
.
	`ş—r
();

1223 
msg·ck
::
uÅ¬£r
<
SŒšgAccum
> 
	`cu
(
§
);

1224 
cu
 << 
·r£r
.
	`»suÉ
();

1225 
cc
 = 
	`£ndto
(
s
, 
§
.
	`d©a
(), sa.
	`Ëngth
(), 0,

1226 (
sockaddr
*è&
sš
, 
sšËn
);

1227 
	`®ways_as£¹
(
cc
 =ğ(
ssize_t
è
§
.
	`Ëngth
());

1229 
ti
->
	`rcu_¡İ
();

1231 
	`´štf
("onego failed\n");

1234 
	}
}

1236 
SŒšg
 
	$log_f’ame
(cÚ¡ * 
logdœ
, 
logšdex
) {

1237 
¡©
 
sb
;

1238 
r
 = 
	`¡©
(
logdœ
, &
sb
);

1239 ià(
r
 < 0 && 
”ºo
 =ğ
ENOENT
) {

1240 
r
 = 
	`mkdœ
(
logdœ
, 0777);

1241 ià(
r
 < 0) {

1242 
	`årštf
(
¡d”r
, "%s: %s\n", 
logdœ
, 
	`¡»¼Ü
(
”ºo
));

1243 
	`®ways_as£¹
(0);

1247 
SŒšgAccum
 
§
;

1248 
§
.
	`¢´štf
(
	`¡¾’
(
logdœ
è+ 24, "%s/kvd-log-%d",†ogdœ, 
logšdex
);

1249  
§
.
	`ke_¡ršg
();

1250 
	}
}

1252 
	$log_š™
() {

1253 
»t
, 
i
;

1255 
logs
 = 
log£t
::
	`make
(
Æogg”
);

1256 
i
 = 0; i < 
Æogg”
; i++)

1257 
logs
->
	`log
(
i
).
	`š™Ÿlize
(
	`log_f’ame
(
logdœs
[˜%†ogdœs.
	`size
()], i));

1259 
cks
 = (
ck¡©e
 *)
	`m®loc
((ck¡©eè* 
nckth»ads
);

1260 
i
 = 0; i < 
nckth»ads
; i++) {

1261 
th»adšfo
 *
ti
 =h»adšfo::
	`make
Ñh»adšfo::
TI_CHECKPOINT
, 
i
);

1262 
cks
[
i
].
¡©e
 = 
CKS‹_Unš™
;

1263 
cks
[
i
].
ti
 =i;

1264 
»t
 = 
	`±h»ad_ü—‹
(&
ti
->
	`±h»ad
(), 0, 
cÚc_checkpoš‹r
,i);

1265 
	`®ways_as£¹
(
»t
 == 0);

1267 
	}
}

1275 
kv•och_t
 
	$»ad_checkpošt
(
th»adšfo
 *
ti
, cÚ¡ *
·th
) {

1276 
t0
 = 
	`now
();

1278 
fd
 = 
	`İ’
(
·th
, 0);

1279 if(
fd
 < 0){

1280 
	`´štf
("nØ%s\n", 
·th
);

1283 
¡©
 
sb
;

1284 
»t
 = 
	`f¡©
(
fd
, &
sb
);

1285 
	`®ways_as£¹
(
»t
 == 0);

1286 *
p
 = (*è
	`mm­
(0, 
sb
.
¡_size
, 
PROT_READ
, 
MAP_FILE
|
MAP_PRIVATE
, 
fd
, 0);

1287 
	`®ways_as£¹
(
p
 !ğ
MAP_FAILED
);

1288 
	`şo£
(
fd
);

1290 
msg·ck
::
·r£r
 
	`·r
(
SŒšg
::
	`make_¡abË
(
p
, 
sb
.
¡_size
));

1291 
JsÚ
 
j
;

1292 
·r
 >> 
j
;

1293 
¡d
::
û¼
 << 
j
 << "\n";

1294 
	`®ways_as£¹
(
j
["g’”©iÚ"].
	`is_i
() && j["size"].is_i());

1295 
ušt64_t
 
g’
 = 
j
["g’”©iÚ"].
	`as_i
();

1296 
ušt64_t
 
n
 = 
j
["size"].
	`as_i
();

1297 
	`´štf
("»adšg checkpošˆw™h %" 
PRIu64
 "‚odes\n", 
n
);

1300 
ušt64_t
 
i
 = 0; i !ğ
n
; ++i)

1301 
ck¡©e
::
	`š£¹
(
Œ“
->
	`bË
(), 
·r
, *
ti
);

1303 
	`munm­
(
p
, 
sb
.
¡_size
);

1304 
t1
 = 
	`now
();

1305 
	`´štf
("%.1f MB, %.2f sec, %.1f MB/sec\n",

1306 
sb
.
¡_size
 / 1000000.0,

1307 
t1
 - 
t0
,

1308 (
sb
.
¡_size
 / 1000000.0è/ (
t1
 - 
t0
));

1309  
g’
;

1310 
	}
}

1313 
	$wa™uÁpha£
(
pha£
)

1315 
	`®ways_as£¹
(
	`±h»ad_mu‹x_lock
(&
»c_mu
) == 0);

1316 
»c_¡©e
 !ğ
pha£
)

1317 
	`®ways_as£¹
(
	`±h»ad_cÚd_wa™
(&
»c_cÚd
, &
»c_mu
) == 0);

1318 
	`®ways_as£¹
(
	`±h»ad_mu‹x_uÆock
(&
»c_mu
) == 0);

1319 
	}
}

1322 
	$šaùive
()

1324 
	`®ways_as£¹
(
	`±h»ad_mu‹x_lock
(&
»c_mu
) == 0);

1325 
»c_Çùive
 --;

1326 
	`®ways_as£¹
(
	`±h»ad_cÚd_brßdÿ¡
(&
»c_cÚd
) == 0);

1327 
	`®ways_as£¹
(
	`±h»ad_mu‹x_uÆock
(&
»c_mu
) == 0);

1328 
	}
}

1330 
	$»cov”checkpošt
(
th»adšfo
 *
ti
) {

1331 
	`wa™uÁpha£
(
REC_CKP
);

1332 
·th
[256];

1333 
	`¥rštf
(
·th
, "%s/kvd-ckp-%" 
PRId64
 "-%d",

1334 
ckpdœs
[
ti
->
	`šdex
(è% ckpdœs.
	`size
()],

1335 
ckp_g’
.
	`v®ue
(), 
ti
->
	`šdex
());

1336 
kv•och_t
 
g’
 = 
	`»ad_checkpošt
(
ti
, 
·th
);

1337 
	`®ways_as£¹
(
ckp_g’
 =ğ
g’
);

1338 
	`šaùive
();

1339 
	}
}

1342 
	$»ıha£
(
Çùive
, 
¡©e
)

1344 
»c_Çùive
 = 
Çùive
;

1345 
»c_¡©e
 = 
¡©e
;

1346 
	`®ways_as£¹
(
	`±h»ad_cÚd_brßdÿ¡
(&
»c_cÚd
) == 0);

1347 
»c_Çùive
)

1348 
	`®ways_as£¹
(
	`±h»ad_cÚd_wa™
(&
»c_cÚd
, &
»c_mu
) == 0);

1349 
	}
}

1357 
	$»cov”
(
th»adšfo
 *)

1359 
»cov”šg
 = 
Œue
;

1363 
·th
[256];

1364 
	`¥rštf
(
·th
, "%s/kvd-ckp-g’", 
ckpdœs
[0]);

1365 
ckp_g’
 = 0;

1366 
»c_ckp_mš_•och
 = 
»c_ckp_max_•och
 = 0;

1367 
fd
 = 
	`İ’
(
·th
, 
O_RDONLY
);

1368 ià(
fd
 >= 0) {

1369 
JsÚ
 
ckpj
 = JsÚ::
	`·r£
(
	`»ad_fe_cÚ‹Ás
(
fd
));

1370 
	`şo£
(
fd
);

1371 ià(
ckpj
 && ckpj["kvdb_checkpošt"] && ckpj["g’”©iÚ"].
	`is_numb”
()) {

1372 
ckp_g’
 = 
ckpj
["g’”©iÚ"].
	`to_u64
();

1373 
»c_ckp_mš_•och
 = 
ckpj
["mš_•och"].
	`to_u64
();

1374 
»c_ckp_max_•och
 = 
ckpj
["max_•och"].
	`to_u64
();

1375 
	`´štf
("»cov” from checkpošˆ%" 
PRIu64
 " [%" PRIu64 ", %" PRIu64 "]\n", 
ckp_g’
.
	`v®ue
(), 
»c_ckp_mš_•och
.v®ue(), 
»c_ckp_max_•och
.value());

1378 
	`´štf
("nØ%s\n", 
·th
);

1380 
	`®ways_as£¹
(
	`±h»ad_mu‹x_lock
(&
»c_mu
) == 0);

1383 
	`»ıha£
(
nckth»ads
, 
REC_CKP
);

1386 
»c_log_šfos
 = 
Ãw
 
log»¶ay
::
šfo_ty³
[
Æogg”
];

1387 
	`»ıha£
(
Æogg”
, 
REC_LOG_TS
);

1397 
kv•och_t
 
max_•och
 = 
»c_ckp_max_•och
;

1398 ià(
max_•och
)

1399 
max_•och
 = max_•och.
	`Ãxt_nÚz”o
();

1400 
log»¶ay
::
šfo_ty³
 *
™
 = 
»c_log_šfos
;

1401 
™
 !ğ
»c_log_šfos
 + 
Æogg”
; ++it)

1402 ià(
™
->
Ï¡_•och


1403 && (!
max_•och
 || max_•och < 
™
->
Ï¡_•och
))

1404 
max_•och
 = 
™
->
Ï¡_•och
;

1408 
kv•och_t
 
max_fœ¡_•och
 = 0;

1409 
log»¶ay
::
šfo_ty³
 *
™
 = 
»c_log_šfos
;

1410 
™
 !ğ
»c_log_šfos
 + 
Æogg”
; ++it)

1411 ià(
™
->
fœ¡_•och


1412 && (!
max_fœ¡_•och
 || max_fœ¡_•och < 
™
->
fœ¡_•och
))

1413 
max_fœ¡_•och
 = 
™
->
fœ¡_•och
;

1416 
kv•och_t
 
max_wake_•och
 = 0;

1417 
log»¶ay
::
šfo_ty³
 *
™
 = 
»c_log_šfos
;

1418 
™
 !ğ
»c_log_šfos
 + 
Æogg”
; ++it)

1419 ià(
™
->
wake_•och


1420 && (!
max_wake_•och
 || max_wake_•och < 
™
->
wake_•och
))

1421 
max_wake_•och
 = 
™
->
wake_•och
;

1424 
kv•och_t
 
mš_qu›sûÁ_Ï¡_•och
 = 0;

1425 
log»¶ay
::
šfo_ty³
 *
™
 = 
»c_log_šfos
;

1426 
™
 !ğ
»c_log_šfos
 + 
Æogg”
; ++it)

1427 ià(
™
->
qu›sûÁ


1428 && (!
mš_qu›sûÁ_Ï¡_•och
 || mš_qu›sûÁ_Ï¡_•och > 
™
->
Ï¡_•och
))

1429 
mš_qu›sûÁ_Ï¡_•och
 = 
™
->
Ï¡_•och
;

1436 ià(
max_wake_•och
 && 
mš_qu›sûÁ_Ï¡_•och
 <= max_wake_epoch)

1437 
»c_»¶ay_mš_qu›sûÁ_Ï¡_•och
 = 
mš_qu›sûÁ_Ï¡_•och
;

1439 
»c_»¶ay_mš_qu›sûÁ_Ï¡_•och
 = 0;

1440 
	`»ıha£
(
Æogg”
, 
REC_LOG_ANALYZE_WAKE
);

1445 
»c_»¶ay_max_•och
 = 
max_•och
;

1446 
log»¶ay
::
šfo_ty³
 *
™
 = 
»c_log_šfos
;

1447 
™
 !ğ
»c_log_šfos
 + 
Æogg”
; ++it) {

1448 ià(!
™
->
qu›sûÁ


1449 && 
™
->
Ï¡_•och


1450 && 
™
->
Ï¡_•och
 < 
»c_»¶ay_max_•och
)

1451 
»c_»¶ay_max_•och
 = 
™
->
Ï¡_•och
;

1452 ià(
™
->
mš_po¡_qu›sûÁ_wake_•och


1453 && 
™
->
mš_po¡_qu›sûÁ_wake_•och
 < 
»c_»¶ay_max_•och
)

1454 
»c_»¶ay_max_•och
 = 
™
->
mš_po¡_qu›sûÁ_wake_•och
;

1458 
»c_»¶ay_mš_•och
 = 
»c_ckp_mš_•och
;

1462 ià(
»c_ckp_mš_•och
) {

1463 
	`®ways_as£¹
(
»c_ckp_mš_•och
 > 
max_fœ¡_•och
);

1464 
	`®ways_as£¹
(
»c_ckp_mš_•och
 < 
»c_»¶ay_max_•och
);

1465 
	`®ways_as£¹
(
»c_ckp_max_•och
 < 
»c_»¶ay_max_•och
);

1466 
	`årštf
(
¡d”r
, "»¶ay [%" 
PRIu64
 ",%" PRIu64 ") from [%" PRIu64 ",%" PRIu64 ") into ckp [%" PRIu64 ",%" PRIu64 "]\n",

1467 
»c_»¶ay_mš_•och
.
	`v®ue
(), 
»c_»¶ay_max_•och
.value(),

1468 
max_fœ¡_•och
.
	`v®ue
(), 
max_•och
.value(),

1469 
»c_ckp_mš_•och
.
	`v®ue
(), 
»c_ckp_max_•och
.value());

1473 
d–‘e
[] 
»c_log_šfos
;

1474 
»c_log_šfos
 = 0;

1475 
	`»ıha£
(
Æogg”
, 
REC_LOG_REPLAY
);

1478 
	`»ıha£
(0, 
REC_DONE
);

1479 #ià!
NDEBUG


1482 
ušt64_t
 
d–s_ü—‹d
 = 0, 
d–s_»moved
 = 0;

1483 
th»adšfo
 *
ti
 =h»adšfo::
®Éh»ads
;i;˜ğti->
	`Ãxt
()) {

1484 
d–s_ü—‹d
 +ğ
ti
->
	`couÁ”
(
tc_»¶ay_ü—‹_d–
);

1485 
d–s_»moved
 +ğ
ti
->
	`couÁ”
(
tc_»¶ay_»move_d–
);

1487 ià(
d–s_ü—‹d
)

1488 
	`årštf
(
¡d”r
, "d– ü—‹d: %" 
PRIu64
 ",„emoved: %" PRIu64 "\n", 
d–s_ü—‹d
, 
d–s_»moved
);

1489 
	`®ways_as£¹
(
d–s_ü—‹d
 =ğ
d–s_»moved
);

1492 
glob®_log_•och
 = 
»c_»¶ay_max_•och
.
	`Ãxt_nÚz”o
();

1494 
	`®ways_as£¹
(
	`±h»ad_mu‹x_uÆock
(&
»c_mu
) == 0);

1495 
»cov”šg
 = 
çl£
;

1496 ià(
»cov”y_Úly
)

1497 
	`ex™
(0);

1498 
	}
}

1501 
	$wr™echeckpošt
(cÚ¡ *
·th
, 
ck¡©e
 *
c
, 
t0
)

1503 
t1
 = 
	`now
();

1504 
	`´štf
("memÜy…ha£: %" 
PRIu64
 "‚odes, %.2à£c\n", 
c
->
couÁ
, 
t1
 - 
t0
);

1506 
fd
 = 
	`ü—t
(
·th
, 0666);

1507 
	`®ways_as£¹
(
fd
 >= 0);

1512 
JsÚ
 
j
 = 
	`JsÚ
().
	`£t
("g’”©iÚ", 
ckp_g’
.
	`v®ue
())

1513 .
	`£t
("size", 
c
->
couÁ
)

1514 .
	`£t
("fœ¡key", 
c
->
¡¬tkey
);

1515 
SŒšgAccum
 
§
;

1516 
msg·ck
::
	`uÅ¬£
(
§
, 
j
);

1517 
	`checked_wr™e
(
fd
, 
§
.
	`d©a
(), sa.
	`Ëngth
());

1518 
	`checked_wr™e
(
fd
, 
c
->
v®s
->
buf
, c->v®s->
n
);

1520 
»t
 = 
	`fsync
(
fd
);

1521 
	`®ways_as£¹
(
»t
 == 0);

1522 
»t
 = 
	`şo£
(
fd
);

1523 
	`®ways_as£¹
(
»t
 == 0);

1525 
t2
 = 
	`now
();

1526 
c
->
by‹s
 = c->
v®s
->
n
;

1527 
	`´štf
("fpha£ (%s): %" 
PRIu64
 " bytes, %.2f sec, %.1f MB/sec\n",

1528 
·th
,

1529 
c
->
by‹s
,

1530 
t2
 - 
t1
,

1531 (
c
->
by‹s
 / 1000000.0è/ (
t2
 - 
t1
));

1532 
	}
}

1535 
	$cÚc_fecheckpošt
(
th»adšfo
 *
ti
)

1537 
ck¡©e
 *
c
 = &
cks
[
ti
->
	`šdex
()];

1538 
c
->
v®s
 = 
	`Ãw_bufkvout
();

1539 
t0
 = 
	`now
();

1540 
Œ“
->
	`bË
().
	`sÿn
(
c
->
¡¬tkey
, 
Œue
, *c, *
ti
);

1541 
·th
[256];

1542 
	`¥rštf
(
·th
, "%s/kvd-ckp-%" 
PRId64
 "-%d",

1543 
ckpdœs
[
ti
->
	`šdex
(è% ckpdœs.
	`size
()],

1544 
ckp_g’
.
	`v®ue
(), 
ti
->
	`šdex
());

1545 
	`wr™echeckpošt
(
·th
, 
c
, 
t0
);

1546 
c
->
couÁ
 = 0;

1547 
	`ä“
(
c
->
v®s
);

1548 
	}
}

1550 
JsÚ


1551 
	$´•¬e_checkpošt
(
kv•och_t
 
mš_•och
, 
nckth»ads
, cÚ¡ 
SŒ
 *
pv
)

1553 
JsÚ
 
j
;

1554 
j
.
	`£t
("kvdb_checkpošt", 
Œue
)

1555 .
	`£t
("mš_•och", 
mš_•och
.
	`v®ue
())

1556 .
	`£t
("max_•och", 
glob®_log_•och
.
	`v®ue
())

1557 .
	`£t
("g’”©iÚ", 
ckp_g’
.
	`v®ue
())

1558 .
	`£t
("nckth»ads", 
nckth»ads
);

1560 
JsÚ
 
pvj
;

1561 
i
 = 1; i < 
nckth»ads
; ++i)

1562 
pvj
.
	`push_back
(
JsÚ
::
	`make_¡ršg
(
pv
[
i
].
s
,…v[i].
Ën
));

1563 
j
.
	`£t
("pivÙs", 
pvj
);

1565  
j
;

1566 
	}
}

1569 
	$comm™_checkpošt
(
JsÚ
 
ckpj
)

1573 
·th
[256];

1574 
	`¥rštf
(
·th
, "%s/kvd-ckp-g’", 
ckpdœs
[0]);

1575 
r
 = 
	`©omic_wr™e_fe_cÚ‹Ás
(
·th
, 
ckpj
.
	`uÅ¬£
());

1576 
	`®ways_as£¹
(
r
 == 0);

1577 
	`årštf
(
¡d”r
, "kvd-ckp-%" 
PRIu64
 " [%s,%s]: committed\n",

1578 
ckp_g’
.
	`v®ue
(), 
ckpj
["mš_•och"].
	`to_s
().
	`c_¡r
(),

1579 
ckpj
["max_•och"].
	`to_s
().
	`c_¡r
());

1582 
i
 = 0; i < 
nckth»ads
; i++) {

1583 
·th
[256];

1584 
	`¥rštf
(
·th
, "%s/kvd-ckp-%" 
PRId64
 "-%d",

1585 
ckpdœs
[
i
 % ckpdœs.
	`size
()],

1586 
ckp_g’
.
	`v®ue
(è- 1, 
i
);

1587 
	`uÆšk
(
·th
);

1589 
	}
}

1591 
kv•och_t


1592 
	$max_æushed_•och
()

1594 
kv•och_t
 
mã
 = 0, 
ge
 = 
glob®_log_•och
;

1595 
i
 = 0; i < 
Æogg”
; ++i) {

1596 
logšfo
& 
log
 = 
logs
->
	`log
(
i
);

1597 
kv•och_t
 
ã
 = 
log
.
	`qu›sûÁ
(è? 
ge
 :†og.
	`æushed_•och
();

1598 ià(!
mã
 || 
ã
 < mfe)

1599 
mã
 = 
ã
;

1601  
mã
;

1602 
	}
}

1605 * 
	$cÚc_checkpoš‹r
(* 
x
) {

1606 
th»adšfo
* 
ti
 = 
»š‹½»t_ÿ¡
<th»adšfo*>(
x
);

1607 
ti
->
	`±h»ad
(èğ
	`±h»ad_£lf
();

1608 
	`»cov”checkpošt
(
ti
);

1609 
ck¡©e
 *
c
 = &
cks
[
ti
->
	`šdex
()];

1610 
c
->
couÁ
 = 0;

1611 
	`±h»ad_cÚd_š™
(&
c
->
¡©e_cÚd
, 
NULL
);

1612 
c
->
¡©e
 = 
CKS‹_R—dy
;

1613 
»cov”šg
)

1614 
	`¦“p
(1);

1615 ià(
checkpošt_š‹rv®
 <= 0)

1617 ià(
ti
->
	`šdex
() == 0) {

1618 
i
 = 1; i < 
nckth»ads
; i++)

1619 
cks
[
i
].
¡©e
 !ğ
CKS‹_R—dy
)

1621 
SŒ
 *
pv
 = 
Ãw
 SŒ[
nckth»ads
 + 1];

1622 
JsÚ
 
uncomm™‹d_ckp
;

1625 
time¥ec
 
ts
;

1626 
	`£t_time¥ec
(
ts
, 
	`now
(è+ (
uncomm™‹d_ckp
 ? 0.25 : 
checkpošt_š‹rv®
));

1628 
	`±h»ad_mu‹x_lock
(&
checkpošt_mu
);

1629 ià(!
go_qu™
)

1630 
	`±h»ad_cÚd_timedwa™
(&
checkpošt_cÚd
, &
checkpošt_mu
, &
ts
);

1631 ià(
go_qu™
) {

1632 
i
 = 0; i < 
nckth»ads
; i++) {

1633 
cks
[
i
].
¡©e
 = 
CKS‹_Qu™
;

1634 
	`±h»ad_cÚd_sigÇl
(&
cks
[
i
].
¡©e_cÚd
);

1636 
	`±h»ad_mu‹x_uÆock
(&
checkpošt_mu
);

1639 
	`±h»ad_mu‹x_uÆock
(&
checkpošt_mu
);

1641 ià(
uncomm™‹d_ckp
) {

1642 
kv•och_t
 
mã
 = 
	`max_æushed_•och
();

1643 ià(!
mã
 || mã > 
uncomm™‹d_ckp
["max_•och"].
	`to_u64
()) {

1644 
	`comm™_checkpošt
(
uncomm™‹d_ckp
);

1645 
uncomm™‹d_ckp
 = 
	`JsÚ
();

1650 
t0
 = 
	`now
();

1651 
ti
->
	`rcu_¡¬t
();

1652 
i
 = 0; i < 
nckth»ads
 + 1; i++)

1653 
pv
[
i
].
	`assign
(
NULL
, 0);

1654 
Œ“
->
	`fšdpivÙs
(
pv
, 
nckth»ads
 + 1);

1655 
ti
->
	`rcu_¡İ
();

1657 
kv•och_t
 
mš_•och
 = 
glob®_log_•och
;

1658 
	`±h»ad_mu‹x_lock
(&
checkpošt_mu
);

1659 
ckp_g’
 = ckp_g’.
	`Ãxt_nÚz”o
();

1660 
i
 = 0; i < 
nckth»ads
; i++) {

1661 
cks
[
i
].
¡¬tkey
 = 
pv
[i];

1662 
cks
[
i
].
’dkey
 = (˜=ğ
nckth»ads
 - 1 ? 
	`SŒ
(è: 
pv
[i + 1]);

1663 
cks
[
i
].
¡©e
 = 
CKS‹_Go
;

1664 
	`±h»ad_cÚd_sigÇl
(&
cks
[
i
].
¡©e_cÚd
);

1666 
	`±h»ad_mu‹x_uÆock
(&
checkpošt_mu
);

1668 
ti
->
	`rcu_¡¬t
();

1669 
	`cÚc_fecheckpošt
(
ti
);

1670 
ti
->
	`rcu_¡İ
();

1672 
cks
[0].
¡©e
 = 
CKS‹_R—dy
;

1673 
ušt64_t
 
by‹s
 = 
cks
[0].bytes;

1674 
	`±h»ad_mu‹x_lock
(&
checkpošt_mu
);

1675 
i
 = 1; i < 
nckth»ads
; i++) {

1676 
cks
[
i
].
¡©e
 !ğ
CKS‹_R—dy
)

1677 
	`±h»ad_cÚd_wa™
(&
cks
[
i
].
¡©e_cÚd
, &
checkpošt_mu
);

1678 
by‹s
 +ğ
cks
[
i
].bytes;

1680 
	`±h»ad_mu‹x_uÆock
(&
checkpošt_mu
);

1682 
uncomm™‹d_ckp
 = 
	`´•¬e_checkpošt
(
mš_•och
, 
nckth»ads
, 
pv
);

1684 
i
 = 0; i < 
nckth»ads
 + 1; i++)

1685 ià(
pv
[
i
].
s
)

1686 
	`ä“
((*)
pv
[
i
].
s
);

1687 
t
 = 
	`now
(è- 
t0
;

1688 
	`årštf
(
¡d”r
, "kvd-ckp-%" 
PRIu64
 " [%s,%s]:…repared (%.2f sec, %" PRIu64 " MB, %" PRIu64 " MB/sec)\n",

1689 
ckp_g’
.
	`v®ue
(), 
uncomm™‹d_ckp
["mš_•och"].
	`to_s
().
	`c_¡r
(),

1690 
uncomm™‹d_ckp
["max_•och"].
	`to_s
().
	`c_¡r
(),

1691 
t
, 
by‹s
 / (1 << 20), (
ušt64_t
)(bytes /) >> 20);

1695 
	`±h»ad_mu‹x_lock
(&
checkpošt_mu
);

1696 
c
->
¡©e
 !ğ
CKS‹_Go
 && c->¡©!ğ
CKS‹_Qu™
)

1697 
	`±h»ad_cÚd_wa™
(&
c
->
¡©e_cÚd
, &
checkpošt_mu
);

1698 ià(
c
->
¡©e
 =ğ
CKS‹_Qu™
) {

1699 
	`±h»ad_mu‹x_uÆock
(&
checkpošt_mu
);

1702 
	`±h»ad_mu‹x_uÆock
(&
checkpošt_mu
);

1704 
ti
->
	`rcu_¡¬t
();

1705 
	`cÚc_fecheckpošt
(
ti
);

1706 
ti
->
	`rcu_¡İ
();

1708 
	`±h»ad_mu‹x_lock
(&
checkpošt_mu
);

1709 
c
->
¡©e
 = 
CKS‹_R—dy
;

1710 
	`±h»ad_cÚd_sigÇl
(&
c
->
¡©e_cÚd
);

1711 
	`±h»ad_mu‹x_uÆock
(&
checkpošt_mu
);

1715 
	}
}

	@masstree-beta/mttest.cc

20 
	~<¡dio.h
>

21 
	~<¡d¬g.h
>

22 
	~<ùy³.h
>

23 
	~<¡dlib.h
>

24 
	~<uni¡d.h
>

25 
	~<sys/sock‘.h
>

26 
	~<Ãtš‘/š.h
>

27 
	~<Ãtš‘/tı.h
>

28 
	~<sys/£Ëù.h
>

29 
	~<sys/mmª.h
>

30 
	~<sys/¡©.h
>

31 
	~<sys/wa™.h
>

32 
	~<sys/ut¢ame.h
>

33 
	~<lim™s.h
>

34 #ià
HAVE_NUMA_H


35 
	~<numa.h
>

37 #ià
HAVE_SYS_EPOLL_H


38 
	~<sys/•Şl.h
>

40 #ià
HAVE_EXECINFO_H


41 
	~<execšfo.h
>

43 #ià
__lšux__


44 
	~<asm-g’”ic/mmª.h
>

46 
	~<fú.h
>

47 
	~<as£¹.h
>

48 
	~<¡ršg.h
>

49 
	~<±h»ad.h
>

50 
	~<m©h.h
>

51 
	~<sigÇl.h
>

52 
	~<”ºo.h
>

53 #ifdeà
__lšux__


54 
	~<m®loc.h
>

56 
	~"nodev”siÚ.hh
"

57 
	~"kv¡©s.hh
"

58 
	~"qu”y_mas¡»e.hh
"

59 
	~"mas¡»e_tcursÜ.hh
"

60 
	~"mas¡»e_š£¹.hh
"

61 
	~"mas¡»e_»move.hh
"

62 
	~"mas¡»e_sÿn.hh
"

63 
	~"time¡amp.hh
"

64 
	~"jsÚ.hh
"

65 
	~"kv‹¡.hh
"

66 
	~"kv¿ndom.hh
"

67 
	~"kvrow.hh
"

68 
	~"kvio.hh
"

69 
	~"şp.h
"

70 
	~<®gÜ™hm
>

71 
	~<num”ic
>

73 
	g¡d
::
veùÜ
<> 
cÜes
;

74 vŞ©
boŞ
 
	gtimeout
[2] = {
çl£
, false};

75 
	gdu¿tiÚ
[2] = {10, 0};

77 
boŞ
 
	gÏzy_tim”
 = 
çl£
;

78 
	gkv‹¡_fœ¡_£ed
 = 31949;

79 
ušt64_t
 
	g‹¡_lim™
 = ~uint64_t(0);

80 
JsÚ
 
	g‹¡_·¿m
;

82 
boŞ
 
	gqu›t
 = 
çl£
;

83 
boŞ
 
	g´št_bË
 = 
çl£
;

84 cÚ¡ *
	ggid
 = 
NULL
;

87 
	gud±h»ads
 = 0;

88 
	gtıth»ads
 = 0;

90 
boŞ
 
	gŒ“_¡©s
 = 
çl£
;

91 
boŞ
 
	gjsÚ_¡©s
 = 
çl£
;

92 
SŒšg
 
	ggnu¶Ù_y¿nge
;

93 
boŞ
 
	gpšth»ads
 = 
çl£
;

94 
nodev”siÚ32
 
glob®_•och_lock
(
çl£
);

95 vŞ©
mrcu_•och_ty³
 
	gglob®•och
 = 1;

96 vŞ©
mrcu_•och_ty³
 
	gaùive_•och
 = 1;

97 
kv•och_t
 
	gglob®_log_•och
 = 0;

98 
	gpÜt
 = 2117;

99 
	grsÿË_ncÜes
 = 0;

101 #ià
MEMSTATS
 && 
HAVE_NUMA_H
 && 
HAVE_LIBNUMA


102 
	sm‰e¡_numašfo
 {

103 
	mä“
;

104 
	msize
;

106 
	g¡d
::
veùÜ
<
m‰e¡_numašfo
> 
numa
;

109 vŞ©
boŞ
 
	g»cov”šg
 = 
çl£
;

110 
kvtime¡amp_t
 
	gš™Ÿl_time¡amp
;

112 cÚ¡ *
	gth»adcouÁ”_Çmes
[(è
tc_max
];

115 
	$‹¡_timeout
() {

116 
size_t
 
n
;

117 
n
 = 0;‚ < 
	`¬¿ysize
(
timeout
) &&imeout[n]; ++n)

119 ià(
n
 < 
	`¬¿ysize
(
timeout
)) {

120 
timeout
[
n
] = 
Œue
;

121 ià(
n
 + 1 < 
	`¬¿ysize
(
timeout
è&& 
du¿tiÚ
[n + 1])

122 
	`x®¬m
(
du¿tiÚ
[
n
 + 1]);

124 
	}
}

126 
	$£t_glob®_•och
(
mrcu_•och_ty³
 
e
) {

127 
glob®_•och_lock
.
	`lock
();

128 ià(
	`mrcu_sigÃd_•och_ty³
(
e
 - 
glob®•och
) > 0) {

129 
glob®•och
 = 
e
;

130 
aùive_•och
 = 
th»adšfo
::
	`mš_aùive_•och
();

132 
glob®_•och_lock
.
	`uÆock
();

133 
	}
}

135 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

136 
	skv‹¡_ş›Á
 {

137 
kv‹¡_ş›Á
()

138 : 
lim™_
(
‹¡_lim™
), 
ncÜes_
(
ud±h»ads
), 
kvo_
() {

140 ~
kv‹¡_ş›Á
() {

141 ià(
	mkvo_
)

142 
ä“_kvout
(
kvo_
);

145 
Áh»ads
() const {

146  
	mud±h»ads
;

148 
id
() const {

149  
	mti_
->
šdex
();

151 
£t_bË
(
T
 *
bË
, 
th»adšfo
 *
ti
) {

152 
	mbË_
 = 
bË
;

153 
	mti_
 = 
ti
;

155 
»£t
(cÚ¡ 
SŒšg
 &
‹¡
, 
ŒŸl
) {

156 
	m»pÜt_
 = 
JsÚ
().
£t
("bË", 
T
().
Çme
())

157 .
£t
("‹¡", 
‹¡
).£t("ŒŸl", 
ŒŸl
)

158 .
£t
("th»ad", 
ti_
->
šdex
());

160 
¡¬t_tim”
() {

161 
®ways_as£¹
(
Ïzy_tim”
 && "Cannot startimer without†azy_timer option");

162 
®ways_as£¹
(
du¿tiÚ
[0] && "Must specifyimeout[0]");

163 
x®¬m
(
du¿tiÚ
[0]);

166 
boŞ
 
timeout
(
which
) const {

167  ::
timeout
[
which
];

169 
ušt64_t
 
lim™
() const {

170  
	mlim™_
;

172 
JsÚ
 
·¿m
(cÚ¡ 
SŒšg
& 
Çme
) const {

173  
	m‹¡_·¿m
[
Çme
];

176 
ncÜes
() const {

177  
	mncÜes_
;

179 
now
() const {

180  ::
now
();

182 
rusÿË_·¹sz
() const {

185 
rusÿË_š™_·¹_no
() const {

186  
	mti_
->
šdex
();

188 
n£qkeys
() const {

189  16 * 
rusÿË_·¹sz
();

192 
g‘
(
ikey
);

193 
boŞ
 
g‘_sync
(cÚ¡ 
SŒ
 &
key
);

194 
boŞ
 
g‘_sync
(cÚ¡ 
SŒ
 &
key
, SŒ &
v®ue
);

195 
boŞ
 
g‘_sync
(
ikey
) {

196 
quick_i¡r
 
key
(
ikey
);

197  
g‘_sync
(
key
.
¡ršg
());

199 
boŞ
 
g‘_sync_key16
(
ikey
) {

200 
quick_i¡r
 
key
(
ikey
, 16);

201  
g‘_sync
(
key
.
¡ršg
());

203 
g‘_check
(cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
ex³ùed
);

204 
g‘_check
(cÚ¡ *
key
, cÚ¡ *
ex³ùed
) {

205 
g‘_check
(
SŒ
(
key
), SŒ(
ex³ùed
));

207 
g‘_check
(
ikey
, 
›x³ùed
) {

208 
quick_i¡r
 
key
(
ikey
), 
ex³ùed
(
›x³ùed
);

209 
g‘_check
(
key
.
¡ršg
(), 
ex³ùed
.string());

211 
g‘_check
(cÚ¡ 
SŒ
 &
key
, 
›x³ùed
) {

212 
quick_i¡r
 
ex³ùed
(
›x³ùed
);

213 
g‘_check
(
key
, 
ex³ùed
.
¡ršg
());

215 
g‘_check_key8
(
ikey
, 
›x³ùed
) {

216 
quick_i¡r
 
key
(
ikey
, 8), 
ex³ùed
(
›x³ùed
);

217 
g‘_check
(
key
.
¡ršg
(), 
ex³ùed
.string());

219 
g‘_cŞ_check
(cÚ¡ 
SŒ
 &
key
, 
cŞ
, cÚ¡ SŒ &
v®ue
);

220 
g‘_cŞ_check
(
ikey
, 
cŞ
, 
iv®ue
) {

221 
quick_i¡r
 
key
(
ikey
), 
v®ue
(
iv®ue
);

222 
g‘_cŞ_check
(
key
.
¡ršg
(), 
cŞ
, 
v®ue
.string());

224 
g‘_cŞ_check_key10
(
ikey
, 
cŞ
, 
iv®ue
) {

225 
quick_i¡r
 
key
(
ikey
, 10), 
v®ue
(
iv®ue
);

226 
g‘_cŞ_check
(
key
.
¡ršg
(), 
cŞ
, 
v®ue
.string());

230 
sÿn_sync
(cÚ¡ 
SŒ
 &
fœ¡key
, 
n
,

231 
¡d
::
veùÜ
<
SŒ
> &
keys
, std::veùÜ<SŒ> &
v®ues
);

232 
rsÿn_sync
(cÚ¡ 
SŒ
 &
fœ¡key
, 
n
,

233 
¡d
::
veùÜ
<
SŒ
> &
keys
, std::veùÜ<SŒ> &
v®ues
);

235 
put
(cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
v®ue
);

236 
put
(cÚ¡ *
key
, cÚ¡ *
v®ue
) {

237 
put
(
SŒ
(
key
), SŒ(
v®ue
));

239 
put
(
ikey
, 
iv®ue
) {

240 
quick_i¡r
 
key
(
ikey
), 
v®ue
(
iv®ue
);

241 
put
(
key
.
¡ršg
(), 
v®ue
.string());

243 
put
(cÚ¡ 
SŒ
 &
key
, 
iv®ue
) {

244 
quick_i¡r
 
v®ue
(
iv®ue
);

245 
put
(
key
, 
v®ue
.
¡ršg
());

247 
put_key8
(
ikey
, 
iv®ue
) {

248 
quick_i¡r
 
key
(
ikey
, 8), 
v®ue
(
iv®ue
);

249 
put
(
key
.
¡ršg
(), 
v®ue
.string());

251 
put_key16
(
ikey
, 
iv®ue
) {

252 
quick_i¡r
 
key
(
ikey
, 16), 
v®ue
(
iv®ue
);

253 
put
(
key
.
¡ršg
(), 
v®ue
.string());

255 
put_cŞ
(cÚ¡ 
SŒ
 &
key
, 
cŞ
, cÚ¡ SŒ &
v®ue
);

256 
put_cŞ
(
ikey
, 
cŞ
, 
iv®ue
) {

257 
quick_i¡r
 
key
(
ikey
), 
v®ue
(
iv®ue
);

258 
put_cŞ
(
key
.
¡ršg
(), 
cŞ
, 
v®ue
.string());

260 
put_cŞ_key10
(
ikey
, 
cŞ
, 
iv®ue
) {

261 
quick_i¡r
 
key
(
ikey
, 10), 
v®ue
(
iv®ue
);

262 
put_cŞ
(
key
.
¡ršg
(), 
cŞ
, 
v®ue
.string());

265 
»move
(cÚ¡ 
SŒ
 &
key
);

266 
»move
(
ikey
) {

267 
quick_i¡r
 
key
(
ikey
);

268 
»move
(
key
.
¡ršg
());

270 
»move_key8
(
ikey
) {

271 
quick_i¡r
 
key
(
ikey
, 8);

272 
»move
(
key
.
¡ršg
());

274 
»move_key16
(
ikey
) {

275 
quick_i¡r
 
key
(
ikey
, 16);

276 
»move
(
key
.
¡ršg
());

278 
boŞ
 
»move_sync
(cÚ¡ 
SŒ
 &
key
);

279 
boŞ
 
»move_sync
(
ikey
) {

280 
quick_i¡r
 
key
(
ikey
);

281  
»move_sync
(
key
.
¡ršg
());

284 
puts_dÚe
() {

286 
wa™_®l
() {

288 
rcu_qu›sû
() {

289 
mrcu_•och_ty³
 
	me
 = 
time¡amp
() >> 16;

290 ià(
	me
 !ğ
glob®•och
)

291 
£t_glob®_•och
(
e
);

292 
	mti_
->
rcu_qu›sû
();

294 
SŒšg
 
make_mes§ge
(
lcdf
::
SŒšgAccum
 &
§
) const;

295 
nÙiû
(cÚ¡ *
fmt
, ...);

296 
ç
(cÚ¡ *
fmt
, ...);

297 cÚ¡ 
	mJsÚ
& 
»pÜt
(cÚ¡ 
JsÚ
& 
x
) {

298  
	m»pÜt_
.
m”ge
(
x
);

300 
fšish
() {

301 
JsÚ
 
	mcouÁ”s
;

302 
	mi
 = 0; i < 
	mtc_max
; ++i)

303 ià(
ušt64_t
 
	mc
 = 
ti_
->
couÁ”
(
th»adcouÁ”
(
i
)))

304 
couÁ”s
.
£t
(
th»adcouÁ”_Çmes
[
i
], 
c
);

305 ià(
	mcouÁ”s
)

306 
	m»pÜt_
.
£t
("couÁ”s", 
couÁ”s
);

307 ià(!
	mqu›t
)

308 
årštf
(
¡d”r
, "%d: %s\n", 
ti_
->
šdex
(), 
»pÜt_
.
uÅ¬£
().
c_¡r
());

311 
T
 *
	mbË_
;

312 
th»adšfo
 *
	mti_
;

313 
	mqu”y
<
	mrow_ty³
> 
	mq_
[1];

314 
kv¿ndom_lcg_Ä
 
	m¿nd
;

315 
ušt64_t
 
	mlim™_
;

316 
JsÚ
 
	m»pÜt_
;

317 
JsÚ
 
	m»q_
;

318 
	mncÜes_
;

319 
kvout
 *
	mkvo_
;

321 
	m´iv©e
:

322 
ouut_sÿn
(cÚ¡ 
JsÚ
& 
»q
, 
¡d
::
veùÜ
<
SŒ
>& 
keys
, std::veùÜ<SŒ>& 
v®ues
) const;

325 vŞ©
	gkv‹¡_´štšg
;

327 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
šlše
 
	$kv‹¡_´št
(cÚ¡ 
T
 &
bË
, 
FILE
* 
f
, 
th»adšfo
 *
ti
) {

329 !
	`boŞ_cmpxchg
((*è&
kv‹¡_´štšg
, 0, 
ti
->
	`šdex
() + 1))

331 
bË
.
	`´št
(
f
);

332 
	}
}

334 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
šlše
 
	$kv‹¡_jsÚ_¡©s
(
T
& 
bË
, 
JsÚ
& 
j
, 
th»adšfo
& 
ti
) {

335 
bË
.
	`jsÚ_¡©s
(
j
, 
ti
);

336 
	}
}

338 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

339 
	gkv‹¡_ş›Á
<
	gT
>::
	$g‘
(
ikey
) {

340 
quick_i¡r
 
	`key
(
ikey
);

341 
SŒ
 
v®
;

342 (è
q_
[0].
	`run_g‘1
(
bË_
->
	`bË
(), 
key
.
	`¡ršg
(), 0, 
v®
, *
ti_
);

343 
	}
}

345 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

346 
boŞ
 
	gkv‹¡_ş›Á
<
	gT
>::
	$g‘_sync
(cÚ¡ 
SŒ
& 
key
) {

347 
SŒ
 
v®
;

348  
q_
[0].
	`run_g‘1
(
bË_
->
	`bË
(), 
key
, 0, 
v®
, *
ti_
);

349 
	}
}

351 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

352 
boŞ
 
	gkv‹¡_ş›Á
<
	gT
>::
	$g‘_sync
(cÚ¡ 
SŒ
 &
key
, SŒ &
v®ue
) {

353  
q_
[0].
	`run_g‘1
(
bË_
->
	`bË
(), 
key
, 0, 
v®ue
, *
ti_
);

354 
	}
}

356 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

357 
	gkv‹¡_ş›Á
<
	gT
>::
	$g‘_check
(cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
ex³ùed
) {

358 
SŒ
 
v®
;

359 ià(!
q_
[0].
	`run_g‘1
(
bË_
->
	`bË
(), 
key
, 0, 
v®
, *
ti_
))

360 
	`ç
("g‘(%.*sèçed (ex³ùed %.*s)\n", 
key
.
Ën
, key.
s
,

361 
ex³ùed
.
Ën
,ƒx³ùed.
s
);

362 ià(
ex³ùed
 !ğ
v®
)

363 
	`ç
("get(%.*s)„eturned unexpected value %.*s (expected %.*s)\n",

364 
key
.
Ën
, key.
s
, 
¡d
::
	`mš
(
v®
.len, 40), val.s,

365 
ex³ùed
.
Ën
,ƒx³ùed.
s
);

366 
	}
}

368 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

369 
	gkv‹¡_ş›Á
<
	gT
>::
	$g‘_cŞ_check
(cÚ¡ 
SŒ
 &
key
, 
cŞ
,

370 cÚ¡ 
SŒ
 &
ex³ùed
) {

371 
SŒ
 
v®
;

372 ià(!
q_
[0].
	`run_g‘1
(
bË_
->
	`bË
(), 
key
, 
cŞ
, 
v®
, *
ti_
))

373 
	`ç
("get.%d(%.*s) failed (expected %.*s)\n",

374 
cŞ
, 
key
.
Ën
, key.
s
, 
ex³ùed
.len,ƒxpected.s);

375 ià(
ex³ùed
 !ğ
v®
)

376 
	`ç
("get.%d(%.*s)„eturned unexpected value %.*s (expected %.*s)\n",

377 
cŞ
, 
key
.
Ën
, key.
s
, 
¡d
::
	`mš
(
v®
.len, 40), val.s,

378 
ex³ùed
.
Ën
,ƒx³ùed.
s
);

379 
	}
}

400 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

401 
	gkv‹¡_ş›Á
<
	gT
>::
sÿn_sync
(cÚ¡ 
SŒ
 &
fœ¡key
, 
n
,

402 
¡d
::
veùÜ
<
SŒ
> &
keys
,

403 
¡d
::
veùÜ
<
SŒ
> &
v®ues
) {

404 
»q_
 = 
JsÚ
::
¬¿y
(0, 0, 
fœ¡key
, 
n
);

405 
	gq_
[0].
run_sÿn
(
bË_
->
bË
(), 
»q_
, *
ti_
);

406 
ouut_sÿn
(
»q_
, 
keys
, 
v®ues
);

409 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

410 
	gkv‹¡_ş›Á
<
	gT
>::
rsÿn_sync
(cÚ¡ 
SŒ
 &
fœ¡key
, 
n
,

411 
¡d
::
veùÜ
<
SŒ
> &
keys
,

412 
¡d
::
veùÜ
<
SŒ
> &
v®ues
) {

413 
»q_
 = 
JsÚ
::
¬¿y
(0, 0, 
fœ¡key
, 
n
);

414 
	gq_
[0].
run_rsÿn
(
bË_
->
bË
(), 
»q_
, *
ti_
);

415 
ouut_sÿn
(
»q_
, 
keys
, 
v®ues
);

418 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

419 
	gkv‹¡_ş›Á
<
	gT
>::
ouut_sÿn
(cÚ¡ 
JsÚ
& 
»q
, 
¡d
::
veùÜ
<
SŒ
>& 
keys
,

420 
¡d
::
veùÜ
<
SŒ
>& 
v®ues
) const {

421 
keys
.
ş—r
();

422 
	gv®ues
.
ş—r
();

423 
	gi
 = 2; i !ğ
»q
.
size
(); i += 2) {

424 
keys
.
push_back
(
»q
[
i
].
as_s
());

425 
	gv®ues
.
push_back
(
»q
[
i
 + 1].
as_s
());

429 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

430 
	gkv‹¡_ş›Á
<
	gT
>::
	$put
(cÚ¡ 
SŒ
 &
key
, cÚ¡ SŒ &
v®ue
) {

431 
q_
[0].
	`run_»¶aû
(
bË_
->
	`bË
(), 
key
, 
v®ue
, *
ti_
);

432 
	}
}

434 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

435 
	gkv‹¡_ş›Á
<
	gT
>::
	$put_cŞ
(cÚ¡ 
SŒ
 &
key
, 
cŞ
, cÚ¡ SŒ &
v®ue
) {

436 #ià!
MASSTREE_ROW_TYPE_STR


437 ià(!
kvo_
)

438 
kvo_
 = 
	`Ãw_kvout
(-1, 2048);

439 
JsÚ
 
x
[2] = {
	`JsÚ
(
cŞ
), JsÚ(
SŒšg
::
	`make_¡abË
(
v®ue
))};

440 
q_
[0].
	`run_put
(
bË_
->
	`bË
(), 
key
, &
x
[0], &x[2], *
ti_
);

442 (è
key
, (è
cŞ
, (è
v®ue
;

443 
	`as£¹
(0);

445 
	}
}

447 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
šlše
 
boŞ
 
kv‹¡_»move
(
kv‹¡_ş›Á
<
T
> &
ş›Á
, cÚ¡ 
SŒ
 &
key
) {

448  
	gş›Á
.
	gq_
[0].
run_»move
(
ş›Á
.
bË_
->
bË
(), 
key
, *ş›Á.
ti_
);

451 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

452 
	gkv‹¡_ş›Á
<
	gT
>::
	$»move
(cÚ¡ 
SŒ
 &
key
) {

453 (è
	`kv‹¡_»move
(*
this
, 
key
);

454 
	}
}

456 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

457 
boŞ
 
	gkv‹¡_ş›Á
<
	gT
>::
	$»move_sync
(cÚ¡ 
SŒ
 &
key
) {

458  
	`kv‹¡_»move
(*
this
, 
key
);

459 
	}
}

461 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

462 
SŒšg
 
	gkv‹¡_ş›Á
<
	gT
>::
	$make_mes§ge
(
lcdf
::
SŒšgAccum
 &
§
) const {

463 cÚ¡ *
begš
 = 
§
.
	`begš
();

464 
begš
 !ğ
§
.
	`’d
(è&& 
	`is¥aû
(() *begin))

465 ++
begš
;

466 
SŒšg
 
s
 = 
	`SŒšg
(
begš
, 
§
.
	`’d
());

467 ià(!
s
.
	`em±y
(è&& s.
	`back
() != '\n')

468 
s
 += '\n';

469  
s
;

470 
	}
}

472 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

473 
	gkv‹¡_ş›Á
<
	gT
>::
	$nÙiû
(cÚ¡ *
fmt
, ...) {

474 
va_li¡
 
v®
;

475 
	`va_¡¬t
(
v®
, 
fmt
);

476 
SŒšg
 
m
 = 
	`make_mes§ge
(
lcdf
::
	`SŒšgAccum
().
	`v¢´štf
(500, 
fmt
, 
v®
));

477 
	`va_’d
(
v®
);

478 ià(
m
 && !
qu›t
)

479 
	`årštf
(
¡d”r
, "%d: %s", 
ti_
->
	`šdex
(), 
m
.
	`c_¡r
());

480 
	}
}

482 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

483 
	gkv‹¡_ş›Á
<
	gT
>::
	$ç
(cÚ¡ *
fmt
, ...) {

484 
nodev”siÚ32
 
	`çšg_lock
(
çl£
);

485 
nodev”siÚ32
 
	`ç_mes§ge_lock
(
çl£
);

486 
SŒšg
 
ç_mes§ge
;

488 
va_li¡
 
v®
;

489 
	`va_¡¬t
(
v®
, 
fmt
);

490 
SŒšg
 
m
 = 
	`make_mes§ge
(
lcdf
::
	`SŒšgAccum
().
	`v¢´štf
(500, 
fmt
, 
v®
));

491 
	`va_’d
(
v®
);

492 ià(!
m
)

493 
m
 = "unknown failure";

495 
ç_mes§ge_lock
.
	`lock
();

496 ià(
ç_mes§ge
 !ğ
m
) {

497 
ç_mes§ge
 = 
m
;

498 
	`årštf
(
¡d”r
, "%d: %s", 
ti_
->
	`šdex
(), 
m
.
	`c_¡r
());

500 
ç_mes§ge_lock
.
	`uÆock
();

502 
çšg_lock
.
	`lock
();

503 
	`årštf
(
¡dout
, "%d: %s", 
ti_
->
	`šdex
(), 
m
.
	`c_¡r
());

504 
	`kv‹¡_´št
(*
bË_
, 
¡dout
, 
ti_
);

506 
	`®ways_as£¹
(0);

507 
	}
}

510 cÚ¡ *
	gcu¼’t_‹¡_Çme
;

511 
	gcu¼’t_ŒŸl
;

512 
FILE
 *
	g‹¡_ouut_fe
;

513 
±h»ad_mu‹x_t
 
	gsub‹¡_mu‹x
;

514 
±h»ad_cÚd_t
 
	gsub‹¡_cÚd
;

516 
	#TESTRUNNER_CLIENT_TYPE
 
kv‹¡_ş›Á
<
Mas¡»e
::
deçuÉ_bË
>&

	)

517 
	~"‹¡ruÂ”.hh
"

519 
MAKE_TESTRUNNER
(
rw1
, 
kv‹¡_rw1
(
ş›Á
));

522 
MAKE_TESTRUNNER
(
rw1fixed
, 
kv‹¡_rw1fixed
(
ş›Á
));

523 
MAKE_TESTRUNNER
(
rw1lÚg
, 
kv‹¡_rw1lÚg
(
ş›Á
));

524 
MAKE_TESTRUNNER
(
rw1puts
, 
kv‹¡_rw1puts
(
ş›Á
));

525 
MAKE_TESTRUNNER
(
rw2
, 
kv‹¡_rw2
(
ş›Á
));

526 
MAKE_TESTRUNNER
(
rw2fixed
, 
kv‹¡_rw2fixed
(
ş›Á
));

527 
MAKE_TESTRUNNER
(
rw2g90
, 
kv‹¡_rw2g90
(
ş›Á
));

528 
MAKE_TESTRUNNER
(
rw2fixedg90
, 
kv‹¡_rw2fixedg90
(
ş›Á
));

529 
MAKE_TESTRUNNER
(
rw2g98
, 
kv‹¡_rw2g98
(
ş›Á
));

530 
MAKE_TESTRUNNER
(
rw2fixedg98
, 
kv‹¡_rw2fixedg98
(
ş›Á
));

531 
MAKE_TESTRUNNER
(
rw3
, 
kv‹¡_rw3
(
ş›Á
));

532 
MAKE_TESTRUNNER
(
rw4
, 
kv‹¡_rw4
(
ş›Á
));

533 
MAKE_TESTRUNNER
(
rw4fixed
, 
kv‹¡_rw4fixed
(
ş›Á
));

534 
MAKE_TESTRUNNER
(
wd1
, 
kv‹¡_wd1
(10000000, 1, 
ş›Á
));

535 
MAKE_TESTRUNNER
(
wd1m1
, 
kv‹¡_wd1
(100000000, 1, 
ş›Á
));

536 
MAKE_TESTRUNNER
(
wd1m2
, 
kv‹¡_wd1
(1000000000, 4, 
ş›Á
));

537 
MAKE_TESTRUNNER
(
§me
, 
kv‹¡_§me
(
ş›Á
));

538 
MAKE_TESTRUNNER
(
rwsm®l24
, 
kv‹¡_rwsm®l24
(
ş›Á
));

539 
MAKE_TESTRUNNER
(
rw£p24
, 
kv‹¡_rw£p24
(
ş›Á
));

540 
MAKE_TESTRUNNER
(
wsÿË
, 
kv‹¡_wsÿË
(
ş›Á
));

541 
MAKE_TESTRUNNER
(
rusÿË_š™
, 
kv‹¡_rusÿË_š™
(
ş›Á
));

542 
MAKE_TESTRUNNER
(
rsÿË
, ià(
ş›Á
.
ti_
->
šdex
(è< ::
rsÿË_ncÜes
è
kv‹¡_rsÿË
(client));

543 
MAKE_TESTRUNNER
(
usÿË
, 
kv‹¡_usÿË
(
ş›Á
));

544 
MAKE_TESTRUNNER
(
bdb
, 
kv‹¡_bdb
(
ş›Á
));

545 
MAKE_TESTRUNNER
(
wcŞ1
, 
kv‹¡_wcŞ1©
(
ş›Á
, cl›Á.
id
(è% 24, 
kv‹¡_fœ¡_£ed
 + client.id() % 48, 5000000));

546 
MAKE_TESTRUNNER
(
rcŞ1
, 
kv‹¡_rcŞ1©
(
ş›Á
, cl›Á.
id
(è% 24, 
kv‹¡_fœ¡_£ed
 + client.id() % 48, 5000000));

547 
MAKE_TESTRUNNER
(
wcŞ1o1
, 
kv‹¡_wcŞ1©
(
ş›Á
, (ş›Á.
id
(è+ 1è% 24, 
kv‹¡_fœ¡_£ed
 + client.id() % 48, 5000000));

548 
MAKE_TESTRUNNER
(
rcŞ1o1
, 
kv‹¡_rcŞ1©
(
ş›Á
, (ş›Á.
id
(è+ 1è% 24, 
kv‹¡_fœ¡_£ed
 + client.id() % 48, 5000000));

549 
MAKE_TESTRUNNER
(
wcŞ1o2
, 
kv‹¡_wcŞ1©
(
ş›Á
, (ş›Á.
id
(è+ 2è% 24, 
kv‹¡_fœ¡_£ed
 + client.id() % 48, 5000000));

550 
MAKE_TESTRUNNER
(
rcŞ1o2
, 
kv‹¡_rcŞ1©
(
ş›Á
, (ş›Á.
id
(è+ 2è% 24, 
kv‹¡_fœ¡_£ed
 + client.id() % 48, 5000000));

551 
MAKE_TESTRUNNER
(
sÿn1
, 
kv‹¡_sÿn1
(
ş›Á
, 0));

552 
MAKE_TESTRUNNER
(
sÿn1q80
, 
kv‹¡_sÿn1
(
ş›Á
, 0.8));

553 
MAKE_TESTRUNNER
(
rsÿn1
, 
kv‹¡_rsÿn1
(
ş›Á
, 0));

554 
MAKE_TESTRUNNER
(
rsÿn1q80
, 
kv‹¡_rsÿn1
(
ş›Á
, 0.8));

555 
MAKE_TESTRUNNER
(
¥l™»move1
, 
kv‹¡_¥l™»move1
(
ş›Á
));

556 
MAKE_TESTRUNNER
(
u¾
, 
kv‹¡_u¾
(
ş›Á
));

560 
	m‹¡_th»ad_š™Ÿlize
 = 1,

561 
	m‹¡_th»ad_de¡roy
 = 2,

562 
	m‹¡_th»ad_¡©s
 = 3

565 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

566 
	s‹¡_th»ad
 {

567 
‹¡_th»ad
(
th»adšfo
* 
ti
) {

568 
	mş›Á_
.
£t_bË
(
bË_
, 
ti
);

569 
	mş›Á_
.
	mti_
->
rcu_¡¬t
();

571 ~
‹¡_th»ad
() {

572 
	mş›Á_
.
	mti_
->
rcu_¡İ
();

574 
£tup
(
th»adšfo
* 
ti
, 
aùiÚ
) {

575 ià(
	maùiÚ
 =ğ
‹¡_th»ad_š™Ÿlize
) {

576 
as£¹
(!
bË_
);

577 
	mbË_
 = 
Ãw
 
T
;

578 
	mbË_
->
š™Ÿlize
(*
ti
);

579 } ià(
	maùiÚ
 =ğ
‹¡_th»ad_de¡roy
) {

580 
as£¹
(
bË_
);

581 
d–‘e
 
	mbË_
;

582 
	mbË_
 = 0;

583 } ià(
	maùiÚ
 =ğ
‹¡_th»ad_¡©s
) {

584 
as£¹
(
bË_
);

585 
	mbË_
->
¡©s
(
‹¡_ouut_fe
);

588 * 
go
(* 
x
) {

589 
th»adšfo
* 
	mti
 = 
»š‹½»t_ÿ¡
<th»adšfo*>(
x
);

590 
	mti
->
±h»ad
(èğ
±h»ad_£lf
();

591 
as£¹
(
bË_
);

592 #ià
__lšux__


593 ià(
	mpšth»ads
) {

594 
ıu_£t_t
 
	mcs
;

595 
CPU_ZERO
(&
cs
);

596 
CPU_SET
(
cÜes
[
ti
->
šdex
()], &
cs
);

597 
	mr
 = 
sched_£ffš™y
(0, (
cs
), &cs);

598 
®ways_as£¹
(
r
 == 0);

601 
®ways_as£¹
(!
pšth»ads
 && "pinthreads‚ot supported\n");

604 
	m‹¡_th»ad
<
	mT
> 
‰
(
ti
);

605 ià(
ãtch_ªd_add
(&
aùive_th»ads_
, 1) == 0)

606 
‰
.
»ady_timeouts
();

607 
SŒšg
 
	m‹¡
 = ::
cu¼’t_‹¡_Çme
;

608 
	msub‹¡no
 = 0;

609 
	mpos
 = 0;…o < 
	m‹¡
.
Ëngth
(); ) {

610 
	mcomma
 = 
‹¡
.
fšd_Ëá
(',', 
pos
);

611 
	mcomma
 = (
comma
 < 0 ? 
‹¡
.
Ëngth
() : comma);

612 
SŒšg
 
	msub‹¡
 = 
‹¡
.
sub¡r
(
pos
, 
comma
 -…os), 
	mŠame
;

613 
‹¡ruÂ”
* 
	mŒ
 =e¡ruÂ”::
fšd
(
sub‹¡
);

614 
	mŠame
 = (
sub‹¡
 =ğ
‹¡
 ? sub‹¡ :e¡ + 
SŒšg
("@"è+ SŒšg(
sub‹¡no
));

615 
	m‰
.
	mş›Á_
.
»£t
(
Šame
, ::
cu¼’t_ŒŸl
);

616 ià(
	mŒ
)

617 
	mŒ
->
run
(
‰
.
ş›Á_
);

619 
	m‰
.
	mş›Á_
.
ç
("unknowÀ‹¡ %s", 
sub‹¡
.
c_¡r
());

620 ià(
	mcomma
 =ğ
‹¡
.
Ëngth
())

622 
±h»ad_mu‹x_lock
(&
sub‹¡_mu‹x
);

623 ià(
ãtch_ªd_add
(&
aùive_th»ads_
, -1) == 1) {

624 
±h»ad_cÚd_brßdÿ¡
(&
sub‹¡_cÚd
);

625 
	m‰
.
»ady_timeouts
();

627 
±h»ad_cÚd_wa™
(&
sub‹¡_cÚd
, &
sub‹¡_mu‹x
);

628 
årštf
(
‹¡_ouut_fe
, "%s\n", 
‰
.
ş›Á_
.
»pÜt_
.
uÅ¬£
().
c_¡r
());

629 
±h»ad_mu‹x_uÆock
(&
sub‹¡_mu‹x
);

630 
ãtch_ªd_add
(&
aùive_th»ads_
, 1);

631 
	mpos
 = 
comma
 + 1;

632 ++
	msub‹¡no
;

634 
	m©
 = 
ãtch_ªd_add
(&
aùive_th»ads_
, -1);

635 ià(
	m©
 =ğ1 && 
´št_bË
)

636 
kv‹¡_´št
(*
bË_
, 
¡dout
, 
‰
.
ş›Á_
.
ti_
);

637 ià(
	m©
 =ğ1 && 
jsÚ_¡©s
) {

638 
JsÚ
 
j
;

639 
kv‹¡_jsÚ_¡©s
(*
bË_
, 
j
, *
‰
.
ş›Á_
.
ti_
);

640 ià(
	mj
) {

641 
årštf
(
¡d”r
, "%s\n", 
j
.
uÅ¬£
(
JsÚ
::
šd’t_d•th
(1).
b_width
(2).
Ãwlše_‹rmš©Ü
(
Œue
)).
c_¡r
());

642 
	m‰
.
	mş›Á_
.
	m»pÜt_
.
m”ge
(
j
);

645 
årštf
(
‹¡_ouut_fe
, "%s\n", 
‰
.
ş›Á_
.
»pÜt_
.
uÅ¬£
().
c_¡r
());

648 
»ady_timeouts
() {

649 
size_t
 
	mi
 = 0; i < 
¬¿ysize
(
timeout
); ++i)

650 
	mtimeout
[
i
] = 
çl£
;

651 ià(!
	mÏzy_tim”
 && 
	mdu¿tiÚ
[0])

652 
x®¬m
(
du¿tiÚ
[0]);

654 
T
 *
	mbË_
;

655 
	maùive_th»ads_
;

656 
	mkv‹¡_ş›Á
<
	mT
> 
	mş›Á_
;

658 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
T
 *
	g‹¡_th»ad
<T>::
bË_
;

659 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	g‹¡_th»ad
<T>::
aùive_th»ads_
;

661 
	g‹¡_th»ad
<
	tMas¡»e
::
	tdeçuÉ_bË
> 
	tmas¡»e_‹¡_th»ad
;

664 cÚ¡ *
	mŒ“ty³
;

665 * (*
	mgo_func
)(*);

666 (*
	m£tup_func
)(
	mth»adšfo
*, );

667 } 
	g‹¡_th»ad_m­
[] = {

668 { "mas¡»e", 
mas¡»e_‹¡_th»ad
::
go
, mas¡»e_‹¡_th»ad::
£tup
 },

669 { "mass", 
mas¡»e_‹¡_th»ad
::
go
, mas¡»e_‹¡_th»ad::
£tup
 },

670 { "mbŒ“", 
mas¡»e_‹¡_th»ad
::
go
, mas¡»e_‹¡_th»ad::
£tup
 },

671 { "mb", 
mas¡»e_‹¡_th»ad
::
go
, mas¡»e_‹¡_th»ad::
£tup
 },

672 { "m", 
mas¡»e_‹¡_th»ad
::
go
, mas¡»e_‹¡_th»ad::
£tup
 }

676 
	$ruÁe¡
(
Áh»ads
, * (*
func
)(*)) {

677 
¡d
::
veùÜ
<
th»adšfo
*> 
tis
;

678 
i
 = 0; i < 
Áh»ads
; ++i)

679 
tis
.
	`push_back
(
th»adšfo
::
	`make
Ñh»adšfo::
TI_PROCESS
, 
i
));

680 
	`sigÇl
(
SIGALRM
, 
‹¡_timeout
);

681 
i
 = 0; i < 
Áh»ads
; ++i) {

682 
r
 = 
	`±h»ad_ü—‹
(&
tis
[
i
]->
	`±h»ad
(), 0, 
func
,is[i]);

683 
	`®ways_as£¹
(
r
 == 0);

685 
i
 = 0; i < 
Áh»ads
; ++i)

686 
	`±h»ad_još
(
tis
[
i
]->
	`±h»ad
(), 0);

687 
	}
}

690 cÚ¡ * cÚ¡ 
	gkv¡©s_Çme
[] = {

694 
JsÚ
 
	gex³rim’t_¡©s
;

696 *
	$¡©_cŞËùÜ
(*
¬g
) {

697 
p
 = (è(
šŒ_t
è
¬g
;

698 
FILE
 *
f
 = 
	`fdİ’
(
p
, "r");

699 
buf
[8192];

700 
	`fg‘s
(
buf
, (buf), 
f
)) {

701 
JsÚ
 
»suÉ
 = JsÚ::
	`·r£
(
buf
);

702 ià(
»suÉ
 &&„esult["table"] &&„esult["test"]) {

703 
SŒšg
 
key
 = 
»suÉ
["‹¡"].
	`to_s
() + "/" +„esult["table"].to_s()

704 + "/" + 
»suÉ
["ŒŸl"].
	`to_s
();

705 
JsÚ
 &
thi£x
 = 
ex³rim’t_¡©s
.
	`g‘_š£¹
(
key
);

706 
thi£x
[
»suÉ
["th»ad"].
	`to_i
()] =„esult;

708 
	`årštf
(
¡d”r
, "%s\n", 
buf
);

710 
	`fşo£
(
f
);

712 
	}
}

717 ’um { 
	mşp_v®_nÜm®ize
 = 
CÍ_V®Fœ¡U£r
, 
	mşp_v®_suffixdoubË
 };

718 ’um { 
	mİt_pš
 = 1, 
	mİt_pÜt
, 
	mİt_du¿tiÚ
,

719 
	mİt_‹¡
, 
	mİt_‹¡_Çme
, 
	mİt_th»ads
, 
	mİt_ŒŸls
, 
	mİt_qu›t
, 
	mİt_´št
,

720 
	mİt_nÜm®ize
, 
	mİt_lim™
, 
	mİt_nÙebook
, 
	mİt_com·»
, 
	mİt_no_run
,

721 
	mİt_Ïzy_tim”
, 
	mİt_gid
, 
	mİt_Œ“_¡©s
, 
	mİt_rsÿË_ncÜes
, 
	mİt_cÜes
,

722 
	mİt_¡©s
, 
	mİt_h–p
, 
	mİt_y¿nge
 };

723 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

724 { "pš", 'p', 
İt_pš
, 0, 
CÍ_Neg©e
 },

725 { "pÜt", 0, 
İt_pÜt
, 
CÍ_V®IÁ
, 0 },

726 { "du¿tiÚ", 'd', 
İt_du¿tiÚ
, 
CÍ_V®DoubË
, 0 },

727 { "Ïzy-tim”", 0, 
İt_Ïzy_tim”
, 0, 0 },

728 { "lim™", 'l', 
İt_lim™
, 
şp_v®_suffixdoubË
, 0 },

729 { "nÜm®ize", 0, 
İt_nÜm®ize
, 
şp_v®_nÜm®ize
, 
CÍ_Neg©e
 },

730 { "‹¡", 0, 
İt_‹¡
, 
CÍ_V®SŒšg
, 0 },

731 { "rsÿË_ncÜes", 'r', 
İt_rsÿË_ncÜes
, 
CÍ_V®IÁ
, 0 },

732 { "‹¡-rw1", 0, 
İt_‹¡_Çme
, 0, 0 },

733 { "‹¡-rw2", 0, 
İt_‹¡_Çme
, 0, 0 },

734 { "‹¡-rw3", 0, 
İt_‹¡_Çme
, 0, 0 },

735 { "‹¡-rw4", 0, 
İt_‹¡_Çme
, 0, 0 },

736 { "‹¡-rd1", 0, 
İt_‹¡_Çme
, 0, 0 },

737 { "th»ads", 'j', 
İt_th»ads
, 
CÍ_V®IÁ
, 0 },

738 { "ŒŸls", 'T', 
İt_ŒŸls
, 
CÍ_V®IÁ
, 0 },

739 { "qu›t", 'q', 
İt_qu›t
, 0, 
CÍ_Neg©e
 },

740 { "´št", 0, 
İt_´št
, 0, 
CÍ_Neg©e
 },

741 { "nÙebook", 'b', 
İt_nÙebook
, 
CÍ_V®SŒšg
, 
CÍ_Neg©e
 },

742 { "gid", 'g', 
İt_gid
, 
CÍ_V®SŒšg
, 0 },

743 { "Œ“-¡©s", 0, 
İt_Œ“_¡©s
, 0, 0 },

744 { "¡©s", 0, 
İt_¡©s
, 0, 0 },

745 { "com·»", 'c', 
İt_com·»
, 
CÍ_V®SŒšg
, 0 },

746 { "cÜes", 0, 
İt_cÜes
, 
CÍ_V®SŒšg
, 0 },

747 { "y¿nge", 0, 
İt_y¿nge
, 
CÍ_V®SŒšg
, 0 },

748 { "no-run", 'n', 
İt_no_run
, 0, 0 },

749 { "h–p", 0, 
İt_h–p
, 0, 0 }

752 
	$h–p
() {

753 
	`´štf
("Masstree-beta mttest\n\
: mttest [-jTHREADS] [OPTIONS] [PARAM=VALUE...] TEST...\n\
 -n -c TESTNAME...\n\
\n\
:\n\
-j, --threads=THREADS Run with THREADShreads (default %d).\n\
-p, --pin Pinƒachhreado its own core.\n\
-T, --trials=TRIALS Runƒachest TRIALSimes.\n\
-q, --quiet Do‚ot generate verbose‡nd Gnuplot output.\n\
-l, --limit=LIMIT Limit„elevantestso LIMIT operations.\n\
-d, --duration=TIME Limit„elevantestso TIME seconds.\n\
-b, --notebook=FILE Record JSON„esults in FILE (notebook-mttest.json).\n\
--no-notebook Do‚ot„ecord JSON„esults.\n\
\n\
-n, --no-run Do‚ot„un‚ewests.\n\
-c, --compare=EXPERIMENT Generated…lot compareso EXPERIMENT.\n\
--yrange=YRANGE Set Y„ange for…lot.\n\
\n\
 TESTs:\n",

772 (è
	`syscÚf
(
_SC_NPROCESSORS_ONLN
));

773 
‹¡ruÂ”_ba£
::
	`´št_Çmes
(
¡dout
, 5);

774 
	`´štf
("Or say TEST1,TEST2,...o„un severalests in sequence\n\
he sameree.\n");

776 
	`ex™
(0);

777 
	}
}

779 
run_Úe_‹¡
(
ŒŸl
, cÚ¡ *
Œ“ty³
, cÚ¡ *
‹¡
,

780 cÚ¡ *
cŞËùÜpe
, 
Äuns
);

781 ’um { 
	mnÜmty³_nÚe
, 
	mnÜmty³_³¹e¡
, 
	mnÜmty³_fœ¡‹¡
 };

782 
´št_gnu¶Ù
(
FILE
 *
f
, cÚ¡ * cÚ¡ *
ty³s_begš
, cÚ¡ * cÚ¡ *
ty³s_’d
, 
¡d
::
veùÜ
<
SŒšg
> &
com·risÚs
, 
nÜm®iz‘y³
);

783 
upd©e_ÏbnÙebook
(
SŒšg
 
nÙebook
);

785 #ià
HAVE_EXECINFO_H


786 cÚ¡ 
	gabÜbË_sigÇls
[] = {

787 
SIGSEGV
, 
SIGBUS
, 
SIGILL
, 
SIGABRT
, 
SIGFPE


790 
	$abÜbË_sigÇl_hªdËr
() {

792 cÚ¡ * 
™
 = 
abÜbË_sigÇls
;

793 
™
 !ğ
abÜbË_sigÇls
 + 
	`¬¿ysize
(abortable_signals); ++it)

794 
	`sigÇl
(*
™
, 
SIG_DFL
);

796 * 
»tuº_addrs
[50];

797 
n
 = 
	`backŒaû
(
»tuº_addrs
, 
	`¬¿ysize
(return_addrs));

798 
	`backŒaû_symbŞs_fd
(
»tuº_addrs
, 
n
, 
STDERR_FILENO
);

800 
	`abÜt
();

801 
	}
}

805 
	$maš
(
¬gc
, *
¬gv
[])

807 
th»adcouÁ”_Çmes
[(è
tc_roÙ_»Œy
] = "root_retry";

808 
th»adcouÁ”_Çmes
[(è
tc_š‹ºode_»Œy
] = "internode_retry";

809 
th»adcouÁ”_Çmes
[(è
tc_Ëaf_»Œy
] = "leaf_retry";

810 
th»adcouÁ”_Çmes
[(è
tc_Ëaf_w®k
] = "leaf_walk";

811 
th»adcouÁ”_Çmes
[(è
tc_¡abË_š‹ºode_š£¹
] = "stable_internode_insert";

812 
th»adcouÁ”_Çmes
[(è
tc_¡abË_š‹ºode_¥l™
] = "stable_internode_split";

813 
th»adcouÁ”_Çmes
[(è
tc_¡abË_Ëaf_š£¹
] = "stable_leaf_insert";

814 
th»adcouÁ”_Çmes
[(è
tc_¡abË_Ëaf_¥l™
] = "stable_leaf_split";

815 
th»adcouÁ”_Çmes
[(è
tc_š‹ºode_lock
] = "internode_lock_retry";

816 
th»adcouÁ”_Çmes
[(è
tc_Ëaf_lock
] = "leaf_lock_retry";

818 
»t
, 
ÁrŸls
 = 1, 
nÜmty³
 = 
nÜmty³_³¹e¡
, 
fœ¡cÜe
 = -1, 
cÜe¡ride
 = 1;

819 
¡d
::
veùÜ
<cÚ¡ *> 
‹¡s
, 
Œ“ty³s
;

820 
¡d
::
veùÜ
<
SŒšg
> 
com·risÚs
;

821 cÚ¡ *
nÙebook
 = "notebook-mttest.json";

822 
tıth»ads
 = 
ud±h»ads
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

824 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, (è
	`¬¿ysize
(
İtiÚs
), options);

825 
	`CÍ_AddSŒšgLi¡Ty³
(
şp
, 
şp_v®_nÜm®ize
, 0,

826 "nÚe", (è
nÜmty³_nÚe
,

827 "³¹e¡", (è
nÜmty³_³¹e¡
,

828 "‹¡", (è
nÜmty³_³¹e¡
,

829 "fœ¡‹¡", (è
nÜmty³_fœ¡‹¡
,

831 
	`CÍ_AddTy³
(
şp
, 
şp_v®_suffixdoubË
, 
CÍ_Di§ÎowO±iÚs
, 
şp_·r£_suffixdoubË
, 0);

832 
İt
;

833 (
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
) {

834 
İt
) {

835 
İt_pš
:

836 
pšth»ads
 = !
şp
->
Ãg©ed
;

838 
İt_th»ads
:

839 
tıth»ads
 = 
ud±h»ads
 = 
şp
->
v®
.
i
;

841 
İt_ŒŸls
:

842 
ÁrŸls
 = 
şp
->
v®
.
i
;

844 
İt_qu›t
:

845 
qu›t
 = !
şp
->
Ãg©ed
;

847 
İt_´št
:

848 
´št_bË
 = !
şp
->
Ãg©ed
;

850 
İt_rsÿË_ncÜes
:

851 
rsÿË_ncÜes
 = 
şp
->
v®
.
i
;

853 
İt_pÜt
:

854 
pÜt
 = 
şp
->
v®
.
i
;

856 
İt_du¿tiÚ
:

857 
du¿tiÚ
[0] = 
şp
->
v®
.
d
;

859 
İt_Ïzy_tim”
:

860 
Ïzy_tim”
 = 
Œue
;

862 
İt_lim™
:

863 
‹¡_lim™
 = 
	`ušt64_t
(
şp
->
v®
.
d
);

865 
İt_‹¡
:

866 
‹¡s
.
	`push_back
(
şp
->
v¡r
);

868 
İt_‹¡_Çme
:

869 
‹¡s
.
	`push_back
(
şp
->
İtiÚ
->
lÚg_Çme
 + 5);

871 
İt_nÜm®ize
:

872 
nÜmty³
 = 
şp
->
Ãg©ed
 ? 
nÜmty³_nÚe
 : cÍ->
v®
.
i
;

874 
İt_gid
:

875 
gid
 = 
şp
->
v¡r
;

877 
İt_Œ“_¡©s
:

878 
Œ“_¡©s
 = 
Œue
;

880 
İt_¡©s
:

881 
jsÚ_¡©s
 = 
Œue
;

883 
İt_y¿nge
:

884 
gnu¶Ù_y¿nge
 = 
şp
->
v¡r
;

886 
İt_nÙebook
:

887 ià(
şp
->
Ãg©ed
)

888 
nÙebook
 = 0;

889 ià(
şp
->
have_v®
)

890 
nÙebook
 = 
şp
->
v¡r
;

892 
nÙebook
 = "notebook-mttest.json";

894 
İt_com·»
:

895 
com·risÚs
.
	`push_back
(
şp
->
v¡r
);

897 
İt_no_run
:

898 
ÁrŸls
 = 0;

900 
İt_cÜes
:

901 ià(
fœ¡cÜe
 >ğ0 || 
cÜes
.
	`size
() > 0) {

902 
	`CÍ_O±iÚE¼Ü
(
şp
, "%<%O%>‡lready given");

903 
	`ex™
(
EXIT_FAILURE
);

905 cÚ¡ *
¶us
 = 
	`¡rchr
(
şp
->
v¡r
, '+');

906 
JsÚ
 
ij
 = JsÚ::
	`·r£
(
şp
->
v¡r
),

907 
aj
 = 
JsÚ
::
	`·r£
(
	`SŒšg
("["è+ SŒšg(
şp
->
v¡r
) + String("]")),

908 
pj1
 = 
JsÚ
::
	`·r£
(
¶us
 ? 
	`SŒšg
(
şp
->
v¡r
,…lus) : "x"),

909 
pj2
 = 
JsÚ
::
	`·r£
(
¶us
 ? 
	`SŒšg
(plus + 1) : "x");

910 
i
 = 0; 
aj
 && i <‡j.
	`size
(); ++i)

911 ià(!
aj
[
i
].
	`is_št
(è||‡j[i].
	`to_i
() < 0)

912 
aj
 = 
	`JsÚ
();

913 ià(
ij
 && ij.
	`is_št
(è&& ij.
	`to_i
() >= 0)

914 
fœ¡cÜe
 = 
ij
.
	`to_i
(), 
cÜe¡ride
 = 1;

915 ià(
pj1
 && 
pj2
 &&…j1.
	`is_št
(è&&…j1.
	`to_i
() >= 0 &&…j2.is_int())

916 
fœ¡cÜe
 = 
pj1
.
	`to_i
(), 
cÜe¡ride
 = 
pj2
.to_i();

917 ià(
aj
) {

918 
i
 = 0; i < 
aj
.
	`size
(); ++i)

919 
cÜes
.
	`push_back
(
aj
[
i
].
	`to_i
());

921 
	`CÍ_O±iÚE¼Ü
(
şp
, "bad %<%O%>,ƒxpected %<CORE1%>, %<CORE1+STRIDE%>, or %<CORE1,CORE2,...%>");

922 
	`ex™
(
EXIT_FAILURE
);

926 
İt_h–p
:

927 
	`h–p
();

929 
CÍ_NÙO±iÚ
:

931 ià(cÚ¡ * 
eqchr
 = 
	`¡rchr
(
şp
->
v¡r
, '=')) {

932 
JsÚ
& 
·¿m
 = 
‹¡_·¿m
[
	`SŒšg
(
şp
->
v¡r
, 
eqchr
)];

933 cÚ¡ * 
’d_v¡r
 = 
şp
->
v¡r
 + 
	`¡¾’
(clp->vstr);

934 ià(
·¿m
.
	`assign_·r£
(
eqchr
 + 1, 
’d_v¡r
))

936 ià(
eqchr
[1] != 0)

937 
·¿m
 = 
	`SŒšg
(
eqchr
 + 1, 
’d_v¡r
);

939 
·¿m
 = 
	`JsÚ
();

942 
boŞ
 
is_Œ“ty³
 = 
çl£
;

943 
i
 = 0; i < (è
	`¬¿ysize
(
‹¡_th»ad_m­
è&& !
is_Œ“ty³
; ++i)

944 
is_Œ“ty³
 = (
	`¡rcmp
(
‹¡_th»ad_m­
[
i
].
Œ“ty³
, 
şp
->
v¡r
) == 0);

945 (
is_Œ“ty³
 ? 
Œ“ty³s
.
	`push_back
(
şp
->
v¡r
è: 
‹¡s
.push_back(clp->vstr));

949 
	`årštf
(
¡d”r
, "Usage: mttest [-jN] TESTS...\n\
 'mttest --help' for options.\n");

951 
	`ex™
(
EXIT_FAILURE
);

954 
	`CÍ_D–‘eP¬£r
(
şp
);

955 ià(
fœ¡cÜe
 < 0)

956 
fœ¡cÜe
 = 
cÜes
.
	`size
(è? cÜes.
	`back
() + 1 : 0;

957 ; (è
cÜes
.
	`size
(è< 
ud±h»ads
; 
fœ¡cÜe
 +ğ
cÜe¡ride
)

958 
cÜes
.
	`push_back
(
fœ¡cÜe
);

960 #ià
PMC_ENABLED


961 
	`®ways_as£¹
(
pšth»ads
 && "Using…erformance counter„equires…inninghreadso cores!");

963 #ià
MEMSTATS
 && 
HAVE_NUMA_H
 && 
HAVE_LIBNUMA


964 ià(
	`numa_avaabË
() != -1)

965 
i
 = 0; i <ğ
	`numa_max_node
(); i++) {

966 
numa
.
	`push_back
(
	`m‰e¡_numašfo
());

967 
numa
.
	`back
().
size
 = 
	`numa_node_size64
(
i
, &numa.back().
ä“
);

970 #ià
HAVE_EXECINFO_H


971 cÚ¡ * 
™
 = 
abÜbË_sigÇls
;

972 
™
 !ğ
abÜbË_sigÇls
 + 
	`¬¿ysize
(abortable_signals); ++it)

973 
	`sigÇl
(*
™
, 
abÜbË_sigÇl_hªdËr
);

976 ià(
Œ“ty³s
.
	`em±y
())

977 
Œ“ty³s
.
	`push_back
("m");

978 ià(
‹¡s
.
	`em±y
())

979 
‹¡s
.
	`push_back
("rw1");

981 
	`±h»ad_mu‹x_š™
(&
sub‹¡_mu‹x
, 0);

982 
	`±h»ad_cÚd_š™
(&
sub‹¡_cÚd
, 0);

985 
p
[2];

986 
»t
 = 
	`pe
(
p
);

987 
	`®ways_as£¹
(
»t
 == 0);

988 
‹¡_ouut_fe
 = 
	`fdİ’
(
p
[1], "w");

990 
±h»ad_t
 
cŞËùÜ
;

991 
»t
 = 
	`±h»ad_ü—‹
(&
cŞËùÜ
, 0, 
¡©_cŞËùÜ
, (*è(
šŒ_t
è
p
[0]);

992 
	`®ways_as£¹
(
»t
 == 0);

993 
š™Ÿl_time¡amp
 = 
	`time¡amp
();

996 
Äuns
 = 
ÁrŸls
 * (è
‹¡s
.
	`size
(è* (è
Œ“ty³s
.size();

997 
¡d
::
veùÜ
<> 
	`ruÆi¡
(
Äuns
, 0);

998 
i
 = 0; i < 
Äuns
; ++i)

999 
ruÆi¡
[
i
] = i;

1001 
couÁ”
 = 0; couÁ” < 
Äuns
; ++counter) {

1002 
x
 = 
	`¿ndom
(è% 
ruÆi¡
.
	`size
();

1003 
run
 = 
ruÆi¡
[
x
];

1004 
ruÆi¡
[
x
] =„uÆi¡.
	`back
();

1005 
ruÆi¡
.
	`pİ_back
();

1007 
ŒŸl
 = 
run
 % 
ÁrŸls
;

1008 
run
 /ğ
ÁrŸls
;

1009 
t
 = 
run
 % 
‹¡s
.
	`size
();

1010 
run
 /ğ
‹¡s
.
	`size
();

1011 
‰
 = 
run
;

1013 
	`årštf
(
¡d”r
, "%d/%u %s/%s%s", 
couÁ”
 + 1, (è(
ÁrŸls
 * 
‹¡s
.
	`size
(è* 
Œ“ty³s
.size()),

1014 
‹¡s
[
t
], 
Œ“ty³s
[
‰
], 
qu›t
 ? " " : "\n");

1016 
	`run_Úe_‹¡
(
ŒŸl
, 
Œ“ty³s
[
‰
], 
‹¡s
[
t
], 
p
, 
Äuns
);

1017 
timev®
 
d–ay
;

1018 
d–ay
.
tv_£c
 = 0;

1019 
d–ay
.
tv_u£c
 = 250000;

1020 (è
	`£Ëù
(0, 0, 0, 0, &
d–ay
);

1022 ià(
qu›t
)

1023 
	`årštf
(
¡d”r
, "\r%60s\r", "");

1026 
	`fşo£
(
‹¡_ouut_fe
);

1027 
	`±h»ad_još
(
cŞËùÜ
, 0);

1030 ià(
nÙebook
)

1031 
	`upd©e_ÏbnÙebook
(
nÙebook
);

1034 ià(
ÁrŸls
 != 0)

1035 
com·risÚs
.
	`š£¹
(com·risÚs.
	`begš
(), "");

1036 ià(!
	`i§‰y
(
STDOUT_FILENO
è|| (
ÁrŸls
 =ğ0 && 
com·risÚs
.
	`size
()))

1037 
	`´št_gnu¶Ù
(
¡dout
, 
kv¡©s_Çme
, kv¡©s_Çm+ 
	`¬¿ysize
(kvstats_name),

1038 
com·risÚs
, 
nÜmty³
);

1041 
	}
}

1043 
	$run_Úe_‹¡_body
(
ŒŸl
, cÚ¡ *
Œ“ty³
, cÚ¡ *
‹¡
) {

1044 
th»adšfo
 *
maš_ti
 =h»adšfo::
	`make
Ñh»adšfo::
TI_MAIN
, -1);

1045 
maš_ti
->
	`±h»ad
(èğ
	`±h»ad_£lf
();

1046 
glob®•och
 = 
aùive_•och
 = 
	`time¡amp
() >> 16;

1047 
i
 = 0; i < (è
	`¬¿ysize
(
‹¡_th»ad_m­
); ++i)

1048 ià(
	`¡rcmp
(
‹¡_th»ad_m­
[
i
].
Œ“ty³
,reetype) == 0) {

1049 
cu¼’t_‹¡_Çme
 = 
‹¡
;

1050 
cu¼’t_ŒŸl
 = 
ŒŸl
;

1051 
‹¡_th»ad_m­
[
i
].
	`£tup_func
(
maš_ti
, 
‹¡_th»ad_š™Ÿlize
);

1052 
	`ruÁe¡
(
tıth»ads
, 
‹¡_th»ad_m­
[
i
].
go_func
);

1053 ià(
Œ“_¡©s
)

1054 
‹¡_th»ad_m­
[
i
].
	`£tup_func
(
maš_ti
, 
‹¡_th»ad_¡©s
);

1055 
‹¡_th»ad_m­
[
i
].
	`£tup_func
(
maš_ti
, 
‹¡_th»ad_de¡roy
);

1058 
	}
}

1060 
	$run_Úe_‹¡
(
ŒŸl
, cÚ¡ *
Œ“ty³
, cÚ¡ *
‹¡
,

1061 cÚ¡ *
cŞËùÜpe
, 
Äuns
) {

1062 ià(
Äuns
 == 1)

1063 
	`run_Úe_‹¡_body
(
ŒŸl
, 
Œ“ty³
, 
‹¡
);

1065 
pid_t
 
c
 = 
	`fÜk
();

1066 ià(
c
 == 0) {

1067 
	`şo£
(
cŞËùÜpe
[0]);

1068 
	`run_Úe_‹¡_body
(
ŒŸl
, 
Œ“ty³
, 
‹¡
);

1069 
	`ex™
(0);

1071 
	`wa™pid
(
c
, 0, 0è=ğ-1 && 
”ºo
 =ğ
EINTR
)

1074 
	}
}

1076 
Ëv–
(cÚ¡ 
¡d
::
veùÜ
<> &
v
, 
äac
) {

1077 
	gäac
 *ğ
v
.
size
() - 1;

1078 
	gba£
 = (è
äac
;

1079 ià(
	gba£
 =ğ
äac
)

1080  
v
[
ba£
];

1082  
	gv
[
ba£
] * (1 - (
	gäac
 - 
	gba£
)) + v[base + 1] * (frac - base);

1085 
SŒšg
 
	$ex³rim’t_‹¡_bË_ŒŸl
(cÚ¡ 
SŒšg
 &
key
) {

1086 cÚ¡ *
l
 = 
key
.
	`begš
(), *
r
 = key.
	`’d
();

1087 ià(
l
 + 2 < 
r
 &&†[0] =ğ'x' && 
	`isdig™
(()†[1])) {

1088 cÚ¡ *
s
 = 
l
; s !ğ
r
; ++s)

1089 ià(*
s
 == '/') {

1090 
l
 = 
s
 + 1;

1094  
key
.
	`sub¡ršg
(
l
, 
r
);

1095 
	}
}

1097 
SŒšg
 
	$ex³rim’t_run_‹¡_bË
(cÚ¡ 
SŒšg
 &
key
) {

1098 cÚ¡ *
l
 = 
key
.
	`begš
(), *
r
 = key.
	`’d
();

1099 cÚ¡ *
s
 = 
r
; s !ğ
l
; --s)

1100 ià(
s
[-1] == '/') {

1101 
r
 = 
s
 - 1;

1103 } ià(!
	`isdig™
((è
s
[-1]))

1105  
key
.
	`sub¡ršg
(
l
, 
r
);

1106 
	}
}

1108 
SŒšg
 
	$ex³rim’t_‹¡_bË
(cÚ¡ 
SŒšg
 &
key
) {

1109  
	`ex³rim’t_run_‹¡_bË
(
	`ex³rim’t_‹¡_bË_ŒŸl
(
key
));

1110 
	}
}

1112 
	gÇme¥aû
 {

1113 
	sgnu¶Ù_šfo
 {

1114 
cÚ¡ex´
 
	gŒŸld–
 = 0.015, 
	gŒ“ty³d–
 = 0.04,

1115 
	g‹¡d–
 = 0.08, 
	gty³d–
 = 0.2;

1116 
	gpos
;

1117 
	gÃxtd–
;

1118 
	gnÜm®iz©iÚ
;

1119 
SŒšg
 
	gÏ¡_‹¡
;

1120 
	gnÜm®iz‘y³
;

1122 
	g¡d
::
veùÜ
<
lcdf
::
SŒšgAccum
> 
ÿndË¡icks
;

1123 
	g¡d
::
veùÜ
<
lcdf
::
SŒšgAccum
> 
medŸns
;

1124 
	glcdf
::
SŒšgAccum
 
xtics
;

1126 
gnu¶Ù_šfo
(
Á
)

1127 : 
pos
(1 - 
ŒŸld–
), 
Ãxtd–
ÑrŸld–), 
nÜm®iz©iÚ
(-1),

1128 
nÜm®iz‘y³
(
Á
) {

1130 
Úe
(cÚ¡ 
SŒšg
 &
xÇme
, 
ti
, cÚ¡ SŒšg &
d©©y³_Çme
);

1131 
´št
(
FILE
 *
f
, cÚ¡ * cÚ¡ *
ty³s_begš
);

1133 
cÚ¡ex´
 
	ggnu¶Ù_šfo
::
ŒŸld–
, gnu¶Ù_šfo::
Œ“ty³d–
, gnu¶Ù_šfo::
‹¡d–
, gnu¶Ù_šfo::
ty³d–
;

1135 
	ggnu¶Ù_šfo
::
Úe
(cÚ¡ 
SŒšg
 &
xÇme
, 
ti
, cÚ¡ SŒšg &
d©©y³_Çme
)

1137 
SŒšg
 
	gcu¼’t_‹¡
 = 
ex³rim’t_‹¡_bË
(
xÇme
);

1138 ià(
	gcu¼’t_‹¡
 !ğ
Ï¡_‹¡
) {

1139 
Ï¡_‹¡
 = 
cu¼’t_‹¡
;

1140 ià(
	gnÜm®iz‘y³
 =ğ
nÜmty³_³¹e¡
)

1141 
nÜm®iz©iÚ
 = -1;

1142 ià(
	gÃxtd–
 =ğ
Œ“ty³d–
)

1143 
Ãxtd–
 = 
‹¡d–
;

1145 
	gbegšpos
 = 
pos
, 
	gfœ¡pos
 =…o + 
Ãxtd–
;

1147 
	g¡d
::
veùÜ
<> 
ŒŸls
;

1148 
	gJsÚ
::
objeù_™”©Ü
 
™
 = 
ex³rim’t_¡©s
.
obegš
();

1149 
	g™
 !ğ
ex³rim’t_¡©s
.
Ûnd
(); ++it) {

1150 
SŒšg
 
	gkey
 = 
™
.
key
();

1151 ià(
ex³rim’t_run_‹¡_bË
(
key
è=ğ
xÇme
)

1152 
ŒŸls
.
push_back
(
¡¹Ş
(
key
.
c_¡r
(è+ 
xÇme
.
Ëngth
() + 1, 0, 0));

1154 
	g¡d
::
sÜt
(
ŒŸls
.
begš
(),rŸls.
’d
());

1156 
	g¡d
::
veùÜ
<>::
™”©Ü
 
t™
 = 
ŒŸls
.
begš
();

1157 
	gt™
 !ğ
ŒŸls
.
’d
(); ++tit) {

1158 
	gJsÚ
 &
	gthis_ŒŸl
 = 
ex³rim’t_¡©s
[
xÇme
 + "/" + 
SŒšg
(*
t™
)];

1159 
	g¡d
::
veùÜ
<> 
v®ues
;

1160 
	gjn
 = 0; jÀ< 
	gthis_ŒŸl
.
size
(); ++jn)

1161 ià(
	gthis_ŒŸl
[
jn
].
g‘
(
d©©y³_Çme
).
is_numb”
())

1162 
	gv®ues
.
push_back
(
this_ŒŸl
[
jn
].
g‘
(
d©©y³_Çme
).
to_d
());

1163 ià(
	gv®ues
.
size
()) {

1164 
	gpos
 +ğ
Ãxtd–
;

1165 
	g¡d
::
sÜt
(
v®ues
.
begš
(), v®ues.
’d
());

1166 ià(
	gnÜm®iz©iÚ
 < 0)

1167 
	gnÜm®iz©iÚ
 = 
nÜm®iz‘y³
 =ğ
nÜmty³_nÚe
 ? 1 : 
Ëv–
(
v®ues
, 0.5);

1168 ià((
	gÿndË¡icks
.
size
()è<ğ
ti
) {

1169 
ÿndË¡icks
.
»size
(
ti
 + 1);

1170 
	gmedŸns
.
»size
(
ti
 + 1);

1172 
	gÿndË¡icks
[
ti
] << 
	gpos
 << " " << 
Ëv–
(
v®ues
, 0)

1173 << " " << 
Ëv–
(
v®ues
, 0.25)

1174 << " " << 
Ëv–
(
v®ues
, 0.75)

1175 << " " << 
Ëv–
(
v®ues
, 1)

1176 << " " << 
	gnÜm®iz©iÚ
 << "\n";

1177 
	gmedŸns
[
ti
] << 
	gpos
 << " " << 
Ëv–
(
v®ues
, 0.5è<< " " << 
	gnÜm®iz©iÚ
 << "\n";

1178 
	gÃxtd–
 = 
ŒŸld–
;

1182 ià(
	gpos
 > 
	gbegšpos
) {

1183 
	gmiddË
 = (
fœ¡pos
 + 
pos
) / 2;

1184 
	gxtics
 << (xtic ? ", " : ""è<< "\"" << 
xÇme
 << "\" " << 
middË
;

1185 
	gÃxtd–
 = 
Œ“ty³d–
;

1189 
	ggnu¶Ù_šfo
::
´št
(
FILE
 *
f
, cÚ¡ * cÚ¡ *
ty³s_begš
) {

1190 
	g¡d
::
veùÜ
<> 
lš‘y³s
(
medŸns
.
size
(), 0);

1191 
	gÃxt_lš‘y³
 = 1;

1192 
	gi
 = 0; i < (
	gmedŸns
.
size
()); ++i)

1193 ià(
	gmedŸns
[
i
])

1194 
	glš‘y³s
[
i
] = 
Ãxt_lš‘y³
++;

1195 
ut¢ame
 
	gÇme
;

1196 
årštf
(
f
, "setitle \"%s (%d cores)\"\n",

1197 (
uÇme
(&
Çme
è=ğ0 ?‚ame.
nod’ame
 : "unknown"),

1198 
ud±h»ads
);

1199 
årštf
(
f
, "seterminal…ng\n");

1200 
årštf
(
f
, "£ˆx¿ng[%g:%g]\n", 1 - 
Œ“ty³d–
, 
pos
 +reetypedelta);

1201 ià(
	ggnu¶Ù_y¿nge
)

1202 
årštf
(
f
, "£ˆy¿ng[%s]\n", 
gnu¶Ù_y¿nge
.
c_¡r
());

1203 
årštf
(
f
, "£ˆxtic rÙ©by 45„ighˆ(%sèfÚˆ\"V”dªa,9\"\n", 
xtics
.
c_¡r
());

1204 
årštf
(
f
, "set keyop†eft Left„everse\n");

1205 ià(
	gnÜm®iz‘y³
 =ğ
nÜmty³_nÚe
)

1206 
årštf
(
f
, "set ylabel \"count\"\n");

1207 ià(
	gnÜm®iz‘y³
 =ğ
nÜmty³_³¹e¡
)

1208 
årštf
(
f
, "set ylabel \"count,‚ormalized…erest\"\n");

1210 
årštf
(
f
, "£ˆyÏb– \"nÜm®ized couÁ (1=%f)\"\n", 
nÜm®iz©iÚ
);

1211 cÚ¡ *
	g£p
 = "plot ";

1212 
	gi
 = 0; i < (
	gmedŸns
.
size
()); ++i)

1213 ià(
	gmedŸns
[
i
]) {

1214 
årštf
(
f
, "%s '-' using 1:($3/$6):($2/$6):($5/$6):($4/$6) with candlesticks†t %ditle '%s', \\\n",

1215 
£p
, 
lš‘y³s
[
i
], 
ty³s_begš
[i]);

1216 
årštf
(
f
, " '-' usšg 1:($2/$3):($2/$3):($2/$3):($2/$3èw™h cªdË¡ick É %d‚Ù™Ë", 
lš‘y³s
[
i
]);

1217 
	g£p
 = ", \\\n";

1219 
årštf
(
f
, "\n");

1220 
	gi
 = 0; i < (
	gmedŸns
.
size
()); ++i)

1221 ià(
	gmedŸns
[
i
]) {

1222 
fwr™e
(
ÿndË¡icks
[
i
].
begš
(), 1, cªdË¡icks[i].
Ëngth
(), 
f
);

1223 
årštf
(
f
, "e\n");

1224 
fwr™e
(
medŸns
[
i
].
begš
(), 1, medŸns[i].
Ëngth
(), 
f
);

1225 
årštf
(
f
, "e\n");

1231 
´št_gnu¶Ù
(
FILE
 *
f
, cÚ¡ * cÚ¡ *
ty³s_begš
, cÚ¡ * cÚ¡ *
ty³s_’d
,

1232 
¡d
::
veùÜ
<
SŒšg
> &
com·risÚs
, 
nÜm®iz‘y³
) {

1233 
	g¡d
::
veùÜ
<
SŒšg
>::
™”©Ü
 
c™
 = 
com·risÚs
.
begš
();

1234 
	gc™
 !ğ
com·risÚs
.
’d
(); ++cit) {

1235 ià(!*
	gc™
)

1236 *
	gc™
 = "[^x]*";

1237 ià(
	gc™
->
Ëngth
(è>ğ2 && (*
c™
)[0] =ğ'x' && 
isdig™
(() (*cit)[1]))

1238 *
c™
 +ğ
SŒšg
(c™->
fšd_Ëá
('/') < 0 ? "/*" : "*");

1240 *
	gc™
 = 
SŒšg
("x*"è+ *
c™
 + String("*");

1243 
	g¡d
::
veùÜ
<
SŒšg
> 
®l_v”siÚs
, 
	g®l_ex³rim’ts
;

1244 
	gJsÚ
::
objeù_™”©Ü
 
™
 = 
ex³rim’t_¡©s
.
obegš
();

1245 
	g™
 !ğ
ex³rim’t_¡©s
.
Ûnd
(); ++it)

1246 
	g¡d
::
veùÜ
<
SŒšg
>::
cÚ¡_™”©Ü
 
c™
 = 
com·risÚs
.
begš
();

1247 
	gc™
 !ğ
com·risÚs
.
’d
(); ++cit)

1248 ià(
	g™
.
key
().
glob_m©ch
(*
c™
)) {

1249 
	g®l_ex³rim’ts
.
push_back
(
ex³rim’t_run_‹¡_bË
(
™
.
key
()));

1250 
	g®l_v”siÚs
.
push_back
(
ex³rim’t_‹¡_bË
(
™
.
key
()));

1253 
	g¡d
::
sÜt
(
®l_ex³rim’ts
.
begš
(),‡Î_ex³rim’ts.
’d
());

1254 
	g®l_ex³rim’ts
.
”a£
(
¡d
::
unique
(
®l_ex³rim’ts
.
begš
(),‡Î_ex³rim’ts.
’d
()),

1255 
®l_ex³rim’ts
.
’d
());

1256 
	g¡d
::
sÜt
(
®l_v”siÚs
.
begš
(),‡Î_v”siÚs.
’d
());

1257 
	g®l_v”siÚs
.
”a£
(
¡d
::
unique
(
®l_v”siÚs
.
begš
(),‡Î_v”siÚs.
’d
()),

1258 
®l_v”siÚs
.
’d
());

1260 
	gÁy³s
 = (è(
ty³s_’d
 - 
ty³s_begš
);

1261 
gnu¶Ù_šfo
 
gpšfo
(
nÜm®iz‘y³
);

1263 
	gti
 = 0;˜< 
	gÁy³s
; ++ti) {

1264 
	gty³pos
 = 
gpšfo
.
pos
;

1265 
	g¡d
::
veùÜ
<
SŒšg
>::
™”©Ü
 
v™
 = 
®l_v”siÚs
.
begš
();

1266 
	gv™
 !ğ
®l_v”siÚs
.
’d
(); ++vit) {

1267 
	g¡d
::
veùÜ
<
SŒšg
>::
™”©Ü
 
x™
 = 
®l_ex³rim’ts
.
begš
();

1268 
	gx™
 !ğ
®l_ex³rim’ts
.
’d
(); ++xit)

1269 ià(
ex³rim’t_‹¡_bË
(*
x™
è=ğ*
v™
)

1270 
gpšfo
.
Úe
(*
x™
, 
ti
, 
ty³s_begš
[ti]);

1272 ià(
	ggpšfo
.
	gpos
 > 
	gty³pos
)

1273 
	ggpšfo
.
	gÃxtd–
 = 
gpšfo
.
ty³d–
;

1274 
	ggpšfo
.
	gÏ¡_‹¡
 = "";

1277 ià(
	ggpšfo
.
	gxtics
)

1278 
	ggpšfo
.
´št
(
f
, 
ty³s_begš
);

1281 
SŒšg


1282 
	$»ad_fe
(
FILE
 *
f
, cÚ¡ *
Çme
)

1284 
lcdf
::
SŒšgAccum
 
§
;

1286 
size_t
 
x
 = 
	`ä—d
(
§
.
	`»£rve
(4096), 1, 4096, 
f
);

1287 ià(
x
 != 0)

1288 
§
.
	`adju¡_Ëngth
(
x
);

1289 ià(
	`ã¼Ü
(
f
)) {

1290 
	`årštf
(
¡d”r
, "%s: %s\n", 
Çme
, 
	`¡»¼Ü
(
”ºo
));

1291  
SŒšg
::
	`make_¡abË
("???", 3);

1293  
§
.
	`ke_¡ršg
();

1295 
	}
}

1298 
	$upd©e_ÏbnÙebook
(
SŒšg
 
nÙebook
)

1300 
FILE
 *
f
 = (
nÙebook
 =ğ"-" ? 
¡dš
 : 
	`fİ’
ÒÙebook.
	`c_¡r
(), "r"));

1301 
SŒšg
 
´evious_‹xt
 = (
f
 ? 
	`»ad_fe
(f, 
nÙebook
.
	`c_¡r
()è: 
	`SŒšg
());

1302 ià(
´evious_‹xt
.
	`out_of_memÜy
())

1304 ià(
f
 && f !ğ
¡dš
)

1305 
	`fşo£
(
f
);

1307 
JsÚ
 
nb
 = JsÚ::
	`·r£
(
´evious_‹xt
);

1308 ià(
´evious_‹xt
 && (!
nb
.
	`is_objeù
() || !nb["experiments"])) {

1309 
	`årštf
(
¡d”r
, "%s: uÃx³ùed cÚ‹Ás,‚Ù wr™šg‚ew d©a\n", 
nÙebook
.
	`c_¡r
());

1313 ià(!
nb
)

1314 
nb
 = 
JsÚ
::
	`make_objeù
();

1315 ià(!
nb
.
	`g‘
("experiments"))

1316 
nb
.
	`£t
("ex³rim’ts", 
JsÚ
::
	`make_objeù
());

1317 ià(!
nb
.
	`g‘
("data"))

1318 
nb
.
	`£t
("d©a", 
JsÚ
::
	`make_objeù
());

1320 
JsÚ
 
Şd_d©a
 = 
nb
["data"];

1321 ià(!
ex³rim’t_¡©s
) {

1322 
ex³rim’t_¡©s
 = 
Şd_d©a
;

1326 
JsÚ
 
xjsÚ
;

1328 
FILE
 *
g™_šfo_p
 = 
	`pİ’
("git„ev-parse HEAD |r -d '\n'; git --no-pager diff --exit-code --shortstat HEAD >/dev/null 2>&1 ||ƒcho M", "r");

1329 
SŒšg
 
g™_šfo
 = 
	`»ad_fe
(
g™_šfo_p
, "<git output>");

1330 
	`pşo£
(
g™_šfo_p
);

1331 ià(
g™_šfo
)

1332 
xjsÚ
.
	`£t
("g™-»visiÚ", 
g™_šfo
.
	`Œim
());

1334 
time_t
 
now
 = 
	`time
(0);

1335 
xjsÚ
.
	`£t
("time", 
	`SŒšg
(
	`ùime
(&
now
)).
	`Œim
());

1336 ià(
gid
)

1337 
xjsÚ
.
	`£t
("gid", 
	`SŒšg
(
gid
));

1339 
ut¢ame
 
Çme
;

1340 ià(
	`uÇme
(&
Çme
) == 0)

1341 
xjsÚ
.
	`£t
("machše", 
Çme
.
nod’ame
);

1343 
xjsÚ
.
	`£t
("cÜes", 
ud±h»ads
);

1345 
JsÚ
 &
runs
 = 
xjsÚ
.
	`g‘_š£¹
("runs");

1346 
SŒšg
 
xÇme
 = "x" + 
	`SŒšg
(
nb
["ex³rim’ts"].
	`size
());

1347 
JsÚ
::
cÚ¡_™”©Ü
 
™
 = 
ex³rim’t_¡©s
.
	`begš
();

1348 
™
 !ğ
ex³rim’t_¡©s
.
	`’d
(); ++it) {

1349 
SŒšg
 
xkey
 = 
xÇme
 + "/" + 
™
.
	`key
();

1350 
runs
.
	`push_back
(
xkey
);

1351 
nb
["d©a"][
xkey
] = 
™
.
	`v®ue
();

1353 
xjsÚ
.
	`£t
("runs", 
runs
);

1355 
nb
["ex³rim’ts"][
xÇme
] = 
xjsÚ
;

1357 
SŒšg
 
Ãw_‹xt
 = 
nb
.
	`uÅ¬£
(
JsÚ
::
	`šd’t_d•th
(4).
	`b_width
(2).
	`Ãwlše_‹rmš©Ü
(
Œue
));

1358 
f
 = (
nÙebook
 =ğ"-" ? 
¡dout
 : 
	`fİ’
(ÒÙebook + "~").
	`c_¡r
(), "w"));

1359 ià(!
f
) {

1360 
	`årštf
(
¡d”r
, "%s~: %s\n", 
nÙebook
.
	`c_¡r
(), 
	`¡»¼Ü
(
”ºo
));

1363 
size_t
 
wr™‹n
 = 
	`fwr™e
(
Ãw_‹xt
.
	`d©a
(), 1,‚ew_‹xt.
	`Ëngth
(), 
f
);

1364 ià(
wr™‹n
 !ğ
	`size_t
(
Ãw_‹xt
.
	`Ëngth
())) {

1365 
	`årštf
(
¡d”r
, "%s~: %s\n", 
nÙebook
.
	`c_¡r
(), 
	`¡»¼Ü
(
”ºo
));

1366 
	`fşo£
(
f
);

1369 ià(
f
 !ğ
¡dout
) {

1370 
	`fşo£
(
f
);

1371 ià(
	`»Çme
((
nÙebook
 + "~").
	`c_¡r
(),‚otebook.c_str()) != 0)

1372 
	`årštf
(
¡d”r
, "%s: %s\n", 
nÙebook
.
	`c_¡r
(), 
	`¡»¼Ü
(
”ºo
));

1375 
	`årštf
(
¡d”r
, "EXPERIMENT %s\n", 
xÇme
.
	`c_¡r
());

1376 
ex³rim’t_¡©s
.
	`m”ge
(
Şd_d©a
);

1377 
	}
}

	@masstree-beta/nodeversion.hh

16 #iâdeà
MASSTREE_NODEVERSION_HH


17 
	#MASSTREE_NODEVERSION_HH


	)

18 
	~"comp”.hh
"

20 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

21 şas 
	cnodev”siÚ
 {

22 
	mpublic
:

23 
P
 
	tŒa™s_ty³
;

24 
ty³Çme
 
	tP
::
	tv®ue_ty³
 value_type;

26 
	$nodev”siÚ
() {

28 
ex¶ic™
 
	$nodev”siÚ
(
boŞ
 
i¦—f
) {

29 
v_
 = 
i¦—f
 ? (
v®ue_ty³
è
P
::
i¦—f_b™
 : 0;

30 
	}
}

32 
boŞ
 
	$i¦—f
() const {

33  
v_
 & 
P
::
i¦—f_b™
;

34 
	}
}

36 
	gnodev”siÚ
<
	gP
> 
	$¡abË
() const {

37  
	`¡abË
(
	`»Ïx_ãnû_funùiÚ
());

38 
	}
}

39 
	g‹m¶©e
 <
ty³Çme
 
	gSF
>

40 
	gnodev”siÚ
<
	gP
> 
	$¡abË
(
SF
 
¥š_funùiÚ
) const {

41 
v®ue_ty³
 
x
 = 
v_
;

42 
x
 & 
P
::
dœty_mask
) {

43 
	`¥š_funùiÚ
();

44 
x
 = 
v_
;

46 
	`acquœe_ãnû
();

47  
x
;

48 
	}
}

49 
	g‹m¶©e
 <
ty³Çme
 
	gSF
>

50 
	gnodev”siÚ
<
	gP
> 
	$¡abË_ªnÙ©ed
(
SF
 
¥š_funùiÚ
) const {

51 
v®ue_ty³
 
x
 = 
v_
;

52 
x
 & 
P
::
dœty_mask
) {

53 
	`¥š_funùiÚ
(
nodev”siÚ
<
P
>(
x
));

54 
x
 = 
v_
;

56 
	`acquœe_ãnû
();

57  
x
;

58 
	}
}

60 
boŞ
 
	$locked
() const {

61  
v_
 & 
P
::
lock_b™
;

62 
	}
}

63 
boŞ
 
	$š£¹šg
() const {

64  
v_
 & 
P
::
š£¹šg_b™
;

65 
	}
}

66 
boŞ
 
	$¥l™tšg
() const {

67  
v_
 & 
P
::
¥l™tšg_b™
;

68 
	}
}

69 
boŞ
 
	$d–‘ed
() const {

70  
v_
 & 
P
::
d–‘ed_b™
;

71 
	}
}

72 
boŞ
 
has_chªged
(
nodev”siÚ
<
P
> 
x
) const {

73 
ãnû
();

74  (
	gx
.
	gv_
 ^ v_è> 
	gP
::
lock_b™
;

76 
boŞ
 
	$is_roÙ
() const {

77  
v_
 & 
P
::
roÙ_b™
;

78 
	}
}

79 
boŞ
 
has_¥l™
(
nodev”siÚ
<
P
> 
x
) const {

80 
ãnû
();

81  (
	gx
.
	gv_
 ^ v_è>ğ
P
::
v¥l™_lowb™
;

83 
boŞ
 
sim¶e_has_¥l™
(
nodev”siÚ
<
P
> 
x
) const {

84  (
	gx
.
	gv_
 ^ v_è>ğ
P
::
v¥l™_lowb™
;

87 
	gnodev”siÚ
<
	gP
> 
	$lock
() {

88  
	`lock
(*
this
);

89 
	}
}

90 
	gnodev”siÚ
<
	gP
> 
lock
(
nodev”siÚ
<
P
> 
ex³ùed
) {

91  
lock
(
ex³ùed
, 
»Ïx_ãnû_funùiÚ
());

93 
	g‹m¶©e
 <
ty³Çme
 
	gSF
>

94 
	gnodev”siÚ
<
	gP
> 
lock
(
nodev”siÚ
<
P
> 
ex³ùed
, 
SF
 
¥š_funùiÚ
) {

96 ià(!(
	gex³ùed
.
	gv_
 & 
	gP
::
lock_b™
)

97 && 
boŞ_cmpxchg
(&
v_
, 
ex³ùed
.v_,

98 
ex³ùed
.
v_
 | 
P
::
lock_b™
))

100 
¥š_funùiÚ
();

101 
	gex³ùed
.
	gv_
 = 
v_
;

103 
mas¡»e_šv¬ŸÁ
(!(
ex³ùed
.
v_
 & 
P
::
dœty_mask
));

104 
	gex³ùed
.
	gv_
 |ğ
P
::
lock_b™
;

105 
acquœe_ãnû
();

106 
mas¡»e_šv¬ŸÁ
(
ex³ùed
.
v_
 == v_);

107  
	gex³ùed
;

110 
	$uÆock
() {

111 
	`uÆock
(*
this
);

112 
	}
}

113 
uÆock
(
nodev”siÚ
<
P
> 
x
) {

114 
mas¡»e_šv¬ŸÁ
((
ãnû
(), 
x
.
v_
 == v_));

115 
mas¡»e_šv¬ŸÁ
(
x
.
v_
 & 
P
::
lock_b™
);

116 ià(
	gx
.
	gv_
 & 
	gP
::
¥l™tšg_b™
)

117 
x
.
v_
 = (x.v_ + 
P
::
v¥l™_lowb™
è& P::
¥l™_uÆock_mask
;

119 
	gx
.
	gv_
 = (
x
.
v_
 + ((x.v_ & 
P
::
š£¹šg_b™
è<< 2)è& P::
uÆock_mask
;

120 
»Ëa£_ãnû
();

121 
	gv_
 = 
x
.
v_
;

124 
	$m¬k_š£¹
() {

125 
	`mas¡»e_šv¬ŸÁ
(
	`locked
());

126 
v_
 |ğ
P
::
š£¹šg_b™
;

127 
	`acquœe_ãnû
();

128 
	}
}

129 
	gnodev”siÚ
<
	gP
> 
m¬k_š£¹
(
nodev”siÚ
<
P
> 
cu¼’t_v”siÚ
) {

130 
mas¡»e_šv¬ŸÁ
((
ãnû
(), 
v_
 =ğ
cu¼’t_v”siÚ
.v_));

131 
mas¡»e_šv¬ŸÁ
(
cu¼’t_v”siÚ
.
v_
 & 
P
::
lock_b™
);

132 
	gv_
 = (
cu¼’t_v”siÚ
.
v_
 |ğ
P
::
š£¹šg_b™
);

133 
acquœe_ãnû
();

134  
	gcu¼’t_v”siÚ
;

136 
	$m¬k_¥l™
() {

137 
	`mas¡»e_šv¬ŸÁ
(
	`locked
());

138 
v_
 |ğ
P
::
¥l™tšg_b™
;

139 
	`acquœe_ãnû
();

140 
	}
}

141 
	$m¬k_chªge
(
boŞ
 
is_¥l™
) {

142 
	`mas¡»e_šv¬ŸÁ
(
	`locked
());

143 
v_
 |ğ(
is_¥l™
 + 1è<< 
P
::
š£¹šg_shiá
;

144 
	`acquœe_ãnû
();

145 
	}
}

146 
	gnodev”siÚ
<
	gP
> 
	$m¬k_d–‘ed
() {

147 
	`mas¡»e_šv¬ŸÁ
(
	`locked
());

148 
v_
 |ğ
P
::
d–‘ed_b™
 | P::
¥l™tšg_b™
;

149 
	`acquœe_ãnû
();

150  *
this
;

151 
	}
}

152 
	$m¬k_d–‘ed_Œ“
() {

153 
	`mas¡»e_šv¬ŸÁ
(
	`locked
(è&& 
	`is_roÙ
());

154 
v_
 |ğ
P
::
d–‘ed_b™
;

155 
	`acquœe_ãnû
();

156 
	}
}

157 
	$m¬k_roÙ
() {

158 
v_
 |ğ
P
::
roÙ_b™
;

159 
	`acquœe_ãnû
();

160 
	}
}

161 
	$m¬k_nÚroÙ
() {

162 
v_
 &ğ~
P
::
roÙ_b™
;

163 
	`acquœe_ãnû
();

164 
	}
}

166 
assign_v”siÚ
(
nodev”siÚ
<
P
> 
x
) {

167 
	gv_
 = 
x
.
v_
;

170 
v®ue_ty³
 
	$v”siÚ_v®ue
() const {

171  
v_
;

172 
	}
}

173 
v®ue_ty³
 
	$uÆocked_v”siÚ_v®ue
() const {

174  
v_
 & 
P
::
uÆock_mask
;

175 
	}
}

177 
	g´iv©e
:

178 
v®ue_ty³
 
v_
;

180 
	$nodev”siÚ
(
v®ue_ty³
 
v
)

181 : 
	$v_
(
v
) {

182 
	}
}

186 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

187 şas 
	csšgËth»aded_nodev”siÚ
 {

188 
	mpublic
:

189 
P
 
	tŒa™s_ty³
;

190 
ty³Çme
 
	tP
::
	tv®ue_ty³
 value_type;

192 
	$sšgËth»aded_nodev”siÚ
() {

194 
ex¶ic™
 
	$sšgËth»aded_nodev”siÚ
(
boŞ
 
i¦—f
) {

195 
v_
 = 
i¦—f
 ? (
v®ue_ty³
è
P
::
i¦—f_b™
 : 0;

196 
	}
}

198 
boŞ
 
	$i¦—f
() const {

199  
v_
 & 
P
::
i¦—f_b™
;

200 
	}
}

202 
	gsšgËth»aded_nodev”siÚ
<
	gP
> 
	$¡abË
() const {

203  *
this
;

204 
	}
}

205 
	g‹m¶©e
 <
ty³Çme
 
	gSF
>

206 
	gsšgËth»aded_nodev”siÚ
<
	gP
> 
	$¡abË
(
SF
) const {

207  *
this
;

208 
	}
}

209 
	g‹m¶©e
 <
ty³Çme
 
	gSF
>

210 
	gsšgËth»aded_nodev”siÚ
<
	gP
> 
	$¡abË_ªnÙ©ed
(
SF
) const {

211  *
this
;

212 
	}
}

214 
boŞ
 
	$locked
() const {

215  
çl£
;

216 
	}
}

217 
boŞ
 
	$š£¹šg
() const {

218  
çl£
;

219 
	}
}

220 
boŞ
 
	$¥l™tšg
() const {

221  
çl£
;

222 
	}
}

223 
boŞ
 
	$d–‘ed
() const {

224  
çl£
;

225 
	}
}

226 
boŞ
 
has_chªged
(
sšgËth»aded_nodev”siÚ
<
P
>) const {

227  
	gçl£
;

229 
boŞ
 
	$is_roÙ
() const {

230  
v_
 & 
P
::
roÙ_b™
;

231 
	}
}

232 
boŞ
 
has_¥l™
(
sšgËth»aded_nodev”siÚ
<
P
>) const {

233  
	gçl£
;

235 
boŞ
 
sim¶e_has_¥l™
(
sšgËth»aded_nodev”siÚ
<
P
>) const {

236  
	gçl£
;

239 
	gsšgËth»aded_nodev”siÚ
<
	gP
> 
	$lock
() {

240  *
this
;

241 
	}
}

242 
	gsšgËth»aded_nodev”siÚ
<
	gP
> 
lock
(
sšgËth»aded_nodev”siÚ
<
P
>) {

243  *
	gthis
;

245 
	g‹m¶©e
 <
ty³Çme
 
	gSF
>

246 
	gsšgËth»aded_nodev”siÚ
<
	gP
> 
lock
(
sšgËth»aded_nodev”siÚ
<
P
>, 
SF
) {

247  *
	gthis
;

250 
	$uÆock
() {

251 
	}
}

252 
uÆock
(
sšgËth»aded_nodev”siÚ
<
P
>) {

255 
	$m¬k_š£¹
() {

256 
	}
}

257 
	gsšgËth»aded_nodev”siÚ
<
	gP
> 
m¬k_š£¹
(
sšgËth»aded_nodev”siÚ
<
P
>) {

258  *
	gthis
;

260 
	$m¬k_¥l™
() {

261 
v_
 &ğ~
P
::
roÙ_b™
;

262 
	}
}

263 
	$m¬k_chªge
(
boŞ
 
is_¥l™
) {

264 ià(
is_¥l™
)

265 
	`m¬k_¥l™
();

266 
	}
}

267 
	gsšgËth»aded_nodev”siÚ
<
	gP
> 
	$m¬k_d–‘ed
() {

268  *
this
;

269 
	}
}

270 
	$m¬k_d–‘ed_Œ“
() {

271 
v_
 |ğ
P
::
d–‘ed_b™
;

272 
	}
}

273 
	$m¬k_roÙ
() {

274 
v_
 |ğ
P
::
roÙ_b™
;

275 
	}
}

276 
	$m¬k_nÚroÙ
() {

277 
v_
 &ğ~
P
::
roÙ_b™
;

278 
	}
}

280 
assign_v”siÚ
(
sšgËth»aded_nodev”siÚ
<
P
> 
x
) {

281 
	gv_
 = 
x
.
v_
;

284 
v®ue_ty³
 
	$v”siÚ_v®ue
() const {

285  
v_
;

286 
	}
}

287 
v®ue_ty³
 
	$uÆocked_v”siÚ_v®ue
() const {

288  
v_
;

289 
	}
}

291 
	g´iv©e
:

292 
v®ue_ty³
 
v_
;

296 
	g‹m¶©e
 <
ty³Çme
 
	gV
> 
	snodev”siÚ_·¿m‘”s
 {};

298 
	g‹m¶©e
 <> 
	gnodev”siÚ_·¿m‘”s
<
	gušt32_t
> {

300 
	glock_b™
 = (1U << 0),

301 
	gš£¹šg_shiá
 = 1,

302 
	gš£¹šg_b™
 = (1U << 1),

303 
	g¥l™tšg_b™
 = (1U << 2),

304 
	gdœty_mask
 = 
š£¹šg_b™
 | 
¥l™tšg_b™
,

305 
	gvš£¹_lowb™
 = (1U << 3),

306 
	gv¥l™_lowb™
 = (1U << 9),

307 
	gunu£d1_b™
 = (1U << 28),

308 
	gd–‘ed_b™
 = (1U << 29),

309 
	groÙ_b™
 = (1U << 30),

310 
	gi¦—f_b™
 = (1U << 31),

311 
	g¥l™_uÆock_mask
 = ~(
roÙ_b™
 | 
unu£d1_b™
 | (
v¥l™_lowb™
 - 1)),

312 
	guÆock_mask
 = ~(
unu£d1_b™
 | (
vš£¹_lowb™
 - 1)),

313 
	gtİ_¡abË_b™s
 = 4

316 
ušt32_t
 
	tv®ue_ty³
;

319 
	g‹m¶©e
 <> 
	gnodev”siÚ_·¿m‘”s
<
	gušt64_t
> {

321 
	glock_b™
 = (1ULL << 8),

322 
	gš£¹šg_shiá
 = 9,

323 
	gš£¹šg_b™
 = (1ULL << 9),

324 
	g¥l™tšg_b™
 = (1ULL << 10),

325 
	gdœty_mask
 = 
š£¹šg_b™
 | 
¥l™tšg_b™
,

326 
	gvš£¹_lowb™
 = (1ULL << 11),

327 
	gv¥l™_lowb™
 = (1ULL << 27),

328 
	gunu£d1_b™
 = (1ULL << 60),

329 
	gd–‘ed_b™
 = (1ULL << 61),

330 
	groÙ_b™
 = (1ULL << 62),

331 
	gi¦—f_b™
 = (1ULL << 63),

332 
	g¥l™_uÆock_mask
 = ~(
roÙ_b™
 | 
unu£d1_b™
 | (
v¥l™_lowb™
 - 1)),

333 
	guÆock_mask
 = ~(
unu£d1_b™
 | (
vš£¹_lowb™
 - 1)),

334 
	gtİ_¡abË_b™s
 = 4

337 
ušt64_t
 
	tv®ue_ty³
;

340 
	gnodev”siÚ
<
	tnodev”siÚ_·¿m‘”s
<
	tušt32_t
> > 
	tnodev”siÚ32
;

	@masstree-beta/perfstat.cc

16 
	~"³rf¡©.hh
"

17 
	~"comp”.hh
"

18 
	~"kv¡©s.hh
"

19 #ià
HAVE_NUMA_H


20 
	~<numa.h
>

23 ’um { 
	mMaxCÜes
 = 48 };

24 ’um { 
	mMaxNumaNode
 = 8 };

25 ’um { 
	mCÜesP”Ch
 = 
MaxCÜes
 / 
MaxNumaNode
 };

27 
Çme¥aû
 
	gP”f
 {

29 #ià
MEMSTATS
 && 
HAVE_NUMA_H
 && 
HAVE_LIBNUMA


31 
	gä“
;

32 
	gsize
;

33 } 
	gnuma
[
MaxNumaNode
];

37 
	g¡©
::
š™maš
(
boŞ
 
pšth»ads
) {

38 (è
pšth»ads
;

39 #ià
PMC_ENABLED


40 
®ways_as£¹
(
pšth»ads
 && "Using…erformance counter„equires…inninghreadso cores!");

42 #ià
MEMSTATS
 && 
HAVE_NUMA_H
 && 
HAVE_LIBNUMA


43 ià(
numa_avaabË
() != -1) {

44 
®ways_as£¹
(
numa_max_node
(è<ğ
MaxNumaNode
);

45 
	gi
 = 0; i <ğ
numa_max_node
(); i++)

46 
	gnuma
[
i
].
	gsize
 = 
numa_node_size64
(i, &
numa
[i].
ä“
);

51 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

52 
kv¡©s


53 
sum_®l_cÜes
(cÚ¡ 
¡©
 **
s
, 
n
, cÚ¡ 
off£t
) {

54 
kv¡©s
 
	gsum
;

55 
	gi
 = 0; i < 
	gn
; i++) {

56 ià(!
	gs
[
i
])

58 
T
 
	gv
 = *
»š‹½»t_ÿ¡
<cÚ¡ T *>Ôeš‹½»t_ÿ¡<cÚ¡ *>(
s
[
i
]è+ 
off£t
);

59 
	gsum
.
add
(
v
);

61  
	gsum
;

64 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

65 
kv¡©s


66 
sum_Úe_ch
(cÚ¡ 
¡©
 **
s
, 
n
, cÚ¡ 
off£t
, cÚ¡ 
chidx
) {

67 
kv¡©s
 
	gsum
;

68 
	gi
 = 0; i < 
	gn
; i++) {

69 ià(!
	gs
[
i
] || s[i]->
	gcid
 / (
	gMaxCÜes
 / 
	gMaxNumaNode
è!ğ
chidx
)

71 
T
 
	gv
 = *
»š‹½»t_ÿ¡
<cÚ¡ T *>Ôeš‹½»t_ÿ¡<cÚ¡ *>(
s
[
i
]è+ 
off£t
);

72 
	gsum
.
add
(
v
);

74  
	gsum
;

77 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

78 
kv¡©s


79 
sum_®l_³r_ch
(cÚ¡ 
¡©
 **
s
, 
n
, cÚ¡ 
off£t
) {

80 
kv¡©s
 
	g³r_ch
[
MaxNumaNode
];

81 
	gi
 = 0; i < 
	gn
; i++) {

82 ià(!
	gs
[
i
])

84 
T
 
	gv
 = *
»š‹½»t_ÿ¡
<cÚ¡ T *>Ôeš‹½»t_ÿ¡<cÚ¡ *>(
s
[
i
]è+ 
off£t
);

85 
	g³r_ch
[
i
 / 
CÜesP”Ch
].
add
(
v
);

87 
kv¡©s
 
	gsum
;

88 
	gi
 = 0; i < 
	gMaxNumaNode
; i++)

89 ià(
	g³r_ch
[
i
].
	gcouÁ
)

90 
	gsum
.
add
(
³r_ch
[
i
].
avg
());

91  
	gsum
;

95 
	g¡©
::
´št
(cÚ¡ 
¡©
 **
s
, 
n
) {

96 ()
	gn
;

97 ()
	gs
;

98 
	#sum_®l_cÜes_of
(
f›ld
) \

99 
sum_®l_cÜes
<
	`ty³of
(
s
[0]->
f›ld
)>(s, 
n
, 
	`off£tof
(
P”f
::
¡©
, f›ld))

	)

100 
	#sum_Úe_ch_of
(
f›ld
, 
c
) \

101 
sum_Úe_ch
<
	`ty³of
(
s
[0]->
f›ld
)>(s, 
n
, 
	`off£tof
(
P”f
::
¡©
, f›ld), 
c
)

	)

102 
	#sum_®l_³r_ch_of
(
f›ld
) \

103 
sum_®l_³r_ch
<
	`ty³of
(
s
[0]->
f›ld
)>(s, 
n
, 
	`off£tof
(
P”f
::
¡©
, f›ld))

	)

105 
	#sum_®l_cÜes_of_¬¿y
(
f›ld
, 
ß
) \

106 
sum_®l_cÜes
<
	`ty³of
(
s
[0]->
f›ld
[0])>(s, 
n
, 
	`off£tof
(
P”f
::
¡©
, field) + \

107 (
s
[0]->
f›ld
[0]è* 
ß
)

	)

108 
	#sum_Úe_ch_of_¬¿y
(
f›ld
, 
ß
, 
c
) \

109 
sum_Úe_ch
<
	`ty³of
(
s
[0]->
f›ld
[0])>(s, 
n
, 
	`off£tof
(
P”f
::
¡©
, field) + \

110 (
s
[0]->
f›ld
[0]è* 
ß
, 
c
)

	)

111 
	#sum_®l_³r_ch_of_¬¿y
(
f›ld
, 
ß
) \

112 
sum_®l_³r_ch
<
	`ty³of
(
s
[0]->
f›ld
[0])>(s, 
n
, 
	`off£tof
(
P”f
::
¡©
, field) + \

113 (
s
[0]->
f›ld
[0]è* 
ß
)

	)

115 #ià
GETSTATS
 && 0

116 
	gi
 = 0; i < 
	gn
; i++)

117 ià(
	gs
[
i
]->
	gng‘s
 < 1000) {

118 
	gs
[
i
] = 
NULL
;

121 
kv¡©s
 
	gng‘s
 = 
sum_®l_cÜes_of
(
ng‘s
);

122 
kv¡©s
 
	gÁsc
 = 
sum_®l_cÜes_of
(
Ásc
);

123 
kv¡©s
 
	gÅ
 = 
sum_®l_cÜes_of
(
Årobe
);

124 ià(
	gÅ
.
	gsum
 >= 1)

125 
årštf
(
¡d”r
, "TÙ®…rob%.0f,…robe/g‘ %.2f\n", 
Å
.
sum
,‚p.sum / 
ng‘s
.sum);

126 #ià
PMC_ENABLED


127 
årštf
(
¡d”r
, "(Inaccurate because PMC is Enabled!)");

129 
årštf
(
¡d”r
, "Cycles/get (between mark_get_begin‡nd mark_get_end): %.0f\n",

130 
Ásc
.
sum
 / 
ng‘s
.sum);

131 #ià
PMC_ENABLED


132 
	gi
 = 0; i < 
	gn
; i++) {

133 ià(!
	gs
[
i
])

135 
årštf
(
¡d”r
, "CÜ%d:\n", 
i
);

136 
	gpi
 = 0;…i < 4;…i++) {

137 
årštf
(
¡d”r
, "\mc[%d]: %016" 
PRIx64
 "->%016" PRIx64 "\n",

138 
pi
, 
s
[
i
]->
pmc_fœ¡g‘
[pi], s[i]->
pmc_¡¬t
[pi]);

139 
®ways_as£¹
(
s
[
i
]->
pmc_¡¬t
[
pi
] >ğs[i]->
pmc_fœ¡g‘
[pi]);

140 
®ways_as£¹
(
s
[
i
]->
t1_Ï¡g‘
 >ğs[i]->
t0_fœ¡g‘
);

144 
kv¡©s
 
	gg‘¡¬t
 = 
sum_®l_cÜes_of
(
t0_fœ¡g‘
);

145 
kv¡©s
 
	gg‘’d
 = 
sum_®l_cÜes_of
(
t1_Ï¡g‘
);

146 
	gg‘¡¬t
.
´št_»pÜt
("time of first get");

147 
	gg‘’d
.
´št_»pÜt
("time of†ast get");

150 
	gpımc_pha£
[
MaxNumaNode
][4];

151 
	gi
 = 0; i < 
	gMaxNumaNode
; i++)

152 
	gpi
 = 0;…i < 4;…i++)

153 
	gpımc_pha£
[
i
][
pi
] = 
sum_Úe_ch_of_¬¿y
(
pmc_¡¬t
,…i, i).
avg
() -

154 
sum_Úe_ch_of_¬¿y
(
pmc_fœ¡g‘
, 
pi
, 
i
).
avg
();

157 
kv¡©s
 
	gt_fœ¡g‘
 = 
sum_®l_cÜes_of
(
t0_fœ¡g‘
);

158 
kv¡©s
 
	gt_Ï¡g‘
 = 
sum_®l_cÜes_of
(
t1_Ï¡g‘
);

159 
	g»®time
 = 
t_Ï¡g‘
.
avg
(è- 
t_fœ¡g‘
.avg();

161 
	gpi
 = 0;…i < 4;…i++) {

162 
årštf
(
¡d”r
, "DRAM‡cûs tØnodÕmø%d)\n", 
pi
);

163 
	gsum
 = 0;

164 
	gi
 = 0; i < 
	gMaxNumaNode
; i++) {

165 
årštf
(
¡d”r
, "\tFrom ch %2d: %8.1àGB/s\n", 
i
,

166 
pımc_pha£
[
i
][
pi
] * 64 / (
»®time
 * (1 << 30)));

167 
	gsum
 +ğ
pımc_pha£
[
i
][
pi
];

169 
årštf
(
¡d”r
, "\tSum: %8.1f GB/s\n",

170 
sum
 * 64 / (
»®time
 * (1 << 30)));

173 
årštf
(
¡d”r
, "Per get statistics (counted between mark_get_begin‡nd mark_get_end):\n");

174 
	gpi
 = 0; (
	gng‘s
.
	gsum
 > 0) &&…i < 4;…i ++) {

175 
kv¡©s
 
	gpmc_lookup
 = 
sum_®l_cÜes_of_¬¿y
(
pmc_lookup
, 
pi
);

176 
kv¡©s
 
	gpımc_lookup
 = 
sum_®l_³r_ch_of_¬¿y
(
pmc_lookup
, 
pi
);

177 
årštf
(
¡d”r
, "\tpmc%d/get: %6.1f,…er_chip_pmc%d/get: %6.1f\n",

178 
pi
, (è
pmc_lookup
.
sum
 / 
ng‘s
.sum,…i,

179 (è
pımc_lookup
.
sum
 / 
ng‘s
.sum);

184 #ià
MEMSTATS
 && 
HAVE_NUMA_H
 && 
HAVE_LIBNUMA
 && 0

186 
kv¡©s
 
	gŒ“_mem
 = 
sum_®l_cÜes_of
(
Œ“_mem
);

187 
kv¡©s
 
	gŒ“_keys
 = 
sum_®l_cÜes_of
(
Œ“_keys
);

188 
årštf
(
¡d”r
, "Memory statistics\n");

189 
årštf
(
¡d”r
, "\tAÎoÿ‹d…” key: %.0àby‹s, %.0f\n", 
Œ“_mem
.
sum
 / 
Œ“_keys
.sum,ree_keys.sum);

190 ià(
numa_avaabË
() != -1) {

191 
tÙ®_®loc
 = 0;

192 
	gi
 = 0; i <ğ
numa_max_node
(); i++) {

193 
kv¡©s
 
	gch
 = 
sum_Úe_ch_of
(
Œ“_mem
, 
i
);

194 
	gnowä“
;

195 
	gsize
 = 
numa_node_size64
(
i
, &
nowä“
);

196 
	gtÙ®_®loc
 +ğ
numa
[
i
].
ä“
 - 
nowä“
;

197 
årštf
(
¡d”r
, "\tNode %d (MB): size %6lld,‡llocated = %6lld - "

199 
i
, 
size
 >> 20, 
numa
[i].
ä“
 >> 20, 
nowä“
 >> 20,

200 (
numa
[
i
].
ä“
 - 
nowä“
) / (1 << 20),

201 
ch
.
sum
 / (1 << 20));

203 
årštf
(
¡d”r
, "TÙ®‡Îoÿ‹d memÜy %ld MB\n", 
tÙ®_®loc
 >> 20);

207 #ià
GCSTATS


209 
kv¡©s
 
	ggc_nä“
 = 
sum_®l_cÜes_of
(
gc_nä“
);

210 
kv¡©s
 
	ggc_ÇÎoc
 = 
sum_®l_cÜes_of
(
gc_ÇÎoc
);

211 
årštf
(
¡d”r
, "reuse…er gc slot: %.0f, freed: %.0f,‡llocated: %.0f\n",

212 
gc_nä“
.
sum
 / 
gc_ÇÎoc
.sum, gc_nfree.sum, gc_nalloc.sum);

	@masstree-beta/perfstat.hh

16 #iâdeà
PERF_STAT_HH


17 
	#PERF_STAT_HH
 1

	)

18 
	~"comp”.hh
"

19 
	~"misc.hh
"

20 
	~<¡dlib.h
>

21 
	~<š‰y³s.h
>

23 
Çme¥aû
 
	gP”f
 {

24 
	s¡©
 {

27 
š™maš
(
boŞ
 
pšth»ads
);

28 #ià
GCSTATS


29 
	ggc_nä“
;

31 
š™Ÿlize
(
cid
) {

32 
	gthis
->
	gcid
 = 
cid
;

34 
´št
(cÚ¡ 
¡©
 **
s
, 
n
);

35 
	gcid
;

	@masstree-beta/query_masstree.cc

16 
	~"mas¡»e.hh
"

17 
	~"mas¡»e_key.hh
"

18 
	~"mas¡»e_¡ruù.hh
"

19 
	~"mas¡»e_tcursÜ.hh
"

20 
	~"mas¡»e_g‘.hh
"

21 
	~"mas¡»e_š£¹.hh
"

22 
	~"mas¡»e_¥l™.hh
"

23 
	~"mas¡»e_»move.hh
"

24 
	~"mas¡»e_sÿn.hh
"

25 
	~"mas¡»e_¡©s.hh
"

26 
	~"mas¡»e_´št.hh
"

27 
	~"qu”y_mas¡»e.hh
"

28 
	~"¡ršg_¦iû.hh
"

29 
	~"k³rmu‹r.hh
"

30 
	~"k£¬ch.hh
"

31 
	~"¡ršgbag.hh
"

32 
	~"jsÚ.hh
"

33 
	~"kvrow.hh
"

35 
Çme¥aû
 
	gMas¡»e
 {

37 
ušt64_t
 
	gheightcouÁs
[300], 
	gflcouÁs
[100];

39 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

40 
Œ“¡©s1
(
node_ba£
<
P
>* 
n
, 
height
) {

41 ià(!
	gn
)

43 
	gsz
;

44 ià(
	gn
->
i¦—f
()) {

45 
as£¹
(
height
 < 
¬¿ysize
(
heightcouÁs
));

46 ià(
	gn
->
d–‘ed
())

48 
	gËaf
<
	gP
> *
	glf
 = (
Ëaf
<
P
> *)
n
;

49 
ty³Çme
 
	gËaf
<
	gP
>::
³rmu‹r_ty³
 
³rm
 = 
lf
->
³rmutiÚ_
;

50 
	gsz
 = 
³rm
.
size
();

51 
	gidx
 = 0; idx < 
	gsz
; ++idx) {

52 
	gp
 = 
³rm
[
idx
];

53 
ty³Çme
 
	gËaf
<
	gP
>::
Ëafv®ue_ty³
 
lv
 = 
lf
->
lv_
[
p
];

54 ià(!
	glv
 || !
	glf
->
is_Ïy”
(
p
))

55 ++
	gheightcouÁs
[
height
];

57 
	gnode_ba£
<
	gP
>* 
	gÏy”
 = 
lv
.
Ïy”
();

58 !
	gÏy”
->
is_roÙ
())

59 
	gÏy”
 = 
Ïy”
->
maybe_·»Á
();

60 
Œ“¡©s1
(
Ïy”
, 
height
 + 1);

64 
	gš‹ºode
<
	gP
> *
	gš
 = (
š‹ºode
<
P
> *è
n
;

65 
	gsz
 = 
š
->
size
();

66 
	gi
 = 0; i <ğ
sz
; ++i)

67 ià(
	gš
->
	gchd_
[
i
])

68 
Œ“¡©s1
(
š
->
chd_
[
i
], 
height
 + 1);

70 
as£¹
((
size_t
è
sz
 < 
¬¿ysize
(
flcouÁs
));

71 
	gflcouÁs
[
sz
] += 1;

74 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

75 
	gqu”y_bË
<
	gP
>::
¡©s
(
FILE
* 
f
) {

76 
mem£t
(
heightcouÁs
, 0, (heightcounts));

77 
mem£t
(
flcouÁs
, 0, (fillcounts));

78 
Œ“¡©s1
(
bË_
.
roÙ
(), 0);

79 
årštf
(
f
, " heights:");

80 
	gi
 = 0; i < 
¬¿ysize
(
heightcouÁs
); ++i)

81 ià(
	gheightcouÁs
[
i
])

82 
årštf
(
f
, " %d=%" 
PRIu64
, 
i
, 
heightcouÁs
[i]);

83 
årštf
(
f
, "\n‚ode counts:");

84 
	gi
 = 0; i < 
¬¿ysize
(
flcouÁs
); ++i)

85 ià(
	gflcouÁs
[
i
])

86 
årštf
(
f
, " %d=%" 
PRIu64
, 
i
, 
flcouÁs
[i]);

87 
årštf
(
f
, "\n");

90 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

91 
	gqu”y_bË
<
	gP
>::
jsÚ_¡©s
(
lcdf
::
JsÚ
& 
j
, 
th»adšfo
& 
ti
) {

92 
	gMas¡»e
::
jsÚ_¡©s
(
j
, 
bË_
, 
ti
);

95 
	g‹m¶©e
 <
ty³Çme
 
	gN
>

96 
SŒ
 
fšdpv
(
N
 *
n
, 
pvi
, 
Åv
)

101 
	gnb¿nch
 = 1, 
	gb¿nchid
 = 0;

102 
ty³Çme
 
	tN
::
	tš‹ºode_ty³
 internode_type;

103 
ty³Çme
 
	tN
::
	tËaf_ty³
†eaf_type;

105 !
	gn
->
is_roÙ
())

106 
	gn
 = 
n
->
maybe_·»Á
();

109 
ty³Çme
 
	gN
::
nodev”siÚ_ty³
 
v
 = 
n
->
¡abË
();

110 
	gsize
;

111 ià(
	gn
->
i¦—f
())

112 
	gsize
 = 
¡©ic_ÿ¡
<
Ëaf_ty³
*>(
n
)->
size
();

114 
	gsize
 = 
¡©ic_ÿ¡
<
š‹ºode_ty³
*>(
n
)->
size
() + 1;

115 ià(
	gsize
 == 0)

116  
SŒ
();

118 
	gtÙ®_nkeys_e¡im©e
 = 
nb¿nch
 * 
size
;

119 
	gfœ¡_pv_š_node
 = 
b¿nchid
 * 
size
;

120 
	gpv_off£t
 = 
pvi
 * 
tÙ®_nkeys_e¡im©e
 / 
Åv
 - 
fœ¡_pv_š_node
;

122 ià(!
	gn
->
i¦—f
(è&& 
	gtÙ®_nkeys_e¡im©e
 < 
	gÅv
) {

123 
š‹ºode_ty³
 *
	gš
 = 
¡©ic_ÿ¡
<š‹ºode_ty³ *>(
n
);

124 
	gpv_off£t
 = 
¡d
::
mš
(¡d::
max
(
pv_off£t
, 0), 
size
 - 1);

125 
N
 *
	gÃxt
 = 
š
->
chd_
[
pv_off£t
];

126 ià(!
	gn
->
has_chªged
(
v
)) {

127 
	gnb¿nch
 = 
tÙ®_nkeys_e¡im©e
;

128 
	gb¿nchid
 = 
fœ¡_pv_š_node
 + 
pv_off£t
;

129 
	gn
 = 
Ãxt
;

134 
	gpv_off£t
 = 
¡d
::
mš
(¡d::
max
(
pv_off£t
, 0), 
size
 - 1 - !
n
->
i¦—f
());

135 
ty³Çme
 
	gN
::
ikey_ty³
 
ikey0
;

136 ià(
	gn
->
i¦—f
()) {

137 
Ëaf_ty³
 *
	gl
 = 
¡©ic_ÿ¡
<Ëaf_ty³ *>(
n
);

138 
ty³Çme
 
	gËaf_ty³
::
³rmu‹r_ty³
 
³rm
 = 
l
->
³rmutiÚ
();

139 
	gikey0
 = 
l
->
ikey0_
[
³rm
[
pv_off£t
]];

141 
š‹ºode_ty³
 *
	gš
 = 
¡©ic_ÿ¡
<š‹ºode_ty³ *>(
n
);

142 
	gikey0
 = 
š
->
ikey0_
[
pv_off£t
];

145 ià(!
	gn
->
has_chªged
(
v
)) {

146 *
	gx
 = (*è
m®loc
((
ikey0
));

147 
	gËn
 = 
¡ršg_¦iû
<
ty³Çme
 
N
::
ikey_ty³
>::
uÅ¬£_com·¿bË
(
x
, (
ikey0
), ikey0);

148  
SŒ
(
x
, 
Ën
);

155 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

156 
	gqu”y_bË
<
	gP
>::
fšdpivÙs
(
SŒ
 *
pv
, 
Åv
) const

158 
	gpv
[0].
assign
(
NULL
, 0);

159 *
	gcmaxk
 = (*)
m®loc
(
MASSTREE_MAXKEYLEN
);

160 
mem£t
(
cmaxk
, 255, 
MASSTREE_MAXKEYLEN
);

161 
	gpv
[
Åv
 - 1].
assign
(
cmaxk
, 
MASSTREE_MAXKEYLEN
);

162 
	gi
 = 1; i < 
	gÅv
 - 1; i++)

163 
	gpv
[
i
] = 
fšdpv
(
bË_
.
roÙ
(), i, 
Åv
 - 1);

166 
	gÇme¥aû
 {

167 
	ssÿn_‹¡”
 {

168 cÚ¡ * cÚ¡ *
	gvbegš_
, * cÚ¡ *
	gv’d_
;

169 
	gkey_
[32];

170 
	gkeyËn_
;

171 
boŞ
 
	g»v”£_
;

172 
boŞ
 
	gfœ¡_
;

173 
sÿn_‹¡”
(cÚ¡ * cÚ¡ *
vbegš
, cÚ¡ * cÚ¡ *
v’d
,

174 
boŞ
 
»v”£
 = 
çl£
)

175 : 
vbegš_
(
vbegš
), 
v’d_
(
v’d
), 
keyËn_
(0), 
»v”£_
(
»v”£
),

176 
fœ¡_
(
Œue
) {

177 ià(
	g»v”£_
) {

178 
mem£t
(
key_
, 255, (key_));

179 
	gkeyËn_
 = (
key_
);

182 
	g‹m¶©e
 <
ty³Çme
 
	gSS
,y³Çm
	gK
>

183 
vis™_Ëaf
(cÚ¡ 
SS
&, cÚ¡ 
K
&, 
th»adšfo
&) {

185 
boŞ
 
vis™_v®ue
(
SŒ
 
key
, 
row_ty³
*, 
th»adšfo
&) {

186 
memıy
(
key_
, 
key
.
s
, key.
Ën
);

187 
	gkeyËn_
 = 
key
.
Ën
;

188 cÚ¡ *
	gpos
 = (
»v”£_
 ? 
v’d_
[-1] : 
vbegš_
[0]);

189 ià((è
¡¾’
(
pos
è!ğ
key
.
Ën
 || 
memcmp
Õos, key.
s
, key.len) != 0) {

190 
årštf
(
¡d”r
, "%ssÿÀ’couÁ”ed %.*s,ƒx³ùed %s\n", 
»v”£_
 ? "r" : "", 
key
.
Ën
, key.
s
, 
pos
);

191 
as£¹
((è
¡¾’
(
pos
è=ğ
key
.
Ën
 && 
memcmp
Õos, key.
s
, key.len) == 0);

193 
årštf
(
¡d”r
, "%ssÿÀ%.*s\n", 
»v”£_
 ? "r" : "", 
key
.
Ën
, key.
s
);

194 (
	g»v”£_
 ? --
	gv’d_
 : ++
vbegš_
);

195 
	gfœ¡_
 = 
çl£
;

196  
	gvbegš_
 !ğ
v’d_
;

198 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

199 
sÿn
(
T
& 
bË
, 
th»adšfo
& 
ti
) {

200  
	gbË
.
bË
().
sÿn
(
SŒ
(
key_
, 
keyËn_
), 
fœ¡_
, *
this
, 
ti
);

202 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

203 
rsÿn
(
T
& 
bË
, 
th»adšfo
& 
ti
) {

204  
	gbË
.
bË
().
rsÿn
(
SŒ
(
key_
, 
keyËn_
), 
fœ¡_
, *
this
, 
ti
);

209 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

210 
	gqu”y_bË
<
	gP
>::
‹¡
(
th»adšfo
& 
ti
) {

211 
qu”y_bË
<
P
> 
t
;

212 
	gt
.
š™Ÿlize
(
ti
);

213 
	gqu”y
<
	grow_ty³
> 
	gq
;

215 cÚ¡ * cÚ¡ 
	gv®ues
[] = {

224 cÚ¡ * cÚ¡ *
	g’d_v®ues
 = 
v®ues
 + 
¬¿ysize
(values);

225 cÚ¡ *
	gv®ues_cİy
[
¬¿ysize
(
v®ues
)];

226 
memıy
(
v®ues_cİy
, 
v®ues
, (values));

228 
	gi
 = 
¬¿ysize
(
v®ues
); i > 0; --i) {

229 
	gx
 = 
¿nd
(è% 
i
;

230 
	gq
.
run_»¶aû
(
t
.
bË
(), 
SŒ
(
v®ues_cİy
[
x
]), SŒ(v®ues_cİy[x]), 
ti
);

231 
	gv®ues_cİy
[
x
] = 
v®ues_cİy
[
i
 - 1];

234 
	gt
.
	gbË_
.
´št
();

235 
´štf
("\n");

237 
sÿn_‹¡”
 
sÿÂ”
(
v®ues
, values + 3);

238 
	gsÿÂ”
.
sÿn
(
t
, 
ti
)) {

239 
	gsÿÂ”
.
	gv’d_
 = 
¡d
::
mš
(
sÿÂ”
.
v’d_
 + 3, 
’d_v®ues
);

240 
årštf
(
¡d”r
, "-scanbreak-\n");

243 
	gsÿÂ”
 = 
sÿn_‹¡”
(
v®ues
, values + 8);

244 
	gsÿÂ”
.
sÿn
(
t
, 
ti
)) {

245 
	gsÿÂ”
.
	gv’d_
 = 
¡d
::
mš
(
sÿÂ”
.
v’d_
 + 8, 
’d_v®ues
);

246 
årštf
(
¡d”r
, "-scanbreak-\n");

249 
	gsÿÂ”
 = 
sÿn_‹¡”
(
v®ues
 + 10, values + 11);

250 
	gr
 = 
t
.
bË_
.
sÿn
(
SŒ
(
v®ues
[10]), 
Œue
, 
sÿÂ”
, 
ti
);

251 
®ways_as£¹
(
r
 == 1);

253 
	gsÿÂ”
 = 
sÿn_‹¡”
(
v®ues
 + 10, values + 11);

254 
	gr
 = 
t
.
bË_
.
sÿn
(
SŒ
(
v®ues
[10] + 1), 
Œue
, 
sÿÂ”
, 
ti
);

255 
®ways_as£¹
(
r
 == 1);

257 
	gsÿÂ”
 = 
sÿn_‹¡”
(
v®ues
 + 11, values + 12);

258 
	gr
 = 
t
.
bË_
.
sÿn
(
SŒ
(
v®ues
[10]), 
çl£
, 
sÿÂ”
, 
ti
);

259 
®ways_as£¹
(
r
 == 1);

261 
	gsÿÂ”
 = 
sÿn_‹¡”
(
v®ues
 + 10, values + 11);

262 
	gr
 = 
t
.
bË_
.
sÿn
(
SŒ
("¯¯¯¯¯¯¯¯¯¯¯¯aZ"), 
Œue
, 
sÿÂ”
, 
ti
);

263 
®ways_as£¹
(
r
 == 1);

265 
	gsÿÂ”
 = 
sÿn_‹¡”
(
v®ues
 + 11, values + 12);

266 
	gr
 = 
t
.
bË_
.
sÿn
(
SŒ
(
v®ues
[11]), 
Œue
, 
sÿÂ”
, 
ti
);

267 
®ways_as£¹
(
r
 == 1);

269 
	gsÿÂ”
 = 
sÿn_‹¡”
(
v®ues
 + 12, values + 13);

270 
	gr
 = 
t
.
bË_
.
sÿn
(
SŒ
(
v®ues
[11]), 
çl£
, 
sÿÂ”
, 
ti
);

271 
®ways_as£¹
(
r
 == 1);

274 
	gsÿÂ”
 = 
sÿn_‹¡”
(
’d_v®ues
 - 3,ƒnd_v®ues, 
Œue
);

275 
	gsÿÂ”
.
rsÿn
(
t
, 
ti
)) {

276 
	gsÿÂ”
.
	gvbegš_
 = 
¡d
::
max
(
sÿÂ”
.
vbegš_
 - 3, (cÚ¡ * cÚ¡ *è
v®ues
);

277 
årštf
(
¡d”r
, "-scanbreak-\n");

280 
	gsÿÂ”
 = 
sÿn_‹¡”
(
’d_v®ues
 - 2,ƒnd_v®ues, 
Œue
);

281 
	gr
 = 
sÿÂ”
.
rsÿn
(
t
, 
ti
);

282 
®ways_as£¹
(
r
 == 2);

283 
	gsÿÂ”
.
	gvbegš_
 = 
¡d
::
max
(
sÿÂ”
.
vbegš_
 - 2, (cÚ¡ * cÚ¡ *è
v®ues
);

284 
årštf
(
¡d”r
, "-scanbreak-\n");

285 
	gr
 = 
sÿÂ”
.
rsÿn
(
t
, 
ti
);

286 
®ways_as£¹
(
r
 == 2);

288 
	gsÿÂ”
 = 
sÿn_‹¡”
(
’d_v®ues
 - 8,ƒnd_v®ues, 
Œue
);

289 
	gsÿÂ”
.
rsÿn
(
t
, 
ti
)) {

290 
	gsÿÂ”
.
	gvbegš_
 = 
¡d
::
max
(
sÿÂ”
.
vbegš_
 - 8, (cÚ¡ * cÚ¡ *è
v®ues
);

291 
årštf
(
¡d”r
, "-scanbreak-\n");

294 
	gsÿÂ”
 = 
sÿn_‹¡”
(
v®ues
 + 10, values + 11);

295 
	gr
 = 
t
.
bË_
.
rsÿn
(
SŒ
(
v®ues
[10]), 
Œue
, 
sÿÂ”
, 
ti
);

296 
®ways_as£¹
(
r
 == 1);

298 
	gsÿÂ”
 = 
sÿn_‹¡”
(
v®ues
 + 10, values + 11);

299 
	gr
 = 
t
.
bË_
.
rsÿn
(
SŒ
("¯¯¯¯¯¯¯¯¯¯¯¯ab"), 
Œue
, 
sÿÂ”
, 
ti
);

300 
®ways_as£¹
(
r
 == 1);

302 
	gsÿÂ”
 = 
sÿn_‹¡”
(
v®ues
 + 9, values + 10);

303 
	gr
 = 
t
.
bË_
.
rsÿn
(
SŒ
(
v®ues
[10]), 
çl£
, 
sÿÂ”
, 
ti
);

304 
®ways_as£¹
(
r
 == 1);

306 
	gsÿÂ”
 = 
sÿn_‹¡”
(
v®ues
 + 10, values + 11);

307 
	gr
 = 
t
.
bË_
.
rsÿn
(
SŒ
("¯¯¯¯¯¯¯¯¯¯¯¯ab"), 
Œue
, 
sÿÂ”
, 
ti
);

308 
®ways_as£¹
(
r
 == 1);

310 
	gsÿÂ”
 = 
sÿn_‹¡”
(
v®ues
 + 11, values + 12);

311 
	gr
 = 
t
.
bË_
.
rsÿn
(
SŒ
(
v®ues
[11]), 
Œue
, 
sÿÂ”
, 
ti
);

312 
®ways_as£¹
(
r
 == 1);

314 
	gsÿÂ”
 = 
sÿn_‹¡”
(
v®ues
 + 10, values + 11);

315 
	gr
 = 
t
.
bË_
.
rsÿn
(
SŒ
(
v®ues
[11]), 
çl£
, 
sÿÂ”
, 
ti
);

316 
®ways_as£¹
(
r
 == 1);

319 
SŒ
 
	gpv
[10];

320 
	gt
.
fšdpivÙs
(
pv
, 10);

321 
	gi
 = 0; i < 10; ++i) {

322 
årštf
(
¡d”r
, "%d >%.*s<\n", 
i
, 
¡d
::
mš
(
pv
[i].
Ën
, 10),…v[i].
s
);

323 
ä“
((*)
pv
[
i
].
s
);

325 
	gt
.
fšdpivÙs
(
pv
, 4);

326 
	gi
 = 0; i < 4; ++i) {

327 
årštf
(
¡d”r
, "%d >%.*s<\n", 
i
, 
¡d
::
mš
(
pv
[i].
Ën
, 10),…v[i].
s
);

328 
ä“
((*)
pv
[
i
].
s
);

334 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

335 
	gqu”y_bË
<
	gP
>::
´št
(
FILE
* 
f
) const {

336 
bË_
.
´št
(
f
);

339 
‹m¶©e
 
şass
 
	gbasic_bË
<
	gdeçuÉ_bË
::
·¿m‘”s_ty³
>;

340 
‹m¶©e
 
şass
 
	gqu”y_bË
<
	gdeçuÉ_bË
::
·¿m‘”s_ty³
>;

	@masstree-beta/query_masstree.hh

16 #iâdeà
QUERY_MASSTREE_HH


17 
	#QUERY_MASSTREE_HH
 1

	)

18 
	~"mas¡»e.hh
"

19 
	~"kvrow.hh
"

20 
şass
 
	gth»adšfo
;

21 
Çme¥aû
 
	glcdf
 { 
şass
 
	gJsÚ
; }

23 
Çme¥aû
 
	gMas¡»e
 {

25 
	g‹m¶©e
 <
ty³Çme
 
	gP
>

26 şas 
	cqu”y_bË
 {

27 
	gpublic
:

28 
P
 
	t·¿m‘”s_ty³
;

29 
	gnode_ba£
<
	tP
> 
	tnode_ty³
;

30 
ty³Çme
 
	tP
::
	tth»adšfo_ty³
 
	tth»adšfo
;

31 
	guÆocked_tcursÜ
<
	tP
> 
	tuÆocked_cursÜ_ty³
;

32 
	gtcursÜ
<
	tP
> 
	tcursÜ_ty³
;

34 
qu”y_bË
() {

37 cÚ¡ 
	gbasic_bË
<
	gP
>& 
bË
() const {

38  
	gbË_
;

40 
	gbasic_bË
<
	gP
>& 
bË
() {

41  
	gbË_
;

44 
š™Ÿlize
(
th»adšfo
& 
ti
) {

45 
	gbË_
.
š™Ÿlize
(
ti
);

47 
de¡roy
(
th»adšfo
& 
ti
) {

48 
	gbË_
.
de¡roy
(
ti
);

51 
fšdpivÙs
(
SŒ
* 
pv
, 
Åv
) const;

53 
¡©s
(
FILE
* 
f
);

54 
jsÚ_¡©s
(
lcdf
::
JsÚ
& 
j
, 
th»adšfo
& 
ti
);

55 
šlše
 
	glcdf
::
JsÚ
 
jsÚ_¡©s
(
th»adšfo
& 
ti
) {

56 
lcdf
::
JsÚ
 
j
;

57 
jsÚ_¡©s
(
j
, 
ti
);

58  
	gj
;

61 
´št
(
FILE
* 
f
) const;

63 
‹¡
(
th»adšfo
& 
ti
);

65 cÚ¡ * 
Çme
() {

69 
	g´iv©e
:

70 
basic_bË
<
P
> 
bË_
;

73 
	gdeçuÉ_qu”y_bË_·¿ms
 : 
public
 
nod•¬ams
<15, 15> {

74 
row_ty³
* 
	tv®ue_ty³
;

75 
	gv®ue_´št
<
	tv®ue_ty³
> 
	tv®ue_´št_ty³
;

76 ::
th»adšfo
 
	tth»adšfo_ty³
;

79 
	gqu”y_bË
<
	tdeçuÉ_qu”y_bË_·¿ms
> 
	tdeçuÉ_bË
;

	@masstree-beta/scantest.cc

1 
	~"qu”y_mas¡»e.hh
"

3 
usšg
 
Çme¥aû
 
	gMas¡»e
;

5 
kv•och_t
 
	gglob®_log_•och
 = 0;

6 vŞ©
mrcu_•och_ty³
 
	gglob®•och
 = 1;

7 vŞ©
boŞ
 
	g»cov”šg
 = 
çl£
;

8 
kvtime¡amp_t
 
	gš™Ÿl_time¡amp
;

11 
	$maš
(
¬gc
, *
¬gv
[])

13 (è
¬gc
;

14 (è
¬gv
;

16 
th»adšfo
* 
ti
 =h»adšfo::
	`make
Ñh»adšfo::
TI_MAIN
, -1);

17 
deçuÉ_bË
::
	`‹¡
(*
ti
);

18 
	}
}

	@masstree-beta/small_vector.hh

1 #iâdeà
GSTORE_SMALL_VECTOR_HH


2 
	#GSTORE_SMALL_VECTOR_HH
 1

	)

3 
	~"comp”.hh
"

4 
	~<memÜy
>

5 
	~<™”©Ü
>

6 
	~<as£¹.h
>

8 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
 = 
¡d
::
®loÿtÜ
<
T
> >

9 şas 
	csm®l_veùÜ
 {

10 
public
:

11 
boŞ
 (
	tsm®l_veùÜ
<
	tT
, 
	tN
, 
	tA
>::*
	tun¥ecif›d_boŞ_ty³
)() const;

12 
T
 
	tv®ue_ty³
;

13 
v®ue_ty³
* 
	t™”©Ü
;

14 cÚ¡ 
	tv®ue_ty³
* 
	tcÚ¡_™”©Ü
;

15 
	m¡d
::
	t»v”£_™”©Ü
<
	t™”©Ü
>„everse_iterator;

16 
	m¡d
::
	t»v”£_™”©Ü
<
	tcÚ¡_™”©Ü
> 
	tcÚ¡_»v”£_™”©Ü
;

17 
	tsize_ty³
;

18 
cÚ¡ex´
 
size_ty³
 
	msm®l_ÿ·c™y
 = 
N
;

20 
šlše
 
sm®l_veùÜ
(cÚ¡ 
A
& 
®loÿtÜ
 = A());

21 
sm®l_veùÜ
(cÚ¡ sm®l_veùÜ<
T
, 
N
, 
A
>& 
x
);

22 
	m‹m¶©e
 <
	mNN
, 
ty³Çme
 
	mAA
>

23 
sm®l_veùÜ
(cÚ¡ sm®l_veùÜ<
T
, 
NN
, 
AA
>& 
x
);

24 
	mšlše
 ~
sm®l_veùÜ
();

26 
šlše
 
size_ty³
 
	$size
() const;

27 
šlše
 
size_ty³
 
	$ÿ·c™y
() const;

28 
šlše
 
boŞ
 
	$em±y
() const;

29 
šlše
 
İ”©Ü
 
	$un¥ecif›d_boŞ_ty³
() const;

30 
šlše
 
boŞ
 
İ”©Ü
!() const;

32 
šlše
 
™”©Ü
 
	`begš
();

33 
šlše
 
™”©Ü
 
	`’d
();

34 
šlše
 
cÚ¡_™”©Ü
 
	$begš
() const;

35 
šlše
 
cÚ¡_™”©Ü
 
	$’d
() const;

36 
šlše
 
cÚ¡_™”©Ü
 
	$cbegš
() const;

37 
šlše
 
cÚ¡_™”©Ü
 
	$ûnd
() const;

38 
šlše
 
»v”£_™”©Ü
 
	`rbegš
();

39 
šlše
 
»v”£_™”©Ü
 
	`»nd
();

40 
šlše
 
cÚ¡_»v”£_™”©Ü
 
	$rbegš
() const;

41 
šlše
 
cÚ¡_»v”£_™”©Ü
 
	$»nd
() const;

42 
šlše
 
cÚ¡_»v”£_™”©Ü
 
	$übegš
() const;

43 
šlše
 
cÚ¡_»v”£_™”©Ü
 
	$ü’d
() const;

45 
šlše
 
v®ue_ty³
& 
İ”©Ü
[](
size_ty³
 
i
);

46 
šlše
 cÚ¡ 
v®ue_ty³
& 
İ”©Ü
[](
size_ty³
 
i
) const;

47 
šlše
 
v®ue_ty³
& 
	`äÚt
();

48 
šlše
 cÚ¡ 
v®ue_ty³
& 
	$äÚt
() const;

49 
šlše
 
v®ue_ty³
& 
	`back
();

50 
šlše
 cÚ¡ 
v®ue_ty³
& 
	$back
() const;

52 
šlše
 
	`push_back
(cÚ¡ 
v®ue_ty³
& 
x
);

53 
šlše
 
	`push_back
(
v®ue_ty³
&& 
x
);

54 
‹m¶©e
 <
ty³Çme
... 
Args
> 
šlše
 
	`em¶aû_back
(Args&&... 
¬gs
);

55 
šlše
 
	`pİ_back
();

57 
šlše
 
	`ş—r
();

58 
šlše
 
	`»size
(
size_ty³
 
n
, 
v®ue_ty³
 
x
 = 
	`v®ue_ty³
());

59 
™”©Ü
 
	`”a£
(™”©Ü 
pos™iÚ
);

60 
™”©Ü
 
	`”a£
(™”©Ü 
fœ¡
, i‹¿tÜ 
Ï¡
);

62 
šlše
 
sm®l_veùÜ
<
T
, 
N
, 
A
>& 
İ”©Ü
=(cÚ¡ sm®l_veùÜ<T, N, A>& 
x
);

63 
‹m¶©e
 <
NN
, 
ty³Çme
 
AA
>

64 
šlše
 
sm®l_veùÜ
<
T
, 
N
, 
A
>& 
İ”©Ü
=(cÚ¡ sm®l_veùÜ<T, 
NN
, 
AA
>& 
x
);

66 
´iv©e
:

67 
»p
 : 
public
 
A
 {

68 
T
* 
fœ¡_
;

69 
T
* 
Ï¡_
;

70 
T
* 
ÿ·c™y_
;

71 
lv_
[(
T
è* 
N
];

73 
šlše
 
	`»p
(cÚ¡ 
A
& 
a
);

75 
»p
 
r_
;

77 
	`grow
(
size_ty³
 
n
 = 0);

78 
	}
};

80 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

81 
šlše
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
»p
::
	$»p
(cÚ¡ 
A
& 
a
)

82 : 
	`A
(
a
), 
	`fœ¡_
(
»š‹½»t_ÿ¡
<
T
*>(
lv_
)),

83 
	`Ï¡_
(
fœ¡_
), 
	`ÿ·c™y_
(fœ¡_ + 
N
) {

84 
	}
}

86 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

87 
šlše
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$sm®l_veùÜ
(cÚ¡ 
A
& 
®loÿtÜ
)

88 : 
	$r_
(
®loÿtÜ
) {

89 
	}
}

91 
‹m¶©e
 <
ty³Çme
 
T
, 
	gN
,y³Çm
	gA
>

92 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
sm®l_veùÜ
(cÚ¡ sm®l_veùÜ<
T
, 
N
, 
A
>& 
x
)

93 : 
r_
(
	$A
()) {

94 cÚ¡ 
T
* 
™
 = 
x
.
r_
.
fœ¡_
; iˆ!ğx.r_.
Ï¡_
; ++it)

95 
	`push_back
(*
™
);

96 
	}
}

98 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

99 
	g‹m¶©e
 <
	gNN
, 
ty³Çme
 
	gAA
>

100 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
sm®l_veùÜ
(cÚ¡ sm®l_veùÜ<
T
, 
NN
, 
AA
>& 
x
)

101 : 
r_
(
	$A
()) {

102 cÚ¡ 
T
* 
™
 = 
x
.
r_
.
fœ¡_
; iˆ!ğx.r_.
Ï¡_
; ++it)

103 
	`push_back
(*
™
);

104 
	}
}

106 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

107 
šlše
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::~
	$sm®l_veùÜ
() {

108 
T
* 
™
 = 
r_
.
fœ¡_
; iˆ!ğr_.
Ï¡_
; ++it)

109 
r_
.
	`de¡roy
(
™
);

110 ià(
r_
.
fœ¡_
 !ğ
»š‹½»t_ÿ¡
<
T
*>Ô_.
lv_
))

111 
r_
.
	`d—Îoÿ‹
Ô_.
fœ¡_
,„_.
ÿ·c™y_
 -„_.first_);

112 
	}
}

114 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

115 
šlše
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$size
() const {

116  
r_
.
Ï¡_
 -„_.
fœ¡_
;

117 
	}
}

119 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

120 
šlše
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$ÿ·c™y
() const {

121  
r_
.
ÿ·c™y_
 -„_.
fœ¡_
;

122 
	}
}

124 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

125 
šlše
 
boŞ
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$em±y
() const {

126  
r_
.
fœ¡_
 =ğr_.
Ï¡_
;

127 
	}
}

129 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

130 
šlše
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
İ”©Ü
 
	$un¥ecif›d_boŞ_ty³
() const {

131  
	`em±y
(è? 0 : &
sm®l_veùÜ
<
T
, 
N
, 
A
>::
em±y
;

132 
	}
}

134 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

135 
šlše
 
boŞ
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
İ”©Ü
!() const {

136  
em±y
();

139 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

140 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$grow
(
size_ty³
 
n
) {

141 
size_t
 
Ãwÿp
 = 
	`ÿ·c™y
() * 2;

142 
Ãwÿp
 < 
n
)

143 
Ãwÿp
 *= 2;

144 
T
* 
m
 = 
r_
.
	`®loÿ‹
(
Ãwÿp
);

145 
T
* 
™
 = 
r_
.
fœ¡_
, *
m™
 = 
m
; iˆ!ğr_.
Ï¡_
; ++it, ++mit) {

146 
r_
.
	`cÚ¡ruù
(
m™
, 
¡d
::
	`move
(*
™
));

147 
r_
.
	`de¡roy
(
™
);

149 ià(
r_
.
fœ¡_
 !ğ
»š‹½»t_ÿ¡
<
T
*>Ô_.
lv_
))

150 
r_
.
	`d—Îoÿ‹
Ô_.
fœ¡_
, 
	`ÿ·c™y
());

151 
r_
.
Ï¡_
 = 
m
 + (r_.Ï¡_ -„_.
fœ¡_
);

152 
r_
.
fœ¡_
 = 
m
;

153 
r_
.
ÿ·c™y_
 = 
m
 + 
Ãwÿp
;

154 
	}
}

156 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

157 
šlše
‡utØ
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
begš
(è-> 
™”©Ü
 {

158  
r_
.
fœ¡_
;

161 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

162 
šlše
‡utØ
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
’d
(è-> 
™”©Ü
 {

163  
r_
.
Ï¡_
;

166 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

167 
šlše
‡utØ
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$begš
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

168  
r_
.
fœ¡_
;

169 
	}
}

171 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

172 
šlše
‡utØ
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$’d
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

173  
r_
.
Ï¡_
;

174 
	}
}

176 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

177 
šlše
‡utØ
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$cbegš
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

178  
r_
.
fœ¡_
;

179 
	}
}

181 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

182 
šlše
‡utØ
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$ûnd
(ècÚ¡ -> 
cÚ¡_™”©Ü
 {

183  
r_
.
Ï¡_
;

184 
	}
}

186 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

187 
šlše
‡utØ
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
rbegš
(è-> 
»v”£_™”©Ü
 {

188  
»v”£_™”©Ü
(
’d
());

191 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

192 
šlše
‡utØ
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
»nd
(è-> 
»v”£_™”©Ü
 {

193  
»v”£_™”©Ü
(
begš
());

196 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

197 
šlše
‡utØ
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$rbegš
(ècÚ¡ -> 
cÚ¡_»v”£_™”©Ü
 {

198  
	`cÚ¡_»v”£_™”©Ü
(
	`’d
());

199 
	}
}

201 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

202 
šlše
‡utØ
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$»nd
(ècÚ¡ -> 
cÚ¡_»v”£_™”©Ü
 {

203  
	`cÚ¡_»v”£_™”©Ü
(
	`begš
());

204 
	}
}

206 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

207 
šlše
‡utØ
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$übegš
(ècÚ¡ -> 
cÚ¡_»v”£_™”©Ü
 {

208  
	`cÚ¡_»v”£_™”©Ü
(
	`’d
());

209 
	}
}

211 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

212 
šlše
‡utØ
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$ü’d
(ècÚ¡ -> 
cÚ¡_»v”£_™”©Ü
 {

213  
	`cÚ¡_»v”£_™”©Ü
(
	`begš
());

214 
	}
}

216 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

217 
šlše
 
	gT
& 
	gsm®l_veùÜ
<T, 
	gN
, 
	gA
>::
İ”©Ü
[](
size_ty³
 
i
) {

218  
r_
.
fœ¡_
[
i
];

221 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

222 
šlše
 cÚ¡ 
	gT
& 
	gsm®l_veùÜ
<T, 
	gN
, 
	gA
>::
İ”©Ü
[](
size_ty³
 
i
) const {

223  
r_
.
fœ¡_
[
i
];

226 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

227 
šlše
 
	gT
& 
	gsm®l_veùÜ
<T, 
	gN
, 
	gA
>::
	$äÚt
() {

228  
r_
.
fœ¡_
[0];

229 
	}
}

231 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

232 
šlše
 cÚ¡ 
	gT
& 
	gsm®l_veùÜ
<T, 
	gN
, 
	gA
>::
	$äÚt
() const {

233  
r_
.
fœ¡_
[0];

234 
	}
}

236 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

237 
šlše
 
	gT
& 
	gsm®l_veùÜ
<T, 
	gN
, 
	gA
>::
	$back
() {

238  
r_
.
Ï¡_
[-1];

239 
	}
}

241 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

242 
šlše
 cÚ¡ 
	gT
& 
	gsm®l_veùÜ
<T, 
	gN
, 
	gA
>::
	$back
() const {

243  
r_
.
Ï¡_
[-1];

244 
	}
}

246 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

247 
šlše
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$push_back
(cÚ¡ 
T
& 
x
) {

248 ià(
r_
.
Ï¡_
 =ğr_.
ÿ·c™y_
)

249 
	`grow
();

250 
r_
.
	`cÚ¡ruù
Ô_.
Ï¡_
, 
x
);

251 ++
r_
.
Ï¡_
;

252 
	}
}

254 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

255 
šlše
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$push_back
(
T
&& 
x
) {

256 ià(
r_
.
Ï¡_
 =ğr_.
ÿ·c™y_
)

257 
	`grow
();

258 
r_
.
	`cÚ¡ruù
Ô_.
Ï¡_
, 
¡d
::
	`move
(
x
));

259 ++
r_
.
Ï¡_
;

260 
	}
}

262 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>em¶©<
	gty³Çme
... 
	gArgs
>

263 
šlše
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$em¶aû_back
(
Args
&&... 
¬gs
) {

264 ià(
r_
.
Ï¡_
 =ğr_.
ÿ·c™y_
)

265 
	`grow
();

266 
r_
.
	`cÚ¡ruù
Ô_.
Ï¡_
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

267 ++
r_
.
Ï¡_
;

268 
	}
}

270 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

271 
šlše
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$pİ_back
() {

272 
	`as£¹
(
r_
.
fœ¡_
 !ğr_.
Ï¡_
);

273 --
r_
.
Ï¡_
;

274 
r_
.
	`de¡roy
Ô_.
Ï¡_
);

275 
	}
}

277 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

278 
šlše
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$ş—r
() {

279 autØ
™
 = 
r_
.
fœ¡_
; iˆ!ğr_.
Ï¡_
; ++it)

280 
r_
.
	`de¡roy
(
™
);

281 
r_
.
Ï¡_
 =„_.
fœ¡_
;

282 
	}
}

284 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

285 
šlše
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$»size
(
size_ty³
 
n
, 
v®ue_ty³
 
v
) {

286 ià(
	`ÿ·c™y
(è< 
n
)

287 
	`grow
(
n
);

288 autØ
™
 = 
r_
.
fœ¡_
 + 
n
;

289 autØ
xt
 = 
r_
.
Ï¡_
;

290 
r_
.
Ï¡_
 = 
™
;

291 ; 
™
 < 
xt
; ++it)

292 
r_
.
	`de¡roy
(
™
);

293 ; 
xt
 < 
™
; ++xt)

294 
r_
.
	`cÚ¡ruù
(
xt
, 
v
);

295 
	}
}

297 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

298 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>&

299 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
İ”©Ü
=(cÚ¡ 
sm®l_veùÜ
<
T
, N, A>& 
	gx
) {

300 ià(&
	gx
 !ğ
this
) {

301 
ş—r
();

302 ià(
ÿ·c™y
(è< 
	gx
.capacity())

303 
grow
(
x
.
ÿ·c™y
());

304 autØ
	gx™
 = 
x
.
r_
.
fœ¡_
; x™ !ğx.r_.
Ï¡_
; ++x™, ++
	gr_
.
	gÏ¡_
)

305 
	gr_
.
cÚ¡ruù
(
r_
.
Ï¡_
, *
x™
);

307  *
	gthis
;

310 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

311 
	g‹m¶©e
 <
	gNN
, 
ty³Çme
 
	gAA
>

312 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>&

313 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
İ”©Ü
=(cÚ¡ 
sm®l_veùÜ
<
T
, 
	gNN
, 
	gAA
>& 
	gx
) {

314 
ş—r
();

315 ià(
ÿ·c™y
(è< 
	gx
.capacity())

316 
grow
(
x
.
ÿ·c™y
());

317 autØ
	gx™
 = 
x
.
r_
.
fœ¡_
; x™ !ğx.r_.
Ï¡_
; ++x™, ++
	gr_
.
	gÏ¡_
)

318 
	gr_
.
cÚ¡ruù
(
r_
.
Ï¡_
, *
x™
);

319  *
	gthis
;

322 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

323 
šlše
 
T
* 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$”a£
(
™”©Ü
 
pos™iÚ
) {

324  
	`”a£
(
pos™iÚ
,…osition + 1);

325 
	}
}

327 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

328 
T
* 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
	$”a£
(
™”©Ü
 
fœ¡
, i‹¿tÜ 
Ï¡
) {

329 ià(
fœ¡
 !ğ
Ï¡
) {

330 
™”©Ü
 
™
 = 
fœ¡
, 
x’d
 = 
	`’d
();

331 ; 
Ï¡
 !ğ
x’d
; ++
™
, ++last)

332 *
™
 = 
¡d
::
	`move
(*
Ï¡
);

333 
r_
.
Ï¡_
 = 
™
;

334 ; 
™
 !ğ
x’d
; ++it)

335 
r_
.
	`de¡roy
(
™
);

337  
fœ¡
;

338 
	}
}

340 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,y³Çm
	gA
>

341 
cÚ¡ex´
 
ty³Çme
 
	gsm®l_veùÜ
<
	gT
, 
	gN
, 
	gA
>::
size_ty³


342 
sm®l_veùÜ
<
T
, 
	gN
, 
	gA
>::
sm®l_ÿ·c™y
;

	@masstree-beta/str.cc

16 
	~"¡r.hh
"

17 
Çme¥aû
 
	glcdf
 {

19 cÚ¡ 
SŒ
 
	gSŒ
::
maxkey
("\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF"

	@masstree-beta/str.hh

16 #iâdeà
STR_HH


17 
	#STR_HH


	)

18 
	~"¡ršg_ba£.hh
"

19 
	~<¡d¬g.h
>

20 
	~<¡dio.h
>

21 
Çme¥aû
 
	glcdf
 {

23 
	gSŒ
 : 
public
 
SŒšg_ba£
<
SŒ
> {

24 
SŒ
 
	tsub¡ršg_ty³
;

25 
SŒ
 
	t¬gum’t_ty³
;

27 cÚ¡ *
	gs
;

28 
	gËn
;

30 
SŒ
()

31 : 
s
(0), 
Ën
(0) {

33 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

34 
SŒ
(cÚ¡ 
SŒšg_ba£
<
T
>& 
x
)

35 : 
s
(
x
.
d©a
()), 
Ën
(x.
Ëngth
()) {

37 
SŒ
(cÚ¡ * 
s_
)

38 : 
s
(
s_
), 
Ën
(
¡¾’
(s_)) {

40 
SŒ
(cÚ¡ * 
s_
, 
Ën_
)

41 : 
s
(
s_
), 
Ën
(
Ën_
) {

43 
SŒ
(cÚ¡ * 
s_
, 
Ën_
)

44 : 
s
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s_
)), 
Ën
(
Ën_
) {

46 
SŒ
(cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
)

47 : 
s
(
fœ¡
), 
Ën
(
Ï¡
 - first) {

48 
´ecÚd™iÚ
(
fœ¡
 <ğ
Ï¡
);

50 
SŒ
(cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
)

51 : 
s
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
fœ¡
)), 
Ën
(
Ï¡
 - first) {

52 
´ecÚd™iÚ
(
fœ¡
 <ğ
Ï¡
);

54 
SŒ
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
)

55 : 
s
(
¡r
.
d©a
()), 
Ën
(¡r.
Ëngth
()) {

57 
SŒ
(cÚ¡ 
unš™Ÿlized_ty³
 &
unu£d
) {

58 (è
	gunu£d
;

61 cÚ¡ 
SŒ
 
	gmaxkey
;

63 
assign
() {

64 
	gs
 = 0;

65 
	gËn
 = 0;

67 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

68 
assign
(cÚ¡ 
SŒšg_ba£
<
T
> &
x
) {

69 
	gs
 = 
x
.
d©a
();

70 
	gËn
 = 
x
.
Ëngth
();

72 
assign
(cÚ¡ *
s_
) {

73 
	gs
 = 
s_
;

74 
	gËn
 = 
¡¾’
(
s_
);

76 
assign
(cÚ¡ *
s_
, 
Ën_
) {

77 
	gs
 = 
s_
;

78 
	gËn
 = 
Ën_
;

81 cÚ¡ *
d©a
() const {

82  
	gs
;

84 
Ëngth
() const {

85  
	gËn
;

87 * 
mubË_d©a
() {

88  
	gcÚ¡_ÿ¡
<*>(
	gs
);

91 
SŒ
 
´efix
(
Ënx
) const {

92  
SŒ
(
s
, 
Ënx
 < 
Ën
 ?†enx :†en);

94 
SŒ
 
sub¡ršg
(cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
) const {

95 ià(
	gfœ¡
 <ğ
Ï¡
 && 
fœ¡
 >ğ
s
 &&†a¡ <ğ + 
Ën
)

96  
SŒ
(
fœ¡
, 
Ï¡
);

98  
SŒ
();

100 
SŒ
 
sub¡ršg
(cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
) const {

101 cÚ¡ *
	gu
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
);

102 ià(
	gfœ¡
 <ğ
Ï¡
 && 
fœ¡
 >ğ
u
 &&†a¡ <ğu + 
Ën
)

103  
SŒ
(
fœ¡
, 
Ï¡
);

105  
SŒ
();

107 
SŒ
 
ç¡_sub¡ršg
(cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
) const {

108 
as£¹
(
begš
(è<ğ
fœ¡
 && fœ¡ <ğ
Ï¡
 &&†a¡ <ğ
’d
());

109  
SŒ
(
fœ¡
, 
Ï¡
);

111 
SŒ
 
ç¡_sub¡ršg
(cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
) const {

112 
as£¹
(
ubegš
(è<ğ
fœ¡
 && fœ¡ <ğ
Ï¡
 &&†a¡ <ğ
u’d
());

113  
SŒ
(
fœ¡
, 
Ï¡
);

115 
SŒ
 
Érim
() const {

116  
	gSŒšg_g’”ic
::
Érim
(*
this
);

118 
SŒ
 
¹rim
() const {

119  
	gSŒšg_g’”ic
::
¹rim
(*
this
);

121 
SŒ
 
Œim
() const {

122  
	gSŒšg_g’”ic
::
Œim
(*
this
);

125 
to_i
() const {

126 
	gx
 = 0;

127 
	gp
;

128 
	gp
 = 0;… < 
	gËn
 && 
	gs
[
p
] >ğ'0' && 
s
[p] <= '9'; ++p)

129 
	gx
 = (
x
 * 10è+ 
s
[
p
] - '0';

130  
	gp
 =ğ
Ën
 && 
p
 !ğ0 ? 
x
 : -1;

133 
SŒ
 
¢´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...) {

134 
va_li¡
 
	gv®
;

135 
va_¡¬t
(
v®
, 
fmt
);

136 
	gn
 = 
v¢´štf
(
buf
, 
size
, 
fmt
, 
v®
);

137 
va_’d
(
v®
);

138  
SŒ
(
buf
, 
n
);

142 
	gšlše_¡ršg
 : 
public
 
SŒšg_ba£
<
šlše_¡ršg
> {

143 
Ën
;

144 
	gs
[0];

146 cÚ¡ *
d©a
() const {

147  
	gs
;

149 
Ëngth
() const {

150  
	gËn
;

153 
size_t
 
size
() const {

154  (
	gšlše_¡ršg
è+ 
	gËn
;

156 
size_t
 
size
(
Ën
) {

157  (
	gšlše_¡ršg
è+ 
	gËn
;

163 
	$LCDF_MAKE_STRING_HASH
(
lcdf
::
SŒ
)

164 
	$LCDF_MAKE_STRING_HASH
(
lcdf
::
šlše_¡ršg
)

	@masstree-beta/straccum.cc

34 
	~"¡¿ccum.hh
"

35 
	~<¡d¬g.h
>

36 
	~<¡dio.h
>

37 
	~<ùy³.h
>

38 
	~<”ºo.h
>

39 
Çme¥aû
 
	glcdf
 {

69 
	gSŒšgAccum
::
assign_out_of_memÜy
()

71 ià(
r_
.
ÿp
 > 0)

72 
d–‘e
[] 
»š‹½»t_ÿ¡
<*>(
r_
.
s
 - 
memo_¥aû
);

73 
	gr_
.
	gs
 = 
»š‹½»t_ÿ¡
<*>(
cÚ¡_ÿ¡
<*>(
SŒšg_g’”ic
::
em±y_d©a
));

74 
	gr_
.
	gÿp
 = -1;

75 
	gr_
.
	gËn
 = 0;

78 * 
	gSŒšgAccum
::
grow
(
nÿp
) {

80 ià(
r_
.
ÿp
 < 0) {

81 
”ºo
 = 
ENOMEM
;

85 ià(
	gnÿp
 < 
	gr_
.
	gÿp
)

86  
	g»š‹½»t_ÿ¡
<*>(
	gr_
.
	gs
 +„_.
	gËn
);

87 ià(
	gnÿp
 < 128)

88 
	gnÿp
 = 128;

89 ià(
	gr_
.
	gÿp
 < (1 << 20è&& 
	gnÿp
 < (r_.ÿ°+ 
	gmemo_¥aû
) * 2 - memo_space)

90 
	gnÿp
 = (
r_
.
ÿp
 + 
memo_¥aû
) * 2 - memo_space;

91 ià(
	gr_
.
	gÿp
 >ğ(1 << 20è&& 
nÿp
 < 
r_
.
ÿp
 + (1 << 19))

92 
nÿp
 = 
r_
.
ÿp
 + (1 << 19);

94 * 
	gn
 = 
Ãw
 [
nÿp
 + 
memo_¥aû
];

95 ià(!
	gn
) {

96 
assign_out_of_memÜy
();

97 
	g”ºo
 = 
ENOMEM
;

101 
	gn
 +ğ
memo_¥aû
;

102 ià(
	gr_
.
	gÿp
 > 0) {

103 
memıy
(
n
, 
r_
.
s
,„_.
Ën
);

104 
	gd–‘e
[] 
	g»š‹½»t_ÿ¡
<*>(
	gr_
.
	gs
 - 
	gmemo_¥aû
);

106 
	gr_
.
	gs
 = 
»š‹½»t_ÿ¡
<*>(
n
);

107 
	gr_
.
	gÿp
 = 
nÿp
;

108  
	g»š‹½»t_ÿ¡
<*>(
	gr_
.
	gs
 +„_.
	gËn
);

115 
	gSŒšgAccum
::
»size
(
Ën
)

117 
as£¹
(
Ën
 >= 0);

118 ià(
	gËn
 > 
	gr_
.
	gÿp
 && !
grow
(
Ën
))

119  -
	gENOMEM
;

121 
	gr_
.
	gËn
 = 
Ën
;

127 
	gSŒšgAccum
::
h¬d_ex‹nd
(
Çdju¡
, 
Äe£rve
)

129 *
	gx
;

130 ià(
	gr_
.
	gËn
 + 
	gÇdju¡
 + 
	gÄe£rve
 <ğ
r_
.
ÿp
)

131 
x
 = 
»š‹½»t_ÿ¡
<*>(
r_
.
s
 +„_.
Ën
);

133 
	gx
 = 
grow
(
r_
.
Ën
 + 
Çdju¡
 + 
Äe£rve
);

134 ià(
	gx
)

135 
	gr_
.
	gËn
 +ğ
Çdju¡
;

136  
	gx
;

139 
	gSŒšgAccum
::
Œªsãr_äom
(
SŒšg
& 
x
) {

140 ià(
x
.
is_sh¬ed
(è|| x.
_r
.
memo_off£t
 !ğ-
memo_¥aû
) {

141 
­³nd
(
x
.
begš
(), x.
’d
());

142 
	gx
.
	g_r
.
d”ef
();

144 
	gr_
.
	gs
 = 
cÚ¡_ÿ¡
<*>(
x
.
ud©a
());

145 
	gr_
.
	gËn
 = 
x
.
Ëngth
();

146 
	gr_
.
	gÿp
 = 
x
.
_r
.
memo
()->
ÿ·c™y
;

157 
	gSŒšgAccum
::
c_¡r
()

159 ià(
r_
.
Ën
 <„_.
ÿp
 || 
grow
(r_.len))

160 
r_
.
s
[r_.
Ën
] = '\0';

161  
	g»š‹½»t_ÿ¡
<*>(
	gr_
.
	gs
);

166 
	gSŒšgAccum
::
­³nd_fl
(
c
, 
Ën
)

168 ià(*
	gs
 = 
ex‹nd
(
Ën
))

169 
mem£t
(
s
, 
c
, 
Ën
);

173 
	gSŒšgAccum
::
h¬d_­³nd
(cÚ¡ *
s
, 
Ën
)

177 cÚ¡ *
	gmy_s
 = 
»š‹½»t_ÿ¡
<*>(
r_
.
s
);

179 ià(
	gr_
.
	gËn
 +†’ <ğ
r_
.
ÿp
) {

180 
sucûss
:

181 
memıy
(
r_
.
s
 +„_.
Ën
, s,†en);

182 
	gr_
.
	gËn
 +ğ
Ën
;

183 } ià(
lik–y
(
s
 < 
my_s
 || s >ğmy_ + 
r_
.
ÿp
)) {

184 ià(
grow
(
r_
.
Ën
 +†en))

185 
sucûss
;

187 
»p_t
 
	gŞd_r
 = 
r_
;

188 
	gr_
 = 
»p_t
();

189 ià(*
	gÃw_s
 = 
ex‹nd
(
Şd_r
.
Ën
 +†en)) {

190 
memıy
(
Ãw_s
, 
Şd_r
.
s
, old_r.
Ën
);

191 
memıy
(
Ãw_s
 + 
Şd_r
.
Ën
, 
s
,†en);

193 
	gd–‘e
[] 
	g»š‹½»t_ÿ¡
<*>(
	gŞd_r
.
	gs
 - 
	gmemo_¥aû
);

198 
	gSŒšgAccum
::
h¬d_­³nd_c¡r
(cÚ¡ *
c¡r
)

200 
­³nd
(
c¡r
, 
¡¾’
(cstr));

203 
boŞ


204 
	gSŒšgAccum
::
­³nd_utf8_h¬d
(
ch
)

206 ià(
ch
 < 0x8000) {

207 
­³nd
(
¡©ic_ÿ¡
<>(0xC0 | (
ch
 >> 6)));

208 
	gch¬1
;

209 } ià(
	gch
 < 0x10000) {

210 ià(
uÆik–y
((
ch
 >= 0xD800 && ch < 0xE000) || ch > 0xFFFD))

211  
çl£
;

212 
­³nd
(
¡©ic_ÿ¡
<>(0xE0 | (
ch
 >> 12)));

213 
	gch¬2
;

214 } ià(
	gch
 < 0x110000) {

215 
­³nd
(
¡©ic_ÿ¡
<>(0xF0 | (
ch
 >> 18)));

216 
­³nd
(
¡©ic_ÿ¡
<>(0x80 | ((
ch
 >> 12) & 0x3F)));

217 
	gch¬2
:

218 
­³nd
(
¡©ic_ÿ¡
<>(0x80 | ((
ch
 >> 6) & 0x3F)));

219 
	gch¬1
:

220 
­³nd
(
¡©ic_ÿ¡
<>(0x80 | (
ch
 & 0x3F)));

222  
	gçl£
;

223  
	gŒue
;

233 
SŒšg


234 
	gSŒšgAccum
::
ke_¡ršg
()

236 
Ën
 = 
Ëngth
();

237 
	gÿp
 = 
r_
.
ÿp
;

238 * 
	g¡r
 = 
»š‹½»t_ÿ¡
<*>(
r_
.
s
);

239 ià(
	gËn
 > 0 && 
	gÿp
 > 0) {

240 
	gSŒšg
::
memo_ty³
* 
memo
 =

241 
»š‹½»t_ÿ¡
<
SŒšg
::
memo_ty³
*>(
r_
.
s
 - 
memo_¥aû
);

242 
	gmemo
->
š™Ÿlize
(
ÿp
, 
Ën
);

243 
	gr_
 = 
»p_t
();

244  
SŒšg
(
¡r
, 
Ën
, 
memo
);

245 } ià(!
out_of_memÜy
())

246  
SŒšg
();

248 
ş—r
();

249  
	gSŒšg
::
make_out_of_memÜy
();

255 
	gSŒšgAccum
::
sw­
(
SŒšgAccum
 &
x
)

257 
»p_t
 
xr
 = 
x
.
r_
;

258 
	gx
.
	gr_
 = 
r_
;

259 
	gr_
 = 
xr
;

265 
	gSŒšgAccum
 &

266 
	gİ”©Ü
<<(
	gSŒšgAccum
 &
	g§
, 
	gi
)

268 ià(*
	gx
 = 
§
.
»£rve
(24)) {

269 
Ën
 = 
¥rštf
(
x
, "%ld", 
i
);

270 
	g§
.
adju¡_Ëngth
(
Ën
);

272  
	g§
;

278 
	gSŒšgAccum
 &

279 
	gİ”©Ü
<<(
	gSŒšgAccum
 &
	g§
, 
	gu
)

281 ià(*
	gx
 = 
§
.
»£rve
(24)) {

282 
Ën
 = 
¥rštf
(
x
, "%lu", 
u
);

283 
	g§
.
adju¡_Ëngth
(
Ën
);

285  
	g§
;

291 
	gSŒšgAccum
 &

292 
	gİ”©Ü
<<(
	gSŒšgAccum
 &
	g§
, 
	gi
)

294 ià(*
	gx
 = 
§
.
»£rve
(24)) {

295 
Ën
 = 
¥rštf
(
x
, "%Îd", 
i
);

296 
	g§
.
adju¡_Ëngth
(
Ën
);

298  
	g§
;

304 
	gSŒšgAccum
 &

305 
	gİ”©Ü
<<(
	gSŒšgAccum
 &
	g§
, 
	gu
)

307 ià(*
	gx
 = 
§
.
»£rve
(24)) {

308 
Ën
 = 
¥rštf
(
x
, "%Îu", 
u
);

309 
	g§
.
adju¡_Ëngth
(
Ën
);

311  
	g§
;

314 
	gSŒšgAccum
 &

315 
	gİ”©Ü
<<(
	gSŒšgAccum
 &
	g§
, 
	gd
)

317 ià(*
	gx
 = 
§
.
»£rve
(256)) {

318 
Ën
 = 
¥rštf
(
x
, "%.12g", 
d
);

319 
	g§
.
adju¡_Ëngth
(
Ën
);

321  
	g§
;

330 
	gSŒšgAccum
 &

331 
	gSŒšgAccum
::
v¢´štf
(
n
, cÚ¡ *
fÜm©
, 
va_li¡
 
v®
)

333 ià(*
	gx
 = 
»£rve
(
n
 + 1)) {

334 #ià
HAVE_VSNPRINTF


335 
Ën
 = ::
v¢´štf
(
x
, 
n
 + 1, 
fÜm©
, 
v®
);

337 
	gËn
 = 
v¥rštf
(
x
, 
fÜm©
, 
v®
);

338 
as£¹
(
Ën
 <ğ
n
);

340 
adju¡_Ëngth
(
Ën
);

342  *
	gthis
;

359 
	gSŒšgAccum
 &

360 
	gSŒšgAccum
::
¢´štf
(
n
, cÚ¡ *
fÜm©
, ...)

362 
va_li¡
 
	gv®
;

363 
va_¡¬t
(
v®
, 
fÜm©
);

364 
v¢´štf
(
n
, 
fÜm©
, 
v®
);

365 
va_’d
(
v®
);

366  *
	gthis
;

370 
	gSŒšgAccum
::
­³nd_b»ak_lšes
(cÚ¡ 
SŒšg
& 
‹xt
, 
lš–’
, cÚ¡ SŒšg &
Ëám¬gš
)

372 ià(
	g‹xt
.
Ëngth
() == 0)

374 cÚ¡ * 
	glše
 = 
‹xt
.
begš
();

375 cÚ¡ * 
	g’ds
 = 
‹xt
.
’d
();

376 
	glš–’
 -ğ
Ëám¬gš
.
Ëngth
();

377 cÚ¡ * 
	gs
 = 
lše
; s < 
	g’ds
; s++) {

378 cÚ¡ * 
	g¡¬t
 = 
s
;

379 
	gs
 < 
	g’ds
 && 
is¥aû
((è*
s
))

380 
	gs
++;

381 cÚ¡ * 
	gwÜd
 = 
s
;

382 
	gs
 < 
	g’ds
 && !
is¥aû
((è*
s
))

383 
	gs
++;

384 ià(
	gs
 - 
	glše
 > 
	glš–’
 && 
	g¡¬t
 >†ine) {

385 *
	gthis
 << 
	gËám¬gš
;

386 
­³nd
(
lše
, 
¡¬t
 -†ine);

387 *
	gthis
 << '\n';

388 
	glše
 = 
wÜd
;

391 ià(
	glše
 < 
	g‹xt
.
’d
()) {

392 *
	gthis
 << 
	gËám¬gš
;

393 
­³nd
(
lše
, 
‹xt
.
’d
() -†ine);

394 *
	gthis
 << '\n';

	@masstree-beta/straccum.hh

16 #iâdeà
LCDF_STRACCUM_HH


17 
	#LCDF_STRACCUM_HH


	)

18 
	~<¡ršg.h
>

19 
	~<as£¹.h
>

20 
	~<¡d¬g.h
>

21 
	~"¡ršg.hh
"

22 #ià
__GNUC__
 > 4

23 
	#LCDF_SNPRINTF_ATTR
 
	`__©Œibu‹__
((
	`__fÜm©__
(
__´štf__
, 3, 4)))

	)

25 
	#LCDF_SNPRINTF_ATTR


	)

27 
Çme¥aû
 
	glcdf
 {

33 şas 
	cSŒšgAccum
 { 
	gpublic
:

35 cÚ¡ *
	tcÚ¡_™”©Ü
;

36 *
	t™”©Ü
;

38 (
	gSŒšgAccum
::*
	tun¥ecif›d_boŞ_ty³
)() const;

40 
šlše
 
SŒšgAccum
();

41 
ex¶ic™
 
šlše
 
SŒšgAccum
(
ÿ·c™y
);

42 
ex¶ic™
 
šlše
 
SŒšgAccum
(cÚ¡ * 
c¡r
);

43 
šlše
 
SŒšgAccum
(cÚ¡ * 
s
, 
Ën
);

44 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

45 
šlše
 
SŒšgAccum
(cÚ¡ 
SŒšg_ba£
<
T
>& 
¡r
);

46 
šlše
 
SŒšgAccum
(cÚ¡ SŒšgAccum& 
x
);

47 #ià
HAVE_CXX_RVALUE_REFERENCES


48 
šlše
 
SŒšgAccum
(SŒšgAccum&& 
x
);

49 
šlše
 
SŒšgAccum
(
SŒšg
&& 
x
);

51 
	gšlše
 ~
SŒšgAccum
();

52 
šlše
 
SŒšgAccum
 
make_Œªsãr
(
SŒšg
& 
x
);

54 
šlše
 
	gSŒšgAccum
& 
	gİ”©Ü
=(cÚ¡ 
SŒšgAccum
& 
x
);

55 #ià
HAVE_CXX_RVALUE_REFERENCES


56 
šlše
 
	gSŒšgAccum
& 
	gİ”©Ü
=(
SŒšgAccum
&& 
x
);

59 
šlše
 cÚ¡ * 
d©a
() const;

60 
šlše
 * 
d©a
();

61 
šlše
 cÚ¡ * 
ud©a
() const;

62 
šlše
 * 
ud©a
();

63 
šlše
 
Ëngth
() const;

64 
šlše
 
ÿ·c™y
() const;

66 cÚ¡ * 
c_¡r
();

68 
šlše
 
İ”©Ü
 
un¥ecif›d_boŞ_ty³
() const;

69 
šlše
 
boŞ
 
em±y
() const;

70 
šlše
 
boŞ
 
	gİ”©Ü
!() const;

72 
šlše
 
cÚ¡_™”©Ü
 
begš
() const;

73 
šlše
 
™”©Ü
 
begš
();

74 
šlše
 
cÚ¡_™”©Ü
 
’d
() const;

75 
šlše
 
™”©Ü
 
’d
();

77 
šlše
 
	gİ”©Ü
[](
	gi
) const;

78 
šlše
 & 
	gİ”©Ü
[](
	gi
);

79 
šlše
 
äÚt
() const;

80 
šlše
 & 
äÚt
();

81 
šlše
 
back
() const;

82 
šlše
 & 
back
();

84 
šlše
 
boŞ
 
out_of_memÜy
() const;

85 
assign_out_of_memÜy
();

87 
šlše
 
ş—r
();

88 
šlše
 * 
»£rve
(
n
);

89 
šlše
 
£t_Ëngth
(
Ën
);

90 
»size
(
Ën
);

91 
šlše
 
adju¡_Ëngth
(
d–
);

92 
šlše
 
£t_’d
(* 
’d
);

93 
šlše
 
£t_’d
(* 
’d
);

94 
šlše
 * 
ex‹nd
(
Çdju¡
, 
Äe£rve
 = 0);

96 
šlše
 
pİ_back
(
n
 = 1);

98 
šlše
 
­³nd
(
c
);

99 
šlše
 
­³nd
(
c
);

100 
šlše
 
boŞ
 
­³nd_utf8
(
ch
);

101 
šlše
 
­³nd
(cÚ¡ * 
c¡r
);

102 
šlše
 
­³nd
(cÚ¡ * 
s
, 
Ën
);

103 
šlše
 
­³nd
(cÚ¡ * 
s
, 
Ën
);

104 
šlše
 
­³nd
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

105 
šlše
 
­³nd
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

106 
­³nd_fl
(
c
, 
Ën
);

108 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

109 
­³nd_’coded
(
T
& 
¡©e
, cÚ¡ * 
fœ¡
,

110 cÚ¡ * 
Ï¡
);

111 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

112 
šlše
 
­³nd_’coded
(
T
& 
¡©e
, cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

113 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

114 
­³nd_’coded
(
T
& 
¡©e
);

115 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

116 
šlše
 
­³nd_’coded
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

117 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

118 
šlše
 
­³nd_’coded
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

121 
	g‹m¶©e
 <
ty³Çme
 
	gI
>

122 
šlše
 
­³nd_još
(cÚ¡ 
SŒšg
& 
još”
, 
I
 
fœ¡
, I 
Ï¡
);

123 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

124 
šlše
 
­³nd_još
(cÚ¡ 
SŒšg
& 
još”
, cÚ¡ 
T
& 
x
);

125 
­³nd_b»ak_lšes
(cÚ¡ 
SŒšg
& 
‹xt
, 
lš–’
, cÚ¡ SŒšg& 
Ëám¬gš
 = String());

127 
	gSŒšgAccum
& 
¢´štf
(
n
, cÚ¡ * 
fÜm©
, ...è
	gLCDF_SNPRINTF_ATTR
;

128 
	gSŒšgAccum
& 
v¢´štf
(
n
, cÚ¡ * 
fÜm©
, 
va_li¡
 
v®
);

130 
SŒšg
 
ke_¡ršg
();

132 
sw­
(
SŒšgAccum
& 
x
);

136 
	g´iv©e
:

139 
memo_¥aû
 = 
SŒšg
::
MEMO_SPACE


142 
	s»p_t
 {

143 * 
	gs
;

144 
	gËn
;

145 
	gÿp
;

146 
»p_t
()

147 : 
s
(
»š‹½»t_ÿ¡
<*>(
cÚ¡_ÿ¡
<*>(
SŒšg_g’”ic
::
em±y_d©a
))),

148 
Ën
(0), 
ÿp
(0) {

150 
ex¶ic™
 
»p_t
(
unš™Ÿlized_ty³
) {

154 
»p_t
 
	gr_
;

156 * 
grow
(
nÿp
);

157 * 
h¬d_ex‹nd
(
Çdju¡
, 
Äe£rve
);

158 
h¬d_­³nd
(cÚ¡ * 
s
, 
Ën
);

159 
h¬d_­³nd_c¡r
(cÚ¡ * 
c¡r
);

160 
boŞ
 
­³nd_utf8_h¬d
(
ch
);

161 
Œªsãr_äom
(
SŒšg
& 
x
);

164 
šlše
 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, 
	gc
);

165 
šlše
 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, 
	gc
);

166 
šlše
 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, cÚ¡ *
	gc¡r
);

167 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
šlše
 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, cÚ¡ 
	gSŒšg_ba£
<T>& 
	g¡r
);

168 
šlše
 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, cÚ¡ SŒšgAccum& 
	gx
);

170 
šlše
 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, 
boŞ
 
	gx
);

171 
šlše
 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, 
	gx
);

172 
šlše
 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, 
	gx
);

173 
šlše
 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, 
	gx
);

174 
šlše
 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, 
	gx
);

175 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, 
	gx
);

176 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, 
	gx
);

177 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, 
	gx
);

178 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, 
	gx
);

179 
	gSŒšgAccum
& 
	gİ”©Ü
<<(SŒšgAccum& 
	g§
, 
	gx
);

182 
šlše
 
	gSŒšgAccum
::
	$SŒšgAccum
() {

183 
	}
}

192 
šlše
 
SŒšgAccum
::
	$SŒšgAccum
(
ÿ·c™y
) {

193 
	`as£¹
(
ÿ·c™y
 >= 0);

194 
	`grow
(
ÿ·c™y
);

195 
	}
}

198 
šlše
 
	gSŒšgAccum
::
	$SŒšgAccum
(cÚ¡ *
c¡r
) {

199 
	`­³nd
(
c¡r
);

200 
	}
}

203 
šlše
 
	gSŒšgAccum
::
	$SŒšgAccum
(cÚ¡ *
s
, 
Ën
) {

204 
	`­³nd
(
s
, 
Ën
);

205 
	}
}

208 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

209 
šlše
 
	gSŒšgAccum
::
SŒšgAccum
(cÚ¡ 
SŒšg_ba£
<
T
> &
¡r
) {

210 
­³nd
(
¡r
.
begš
(), sŒ.
’d
());

214 
šlše
 
	gSŒšgAccum
::
	$SŒšgAccum
(cÚ¡ 
SŒšgAccum
 &
x
) {

215 
	`­³nd
(
x
.
	`d©a
(), x.
	`Ëngth
());

216 
	}
}

218 #ià
HAVE_CXX_RVALUE_REFERENCES


220 
šlše
 
	gSŒšgAccum
::
	$SŒšgAccum
(
SŒšgAccum
&& 
x
) {

221 
usšg
 
¡d
::
sw­
;

222 
	`sw­
(
r_
, 
x
.r_);

223 
	}
}

225 
šlše
 
	gSŒšgAccum
::
	$SŒšgAccum
(
SŒšg
&& 
x
) {

226 
	`Œªsãr_äom
(
x
);

227 
x
.
_r
 = 
SŒšg
::
»p_ty³
{
SŒšg_g’”ic
::
em±y_d©a
, 0, 0};

228 
	}
}

232 
šlše
 
	gSŒšgAccum
::~
	$SŒšgAccum
() {

233 ià(
r_
.
ÿp
 > 0)

234 
d–‘e
[] 
»š‹½»t_ÿ¡
<*>(
r_
.
s
 - 
memo_¥aû
);

235 
	}
}

237 
šlše
 
SŒšgAccum
 
	gSŒšgAccum
::
	$make_Œªsãr
(
SŒšg
& 
x
) {

238 
SŒšgAccum
 
§
;

239 
§
.
	`Œªsãr_äom
(
x
);

240 
x
.
_r
 = 
SŒšg
::
»p_ty³
{
SŒšg_g’”ic
::
em±y_d©a
, 0, 0};

241  
§
;

242 
	}
}

247 
šlše
 cÚ¡ * 
	gSŒšgAccum
::
	$d©a
() const {

248  
»š‹½»t_ÿ¡
<cÚ¡ *>(
r_
.
s
);

249 
	}
}

252 
šlše
 * 
	gSŒšgAccum
::
	$d©a
() {

253  
»š‹½»t_ÿ¡
<*>(
r_
.
s
);

254 
	}
}

259 
šlše
 cÚ¡ * 
	gSŒšgAccum
::
	$ud©a
() const {

260  
r_
.
s
;

261 
	}
}

264 
šlše
 * 
	gSŒšgAccum
::
	$ud©a
() {

265  
r_
.
s
;

266 
	}
}

269 
šlše
 
	gSŒšgAccum
::
	$Ëngth
() const {

270  
r_
.
Ën
;

271 
	}
}

278 
šlše
 
	gSŒšgAccum
::
	$ÿ·c™y
() const {

279  
r_
.
ÿp
;

280 
	}
}

286 
šlše
 
	gSŒšgAccum
::
cÚ¡_™”©Ü
 
SŒšgAccum
::
	$begš
() const {

287  
»š‹½»t_ÿ¡
<*>(
r_
.
s
);

288 
	}
}

291 
šlše
 
	gSŒšgAccum
::
™”©Ü
 
SŒšgAccum
::
	$begš
() {

292  
»š‹½»t_ÿ¡
<*>(
r_
.
s
);

293 
	}
}

299 
šlše
 
	gSŒšgAccum
::
cÚ¡_™”©Ü
 
SŒšgAccum
::
	$’d
() const {

300  
»š‹½»t_ÿ¡
<*>(
r_
.
s
 +„_.
Ën
);

301 
	}
}

304 
šlše
 
	gSŒšgAccum
::
™”©Ü
 
SŒšgAccum
::
	$’d
() {

305  
»š‹½»t_ÿ¡
<*>(
r_
.
s
 +„_.
Ën
);

306 
	}
}

309 
šlše
 
	gSŒšgAccum
::
İ”©Ü
 
	$un¥ecif›d_boŞ_ty³
() const {

310  
r_
.
Ën
 !ğ0 ? &
SŒšgAccum
::
ÿ·c™y
 : 0;

311 
	}
}

316 
šlše
 
boŞ
 
	gSŒšgAccum
::
İ”©Ü
!() const {

317  
r_
.
Ën
 == 0;

321 
šlše
 
boŞ
 
	gSŒšgAccum
::
	$em±y
() const {

322  
r_
.
Ën
 == 0;

323 
	}
}

326 
šlše
 
boŞ
 
	gSŒšgAccum
::
	$out_of_memÜy
() const {

327  
	`uÆik–y
(
r_
.
ÿp
 < 0);

328 
	}
}

333 
šlše
 
	gSŒšgAccum
::
İ”©Ü
[](
i
) const {

334 
as£¹
((è
i
 < (è
r_
.
Ën
);

335  
	g¡©ic_ÿ¡
<>(
	gr_
.
	gs
[
i
]);

341 
šlše
 &
	gSŒšgAccum
::
İ”©Ü
[](
i
) {

342 
as£¹
((è
i
 < (è
r_
.
Ën
);

343  
	g»š‹½»t_ÿ¡
<&>(
	gr_
.
	gs
[
i
]);

348 
šlše
 
	gSŒšgAccum
::
	$äÚt
() const {

349 
	`as£¹
(
r_
.
Ën
 > 0);

350  
¡©ic_ÿ¡
<>(
r_
.
s
[0]);

351 
	}
}

355 
šlše
 &
	gSŒšgAccum
::
	$äÚt
() {

356 
	`as£¹
(
r_
.
Ën
 > 0);

357  
»š‹½»t_ÿ¡
<&>(
r_
.
s
[0]);

358 
	}
}

362 
šlše
 
	gSŒšgAccum
::
	$back
() const {

363 
	`as£¹
(
r_
.
Ën
 > 0);

364  
¡©ic_ÿ¡
<>(
r_
.
s
[r_.
Ën
 - 1]);

365 
	}
}

369 
šlše
 &
	gSŒšgAccum
::
	$back
() {

370 
	`as£¹
(
r_
.
Ën
 > 0);

371  
»š‹½»t_ÿ¡
<&>(
r_
.
s
[r_.
Ën
 - 1]);

372 
	}
}

378 
šlše
 
	gSŒšgAccum
::
	$ş—r
() {

379 ià(
r_
.
ÿp
 < 0)

380 
r_
.
ÿp
 = 0;

381 
r_
.
Ën
 = 0;

382 
	}
}

396 
šlše
 *
	gSŒšgAccum
::
	$»£rve
(
n
) {

397 
	`as£¹
(
n
 >= 0);

398 ià(
r_
.
Ën
 + 
n
 <ğr_.
ÿp
)

399  
»š‹½»t_ÿ¡
<*>(
r_
.
s
 +„_.
Ën
);

401  
	`grow
(
r_
.
Ën
 + 
n
);

402 
	}
}

408 
šlše
 
	gSŒšgAccum
::
	$£t_Ëngth
(
Ën
) {

409 
	`as£¹
(
Ën
 >ğ0 && 
r_
.ËÀ<ğr_.
ÿp
);

410 
r_
.
Ën
 =†en;

411 
	}
}

413 
šlše
 
	gSŒšgAccum
::
	$£t_’d
(* 
x
) {

414 
	`as£¹
(
x
 >ğ
r_
.
s
 && x <ğr_. +„_.
ÿp
);

415 
r_
.
Ën
 = 
x
 -„_.
s
;

416 
	}
}

418 
šlše
 
	gSŒšgAccum
::
	$£t_’d
(* 
x
) {

419 
	`£t_’d
((*è
x
);

420 
	}
}

430 
šlše
 
	gSŒšgAccum
::
	$adju¡_Ëngth
(
d–
) {

431 
	`as£¹
(
r_
.
Ën
 + 
d–
 >ğ0 &&„_.ËÀ+ d– <ğr_.
ÿp
);

432 
r_
.
Ën
 +ğ
d–
;

433 
	}
}

443 
šlše
 *
	gSŒšgAccum
::
	$ex‹nd
(
Çdju¡
, 
Äe£rve
) {

444 #ià
HAVE_OPTIMIZE_SIZE
 || 
__OPTIMIZE_SIZE__


445  
	`h¬d_ex‹nd
(
Çdju¡
, 
Äe£rve
);

447 
	`as£¹
(
Çdju¡
 >ğ0 && 
Äe£rve
 >= 0);

448 ià(
r_
.
Ën
 + 
Çdju¡
 + 
Äe£rve
 <ğr_.
ÿp
) {

449 *
x
 = 
»š‹½»t_ÿ¡
<*>(
r_
.
s
 +„_.
Ën
);

450 
r_
.
Ën
 +ğ
Çdju¡
;

451  
x
;

453  
	`h¬d_ex‹nd
(
Çdju¡
, 
Äe£rve
);

455 
	}
}

462 
šlše
 
	gSŒšgAccum
::
	$pİ_back
(
n
) {

463 
	`as£¹
(
n
 >ğ0 && 
r_
.
Ën
 >=‚);

464 
r_
.
Ën
 -ğ
n
;

465 
	}
}

469 
šlše
 
	gSŒšgAccum
::
	$­³nd
(
c
) {

470 ià(
r_
.
Ën
 <„_.
ÿp
 || 
	`grow
(r_.len))

471 
r_
.
s
[r_.
Ën
++] = 
c
;

472 
	}
}

475 
šlše
 
	gSŒšgAccum
::
	$­³nd
(
c
) {

476 
	`­³nd
(
¡©ic_ÿ¡
<>(
c
));

477 
	}
}

483 
šlše
 
	gSŒšgAccum
::
	$­³nd
(cÚ¡ *
s
, 
Ën
) {

484 #ià
HAVE_OPTIMIZE_SIZE
 || 
__OPTIMIZE_SIZE__


485 
	`h¬d_­³nd
(
s
, 
Ën
);

487 
	`as£¹
(
Ën
 >= 0);

488 ià(
r_
.
Ën
 +†’ <ğr_.
ÿp
) {

489 
	`memıy
(
r_
.
s
 +„_.
Ën
, s,†en);

490 
r_
.
Ën
 +=†en;

492 
	`h¬d_­³nd
(
s
, 
Ën
);

494 
	}
}

497 
šlše
 
	gSŒšgAccum
::
	$­³nd
(cÚ¡ *
s
, 
Ën
) {

498 
	`­³nd
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
), 
Ën
);

499 
	}
}

503 
šlše
 
	gSŒšgAccum
::
	$­³nd
(cÚ¡ *
c¡r
) {

504 ià(
	`LCDF_CONSTANT_CSTR
(
c¡r
))

505 
	`­³nd
(
c¡r
, 
	`¡¾’
(cstr));

507 
	`h¬d_­³nd_c¡r
(
c¡r
);

508 
	}
}

514 
šlše
 
	gSŒšgAccum
::
	$­³nd
(cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
) {

515 ià(
fœ¡
 < 
Ï¡
)

516 
	`­³nd
(
fœ¡
, 
Ï¡
 - first);

517 
	}
}

520 
šlše
 
	gSŒšgAccum
::
	$­³nd
(cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
) {

521 ià(
fœ¡
 < 
Ï¡
)

522 
	`­³nd
(
fœ¡
, 
Ï¡
 - first);

523 
	}
}

529 
šlše
 
boŞ
 
	gSŒšgAccum
::
	$­³nd_utf8
(
ch
) {

530 ià(
	`uÆik–y
(
ch
 <= 0))

531  
çl£
;

532 ià(
	`lik–y
(
ch
 <= 0x7F)) {

533 
	`­³nd
(
¡©ic_ÿ¡
<>(
ch
));

534  
Œue
;

536  
	`­³nd_utf8_h¬d
(
ch
);

537 
	}
}

539 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

540 
	gSŒšgAccum
::
	$­³nd_’coded
(
T
 &
’cod”
,

541 cÚ¡ *
fœ¡
,

542 cÚ¡ *
Ï¡
)

544 *
kls
 = 0;

545 ià(
fœ¡
 !ğ
Ï¡
)

546 
fœ¡
 = 
’cod”
.
	`¡¬t
(fœ¡, 
Ï¡
);

548 
’cod”
.
	`£t_ouut
(
r_
.
s
 +„_.
Ën
,„_. +„_.
ÿp
, 
fœ¡
);

549 ià(
’cod”
.
	`bufãr_em±y
())

550 
fœ¡
 = 
’cod”
.
	`’code
(fœ¡, 
Ï¡
);

552 
fœ¡
 = 
’cod”
.
	`æush
(fœ¡, 
Ï¡
);

553 ià(
fœ¡
 =ğ
Ï¡
)

555 
r_
.
Ën
 = 
’cod”
.
	`ouut_begš
(è-„_.
s
;

556 ià(!
kls
) {

557 
kls
 = 
r_
.
s
;

558 
r_
.
s
 = 0;

559 
	`grow
(
r_
.
Ën
 + 
Ï¡
 - 
fœ¡
);

560 
	`memıy
(
r_
.
s
, 
kls
,„_.
Ën
);

562 
	`grow
(
r_
.
Ën
 + 
Ï¡
 - 
fœ¡
);

564 ià(
kls
)

565 
d–‘e
[] 
»š‹½»t_ÿ¡
<*>(
kls
 - 
memo_¥aû
);

566 
	}
}

568 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

569 
šlše
 
	gSŒšgAccum
::
	$­³nd_’coded
(
T
 &
¡©e
,

570 cÚ¡ *
fœ¡
,

571 cÚ¡ *
Ï¡
) {

572 
	`­³nd_’coded
(
¡©e
,

573 
»š‹½»t_ÿ¡
<cÚ¡ *>(
fœ¡
),

574 
»š‹½»t_ÿ¡
<cÚ¡ *>(
Ï¡
));

575 
	}
}

577 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

578 
šlše
 
	gSŒšgAccum
::
	$­³nd_’coded
(cÚ¡ *
fœ¡
,

579 cÚ¡ *
Ï¡
) {

580 
­³nd_’coded
<
T
>(
»š‹½»t_ÿ¡
<cÚ¡ *>(
fœ¡
),

581 
»š‹½»t_ÿ¡
<cÚ¡ *>(
Ï¡
));

582 
	}
}

584 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

585 
	gSŒšgAccum
::
	$­³nd_’coded
(
T
 &
’cod”
)

587 !
’cod”
.
	`bufãr_em±y
()) {

588 
’cod”
.
	`£t_ouut
(
r_
.
s
 +„_.
Ën
,„_. +„_.
ÿp
, 0);

589 ià(
’cod”
.
	`æush_ş—r
()) {

590 
r_
.
Ën
 = 
’cod”
.
	`ouut_begš
(è-„_.
s
;

593 
	`grow
(
r_
.
Ën
 + 10);

595 
	}
}

597 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

598 
šlše
 
	gSŒšgAccum
::
	$­³nd_’coded
(cÚ¡ *
fœ¡
,

599 cÚ¡ *
Ï¡
)

601 
T
 
’cod”
;

602 
	`­³nd_’coded
(
’cod”
, 
fœ¡
, 
Ï¡
);

603 ià(!
’cod”
.
	`bufãr_em±y
())

604 
	`­³nd_’coded
(
’cod”
);

605 
	}
}

607 
	g‹m¶©e
 <
ty³Çme
 
	gI
>

608 
šlše
 
	gSŒšgAccum
::
	$­³nd_još
(cÚ¡ 
SŒšg
 &
još”
, 
I
 
fœ¡
, I 
Ï¡
) {

609 
boŞ
 
Ï‹r
 = 
çl£
;

610 
fœ¡
 !ğ
Ï¡
) {

611 ià(
Ï‹r
)

612 *
this
 << 
još”
;

613 
Ï‹r
 = 
Œue
;

614 *
this
 << *
fœ¡
;

615 ++
fœ¡
;

617 
	}
}

619 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

620 
šlše
 
	gSŒšgAccum
::
	$­³nd_još
(cÚ¡ 
SŒšg
 &
još”
, cÚ¡ 
T
 &
x
) {

621 
	`­³nd_još
(
još”
, 
x
.
	`begš
(), x.
	`’d
());

622 
	}
}

625 
šlše
 
	gSŒšgAccum
 &SŒšgAccum::
İ”©Ü
=(cÚ¡ 
SŒšgAccum
 &
x
) {

626 ià(&
x
 !ğ
this
) {

627 ià(
out_of_memÜy
())

628 
r_
.
ÿp
 = 0;

629 
	gr_
.
	gËn
 = 0;

630 
­³nd
(
x
.
d©a
(), x.
Ëngth
());

632  *
	gthis
;

635 #ià
HAVE_CXX_RVALUE_REFERENCES


637 
šlše
 
	gSŒšgAccum
 &SŒšgAccum::
İ”©Ü
=(
SŒšgAccum
 &&
x
) {

638 
x
.
sw­
(*
this
);

639  *
	gthis
;

647 
šlše
 
	gSŒšgAccum
 &
	gİ”©Ü
<<(SŒšgAccum &
	g§
, 
	gc
) {

648 
	g§
.
­³nd
(
c
);

649  
	g§
;

656 
šlše
 
	gSŒšgAccum
 &
	gİ”©Ü
<<(SŒšgAccum &
	g§
, 
	gc
) {

657 
	g§
.
­³nd
(
c
);

658  
	g§
;

665 
šlše
 
	gSŒšgAccum
 &
	gİ”©Ü
<<(SŒšgAccum &
	g§
, cÚ¡ *
	gc¡r
) {

666 
	g§
.
­³nd
(
c¡r
);

667  
	g§
;

673 
šlše
 
	gSŒšgAccum
 &
	gİ”©Ü
<<(SŒšgAccum &
	g§
, 
boŞ
 
	gx
) {

674 
	g§
.
­³nd
(
SŒšg_g’”ic
::
boŞ_d©a
 + (-
x
 & 6), 5 - x);

675  
	g§
;

681 
šlše
 
	gSŒšgAccum
 &
	gİ”©Ü
<<(SŒšgAccum &
	g§
, 
	gx
) {

682  
	g§
 << 
	g¡©ic_ÿ¡
<>(
	gx
);

686 
šlše
 
	gSŒšgAccum
 &
	gİ”©Ü
<<(SŒšgAccum &
	g§
, 
	gx
) {

687  
	g§
 << 
	g¡©ic_ÿ¡
<>(
	gx
);

691 
šlše
 
	gSŒšgAccum
 &
	gİ”©Ü
<<(SŒšgAccum &
	g§
, 
	gx
) {

692  
	g§
 << 
	g¡©ic_ÿ¡
<>(
	gx
);

696 
šlše
 
	gSŒšgAccum
 &
	gİ”©Ü
<<(SŒšgAccum &
	g§
, 
	gx
) {

697  
	g§
 << 
	g¡©ic_ÿ¡
<>(
	gx
);

703 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

704 
šlše
 
	gSŒšgAccum
 &
	gİ”©Ü
<<(SŒšgAccum &
	g§
, cÚ¡ 
	gSŒšg_ba£
<
	gT
> &
	g¡r
) {

705 
	g§
.
­³nd
(
¡r
.
d©a
(), sŒ.
Ëngth
());

706  
	g§
;

709 
šlše
 
	gSŒšgAccum
 &
	gİ”©Ü
<<(SŒšgAccum &
	g§
, cÚ¡ 
	g¡d
::
¡ršg
 &
¡r
) {

710 
§
.
­³nd
(
¡r
.
d©a
(), sŒ.
Ëngth
());

711  
	g§
;

717 
šlše
 
	gSŒšgAccum
 &
	gİ”©Ü
<<(SŒšgAccum &
	g§
, cÚ¡ SŒšgAccum &
	gx
) {

718 
	g§
.
­³nd
(
x
.
begš
(), x.
’d
());

719  
	g§
;

722 
šlše
 
boŞ
 
	gİ”©Ü
==(
SŒšgAccum
 &
§
, cÚ¡ *
	gc¡r
) {

723  
¡rcmp
(
§
.
c_¡r
(), 
c¡r
) == 0;

726 
šlše
 
boŞ
 
	gİ”©Ü
!=(
SŒšgAccum
 &
§
, cÚ¡ *
	gc¡r
) {

727  
¡rcmp
(
§
.
c_¡r
(), 
c¡r
) != 0;

730 
šlše
 
	$sw­
(
SŒšgAccum
& 
a
, SŒšgAccum& 
b
) {

731 
a
.
	`sw­
(
b
);

732 
	}
}

735 #undeà
LCDF_SNPRINTF_ATTR


	@masstree-beta/string.cc

35 
	~"¡ršg.hh
"

36 
	~"¡¿ccum.hh
"

37 
	~<¡dio.h
>

38 
	~<¡ršg.h
>

39 
	~<ùy³.h
>

40 
	~<š‰y³s.h
>

41 
	~<veùÜ
>

42 
Çme¥aû
 
	glcdf
 {

84 cÚ¡ 
	gSŒšg_g’”ic
::
em±y_d©a
[] = "";

86 cÚ¡ 
	gSŒšg_g’”ic
::
out_of_memÜy_d©a
[] = "\360\237\222\243ENOMEM\360\237\222\243";

87 cÚ¡ 
	gSŒšg_g’”ic
::
boŞ_d©a
[] = "false\0true";

88 cÚ¡ 
	gSŒšg_g’”ic
::
ba£64_’codšg_bË
[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

89 cÚ¡ 
	gSŒšg_g’”ic
::
ba£64_decodšg_m­
[] =

106 cÚ¡ 
	gSŒšg
::
št_d©a
[] = "0\0001\0002\0003\0004\0005\0006\0007\0008\0009";

108 #ià
HAVE_STRING_PROFILING
 > 1

109 
	#MEMO_INITIALIZER_TAIL
 , 0, 0

	)

111 
	#MEMO_INITIALIZER_TAIL


	)

114 cÚ¡ 
	gSŒšg
::
»p_ty³
 
SŒšg
::
nuÎ_¡ršg_»p
 = {

115 
SŒšg_g’”ic
::
em±y_d©a
, 0, 0

117 cÚ¡ 
	gSŒšg
::
»p_ty³
 
SŒšg
::
oom_¡ršg_»p
 = {

118 
SŒšg_g’”ic
::
out_of_memÜy_d©a
, SŒšg_g’”ic::
out_of_memÜy_Ëngth
, 0

120 cÚ¡ 
	gSŒšg
::
»p_ty³
 
SŒšg
::
z”o_¡ršg_»p
 = {

121 &
št_d©a
[0], 0, 0

124 #ià
HAVE_STRING_PROFILING


125 
ušt64_t
 
	gSŒšg
::
live_memo_couÁ
;

126 
ušt64_t
 
	gSŒšg
::
memo_sizes
[55];

127 
ušt64_t
 
	gSŒšg
::
live_memo_sizes
[55];

128 
ušt64_t
 
	gSŒšg
::
live_memo_by‹s
[55];

129 #ià
HAVE_STRING_PROFILING
 > 1

130 
	gSŒšg
::
memo_ty³
 *
SŒšg
::
live_memos
[55];

135 
	gSŒšg_g’”ic
::
com·»
(cÚ¡ * 
a
, 
a_Ën
, cÚ¡ * 
b
, 
b_Ën
)

137 ià(
	ga
 !ğ
b
) {

138 
Ën
 = 
a_Ën
 < 
b_Ën
 ?‡_len : b_len;

139 
	gcmp
 = 
memcmp
(
a
, 
b
, 
Ën
);

140 ià(
	gcmp
 != 0)

141  
cmp
;

143  
	ga_Ën
 - 
	gb_Ën
;

146 
	gSŒšg_g’”ic
::
Çtu¿l_com·»
(cÚ¡ * 
a
, 
a_Ën
,

147 cÚ¡ * 
b
, 
b_Ën
) {

148 cÚ¡ * 
	g«
 = 
a
 + 
a_Ën
;

149 cÚ¡ * 
	gbe
 = 
b
 + 
b_Ën
;

150 cÚ¡ * 
	g­”iod
 = 0;

151 
boŞ
 
	g­”iod_Ãg©ive
 = 
çl£
;

152 
	g¿w_com·»
 = 0;

154 
	ga
 < 
	g«
 && 
	gb
 < 
	gbe
) {

155 ià(
isdig™
((è*
a
è&& isdig™((è*
b
)) {

158 
boŞ
 
	gpÙ’tŸl_decim®
 = (
a
 =ğ
­”iod
);

162 
boŞ
 
	gÃg©ive
 = 
çl£
;

163 ià(
	ga
 > 
	g«
 - 
	ga_Ën
 &&‡[-1] == '-'

164 && (
a
 =ğ
«
 - 
a_Ën
 + 1

165 || 
is¥aû
((è
a
[-2])))

166 
Ãg©ive
 = 
Œue
;

169 cÚ¡ *
	gŸ
 = 
a
, *
	gib
 = 
b
;

170 
	ga
 < 
	g«
 && *a == '0')

171 ++
a
;

172 
	gb
 < 
	gbe
 && *b == '0')

173 ++
b
;

174 
	glÚg”_z”os
 = (
a
 - 
Ÿ
è- (
b
 - 
ib
);

177 
	gdig™_com·»
 = 0;

178 
boŞ
 
	ga_good
, 
	gb_good
;

180 
	ga_good
 = 
a
 < 
«
 && 
isdig™
(() *a);

181 
	gb_good
 = 
b
 < 
be
 && 
isdig™
(() *b);

182 ià(!
	ga_good
 || !
	gb_good
)

184 ià(
	gdig™_com·»
 == 0)

185 
dig™_com·»
 = *
a
 - *
b
;

186 ++
	ga
;

187 ++
	gb
;

192 ià(
	gpÙ’tŸl_decim®
) {

193 cÚ¡ *
	gax
 = 
a
, *
	gbx
 = 
b
;

194 
	gax
 < 
	g«
 && 
isdig™
((è*
ax
))

195 ++
	gax
;

196 
	gbx
 < 
	gbe
 && 
isdig™
((è*
bx
))

197 ++
	gbx
;

199 ià(!(
	gax
 + 1 < 
	g«
 && *ax =ğ'.' && !
is¥aû
((è
ax
[1]))

200 && !(
bx
 + 1 < 
be
 && *bx =ğ'.' && !
is¥aû
(() bx[1]))) {

201 
Ãg©ive
 = 
­”iod_Ãg©ive
;

202 ià(
	glÚg”_z”os
)

203  
	gÃg©ive
 ? 1 : -1;

204 ià(
	gdig™_com·»
)

205 
	ga_good
 = 
b_good
;

209 ià(
	ga_good
 !ğ
b_good
)

210  
Ãg©ive
 =ğ
a_good
 ? -1 : 1;

212 ià(
	gdig™_com·»
)

213  
	gÃg©ive
 =ğ(
dig™_com·»
 > 0) ? -1 : 1;

215 ià(
	glÚg”_z”os
)

216  
	glÚg”_z”os
;

218 ià(!
	g­”iod
) {

219 
	ga_good
 = 
a
 + 1 < 
«
 && *a == '.'

220 && 
isdig™
((è
a
[1]);

221 
	gb_good
 = 
b
 + 1 < 
be
 && *b == '.'

222 && 
isdig™
((è
b
[1]);

223 ià(
	ga_good
 !ğ
b_good
)

224  
Ãg©ive
 =ğ
b_good
 ? 1 : -1;

225 ià(
	ga_good
) {

226 
	g­”iod
 = 
a
 + 1;

227 
	g­”iod_Ãg©ive
 = 
Ãg©ive
;

233 } ià(
isdig™
((è*
a
))

234  
i§Íha
((è*
b
) ? -1 : 1;

235 ià(
isdig™
((è*
b
))

236  
i§Íha
((è*
a
) ? 1 : -1;

238 
	g®ow”
 = (è
tŞow”
((è*
a
);

239 
	gblow”
 = (è
tŞow”
((è*
b
);

240 ià(
	g®ow”
 !ğ
blow”
)

241  
®ow”
 - 
blow”
;

242 ià(
	g¿w_com·»
 == 0)

243 
¿w_com·»
 = (è*
a
 - (è*
b
;

244 ià(*
	ga
 != '.')

245 
­”iod
 = 0;

246 ++
	ga
;

247 ++
	gb
;

251 ià((
	g«
 - 
	ga
è!ğ(
be
 - 
b
))

252  (
«
 - 
a
è- (
be
 - 
b
);

254  
	g¿w_com·»
;

257 
hashcode_t


258 
	gSŒšg_g’”ic
::
hashcode
(cÚ¡ *
s
, 
Ën
)

260 ià(
	gËn
 <= 0)

263 
ušt32_t
 
	ghash
 = 
Ën
;

264 
	g»m
 = 
hash
 & 3;

265 cÚ¡ *
	g’d
 = 
s
 + 
Ën
 - 
»m
;

266 
ušt32_t
 
	gÏ¡16
;

268 #ià!
HAVE_INDIFFERENT_ALIGNMENT


269 ià(!(
	g»š‹½»t_ÿ¡
<
	gušŒ_t
>(
	gs
) & 1)) {

271 
	#g‘16
(
p
è(*
»š‹½»t_ÿ¡
<cÚ¡ 
ušt16_t
 *>(Õ)))

	)

272 ; 
	gs
 !ğ
’d
; s += 4) {

273 
hash
 +ğ
g‘16
(
s
);

274 
ušt32_t
 
	gtmp
 = (
g‘16
(
s
 + 2è<< 11è^ 
hash
;

275 
	ghash
 = (
hash
 << 16è^ 
tmp
;

276 
	ghash
 +ğ
hash
 >> 11;

278 ià(
	g»m
 >= 2) {

279 
Ï¡16
 = 
g‘16
(
s
);

280 
	g»m2
;

282 #undeà
g‘16


283 #ià!
HAVE_INDIFFERENT_ALIGNMENT


285 #ià!
__i386__
 && !
__x86_64__
 && !
__¬ch_um__


286 
	#g‘16
(
p
è(((èÕ)[0] << 8è+ (èÕ)[1])

	)

288 
	#g‘16
(
p
è((èÕ)[0] + ((èÕ)[1] << 8))

	)

291 ; 
	gs
 !ğ
’d
; s += 4) {

292 
hash
 +ğ
g‘16
(
s
);

293 
ušt32_t
 
	gtmp
 = (
g‘16
(
s
 + 2è<< 11è^ 
hash
;

294 
	ghash
 = (
hash
 << 16è^ 
tmp
;

295 
	ghash
 +ğ
hash
 >> 11;

297 ià(
	g»m
 >= 2) {

298 
Ï¡16
 = 
g‘16
(
s
);

299 
	g»m2
;

301 #undeà
g‘16


307 
	g»m2
:

308 ià(
»m
 == 3) {

309 
hash
 +ğ
Ï¡16
;

310 
	ghash
 ^ğ
hash
 << 16;

311 
	ghash
 ^ğ((è
s
[2]) << 18;

312 
	ghash
 +ğ
hash
 >> 11;

314 
	ghash
 +ğ
Ï¡16
;

315 
	ghash
 ^ğ
hash
 << 11;

316 
	ghash
 +ğ
hash
 >> 17;

318 } ià(
	g»m
 == 1) {

319 
hash
 +ğ(è*
s
;

320 
	ghash
 ^ğ
hash
 << 10;

321 
	ghash
 +ğ
hash
 >> 1;

325 
	ghash
 ^ğ
hash
 << 3;

326 
	ghash
 +ğ
hash
 >> 5;

327 
	ghash
 ^ğ
hash
 << 4;

328 
	ghash
 +ğ
hash
 >> 17;

329 
	ghash
 ^ğ
hash
 << 25;

330 
	ghash
 +ğ
hash
 >> 6;

332  
	ghash
;

336 
	gSŒšg_g’”ic
::
fšd_Ëá
(cÚ¡ *
s
, 
Ën
, 
¡¬t
,

337 
x
)

339 ià(
	g¡¬t
 < 0)

340 
	g¡¬t
 = 0;

341 
	gi
 = 
¡¬t
; i < 
	gËn
; ++i)

342 ià(
	gs
[
i
] =ğ
x
)

343  
i
;

348 
	gSŒšg_g’”ic
::
fšd_Ëá
(cÚ¡ *
s
, 
Ën
, 
¡¬t
,

349 cÚ¡ *
x
, 
x_Ën
)

351 ià(
	g¡¬t
 < 0)

352 
	g¡¬t
 = 0;

353 ià(
	gx_Ën
 == 0)

354  
¡¬t
 <ğ
Ën
 ? start : -1;

355 
	gmax_pos
 = 
Ën
 - 
x_Ën
;

356 
	gi
 = 
¡¬t
; i <ğ
max_pos
; ++i)

357 ià(
memcmp
(
s
 + 
i
, 
x
, 
x_Ën
) == 0)

358  
i
;

363 
	gSŒšg_g’”ic
::
fšd_right
(cÚ¡ *
s
, 
Ën
, 
¡¬t
,

364 
x
)

366 ià(
	g¡¬t
 >ğ
Ën
)

367 
¡¬t
 = 
Ën
 - 1;

368 
	gi
 = 
¡¬t
; i >= 0; --i)

369 ià(
	gs
[
i
] =ğ
x
)

370  
i
;

375 
	gSŒšg_g’”ic
::
fšd_right
(cÚ¡ *
s
, 
Ën
, 
¡¬t
,

376 cÚ¡ *
x
, 
x_Ën
)

378 ià(
	g¡¬t
 >ğ
Ën
)

379 
¡¬t
 = 
Ën
 - 
x_Ën
;

380 ià(
	gx_Ën
 == 0)

381  
¡¬t
 >= 0 ? start : -1;

382 
	gi
 = 
¡¬t
; i >= 0; --i)

383 ià(
memcmp
(
s
 + 
i
, 
x
, 
x_Ën
) == 0)

384  
i
;

388 
	gSŒšg_g’”ic
::
to_i
(cÚ¡ * 
s
, cÚ¡ * 
’ds
) {

389 
boŞ
 
	gÃg
;

390 ià(
	gs
 !ğ
’ds
 && (
s
[0] == '-' || s[0] == '+')) {

391 
Ãg
 = 
s
[0] == '-';

392 ++
	gs
;

394 
	gÃg
 = 
çl£
;

395 ià(
	gs
 =ğ
’ds
 || !
isdig™
((è*
s
))

397 
	gx
 = (è*
s
 - '0';

398 ++
	gs
; s !ğ
’ds
 && 
isdig™
((è*
s
); ++s)

399 
	gx
 = 
x
 * 10 + *
s
 - '0';

400  
	gÃg
 ? -
	gx
 : 
x
;

403 
boŞ
 
	gSŒšg_g’”ic
::
glob_m©ch
(cÚ¡ * 
sbegš
, 
¦’
,

404 cÚ¡ * 
pbegš
, 
¶’
) {

405 cÚ¡ * 
	g£nd
 = 
sbegš
 + 
¦’
;

406 cÚ¡ * 
	g³nd
 = 
pbegš
 + 
¶’
;

409 
	gpbegš
 < 
	g³nd
 && 
	gsbegš
 < 
	g£nd


410 && 
	g³nd
[-1] !ğ'*' && 
³nd
[-1] != '?' &&…end[-1] != ']'

411 && (
pbegš
 + 1 =ğ
³nd
 ||…end[-2] != '\\'))

412 ià(
³nd
[-1] =ğ
£nd
[-1])

413 --
³nd
, --
	g£nd
;

415  
	gçl£
;

417 
	g¡d
::
veùÜ
<cÚ¡ *> 
¡©e
, 
	gÃxt¡©e
;

418 
	g¡©e
.
push_back
(
pbegš
);

420 cÚ¡ * 
	gs
 = 
sbegš
; s !ğ
£nd
 && 
¡©e
.
size
(); ++s) {

421 
	gÃxt¡©e
.
ş—r
();

422 cÚ¡ ** 
	gµ
 = 
¡©e
.
d©a
();…°!ğ¡©e.d©a(è+ s‹.
size
(); ++pp)

423 ià(*
	gµ
 !ğ
³nd
) {

424 
»sw™ch
:

425 **
µ
) {

427 
Ãxt¡©e
.
push_back
(*
µ
 + 1);

430 ià(*
µ
 + 1 =ğ
³nd
)

431  
Œue
;

432 ià(
	gÃxt¡©e
.
em±y
(è||‚ext¡©e.
back
(è!ğ*
µ
)

433 
Ãxt¡©e
.
push_back
(*
µ
);

434 ++*
	gµ
;

435 
	g»sw™ch
;

437 ià(*
µ
 + 1 !ğ
³nd
)

438 ++*
µ
;

439 
	gnÜm®_ch¬
;

441 cÚ¡ *
ec
 = *
µ
 + 1;

442 
boŞ
 
	gÃg©ed
;

443 ià(
	gec
 !ğ
³nd
 && *
ec
 == '^') {

444 
Ãg©ed
 = 
Œue
;

445 ++
	gec
;

447 
	gÃg©ed
 = 
çl£
;

448 ià(
	gec
 =ğ
³nd
)

449 
nÜm®_ch¬
;

451 
boŞ
 
	gfound
 = 
çl£
;

453 ià(*++
	gec
 =ğ*
s
)

454 
found
 = 
Œue
;

455 } 
	gec
 !ğ
³nd
 && *
ec
 != ']');

456 ià(
	gec
 =ğ
³nd
)

457 
nÜm®_ch¬
;

459 ià(
	gfound
 =ğ!
Ãg©ed
)

460 
Ãxt¡©e
.
push_back
(
ec
 + 1);

463 
	gnÜm®_ch¬
:

465 ià(**
µ
 =ğ*
s
)

466 
Ãxt¡©e
.
push_back
(*
µ
 + 1);

470 
	g¡©e
.
sw­
(
Ãxt¡©e
);

473 cÚ¡ ** 
	gµ
 = 
¡©e
.
d©a
();…°!ğ¡©e.d©a(è+ s‹.
size
(); ++pp) {

474 *
	gµ
 !ğ
³nd
 && **
µ
 == '*')

475 ++*
µ
;

476 ià(*
	gµ
 =ğ
³nd
)

477  
Œue
;

479  
	gçl£
;

484 #ià
HAVE_STRING_PROFILING


485 
	gSŒšg
::
memo_ty³
::
accouÁ_Ãw
() {

486 
buck‘
 = 
´ofe_memo_size_buck‘
(
this
->
dœty
,his->
ÿ·c™y
);

487 ++
	gmemo_sizes
[
buck‘
];

488 ++
	glive_memo_sizes
[
buck‘
];

489 
	glive_memo_by‹s
[
buck‘
] +ğ
this
->
ÿ·c™y
;

490 ++
	glive_memo_couÁ
;

491 #ià
HAVE_STRING_PROFILING
 > 1

492 
	gthis
->
	gµ»v
 = &
live_memos
[
buck‘
];

493 ià((
	gthis
->
	gÃxt
 = *
this
->
µ»v
))

494 
this
->
Ãxt
->
µ»v
 = &this->next;

495 *
	gthis
->
	gµ»v
 = 
memo
;

499 
	gSŒšg
::
memo_ty³
::
accouÁ_de¡roy
() {

500 
buck‘
 = 
´ofe_memo_size_buck‘
(
this
->
dœty
,his->
ÿ·c™y
);

501 --
	glive_memo_sizes
[
buck‘
];

502 
	glive_memo_by‹s
[
buck‘
] -ğ
this
->
ÿ·c™y
;

503 --
	glive_memo_couÁ
;

504 #ià
HAVE_STRING_PROFILING
 > 1

505 ià((*
	gthis
->
	gµ»v
 = 
this
->
Ãxt
))

506 
this
->
Ãxt
->
µ»v
 =his->pprev;

511 
šlše
 
	gSŒšg
::
memo_ty³
* 
SŒšg
::
ü—‹_memo
(
ÿ·c™y
, 
dœty
) {

512 
as£¹
(
ÿ·c™y
 > 0 && c­ac™y >ğ
dœty
);

513 
memo_ty³
 *
	gmemo
 =

514 
»š‹½»t_ÿ¡
<
memo_ty³
 *>(
Ãw
 [
ÿ·c™y
 + 
MEMO_SPACE
]);

515 ià(
	gmemo
)

516 
	gmemo
->
š™Ÿlize
(
ÿ·c™y
, 
dœty
);

517  
	gmemo
;

521 
	gSŒšg
::
d–‘e_memo
(
memo_ty³
 *
memo
)

523 
as£¹
(
memo
->
ÿ·c™y
 > 0);

524 
as£¹
(
memo
->
ÿ·c™y
 >ğmemo->
dœty
);

525 
	gmemo
->
accouÁ_de¡roy
();

526 
	gd–‘e
[] 
	g»š‹½»t_ÿ¡
<*>(
	gmemo
);

530 #ià
HAVE_STRING_PROFILING


532 
	gSŒšg
::
Úe_´ofe_»pÜt
(
SŒšgAccum
 &
§
, 
i
, 
exam¶es
)

534 ià(
	gi
 <= 16)

535 
§
 << "memo_dœty_" << 
i
;

536 ià(
	gi
 < 25) {

537 
ušt32_t
 
	gs
 = (
i
 - 17) * 2 + 17;

538 
	g§
 << "memo_ÿp_" << 
	gs
 << '_' << (s + 1);

539 } ià(
	gi
 < 29) {

540 
ušt32_t
 
	gs
 = (
i
 - 25) * 8 + 33;

541 
	g§
 << "memo_ÿp_" << 
	gs
 << '_' << (s + 7);

543 
ušt32_t
 
	gs1
 = (1U << (
i
 - 23)) + 1;

544 
ušt32_t
 
	gs2
 = (
s1
 - 1) << 1;

545 
	g§
 << "memo_ÿp_" << 
	gs1
 << '_' << 
	gs2
;

547 
	g§
 << '\t' << 
	glive_memo_sizes
[
i
] << '\t' << 
	gmemo_sizes
[i] << '\t' << 
	glive_memo_by‹s
[i] << '\n';

548 ià(
	gexam¶es
) {

549 #ià
HAVE_STRING_PROFILING
 > 1

550 
memo_ty³
 *
	gm
 = 
live_memos
[
i
]; m; m = 
m
->
Ãxt
) {

551 
§
 << " [" << 
m
->
dœty
 << "] ";

552 
ušt32_t
 
	gdœty
 = 
m
->
dœty
;

553 ià(
	gdœty
 > 0 && 
	gm
->
	g»®_d©a
[
dœty
 - 1] == '\0')

554 --
dœty
;

555 
	g§
.
­³nd
(
m
->
»®_d©a
, 
dœty
 > 128 ? 128 : dirty);

556 
	g§
 << '\n';

563 
	gSŒšg
::
´ofe_»pÜt
(
SŒšgAccum
 &
§
, 
exam¶es
)

565 
ušt64_t
 
	g®l_live_sizes
 = 0, 
	g®l_sizes
 = 0, 
	g®l_live_by‹s
 = 0;

566 
	gi
 = 0; i < 55; ++i) {

567 ià(
	gmemo_sizes
[
i
])

568 
Úe_´ofe_»pÜt
(
§
, 
i
, 
exam¶es
);

569 
	g®l_live_sizes
 +ğ
live_memo_sizes
[
i
];

570 
	g®l_sizes
 +ğ
memo_sizes
[
i
];

571 
	g®l_live_by‹s
 +ğ
live_memo_by‹s
[
i
];

573 
	g§
 << "memo_tÙ®\t" << 
	g®l_live_sizes
 << '\t' << 
	g®l_sizes
 << '\t' << 
	g®l_live_by‹s
 << '\n';

581 
	gSŒšg
::
SŒšg
(
x
)

583 ià(
x
 >= 0 && x < 10)

584 
_r
.
assign
(
št_d©a
 + 2 * 
x
, 1, 0);

586 
	gbuf
[128];

587 
¥rštf
(
buf
, "%d", 
x
);

588 
assign
(
buf
, -1, 
çl£
);

593 
	gSŒšg
::
SŒšg
(
x
)

595 ià(
x
 < 10)

596 
_r
.
assign
(
št_d©a
 + 2 * 
x
, 1, 0);

598 
	gbuf
[128];

599 
¥rštf
(
buf
, "%u", 
x
);

600 
assign
(
buf
, -1, 
çl£
);

605 
	gSŒšg
::
SŒšg
(
x
)

607 ià(
x
 >= 0 && x < 10)

608 
_r
.
assign
(
št_d©a
 + 2 * 
x
, 1, 0);

610 
	gbuf
[128];

611 
¥rštf
(
buf
, "%ld", 
x
);

612 
assign
(
buf
, -1, 
çl£
);

617 
	gSŒšg
::
SŒšg
(
x
)

619 ià(
x
 < 10)

620 
_r
.
assign
(
št_d©a
 + 2 * 
x
, 1, 0);

622 
	gbuf
[128];

623 
¥rštf
(
buf
, "%lu", 
x
);

624 
assign
(
buf
, -1, 
çl£
);

629 
	gSŒšg
::
SŒšg
(
x
)

631 ià(
x
 >= 0 && x < 10)

632 
_r
.
assign
(
št_d©a
 + 2 * 
x
, 1, 0);

634 
	gbuf
[128];

635 
¥rštf
(
buf
, "%Îd", 
x
);

636 
assign
(
buf
, -1, 
çl£
);

641 
	gSŒšg
::
SŒšg
(
x
)

643 ià(
x
 < 10)

644 
_r
.
assign
(
št_d©a
 + 2 * 
x
, 1, 0);

646 
	gbuf
[128];

647 
¥rštf
(
buf
, "%Îu", 
x
);

648 
assign
(
buf
, -1, 
çl£
);

652 
	gSŒšg
::
SŒšg
(
x
)

654 
buf
[128];

655 
	gËn
 = 
¥rštf
(
buf
, "%.12g", 
x
);

656 
assign
(
buf
, 
Ën
, 
çl£
);

659 
SŒšg


660 
	gSŒšg
::
h¬d_make_¡abË
(cÚ¡ *
s
, 
Ën
)

662 ià(
	gËn
 < 0)

663 
	gËn
 = 
¡¾’
(
s
);

664  
SŒšg
(
s
, 
Ën
, 0);

667 
SŒšg


668 
	gSŒšg
::
make_fl
(
c
, 
Ën
)

670 
SŒšg
 
	gs
;

671 
	gs
.
­³nd_fl
(
c
, 
Ën
);

672  
	gs
;

676 
	gSŒšg
::
assign_out_of_memÜy
()

678 
_r
.
d”ef
();

679 
	g_r
 = 
oom_¡ršg_»p
;

683 
	gSŒšg
::
assign
(cÚ¡ *
s
, 
Ën
, 
boŞ
 
Ãed_d”ef
)

685 ià(!
	gs
) {

686 
as£¹
(
Ën
 <= 0);

687 
	gËn
 = 0;

688 } ià(
	gËn
 < 0)

689 
	gËn
 = 
¡¾’
(
s
);

692 
memo_ty³
* 
	gm
;

693 ià(
	gÃed_d”ef
) {

694 ià(
uÆik–y
((
m
 = 
_r
.
memo
())

695 && 
s
 >ğ
m
->
»®_d©a


696 && 
s
 + 
Ën
 <ğ
m
->
»®_d©a
 + m->
ÿ·c™y
)) {

698 
_r
.
assign_nÜef
(
s
, 
Ën
, 
m
);

701 
d”ef
();

704 ià(
	gËn
 == 0) {

705 
m
 = 0;

706 
	gs
 = 
SŒšg_g’”ic
::
em±y_d©a
;

710 
	gmemo_ÿ·c™y
 = (
Ën
 + 15 + 
MEMO_SPACE
) & ~15;

711 
	gm
 = 
ü—‹_memo
(
memo_ÿ·c™y
 - 
MEMO_SPACE
, 
Ën
);

712 ià(!
	gm
) {

713 
	g_r
.
»£t_»f
();

714 
assign_out_of_memÜy
();

717 
memıy
(
m
->
»®_d©a
, 
s
, 
Ën
);

718 
	gs
 = 
m
->
»®_d©a
;

721 
	g_r
.
assign_nÜef
(
s
, 
Ën
, 
m
);

730 
	gSŒšg
::
­³nd_unš™Ÿlized
(
Ën
)

733 ià(
uÆik–y
(
Ën
 <ğ0è|| 
out_of_memÜy
())

739 
ušt32_t
 
	gdœty
;

740 
memo_ty³
* 
	gm
 = 
_r
.
memo
();

741 ià(
	gm
 && ((
	gdœty
 = 
m
->
dœty
), m->
	gÿ·c™y
 > dœty + 
	gËn
)) {

742 *
	g»®_dœty
 = 
m
->
»®_d©a
 + 
dœty
;

743 ià(
	g»®_dœty
 =ğ
_r
.
d©a
 + _r.
Ëngth
) {

744 
m
->
dœty
 = dœty + 
Ën
;

745 
	g_r
.
	gËngth
 +ğ
Ën
;

746 
as£¹
(
m
->
dœty
 < m->
ÿ·c™y
);

747 #ià
HAVE_STRING_PROFILING


748 
´ofe_upd©e_memo_dœty
(
m
, 
dœty
, dœty + 
Ën
, m->
ÿ·c™y
);

750  
	g»®_dœty
;

758 
	gwªt_memo_Ën
 = 
_r
.
Ëngth
 + 
Ën
 + 
MEMO_SPACE
;

759 
	gmemo_ÿ·c™y
;

760 ià(
	gwªt_memo_Ën
 <= 1024)

761 
memo_ÿ·c™y
 = (
wªt_memo_Ën
 + 15) & ~15;

763 
	gmemo_ÿ·c™y
 = 2048; memo_ÿ·c™y < 
	gwªt_memo_Ën
; )

764 
	gmemo_ÿ·c™y
 *= 2;

766 
	gm
 = 
ü—‹_memo
(
memo_ÿ·c™y
 - 
MEMO_SPACE
, 
_r
.
Ëngth
 + 
Ën
);

767 ià(!
	gm
) {

768 
assign_out_of_memÜy
();

772 *
	gÃw_d©a
 = 
m
->
»®_d©a
;

773 
memıy
(
Ãw_d©a
, 
_r
.
d©a
, _r.
Ëngth
);

775 
d”ef
();

776 
	g_r
.
assign_nÜef
(
Ãw_d©a
, 
_r
.
Ëngth
 + 
Ën
, 
m
);

777  
	gcÚ¡_ÿ¡
<*>(
	g_r
.
	gd©a
 + _r.
	gËngth
 - 
	gËn
);

781 
	gSŒšg
::
­³nd
(cÚ¡ * 
s
, 
Ën
, 
memo_ty³
* 
memo
)

783 ià(!
	gs
) {

784 
as£¹
(
Ën
 <= 0);

785 
	gËn
 = 0;

786 } ià(
	gËn
 < 0)

787 
	gËn
 = 
¡¾’
(
s
);

789 
memo_ty³
* 
	gmy_memo
;

790 ià(
uÆik–y
(
Ën
 =ğ0è|| 
out_of_memÜy
())

792 ià(
uÆik–y
(
s
 =ğ
SŒšg_g’”ic
::
out_of_memÜy_d©a
è&& !
memo
)

795 
assign_out_of_memÜy
();

796 ià(
	g_r
.
	gËngth
 =ğ0 && 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
memo
) > 1) {

797 
d”ef
();

798 
	g_r
.
assign
(
s
, 
Ën
, 
memo
);

799 } ià(
lik–y
(!((
my_memo
 = 
_r
.
memo
())

800 && 
s
 >ğ
my_memo
->
»®_d©a


801 && 
s
 + 
Ën
 <ğ
my_memo
->
»®_d©a
 + my_memo->
ÿ·c™y
))) {

802 ià(*
¥aû
 = 
­³nd_unš™Ÿlized
(
Ën
))

803 
memıy
(
¥aû
, 
s
, 
Ën
);

805 
SŒšg
 
´e£rve_s
(*
this
);

806 ià(*
	g¥aû
 = 
­³nd_unš™Ÿlized
(
Ën
))

807 
memıy
(
¥aû
, 
s
, 
Ën
);

813 
	gSŒšg
::
­³nd_fl
(
c
, 
Ën
)

815 
as£¹
(
Ën
 >= 0);

816 ià(*
	g¥aû
 = 
­³nd_unš™Ÿlized
(
Ën
))

817 
mem£t
(
¥aû
, 
c
, 
Ën
);

823 
	gSŒšg
::
mubË_d©a
()

827 ià(!
is_sh¬ed
())

828  
cÚ¡_ÿ¡
<*>(
_r
.
d©a
);

833 
SŒšg
 
do_nÙ_d–‘e_und”lyšg_memo
(*
this
);

834 
d”ef
();

835 
assign
(
_r
.
d©a
, _r.
Ëngth
, 
çl£
);

836  
	gcÚ¡_ÿ¡
<*>(
	g_r
.
	gd©a
);

840 
	gSŒšg
::
h¬d_c_¡r
() const

847 cÚ¡ *
’d_d©a
 = 
_r
.
d©a
 + _r.
Ëngth
;

848 
memo_ty³
* 
	gm
 = 
_r
.
memo
();

849 ià((
	gm
 && 
	g’d_d©a
 >ğ
m
->
»®_d©a
 + m->
dœty
)

850 || *
’d_d©a
 != '\0') {

851 ià(*
x
 = 
cÚ¡_ÿ¡
<
SŒšg
 *>(
this
)->
­³nd_unš™Ÿlized
(1)) {

852 *
x
 = '\0';

853 --
	g_r
.
	gËngth
;

856  
	g_r
.
	gd©a
;

863 
	gSŒšg
::
mubË_c_¡r
()

865 (è
mubË_d©a
();

866 (è
c_¡r
();

867  
	gcÚ¡_ÿ¡
<*>(
	g_r
.
	gd©a
);

884 
SŒšg


885 
	gSŒšg
::
sub¡r
(
pos
, 
Ën
) const

887 ià(
	gpos
 < 0)

888 
	gpos
 +ğ
_r
.
Ëngth
;

890 
	gpos2
;

891 ià(
	gËn
 < 0)

892 
	gpos2
 = 
_r
.
Ëngth
 + 
Ën
;

893 ià(
	gpos
 >ğ0 && 
Ën
 >ğ
_r
.
Ëngth
)

894 
pos2
 = 
_r
.
Ëngth
;

896 
	gpos2
 = 
pos
 + 
Ën
;

898 ià(
	gpos
 < 0)

899 
	gpos
 = 0;

900 ià(
	gpos2
 > 
	g_r
.
	gËngth
)

901 
	gpos2
 = 
_r
.
Ëngth
;

903 ià(
	gpos
 >ğ
pos2
)

904  
SŒšg
();

906 
	g_r
.
»f
();

907  
SŒšg
(
_r
.
d©a
 + 
pos
, 
pos2
 -…os, _r.
memo
());

911 
SŒšg


912 
h¬d_low”
(cÚ¡ 
SŒšg
 &
s
, 
pos
)

914 
SŒšg
 
Ãw_s
(
s
.
d©a
(), s.
Ëngth
());

915 *
	gx
 = 
cÚ¡_ÿ¡
<*>(
Ãw_s
.
d©a
());

916 
	gËn
 = 
s
.
Ëngth
();

917 ; 
	gpos
 < 
	gËn
;…os++)

918 
	gx
[
pos
] = 
tŞow”
((è
x
[pos]);

919  
	gÃw_s
;

926 
SŒšg


927 
	gSŒšg
::
low”
() const

930 ià(!
out_of_memÜy
())

931 
i
 = 0; 
	gi
 < 
	g_r
.
	gËngth
; i++)

932 ià(
	g_r
.
	gd©a
[
i
] >ğ'A' && 
_r
.
d©a
[i] <= 'Z')

933  
h¬d_low”
(*
this
, 
i
);

934  *
	gthis
;

937 
SŒšg


938 
h¬d_uµ”
(cÚ¡ 
SŒšg
 &
s
, 
pos
)

940 
SŒšg
 
Ãw_s
(
s
.
d©a
(), s.
Ëngth
());

941 *
	gx
 = 
cÚ¡_ÿ¡
<*>(
Ãw_s
.
d©a
());

942 
	gËn
 = 
s
.
Ëngth
();

943 ; 
	gpos
 < 
	gËn
;…os++)

944 
	gx
[
pos
] = 
touµ”
((è
x
[pos]);

945  
	gÃw_s
;

952 
SŒšg


953 
	gSŒšg
::
uµ”
() const

956 
i
 = 0; 
	gi
 < 
	g_r
.
	gËngth
; i++)

957 ià(
	g_r
.
	gd©a
[
i
] >ğ'a' && 
_r
.
d©a
[i] <= 'z')

958  
h¬d_uµ”
(*
this
, 
i
);

959  *
	gthis
;

962 
SŒšg


963 
h¬d_´šbË
(cÚ¡ 
SŒšg
 &
s
, 
pos
, 
ty³
)

965 
SŒšgAccum
 
§
(
s
.
Ëngth
() * 2);

966 
	g§
.
­³nd
(
s
.
d©a
(), 
pos
);

967 cÚ¡ *
	gx
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
.
d©a
());

968 
	gËn
 = 
s
.
Ëngth
();

969 ; 
	gpos
 < 
	gËn
;…os++) {

970 ià(
	gty³
 =ğ2 && (
x
[
pos
] == '\\' || x[pos] == '\"'))

971 
§
 << '\\' << 
x
[
pos
];

972 ià(
	gx
[
pos
] >ğ32 && 
x
[pos] < 127)

973 
§
 << 
x
[
pos
];

974 ià(
	gx
[
pos
] < 32 && 
	gty³
 == 2) {

975 ià(
x
[
pos
] >= 9 && x[pos] <= 13)

976 
§
 << '\\' << ("Švä"[
x
[
pos
] - 9]);

977 ià(*
	gbuf
 = 
§
.
ex‹nd
(4, 1))

978 
¥rštf
(
buf
, "\\%03o", 
x
[
pos
]);

979 } ià(
	gx
[
pos
] < 32 && 
	gty³
 != 1)

980 
§
 << '^' << ()(
x
[
pos
] + 64);

981 ià(*
	gbuf
 = 
§
.
ex‹nd
(4, 1))

982 
¥rštf
(
buf
, "\\%03o", 
x
[
pos
]);

984  
	g§
.
ke_¡ršg
();

995 
SŒšg


996 
	gSŒšg
::
´šbË
(
ty³
) const

999 ià(!
out_of_memÜy
())

1000 
i
 = 0; 
	gi
 < 
	g_r
.
	gËngth
; i++)

1001 ià(
	g_r
.
	gd©a
[
i
] < 32 || _r.data[i] > 126)

1002  
h¬d_´šbË
(*
this
, 
i
, 
ty³
);

1003  *
	gthis
;

1006 
SŒšg
 
	gSŒšg
::
to_hex
() const {

1007 
SŒšgAccum
 
§
;

1008 cÚ¡ 
	ghexv®
[] = "0123456789ABCDEF";

1009 * 
	gx
 = 
§
.
ex‹nd
(2 * 
_r
.
Ëngth
);

1010 
	gi
 = 0; i !ğ
_r
.
Ëngth
; ++i) {

1011 *
	gx
++ = 
hexv®
[(è
_r
.
d©a
[
i
] >> 4];

1012 *
	gx
++ = 
hexv®
[
_r
.
d©a
[
i
] & 15];

1014  
	g§
.
ke_¡ršg
();

1018 
SŒšg


1019 
	gSŒšg
::
Érim
() const

1021  
SŒšg_g’”ic
::
Érim
(*
this
);

1025 
SŒšg


1026 
	gSŒšg
::
¹rim
() const

1028  
SŒšg_g’”ic
::
¹rim
(*
this
);

1032 
SŒšg


1033 
	gSŒšg
::
Œim
() const

1035  
SŒšg_g’”ic
::
Œim
(*
this
);

1039 
	gSŒšg
::
®ign
(
n
)

1041 
off£t
 = 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
_r
.
d©a
è% 
n
;

1042 ià(
	goff£t
) {

1043 
SŒšg
 
	gs
;

1044 
	gs
.
­³nd_unš™Ÿlized
(
_r
.
Ëngth
 + 
n
 + 1);

1045 
	goff£t
 = 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
s
.
_r
.
d©a
è% 
n
;

1046 
memıy
((*)
s
.
_r
.
d©a
 + 
n
 - 
off£t
, _r.d©a, _r.
Ëngth
);

1047 
	gs
.
	g_r
.
	gd©a
 +ğ
n
 - 
off£t
;

1048 
	gs
.
	g_r
.
	gËngth
 = 
_r
.
Ëngth
;

1049 *
	gthis
 = 
s
;

1055 
	gSŒšg
::
sk_utf8_ch¬
(cÚ¡ *
s
, cÚ¡ *
’d
)

1057 
	gc
 = *
s
;

1058 ià(
	gc
 > 0 && c < 0x80)

1059  
	gs
 + 1;

1060 ià(
	gc
 < 0xC2)

1062 ià(
	gc
 < 0xE0) {

1063 ià(
lik–y
(
s
 + 1 < 
’d


1064 && 
s
[1] >= 0x80 && s[1] < 0xC0))

1065  
s
 + 2;

1066 } ià(
	gc
 < 0xF0) {

1067 ià(
lik–y
(
s
 + 2 < 
’d


1068 && 
s
[1] >= 0x80 && s[1] < 0xC0

1069 && 
s
[2] >= 0x80 && s[2] < 0xC0

1070 && (
c
 !ğ0xE0 || 
s
[1] >= 0xA0)

1071 && (
c
 !ğ0xED || 
s
[1] < 0xA0) ))

1072  
s
 + 3;

1073 } ià(
	gc
 < 0xF5) {

1074 ià(
lik–y
(
s
 + 3 < 
’d


1075 && 
s
[1] >= 0x80 && s[1] < 0xC0

1076 && 
s
[2] >= 0x80 && s[2] < 0xC0

1077 && 
s
[3] >= 0x80 && s[3] < 0xC0

1078 && (
c
 !ğ0xF0 || 
s
[1] >= 0x90)

1079 && (
c
 !ğ0xF4 || 
s
[1] < 0x90) ))

1080  
s
 + 4;

1082  
	gs
;

1086 
	gSŒšg
::
·r£_ûsu8_ch¬
(cÚ¡ *
s
, cÚ¡ *
’d
)

1088 ià(
	gs
 + 5 < 
	g’d


1089 && 
	gs
[0] == 0xED

1090 && 
s
[1] >= 0xA0 && s[1] < 0xB0

1091 && 
s
[2] >= 0x80 && s[2] < 0xC0

1092 && 
s
[3] == 0xED

1093 && 
s
[4] >= 0xB0 && s[4] < 0xC0

1094 && 
s
[5] >= 0x80 && s[5] < 0xC0)

1096 + ((
s
[1] & 0x0F) << 16) + ((s[2] & 0x3F) << 10)

1097 + ((
s
[4] & 0x0F) << 6) + (s[5] & 0x3F);

1102 cÚ¡ 
ušt16_t
 
	gwšdows1252_c1_m­pšg
[] = {

1109 
SŒšg


1110 
	gSŒšg
::
wšdows1252_to_utf8
() const

1112 cÚ¡ *
s
 = 
ubegš
(), *
	gÏ¡
 = s, *
	g’ds
 = 
u’d
();

1113 
SŒšgAccum
 
	g§
;

1114 ; 
	gs
 !ğ
’ds
; ++s) {

1115 
	gc
 = *
s
;

1116 ià(
uÆik–y
(
c
 == 0)) {

1117 
§
.
­³nd
(
Ï¡
, 
s
);

1118 
	gÏ¡
 = 
s
 + 1;

1119 } ià(
lik–y
(
c
 < 128))

1122 
	g§
.
­³nd
(
Ï¡
, 
s
);

1123 ià(
uÆik–y
(
c
 < 160))

1124 
	gc
 = 
wšdows1252_c1_m­pšg
[
c
 - 128];

1125 
	g§
.
­³nd_utf8
(
c
);

1126 
	gÏ¡
 = 
s
 + 1;

1129 ià(
	gÏ¡
 =ğ
ubegš
())

1130  *
this
;

1132 
	g§
.
­³nd
(
Ï¡
, 
s
);

1133  
	g§
.
ke_¡ršg
();

1137 
SŒšg


1138 
	gSŒšg
::
utf16be_to_utf8
(
æags
) const

1140 cÚ¡ *
s
 = 
ubegš
(), *
	g’ds
 = 
u’d
();

1141 ià((
	g’ds
 - 
	gs
) & 1)

1142 --
	g’ds
;

1143 ià((
	gæags
 & 
	gutf_¡r_bom
è&& 
	gs
 !ğ
’ds


1144 && 
s
[0] == 0xFE && s[1] == 0xFF)

1145 
s
 += 2;

1146 
SŒšgAccum
 
	g§
;

1147 
	g§
.
»£rve
((
’ds
 - 
s
) / 2);

1148 ; 
	gs
 !ğ
’ds
; s += 2) {

1149 
c
 = 
s
[0] * 256 + s[1];

1150 ià(
lik–y
(
c
 < 0xD800è|| 
	gc
 >= 0xE000)

1151 
§
.
­³nd_utf8
(
c
);

1152 ià(
	gc
 < 0xDC00 && 
	gs
 + 2 !ğ
’ds


1153 && 
s
[2] >= 0xDC && s[2] < 0xE0) {

1154 
c
 = 0x10000 + ((c - 0xD800) << 10)

1155 + ((
s
[2] & 0x03) << 8) + s[3];

1156 
	g§
.
­³nd_utf8
(
c
);

1157 
	gs
 += 2;

1158 } ià(
	gc
 && (
	gæags
 & 
	gutf_»¶aûm’t
))

1159 
	g§
.
­³nd_utf8
(
u_»¶aûm’t
);

1161  
	g§
.
ke_¡ršg
();

1164 
SŒšg


1165 
	gSŒšg
::
utf16Ë_to_utf8
(
æags
) const

1167 cÚ¡ *
s
 = 
ubegš
(), *
	g’ds
 = 
u’d
();

1168 ià((
	g’ds
 - 
	gs
) & 1)

1169 --
	g’ds
;

1170 ià((
	gæags
 & 
	gutf_¡r_bom
è&& 
	gs
 !ğ
’ds


1171 && 
s
[1] == 0xFE && s[0] == 0xFF)

1172 
s
 += 2;

1173 
SŒšgAccum
 
	g§
;

1174 
	g§
.
»£rve
((
’ds
 - 
s
) / 2);

1175 ; 
	gs
 !ğ
’ds
; s += 2) {

1176 
c
 = 
s
[1] * 256 + s[0];

1177 ià(
lik–y
(
c
 < 0xD800è|| 
	gc
 >= 0xE000)

1178 
§
.
­³nd_utf8
(
c
);

1179 ià(
	gc
 < 0xDC00 && 
	gs
 + 2 !ğ
’ds


1180 && 
s
[3] >= 0xDC && s[3] < 0xE0) {

1181 
c
 = 0x10000 + ((c - 0xD800) << 10)

1182 + ((
s
[3] & 0x03) << 8) + s[2];

1183 
	g§
.
­³nd_utf8
(
c
);

1184 
	gs
 += 2;

1185 } ià(
	gc
 && (
	gæags
 & 
	gutf_»¶aûm’t
))

1186 
	g§
.
­³nd_utf8
(
u_»¶aûm’t
);

1188  
	g§
.
ke_¡ršg
();

1191 
SŒšg


1192 
	gSŒšg
::
utf16_to_utf8
(
æags
) const

1194 ià(
Ëngth
() < 2)

1195  
SŒšg
();

1196 cÚ¡ *
	gs
 = 
ubegš
(), *
	g’ds
 = 
u’d
();

1197 ià(
	g’ds
 - 
	gs
 < 2)

1198  
SŒšg
();

1199 
	gc
 = 
s
[0] * 256 + s[1];

1200 ià(
	gc
 =ğ0xFEFF || (
c
 !ğ0xFFFE && !(
æags
 & 
utf_´eãr_Ë
)))

1201  
utf16be_to_utf8
(
æags
);

1203  
utf16Ë_to_utf8
(
æags
);

1206 
SŒšg


1207 
	gSŒšg
::
ûsu8_to_utf8
(
æags
) const

1209 cÚ¡ *
s
 = 
ubegš
(), *
	gÏ¡
 = s, *
	gt
, *
	g’ds
 = 
u’d
();

1210 
SŒšgAccum
 
	g§
;

1211 ià(
	gæags
 & 
	gutf_¡r_bom
)

1212 
	gs
 = 
Ï¡
 = 
sk_utf8_bom
(
s
, 
’ds
);

1213 
	gs
 !ğ
’ds
) {

1214 
c
 = 
s
[0];

1215 ià(
lik–y
(
c
 > 0 && c < 0x7F))

1216 ++
	gs
;

1217 ià(
lik–y
((
t
 = 
sk_utf8_ch¬
(
s
, 
’ds
)) != s))

1218 
s
 = 
t
;

1219 ià((
	gc
 = 
·r£_ûsu8_ch¬
(
s
, 
’ds
))) {

1220 
	g§
.
­³nd
(
Ï¡
, 
s
);

1221 
	g§
.
­³nd_utf8
(
c
);

1222 
	gs
 += 6;

1223 
	gÏ¡
 = 
s
;

1225 
	g§
.
­³nd
(
Ï¡
, 
s
);

1226 ià((
	gæags
 & 
	gutf_»¶aûm’t
è&& 
	gc
 != 0)

1227 
§
.
­³nd_utf8
(
u_»¶aûm’t
);

1228 ++
	gs
; s !ğ
’ds
 && *
s
 >= 0x80 && *s < 0xC0; ++s)

1230 
	gÏ¡
 = 
s
;

1233 ià(
	gÏ¡
 =ğ
ubegš
())

1234  *
this
;

1236 
	g§
.
­³nd
(
Ï¡
, 
s
);

1237  
	g§
.
ke_¡ršg
();

1241 
SŒšg


1242 
	gSŒšg
::
utf8_to_utf8
(
æags
) const

1244 cÚ¡ *
s
 = 
ubegš
(), *
	gÏ¡
 = s, *
	gt
, *
	g’ds
 = 
u’d
();

1245 
SŒšgAccum
 
	g§
;

1246 ià(
	gæags
 & 
	gutf_¡r_bom
)

1247 
	gs
 = 
Ï¡
 = 
sk_utf8_bom
(
s
, 
’ds
);

1248 
	gs
 !ğ
’ds
) {

1249 
c
 = 
s
[0];

1250 ià(
lik–y
(
c
 > 0 && c < 0x7F))

1251 ++
	gs
;

1252 ià(
lik–y
((
t
 = 
sk_utf8_ch¬
(
s
, 
’ds
)) != s))

1253 
s
 = 
t
;

1255 
	g§
.
­³nd
(
Ï¡
, 
s
);

1256 ià((
	gæags
 & 
	gutf_»¶aûm’t
è&& 
	gc
 != 0)

1257 
§
.
­³nd_utf8
(
u_»¶aûm’t
);

1258 ++
	gs
; s !ğ
’ds
 && *
s
 >= 0x80 && *s < 0xC0; ++s)

1260 
	gÏ¡
 = 
s
;

1263 ià(
	gÏ¡
 =ğ
ubegš
())

1264  *
this
;

1266 
	g§
.
­³nd
(
Ï¡
, 
s
);

1267  
	g§
.
ke_¡ršg
();

1276 
SŒšg


1277 
	gSŒšg
::
to_utf8
(
æags
) const

1279 cÚ¡ *
s
 = 
ubegš
(), *
	g’ds
 = 
u’d
();

1280 ià(
	g’ds
 - 
	gs
 > 2) {

1281 ià((
	gs
[0] =ğ0xFF && 
s
[1] == 0xFE)

1282 || (
s
[0] > 0 && s[0] < 0x80 && s[1] == 0))

1283  
utf16Ë_to_utf8
(
æags
);

1284 ià((
	gs
[0] =ğ0xFE && 
s
[1] == 0xFF)

1285 || (
s
[0] == 0 && s[1] > 0 && s[1] < 0x80))

1286  
utf16be_to_utf8
(
æags
);

1289 cÚ¡ *
	gÏ¡
 = 
s
, *
	gt
;

1290 ià(
	g’ds
 - 
	gs
 > 3 && (
	gæags
 & 
	gutf_¡r_bom
))

1291 
	gs
 = 
Ï¡
 = 
sk_utf8_bom
(
s
, 
’ds
);

1292 
SŒšgAccum
 
	g§
;

1293 
boŞ
 
	gªy_lÚg_utf8
 = 
çl£
;

1294 
	gc
;

1295 
	gs
 !ğ
’ds
) {

1296 ià(
lik–y
(*
s
 > 0 && *s < 128))

1297 ++
s
;

1298 ià(
lik–y
((
t
 = 
sk_utf8_ch¬
(
s
, 
’ds
)) != s)) {

1299 
ªy_lÚg_utf8
 = 
Œue
;

1300 
	gs
 = 
t
;

1301 } ià((
	gc
 = 
·r£_ûsu8_ch¬
(
s
, 
’ds
)) != 0) {

1302 
ªy_lÚg_utf8
 = 
Œue
;

1303 
	g§
.
­³nd
(
Ï¡
, 
s
);

1304 
	g§
.
­³nd_utf8
(
c
);

1305 
	gs
 += 6;

1306 
	gÏ¡
 = 
s
;

1307 } ià(*
	gs
 == 0) {

1308 
§
.
­³nd
(
Ï¡
, 
s
);

1309 ++
	gs
;

1310 
	gÏ¡
 = 
s
;

1311 } ià(!
	gªy_lÚg_utf8
)

1312 
	gwšdows1252
;

1314 
	g§
.
­³nd
(
Ï¡
, 
s
);

1315 
	gc
 = *
s
;

1316 ià(
	gc
 < 160)

1317 
	gc
 = 
wšdows1252_c1_m­pšg
[
c
 - 128];

1318 
	g§
.
­³nd_utf8
(
c
);

1319 ++
	gs
;

1320 
	gÏ¡
 = 
s
;

1324 
	gex™
:

1325 ià(
Ï¡
 =ğ
ubegš
())

1326  *
this
;

1328 
	g§
.
­³nd
(
Ï¡
, 
’ds
);

1329  
	g§
.
ke_¡ršg
();

1332 
	gwšdows1252
:

1333 
s
 !ğ
’ds
) {

1334 ià(
lik–y
(*
s
 > 0 && *s < 128))

1335 ++
s
;

1337 
	g§
.
­³nd
(
Ï¡
, 
s
);

1338 ià(*
	gs
 != 0) {

1339 
c
 = *
s
;

1340 ià(
	gc
 < 160)

1341 
	gc
 = 
wšdows1252_c1_m­pšg
[
c
 - 128];

1342 
	g§
.
­³nd_utf8
(
c
);

1344 ++
	gs
;

1345 
	gÏ¡
 = 
s
;

1348 
	gex™
;

1357 
SŒšg
 
	gSŒšg
::
’code_jsÚ
() const {

1358 
SŒšgAccum
 
§
;

1359 cÚ¡ * 
	gÏ¡
 = 
’code_jsÚ_·¹Ÿl
(
§
);

1360 ià(
	gÏ¡
 =ğ
begš
())

1361  *
this
;

1363 
	g§
.
­³nd
(
Ï¡
, 
’d
());

1364  
	g§
.
ke_¡ršg
();

1368 
SŒšg
 
	gSŒšg
::
’code_ba£64
(
boŞ
 
·d
) const {

1369 
SŒšgAccum
 
§
;

1370 
’code_ba£64
(
§
, 
·d
);

1371  
	g§
.
ke_¡ršg
();

1374 
SŒšg
 
	gSŒšg
::
decode_ba£64
() const {

1375 
SŒšgAccum
 
§
;

1376 ià(!
decode_ba£64
(
§
))

1377  
SŒšg
();

1378  
	g§
.
ke_¡ršg
();

1381 
SŒšg
 
	gSŒšg
::
’code_uri_compÚ’t
() const {

1382 
SŒšgAccum
 
§
;

1383 
’code_uri_compÚ’t
(
§
);

1384  
	g§
.
ke_¡ršg
();

	@masstree-beta/string.hh

16 #iâdeà
LCDF_STRING_HH


17 
	#LCDF_STRING_HH


	)

18 
	~"¡ršg_ba£.hh
"

19 
	~<¡ršg
>

20 
	~<ut™y
>

21 
Çme¥aû
 
	glcdf
 {

23 
şass
 
	gSŒšg
 : 
public
 
SŒšg_ba£
<
SŒšg
> {

24 
memo_ty³
;

25 
	gpublic
:

26 
»p_ty³
;

28 ’um { 
	gmax_Ëngth
 = 0x7FFFFFE0 };

30 
SŒšg
 
	tsub¡ršg_ty³
;

31 cÚ¡ 
	tSŒšg
& 
	t¬gum’t_ty³
;

33 
šlše
 
SŒšg
();

34 
šlše
 
SŒšg
(cÚ¡ SŒšg &
x
);

35 #ià
HAVE_CXX_RVALUE_REFERENCES


36 
šlše
 
SŒšg
(SŒšg &&
x
);

38 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

39 
ex¶ic™
 
šlše
 
SŒšg
(cÚ¡ 
SŒšg_ba£
<
T
>& 
¡r
);

40 
šlše
 
SŒšg
(cÚ¡ * 
c¡r
);

41 
šlše
 
SŒšg
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
);

42 
šlše
 
SŒšg
(cÚ¡ * 
s
, 
Ën
);

43 
šlše
 
SŒšg
(cÚ¡ * 
s
, 
Ën
);

44 
šlše
 
SŒšg
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

45 
šlše
 
SŒšg
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

46 
ex¶ic™
 
šlše
 
SŒšg
(
boŞ
 
x
);

47 
ex¶ic™
 
šlše
 
SŒšg
(
c
);

48 
ex¶ic™
 
šlše
 
SŒšg
(
c
);

49 
ex¶ic™
 
SŒšg
(
x
);

50 
ex¶ic™
 
SŒšg
(
x
);

51 
ex¶ic™
 
SŒšg
(
x
);

52 
ex¶ic™
 
SŒšg
(
x
);

53 
ex¶ic™
 
SŒšg
(
x
);

54 
ex¶ic™
 
SŒšg
(
x
);

55 
ex¶ic™
 
SŒšg
(
x
);

57 
šlše
 
SŒšg
(cÚ¡ 
»p_ty³
& 
r
);

59 
	gšlše
 ~
SŒšg
();

61 
šlše
 cÚ¡ 
	gSŒšg
& 
make_em±y
();

62 
šlše
 cÚ¡ 
	gSŒšg
& 
make_out_of_memÜy
();

63 
SŒšg
 
make_unš™Ÿlized
(
Ën
);

64 
šlše
 
SŒšg
 
make_¡abË
(cÚ¡ * 
c¡r
);

65 
šlše
 
SŒšg
 
make_¡abË
(cÚ¡ * 
s
, 
Ën
);

66 
šlše
 
SŒšg
 
make_¡abË
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

67 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

68 
šlše
 
SŒšg
 
make_¡abË
(cÚ¡ 
SŒšg_ba£
<
T
>& 
¡r
);

69 
SŒšg
 
make_fl
(
c
, 
n
);

70 
šlše
 cÚ¡ 
	gSŒšg
& 
make_z”o
();

72 
šlše
 cÚ¡ * 
d©a
() const;

73 
šlše
 
Ëngth
() const;

75 
šlše
 cÚ¡ *
c_¡r
() const;

77 
šlše
 
SŒšg
 
sub¡ršg
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
) const;

78 
šlše
 
SŒšg
 
sub¡ršg
(cÚ¡ * 
fœ¡
,

79 cÚ¡ * 
Ï¡
) const;

80 
šlše
 
SŒšg
 
ç¡_sub¡ršg
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
) const;

81 
šlše
 
SŒšg
 
ç¡_sub¡ršg
(cÚ¡ * 
fœ¡
,

82 cÚ¡ * 
Ï¡
) const;

83 
SŒšg
 
sub¡r
(
pos
, 
Ën
) const;

84 
šlše
 
SŒšg
 
sub¡r
(
pos
) const;

85 
SŒšg
 
Érim
() const;

86 
SŒšg
 
¹rim
() const;

87 
SŒšg
 
Œim
() const;

89 
SŒšg
 
low”
() const;

90 
SŒšg
 
uµ”
() const;

91 
SŒšg
 
´šbË
(
ty³
 = 0) const;

92 
SŒšg
 
to_hex
() const;

95 
	gutf_¡r_bom
 = 1,

96 
	gutf_»¶aûm’t
 = 2,

97 
	gutf_´eãr_Ë
 = 4

101 
	gu_»¶aûm’t
 = 0xFFFD

104 
SŒšg
 
wšdows1252_to_utf8
() const;

105 
SŒšg
 
utf16be_to_utf8
(
æags
 = 0) const;

106 
SŒšg
 
utf16Ë_to_utf8
(
æags
 = 0) const;

107 
SŒšg
 
utf16_to_utf8
(
æags
 = 0) const;

108 
SŒšg
 
ûsu8_to_utf8
(
æags
 = 0) const;

109 
SŒšg
 
utf8_to_utf8
(
æags
 = 0) const;

110 
SŒšg
 
to_utf8
(
æags
 = 0) const;

112 
usšg
 
	gSŒšg_ba£
<
	gSŒšg
>::
’code_jsÚ
;

113 
SŒšg
 
’code_jsÚ
() const;

115 
usšg
 
	gSŒšg_ba£
<
	gSŒšg
>::
’code_ba£64
;

116 
SŒšg
 
’code_ba£64
(
boŞ
 
·d
 = 
çl£
) const;

117 
usšg
 
	gSŒšg_ba£
<
	gSŒšg
>::
decode_ba£64
;

118 
SŒšg
 
decode_ba£64
() const;

120 
usšg
 
	gSŒšg_ba£
<
	gSŒšg
>::
’code_uri_compÚ’t
;

121 
SŒšg
 
’code_uri_compÚ’t
() const;

123 
šlše
 
	gSŒšg
& 
	gİ”©Ü
=(cÚ¡ 
SŒšg
& 
x
);

124 #ià
HAVE_CXX_RVALUE_REFERENCES


125 
šlše
 
	gSŒšg
& 
	gİ”©Ü
=(
SŒšg
&& 
x
);

127 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

128 
šlše
 
	gSŒšg
& 
	gİ”©Ü
=(cÚ¡ 
SŒšg_ba£
<
T
>& 
¡r
);

129 
šlše
 
	gSŒšg
& 
	gİ”©Ü
=(cÚ¡ * 
c¡r
);

130 
šlše
 
	gSŒšg
& 
	gİ”©Ü
=(cÚ¡ 
¡d
::
¡ršg
& 
¡r
);

132 
šlše
 
assign
(cÚ¡ 
SŒšg
& 
x
);

133 #ià
HAVE_CXX_RVALUE_REFERENCES


134 
šlše
 
assign
(
SŒšg
&& 
x
);

136 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

137 
šlše
 
assign
(cÚ¡ 
SŒšg_ba£
<
T
>& 
¡r
);

138 
šlše
 
assign
(cÚ¡ * 
c¡r
);

139 
šlše
 
assign
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
);

140 
šlše
 
assign
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

142 
šlše
 
sw­
(
SŒšg
& 
x
);

144 
šlše
 
­³nd
(cÚ¡ 
SŒšg
& 
x
);

145 
šlše
 
­³nd
(cÚ¡ * 
c¡r
);

146 
šlše
 
­³nd
(cÚ¡ * 
s
, 
Ën
);

147 
šlše
 
­³nd
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

148 
šlše
 
­³nd
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

149 
­³nd_fl
(
c
, 
Ën
);

150 *
­³nd_unš™Ÿlized
(
Ën
);

152 
šlše
 
	gSŒšg
& 
	gİ”©Ü
+=(cÚ¡ 
SŒšg
& 
x
);

153 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

154 
šlše
 
	gSŒšg
& 
	gİ”©Ü
+=(cÚ¡ 
SŒšg_ba£
<
T
>& 
x
);

155 
šlše
 
	gSŒšg
& 
	gİ”©Ü
+=(cÚ¡ * 
c¡r
);

156 
šlše
 
	gSŒšg
& 
	gİ”©Ü
+=(
c
);

162 
šlše
 
boŞ
 
is_sh¬ed
() const;

163 
šlše
 
boŞ
 
is_¡abË
() const;

165 
šlše
 
SŒšg
 
unique
() const;

166 
šlše
 
shršk_to_f™
();

168 * 
mubË_d©a
();

169 
šlše
 * 
mubË_ud©a
();

170 * 
mubË_c_¡r
();

172 
®ign
();

174 cÚ¡ * 
sk_utf8_ch¬
(cÚ¡ * 
fœ¡
,

175 cÚ¡ * 
Ï¡
);

176 cÚ¡ * 
sk_utf8_ch¬
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

177 cÚ¡ * 
sk_utf8_bom
(cÚ¡ * 
fœ¡
,

178 cÚ¡ * 
Ï¡
);

179 cÚ¡ * 
sk_utf8_bom
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

182 
	s»p_ty³
 {

183 cÚ¡ * 
	gd©a
;

184 
	gËngth
;

185 
	gmemo_off£t
;

187 
šlše
 
»f
() const {

188 ià(
	gmemo_off£t
)

189 ++
xmemo
()->
	g»fcouÁ
;

191 
šlše
 
d”ef
() const {

192 ià(
	gmemo_off£t
 && --
xmemo
()->
	g»fcouÁ
 == 0)

193 
SŒšg
::
d–‘e_memo
(
xmemo
());

195 
šlše
 
»£t_»f
() {

196 
	gmemo_off£t
 = 0;

199 
	g´iv©e
:

200 
šlše
 
memo_ty³
* 
xmemo
() const {

201  
»š‹½»t_ÿ¡
<
memo_ty³
*>

202 (
cÚ¡_ÿ¡
<*>(
d©a
 + 
memo_off£t
));

204 
šlše
 
memo_ty³
* 
memo
() const {

205  
	gmemo_off£t
 ? 
xmemo
(è: 
nuÎ±r
;

207 
šlše
 
assign
(cÚ¡ * 
d
, 
l
, 
memo_ty³
* 
m
) {

208 
	gd©a
 = 
d
;

209 
	gËngth
 = 
l
;

210 ià(
	gm
) {

211 ++
	gm
->
	g»fcouÁ
;

212 
	gmemo_off£t
 = 
¡©ic_ÿ¡
<>(
»š‹½»t_ÿ¡
<*>(
m
è- 
d
);

214 
	gmemo_off£t
 = 0;

216 
šlše
 
assign_nÜef
(cÚ¡ * 
d
, 
l
, 
memo_ty³
* 
m
) {

217 
	gd©a
 = 
d
;

218 
	gËngth
 = 
l
;

219 ià(
	gm
)

220 
	gmemo_off£t
 = 
¡©ic_ÿ¡
<>(
»š‹½»t_ÿ¡
<*>(
m
è- 
d
);

222 
	gmemo_off£t
 = 0;

224 
ä›nd
 
şass
 
	gSŒšg
;

225 
ä›nd
 
şass
 
	gSŒšgAccum
;

228 cÚ¡ 
	g»p_ty³
& 
š‹º®_»p
() const {

229  
	g_r
;

231 
sw­
(
»p_ty³
& 
Ùh”_»p
) {

232 
usšg
 
	g¡d
::
sw­
;

233 
sw­
(
_r
, 
Ùh”_»p
);

235 
šlše
 
assign
(cÚ¡ 
»p_ty³
& 
»p
);

238 
	g´iv©e
:

240 
	smemo_ty³
 {

241 vŞ©
ušt32_t
 
»fcouÁ
;

242 
ušt32_t
 
	gÿ·c™y
;

243 vŞ©
ušt32_t
 
	gdœty
;

244 #ià
HAVE_STRING_PROFILING
 > 1

245 
memo_ty³
** 
	gµ»v
;

246 
memo_ty³
* 
	gÃxt
;

248 
	g»®_d©a
[8];

250 
šlše
 
š™Ÿlize
(
ušt32_t
 
ÿ·c™y
, ušt32_ˆ
dœty
);

251 #ià
HAVE_STRING_PROFILING


252 
accouÁ_Ãw
();

253 
accouÁ_de¡roy
();

255 
šlše
 
accouÁ_de¡roy
() {}

260 
	gMEMO_SPACE
 = (
memo_ty³
) - 8

263 
	snuÎ_memo
 {

267 
mubË
 
»p_ty³
 
	g_r
;

269 #ià
HAVE_STRING_PROFILING


270 
ušt64_t
 
	glive_memo_couÁ
;

271 
ušt64_t
 
	gmemo_sizes
[55];

272 
ušt64_t
 
	glive_memo_sizes
[55];

273 
ušt64_t
 
	glive_memo_by‹s
[55];

274 #ià
HAVE_STRING_PROFILING
 > 1

275 
memo_t
 *
	glive_memos
[55];

278 
šlše
 
´ofe_memo_size_buck‘
(
ušt32_t
 
dœty
, ušt32_ˆ
ÿ·c™y
) {

279 ià(
	gÿ·c™y
 <= 16)

280  
dœty
;

281 ià(
	gÿ·c™y
 <= 32)

282  17 + (
ÿ·c™y
 - 17) / 2;

283 ià(
	gÿ·c™y
 <= 64)

284  25 + (
ÿ·c™y
 - 33) / 8;

286  29 + 26 - 
ffs_msb
(
ÿ·c™y
 - 1);

289 
´ofe_upd©e_memo_dœty
(
memo_ty³
* 
memo
, 
ušt32_t
 
Şd_dœty
, ušt32_ˆ
Ãw_dœty
, ušt32_ˆ
ÿ·c™y
) {

290 ià(
	gÿ·c™y
 <ğ16 && 
Ãw_dœty
 !ğ
Şd_dœty
) {

291 ++
memo_sizes
[
Ãw_dœty
];

292 ++
	glive_memo_sizes
[
Ãw_dœty
];

293 
	glive_memo_by‹s
[
Ãw_dœty
] +ğ
ÿ·c™y
;

294 --
	glive_memo_sizes
[
Şd_dœty
];

295 
	glive_memo_by‹s
[
Şd_dœty
] -ğ
ÿ·c™y
;

296 #ià
HAVE_STRING_PROFILING
 > 1

297 ià((*
	gmemo
->
	gµ»v
 = 
memo
->
Ãxt
))

298 
memo
->
Ãxt
->
µ»v
 = memo->pprev;

299 
	gmemo
->
	gµ»v
 = &
live_memos
[
Ãw_dœty
];

300 ià((
	gmemo
->
	gÃxt
 = *
memo
->
µ»v
))

301 
memo
->
Ãxt
->
µ»v
 = &memo->next;

302 *
	gmemo
->
	gµ»v
 = 
memo
;

304 (è
	gmemo
;

309 
Úe_´ofe_»pÜt
(
SŒšgAccum
 &
§
, 
i
, 
exam¶es
);

312 
šlše
 
SŒšg
(cÚ¡ * 
d©a
, 
Ëngth
, 
memo_ty³
* 
memo
) {

313 
	g_r
.
assign_nÜef
(
d©a
, 
Ëngth
, 
memo
);

315 
šlše
 
SŒšg
(cÚ¡ * 
d©a
, 
Ëngth
, cÚ¡ 
nuÎ_memo
&)

316 : 
_r
{
d©a
, 
	gËngth
, 0} {

319 
šlše
 
d”ef
() const {

320 
	g_r
.
d”ef
();

323 
assign
(cÚ¡ * 
s
, 
Ën
, 
boŞ
 
Ãed_d”ef
);

324 
assign_out_of_memÜy
();

325 
­³nd
(cÚ¡ * 
s
, 
Ën
, 
memo_ty³
* 
memo
);

326 
SŒšg
 
h¬d_make_¡abË
(cÚ¡ *
s
, 
Ën
);

327 
šlše
 
memo_ty³
* 
ab£Á_memo
() {

328  
	g»š‹½»t_ÿ¡
<
	gmemo_ty³
*>(
ušŒ_t
(1));

330 
šlše
 
memo_ty³
* 
ü—‹_memo
(
ÿ·c™y
, 
dœty
);

331 
d–‘e_memo
(
memo_ty³
* 
memo
);

332 cÚ¡ * 
h¬d_c_¡r
() const;

333 
boŞ
 
h¬d_equ®s
(cÚ¡ * 
s
, 
Ën
) const;

335 cÚ¡ 
	gšt_d©a
[20];

336 cÚ¡ 
»p_ty³
 
	gnuÎ_¡ršg_»p
;

337 cÚ¡ 
»p_ty³
 
	goom_¡ršg_»p
;

338 cÚ¡ 
»p_ty³
 
	gz”o_¡ršg_»p
;

340 
·r£_ûsu8_ch¬
(cÚ¡ * 
s
,

341 cÚ¡ * 
’d
);

343 
ä›nd
 
	g»p_ty³
;

344 
ä›nd
 
şass
 
	gSŒšgAccum
;

349 
šlše
 
	gSŒšg
::
memo_ty³
::
š™Ÿlize
(
ušt32_t
 
ÿ·c™y
, ušt32_ˆ
dœty
) {

350 
	gthis
->
	g»fcouÁ
 = 1;

351 
	gthis
->
	gÿ·c™y
 = 
ÿ·c™y
;

352 
	gthis
->
	gdœty
 = 
dœty
;

353 #ià
HAVE_STRING_PROFILING


354 
	gthis
->
accouÁ_Ãw
();

360 
šlše
 
	gSŒšg
::
SŒšg
()

361 : 
_r
{
SŒšg_g’”ic
::
em±y_d©a
, 0, 0} {

365 
šlše
 
	gSŒšg
::
SŒšg
(cÚ¡ SŒšg& 
x
)

366 : 
_r
(
x
._r) {

367 
_r
.
»f
();

370 #ià
HAVE_CXX_RVALUE_REFERENCES


372 
šlše
 
	gSŒšg
::
SŒšg
(SŒšg &&
x
)

373 : 
_r
(
x
._r) {

374 
x
.
_r
.
»£t_»f
();

379 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

380 
šlše
 
	gSŒšg
::
SŒšg
(cÚ¡ 
SŒšg_ba£
<
T
> &
¡r
) {

381 
assign
(
¡r
.
d©a
(), sŒ.
Ëngth
(), 
çl£
);

388 
šlše
 
	gSŒšg
::
SŒšg
(cÚ¡ * 
c¡r
) {

389 ià(
LCDF_CONSTANT_CSTR
(
c¡r
))

390 
_r
.
assign
(
c¡r
, 
¡¾’
(cstr), 0);

392 
assign
(
c¡r
, -1, 
çl£
);

401 
šlše
 
	gSŒšg
::
SŒšg
(cÚ¡ * 
s
, 
Ën
) {

402 ià(
LCDF_CONSTANT_CSTR
(
s
))

403 
	g_r
.
assign
(
s
, 
Ën
, 0);

405 
assign
(
s
, 
Ën
, 
çl£
);

409 
šlše
 
	gSŒšg
::
SŒšg
(cÚ¡ * 
s
, 
Ën
) {

410 ià(
LCDF_CONSTANT_CSTR
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
)))

411 
	g_r
.
assign
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
), 
Ën
, 0);

413 
assign
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
s
), 
Ën
, 
çl£
);

423 
šlše
 
	gSŒšg
::
SŒšg
(cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
) {

424 
assign
(
fœ¡
, (fœ¡ < 
Ï¡
 ?†a¡ - fœ¡ : 0), 
çl£
);

428 
šlše
 
	gSŒšg
::
SŒšg
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
) {

429 
assign
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
fœ¡
),

430 (
fœ¡
 < 
Ï¡
 ?†a¡ - fœ¡ : 0), 
çl£
);

434 
šlše
 
	gSŒšg
::
SŒšg
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
) {

435 
assign
(
¡r
.
d©a
(), sŒ.
Ëngth
(), 
çl£
);

440 
šlše
 
	gSŒšg
::
SŒšg
(
boŞ
 
x
)

441 : 
_r
{
SŒšg_g’”ic
::
boŞ_d©a
 + (-
x
 & 6), 5 - 
	gx
, 0} {

446 
šlše
 
	gSŒšg
::
SŒšg
(
c
) {

447 
assign
(&
c
, 1, 
çl£
);

451 
šlše
 
	gSŒšg
::
SŒšg
(
c
) {

452 
assign
(
»š‹½»t_ÿ¡
<*>(&
c
), 1, 
çl£
);

455 
šlše
 
	gSŒšg
::
SŒšg
(cÚ¡ 
»p_ty³
& 
r
)

456 : 
_r
(
r
) {

457 
_r
.
»f
();

461 
šlše
 
	gSŒšg
::~
SŒšg
() {

462 
d”ef
();

468 
šlše
 cÚ¡ 
	gSŒšg
& SŒšg::
make_em±y
() {

469  
»š‹½»t_ÿ¡
<cÚ¡ 
SŒšg
 &>(
nuÎ_¡ršg_»p
);

473 
šlše
 
SŒšg
 
	gSŒšg
::
make_unš™Ÿlized
(
Ën
) {

474 
SŒšg
 
s
;

475 
	gs
.
­³nd_unš™Ÿlized
(
Ën
);

476  
	gs
;

480 
šlše
 cÚ¡ 
	gSŒšg
& SŒšg::
make_z”o
() {

481  
»š‹½»t_ÿ¡
<cÚ¡ 
SŒšg
&>(
z”o_¡ršg_»p
);

491 
šlše
 
SŒšg
 
	gSŒšg
::
make_¡abË
(cÚ¡ *
c¡r
) {

492 ià(
LCDF_CONSTANT_CSTR
(
c¡r
))

493  
SŒšg
(
c¡r
, 
¡¾’
(c¡r), 
nuÎ_memo
());

495  
h¬d_make_¡abË
(
c¡r
, -1);

505 
šlše
 
SŒšg
 
	gSŒšg
::
make_¡abË
(cÚ¡ * 
s
, 
Ën
) {

506 ià(
__butš_cÚ¡ªt_p
(
Ën
è&& 
	gËn
 >= 0)

507  
SŒšg
(
s
, 
Ën
, 
nuÎ_memo
());

509  
h¬d_make_¡abË
(
s
, 
Ën
);

524 
šlše
 
SŒšg
 
	gSŒšg
::
make_¡abË
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
) {

525  
SŒšg
(
fœ¡
, (fœ¡ < 
Ï¡
 ?†a¡ - fœ¡ : 0), 
nuÎ_memo
());

529 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

530 
šlše
 
SŒšg
 
	gSŒšg
::
make_¡abË
(cÚ¡ 
SŒšg_ba£
<
T
>& 
¡r
) {

531  
SŒšg
(
¡r
.
d©a
(), sŒ.
Ëngth
(), 
nuÎ_memo
());

538 
šlše
 cÚ¡ * 
	gSŒšg
::
d©a
() const {

539  
_r
.
d©a
;

543 
šlše
 
	gSŒšg
::
Ëngth
() const {

544  
_r
.
Ëngth
;

553 
šlše
 cÚ¡ * 
	gSŒšg
::
c_¡r
() const {

555 #ià
HAVE_OPTIMIZE_SIZE
 || 
__OPTIMIZE_SIZE__


556  
h¬d_c_¡r
();

562 cÚ¡ * 
	g’d_d©a
 = 
_r
.
d©a
 + _r.
Ëngth
;

563 
memo_ty³
* 
	gm
 = 
_r
.
memo
();

564 ià((
	gm
 && 
	g’d_d©a
 >ğ
m
->
»®_d©a
 + m->
dœty
)

565 || *
’d_d©a
 != '\0') {

566 ià(*
x
 = 
cÚ¡_ÿ¡
<
SŒšg
*>(
this
)->
­³nd_unš™Ÿlized
(1)) {

567 *
x
 = '\0';

568 --
	g_r
.
	gËngth
;

571  
	g_r
.
	gd©a
;

585 
šlše
 
SŒšg
 
	gSŒšg
::
sub¡ršg
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
) const {

586 ià(
	gfœ¡
 < 
	gÏ¡
 && fœ¡ >ğ
_r
.
d©a
 && 
Ï¡
 <ğ_r.d©¨+ _r.
Ëngth
) {

587 
_r
.
»f
();

588  
SŒšg
(
fœ¡
, 
Ï¡
 - fœ¡, 
_r
.
memo
());

590  
SŒšg
();

593 
šlše
 
SŒšg
 
	gSŒšg
::
sub¡ršg
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
) const {

594  
sub¡ršg
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
fœ¡
),

595 
»š‹½»t_ÿ¡
<cÚ¡ *>(
Ï¡
));

603 
šlše
 
SŒšg
 
	gSŒšg
::
ç¡_sub¡ršg
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
) const {

604 
as£¹
(
begš
(è<ğ
fœ¡
 && fœ¡ <ğ
Ï¡
 &&†a¡ <ğ
’d
());

605 
	g_r
.
»f
();

606  
SŒšg
(
fœ¡
, 
Ï¡
 - fœ¡, 
_r
.
memo
());

609 
šlše
 
SŒšg
 
	gSŒšg
::
ç¡_sub¡ršg
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
) const {

610  
ç¡_sub¡ršg
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
fœ¡
),

611 
»š‹½»t_ÿ¡
<cÚ¡ *>(
Ï¡
));

625 
šlše
 
SŒšg
 
	gSŒšg
::
sub¡r
(
pos
) const {

626  
sub¡r
((
pos
 <ğ-
_r
.
Ëngth
 ? 0 :…os), _r.length);

629 
šlše
 
	gSŒšg
::
assign
(cÚ¡ 
»p_ty³
& 
»p
) {

630 
»p
.
»f
();

631 
	g_r
.
d”ef
();

632 
	g_r
 = 
»p
;

636 
šlše
 
	gSŒšg
::
assign
(cÚ¡ 
SŒšg
& 
x
) {

637 
assign
(
x
.
_r
);

641 
šlše
 
	gSŒšg
& SŒšg::
İ”©Ü
=(cÚ¡ 
SŒšg
& 
x
) {

642 
assign
(
x
);

643  *
	gthis
;

646 #ià
HAVE_CXX_RVALUE_REFERENCES


648 
šlše
 
	gSŒšg
::
assign
(
SŒšg
&& 
x
) {

649 
d”ef
();

650 
	g_r
 = 
x
.
_r
;

651 
	gx
.
	g_r
.
»£t_»f
();

655 
šlše
 
	gSŒšg
& SŒšg::
İ”©Ü
=(
SŒšg
&& 
x
) {

656 
assign
(
¡d
::
move
(
x
));

657  *
	gthis
;

662 
šlše
 
	gSŒšg
::
assign
(cÚ¡ * 
c¡r
) {

663 ià(
LCDF_CONSTANT_CSTR
(
c¡r
)) {

664 
d”ef
();

665 
	g_r
.
assign
(
c¡r
, 
¡¾’
(cstr), 0);

667 
assign
(
c¡r
, -1, 
Œue
);

671 
šlše
 
	gSŒšg
& SŒšg::
İ”©Ü
=(cÚ¡ * 
c¡r
) {

672 
assign
(
c¡r
);

673  *
	gthis
;

677 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

678 
šlše
 
	gSŒšg
::
assign
(cÚ¡ 
SŒšg_ba£
<
T
>& 
¡r
) {

679 
assign
(
¡r
.
d©a
(), sŒ.
Ëngth
(), 
Œue
);

683 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

684 
šlše
 
	gSŒšg
& SŒšg::
İ”©Ü
=(cÚ¡ 
SŒšg_ba£
<
T
>& 
¡r
) {

685 
assign
(
¡r
);

686  *
	gthis
;

690 
šlše
 
	gSŒšg
::
assign
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
) {

691 
assign
(
¡r
.
d©a
(), sŒ.
Ëngth
(), 
Œue
);

695 
šlše
 
	gSŒšg
& SŒšg::
İ”©Ü
=(cÚ¡ 
¡d
::
¡ršg
& 
¡r
) {

696 
assign
(
¡r
);

697  *
	gthis
;

701 
šlše
 
	gSŒšg
::
assign
(cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
) {

702 
assign
(
fœ¡
, 
Ï¡
 - fœ¡, 
Œue
);

706 
šlše
 
	gSŒšg
::
sw­
(
SŒšg
 &
x
) {

707 
usšg
 
¡d
::
sw­
;

708 
sw­
(
_r
, 
x
._r);

712 
šlše
 
	gSŒšg
::
­³nd
(cÚ¡ 
SŒšg
& 
x
) {

713 
­³nd
(
x
.
d©a
(), x.
Ëngth
(), x.
_r
.
memo
());

718 
šlše
 
	gSŒšg
::
­³nd
(cÚ¡ * 
c¡r
) {

719 ià(
LCDF_CONSTANT_CSTR
(
c¡r
))

720 
­³nd
(
c¡r
, 
¡¾’
(c¡r), 
ab£Á_memo
());

722 
­³nd
(
c¡r
, -1, 
ab£Á_memo
());

730 
šlše
 
	gSŒšg
::
­³nd
(cÚ¡ * 
s
, 
Ën
) {

731 
­³nd
(
s
, 
Ën
, 
ab£Á_memo
());

737 
šlše
 
	gSŒšg
::
­³nd
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
) {

738 ià(
	gfœ¡
 < 
	gÏ¡
)

739 
­³nd
(
fœ¡
, 
Ï¡
 - first);

742 
šlše
 
	gSŒšg
::
­³nd
(cÚ¡ * 
fœ¡
,

743 cÚ¡ * 
Ï¡
) {

744 ià(
	gfœ¡
 < 
	gÏ¡
)

745 
­³nd
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
fœ¡
), 
Ï¡
 - first);

750 
šlše
 
	gSŒšg
& SŒšg::
İ”©Ü
+=(cÚ¡ 
SŒšg
 &
x
) {

751 
­³nd
(
x
.
d©a
(), x.
Ëngth
(), x.
_r
.
memo
());

752  *
	gthis
;

757 
šlše
 
	gSŒšg
& SŒšg::
İ”©Ü
+=(cÚ¡ * 
c¡r
) {

758 
­³nd
(
c¡r
);

759  *
	gthis
;

764 
šlše
 
	gSŒšg
 &SŒšg::
İ”©Ü
+=(
c
) {

765 
­³nd
(&
c
, 1);

766  *
	gthis
;

771 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

772 
šlše
 
	gSŒšg
 &SŒšg::
İ”©Ü
+=(cÚ¡ 
SŒšg_ba£
<
T
> &
x
) {

773 
­³nd
(
x
.
d©a
(), x.
Ëngth
());

774  *
	gthis
;

778 
šlše
 
boŞ
 
	gSŒšg
::
is_sh¬ed
() const {

779 
memo_ty³
* 
m
 = 
_r
.
memo
();

780  !
	gm
 || m->
	g»fcouÁ
 != 1;

784 
šlše
 
boŞ
 
	gSŒšg
::
is_¡abË
() const {

785  !
_r
.
memo
();

791 
šlše
 
SŒšg
 
	gSŒšg
::
unique
() const {

792 
memo_ty³
* 
m
 = 
_r
.
memo
();

793 ià(!
	gm
 || m->
	g»fcouÁ
 == 1)

794  *
this
;

796  
SŒšg
(
_r
.
d©a
, _r.d©¨+ _r.
Ëngth
);

803 
šlše
 
	gSŒšg
::
shršk_to_f™
() {

804 
memo_ty³
* 
m
 = 
_r
.
memo
();

805 ià(
	gm
 && m->
	g»fcouÁ
 > 1 && (
	gušt32_t
è
	g_r
.
	gËngth
 + 256 < m->
	gÿ·c™y
)

806 *
	gthis
 = 
SŒšg
(
_r
.
d©a
, _r.d©¨+ _r.
Ëngth
);

810 
šlše
 * 
	gSŒšg
::
mubË_ud©a
() {

811  
»š‹½»t_ÿ¡
<*>(
mubË_d©a
());

815 
šlše
 cÚ¡ 
	gSŒšg
 &SŒšg::
make_out_of_memÜy
() {

816  
»š‹½»t_ÿ¡
<cÚ¡ 
SŒšg
 &>(
oom_¡ršg_»p
);

823 
šlše
 cÚ¡ * 
	gSŒšg
::
sk_utf8_ch¬
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
) {

824  
	g»š‹½»t_ÿ¡
<const *>(

825 
sk_utf8_ch¬
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
fœ¡
),

826 
»š‹½»t_ÿ¡
<cÚ¡ *>(
Ï¡
)));

829 
šlše
 cÚ¡ * 
	gSŒšg
::
sk_utf8_bom
(cÚ¡ * 
fœ¡
,

830 cÚ¡ * 
Ï¡
) {

831 ià(
	gÏ¡
 - 
	gfœ¡
 >= 3

832 && 
fœ¡
[0] == 0xEF && first[1] == 0xBB && first[2] == 0xBF)

833  
fœ¡
 + 3;

835  
	gfœ¡
;

838 
šlše
 cÚ¡ * 
	gSŒšg
::
sk_utf8_bom
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
) {

839  
	g»š‹½»t_ÿ¡
<const *>(

840 
sk_utf8_bom
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
fœ¡
),

841 
»š‹½»t_ÿ¡
<cÚ¡ *>(
Ï¡
)));

849 
šlše
 
SŒšg
 
	gİ”©Ü
+(SŒšg 
	ga
, cÚ¡ 
	gSŒšg
& 
	gb
) {

850 
	ga
 +ğ
b
;

851  
	ga
;

855 
šlše
 
SŒšg
 
	gİ”©Ü
+(SŒšg 
	ga
, cÚ¡ * 
	gb
) {

856 
	ga
.
­³nd
(
b
);

857  
	ga
;

861 
šlše
 
SŒšg
 
	gİ”©Ü
+(cÚ¡ * 
	ga
, cÚ¡ 
	gSŒšg
& 
	gb
) {

862 
SŒšg
 
s1
(
a
);

863 
	gs1
 +ğ
b
;

864  
	gs1
;

871 
šlše
 
SŒšg
 
	gİ”©Ü
+(SŒšg 
	ga
, 
	gb
) {

872 
	ga
.
­³nd
(&
b
, 1);

873  
	ga
;

876 #ià
HAVE_CXX_USER_LITERALS


877 
šlše
 
SŒšg
 
	gİ”©Ü
"" 
_S
(cÚ¡ * 
s
, 
size_t
 
Ën
) {

878  
	gSŒšg
::
make_¡abË
(
s
, s + 
Ën
);

882 
šlše
 
sw­
(
SŒšg
& 
a
, SŒšg& 
b
) {

883 
	ga
.
sw­
(
b
);

888 
	$LCDF_MAKE_STRING_HASH
(
lcdf
::
SŒšg
)

	@masstree-beta/string_base.hh

16 #iâdeà
STRING_BASE_HH


17 
	#STRING_BASE_HH


	)

18 
	~"comp”.hh
"

19 
	~"hashcode.hh
"

20 
	~<as£¹.h
>

21 
	~<¡ršg.h
>

22 
	~<lim™s.h
>

23 
	~<ùy³.h
>

24 
	~<io¡»am
>

25 
Çme¥aû
 
	glcdf
 {

26 
şass
 
	gSŒšgAccum
;

27 
	#LCDF_CONSTANT_CSTR
(
c¡r
è((c¡rè&& 
	`__butš_cÚ¡ªt_p
(
	`¡¾’
((c¡r))))

	)

29 şas 
	cSŒšg_g’”ic
 {

30 
	gpublic
:

31 cÚ¡ 
em±y_d©a
[1];

32 cÚ¡ 
	gboŞ_d©a
[11];

33 cÚ¡ 
	gout_of_memÜy_d©a
[15];

34 cÚ¡ 
	gba£64_’codšg_bË
[65];

35 cÚ¡ 
	gba£64_decodšg_m­
[256];

36 ’um { 
	gout_of_memÜy_Ëngth
 = 14 };

37 
boŞ
 
out_of_memÜy
(cÚ¡ * 
s
) {

38  
uÆik–y
(
s
 >ğ
out_of_memÜy_d©a


39 && 
s
 <ğ
out_of_memÜy_d©a
 + 
out_of_memÜy_Ëngth
);

41 
boŞ
 
equ®s
(cÚ¡ * 
a
, 
a_Ën
, cÚ¡ * 
b
, 
b_Ën
) {

42  
	ga_Ën
 =ğ
b_Ën
 && 
memcmp
(
a
, 
b
, 
a_Ën
) == 0;

44 
com·»
(cÚ¡ * 
a
, 
a_Ën
, cÚ¡ * 
b
, 
b_Ën
);

45 
šlše
 
com·»
(cÚ¡ * 
a
, 
a_Ën
,

46 cÚ¡ * 
b
, 
b_Ën
) {

47  
com·»
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
a
), 
a_Ën
,

48 
»š‹½»t_ÿ¡
<cÚ¡ *>(
b
), 
b_Ën
);

50 
Çtu¿l_com·»
(cÚ¡ * 
a
, 
a_Ën
, cÚ¡ * 
b
, 
b_Ën
);

51 
Çtu¿l_com·»
(cÚ¡ * 
a
, 
a_Ën
,

52 cÚ¡ * 
b
, 
b_Ën
) {

53  
Çtu¿l_com·»
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
a
), 
a_Ën
,

54 
»š‹½»t_ÿ¡
<cÚ¡ *>(
b
), 
b_Ën
);

56 
boŞ
 
¡¬ts_w™h
(cÚ¡ *
a
, 
a_Ën
, cÚ¡ *
b
, 
b_Ën
) {

57  
	ga_Ën
 >ğ
b_Ën
 && 
memcmp
(
a
, 
b
, b_len) == 0;

59 
fšd_Ëá
(cÚ¡ *
s
, 
Ën
, 
¡¬t
, 
x
);

60 
fšd_Ëá
(cÚ¡ *
s
, 
Ën
, 
¡¬t
, cÚ¡ *
x
, 
x_Ën
);

61 
fšd_right
(cÚ¡ *
s
, 
Ën
, 
¡¬t
, 
x
);

62 
fšd_right
(cÚ¡ *
s
, 
Ën
, 
¡¬t
, cÚ¡ *
x
, 
x_Ën
);

63 
boŞ
 
glob_m©ch
(cÚ¡ * 
s
, 
¦’
, cÚ¡ * 
·‰”n
, 
¶’
);

64 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
šlše
y³ÇmT::
sub¡ršg_ty³
 
Érim
(cÚ¡ 
T
 &
¡r
);

65 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
šlše
y³ÇmT::
sub¡ršg_ty³
 
¹rim
(cÚ¡ 
T
 &
¡r
);

66 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
šlše
y³ÇmT::
sub¡ršg_ty³
 
Œim
(cÚ¡ 
T
 &
¡r
);

67 
hashcode_t
 
hashcode
(cÚ¡ *
s
, 
Ën
);

68 
hashcode_t
 
hashcode
(cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
) {

69  
hashcode
(
fœ¡
, 
Ï¡
 - first);

71 
to_i
(cÚ¡ * 
fœ¡
, cÚ¡ * 
Ï¡
);

72 
uµ”_hex_nibbË
(
n
) {

73  
	gn
 + (n > 9 ? 'A' - 10 : '0');

77 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

78 şas 
	cSŒšg_ba£
 {

79 
	gpublic
:

80 
T
 
	tty³
;

81 cÚ¡ * 
	tcÚ¡_™”©Ü
;

82 
cÚ¡_™”©Ü
 
	t™”©Ü
;

83 cÚ¡ * 
	tcÚ¡_unsigÃd_™”©Ü
;

84 
cÚ¡_unsigÃd_™”©Ü
 
	tunsigÃd_™”©Ü
;

85 (
	gSŒšg_ba£
<
	tT
>::*
	tun¥ecif›d_boŞ_ty³
)() const;

87 cÚ¡ * 
d©a
() const {

88  
	g¡©ic_ÿ¡
<cÚ¡ 
	gT
*>(
	gthis
)->
d©a
();

90 
Ëngth
() const {

91  
	g¡©ic_ÿ¡
<cÚ¡ 
	gT
*>(
	gthis
)->
Ëngth
();

93 
size
() const {

94  
	g¡©ic_ÿ¡
<cÚ¡ 
	gT
*>(
	gthis
)->
Ëngth
();

101 cÚ¡ * 
ud©a
() const {

102  
	g»š‹½»t_ÿ¡
<cÚ¡ *>(
d©a
());

108 
cÚ¡_™”©Ü
 
begš
() const {

109  
d©a
();

115 
cÚ¡_™”©Ü
 
’d
() const {

116  
d©a
(è+ 
Ëngth
();

122 
cÚ¡_unsigÃd_™”©Ü
 
ubegš
() const {

123  
	g»š‹½»t_ÿ¡
<
	gcÚ¡_unsigÃd_™”©Ü
>(
d©a
());

129 
cÚ¡_unsigÃd_™”©Ü
 
u’d
() const {

130  
	g»š‹½»t_ÿ¡
<
	gcÚ¡_unsigÃd_™”©Ü
>(
d©a
(è+ 
Ëngth
());

133 
İ”©Ü
 
un¥ecif›d_boŞ_ty³
() const {

134  
Ëngth
(è? &
	gSŒšg_ba£
<
	gT
>::length : 0;

137 
boŞ
 
	gİ”©Ü
!() const {

138  
Ëngth
() == 0;

141 
boŞ
 
em±y
() const {

142  
Ëngth
() == 0;

145 
boŞ
 
out_of_memÜy
() const {

146  
	gSŒšg_g’”ic
::
out_of_memÜy
(
d©a
());

151 cÚ¡ & 
	gİ”©Ü
[](
	gi
) const {

152  
d©a
()[
i
];

158 cÚ¡ & 
©
(
i
) const {

159 
as£¹
((
i
è< (
Ëngth
()));

160  
d©a
()[
i
];

165 cÚ¡ & 
äÚt
() const {

166  
d©a
()[0];

171 cÚ¡ & 
back
() const {

172  
d©a
()[
Ëngth
() - 1];

175 
boŞ
 
equ®s
(cÚ¡ *
c¡r
) const {

176  
	gSŒšg_g’”ic
::
equ®s
(
d©a
(), 
Ëngth
(), 
c¡r
, 
¡¾’
(cstr));

180 
boŞ
 
equ®s
(cÚ¡ *
s
, 
Ën
) const {

181  
	gSŒšg_g’”ic
::
equ®s
(
d©a
(), 
Ëngth
(), 
s
, 
Ën
);

184 
	g‹m¶©e
 <
ty³Çme
 
	gTT
>

185 
boŞ
 
equ®s
(cÚ¡ 
SŒšg_ba£
<
TT
>& 
x
) const {

186  
	gSŒšg_g’”ic
::
equ®s
(
d©a
(), 
Ëngth
(), 
x
.data(), x.length());

194 
com·»
(cÚ¡ * 
c¡r
) const {

195  
	gSŒšg_g’”ic
::
com·»
(
d©a
(), 
Ëngth
(), 
c¡r
, 
¡¾’
(cstr));

199 
com·»
(cÚ¡ * 
s
, 
Ën
) const {

200  
	gSŒšg_g’”ic
::
com·»
(
d©a
(), 
Ëngth
(), 
s
, 
Ën
);

203 
	g‹m¶©e
 <
ty³Çme
 
	gTT
>

204 
com·»
(cÚ¡ 
SŒšg_ba£
<
TT
>& 
x
) const {

205  
	gSŒšg_g’”ic
::
com·»
(
d©a
(), 
Ëngth
(), 
x
.data(), x.length());

208 
	g‹m¶©e
 <
ty³Çme
 
	gTT
,y³Çm
	gUU
>

209 
com·»
(cÚ¡ 
SŒšg_ba£
<
TT
>& 
a
, cÚ¡ SŒšg_ba£<
UU
>& 
b
) {

210  
	gSŒšg_g’”ic
::
com·»
(
a
.
d©a
(),‡.
Ëngth
(), 
b
.data(), b.length());

213 
	g‹m¶©e
 <
ty³Çme
 
	gUU
>

214 
com·»
(cÚ¡ * 
a
, cÚ¡ 
SŒšg_ba£
<
UU
> &
b
) {

215  
	gSŒšg_g’”ic
::
com·»
(
a
, 
¡¾’
×), 
b
.
d©a
(), b.
Ëngth
());

218 
	g‹m¶©e
 <
ty³Çme
 
	gTT
>

219 
com·»
(cÚ¡ 
SŒšg_ba£
<
TT
>& 
a
, cÚ¡ * 
b
) {

220  
	gSŒšg_g’”ic
::
com·»
(
a
.
d©a
(),‡.
Ëngth
(), 
b
, 
¡¾’
(b));

223 
com·»
(cÚ¡ * 
a
, cÚ¡ * 
b
) {

224  
	gSŒšg_g’”ic
::
com·»
(
a
, 
¡¾’
×), 
b
, strlen(b));

235 
Çtu¿l_com·»
(cÚ¡ *
c¡r
) const {

236  
	gSŒšg_g’”ic
::
Çtu¿l_com·»
(
d©a
(), 
Ëngth
(), 
c¡r
, 
¡¾’
(cstr));

240 
Çtu¿l_com·»
(cÚ¡ *
s
, 
Ën
) const {

241  
	gSŒšg_g’”ic
::
Çtu¿l_com·»
(
d©a
(), 
Ëngth
(), 
s
, 
Ën
);

244 
	g‹m¶©e
 <
ty³Çme
 
	gTT
>

245 
Çtu¿l_com·»
(cÚ¡ 
SŒšg_ba£
<
TT
> &
x
) const {

246  
	gSŒšg_g’”ic
::
Çtu¿l_com·»
(
d©a
(), 
Ëngth
(), 
x
.data(), x.length());

249 
	g‹m¶©e
 <
ty³Çme
 
	gTT
,y³Çm
	gUU
>

250 
Çtu¿l_com·»
(cÚ¡ 
SŒšg_ba£
<
TT
> &
a
, cÚ¡ SŒšg_ba£<
UU
> &
b
) {

251  
	gSŒšg_g’”ic
::
Çtu¿l_com·»
(
a
.
d©a
(),‡.
Ëngth
(), 
b
.data(), b.length());

254 
	g‹m¶©e
 <
ty³Çme
 
	gUU
>

255 
Çtu¿l_com·»
(cÚ¡ * 
a
, cÚ¡ 
SŒšg_ba£
<
UU
> &
b
) {

256  
	gSŒšg_g’”ic
::
Çtu¿l_com·»
(
a
, 
¡¾’
×), 
b
.
d©a
(), b.
Ëngth
());

259 
	g‹m¶©e
 <
ty³Çme
 
	gTT
>

260 
Çtu¿l_com·»
(cÚ¡ 
SŒšg_ba£
<
TT
>& 
a
, cÚ¡ * 
b
) {

261  
	gSŒšg_g’”ic
::
Çtu¿l_com·»
(
a
.
d©a
(),‡.
Ëngth
(), 
b
, 
¡¾’
(b));

264 
Çtu¿l_com·»
(cÚ¡ * 
a
, cÚ¡ * 
b
) {

265  
	gSŒšg_g’”ic
::
Çtu¿l_com·»
(
a
, 
¡¾’
×), 
b
, strlen(b));

268 
Çtu¿l_com·»
(cÚ¡ 
¡d
::
¡ršg
& 
a
, cÚ¡ std::¡ršg& 
b
) {

269  
SŒšg_g’”ic
::
Çtu¿l_com·»
(
a
.
d©a
(),‡.
Ëngth
(), 
b
.data(), b.length());

272 şas 
	cÇtu¿l_com·¿tÜ
 {

273 
	gpublic
:

274 
‹m¶©e
 <
ty³Çme
 
TT
,y³Çm
	gUU
>

275 
boŞ
 
İ”©Ü
()(cÚ¡ 
	gTT
& 
	ga
, cÚ¡ 
	gUU
& 
	gb
) const {

276  
	gSŒšg_ba£
<
	gT
>::
Çtu¿l_com·»
(
a
, 
b
) < 0;

280 
boŞ
 
¡¬ts_w™h
(cÚ¡ *
c¡r
) const {

281  
	gSŒšg_g’”ic
::
¡¬ts_w™h
(
d©a
(), 
Ëngth
(), 
c¡r
, 
¡¾’
(cstr));

285 
boŞ
 
¡¬ts_w™h
(cÚ¡ *
s
, 
Ën
) const {

286  
	gSŒšg_g’”ic
::
¡¬ts_w™h
(
d©a
(), 
Ëngth
(), 
s
, 
Ën
);

289 
	g‹m¶©e
 <
ty³Çme
 
	gTT
>

290 
boŞ
 
¡¬ts_w™h
(cÚ¡ 
SŒšg_ba£
<
TT
> &
x
) const {

291  
	gSŒšg_g’”ic
::
¡¬ts_w™h
(
d©a
(), 
Ëngth
(), 
x
.data(), x.length());

298 
fšd_Ëá
(
x
, 
¡¬t
 = 0) const {

299  
SŒšg_g’”ic
::
fšd_Ëá
(
d©a
(), 
Ëngth
(), 
¡¬t
, 
x
);

305 
fšd_Ëá
(cÚ¡ *
c¡r
, 
¡¬t
 = 0) const {

306  
SŒšg_g’”ic
::
fšd_Ëá
(
d©a
(), 
Ëngth
(), 
¡¬t
, 
c¡r
, 
¡¾’
(cstr));

312 
	g‹m¶©e
 <
ty³Çme
 
	gTT
>

313 
fšd_Ëá
(cÚ¡ 
SŒšg_ba£
<
TT
> &
x
, 
¡¬t
 = 0) const {

314  
SŒšg_g’”ic
::
fšd_Ëá
(
d©a
(), 
Ëngth
(), 
¡¬t
, 
x
.data(), x.length());

321 
fšd_right
(
c
, 
¡¬t
 = 
INT_MAX
) const {

322  
SŒšg_g’”ic
::
fšd_right
(
d©a
(), 
Ëngth
(), 
¡¬t
, 
c
);

329 
fšd_right
(cÚ¡ *
c¡r
, 
¡¬t
 = 
INT_MAX
) const {

330  
SŒšg_g’”ic
::
fšd_right
(
d©a
(), 
Ëngth
(), 
¡¬t
, 
c¡r
, 
¡¾’
(cstr));

336 
	g‹m¶©e
 <
ty³Çme
 
	gTT
>

337 
fšd_right
(cÚ¡ 
SŒšg_ba£
<
TT
> &
x
, 
¡¬t
 = 
INT_MAX
) const {

338  
SŒšg_g’”ic
::
fšd_right
(
d©a
(), 
Ëngth
(), 
¡¬t
, 
x
.data(), x.length());

345 
boŞ
 
glob_m©ch
(cÚ¡ * 
·‰”n
) const {

346  
	gSŒšg_g’”ic
::
glob_m©ch
(
d©a
(), 
Ëngth
(), 
·‰”n
, 
¡¾’
(pattern));

349 
	g‹m¶©e
 <
ty³Çme
 
	gTT
>

350 
boŞ
 
glob_m©ch
(cÚ¡ 
SŒšg_ba£
<
TT
>& 
·‰”n
) const {

351  
	gSŒšg_g’”ic
::
glob_m©ch
(
d©a
(), 
Ëngth
(), 
·‰”n
.data(),…attern.length());

362 
hashcode_t
 
hashcode
(cÚ¡ *
fœ¡
, cÚ¡ *
Ï¡
) {

363  
	gSŒšg_g’”ic
::
hashcode
(
fœ¡
, 
Ï¡
);

366 
hashcode_t
 
hashcode
() const {

367  
	gSŒšg_g’”ic
::
hashcode
(
d©a
(), 
Ëngth
());

371 
to_i
() const {

372  
	gSŒšg_g’”ic
::
to_i
(
begš
(), 
’d
());

375 
	g‹m¶©e
 <
ty³Çme
 
	gE
>

376 
cÚ¡_™”©Ü
 
’code_jsÚ_·¹Ÿl
(
E
& 
e
) const;

377 
	g‹m¶©e
 <
ty³Çme
 
	gE
>

378 
šlše
 
’code_jsÚ
(
E
& 
e
) const;

379 
	g‹m¶©e
 <
ty³Çme
 
	gE
>

380 
’code_ba£64
(
E
& 
e
, 
boŞ
 
·d
 = 
çl£
) const;

381 
	g‹m¶©e
 <
ty³Çme
 
	gE
>

382 
boŞ
 
decode_ba£64
(
E
& 
e
) const;

383 
	g‹m¶©e
 <
ty³Çme
 
	gE
>

384 
’code_uri_compÚ’t
(
E
& 
e
) const;

387 
šlše
 
İ”©Ü
 
	g¡d
::
¡ršg
() const {

388  
¡d
::
¡ršg
(
begš
(), 
’d
());

391 
	g´Ùeùed
:

392 
SŒšg_ba£
() = ;

395 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

396 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
SŒšg_ba£
<
T
> &
a
, cÚ¡ 
	gSŒšg_ba£
<
	gU
> &
	gb
) {

397  
	ga
.
equ®s
(
b
);

400 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

401 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
SŒšg_ba£
<
T
> &
a
, cÚ¡ 
	g¡d
::
¡ršg
 &
b
) {

402  
a
.
equ®s
(
b
.
d©a
(), b.
Ëngth
());

405 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

406 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
¡d
::
¡ršg
 &
a
, cÚ¡ 
	gSŒšg_ba£
<
	gT
> &
	gb
) {

407  
	gb
.
equ®s
(
a
.
d©a
(),‡.
Ëngth
());

410 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

411 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
SŒšg_ba£
<
T
> &
a
, cÚ¡ *
	gb
) {

412  
	ga
.
equ®s
(
b
, 
¡¾’
(b));

415 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

416 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ *
a
, cÚ¡ 
	gSŒšg_ba£
<
	gT
> &
	gb
) {

417  
	gb
.
equ®s
(
a
, 
¡¾’
(a));

420 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

421 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
SŒšg_ba£
<
T
> &
a
, cÚ¡ 
	gSŒšg_ba£
<
	gU
> &
	gb
) {

422  !(
	ga
 =ğ
b
);

425 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

426 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
SŒšg_ba£
<
T
> &
a
, cÚ¡ 
	g¡d
::
¡ršg
 &
b
) {

427  !(
a
 =ğ
b
);

430 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

431 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
¡d
::
¡ršg
 &
a
, cÚ¡ 
	gSŒšg_ba£
<
	gT
> &
	gb
) {

432  !(
	ga
 =ğ
b
);

435 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

436 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
SŒšg_ba£
<
T
> &
a
, cÚ¡ *
	gb
) {

437  !(
	ga
 =ğ
b
);

440 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

441 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ *
a
, cÚ¡ 
	gSŒšg_ba£
<
	gT
> &
	gb
) {

442  !(
	ga
 =ğ
b
);

445 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

446 
šlše
 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gSŒšg_ba£
<
	gT
> &
	ga
, cÚ¡ SŒšg_ba£<
	gU
> &
	gb
) {

447  
	ga
.
com·»
(
b
) < 0;

450 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

451 
šlše
 
boŞ
 
	gİ”©Ü
<=(cÚ¡ 
SŒšg_ba£
<
T
> &
a
, cÚ¡ 
	gSŒšg_ba£
<
	gU
> &
	gb
) {

452  
	ga
.
com·»
(
b
) <= 0;

455 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

456 
šlše
 
boŞ
 
	gİ”©Ü
>=(cÚ¡ 
SŒšg_ba£
<
T
> &
a
, cÚ¡ 
	gSŒšg_ba£
<
	gU
> &
	gb
) {

457  
	ga
.
com·»
(
b
) >= 0;

460 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

461 
šlše
 
boŞ
 
	gİ”©Ü
>(cÚ¡ 
	gSŒšg_ba£
<
	gT
> &
	ga
, cÚ¡ SŒšg_ba£<
	gU
> &
	gb
) {

462  
	ga
.
com·»
(
b
) > 0;

465 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

466 
šlše
 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(
¡d
::o¡»am &
f
, cÚ¡ 
	gSŒšg_ba£
<
	gT
> &
	g¡r
) {

467  
	gf
.
wr™e
(
¡r
.
d©a
(), sŒ.
Ëngth
());

470 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

471 
šlše
 
hashcode_t
 
hashcode
(cÚ¡ 
SŒšg_ba£
<
T
>& 
x
) {

472  
	gSŒšg_g’”ic
::
hashcode
(
x
.
d©a
(), x.
Ëngth
());

476 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

477 
šlše
 
size_t
 
hash_v®ue
(cÚ¡ 
SŒšg_ba£
<
T
>& 
x
) {

478  
	gSŒšg_g’”ic
::
hashcode
(
x
.
d©a
(), x.
Ëngth
());

481 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

482 
šlše
 
ty³Çme
 
	gT
::
sub¡ršg_ty³
 
SŒšg_g’”ic
::
	$Érim
(cÚ¡ 
T
 &
¡r
) {

483 cÚ¡ *
b
 = 
¡r
.
	`begš
(), *
e
 = sŒ.
	`’d
();

484 
b
 !ğ
e
 && 
	`is¥aû
(() b[0]))

485 ++
b
;

486  
¡r
.
	`ç¡_sub¡ršg
(
b
, 
e
);

487 
	}
}

489 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

490 
šlše
 
ty³Çme
 
	gT
::
sub¡ršg_ty³
 
SŒšg_g’”ic
::
	$¹rim
(cÚ¡ 
T
 &
¡r
) {

491 cÚ¡ *
b
 = 
¡r
.
	`begš
(), *
e
 = sŒ.
	`’d
();

492 
b
 !ğ
e
 && 
	`is¥aû
(()ƒ[-1]))

493 --
e
;

494  
¡r
.
	`ç¡_sub¡ršg
(
b
, 
e
);

495 
	}
}

497 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

498 
šlše
 
ty³Çme
 
	gT
::
sub¡ršg_ty³
 
SŒšg_g’”ic
::
	$Œim
(cÚ¡ 
T
 &
¡r
) {

499 cÚ¡ *
b
 = 
¡r
.
	`begš
(), *
e
 = sŒ.
	`’d
();

500 
b
 !ğ
e
 && 
	`is¥aû
(()ƒ[-1]))

501 --
e
;

502 
b
 !ğ
e
 && 
	`is¥aû
(() b[0]))

503 ++
b
;

504  
¡r
.
	`ç¡_sub¡ršg
(
b
, 
e
);

505 
	}
}

507 #ià
HAVE_STD_HASH


508 
	#LCDF_MAKE_STRING_HASH
(
ty³
) \

509 
Çme¥aû
 
¡d
 { 
‹m¶©e
 <> 
hash
<
ty³
> \

510 : 
public
 
uÇry_funùiÚ
<cÚ¡ 
ty³
&, 
size_t
> { \

511 
size_t
 
	`İ”©Ü
()(cÚ¡ 
ty³
& 
x
ècÚ¡ 
nÛxû±
 { \

512  
x
.
	`hashcode
(); \

513 } }; }

	)

515 
	#LCDF_MAKE_STRING_HASH
(
ty³
)

	)

518 
	g‹m¶©e
 <
ty³Çme
 
	gT
>em¶©<ty³Çm
	gE
>

519 
ty³Çme
 
	gSŒšg_ba£
<
	gT
>::
cÚ¡_™”©Ü
 
SŒšg_ba£
<
T
>::
	$’code_jsÚ_·¹Ÿl
(
E
& 
’c
) const {

520 cÚ¡ *
Ï¡
 = 
this
->
	`begš
(), *
’d
 =his->
	`’d
();

521 cÚ¡ *
s
 = 
Ï¡
; s !ğ
’d
; ++s) {

522 
c
 = (è*
s
;

527 ià(
	`uÆik–y
(
c
 == 0xE2)

528 && 
s
 + 2 < 
’d
 && () s[1] == 0x80

529 && (è(
s
[2] | 1) == 0xA9)

530 
c
 = 0x2028 + (
s
[2] & 1);

531 ià(
	`lik–y
(
c
 >= 32 && c != '\\' && c != '\"' && c != '/'))

534 
’c
.
	`­³nd
(
Ï¡
, 
s
);

535 
’c
 << '\\';

536 
c
) {

538 
’c
 << 'b';

541 
’c
 << 'f';

544 
’c
 << 'n';

547 
’c
 << 'r';

550 
’c
 << 't';

555 
’c
 << (è
c
;

558 * 
x
 = 
’c
.
	`ex‹nd
(5);

559 *
x
++ = 'u';

560 *
x
++ = 
SŒšg_g’”ic
::
	`uµ”_hex_nibbË
(
c
 >> 12);

561 *
x
++ = 
SŒšg_g’”ic
::
	`uµ”_hex_nibbË
((
c
 >> 8) & 0xF);

562 *
x
++ = 
SŒšg_g’”ic
::
	`uµ”_hex_nibbË
((
c
 >> 4) & 0xF);

563 *
x
++ = 
SŒšg_g’”ic
::
	`uµ”_hex_nibbË
(
c
 & 0xF);

564 ià(
c
 > 255)

565 
s
 += 2;

569 
Ï¡
 = 
s
 + 1;

571  
Ï¡
;

572 
	}
}

574 
	g‹m¶©e
 <
ty³Çme
 
	gT
>em¶©<ty³Çm
	gE
>

575 
šlše
 
	gSŒšg_ba£
<
	gT
>::
	$’code_jsÚ
(
E
& 
’c
) const {

576 cÚ¡ * 
Ï¡
 = 
	`’code_jsÚ_·¹Ÿl
(
’c
);

577 
’c
.
	`­³nd
(
Ï¡
, 
	`’d
());

578 
	}
}

580 
	g‹m¶©e
 <
ty³Çme
 
	gT
>em¶©<ty³Çm
	gE
>

581 
	gSŒšg_ba£
<
	gT
>::
	$’code_ba£64
(
E
& 
’c
, 
boŞ
 
·d
) const {

582 * 
out
 = 
’c
.
	`»£rve
(((
	`Ëngth
() + 2) * 4) / 3);

583 cÚ¡ * 
s
 = 
this
->
	`ubegš
(), *
’d
 =his->
	`u’d
();

584 ; 
’d
 - 
s
 >= 3; s += 3) {

585 
x
 = (
s
[0] << 16) | (s[1] << 8) | s[2];

586 *
out
++ = 
SŒšg_g’”ic
::
ba£64_’codšg_bË
[
x
 >> 18];

587 *
out
++ = 
SŒšg_g’”ic
::
ba£64_’codšg_bË
[(
x
 >> 12) & 63];

588 *
out
++ = 
SŒšg_g’”ic
::
ba£64_’codšg_bË
[(
x
 >> 6) & 63];

589 *
out
++ = 
SŒšg_g’”ic
::
ba£64_’codšg_bË
[
x
 & 63];

591 ià(
’d
 > 
s
) {

592 
x
 = 
s
[0] << 16;

593 ià(
’d
 > 
s
 + 1)

594 
x
 |ğ
s
[1] << 8;

595 *
out
++ = 
SŒšg_g’”ic
::
ba£64_’codšg_bË
[
x
 >> 18];

596 *
out
++ = 
SŒšg_g’”ic
::
ba£64_’codšg_bË
[(
x
 >> 12) & 63];

597 ià(
’d
 > 
s
 + 1)

598 *
out
++ = 
SŒšg_g’”ic
::
ba£64_’codšg_bË
[(
x
 >> 6) & 63];

599 ià(
·d
)

600 *
out
++ = '=';

601 ià(
·d
)

602 *
out
++ = '=';

604 
’c
.
	`£t_’d
(
out
);

605 
	}
}

607 
	g‹m¶©e
 <
ty³Çme
 
	gT
>em¶©<ty³Çm
	gE
>

608 
boŞ
 
	gSŒšg_ba£
<
	gT
>::
	$decode_ba£64
(
E
& 
’c
) const {

609 * 
out
 = 
’c
.
	`»£rve
((
	`Ëngth
() * 3) / 4 + 1);

610 cÚ¡ * 
s
 = 
this
->
	`ubegš
(), *
’d
 =his->
	`u’d
();

611 
’d
 > 
s
 &&ƒnd[-1] == '=')

612 --
’d
;

613 ; 
’d
 - 
s
 >= 4; s += 4) {

614 
x
 = ((((è
SŒšg_g’”ic
::
ba£64_decodšg_m­
[
s
[0]]) - 1) << 18)

615 | ((((è
SŒšg_g’”ic
::
ba£64_decodšg_m­
[
s
[1]]) - 1) << 12)

616 | ((((è
SŒšg_g’”ic
::
ba£64_decodšg_m­
[
s
[2]]) - 1) << 6)

617 | (((è
SŒšg_g’”ic
::
ba£64_decodšg_m­
[
s
[3]]) - 1);

618 ià((è
x
 < 0)

619  
çl£
;

620 *
out
++ = (è(
x
 >> 16);

621 *
out
++ = (è(
x
 >> 8);

622 *
out
++ = (è
x
;

624 ià(
’d
 - 
s
 >= 2) {

625 
x
 = ((((è
SŒšg_g’”ic
::
ba£64_decodšg_m­
[
s
[0]]) - 1) << 18)

626 | ((((è
SŒšg_g’”ic
::
ba£64_decodšg_m­
[
s
[1]]) - 1) << 12)

627 | (
’d
 - 
s
 =ğ3 ? (((è
SŒšg_g’”ic
::
ba£64_decodšg_m­
[s[2]]) - 1) << 6 : 0);

628 ià((è
x
 < 0)

629  
çl£
;

630 *
out
++ = (è(
x
 >> 16);

631 ià(
’d
 - 
s
 == 3)

632 *
out
++ = (è(
x
 >> 8);

633 } ià(
’d
 - 
s
)

634  
çl£
;

635 
’c
.
	`£t_’d
(
out
);

636  
Œue
;

637 
	}
}

639 
	g‹m¶©e
 <
ty³Çme
 
	gT
>em¶©<ty³Çm
	gE
>

640 
	gSŒšg_ba£
<
	gT
>::
	$’code_uri_compÚ’t
(
E
& 
’c
) const {

641 cÚ¡ *
Ï¡
 = 
this
->
	`begš
(), *
’d
 =his->
	`’d
();

642 
’c
.
	`»£rve
(
’d
 - 
Ï¡
);

643 cÚ¡ *
s
 = 
Ï¡
; s !ğ
’d
; ++s) {

644 
c
 = (è*
s
;

645 ià(
	`i§Êum
(
c
) || c == '-' || c == '_' || c == '.' || c == '~')

647 
’c
.
	`­³nd
(
Ï¡
, 
s
);

648 * 
x
 = 
’c
.
	`ex‹nd
(3);

649 *
x
++ = '%';

650 *
x
++ = 
SŒšg_g’”ic
::
	`uµ”_hex_nibbË
(
c
 >> 4);

651 *
x
++ = 
SŒšg_g’”ic
::
	`uµ”_hex_nibbË
(
c
 & 0xF);

652 
Ï¡
 = 
s
 + 1;

654 
’c
.
	`­³nd
(
Ï¡
, 
’d
);

655 
	}
}

	@masstree-beta/string_slice.cc

16 
	~"¡ršg_¦iû.hh
"

	@masstree-beta/string_slice.hh

16 #iâdeà
STRING_SLICE_HH


17 
	#STRING_SLICE_HH
 1

	)

18 
	~"¡r.hh
"

19 
	~<®gÜ™hm
>

20 
	~<as£¹.h
>

21 
	~<¡ršg.h
>

22 
şass
 
	gth»adšfo
;

25 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	s¡ršg_¦iû
 {

26 
	m´iv©e
:

27 
	uuniÚ_ty³
 {

28 
T
 
x
;

29 
	ms
[(
T
)];

30 
uniÚ_ty³
(
T
 
x
)

31 : 
x
(x) {

35 
	mpublic
:

36 
T
 
	tty³
;

39 
cÚ¡ex´
 
	msize
 = (è(
T
);

42 
T
 
make
(cÚ¡ *
s
, 
Ën
) {

43 ià(
	mËn
 <= 0)

45 #ià
HAVE_UNALIGNED_ACCESS


46 ià(
	mËn
 >ğ
size
)

47  *
»š‹½»t_ÿ¡
<cÚ¡ 
T
 *>(
s
);

49 
uniÚ_ty³
 
u
(0);

50 
memıy
(
u
.
s
, s, 
¡d
::
mš
(
Ën
, 
size
));

51  
	mu
.
	mx
;

61 
T
 
make_com·¿bË
(cÚ¡ *
s
, 
Ën
) {

62  
Ãt_to_ho¡_Üd”
(
make
(
s
, 
Ën
));

72 
T
 
make_¦İpy
(cÚ¡ *
s
, 
Ën
) {

73 ià(
	mËn
 <= 0)

75 #ià
HAVE_UNALIGNED_ACCESS


76 ià(
	mËn
 >ğ
size
)

77  *
»š‹½»t_ÿ¡
<cÚ¡ 
T
 *>(
s
);

78 #ià
WORDS_BIGENDIAN


79  *
	m»š‹½»t_ÿ¡
<cÚ¡ 
	mT
 *>(
	ms
è& (~
T
(0è<< (8 * (
	msize
 - 
	mËn
)));

80 #–ià
WORDS_BIGENDIAN_SET


81  *
	m»š‹½»t_ÿ¡
<cÚ¡ 
	mT
 *>(
	ms
 - (
	msize
 - 
	mËn
)) >> (8 * (size -†en));

86 
uniÚ_ty³
 
u
(0);

87 
memıy
(
u
.
s
, s, 
¡d
::
mš
(
Ën
, 
size
));

88  
	mu
.
	mx
;

99 
T
 
make_com·¿bË_¦İpy
(cÚ¡ *
s
, 
Ën
) {

100  
Ãt_to_ho¡_Üd”
(
make_¦İpy
(
s
, 
Ën
));

111 
uÅ¬£_com·¿bË
(*
buf
, 
buæ’
, 
T
 
v®ue
) {

112 
uniÚ_ty³
 
u
(
ho¡_to_Ãt_Üd”
(
v®ue
));

113 
	ml
 = 
size
;

114 
	ml
 > 0 && 
	mu
.
	ms
[
l
 - 1] == 0)

115 --
l
;

116 
	ml
 = 
¡d
::
mš
(
l
, 
buæ’
);

117 
memıy
(
buf
, 
u
.
s
, 
l
);

118  
	ml
;

127 
uÅ¬£_com·¿bË
(*
buf
, 
buæ’
, 
T
 
v®ue
, 
Ën
) {

128 
uniÚ_ty³
 
u
(
ho¡_to_Ãt_Üd”
(
v®ue
));

129 
	ml
 = 
¡d
::
mš
(¡d::mš(
Ën
, 
size
), 
buæ’
);

130 
memıy
(
buf
, 
u
.
s
, 
l
);

131  
	ml
;

145 
boŞ
 
equ®s_¦İpy
(cÚ¡ *
a
, cÚ¡ *
b
, 
Ën
) {

146 #ià
HAVE_UNALIGNED_ACCESS


147 ià(
	mËn
 <ğ
size
) {

148 
ty³Çme
 
mass
::
make_unsigÃd
<
T
>::
ty³
 
d–


149 ğ*
»š‹½»t_ÿ¡
<cÚ¡ 
T
 *>(
a
)

150 ^ *
»š‹½»t_ÿ¡
<cÚ¡ 
T
 *>(
b
);

151 ià(
uÆik–y
(
Ën
 <= 0))

152  
Œue
;

153 #ià
WORDS_BIGENDIAN


154  (
	md–
 >> (8 * (
	msize
 - 
	mËn
))) == 0;

156  (
	md–
 << (8 * (
	msize
 - 
	mËn
))) == 0;

160  
memcmp
(
a
, 
b
, 
Ën
) == 0;

164 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
cÚ¡ex´
 
	g¡ršg_¦iû
<T>::
size
;

	@masstree-beta/stringbag.hh

16 #iâdeà
STRINGBAG_HH


17 
	#STRINGBAG_HH
 1

	)

18 
	~"comp”.hh
"

19 
	~"¡ršg_¦iû.hh
"

41 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

42 şas 
	c¡ršgbag
 {

43 
	mpublic
:

45 
T
 
	toff£t_ty³
;

46 
	m¡ršg_¦iû
<
	tušŒ_t
> 
	t¦iû_ty³
;

48 
	m´iv©e
:

49 
	sšfo_ty³
 {

50 
off£t_ty³
 
pos
;

51 
off£t_ty³
 
	mËn
;

52 
šfo_ty³
(
p
, 
l
)

53 : 
pos
(
p
), 
Ën
(
l
) {

57 
	gpublic
:

59 
cÚ¡ex´
 
	$max_size
() {

60  ((è(
off£t_ty³
) -1) + 1;

61 
	}
}

65 
cÚ¡ex´
 
size_t
 
	$ov”h—d
(
width
) {

66  (
¡ršgbag
<
T
>è+ 
width
 * (
šfo_ty³
);

67 
	}
}

71 
cÚ¡ex´
 
size_t
 
	$§ã_size
(
width
, 
Ën
) {

72  
	`ov”h—d
(
width
è+ 
Ën
 + 
¦iû_ty³
::
size
 - 1;

73 
	}
}

85 
	$¡ršgbag
(
width
, 
size_t
 
ÿ·c™y
) {

86 
size_t
 
fœ¡pos
 = 
	`ov”h—d
(
width
);

87 
	`as£¹
(
ÿ·c™y
 >ğ
fœ¡pos
 && c­ac™y <ğ
	`max_size
());

88 
size_
 = 
fœ¡pos
;

89 
ÿ·c™y_
 = 
ÿ·c™y
 - 1;

90 
	`mem£t
(
šfo_
, 0, (
šfo_ty³
è* 
width
);

91 
	}
}

94 
size_t
 
	$ÿ·c™y
() const {

95  
ÿ·c™y_
 + 1;

96 
	}
}

98 
size_t
 
	$u£d_ÿ·c™y
() const {

99  
size_
;

100 
	}
}

104 
	glcdf
::
SŒ
 
İ”©Ü
[](
p
) const {

105 
šfo_ty³
 
šfo
 = 
šfo_
[
p
];

106  
	glcdf
::
SŒ
(
s_
 + 
šfo
.
pos
, info.
Ën
);

110 
	glcdf
::
SŒ
 
	$g‘
(
p
) const {

111 
šfo_ty³
 
šfo
 = 
šfo_
[
p
];

112  
lcdf
::
	`SŒ
(
s_
 + 
šfo
.
pos
, info.
Ën
);

113 
	}
}

122 
boŞ
 
	$assign
(
p
, cÚ¡ *
s
, 
Ën
) {

123 
pos
, 
myËn
 = 
šfo_
[
p
].
Ën
;

124 ià(
myËn
 >ğ(è
Ën
)

125 
pos
 = 
šfo_
[
p
].pos;

126 ià(
size_
 + (è
¡d
::
	`max
(
Ën
, 
¦iû_ty³
::
size
)

127 <ğ
	`ÿ·c™y
()) {

128 
pos
 = 
size_
;

129 
size_
 +ğ
Ën
;

131  
çl£
;

132 
	`memıy
(
s_
 + 
pos
, 
s
, 
Ën
);

133 
šfo_
[
p
] = 
	`šfo_ty³
(
pos
, 
Ën
);

134  
Œue
;

135 
	}
}

137 
boŞ
 
	$assign
(
p
, 
lcdf
::
SŒ
 
s
) {

138  
	`assign
(
p
, 
s
.s, s.
Ën
);

139 
	}
}

142 
	$´št
(
width
, 
FILE
 *
f
, cÚ¡ *
´efix
, 
šd’t
) {

143 
	`årštf
(
f
, "%s%*s%°(%d:)%d:%d...\n", 
´efix
, 
šd’t
, "",

144 
this
, (è
	`ov”h—d
(
width
), 
size_
, 
	`ÿ·c™y
());

145 
i
 = 0; i < 
width
; ++i)

146 ià(
šfo_
[
i
].
Ën
)

147 
	`årštf
(
f
, "%s%*  #%x %u:%u %.*s\n", 
´efix
, 
šd’t
, "",

148 
i
, 
šfo_
[i].
pos
, info_[i].
Ën
, 
¡d
::
	`mš
(šfo_[i].Ën, 40U), 
s_
 + info_[i].pos);

149 
	}
}

151 
	g´iv©e
:

154 
off£t_ty³
 
size_
;

155 
off£t_ty³
 
	gÿ·c™y_
;

156 
šfo_ty³
 
	gšfo_
[0];

158 
	gs_
[0];

	@masstree-beta/test_atomics.cc

16 
	#FORCE_ENABLE_ASSERTIONS
 1

	)

17 #undeà
NDEBUG


18 
	~"comp”.hh
"

19 
	~<¡dlib.h
>

20 
	~<®gÜ™hm
>

21 
	~<sys/time.h
>

22 
	~<as£¹.h
>

23 
	~<¡dšt.h
>

24 
	~<¡dio.h
>

25 
	~<±h»ad.h
>

26 
	~<uni¡d.h
>

27 
	~"kv¿ndom.hh
"

28 
	~"¡ršg_¦iû.hh
"

29 
	~"k³rmu‹r.hh
"

30 
	~"v®ue_bag.hh
"

31 
	~"v®ue_¡ršg.hh
"

32 
	~"jsÚ.hh
"

33 
usšg
 
Çme¥aû
 
	glcdf
;

35 
ušt8_t
 
	gxb
[100];

36 
ušt16_t
 
	gxw
[100];

37 
ušt32_t
 
	gxl
[100];

39 
	sçke_th»adšfo
 {

40 * 
®loÿ‹
(
size_t
 
sz
, 
memg
 = 
memg_nÚe
) {

41  
Ãw
 [
sz
];

43 
d—Îoÿ‹
(* 
p
, 
size_t
, 
memg
 = 
memg_nÚe
) {

44 
d–‘e
[] 
»š‹½»t_ÿ¡
<*>(
p
);

49 
	umyuniÚ
 {

50 
ušt32_t
 
	mx
;

52 
	mÚe
 : 1;

53 
	mtwo
 : 2;

54 
	mth»e
 : 3;

56 } 
	gxuniÚ
;

58 
	$‹¡_©omics
() {

59 
ušt32_t
 
x
;

61 
xuniÚ
.
Úe
 = 1;

62 
	`as£¹
(
xuniÚ
.
x
 == 1);

64 
x
 = 
	`xchg
(&
xb
[0], 2);

65 
	`as£¹
(
x
 =ğ0 && 
xb
[0] == 2 && xb[1] == 0 && xb[2] == 0 && xb[3] == 0);

66 
x
 = 
	`xchg
(&
xb
[0], 3);

67 
	`as£¹
(
x
 =ğ2 && 
xb
[0] == 3 && xb[1] == 0 && xb[2] == 0 && xb[3] == 0);

69 
x
 = 
	`xchg
(&
xw
[0], 1);

70 
	`as£¹
(
x
 == 0);

72 
x
 = 
	`ãtch_ªd_add
(&
xl
[0], 100);

73 
	`as£¹
(
x
 =ğ0 && 
xl
[0] == 100);

74 
x
 = 
	`cmpxchg
(&
xl
[0], 100, 200);

75 
	`as£¹
(
x
 =ğ100 && 
xl
[0] == 200);

76 ià(
	`boŞ_cmpxchg
(&
xl
[0], 200, 300))

77 
xl
[1] = 400;

78 
	`as£¹
(
xl
[0] == 300 && xl[1] == 400);

79 ià(
	`boŞ_cmpxchg
(&
xl
[0], 400, 100))

80 
xl
[1] = 500;

81 
	`as£¹
(
xl
[0] == 300 && xl[1] == 400);

82 
	}
}

84 
	$‹¡_psdes_Ä
() {

85 
kv¿ndom_psdes_Ä
 
r
;

87 
ušt32_t
 
u
;

88 
f
;

89 } 
u
;

91 
r
.
	`»£t
(1);

92 
u
.u = 
r
.
	`Ãxt
();

93 
	`as£¹
(
u
.u == 0x509C0C23U);

94 
u
.u = 
r
[99];

95 
	`as£¹
(
u
.u == 0xA66CB41A);

97 
r
.
	`»£t
(99);

98 
u
.u = 
r
.
	`Ãxt
();

99 
	`as£¹
(
u
.u == 0x64300984);

100 
u
.u = 
r
[99];

101 
	`as£¹
(
u
.u == 0x59BA89EB);

102 
	}
}

104 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

105 
	$time_¿ndom
() {

106 
T
 
r
;

107 
ušt32_t
 
x
 = 0;

108 
i
 = 0; i < 1000000000; ++i)

109 
x
 ^ğ
r
.
	`Ãxt
();

110 
	`as£¹
(
x
 != 0);

111 
	}
}

113 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

114 
	$time_key¦iû
() {

115 *
b
 = (*è
	`m®loc
(4096);

116 
FILE
 *
f
 = 
	`fİ’
("/dev/urandom", "rb");

117 
ssize_t
 
¼
 = 
	`ä—d
(
b
, 1, 4096, 
f
);

118 
	`as£¹
(
¼
 == 4096);

119 
	`fşo£
(
f
);

120 
T
 
x
 = 0;

121 
kv¿ndom_lcg_Ä
 
r
;

122 
x
 ^ğ
¡ršg_¦iû
<
T
>::
	`make
(
b
, 1);

123 
i
 = 0; i < 1000000000; ++i)

124 
x
 ^ğ
¡ršg_¦iû
<
T
>::
	`make
(
b
 + 
r
.
	`Ãxt
() % 2048,„.next() % 16);

125 
	`as£¹
(
x
);

126 
	}
}

128 
	$‹¡_k³rmu‹r
() {

129 
k³rmu‹r
<15> 
	tk³rmu‹r_ty³
;

130 
k³rmu‹r_ty³
 
k
 = k³rmu‹r_ty³::
	`make_em±y
();

131 
i
 = 
k
.
	`š£¹_äom_back
(0);

132 
	`as£¹
(
k
.
	`size
(è=ğ1 && 
i
 == 0 && k[0] == 0);

133 
i
 = 
k
.
	`š£¹_äom_back
(0);

134 
	`as£¹
(
k
.
	`size
(è=ğ2 && 
i
 == 1 && k[0] == 1 && k[1] == 0);

135 
i
 = 
k
.
	`š£¹_äom_back
(2);

136 
	`as£¹
(
k
.
	`size
(è=ğ3 && 
i
 == 2 && k[0] == 1 && k[1] == 0 && k[2] == 2);

137 
k
.
	`»move
(1);

138 
	`as£¹
(
k
.
	`size
() == 2 && k[0] == 1 && k[1] == 2 && k[2] == 0);

139 
k
.
	`»move
(1);

140 
	`as£¹
(
k
.
	`size
() == 1 && k[0] == 1 && k[1] == 2 && k[2] == 0 && k[3] == 14);

141 
i
 = 
k
.
	`š£¹_äom_back
(0);

142 
	`as£¹
(
k
.
	`size
(è=ğ2 && 
i
 == 3 && k[0] == 3 && k[1] == 1 && k[2] == 2 && k[3] == 0 && k[4] == 14);

143 
k
.
	`š£¹_£Ëùed
(0, 3);

144 
	`as£¹
(
k
.
	`size
() == 3 && k[0] == 0 && k[1] == 3 && k[2] == 1 && k[3] == 2 && k[4] == 14);

145 
k
.
	`š£¹_£Ëùed
(2, 11);

146 
	`as£¹
(
k
.
	`size
() == 4 && k[0] == 0 && k[1] == 3 && k[2] == 7 && k[3] == 1 && k[4] == 2

147 && 
k
[5] == 14 && k[11] == 8 && k[12] == 6);

148 
k
.
	`š£¹_£Ëùed
(2, 14);

149 
	`as£¹
(
k
.
	`size
() == 5 && k[0] == 0 && k[1] == 3 && k[2] == 4 && k[3] == 7 && k[4] == 1 && k[5] == 2

150 && 
k
[6] == 14 && k[12] == 8 && k[13] == 6);

151 
k
.
	`exchªge
(0, 1);

152 
	`as£¹
(
k
.
	`size
() == 5 && k[0] == 3 && k[1] == 0 && k[2] == 4 && k[3] == 7 && k[4] == 1 && k[5] == 2

153 && 
k
[6] == 14 && k[12] == 8 && k[13] == 6);

154 
k
.
	`»move_to_back
(2);

155 
	`as£¹
(
k
.
	`size
() == 4 && k[0] == 3 && k[1] == 0 && k[2] == 7 && k[3] == 1 && k[4] == 2

156 && 
k
[5] == 14 && k[11] == 8 && k[12] == 6 && k[14] == 4);

157 
	`as£¹
(
k
.
	`back
() == 4);

158 
i
 = 
k
.
	`š£¹_äom_back
(2);

159 
	`as£¹
(
k
.
	`size
() == 5 && k[0] == 3 && k[1] == 0 && k[2] == 4 && k[3] == 7 && k[4] == 1 && k[5] == 2

160 && 
k
[6] =ğ14 && k[12] =ğ8 && k[13] =ğ6 && 
i
 == 4);

161 
k
.
	`exchªge
(0, 0);

162 
	`as£¹
(
k
.
	`size
() == 5 && k[0] == 3 && k[1] == 0 && k[2] == 4 && k[3] == 7 && k[4] == 1 && k[5] == 2

163 && 
k
[6] =ğ14 && k[12] =ğ8 && k[13] =ğ6 && 
i
 == 4);

165 
	`as£¹
(
	`fšd_lowe¡_z”o_nibbË
(0x0120U) == 0);

166 
	`as£¹
(
	`fšd_lowe¡_z”o_nibbË
(0x0123U) == 3);

167 
	`as£¹
(
	`fšd_lowe¡_z”o_nibbË
(0x12345678U) == -1);

169 
k³rmu‹r
<14> 
ka
 = k³rmu‹r<14>::
	`make_em±y
();

170 
i
 = 
ka
.
	`š£¹_äom_back
(0);

171 
	`as£¹
(
ka
.
	`size
(è=ğ1 && 
i
 == 0 && ka[0] == 0);

172 
i
 = 
ka
.
	`š£¹_äom_back
(0);

173 
	`as£¹
(
ka
.
	`size
(è=ğ2 && 
i
 == 1 && ka[0] == 1 && ka[1] == 0);

174 
i
 = 
ka
.
	`š£¹_äom_back
(2);

175 
	`as£¹
(
ka
.
	`size
(è=ğ3 && 
i
 == 2 && ka[0] == 1 && ka[1] == 0 && ka[2] == 2);

176 
ka
.
	`»move_to_back
(1);

177 
	`as£¹
(
ka
.
	`size
(è=ğ2 && ka[0] =ğ1 && ka[1] =ğ2 && ka.
	`back
() == 0);

178 
	}
}

180 
	$‹¡_¡ršg_¦iû
() {

181 
¡ršg_¦iû
<
	tušt32_t
> 
	tss_ty³
;

182 
	`as£¹
(
ss_ty³
::
	`make
("a", 1) == ss_type::make("aaa", 1));

183 
	`as£¹
(
ss_ty³
::
	`make_¦İpy
("0123abcdef" + 4, 1)

184 =ğ
ss_ty³
::
	`make_¦İpy
("bcdea01293" + 4, 1));

185 
	`as£¹
(
ss_ty³
::
	`make_com·¿bË
("a", 1) < ss_type::make_comparable("b", 1));

186 
	`as£¹
(
ss_ty³
::
	`equ®s_¦İpy
("0123abcdef" + 4, "abcdea02345" + 5, 1));

187 
	`as£¹
(
ss_ty³
::
	`make_com·¿bË
("abcd", 4) < ss_type::make_comparable("abce", 4));

188 
	`as£¹
(
ss_ty³
::
	`make_com·¿bË
("abce", 4) > ss_type::make_comparable("abcd", 4));

189 
	`as£¹
(
ss_ty³
::
	`equ®s_¦İpy
("0123abcdef" + 4, "abcdeabcd5" + 5, 4));

190 
	`as£¹
(!
ss_ty³
::
	`equ®s_¦İpy
("0123abcdef" + 4, "abcdeabcd5" + 5, 5));

191 
	`as£¹
(
	`SŒšg
("12345").
	`fšd_right
("") == 5);

192 
	`as£¹
(
	`SŒšg
("12345").
	`fšd_right
("5") == 4);

193 
	`as£¹
(
	`SŒšg
("12345").
	`fšd_right
("23") == 1);

194 
	`as£¹
(
	`SŒšg
("12345", 0).
	`fšd_right
("23") == -1);

195 
	}
}

197 
	$‹¡_¡ršg_bag
() {

198 
çke_th»adšfo
 
ti
;

199 
v®ue_bag
<
	tušt16_t
> 
	tbag_t
;

200 
bag_t
 
eb
;

201 ià(
eb
.
	`size
(è> (
bag_t
))

202 
	`årštf
(
¡d”r
, "size ¬off: %zu vs. %zu\n", 
eb
.
	`size
(), (
bag_t
));

203 
	`as£¹
(
eb
.
	`size
(è<ğ(
bag_t
));

204 
bag_t
* 
b
 = 
eb
.
	`upd©e
(0, 
	`SŒ
("A", 1), 1, 
ti
);

205 
	`as£¹
(
b
->
	`row_¡ršg
(è=ğ
	`SŒ
("\001\000\006\000\007\000A", 7));

206 
	`as£¹
(
b
->
	`ncŞ
() == 1);

207 
	`as£¹
(
b
->
	`cŞ
(0è=ğ
	`SŒ
("A", 1));

209 
bag_t
* 
bx
 = bag_t::
	`ü—‹1
(
	`SŒ
("A", 1), 1, 
ti
);

210 
	`as£¹
(
bx
->
	`row_¡ršg
(è=ğ
b
->row_string());

211 
bx
->
	`d—Îoÿ‹
(
ti
);

213 
bag_t
 *
bb
 = 
b
->
	`upd©e
(1, 
	`SŒ
("BB", 2), 2, 
ti
);

214 
b
->
	`d—Îoÿ‹
(
ti
);

215 
b
 = 
bb
;

216 
	`as£¹
(
b
->
	`row_¡ršg
(è=ğ
	`SŒ
("\002\000"

219 
	`as£¹
(
b
->
	`ncŞ
() == 2);

220 
	`as£¹
(
b
->
	`cŞ
(0è=ğ
	`SŒ
("A", 1));

221 
	`as£¹
(
b
->
	`cŞ
(1è=ğ
	`SŒ
("BB", 2));

223 
bb
 = 
b
->
	`upd©e
(3, 
	`SŒ
("CCC", 3), 3, 
ti
);

224 
b
->
	`d—Îoÿ‹
(
ti
);

225 
b
 = 
bb
;

226 
	`as£¹
(
b
->
	`row_¡ršg
(è=ğ
	`SŒ
("\004\000"

229 
	`as£¹
(
b
->
	`ncŞ
() == 4);

230 
	`as£¹
(
b
->
	`cŞ
(0è=ğ
	`SŒ
("A", 1));

231 
	`as£¹
(
b
->
	`cŞ
(1è=ğ
	`SŒ
("BB", 2));

232 
	`as£¹
(
b
->
	`cŞ
(2è=ğ
	`SŒ
("", 0));

233 
	`as£¹
(
b
->
	`cŞ
(3è=ğ
	`SŒ
("CCC", 3));

235 
bb
 = 
b
->
	`upd©e
(1, 
	`SŒ
("bbb", 3), 4, 
ti
);

236 
b
->
	`d—Îoÿ‹
(
ti
);

237 
b
 = 
bb
;

238 
	`as£¹
(
b
->
	`row_¡ršg
(è=ğ
	`SŒ
("\004\000"

241 
	`as£¹
(
b
->
	`ncŞ
() == 4);

242 
	`as£¹
(
b
->
	`cŞ
(0è=ğ
	`SŒ
("A", 1));

243 
	`as£¹
(
b
->
	`cŞ
(1è=ğ
	`SŒ
("bbb", 3));

244 
	`as£¹
(
b
->
	`cŞ
(2è=ğ
	`SŒ
("", 0));

245 
	`as£¹
(
b
->
	`cŞ
(3è=ğ
	`SŒ
("CCC", 3));

247 
bb
 = 
b
->
	`upd©e
(0, 
	`SŒ
("a", 1), 4, 
ti
);

248 
b
->
	`d—Îoÿ‹
(
ti
);

249 
b
 = 
bb
;

250 
	`as£¹
(
b
->
	`row_¡ršg
(è=ğ
	`SŒ
("\004\000"

253 
	`as£¹
(
b
->
	`ncŞ
() == 4);

254 
	`as£¹
(
b
->
	`cŞ
(0è=ğ
	`SŒ
("a", 1));

255 
	`as£¹
(
b
->
	`cŞ
(1è=ğ
	`SŒ
("bbb", 3));

256 
	`as£¹
(
b
->
	`cŞ
(2è=ğ
	`SŒ
("", 0));

257 
	`as£¹
(
b
->
	`cŞ
(3è=ğ
	`SŒ
("CCC", 3));

259 
bb
 = 
b
->
	`upd©e
(1, 
	`SŒ
("", 0), 4, 
ti
);

260 
b
->
	`d—Îoÿ‹
(
ti
);

261 
b
 = 
bb
;

262 
	`as£¹
(
b
->
	`row_¡ršg
(è=ğ
	`SŒ
("\004\000"

265 
	`as£¹
(
b
->
	`ncŞ
() == 4);

266 
	`as£¹
(
b
->
	`cŞ
(0è=ğ
	`SŒ
("a", 1));

267 
	`as£¹
(
b
->
	`cŞ
(1è=ğ
	`SŒ
("", 0));

268 
	`as£¹
(
b
->
	`cŞ
(2è=ğ
	`SŒ
("", 0));

269 
	`as£¹
(
b
->
	`cŞ
(3è=ğ
	`SŒ
("CCC", 3));

271 
b
->
	`d—Îoÿ‹
(
ti
);

272 
	}
}

274 
	$‹¡_jsÚ
()

276 
JsÚ
 
j
;

277 
	`as£¹
(
j
.
	`em±y
());

278 
	`as£¹
(!
j
);

280 
j
 = 
JsÚ
::
	`make_objeù
();

281 
	`as£¹
(
j
.
	`em±y
());

282 
	`as£¹
(
j
);

284 
j
.
	`£t
("foo", "bar");

285 
	`as£¹
(
j
["foo"]);

286 
	`as£¹
(
j
["foo"].
	`to_s
() == "bar");

287 
	`as£¹
(
j
.
	`size
() == 1);

289 
j
.
	`£t
("baz", "flim");

290 
	`as£¹
(
j
.
	`size
() == 2);

291 
	`as£¹
(
j
.
	`uÅ¬£
() == "{\"foo\":\"bar\",\"baz\":\"flim\"}");

293 
j
.
	`”a£
("foo");

294 
	`as£¹
(
j
.
	`size
() == 1);

296 
j
.
	`assign_·r£
("2");

297 
	`as£¹
(
j
 == 2);

299 
j
.
	`assign_·r£
("null");

300 
	`as£¹
(
j
 =ğ
	`JsÚ
());

302 
j
.
	`assign_·r£
("\"a\"");

303 
	`as£¹
(
j
 == "a");

305 
j
.
	`assign_·r£
("[1,2]");

306 
	`as£¹
(
j
.
	`uÅ¬£
() == "[1,2]");

308 
j
.
	`assign_·r£
("[[[]],{\"a\":{}}]");

309 
	`as£¹
(
j
.
	`uÅ¬£
() == "[[[]],{\"a\":{}}]");

311 
j
 = 
JsÚ
::
	`·r£
("{\"x22\":{\n\
\"git-revision\":\"ebbd3d4767847300f552b181a10bda57a926f554M\",\n\
\"time\":\"Tue Feb 7 20:20:33 2012\",\n\
\"machine\":\"rtshanks-laptop\",\n\
\"cores\":2,\n\
\"runs\":[\"x22\\/rw2\\/mb\\/0\"]\n\
},\n\
\"x23\":{\n\
\"git-revision\":\"ebbd3d4767847300f552b181a10bda57a926f554M\",\n\
\"time\":\"Tue Feb 7 20:31:05 2012\",\n\
\"machine\":\"rtshanks-laptop\",\n\
\"cores\":2,\n\
\"runs\":[\"x23\\/rw2\\/mb\\/0\",\"x23\\/rw1\\/mb\\/0\",\"x23\\/rw3\\/mb\\/0\"]\n\
},\n\
\"x24\":{\n\
\"git-revision\":\"62e9970ca8ae9c6eebf2d71b7065ea694fb25282M\",\n\
\"time\":\"Sat Feb 11 15:54:01 2012\",\n\
\"machine\":\"rtshanks-laptop\",\n\
\"cores\":2,\n\
\"runs\":[\"x24\\/rw1\\/b\\/0\"]\n\
},\"b\":\"c\",\"c\":\"d\"}");

332 
	`as£¹
(
j
["x22"]["time"] == "Tue Feb 7 20:20:33 2012");

333 
	`as£¹
(
j
["x22"]["cores"] == 2);

335 
JsÚ
::
objeù_™”©Ü
 
™
 = 
j
.
	`obegš
();

336 
	`as£¹
(
™
.
	`key
() == "x22");

337 ++
™
;

338 
	`as£¹
(
™
.
	`key
() == "x23");

339 ++
™
;

340 
	`as£¹
(
™
.
	`key
() == "x24");

341 ++
™
;

342 
	`as£¹
(
™
.
	`key
() == "b");

343 ++
™
;

344 
	`as£¹
(
™
.
	`key
() == "c");

348 
JsÚ
 
jcİy
 = 
j
;

349 
	`as£¹
(
j
.
	`size
() == 5);

350 
couÁ
 = 0;

351 
JsÚ
::
™”©Ü
 
™
 = 
jcİy
.
	`begš
(); iˆ!ğjcİy.
	`’d
(); ++it) {

352 
™
->
£cÚd
 = 
	`JsÚ
();

353 ++
couÁ
;

355 
	`as£¹
(!
jcİy
["x22"]);

356 
	`as£¹
(
j
["x22"]["cores"] == 2);

357 
	`as£¹
(
couÁ
 =ğ
jcİy
.
	`size
());

360 
	`as£¹
(!
j
["x49"]);

361 
	`as£¹
(
j
.
	`size
() == 5);

362 
	`as£¹
(!
j
["x49"]["45"][2]["a"]);

363 
	`as£¹
(
j
.
	`size
() == 5);

364 
j
["x49"]["45"][2]["a"] = 1;

365 
	`as£¹
(
j
.
	`size
() == 6);

366 
	`as£¹
(
j
["x22"].
	`is_objeù
(è&& j.
	`g‘
("x22").is_object());

367 
	`as£¹
(
j
["x23"].
	`is_objeù
(è&& j.
	`g‘
("x23").is_object());

368 
	`as£¹
(
j
["b"].
	`is_¡ršg
(è&& j.
	`g‘
("b").is_string());

369 
	`as£¹
(
j
["x49"].
	`is_objeù
(è&& j.
	`g‘
("x49").is_object());

370 
	`as£¹
(
j
["x49"]["45"].
	`is_¬¿y
());

371 
	`as£¹
(
j
["x49"]["45"].
	`size
(è=ğ3 && j["x49"]["45"][2].
	`is_objeù
());

373 
j
 = 
JsÚ
::
	`make_objeù
();

374 
j
["a"] = j["b"];

375 
	`as£¹
(
j
.
	`size
() == 1);

376 
	`as£¹
(
j
["a"].
	`is_nuÎ
());

377 
	`as£¹
(
j
.
	`couÁ
("a") == 1);

379 
j
 = 
JsÚ
::
	`make_objeù
();

380 
JsÚ
 
k
 = JsÚ::
	`make_¬¿y
();

381 
j
["a"] = 
k
[2];

382 
	`as£¹
(
j
.
	`size
() == 1);

383 
	`as£¹
(
k
.
	`size
() == 0);

384 
	`as£¹
(
j
["a"].
	`is_nuÎ
());

385 
	`as£¹
(
j
.
	`couÁ
("a") == 1);

387 
j
 = 
	`JsÚ
(1);

388 
	`as£¹
(
j
.
	`g‘
("a").
	`is_nuÎ
());

390 
j
.
	`assign_·r£
("{\"a\":1,\"b\":true,\"c\":\"\"}");

392 
i
 = 0;

393 
boŞ
 
b
 = 
çl£
;

394 
SŒšg
 
s
;

395 
	`as£¹
(
j
.
	`g‘
("a", 
i
));

396 
	`as£¹
(
i
 == 1);

397 
	`as£¹
(
j
.
	`g‘
("a", 
i
).g‘("b", 
b
));

398 
	`as£¹
(
b
 =ğ
Œue
);

399 
	`as£¹
(!
j
.
	`g‘
("a", 
s
).
	`¡©us
());

400 
	`as£¹
(!
j
.
	`g‘
("a", 
s
).
	`¡©us
(
b
));

401 
	`as£¹
(
b
 =ğ
çl£
);

402 
	`as£¹
(
j
.
	`g‘
("a", 
k
));

403 
	`as£¹
(
k
 =ğ
	`JsÚ
(1));

404 
	`as£¹
(!
j
.
	`g‘
("cc", 
k
));

407 
j
["a"] = 
	`JsÚ
(5);

408 
j
.
	`£t
("a", 
	`JsÚ
(5));

409 
j
["b"] = 
JsÚ
::
	`·r£
("[]");

410 
	}
}

412 
	$‹¡_v®ue_upd©es
() {

413 
çke_th»adšfo
 
ti
;

414 
v®ue_bag
<
	tušt16_t
> 
	tbag_t
;

415 
v®ue_¡ršg
 
	tv¡r_t
;

416 
bag_t
* 
eb
 = 
	`Ãw
(
ti
.
	`®loÿ‹
((bag_t))) bag_t;

417 
v¡r_t
* 
¡rb
 = 
	`Ãw
(
ti
.
	`®loÿ‹
((vstr_t))) vstr_t;

419 
JsÚ
 
bagupd©e
 = JsÚ::
	`¬¿y
(0, "ABC", 1, "def", 2, "EGHIJ", 3, "klm");

421 
JsÚ
 
¡rupd©e
 = JsÚ::
	`¬¿y
(
v¡r_t
::
	`make_šdex
(0, 3), "ABC",

422 
v¡r_t
::
	`make_šdex
(3, 3), "def",

423 
v¡r_t
::
	`make_šdex
(6, 5), "EGHIJ",

424 
v¡r_t
::
	`make_šdex
(11, 3), "klm");

427 
bag_t
* 
eb2
 = 
eb
->
	`upd©e
(
bagupd©e
.
	`¬¿y_d©a
(), bagupd©e.
	`’d_¬¿y_d©a
(), 1, 
ti
);

428 
eb
->
	`d—Îoÿ‹
(
ti
);

429 
eb
 = 
eb2
;

430 
	`as£¹
(
eb
->
	`cŞ
(0è=ğ
	`SŒ
("ABC"));

431 
	`as£¹
(
eb
->
	`cŞ
(1è=ğ
	`SŒ
("def"));

432 
	`as£¹
(
eb
->
	`cŞ
(2è=ğ
	`SŒ
("EGHIJ"));

433 
	`as£¹
(
eb
->
	`cŞ
(3è=ğ
	`SŒ
("klm"));

437 
v¡r_t
* 
¡rb2
 = 
¡rb
->
	`upd©e
(
¡rupd©e
.
	`¬¿y_d©a
(), sŒupd©e.
	`’d_¬¿y_d©a
(), 1, 
ti
);

438 
¡rb
->
	`d—Îoÿ‹
(
ti
);

439 
¡rb
 = 
¡rb2
;

440 
	`as£¹
(
¡rb
->
	`cŞ
(
v¡r_t
::
	`make_šdex
(0, 3)è=ğ
	`SŒ
("ABC"));

441 
	`as£¹
(
¡rb
->
	`cŞ
(
v¡r_t
::
	`make_šdex
(3, 3)è=ğ
	`SŒ
("def"));

442 
	`as£¹
(
¡rb
->
	`cŞ
(
v¡r_t
::
	`make_šdex
(6, 5)è=ğ
	`SŒ
("EGHIJ"));

443 
	`as£¹
(
¡rb
->
	`cŞ
(
v¡r_t
::
	`make_šdex
(11, 3)è=ğ
	`SŒ
("klm"));

444 
	`as£¹
(
¡rb
->
	`cŞ
(0è=ğ
	`SŒ
("ABCdefEGHIJklm"));

447 
eb
->
	`d—Îoÿ‹
(
ti
);

448 
¡rb
->
	`d—Îoÿ‹
(
ti
);

449 
	}
}

451 
	$maš
(, *[])

456 
	`as£¹
(
	`iû_log2
(2) == 2);

457 
	`as£¹
(
	`iû_log2
(3) == 4);

458 
	`as£¹
(
	`iæoÜ_log2
(2) == 2);

459 
	`as£¹
(
	`iæoÜ_log2
(3) == 2);

461 
	`‹¡_k³rmu‹r
();

462 
	`‹¡_¡ršg_¦iû
();

463 
	`‹¡_¡ršg_bag
();

464 
	`‹¡_jsÚ
();

465 
	`‹¡_v®ue_upd©es
();

466 
¡d
::
cout
 << "Tests complete!\n";

468 
	}
}

	@masstree-beta/test_string.cc

16 
	~"¡ršg.hh
"

17 
	~<¡dio.h
>

18 
	~<as£¹.h
>

19 
	~<¡ršg.h
>

20 
	~<¡dlib.h
>

21 
	~"¡¿ccum.hh
"

23 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

24 
boŞ


25 
	$check_¡¿ccum_utf8
(
SŒšgAccum
 &
§
, cÚ¡ *
š
, 
šËn
,

26 cÚ¡ *
out
, 
ou’
)

28 
§
.
	`ş—r
();

29 
Encodšg
::
UTF8Encod”
<
T
> 
’cod”
;

30 
§
.
	`­³nd_’coded
(
’cod”
, 
š
, iÀ+ 
šËn
);

31  
§
.
	`Ëngth
(è=ğ
ou’
 && 
	`memcmp
(§.
	`begš
(), 
out
, sa.length()) == 0;

32 
	}
}

34 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

35 
boŞ


36 
	$check_¡¿ccum2_utf8
(
SŒšgAccum
 &
§
, cÚ¡ *
š
, 
šËn
,

37 cÚ¡ *
out
, 
ou’
)

39 
§
.
	`ş—r
();

40 
	`memıy
(
§
.
	`»£rve
(
šËn
), 
š
, inlen);

41 
Encodšg
::
UTF8Encod”
<
T
> 
’cod”
;

42 
§
.
	`­³nd_’coded
(
’cod”
, sa.
	`begš
(), sa.begš(è+ 
šËn
);

43  
§
.
	`Ëngth
(è=ğ
ou’
 && 
	`memcmp
(§.
	`begš
(), 
out
, sa.length()) == 0;

44 
	}
}

47 
	$maš
(
¬gc
, *
¬gv
[])

49 
	`as£¹
(
	`SŒšg
("abc").
	`to_utf8
() == "abc");

50 
	`as£¹
(
	`SŒšg
("").
	`to_utf8
() == "");

51 
	`as£¹
(
	`SŒšg
("ab\000cd", 5).
	`to_utf8
() == "abcd");

52 
	`as£¹
(
	`SŒšg
("\xc3\x9dHi!").
	`to_utf8
() == "\xc3\x9dHi!");

53 
	`as£¹
(
	`SŒšg
("\xddHi!").
	`to_utf8
() == "\xc3\x9dHi!");

54 
	`as£¹
(
	`SŒšg
("\xc3\x9dHi!\x9c").
	`to_utf8
() == "\xc3\x9dHi!\xc5\x93");

55 
	`as£¹
(
	`SŒšg
("ab\000c\x9c", 5).
	`to_utf8
() == "abc\xc5\x93");

56 
	`as£¹
(
	`SŒšg
("\xc3\x9dXY\000c\x9c", 7).
	`to_utf8
() == "\xc3\x9dXYc\xc5\x93");

58 
SŒšgAccum
 
§
;

59 
check_¡¿ccum_utf8
<
Encodšg
::
UTF8
>(
§
, "abc", 3, "abc", 3);

60 
check_¡¿ccum_utf8
<
Encodšg
::
UTF8
>(
§
, "", 0, "", 0);

61 
check_¡¿ccum_utf8
<
Encodšg
::
UTF8
>(
§
, "ab\000cd", 5, "ab\000cd", 5);

62 
check_¡¿ccum_utf8
<
Encodšg
::
UTF8NoNul
>(
§
, "ab\000cd", 5, "abcd", 4);

63 
check_¡¿ccum_utf8
<
Encodšg
::
UTF8
>(
§
, "\xc3\x9dHi!", 5, "\xc3\x9dHi!", 5);

64 
check_¡¿ccum_utf8
<
Encodšg
::
Wšdows1252
>(
§
, "\xddHi!", 4, "\xc3\x9dHi!", 5);

66 
check_¡¿ccum2_utf8
<
Encodšg
::
UTF8
>(
§
, "abc", 3, "abc", 3);

67 
check_¡¿ccum2_utf8
<
Encodšg
::
UTF8
>(
§
, "", 0, "", 0);

68 
check_¡¿ccum2_utf8
<
Encodšg
::
UTF8
>(
§
, "ab\000cd", 5, "ab\000cd", 5);

69 
check_¡¿ccum2_utf8
<
Encodšg
::
UTF8NoNul
>(
§
, "ab\000cd", 5, "abcd", 4);

70 
check_¡¿ccum2_utf8
<
Encodšg
::
UTF8
>(
§
, "\xc3\x9dHi!", 5, "\xc3\x9dHi!", 5);

71 
check_¡¿ccum2_utf8
<
Encodšg
::
Wšdows1252
>(
§
, "\xddHi!", 4, "\xc3\x9dHi!", 5);

73 ià(
¬gc
 == 2) {

74 
FILE
 *
f
;

75 ià(
	`¡rcmp
(
¬gv
[1], "-") == 0)

76 
f
 = 
¡dš
;

77 ià(!(
f
 = 
	`fİ’
(
¬gv
[1], "rb"))) {

78 
	`³¼Ü
("test_string");

79 
	`ex™
(1);

81 
SŒšgAccum
 
§
;

82 !
	`ãof
(
f
)) {

83 
size_t
 
x
 = 
	`ä—d
(
§
.
	`»£rve
(1024), 1, 1024, 
f
);

84 
§
.
	`adju¡_Ëngth
(
x
);

86 
SŒšg
 
s
 = 
§
.
	`ke_¡ršg
().
	`to_utf8
(SŒšg::
utf_¡r_bom
);

87 
	`fwr™e
(
s
.
	`d©a
(), 1, s.
	`Ëngth
(), 
¡dout
);

89 
	}
}

	@masstree-beta/testrunner.cc

16 
	~"‹¡ruÂ”.hh
"

17 
	~<®gÜ™hm
>

18 
	~<num”ic
>

19 
	~<veùÜ
>

21 
‹¡ruÂ”_ba£
* 
	g‹¡ruÂ”_ba£
::
theh—d
;

22 
‹¡ruÂ”_ba£
* 
	g‹¡ruÂ”_ba£
::
th‘a
;

24 
	g‹¡ruÂ”_ba£
::
	$´št_Çmes
(
FILE
* 
¡»am
, 
ncŞ
) {

25 
	`mas¡»e_´ecÚd™iÚ
(
ncŞ
 >= 1);

27 
¡d
::
veùÜ
<
lcdf
::
SŒšg
> 
Çmes
;

28 
‹¡ruÂ”_ba£
* 
Œ
 = 
theh—d
;r;¸ğŒ->
Ãxt_
)

29 
Çmes
.
	`push_back
(
Œ
->
	`Çme
());

31 
size_t
 
³rcŞ
;

32 
¡d
::
veùÜ
<> 
cŞwidth
;

34 
³rcŞ
 = (
Çmes
.
	`size
(è+ 
ncŞ
 - 1) /‚col;

35 
cŞwidth
.
	`assign
(
ncŞ
, 0);

36 
size_t
 
i
 = 0; i !ğ
Çmes
.
	`size
(); ++i)

37 
cŞwidth
[
i
/
³rcŞ
] = 
¡d
::
	`max
(cŞwidth[i/³rcŞ], 
Çmes
[i].
	`Ëngth
());

38 ià(
ncŞ
 == 1

39 || 
¡d
::
	`accumuÏ‹
(
cŞwidth
.
	`begš
(), cŞwidth.
	`’d
(), 0)

40 + 
ncŞ
 * 3 <= 78)

42 --
ncŞ
;

45 
size_t
 
row
 = 0;„ow !ğ
³rcŞ
; ++row) {

46 
size_t
 
off
 = 
row
;

47 
cŞ
 = 0; cŞ !ğ
ncŞ
; ++cŞ, 
off
 +ğ
³rcŞ
)

48 ià(
off
 < 
Çmes
.
	`size
())

49 
	`årštf
(
¡»am
, "%*s %s",

50 (è(
cŞ
 ? 
cŞwidth
[cŞ-1] - 
Çmes
[
off
-
³rcŞ
].
	`Ëngth
() : 0), "",

51 
Çmes
[
off
].
	`c_¡r
());

52 
	`årštf
(
¡»am
, "\n");

54 
	}
}

	@masstree-beta/testrunner.hh

1 #iâdeà
MASSTREE_TESTRUNNER_HH


2 
	#MASSTREE_TESTRUNNER_HH


	)

3 
	~"¡ršg.hh
"

4 
	~<¡dio.h
>

6 şas 
	c‹¡ruÂ”_ba£
 {

7 
	mpublic
:

8 
	$‹¡ruÂ”_ba£
(cÚ¡ 
lcdf
::
SŒšg
& 
Çme
)

9 : 
	`Çme_
(
Çme
), 
	$Ãxt_
(0) {

10 
theh—d
 ? 
th‘a
->
Ãxt_
 = 
this
 :hehead =his;

11 
th‘a
 = 
this
;

13 
vœtu®
 ~
	$‹¡ruÂ”_ba£
() {

14 
	}
}

15 cÚ¡ 
	glcdf
::
SŒšg
& 
	$Çme
() const {

16  
Çme_
;

17 
	}
}

18 
‹¡ruÂ”_ba£
* 
	$fœ¡
() {

19  
theh—d
;

20 
	}
}

21 
‹¡ruÂ”_ba£
* 
	$fšd
(cÚ¡ 
lcdf
::
SŒšg
& 
Çme
) {

22 
‹¡ruÂ”_ba£
* 
t
 = 
theh—d
;

23 
t
 &&->
Çme_
 !ğ
Çme
)

24 
t
 =->
Ãxt_
;

25  
t
;

26 
	}
}

27 
´št_Çmes
(
FILE
* 
¡»am
, 
maxcŞ
);

28 
	g´iv©e
:

29 
‹¡ruÂ”_ba£
* 
theh—d
;

30 
‹¡ruÂ”_ba£
* 
	gth‘a
;

31 
	glcdf
::
SŒšg
 
Çme_
;

32 
‹¡ruÂ”_ba£
* 
	gÃxt_
;

35 #ifdeà
TESTRUNNER_CLIENT_TYPE


37 şas 
	c‹¡ruÂ”
 : 
public
 
‹¡ruÂ”_ba£
 {

38 
public
:

39 
šlše
 
	$‹¡ruÂ”
(cÚ¡ 
lcdf
::
SŒšg
& 
Çme
)

40 : 
	$‹¡ruÂ”_ba£
(
Çme
) {

42 
‹¡ruÂ”
* 
	$fœ¡
() {

43  
¡©ic_ÿ¡
<
‹¡ruÂ”
*>(
‹¡ruÂ”_ba£
::
	`fœ¡
());

44 
	}
}

45 
‹¡ruÂ”
* 
	$fšd
(cÚ¡ 
lcdf
::
SŒšg
& 
Çme
) {

46  
¡©ic_ÿ¡
<
‹¡ruÂ”
*>(
‹¡ruÂ”_ba£
::
	`fšd
(
Çme
));

47 
	}
}

48 
vœtu®
 
run
(
TESTRUNNER_CLIENT_TYPE
) = 0;

51 
	#MAKE_TESTRUNNER
(
Çme
, 
‹xt
) \

52 
Çme¥aû
 { \

53 
şass
 
‹¡ruÂ”_
##
Çme
 : 
public
 
‹¡ruÂ”
 { \

54 
public
: \

55 
‹¡ruÂ”_
##
	`Çme
(è: 
	`‹¡ruÂ”
(#name) {} \

56 
	`run
(
TESTRUNNER_CLIENT_TYPE
 
ş›Á
è{ 
‹xt
; cl›Á.
	`fšish
(); } \

57 }; 
‹¡ruÂ”_
##
Çme
e¡ruÂ”_##Çme##
_š¡ªû
; }

	)

	@masstree-beta/timestamp.hh

16 #iâdeà
TIMESTAMP_HH


17 
	#TIMESTAMP_HH


	)

18 
	~"comp”.hh
"

19 
	~<time.h
>

20 
	~<sys/time.h
>

21 
	~<m©h.h
>

23 #ià
HAVE_INT64_T_IS_LONG_LONG


24 
	#PRIuKVTS
 "Îu"

	)

26 
	#PRIuKVTS
 "lu"

	)

28 
	#PRIKVTSPARTS
 "%lu.%06lu"

	)

30 
	#KVTS_HIGHPART
(
t
è((è(Ñè>> 32))

	)

31 
	#KVTS_LOWPART
(
t
è((è(
ušt32_t
èÑ))

	)

33 
ušt64_t
 
	tkvtime¡amp_t
;

35 
šlše
 
kvtime¡amp_t
 
	$time¡amp
() {

36 
timev®
 
tv
;

37 
	`g‘timeofday
(&
tv
, 0);

38  ((
kvtime¡amp_t
è
tv
.
tv_£c
 << 32è| (év.
tv_u£c
;

39 
	}
}

41 
šlše
 
kvtime¡amp_t
 
	$time¡amp_sub
(
kvtime¡amp_t
 
a
, kvtime¡amp_ˆ
b
) {

42 
a
 -ğ
b
;

43 ià(
	`KVTS_LOWPART
(
a
) > 999999)

44 
a
 -ğ((
kvtime¡amp_t
) 1 << 32) - 1000000;

45  
a
;

46 
	}
}

48 
kvtime¡amp_t
 
š™Ÿl_time¡amp
;

50 
šlše
 
	$now
() {

51 
timev®
 
tv
;

52 
	`g‘timeofday
(&
tv
, 0);

53  
tv
.
tv_£c
 +v.
tv_u£c
 / 1000000.0;

54 
	}
}

56 
šlše
 
	gtime¥ec
 &
	$£t_time¥ec
(
time¥ec
 &
x
, 
y
) {

57 
¬t
 = 
	`æoÜ
(
y
);

58 
x
.
tv_£c
 = (è
¬t
;

59 
x
.
tv_n£c
 = (è((
y
 - 
¬t
) * 1e9);

60  
x
;

61 
	}
}

	@masstree-beta/unit-mt.cc

1 
	~<io¡»am
>

2 
	~<¿ndom
>

3 
	~<veùÜ
>

4 
	~<th»ad
>

6 
	~<±h»ad.h
>

8 
	~"cÚfig.h
"

9 
	~"comp”.hh
"

11 
	~"mas¡»e.hh
"

12 
	~"kvth»ad.hh
"

13 
	~"mas¡»e_tcursÜ.hh
"

14 
	~"mas¡»e_š£¹.hh
"

15 
	~"mas¡»e_´št.hh
"

16 
	~"mas¡»e_»move.hh
"

17 
	~"mas¡»e_sÿn.hh
"

18 
	~"mas¡»e_¡©s.hh
"

19 
	~"¡ršg.hh
"

21 
	#NUM_THREADS
 64

	)

23 şas 
	ckey_uÅ¬£_unsigÃd
 {

24 
	mpublic
:

25 
uÅ¬£_key
(
Mas¡»e
::
key
<
ušt64_t
> key, * 
buf
, 
buæ’
) {

26  
¢´štf
(
buf
, 
buæ’
, "%" 
PRIu64
, 
key
.
ikey
());

30 şas 
	cMas¡»eW¿µ”
 {

31 
	mpublic
:

32 
cÚ¡ex´
 
ušt64_t
 
š£¹_bound
 = 0xfffff;

33 
	mbË_·¿ms
 : 
public
 
Mas¡»e
::
nod•¬ams
<15,15> {

34 
ušt64_t
 
	tv®ue_ty³
;

35 
	mMas¡»e
::
	tv®ue_´št
<
	tv®ue_ty³
> 
	tv®ue_´št_ty³
;

36 
th»adšfo
 
	tth»adšfo_ty³
;

37 
key_uÅ¬£_unsigÃd
 
	tkey_uÅ¬£_ty³
;

38 
cÚ¡ex´
 
ssize_t
 
	m´št_max_šd’t_d•th
 = 12;

41 
	gMas¡»e
::
	tSŒ
 Str;

42 
	gMas¡»e
::
	tbasic_bË
<
	tbË_·¿ms
> 
	tbË_ty³
;

43 
	gMas¡»e
::
	tuÆocked_tcursÜ
<
	tbË_·¿ms
> 
	tuÆocked_cursÜ_ty³
;

44 
	gMas¡»e
::
	ttcursÜ
<
	tbË_·¿ms
> 
	tcursÜ_ty³
;

45 
	gMas¡»e
::
	tËaf
<
	tbË_·¿ms
> 
	tËaf_ty³
;

46 
	gMas¡»e
::
	tš‹ºode
<
	tbË_·¿ms
> 
	tš‹ºode_ty³
;

48 
ty³Çme
 
	tbË_ty³
::
	tnode_ty³
‚ode_type;

49 
ty³Çme
 
	tuÆocked_cursÜ_ty³
::
	tnodev”siÚ_v®ue_ty³
‚odeversion_value_type;

51 
__th»ad
 
ty³Çme
 
	gbË_·¿ms
::
th»adšfo_ty³
 *
ti
;

53 
	$Mas¡»eW¿µ”
() {

54 
this
->
	`bË_š™
();

55 
	}
}

57 
	$bË_š™
() {

58 ià(
ti
 =ğ
nuÎ±r
)

59 
ti
 = 
th»adšfo
::
	`make
Ñh»adšfo::
TI_MAIN
, -1);

60 
bË_
.
	`š™Ÿlize
(*
ti
);

61 
key_g’_
 = 0;

62 
	}
}

64 
	$keyg’_»£t
() {

65 
key_g’_
 = 0;

66 
	}
}

68 
	$th»ad_š™
(
th»ad_id
) {

69 ià(
ti
 =ğ
nuÎ±r
)

70 
ti
 = 
th»adšfo
::
	`make
Ñh»adšfo::
TI_PROCESS
, 
th»ad_id
);

71 
	}
}

73 
	$š£¹_‹¡
() {

75 autØ
št_key
 = 
	`ãtch_ªd_add
(&
key_g’_
, 1);

76 
ušt64_t
 
key_buf
;

77 ià(
št_key
 > 
š£¹_bound
)

79 
SŒ
 
key
 = 
	`make_key
(
št_key
, 
key_buf
);

81 
cursÜ_ty³
 
	`Í
(
bË_
, 
key
);

82 
boŞ
 
found
 = 
Í
.
	`fšd_š£¹
(*
ti
);

83 
	`®ways_as£¹
(!
found
, "keys should‡ll be unique");

85 
Í
.
	`v®ue
(èğ
št_key
;

87 
	`ãnû
();

88 
Í
.
	`fšish
(1, *
ti
);

90 
	}
}

92 
	$»move_‹¡
() {

94 autØ
št_key
 = 
	`ãtch_ªd_add
(&
key_g’_
, 1);

95 
ušt64_t
 
key_buf
;

96 ià(
št_key
 > 
š£¹_bound
)

98 
SŒ
 
key
 = 
	`make_key
(
št_key
, 
key_buf
);

100 
cursÜ_ty³
 
	`Í
(
bË_
, 
key
);

101 
boŞ
 
found
 = 
Í
.
	`fšd_locked
(*
ti
);

102 
	`®ways_as£¹
(
found
, "keys must‡llƒxist");

103 
Í
.
	`fšish
(-1, *
ti
);

105 
	}
}

107 
	$š£¹_»move_‹¡
(
th»ad_id
) {

108 
¡d
::
mt19937
 
	`g’
(
th»ad_id
);

109 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`di¡
(1, 6);

110 
ušt64_t
 
št_key
 = 0;

111 
boŞ
 
Ãed_´št
 = 
Œue
;

112 !
¡İpšg
) {

113 
št_key
 = 
	`ãtch_ªd_add
(&
key_g’_
, 1);

114 
ušt64_t
 
key_buf
;

115 ià(
št_key
 > 
š£¹_bound
)

117 
SŒ
 
key
 = 
	`make_key
(
št_key
, 
key_buf
);

119 
cursÜ_ty³
 
	`Í
(
bË_
, 
key
);

120 
boŞ
 
found
 = 
Í
.
	`fšd_š£¹
(*
ti
);

121 
	`®ways_as£¹
(!
found
, "keys should‡ll be unique 1");

123 
Í
.
	`v®ue
(èğ
št_key
;

124 
	`ãnû
();

125 
Í
.
	`fšish
(1, *
ti
);

127 ià(
	`di¡
(
g’
) <= 2) {

128 
cursÜ_ty³
 
	`Í1
(
bË_
, 
key
);

129 
boŞ
 
found1
 = 
Í1
.
	`fšd_locked
(*
ti
);

130 ià(!
found1
) {

131 
¡İpšg
 = 
Œue
;

132 
Í1
.
	`fšish
(0, *
ti
);

133 
	`´štf
("çed‡ˆkey %" 
PRIu64
 ",†p1 gÙ %p\n", 
št_key
, 
Í1
.
	`node
());

134 
Ãed_´št
 = 
Œue
;

136 
	`®ways_as£¹
(
found1
, "this is my key!");

138 
Í1
.
	`fšish
(-1, *
ti
);

142 
	`´štf
("¡İ³d‡ˆkey %" 
PRIu64
 "\n", 
št_key
);

143 ià(
Ãed_´št
 && 
	`ãtch_ªd_add
(&
´štšg
, 1) == 0) {

144 
bË_
.
	`´št
(
¡dout
);

145 
	`fæush
(
¡dout
);

146 
	`årštf
(
¡dout
, "Stats: %s\n",

147 
Mas¡»e
::
	`jsÚ_¡©s
(
bË_
, 
ti
).
	`uÅ¬£
(
lcdf
::
JsÚ
::
	`šd’t_d•th
(1000)).
	`c_¡r
());

149 
	}
}

151 
	g´iv©e
:

152 
bË_ty³
 
bË_
;

153 
ušt64_t
 
	gkey_g’_
;

154 
boŞ
 
	g¡İpšg
;

155 
ušt32_t
 
	g´štšg
;

157 
šlše
 
SŒ
 
	$make_key
(
ušt64_t
 
št_key
, ušt64_t& 
key_buf
) {

158 
key_buf
 = 
	`__butš_bsw­64
(
št_key
);

159  
	`SŒ
((cÚ¡ *)&
key_buf
, (key_buf));

160 
	}
}

163 
__th»ad
 
ty³Çme
 
	gMas¡»eW¿µ”
::
bË_·¿ms
::
th»adšfo_ty³
* 
Mas¡»eW¿µ”
::
ti
 = 
nuÎ±r
;

164 
boŞ
 
	gMas¡»eW¿µ”
::
¡İpšg
 = 
çl£
;

165 
ušt32_t
 
	gMas¡»eW¿µ”
::
´štšg
 = 0;

167 vŞ©
mrcu_•och_ty³
 
	gaùive_•och
 = 1;

168 vŞ©
ušt64_t
 
	gglob®•och
 = 1;

169 vŞ©
boŞ
 
	g»cov”šg
 = 
çl£
;

171 
	$‹¡_th»ad
(
Mas¡»eW¿µ”
* 
mt
, 
th»ad_id
) {

172 
mt
->
	`th»ad_š™
(
th»ad_id
);

173 
mt
->
	`š£¹_»move_‹¡
(
th»ad_id
);

174 
	}
}

176 
	$maš
() {

177 autØ
mt
 = 
Ãw
 
	`Mas¡»eW¿µ”
();

178 
mt
->
	`keyg’_»£t
();

179 
¡d
::
cout
 << "š£¹_»move_‹¡..." << std::
’dl
;

181 
¡d
::
veùÜ
<¡d::
th»ad
> 
ths
;

183 
i
 = 0; i < 
NUM_THREADS
; ++i)

184 
ths
.
	`em¶aû_back
(
‹¡_th»ad
, 
mt
, 
i
);

185 auto& 
t
 : 
ths
)

186 
t
.
	`još
();

188 
¡d
::
cout
 << "‹¡…ass." << std::
’dl
;

190 
	}
}

	@masstree-beta/value_array.cc

16 
	~"kvrow.hh
"

17 
	~"v®ue_¬¿y.hh
"

18 
	~<¡ršg.h
>

20 
v®ue_¬¿y
* 
	gv®ue_¬¿y
::
	$make_sized_row
(
ncŞ
, 
kvtime¡amp_t
 
ts
,

21 
th»adšfo
& 
ti
) {

22 
v®ue_¬¿y
 *
tv
;

23 
tv
 = (
v®ue_¬¿y
 *è
ti
.
	`®loÿ‹
(
	`sh®low_size
(
ncŞ
), 
memg_v®ue
);

24 
tv
->
ts_
 = 
ts
;

25 
tv
->
ncŞ_
 = 
ncŞ
;

26 
	`mem£t
(
tv
->
cŞs_
, 0, Ñv->cŞs_[0]è* 
ncŞ
);

27  
tv
;

28 
	}
}

30 
v®ue_¬¿y
* 
	gv®ue_¬¿y
::
	$upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
,

31 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
) const {

32 
	`mas¡»e_´ecÚd™iÚ
(
ts
 >ğ
ts_
);

33 
ncŞ
 = 
¡d
::
	`max
((
ncŞ_
), (
Ï¡
[-2].
	`as_i
()) + 1);

34 
v®ue_¬¿y
* 
row
 = (v®ue_¬¿y*è
ti
.
	`®loÿ‹
(
	`sh®low_size
(
ncŞ
), 
memg_v®ue
);

35 
row
->
ts_
 = 
ts
;

36 
row
->
ncŞ_
 = 
ncŞ
;

37 
	`memıy
(
row
->
cŞs_
, cŞs_, 
ncŞ_
 * (cols_[0]));

38 
	`mem£t
(
row
->
cŞs_
 + 
ncŞ_
, 0, (
ncŞ
 -‚col_) * (cols_[0]));

39 ; 
fœ¡
 !ğ
Ï¡
; first += 2)

40 
row
->
cŞs_
[
fœ¡
[0].
	`as_u
()] = 
	`make_cŞumn
(fœ¡[1].
	`as_s
(), 
ti
);

41  
row
;

42 
	}
}

44 
	gv®ue_¬¿y
::
	$d—Îoÿ‹
(
th»adšfo
& 
ti
) {

45 
i
 = 0; i < 
ncŞ_
; ++i)

46 
	`d—Îoÿ‹_cŞumn
(
cŞs_
[
i
], 
ti
);

47 
ti
.
	`d—Îoÿ‹
(
this
, 
	`sh®low_size
(), 
memg_v®ue
);

48 
	}
}

50 
	gv®ue_¬¿y
::
	$d—Îoÿ‹_rcu
(
th»adšfo
& 
ti
) {

51 
i
 = 0; i < 
ncŞ_
; ++i)

52 
	`d—Îoÿ‹_cŞumn_rcu
(
cŞs_
[
i
], 
ti
);

53 
ti
.
	`d—Îoÿ‹_rcu
(
this
, 
	`sh®low_size
(), 
memg_v®ue
);

54 
	}
}

56 
	gv®ue_¬¿y
::
	$d—Îoÿ‹_rcu_aá”_upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
th»adšfo
& 
ti
) {

57 ; 
fœ¡
 !ğ
Ï¡
 && fœ¡[0].
	`as_u
(è< (
ncŞ_
); first += 2)

58 
	`d—Îoÿ‹_cŞumn_rcu
(
cŞs_
[
fœ¡
[0].
	`as_u
()], 
ti
);

59 
ti
.
	`d—Îoÿ‹_rcu
(
this
, 
	`sh®low_size
(), 
memg_v®ue
);

60 
	}
}

62 
	gv®ue_¬¿y
::
	$d—Îoÿ‹_aá”_çed_upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
th»adšfo
& 
ti
) {

63 ; 
fœ¡
 !ğ
Ï¡
; first += 2)

64 
	`d—Îoÿ‹_cŞumn
(
cŞs_
[
fœ¡
[0].
	`as_u
()], 
ti
);

65 
ti
.
	`d—Îoÿ‹
(
this
, 
	`sh®low_size
(), 
memg_v®ue
);

66 
	}
}

	@masstree-beta/value_array.hh

16 #iâdeà
VALUE_ARRAY_HH


17 
	#VALUE_ARRAY_HH


	)

18 
	~"comp”.hh
"

19 
	~"jsÚ.hh
"

21 şas 
	cv®ue_¬¿y
 {

22 
	mpublic
:

23 
	tšdex_ty³
;

24 cÚ¡ *
	$Çme
() {  "Array"; }

26 
lcdf
::
	tJsÚ
 Json;

28 
šlše
 
	`v®ue_¬¿y
();

30 
šlše
 
kvtime¡amp_t
 
	$time¡amp
() const;

31 
šlše
 
	$ncŞ
() const;

32 
šlše
 
SŒ
 
	$cŞ
(
i
) const;

34 
	`d—Îoÿ‹
(
th»adšfo
 &
ti
);

35 
	`d—Îoÿ‹_rcu
(
th»adšfo
 &
ti
);

37 
v®ue_¬¿y
* 
	$upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
) const;

38 
v®ue_¬¿y
* 
	`ü—‹
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
);

39 
šlše
 
v®ue_¬¿y
* 
	`ü—‹1
(
SŒ
 
v®ue
, 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
);

40 
	`d—Îoÿ‹_rcu_aá”_upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
th»adšfo
& 
ti
);

41 
	`d—Îoÿ‹_aá”_çed_upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
th»adšfo
& 
ti
);

43 
‹m¶©e
 <
ty³Çme
 
PARSER
>

44 
v®ue_¬¿y
* 
	`checkpošt_»ad
(
PARSER
& 
·r
, 
kvtime¡amp_t
 
ts
,

45 
th»adšfo
& 
ti
);

46 
‹m¶©e
 <
ty³Çme
 
UNPARSER
>

47 
	$checkpošt_wr™e
(
UNPARSER
& 
uÅ¬
) const;

49 
	`´št
(
FILE
* 
f
, cÚ¡ * 
´efix
, 
šd’t
, 
SŒ
 
key
,

50 
kvtime¡amp_t
 
š™Ÿl_ts
, cÚ¡ * 
suffix
 = "") {

51 
kvtime¡amp_t
 
adj_ts
 = 
	`time¡amp_sub
(
ts_
, 
š™Ÿl_ts
);

52 
	`årštf
(
f
, "%s%*s%.* ğ### @" 
PRIKVTSPARTS
 "%s\n", 
´efix
, 
šd’t
, "",

53 
key
.
Ën
, key.
s
, 
	`KVTS_HIGHPART
(
adj_ts
), 
	`KVTS_LOWPART
×dj_ts), 
suffix
);

54 
	}
}

56 
šlše
 
	glcdf
::
šlše_¡ršg
* 
make_cŞumn
(
SŒ
 
¡r
, 
th»adšfo
& 
ti
);

57 
d—Îoÿ‹_cŞumn
(
lcdf
::
šlše_¡ršg
* 
cŞ
, 
th»adšfo
& 
ti
);

58 
d—Îoÿ‹_cŞumn_rcu
(
lcdf
::
šlše_¡ršg
* 
cŞ
, 
th»adšfo
& 
ti
);

60 
	g´iv©e
:

61 
kvtime¡amp_t
 
ts_
;

62 
	gncŞ_
;

63 
	glcdf
::
šlše_¡ršg
* 
cŞs_
[0];

65 
šlše
 
size_t
 
sh®low_size
(
ncŞ
);

66 
šlše
 
size_t
 
	$sh®low_size
() const;

67 
v®ue_¬¿y
* 
	`make_sized_row
(
ncŞ
, 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
);

68 
	}
};

70 
šlše
 
	gv®ue_¬¿y
::
	$v®ue_¬¿y
()

71 : 
	`ts_
(0), 
	$ncŞ_
(0) {

72 
	}
}

74 
šlše
 
kvtime¡amp_t
 
	gv®ue_¬¿y
::
	$time¡amp
() const {

75  
ts_
;

76 
	}
}

78 
šlše
 
	gv®ue_¬¿y
::
	$ncŞ
() const {

79  
ncŞ_
;

80 
	}
}

82 
šlše
 
SŒ
 
	gv®ue_¬¿y
::
	$cŞ
(
i
) const {

83 ià((
i
è< (
ncŞ_
è&& 
cŞs_
[i])

84  
	`SŒ
(
cŞs_
[
i
]->
s
, cŞs_[i]->
Ën
);

86  
	`SŒ
();

87 
	}
}

89 
šlše
 
size_t
 
	gv®ue_¬¿y
::
	$sh®low_size
(
ncŞ
) {

90  (
v®ue_¬¿y
è+ (
lcdf
::
šlše_¡ršg
*è* 
ncŞ
;

91 
	}
}

93 
šlše
 
size_t
 
	gv®ue_¬¿y
::
	$sh®low_size
() const {

94  
	`sh®low_size
(
ncŞ_
);

95 
	}
}

97 
šlše
 
	glcdf
::
šlše_¡ršg
* 
v®ue_¬¿y
::
	$make_cŞumn
(
SŒ
 
¡r
, 
th»adšfo
& 
ti
) {

98 
usšg
 
lcdf
::
šlše_¡ršg
;

99 ià(
¡r
) {

100 
šlše_¡ršg
* 
cŞ
 = (šlše_¡ršg*è
ti
.
	`®loÿ‹
(šlše_¡ršg::
	`size
(
¡r
.
	`Ëngth
()), 
memg_v®ue
);

101 
cŞ
->
Ën
 = 
¡r
.
	`Ëngth
();

102 
	`memıy
(
cŞ
->
s
, 
¡r
.
	`d©a
(), sŒ.
	`Ëngth
());

103  
cŞ
;

106 
	}
}

108 
šlše
 
	gv®ue_¬¿y
::
	$d—Îoÿ‹_cŞumn
(
lcdf
::
šlše_¡ršg
* 
cŞ
,

109 
th»adšfo
& 
ti
) {

110 ià(
cŞ
)

111 
ti
.
	`d—Îoÿ‹
(
cŞ
, cŞ->
	`size
(), 
memg_v®ue
);

112 
	}
}

114 
šlše
 
	gv®ue_¬¿y
::
	$d—Îoÿ‹_cŞumn_rcu
(
lcdf
::
šlše_¡ršg
* 
cŞ
,

115 
th»adšfo
& 
ti
) {

116 ià(
cŞ
)

117 
ti
.
	`d—Îoÿ‹_rcu
(
cŞ
, cŞ->
	`size
(), 
memg_v®ue
);

118 
	}
}

120 
šlše
 
v®ue_¬¿y
* 
	gv®ue_¬¿y
::
	$ü—‹
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
,

121 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
) {

122 
v®ue_¬¿y
 
em±y
;

123  
em±y
.
	`upd©e
(
fœ¡
, 
Ï¡
, 
ts
, 
ti
);

124 
	}
}

126 
šlše
 
v®ue_¬¿y
* 
	gv®ue_¬¿y
::
	$ü—‹1
(
SŒ
 
v®ue
, 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
) {

127 
v®ue_¬¿y
* 
row
 = (v®ue_¬¿y*è
ti
.
	`®loÿ‹
(
	`sh®low_size
(1), 
memg_v®ue
);

128 
row
->
ts_
 = 
ts
;

129 
row
->
ncŞ_
 = 1;

130 
row
->
cŞs_
[0] = 
	`make_cŞumn
(
v®ue
, 
ti
);

131  
row
;

132 
	}
}

134 
	g‹m¶©e
 <
ty³Çme
 
	gPARSER
>

135 
v®ue_¬¿y
* 
	gv®ue_¬¿y
::
	$checkpošt_»ad
(
PARSER
& 
·r
, 
kvtime¡amp_t
 
ts
,

136 
th»adšfo
& 
ti
) {

137 
ncŞ
;

138 
·r
.
	`»ad_¬¿y_h—d”
(
ncŞ
);

139 
v®ue_¬¿y
* 
row
 = 
	`make_sized_row
(
ncŞ
, 
ts
, 
ti
);

140 
SŒ
 
cŞ
;

141 
i
 = 0; i !ğ
ncŞ
; i++) {

142 
·r
 >> 
cŞ
;

143 ià(
cŞ
)

144 
row
->
cŞs_
[
i
] = 
	`make_cŞumn
(
cŞ
, 
ti
);

146  
row
;

147 
	}
}

149 
	g‹m¶©e
 <
ty³Çme
 
	gUNPARSER
>

150 
	gv®ue_¬¿y
::
	$checkpošt_wr™e
(
UNPARSER
& 
uÅ¬
) const {

151 
uÅ¬
.
	`wr™e_¬¿y_h—d”
(
ncŞ_
);

152 
i
 = 0; i !ğ
ncŞ_
; i++)

153 
uÅ¬
 << 
	`cŞ
(
i
);

154 
	}
}

	@masstree-beta/value_bag.hh

16 #iâdeà
VALUE_BAG_HH


17 
	#VALUE_BAG_HH


	)

18 
	~"kvth»ad.hh
"

19 
	~"jsÚ.hh
"

21 
	g‹m¶©e
 <
ty³Çme
 
	gO
>

22 şas 
	cv®ue_bag
 {

23 
	mpublic
:

24 
	tšdex_ty³
;

25 
O
 
	toff£t_ty³
;

26 
	mlcdf
::
	tSŒ
 Str;

27 
	mlcdf
::
	tJsÚ
 Json;

29 
	m´iv©e
:

30 
	ubagd©a
 {

32 
off£t_ty³
 
ncŞ_
;

33 
off£t_ty³
 
	mpos_
[1];

35 
	ms_
[0];

38 
	gpublic
:

39 cÚ¡ *
	$Çme
(è{  "Bag"; 
	}
}

41 
šlše
 
v®ue_bag
();

43 
šlše
 
kvtime¡amp_t
 
	$time¡amp
() const;

44 
šlše
 
size_t
 
	$size
() const;

45 
šlše
 
	$ncŞ
() const;

46 
šlše
 
O
 
	$cŞumn_Ëngth
(
i
) const;

47 
šlše
 
SŒ
 
	$cŞ
(
i
) const;

49 
šlše
 
SŒ
 
	$row_¡ršg
() const;

51 
‹m¶©e
 <
ty³Çme
 
ALLOC
> 
šlše
 
	`d—Îoÿ‹
(ALLOC& 
ti
);

52 
‹m¶©e
 <
ty³Çme
 
ALLOC
> 
šlše
 
	`d—Îoÿ‹_rcu
(ALLOC& 
ti
);

54 
‹m¶©e
 <
ty³Çme
 
ALLOC
>

55 
v®ue_bag
<
O
>* 
	$upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
kvtime¡amp_t
 
ts
,

56 
ALLOC
& 
ti
) const;

57 
‹m¶©e
 <
ty³Çme
 
ALLOC
>

58 
šlše
 
v®ue_bag
<
O
>* 
	$upd©e
(
cŞ
, 
SŒ
 
v®ue
,

59 
kvtime¡amp_t
 
ts
, 
ALLOC
& 
ti
) const;

60 
‹m¶©e
 <
ty³Çme
 
ALLOC
>

61 
v®ue_bag
<
O
>* 
	`ü—‹
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
,

62 
kvtime¡amp_t
 
ts
, 
ALLOC
& 
ti
);

63 
‹m¶©e
 <
ty³Çme
 
ALLOC
>

64 
v®ue_bag
<
O
>* 
	`ü—‹1
(
SŒ
 
v®ue
, 
kvtime¡amp_t
 
ts
, 
ALLOC
& 
ti
);

65 
‹m¶©e
 <
ty³Çme
 
ALLOC
>

66 
šlše
 
	`d—Îoÿ‹_rcu_aá”_upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
ALLOC
& 
ti
);

67 
‹m¶©e
 <
ty³Çme
 
ALLOC
>

68 
šlše
 
	`d—Îoÿ‹_aá”_çed_upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
ALLOC
& 
ti
);

70 
‹m¶©e
 <
ty³Çme
 
PARSER
,y³Çm
ALLOC
>

71 
v®ue_bag
<
O
>* 
	`checkpošt_»ad
(
PARSER
& 
·r
, 
kvtime¡amp_t
 
ts
,

72 
ALLOC
& 
ti
);

73 
‹m¶©e
 <
ty³Çme
 
UNPARSER
>

74 
šlše
 
	$checkpošt_wr™e
(
UNPARSER
& 
uÅ¬
) const;

76 
	`´št
(
FILE
* 
f
, cÚ¡ * 
´efix
, 
šd’t
, 
SŒ
 
key
,

77 
kvtime¡amp_t
 
š™Ÿl_ts
, cÚ¡ * 
suffix
 = "");

79 
´iv©e
:

80 
kvtime¡amp_t
 
ts_
;

81 
bagd©a
 
d_
;

82 
	}
};

85 
	g‹m¶©e
 <
ty³Çme
 
	gO
>

86 
šlše
 
	gv®ue_bag
<
	gO
>::
	$v®ue_bag
()

87 : 
	$ts_
(0) {

88 
d_
.
ncŞ_
 = 0;

89 
d_
.
pos_
[0] = (
bagd©a
);

90 
	}
}

92 
	g‹m¶©e
 <
ty³Çme
 
	gO
>

93 
šlše
 
kvtime¡amp_t
 
	gv®ue_bag
<
	gO
>::
	$time¡amp
() const {

94  
ts_
;

95 
	}
}

97 
	g‹m¶©e
 <
ty³Çme
 
	gO
>

98 
šlše
 
size_t
 
	gv®ue_bag
<
	gO
>::
	$size
() const {

99  (
kvtime¡amp_t
è+ 
d_
.
pos_
[d_.
ncŞ_
];

100 
	}
}

102 
	g‹m¶©e
 <
ty³Çme
 
	gO
>

103 
šlše
 
	gv®ue_bag
<
	gO
>::
	$ncŞ
() const {

104  
d_
.
ncŞ_
;

105 
	}
}

107 
	g‹m¶©e
 <
ty³Çme
 
	gO
>

108 
šlše
 
O
 
	gv®ue_bag
<
	gO
>::
	$cŞumn_Ëngth
(
i
) const {

109  
d_
.
pos_
[
i
 + 1] - d_.pos_[i];

110 
	}
}

112 
	g‹m¶©e
 <
ty³Çme
 
	gO
>

113 
šlše
 
	glcdf
::
SŒ
 
v®ue_bag
<
O
>::
	$cŞ
(
i
) const {

114 ià((
i
è< (
d_
.
ncŞ_
))

115  
	`SŒ
(
d_
.
s_
 + d_.
pos_
[
i
], 
	`cŞumn_Ëngth
(i));

117  
	`SŒ
();

118 
	}
}

120 
	g‹m¶©e
 <
ty³Çme
 
	gO
>

121 
šlše
 
	glcdf
::
SŒ
 
v®ue_bag
<
O
>::
	$row_¡ršg
() const {

122  
	`SŒ
(
d_
.
s_
, d_.
pos_
[d_.
ncŞ_
]);

123 
	}
}

125 
	g‹m¶©e
 <
ty³Çme
 
	gO
>em¶©<ty³Çm
	gALLOC
>

126 
šlše
 
	gv®ue_bag
<
	gO
>::
	$d—Îoÿ‹
(
ALLOC
& 
ti
) {

127 
ti
.
	`d—Îoÿ‹
(
this
, 
	`size
(), 
memg_v®ue
);

128 
	}
}

130 
	g‹m¶©e
 <
ty³Çme
 
	gO
>em¶©<ty³Çm
	gALLOC
>

131 
šlše
 
	gv®ue_bag
<
	gO
>::
	$d—Îoÿ‹_rcu
(
ALLOC
& 
ti
) {

132 
ti
.
	`d—Îoÿ‹_rcu
(
this
, 
	`size
(), 
memg_v®ue
);

133 
	}
}

138 
	g‹m¶©e
 <
ty³Çme
 
	gO
>em¶©<ty³Çm
	gALLOC
>

139 
	gv®ue_bag
<
	gO
>* v®ue_bag<O>::
	$upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
,

140 
kvtime¡amp_t
 
ts
, 
ALLOC
& 
ti
) const

142 
size_t
 
sz
 = 
	`size
();

143 
ncŞ
 = 
d_
.
ncŞ_
;

144 autØ
™
 = 
fœ¡
; iˆ!ğ
Ï¡
; it += 2) {

145 
idx
 = 
™
[0].
	`as_u
();

146 
sz
 +ğ
™
[1].
	`as_s
().
	`Ëngth
();

147 ià(
idx
 < 
d_
.
ncŞ_
)

148 
sz
 -ğ
	`cŞumn_Ëngth
(
idx
);

150 
ncŞ
 = 
idx
 + 1;

152 ià(
ncŞ
 > 
d_
.
ncŞ_
)

153 
sz
 +ğ(
ncŞ
 - 
d_
.
ncŞ_
è* (
off£t_ty³
);

155 
v®ue_bag
<
O
>* 
row
 = (v®ue_bag<O>*è
ti
.
	`®loÿ‹
(
sz
, 
memg_v®ue
);

156 
row
->
ts_
 = 
ts
;

159 ià(
ncŞ
 =ğ
d_
.
ncŞ_
 && 
sz
 =ğ
	`size
(è&& 
fœ¡
 + 2 =ğ
Ï¡


160 && 
fœ¡
[1].
	`as_s
().
	`Ëngth
() <= 16) {

161 
	`memıy
(
row
->
d_
.
s_
, d_.s_, 
sz
 - (
kvtime¡amp_t
));

162 
	`memıy
(
row
->
d_
.
s_
 + d_.
pos_
[
fœ¡
[0].
	`as_u
()],

163 
fœ¡
[1].
	`as_s
().
	`d©a
(), fœ¡[1].as_s().
	`Ëngth
());

164  
row
;

168 
row
->
d_
.
ncŞ_
 = 
ncŞ
;

169 
sz
 = (
bagd©a
è+ 
ncŞ
 * (
off£t_ty³
);

170 
cŞ
 = 0;

172 
this_cŞ
 = (
fœ¡
 !ğ
Ï¡
 ? fœ¡[0].
	`as_u
(è: 
ncŞ
);

175 ià(
cŞ
 !ğ
this_cŞ
 && cŞ < 
d_
.
ncŞ_
) {

176 
’d_cŞ
 = 
¡d
::
	`mš
(
this_cŞ
, (
d_
.
ncŞ_
));

177 
ssize_t
 
d–
 = 
sz
 - 
d_
.
pos_
[
cŞ
];

178 ià(
d–
 == 0)

179 
	`memıy
(
row
->
d_
.
pos_
 + 
cŞ
, d_.pos_ + col,

180 (
off£t_ty³
è* (
’d_cŞ
 - 
cŞ
));

182 
i
 = 
cŞ
; i < 
’d_cŞ
; ++i)

183 
row
->
d_
.
pos_
[
i
] = d_.pos_[i] + 
d–
;

184 
size_t
 
amt
 = 
d_
.
pos_
[
’d_cŞ
] - d_.pos_[
cŞ
];

185 
	`memıy
(
row
->
d_
.
s_
 + 
sz
, d_.s_ + d_.
pos_
[
cŞ
], 
amt
);

186 
sz
 +ğ
amt
;

187 
cŞ
 = 
’d_cŞ
;

191 
cŞ
 !ğ
this_cŞ
) {

192 
row
->
d_
.
pos_
[
cŞ
] = 
sz
;

193 ++
cŞ
;

196 ià(
cŞ
 =ğ
ncŞ
)

200 
row
->
d_
.
pos_
[
cŞ
] = 
sz
;

201 
SŒ
 
v®
 = 
fœ¡
[1].
	`as_s
();

202 
	`memıy
(
row
->
d_
.
s_
 + 
sz
, 
v®
.
	`d©a
(), v®.
	`Ëngth
());

203 
sz
 +ğ
v®
.
	`Ëngth
();

204 
fœ¡
 += 2;

205 ++
cŞ
;

207 
row
->
d_
.
pos_
[
ncŞ
] = 
sz
;

208  
row
;

209 
	}
}

211 
	g‹m¶©e
 <
ty³Çme
 
	gO
>em¶©<ty³Çm
	gALLOC
>

212 
šlše
 
	gv®ue_bag
<
	gO
>* v®ue_bag<O>::
	$upd©e
(
cŞ
, 
SŒ
 
v®ue
, 
kvtime¡amp_t
 
ts
,

213 
ALLOC
& 
ti
) const {

214 
JsÚ
 
chªge
[2] = {
	`JsÚ
(
cŞ
), JsÚ(
v®ue
)};

215  
	`upd©e
(&
chªge
[0], &chªge[2], 
ts
, 
ti
);

216 
	}
}

218 
	g‹m¶©e
 <
ty³Çme
 
	gO
>em¶©<ty³Çm
	gALLOC
>

219 
šlše
 
	gv®ue_bag
<
	gO
>* v®ue_bag<O>::
	$ü—‹
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
,

220 
kvtime¡amp_t
 
ts
, 
ALLOC
& 
ti
) {

221 
v®ue_bag
<
O
> 
em±y
;

222  
em±y
.
	`upd©e
(
fœ¡
, 
Ï¡
, 
ts
, 
ti
);

223 
	}
}

225 
	g‹m¶©e
 <
ty³Çme
 
	gO
>em¶©<ty³Çm
	gALLOC
>

226 
šlše
 
	gv®ue_bag
<
	gO
>* v®ue_bag<O>::
	$ü—‹1
(
SŒ
 
¡r
, 
kvtime¡amp_t
 
ts
,

227 
ALLOC
& 
ti
) {

228 
v®ue_bag
<
O
>* 
row
 = (v®ue_bag<O>*è
ti
.
	`®loÿ‹
((
kvtime¡amp_t
è+ (
bagd©a
è+ (Oè+ 
¡r
.
	`Ëngth
(), 
memg_v®ue
);

229 
row
->
ts_
 = 
ts
;

230 
row
->
d_
.
ncŞ_
 = 1;

231 
row
->
d_
.
pos_
[0] = (
bagd©a
è+ (
O
);

232 
row
->
d_
.
pos_
[1] = (
bagd©a
è+ (
O
è+ 
¡r
.
	`Ëngth
();

233 
	`memıy
(
row
->
d_
.
s_
 +„ow->d_.
pos_
[0], 
¡r
.
	`d©a
(), sŒ.
	`Ëngth
());

234  
row
;

235 
	}
}

237 
	g‹m¶©e
 <
ty³Çme
 
	gO
>em¶©<ty³Çm
	gALLOC
>

238 
šlše
 
	gv®ue_bag
<
	gO
>::
	$d—Îoÿ‹_rcu_aá”_upd©e
(cÚ¡ 
JsÚ
*, cÚ¡ JsÚ*, 
ALLOC
& 
ti
) {

239 
	`d—Îoÿ‹_rcu
(
ti
);

240 
	}
}

242 
	g‹m¶©e
 <
ty³Çme
 
	gO
>em¶©<ty³Çm
	gALLOC
>

243 
šlše
 
	gv®ue_bag
<
	gO
>::
	$d—Îoÿ‹_aá”_çed_upd©e
(cÚ¡ 
JsÚ
*, cÚ¡ JsÚ*, 
ALLOC
& 
ti
) {

244 
	`d—Îoÿ‹
(
ti
);

245 
	}
}

247 
	g‹m¶©e
 <
ty³Çme
 
	gO
>em¶©<ty³Çm
	gPARSER
,y³Çm
	gALLOC
>

248 
šlše
 
	gv®ue_bag
<
	gO
>* v®ue_bag<O>::
	$checkpošt_»ad
(
PARSER
& 
·r
,

249 
kvtime¡amp_t
 
ts
,

250 
ALLOC
& 
ti
) {

251 
SŒ
 
v®ue
;

252 
·r
 >> 
v®ue
;

253 
v®ue_bag
<
O
>* 
row
 = (v®ue_bag<O>*è
ti
.
	`®loÿ‹
((
kvtime¡amp_t
è+ 
v®ue
.
	`Ëngth
(), 
memg_v®ue
);

254 
row
->
ts_
 = 
ts
;

255 
	`memıy
(
row
->
d_
.
s_
, 
v®ue
.
	`d©a
(), v®ue.
	`Ëngth
());

256  
row
;

257 
	}
}

259 
	g‹m¶©e
 <
ty³Çme
 
	gO
>em¶©<ty³Çm
	gUNPARSER
>

260 
šlše
 
	gv®ue_bag
<
	gO
>::
	$checkpošt_wr™e
(
UNPARSER
& 
uÅ¬
) const {

261 
uÅ¬
 << 
	`SŒ
(
d_
.
s_
, d_.
pos_
[d_.
ncŞ_
]);

262 
	}
}

264 
	g‹m¶©e
 <
ty³Çme
 
	gO
>

265 
	gv®ue_bag
<
	gO
>::
	$´št
(
FILE
 *
f
, cÚ¡ *
´efix
, 
šd’t
,

266 
SŒ
 
key
, 
kvtime¡amp_t
 
š™Ÿl_ts
,

267 cÚ¡ *
suffix
)

269 
kvtime¡amp_t
 
adj_ts
 = 
	`time¡amp_sub
(
ts_
, 
š™Ÿl_ts
);

270 ià(
d_
.
ncŞ_
 == 1)

271 
	`årštf
(
f
, "%s%*s%.* ğ%.* @" 
PRIKVTSPARTS
 "%s\n", 
´efix
, 
šd’t
, "",

272 
key
.
Ën
, key.
s
, 
d_
.
pos_
[1] - d_.pos_[0], d_.
s_
 + d_.pos_[0],

273 
	`KVTS_HIGHPART
(
adj_ts
), 
	`KVTS_LOWPART
×dj_ts), 
suffix
);

275 
	`årštf
(
f
, "%s%*s%.* ğ[", 
´efix
, 
šd’t
, "", 
key
.
Ën
, key.
s
);

276 
cŞ
 = 0; cŞ < 
d_
.
ncŞ_
; ++col) {

277 
pos
 = 
d_
.
pos_
[
cŞ
], 
Ën
 = 
¡d
::
	`mš
(40, d_.pos_[col + 1] -…os);

278 
	`årštf
(
f
, 
cŞ
 ? "|%.*s" : "%.*s", 
Ën
, 
d_
.
s_
 + 
pos
);

280 
	`årštf
(
f
, "] @" 
PRIKVTSPARTS
 "%s\n",

281 
	`KVTS_HIGHPART
(
adj_ts
), 
	`KVTS_LOWPART
×dj_ts), 
suffix
);

283 
	}
}

	@masstree-beta/value_string.cc

16 
	~"kvrow.hh
"

17 
	~"v®ue_¡ršg.hh
"

18 
	~<¡ršg.h
>

	@masstree-beta/value_string.hh

16 #iâdeà
VALUE_STRING_HH


17 
	#VALUE_STRING_HH


	)

18 
	~"comp”.hh
"

19 
	~"jsÚ.hh
"

21 şas 
	cv®ue_¡ršg
 {

22 
	mpublic
:

23 
	tšdex_ty³
;

24 cÚ¡ *
	$Çme
() {  "String"; }

26 
lcdf
::
	tSŒ
 Str;

27 
lcdf
::
	tJsÚ
 Json;

29 
šlše
 
	`v®ue_¡ršg
();

31 
šlše
 
kvtime¡amp_t
 
	$time¡amp
() const;

32 
šlše
 
size_t
 
	$size
() const;

33 
šlše
 
	$ncŞ
() const;

34 
šlše
 
SŒ
 
	$cŞ
(
šdex_ty³
 
idx
) const;

36 
‹m¶©e
 <
ty³Çme
 
ALLOC
>

37 
šlše
 
	`d—Îoÿ‹
(
ALLOC
& 
ti
);

38 
šlše
 
	`d—Îoÿ‹_rcu
(
th»adšfo
& 
ti
);

40 
‹m¶©e
 <
ty³Çme
 
ALLOC
>

41 
v®ue_¡ršg
* 
	$upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
kvtime¡amp_t
 
ts
, 
ALLOC
& 
ti
) const;

42 
šlše
 
v®ue_¡ršg
* 
	`ü—‹
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
);

43 
šlše
 
v®ue_¡ršg
* 
	`ü—‹1
(
SŒ
 
v®ue
, 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
);

44 
šlše
 
	`d—Îoÿ‹_rcu_aá”_upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
th»adšfo
& 
ti
);

45 
šlše
 
	`d—Îoÿ‹_aá”_çed_upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
th»adšfo
& 
ti
);

47 
‹m¶©e
 <
ty³Çme
 
PARSER
>

48 
šlše
 
v®ue_¡ršg
* 
	`checkpošt_»ad
(
PARSER
& 
·r
, 
kvtime¡amp_t
 
ts
,

49 
th»adšfo
& 
ti
);

50 
‹m¶©e
 <
ty³Çme
 
UNPARSER
>

51 
šlše
 
	$checkpošt_wr™e
(
UNPARSER
& 
uÅ¬
) const;

53 
	`´št
(
FILE
* 
f
, cÚ¡ * 
´efix
, 
šd’t
, 
SŒ
 
key
,

54 
kvtime¡amp_t
 
š™Ÿl_ts
, cÚ¡ * 
suffix
 = "") {

55 
kvtime¡amp_t
 
adj_ts
 = 
	`time¡amp_sub
(
ts_
, 
š™Ÿl_ts
);

56 
	`årštf
(
f
, "%s%*s%.* ğ%.* @" 
PRIKVTSPARTS
 "%s\n", 
´efix
, 
šd’t
, "",

57 
key
.
Ën
, key.
s
, 
¡d
::
	`mš
(40U, 
v®Ën_
), 
s_
,

58 
	`KVTS_HIGHPART
(
adj_ts
), 
	`KVTS_LOWPART
×dj_ts), 
suffix
);

59 
	}
}

61 
šlše
 
šdex_ty³
 
make_šdex
(
off£t
, 
Ëngth
);

62 
šlše
 
šdex_off£t
(
šdex_ty³
 
idx
);

63 
šlše
 
šdex_Ëngth
(
šdex_ty³
 
idx
);

65 
	g´iv©e
:

66 
kvtime¡amp_t
 
ts_
;

67 
	gv®Ën_
;

68 
	gs_
[0];

70 
šlše
 
šdex_Ï¡_off£t
(
šdex_ty³
 
idx
);

71 
šlše
 
size_t
 
sh®low_size
(
v®Ën
);

72 
šlše
 
size_t
 
	$sh®low_size
() const;

73 
	}
};

75 
šlše
 
	gv®ue_¡ršg
::
šdex_ty³
 
v®ue_¡ršg
::
	$make_šdex
(
off£t
, 
Ëngth
) {

76  
off£t
 + (
Ëngth
 << 16);

77 
	}
}

79 
šlše
 
	gv®ue_¡ršg
::
	$šdex_off£t
(
šdex_ty³
 
idx
) {

80  
idx
 & 0xFFFF;

81 
	}
}

83 
šlše
 
	gv®ue_¡ršg
::
	$šdex_Ëngth
(
šdex_ty³
 
idx
) {

84  
idx
 >> 16;

85 
	}
}

87 
šlše
 
	gv®ue_¡ršg
::
	$v®ue_¡ršg
()

88 : 
	`ts_
(0), 
	$v®Ën_
(0) {

89 
	}
}

91 
šlše
 
kvtime¡amp_t
 
	gv®ue_¡ršg
::
	$time¡amp
() const {

92  
ts_
;

93 
	}
}

95 
šlše
 
size_t
 
	gv®ue_¡ršg
::
	$size
() const {

96  (
v®ue_¡ršg
è+ 
v®Ën_
;

97 
	}
}

99 
šlše
 
	gv®ue_¡ršg
::
	$ncŞ
() const {

101 
	}
}

103 
šlše
 
	gv®ue_¡ršg
::
	$šdex_Ï¡_off£t
(
šdex_ty³
 
idx
) {

104  
	`šdex_off£t
(
idx
è+ 
	`šdex_Ëngth
(idx);

105 
	}
}

107 
šlše
 
	glcdf
::
SŒ
 
v®ue_¡ršg
::
	$cŞ
(
šdex_ty³
 
idx
) const {

108 ià(
idx
 == 0)

109  
	`SŒ
(
s_
, 
v®Ën_
);

111 
off
 = 
¡d
::
	`mš
(
v®Ën_
, 
	`šdex_off£t
(
idx
));

112  
	`SŒ
(
s_
 + 
off
, 
¡d
::
	`mš
(
v®Ën_
 - off, 
	`šdex_Ëngth
(
idx
)));

114 
	}
}

116 
	g‹m¶©e
 <
ty³Çme
 
	gALLOC
>

117 
šlše
 
	gv®ue_¡ršg
::
	$d—Îoÿ‹
(
ALLOC
& 
ti
) {

118 
ti
.
	`d—Îoÿ‹
(
this
, 
	`size
(), 
memg_v®ue
);

119 
	}
}

121 
šlše
 
	gv®ue_¡ršg
::
	$d—Îoÿ‹_rcu
(
th»adšfo
& 
ti
) {

122 
ti
.
	`d—Îoÿ‹_rcu
(
this
, 
	`size
(), 
memg_v®ue
);

123 
	}
}

125 
šlše
 
size_t
 
	gv®ue_¡ršg
::
	$sh®low_size
(
v®Ën
) {

126  (
v®ue_¡ršg
è+ 
v®Ën
;

127 
	}
}

129 
šlše
 
size_t
 
	gv®ue_¡ršg
::
	$sh®low_size
() const {

130  
	`sh®low_size
(
v®Ën_
);

131 
	}
}

133 
	g‹m¶©e
 <
ty³Çme
 
	gALLOC
>

134 
v®ue_¡ršg
* 
	gv®ue_¡ršg
::
	$upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
,

135 
kvtime¡amp_t
 
ts
, 
ALLOC
& 
ti
) const {

136 
v®Ën
 = 0, 
cut
 = 
v®Ën_
;

137 autØ
™
 = 
fœ¡
; iˆ!ğ
Ï¡
; it += 2) {

138 
idx
 = 
™
[0].
	`as_u
(), 
Ëngth
 = it[1].
	`as_s
().
	`Ëngth
();

139 ià(
idx
 == 0)

140 
cut
 = 
Ëngth
;

141 
v®Ën
 = 
¡d
::
	`max
(v®Ën, 
	`šdex_off£t
(
idx
è+ 
Ëngth
);

143 
v®Ën
 = 
¡d
::
	`max
(v®Ën, 
cut
);

144 
v®ue_¡ršg
* 
row
 = (v®ue_¡ršg*è
ti
.
	`®loÿ‹
(
	`sh®low_size
(
v®Ën
), 
memg_v®ue
);

145 
row
->
ts_
 = 
ts
;

146 
row
->
v®Ën_
 = 
v®Ën
;

147 
	`memıy
(
row
->
s_
, s_, 
cut
);

148 ; 
fœ¡
 !ğ
Ï¡
; first += 2) {

149 
SŒ
 
v®
 = 
fœ¡
[1].
	`as_s
();

150 
	`memıy
(
row
->
s_
 + 
	`šdex_off£t
(
fœ¡
[0].
	`as_u
()), 
v®
.
	`d©a
(), v®.
	`Ëngth
());

152  
row
;

153 
	}
}

155 
šlše
 
v®ue_¡ršg
* 
	gv®ue_¡ršg
::
	$ü—‹
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
,

156 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
) {

157 
v®ue_¡ršg
 
em±y
;

158  
em±y
.
	`upd©e
(
fœ¡
, 
Ï¡
, 
ts
, 
ti
);

159 
	}
}

161 
šlše
 
v®ue_¡ršg
* 
	gv®ue_¡ršg
::
	$ü—‹1
(
SŒ
 
v®ue
,

162 
kvtime¡amp_t
 
ts
,

163 
th»adšfo
& 
ti
) {

164 
v®ue_¡ršg
* 
row
 = (v®ue_¡ršg*è
ti
.
	`®loÿ‹
(
	`sh®low_size
(
v®ue
.
	`Ëngth
()), 
memg_v®ue
);

165 
row
->
ts_
 = 
ts
;

166 
row
->
v®Ën_
 = 
v®ue
.
	`Ëngth
();

167 
	`memıy
(
row
->
s_
, 
v®ue
.
	`d©a
(), v®ue.
	`Ëngth
());

168  
row
;

169 
	}
}

171 
šlše
 
	gv®ue_¡ršg
::
	$d—Îoÿ‹_rcu_aá”_upd©e
(cÚ¡ 
JsÚ
*, cÚ¡ JsÚ*, 
th»adšfo
& 
ti
) {

172 
	`d—Îoÿ‹_rcu
(
ti
);

173 
	}
}

175 
šlše
 
	gv®ue_¡ršg
::
	$d—Îoÿ‹_aá”_çed_upd©e
(cÚ¡ 
JsÚ
*, cÚ¡ JsÚ*, 
th»adšfo
& 
ti
) {

176 
	`d—Îoÿ‹
(
ti
);

177 
	}
}

179 
	g‹m¶©e
 <
ty³Çme
 
	gPARSER
>

180 
šlše
 
v®ue_¡ršg
* 
	gv®ue_¡ršg
::
	$checkpošt_»ad
(
PARSER
& 
·r
,

181 
kvtime¡amp_t
 
ts
,

182 
th»adšfo
& 
ti
) {

183 
SŒ
 
¡r
;

184 
·r
 >> 
¡r
;

185  
	`ü—‹1
(
¡r
, 
ts
, 
ti
);

186 
	}
}

188 
	g‹m¶©e
 <
ty³Çme
 
	gUNPARSER
>

189 
šlše
 
	gv®ue_¡ršg
::
	$checkpošt_wr™e
(
UNPARSER
& 
uÅ¬
) const {

190 
uÅ¬
 << 
	`SŒ
(
s_
, 
v®Ën_
);

191 
	}
}

	@masstree-beta/value_versioned_array.cc

16 
	~"kvrow.hh
"

17 
	~"v®ue_v”siÚed_¬¿y.hh
"

18 
	~<¡ršg.h
>

20 
v®ue_v”siÚed_¬¿y
* 
	gv®ue_v”siÚed_¬¿y
::
	$make_sized_row
(
ncŞ
, 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
) {

21 
v®ue_v”siÚed_¬¿y
* 
row
 = (v®ue_v”siÚed_¬¿y*è
ti
.
	`®loÿ‹
(
	`sh®low_size
(
ncŞ
), 
memg_v®ue
);

22 
row
->
ts_
 = 
ts
;

23 
row
->
v”_
 = 
	`rowv”siÚ
();

24 
row
->
ncŞ_
 =„ow->
ncŞ_ÿp_
 = 
ncŞ
;

25 
	`mem£t
(
row
->
cŞs_
, 0, Ôow->cŞs_[0]è* 
ncŞ
);

26  
row
;

27 
	}
}

29 
	gv®ue_v”siÚed_¬¿y
::
¢­shÙ
(
v®ue_v”siÚed_¬¿y
*& 
¡Üage
,

30 cÚ¡ 
¡d
::
veùÜ
<
šdex_ty³
>& 
f
, 
th»adšfo
& 
ti
) const {

31 ià(!
	g¡Üage
 || stÜage->
	gncŞ_ÿp_
 < 
	gncŞ_
) {

32 ià(
	g¡Üage
)

33 
	g¡Üage
->
d—Îoÿ‹
(
ti
);

34 
	g¡Üage
 = 
make_sized_row
(
ncŞ_
, 
ts_
, 
ti
);

36 
	g¡Üage
->
	gncŞ_
 = 
ncŞ_
;

37 
rowv”siÚ
 
	gv1
 = 
v”_
.
¡abË
();

39 ià(
	gf
.
size
() == 1)

40 
¡Üage
->
cŞs_
[
f
[0]] = cols_[f[0]];

42 
memıy
(
¡Üage
->
cŞs_
, cŞs_, (cŞs_[0]è* stÜage->
ncŞ_
);

43 
rowv”siÚ
 
	gv2
 = 
v”_
.
¡abË
();

44 ià(!
	gv1
.
has_chªged
(
v2
))

46 
	gv1
 = 
v2
;

50 
v®ue_v”siÚed_¬¿y
*

51 
	gv®ue_v”siÚed_¬¿y
::
	$upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
,

52 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
,

53 
boŞ
 
®ways_cİy
) {

54 
ncŞ
 = 
Ï¡
[-2].
	`as_u
() + 1;

55 
v®ue_v”siÚed_¬¿y
* 
row
;

56 ià(
ncŞ
 > 
ncŞ_ÿp_
 || 
®ways_cİy
) {

57 
row
 = (
v®ue_v”siÚed_¬¿y
*è
ti
.
	`®loÿ‹
(
	`sh®low_size
(
ncŞ
), 
memg_v®ue
);

58 
row
->
ts_
 = 
ts
;

59 
row
->
v”_
 = 
	`rowv”siÚ
();

60 
row
->
ncŞ_
 =„ow->
ncŞ_ÿp_
 = 
ncŞ
;

61 
	`memıy
(
row
->
cŞs_
, cŞs_, (cŞs_[0]è* 
ncŞ_
);

63 
row
 = 
this
;

64 ià(
ncŞ
 > 
ncŞ_
)

65 
	`mem£t
(
row
->
cŞs_
 + 
ncŞ_
, 0, (cŞs_[0]è* (
ncŞ
 -‚col_));

67 ià(
row
 =ğ
this
) {

68 
v”_
.
	`£tdœty
();

69 
	`ãnû
();

71 ià(
row
->
ncŞ_
 < 
ncŞ
)

72 
row
->
ncŞ_
 = 
ncŞ
;

74 ; 
fœ¡
 !ğ
Ï¡
; first += 2) {

75 
idx
 = 
fœ¡
[0].
	`as_u
();

76 
v®ue_¬¿y
::
	`d—Îoÿ‹_cŞumn_rcu
(
row
->
cŞs_
[
idx
], 
ti
);

77 
row
->
cŞs_
[
idx
] = 
v®ue_¬¿y
::
	`make_cŞumn
(
fœ¡
[1].
	`as_s
(), 
ti
);

80 ià(
row
 =ğ
this
) {

81 
	`ãnû
();

82 
v”_
.
	`ş—¿ndbump
();

84  
row
;

85 
	}
}

87 
	gv®ue_v”siÚed_¬¿y
::
	$d—Îoÿ‹
(
th»adšfo
 &
ti
) {

88 
i
 = 0; i < 
ncŞ_
; ++i)

89 
v®ue_¬¿y
::
	`d—Îoÿ‹_cŞumn
(
cŞs_
[
i
], 
ti
);

90 
ti
.
	`d—Îoÿ‹
(
this
, 
	`sh®low_size
(), 
memg_v®ue
);

91 
	}
}

93 
	gv®ue_v”siÚed_¬¿y
::
	$d—Îoÿ‹_rcu
(
th»adšfo
 &
ti
) {

94 
i
 = 0; i < 
ncŞ_
; ++i)

95 
v®ue_¬¿y
::
	`d—Îoÿ‹_cŞumn_rcu
(
cŞs_
[
i
], 
ti
);

96 
ti
.
	`d—Îoÿ‹_rcu
(
this
, 
	`sh®low_size
(), 
memg_v®ue
);

97 
	}
}

	@masstree-beta/value_versioned_array.hh

16 #iâdeà
VALUE_VERSIONED_ARRAY_HH


17 
	#VALUE_VERSIONED_ARRAY_HH


	)

18 
	~"comp”.hh
"

19 
	~"v®ue_¬¿y.hh
"

21 
	srowv”siÚ
 {

22 
rowv”siÚ
() {

23 
	mv_
.
	mu
 = 0;

25 
boŞ
 
dœty
() {

26  
	mv_
.
	mdœty
;

28 
£tdœty
() {

29 
	mv_
.
	mu
 = 
v_
.
u
 | 0x80000000;

31 
ş—r
() {

32 
	mv_
.
	mu
 = 
v_
.
u
 & 0x7fffffff;

34 
ş—¿ndbump
() {

35 
	mv_
.
	mu
 = (
v_
.
u
 + 1) & 0x7fffffff;

37 
rowv”siÚ
 
¡abË
() const {

38 
v®ue_t
 
	mx
 = 
v_
;

39 
	mx
.
	mdœty
) {

40 
»Ïx_ãnû
();

41 
	mx
 = 
v_
;

43 
acquœe_ãnû
();

44  
	mx
;

46 
boŞ
 
has_chªged
(
rowv”siÚ
 
x
) const {

47 
ãnû
();

48  
	mx
.
	mv_
.
	mùr
 !ğ
v_
.
ùr
;

50 
	m´iv©e
:

51 
	uv®ue_t
 {

53 
ušt32_t
 
ùr
:31;

54 
ušt32_t
 
	mdœty
:1;

56 
ušt32_t
 
	mu
;

58 
v®ue_t
 
	mv_
;

60 
rowv”siÚ
(
v®ue_t
 
v
)

61 : 
v_
(
v
) {

66 şas 
	cv®ue_v”siÚed_¬¿y
 {

67 
	mpublic
:

68 
v®ue_¬¿y
::
	tšdex_ty³
 index_type;

69 cÚ¡ *
	$Çme
() {  "ArrayVersion"; }

71 
lcdf
::
	tJsÚ
 Json;

73 
šlše
 
	`v®ue_v”siÚed_¬¿y
();

75 
šlše
 
kvtime¡amp_t
 
	$time¡amp
() const;

76 
šlše
 
	$ncŞ
() const;

77 
šlše
 
SŒ
 
	$cŞ
(
i
) const;

79 
	`d—Îoÿ‹
(
th»adšfo
 &
ti
);

80 
	`d—Îoÿ‹_rcu
(
th»adšfo
 &
ti
);

82 
	`¢­shÙ
(
v®ue_v”siÚed_¬¿y
*& 
¡Üage
,

83 cÚ¡ 
¡d
::
veùÜ
<
šdex_ty³
>& 
f
, 
th»adšfo
& 
ti
) const;

85 
v®ue_v”siÚed_¬¿y
* 
	`upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
,

86 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
,

87 
boŞ
 
®ways_cİy
 = 
çl£
);

88 
v®ue_v”siÚed_¬¿y
* 
	`ü—‹
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
,

89 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
);

90 
v®ue_v”siÚed_¬¿y
* 
	`ü—‹1
(
SŒ
 
v®ue
, 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
);

91 
šlše
 
	`d—Îoÿ‹_rcu_aá”_upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
th»adšfo
& 
ti
);

92 
šlše
 
	`d—Îoÿ‹_aá”_çed_upd©e
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
th»adšfo
& 
ti
);

94 
‹m¶©e
 <
ty³Çme
 
PARSER
>

95 
v®ue_v”siÚed_¬¿y
* 
	`checkpošt_»ad
(
PARSER
& 
·r
, 
kvtime¡amp_t
 
ts
,

96 
th»adšfo
& 
ti
);

97 
‹m¶©e
 <
ty³Çme
 
UNPARSER
>

98 
	$checkpošt_wr™e
(
UNPARSER
& 
uÅ¬
) const;

100 
	`´št
(
FILE
 *
f
, cÚ¡ *
´efix
, 
šd’t
, 
SŒ
 
key
,

101 
kvtime¡amp_t
 
š™Ÿl_ts
, cÚ¡ *
suffix
 = "") {

102 
kvtime¡amp_t
 
adj_ts
 = 
	`time¡amp_sub
(
ts_
, 
š™Ÿl_ts
);

103 
	`årštf
(
f
, "%s%*s%.* ğ### @" 
PRIKVTSPARTS
 "%s\n", 
´efix
, 
šd’t
, "",

104 
key
.
Ën
, key.
s
, 
	`KVTS_HIGHPART
(
adj_ts
), 
	`KVTS_LOWPART
×dj_ts), 
suffix
);

105 
	}
}

107 
	g´iv©e
:

108 
kvtime¡amp_t
 
ts_
;

109 
rowv”siÚ
 
	gv”_
;

110 
	gncŞ_
;

111 
	gncŞ_ÿp_
;

112 
	glcdf
::
šlše_¡ršg
* 
cŞs_
[0];

114 
šlše
 
size_t
 
sh®low_size
(
ncŞ
);

115 
šlše
 
size_t
 
	$sh®low_size
() const;

116 
v®ue_v”siÚed_¬¿y
* 
	`make_sized_row
(
ncŞ
, 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
);

117 
	}
};

119 
	g‹m¶©e
 <>

120 
	gqu”y_h–³r
<
	gv®ue_v”siÚed_¬¿y
> {

121 
v®ue_v”siÚed_¬¿y
* 
	g¢­shÙ_
;

123 
qu”y_h–³r
()

124 : 
¢­shÙ_
() {

126 
šlše
 cÚ¡ 
v®ue_v”siÚed_¬¿y
* 
¢­shÙ
(cÚ¡ v®ue_v”siÚed_¬¿y* 
row
,

127 cÚ¡ 
¡d
::
veùÜ
<
v®ue_v”siÚed_¬¿y
::
šdex_ty³
>& 
f
,

128 
th»adšfo
& 
ti
) {

129 
	grow
->
¢­shÙ
(
¢­shÙ_
, 
f
, 
ti
);

130  
	g¢­shÙ_
;

134 
šlše
 
	gv®ue_v”siÚed_¬¿y
::
	$v®ue_v”siÚed_¬¿y
()

135 : 
	`ts_
(0), 
	`ncŞ_
(0), 
	$ncŞ_ÿp_
(0) {

136 
	}
}

138 
šlše
 
kvtime¡amp_t
 
	gv®ue_v”siÚed_¬¿y
::
	$time¡amp
() const {

139  
ts_
;

140 
	}
}

142 
šlše
 
	gv®ue_v”siÚed_¬¿y
::
	$ncŞ
() const {

143  
ncŞ_
;

144 
	}
}

146 
šlše
 
SŒ
 
	gv®ue_v”siÚed_¬¿y
::
	$cŞ
(
i
) const {

147 ià((
i
è< (
ncŞ_
è&& 
cŞs_
[i])

148  
	`SŒ
(
cŞs_
[
i
]->
s
, cŞs_[i]->
Ën
);

150  
	`SŒ
();

151 
	}
}

153 
šlše
 
size_t
 
	gv®ue_v”siÚed_¬¿y
::
	$sh®low_size
(
ncŞ
) {

154  (
v®ue_v”siÚed_¬¿y
è+ 
ncŞ
 * (
lcdf
::
šlše_¡ršg
*);

155 
	}
}

157 
šlše
 
size_t
 
	gv®ue_v”siÚed_¬¿y
::
	$sh®low_size
() const {

158  
	`sh®low_size
(
ncŞ_
);

159 
	}
}

161 
šlše
 
v®ue_v”siÚed_¬¿y
* 
	gv®ue_v”siÚed_¬¿y
::
	$ü—‹
(cÚ¡ 
JsÚ
* 
fœ¡
, cÚ¡ JsÚ* 
Ï¡
, 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
) {

162 
v®ue_v”siÚed_¬¿y
 
em±y
;

163  
em±y
.
	`upd©e
(
fœ¡
, 
Ï¡
, 
ts
, 
ti
, 
Œue
);

164 
	}
}

166 
šlše
 
v®ue_v”siÚed_¬¿y
* 
	gv®ue_v”siÚed_¬¿y
::
	$ü—‹1
(
SŒ
 
v®ue
, 
kvtime¡amp_t
 
ts
, 
th»adšfo
& 
ti
) {

167 
v®ue_v”siÚed_¬¿y
* 
row
 = (v®ue_v”siÚed_¬¿y*è
ti
.
	`®loÿ‹
(
	`sh®low_size
(1), 
memg_v®ue
);

168 
row
->
ts_
 = 
ts
;

169 
row
->
v”_
 = 
	`rowv”siÚ
();

170 
row
->
ncŞ_
 =„ow->
ncŞ_ÿp_
 = 1;

171 
row
->
cŞs_
[0] = 
v®ue_¬¿y
::
	`make_cŞumn
(
v®ue
, 
ti
);

172  
row
;

173 
	}
}

175 
šlše
 
	gv®ue_v”siÚed_¬¿y
::
	$d—Îoÿ‹_rcu_aá”_upd©e
(cÚ¡ 
JsÚ
*, cÚ¡ JsÚ*, 
th»adšfo
& 
ti
) {

176 
ti
.
	`d—Îoÿ‹_rcu
(
this
, 
	`sh®low_size
(), 
memg_v®ue
);

177 
	}
}

179 
šlše
 
	gv®ue_v”siÚed_¬¿y
::
	$d—Îoÿ‹_aá”_çed_upd©e
(cÚ¡ 
JsÚ
*, cÚ¡ JsÚ*, 
th»adšfo
&) {

180 
	`®ways_as£¹
(0);

181 
	}
}

183 
	g‹m¶©e
 <
ty³Çme
 
	gPARSER
>

184 
v®ue_v”siÚed_¬¿y
*

185 
	gv®ue_v”siÚed_¬¿y
::
	$checkpošt_»ad
(
PARSER
& 
·r
, 
kvtime¡amp_t
 
ts
,

186 
th»adšfo
& 
ti
) {

187 
ncŞ
;

188 
·r
.
	`»ad_¬¿y_h—d”
(
ncŞ
);

189 
v®ue_v”siÚed_¬¿y
* 
row
 = 
	`make_sized_row
(
ncŞ
, 
ts
, 
ti
);

190 
SŒ
 
cŞ
;

191 
i
 = 0; i !ğ
ncŞ
; i++) {

192 
·r
 >> 
cŞ
;

193 
row
->
cŞs_
[
i
] = 
v®ue_¬¿y
::
	`make_cŞumn
(
cŞ
, 
ti
);

195  
row
;

196 
	}
}

198 
	g‹m¶©e
 <
ty³Çme
 
	gUNPARSER
>

199 
	gv®ue_v”siÚed_¬¿y
::
	$checkpošt_wr™e
(
UNPARSER
& 
uÅ¬
) const {

200 
uÅ¬
.
	`wr™e_¬¿y_h—d”
(
ncŞ_
);

201 
i
 = 0; i !ğ
ncŞ_
; ++i)

202 
uÅ¬
 << 
	`cŞ
(
i
);

203 
	}
}

	@srandomdev.c

1 
	~<¡dlib.h
>

2 
	~<¡dio.h
>

3 
	~<uni¡d.h
>

4 
	~<sys/time.h
>

6 #ià
__ılu¥lus__


9 
¤ªdomdev
() {

10 
£ed
;

11 
size_t
 
n
 = 0;

12 
FILE
* 
f
 = 
fİ’
("/dev/urandom", "r");

13 ià(
f
) {

14 
n
 = 
ä—d
(&
£ed
, (£ed), 1, 
f
);

15 
fşo£
(
f
);

17 ià(!
n
) {

18 
timev®
 
tv
;

19 
g‘timeofday
(&
tv
, 
NULL
);

20 
£ed
 = (
g‘pid
(è^ 
tv
.
tv_£c
è+v.
tv_u£c
;

22 
¤ªdom
(
£ed
);

24 #ià
__ılu¥lus__


	@sto-core/ConcurrencyControl.hh

1 #´agm¨
Úû


3 
	~"T¿n§ùiÚ.hh
"

4 
	~"T¿nsI‹m.hh
"

5 
	~"V”siÚBa£.hh
"

6 
	~"Eag”V”siÚs.hh
"

7 
	~"OCCV”siÚs.hh
"

8 
	~"TicTocV”siÚs.hh
"

10 şas 
	cV”siÚD–eg©e
 {

11 
ä›nd
 
şass
 
	mTV”siÚ
;

12 
ä›nd
 
şass
 
	mTNÚİaqueV”siÚ
;

13 
ä›nd
 
şass
 
	mTCommutiveV”siÚ
;

14 
	m‹m¶©e
 <
boŞ
 
	mAd­tive
>

15 
ä›nd
 
şass
 
	mTLockV”siÚ
;

16 
	m‹m¶©e
 <
boŞ
 
	mO·que
>

17 
ä›nd
 
şass
 
	mTSwissV”siÚ
;

18 
	m‹m¶©e
 <
boŞ
 
	mO·que
, boŞ 
	mEx‹nd
>

19 
ä›nd
 
şass
 
	mTicTocV”siÚ
;

20 
	m‹m¶©e
 <
boŞ
 
	mO·que
, boŞ 
	mEx‹nd
>

21 
ä›nd
 
şass
 
	mTicTocCom´es£dV”siÚ
;

23 
	$™em_Ü_æags
(
T¿nsI‹m
& 
™em
, T¿nsI‹m::
æags_ty³
 
æags
) {

24 
™em
.
	`__Ü_æags
(
æags
);

26 *& 
	$™em_acûss_wd©a
(
T¿nsI‹m
& 
™em
) {

27  
™em
.
wd©a_
;

28 
	}
}

29 
	grd©a_t
& 
	$™em_acûss_rd©a
(
T¿nsI‹m
& 
™em
) {

30  
™em
.
rd©a_
;

31 
	}
}

33 
	$txn_£t_ªy_wr™es
(
T¿n§ùiÚ
& 
txn
, 
boŞ
 
v®
) {

34 
txn
.
ªy_wr™es_
 = 
v®
;

35 
	}
}

36 
	$txn_£t_ªy_nÚİaque
(
T¿n§ùiÚ
& 
txn
, 
boŞ
 
v®
) {

37 
txn
.
ªy_nÚİaque_
 = 
v®
;

38 
	}
}

40 
	gT¿n§ùiÚTid
::
ty³
& 
	$¡ªd¬d_tid
(
T¿n§ùiÚ
& 
txn
) {

41  
txn
.
comm™_tid_
;

42 
	}
}

44 
	gT¿n§ùiÚTid
::
ty³
& 
	$tiùoc_tid
(
T¿n§ùiÚ
& 
txn
) {

45  
txn
.
tiùoc_tid_
;

46 
	}
}

50 
šlše
 
	gT¿nsProxy
& T¿nsProxy::
	$add_wr™e
() {

51 ià(!
	`has_wr™e
()) {

52 
	`™em
().
	`__Ü_æags
(
T¿nsI‹m
::
wr™e_b™
);

53 
	`t
()->
ªy_wr™es_
 = 
Œue
;

55  *
this
;

56 
	}
}

58 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

59 
šlše
 
	gT¿nsProxy
& T¿nsProxy::
	$add_wr™e
(cÚ¡ 
T
& 
wd©a
) {

60  
add_wr™e
<
T
, cÚ¡ T&>(
wd©a
);

61 
	}
}

63 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

64 
šlše
 
	gT¿nsProxy
& T¿nsProxy::
	$add_wr™e
(
T
&& 
wd©a
) {

65 
ty³Çme
 
	t¡d
::
	tdeÿy
<
	tT
>::
	tty³
 
	tV
;

66  
add_wr™e
<
V
, V&&>(
¡d
::
	`move
(
wd©a
));

67 
	}
}

69 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

70 
šlše
 
	gT¿nsProxy
& T¿nsProxy::
	$add_wr™e
(
Args
&&... 
¬gs
) {

71 ià(!
	`has_wr™e
()) {

72 
	`™em
().
	`__Ü_æags
(
T¿nsI‹m
::
wr™e_b™
);

73 
	`™em
().
wd©a_
 = 
Pack”
<
T
>::
	`·ck
(
	`t
()->
buf_
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

74 
	`t
()->
ªy_wr™es_
 = 
Œue
;

80 
	`™em
().
wd©a_
 = 
Pack”
<
T
>::
	`»·ck
(
	`t
()->
buf_
, i‹m().wd©a_, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

81  *
this
;

82 
	}
}

85 
šlše
 
	gT¿n§ùiÚ
& 
	$t
() {

86  *
TTh»ad
::
txn
;

87 
	}
}

91 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

92 
šlše
 
boŞ
 
	gBasicV”siÚ
<
	gV”sIm¶
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
) {

93 
	`T¿nsProxy
(
	`t
(), 
™em
).
	`add_wr™e
();

94  
Œue
;

95 
	}
}

96 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>em¶©<ty³Çm
	gT
>

97 
šlše
 
boŞ
 
	gBasicV”siÚ
<
	gV”sIm¶
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, cÚ¡ 
T
& 
wd©a
) {

98 
	`T¿nsProxy
(
	`t
(), 
™em
).
	`add_wr™e
(
wd©a
);

99  
Œue
;

100 
	}
}

101 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>em¶©<ty³Çm
	gT
>

102 
šlše
 
boŞ
 
	gBasicV”siÚ
<
	gV”sIm¶
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
T
&& 
wd©a
) {

103 
	`T¿nsProxy
(
	`t
(), 
™em
).
	`add_wr™e
(
wd©a
);

104  
Œue
;

105 
	}
}

106 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>em¶©<ty³Çm
	gT
, 
	gty³Çme
... 
	gArgs
>

107 
šlše
 
boŞ
 
	gBasicV”siÚ
<
	gV”sIm¶
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
Args
&&... 
¬gs
) {

108 
	`T¿nsProxy
(
	`t
(), 
™em
).
add_wr™e
<
T
, 
Args
...>(
¡d
::
fÜw¬d
<Args>(
¬gs
)...);

109  
Œue
;

110 
	}
}

114 
šlše
 
boŞ
 
	gTV”siÚ
::
	$ob£rve_»ad_im¶
(
T¿nsI‹m
 &
™em
, 
boŞ
 
add_»ad
){

115 
	`as£¹
(!
™em
.
	`has_¡ash
());

116 
TV”siÚ
 
v”siÚ
 = *
this
;

117 
	`ãnû
();

119 ià(
v”siÚ
.
	`is_locked_–£wh”e
()) {

120 
	`t
().
	`m¬k_abÜt_beÿu£
(&
™em
, "locked", 
v”siÚ
.
	`v®ue
());

121 
	`TXP_INCREMENT
(
txp_ob£rve_lock_abÜts
);

122  
çl£
;

124 ià(!
	`t
().
	`check_İac™y
(
™em
, 
v”siÚ
.
	`v®ue
()))

125  
çl£
;

126 ià(
add_»ad
 && !
™em
.
	`has_»ad
()) {

127 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
»ad_b™
);

128 
V”siÚD–eg©e
::
	`™em_acûss_rd©a
(
™em
).
v
 = 
Pack”
<
TV”siÚ
>::
	`·ck
(
	`t
().
buf_
, 
¡d
::
	`move
(
v”siÚ
));

133  
Œue
;

134 
	}
}

138 
šlše
 
boŞ
 
	gTNÚİaqueV”siÚ
::
	$ob£rve_»ad_im¶
(
T¿nsI‹m
& 
™em
, 
boŞ
 
add_»ad
) {

139 
	`as£¹
(!
™em
.
	`has_¡ash
());

140 
TNÚİaqueV”siÚ
 
v”siÚ
 = *
this
;

141 
	`ãnû
();

142 ià(
v”siÚ
.
	`is_locked
()) {

143 
	`t
().
	`m¬k_abÜt_beÿu£
(&
™em
, "locked", 
v”siÚ
.
	`v®ue
());

144 
	`TXP_INCREMENT
(
txp_ob£rve_lock_abÜts
);

145  
çl£
;

147 ià(
add_»ad
 && !
™em
.
	`has_»ad
()) {

148 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
»ad_b™
);

149 
V”siÚD–eg©e
::
	`™em_acûss_rd©a
(
™em
).
v
 = 
Pack”
<
TNÚİaqueV”siÚ
>::
	`·ck
(
	`t
().
buf_
, 
¡d
::
	`move
(
v”siÚ
));

150 
V”siÚD–eg©e
::
	`txn_£t_ªy_nÚİaque
(
	`t
(), 
Œue
);

155  
Œue
;

156 
	}
}

161 
	g‹m¶©e
 <
boŞ
 
	gAd­tive
>

162 
šlše
 
boŞ
 
	gTLockV”siÚ
<
	gAd­tive
>::
	$Œy_upg¿de_w™h_¥š
() {

163 
ušt64_t
 
n
 = 0;

164 
Œue
) {

165 ià(
	`Œy_upg¿de
(è=ğ
LockRe¥Ú£
::
locked
)

166  
Œue
;

167 ++
n
;

168 ià(
n
 =ğ(1 << 
STO_SPIN_BOUND_WRITE
))

169  
çl£
;

170 
	`»Ïx_ãnû
();

172 
	}
}

174 
	g‹m¶©e
 <
boŞ
 
	gAd­tive
>

175 
šlše
 
boŞ
 
	gTLockV”siÚ
<
	gAd­tive
>::
	$Œy_lock_wr™e_w™h_¥š
() {

176 
ušt64_t
 
n
 = 0;

177 
Œue
) {

178 autØ
r
 = 
	`Œy_lock_wr™e
();

179 ià(
r
 =ğ
LockRe¥Ú£
::
locked
)

180  
Œue
;

181 ià(
r
 =ğ
LockRe¥Ú£
::
¥š
)

182 ++
n
;

184  
çl£
;

185 ià(
n
 =ğ(1 << 
STO_SPIN_BOUND_WRITE
))

186  
çl£
;

187 
	`»Ïx_ãnû
();

189 
	}
}

191 
	g‹m¶©e
 <
boŞ
 
	gAd­tive
>

192 
šlše
 
	g¡d
::
·œ
<
LockRe¥Ú£
, 
ty³Çme
 
	gTLockV”siÚ
<
	gAd­tive
>::
ty³
>

193 
TLockV”siÚ
<
Ad­tive
>::
	$Œy_lock_»ad_w™h_¥š
() {

194 
ušt64_t
 
n
 = 0;

195 
Œue
) {

196 autØ
r
 = 
	`Œy_lock_»ad
();

197 ià(
r
.
fœ¡
 !ğ
LockRe¥Ú£
::
¥š
) {

198  
r
;

200 ++
n
;

201 ià(
n
 =ğ(1 << 
STO_SPIN_BOUND_WRITE
))

202  {
LockRe¥Ú£
::
çed
, 
	`ty³
()};

204 
	}
}

206 
	g‹m¶©e
 <
boŞ
 
	gAd­tive
>

207 
šlše
 
boŞ
 
	gTLockV”siÚ
<
	gAd­tive
>::
	$lock_fÜ_wr™e
(
T¿nsI‹m
& 
™em
) {

208 ià(
™em
.
	`has_»ad
(è&& i‹m.
	`Ãeds_uÆock
()) {

210 ià(!
	`Œy_upg¿de_w™h_¥š
()) {

211 
	`t
().
	`m¬k_abÜt_beÿu£
(&
™em
, "upg¿de_lock", 
BV
::
	`v®ue
());

212  
çl£
;

215 ià(!
	`Œy_lock_wr™e_w™h_¥š
()) {

216 
	`t
().
	`m¬k_abÜt_beÿu£
(&
™em
, "wr™e_lock", 
BV
::
	`v®ue
());

217  
çl£
;

219 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
lock_b™
);

221  
Œue
;

224 
	}
}

226 
	g‹m¶©e
 <
boŞ
 
	gAd­tive
>

227 
šlše
 
boŞ
 
	gTLockV”siÚ
<
	gAd­tive
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
) {

228 ià(!
™em
.
	`has_wr™e
()) {

229 ià(!
	`lock_fÜ_wr™e
(
™em
)) {

230 
	`TXP_INCREMENT
(
txp_lock_abÜts
);

231  
çl£
;

233 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
wr™e_b™
);

234 
V”siÚD–eg©e
::
	`txn_£t_ªy_wr™es
(
	`t
(), 
Œue
);

236  
Œue
;

237 
	}
}

239 
	g‹m¶©e
 <
boŞ
 
	gAd­tive
>em¶©<
ty³Çme
 
	gT
>

240 
šlše
 
boŞ
 
	gTLockV”siÚ
<
	gAd­tive
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, cÚ¡ 
T
& 
wd©a
) {

241  
acquœe_wr™e_im¶
<
T
, cÚ¡ T&>(
™em
, 
wd©a
);

242 
	}
}

244 
	g‹m¶©e
 <
boŞ
 
	gAd­tive
>em¶©<
ty³Çme
 
	gT
>

245 
šlše
 
boŞ
 
	gTLockV”siÚ
<
	gAd­tive
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
T
&& 
wd©a
) {

246 
ty³Çme
 
	t¡d
::
	tdeÿy
<
	tT
>::
	tty³
 
	tV
;

247  
acquœe_wr™e_im¶
<
V
, V&&>(
™em
, 
¡d
::
	`move
(
wd©a
));

248 
	}
}

250 
	g‹m¶©e
 <
boŞ
 
	gAd­tive
>em¶©<
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

251 
šlše
 
boŞ
 
	gTLockV”siÚ
<
	gAd­tive
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
Args
&&... 
¬gs
) {

252 ià(!
™em
.
	`has_wr™e
()) {

253 ià(!
	`lock_fÜ_wr™e
(
™em
)) {

254 
	`TXP_INCREMENT
(
txp_lock_abÜts
);

255  
çl£
;

257 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
wr™e_b™
);

258 
V”siÚD–eg©e
::
	`™em_acûss_wd©a
(
™em
èğ
Pack”
<
T
>::
	`·ck
(
	`t
().
buf_
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

259 
V”siÚD–eg©e
::
	`txn_£t_ªy_wr™es
(
	`t
(), 
Œue
);

261 autØ
Şd_wd©a
 = 
V”siÚD–eg©e
::
	`™em_acûss_wd©a
(
™em
);

262 
V”siÚD–eg©e
::
	`™em_acûss_wd©a
(
™em
èğ
Pack”
<
T
>::
	`»·ck
(
	`t
().
buf_
, 
Şd_wd©a
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

264  
Œue
;

265 
	}
}

267 
	g‹m¶©e
 <
boŞ
 
	gAd­tive
>

268 
šlše
 
boŞ
 
	gTLockV”siÚ
<
	gAd­tive
>::
	$ob£rve_»ad_im¶
(
T¿nsI‹m
& 
™em
, 
boŞ
 
add_»ad
) {

269 
	`as£¹
(!
™em
.
	`has_¡ash
());

271 
TLockV”siÚ
 
occ_v”siÚ
;

273 
boŞ
 
İtimi¡ic
;

274 autØ
š™_mode
 = 
™em
.
	`cc_mode
();

275 ià(
š™_mode
 !ğ
CCMode
::
nÚe
) {

276 
İtimi¡ic
 = (
š™_mode
 =ğ
CCMode
::
İt
);

278 
İtimi¡ic
 = 
™em
.
	`cc_mode_is_İtimi¡ic
(
	`hšt_İtimi¡ic
());

281 ià(
İtimi¡ic
) {

282 
	`acquœe_ãnû
();

283 
occ_v”siÚ
 = *
this
;

286 ià(!
İtimi¡ic
 && !
™em
.
	`Ãeds_uÆock
(è&& 
add_»ad
 && !™em.
	`has_»ad
()) {

287 autØ
»¥Ú£
 = 
	`Œy_lock_»ad_w™h_¥š
();

288 ià(
»¥Ú£
.
fœ¡
 =ğ
LockRe¥Ú£
::
İtimi¡ic
) {

291 
İtimi¡ic
 = 
Œue
;

292 
occ_v”siÚ
 = 
	`TLockV”siÚ
(
»¥Ú£
.
£cÚd
);

293 } ià(
»¥Ú£
.
fœ¡
 =ğ
LockRe¥Ú£
::
locked
) {

294 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
lock_b™
);

295 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
»ad_b™
);

297 
V”siÚD–eg©e
::
	`txn_£t_ªy_nÚİaque
(
	`t
(), 
Œue
);

299 
	`as£¹
(
»¥Ú£
.
fœ¡
 =ğ
LockRe¥Ú£
::
çed
);

300 
	`t
().
	`m¬k_abÜt_beÿu£
(&
™em
, "ob£rve_¾ock_çed", 
BV
::
	`v®ue
());

301 
	`TXP_INCREMENT
(
txp_lock_abÜts
);

302  
çl£
;

309 ià(
İtimi¡ic
) {

311 ià(
occ_v”siÚ
.
	`is_dœty
()) {

312 
	`t
().
	`m¬k_abÜt_beÿu£
(&
™em
, "lock-dœty", 
occ_v”siÚ
.
	`v®ue
());

313 
	`TXP_INCREMENT
(
txp_ob£rve_lock_abÜts
);

314  
çl£
;

318 ià(
add_»ad
 && !
™em
.
	`has_»ad
()) {

319 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
»ad_b™
);

320 
V”siÚD–eg©e
::
	`™em_acûss_rd©a
(
™em
).
v
 = 
Pack”
<
TLockV”siÚ
>::
	`·ck
(
	`t
().
buf_
, 
¡d
::
	`move
(
occ_v”siÚ
));

321 
V”siÚD–eg©e
::
	`txn_£t_ªy_nÚİaque
(
	`t
(), 
Œue
);

326  
Œue
;

327 
	}
}

331 
	g‹m¶©e
 <
boŞ
 
	gO·que
>

332 
šlše
 
boŞ
 
	gTSwissV”siÚ
<
	gO·que
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
) {

333 ià(
BV
::
	`is_locked_h”e
())

334  
Œue
;

336 
Œue
) {

337 autØ
vv
 = 
	`Œy_lock_v®
();

338 ià(
T¿n§ùiÚTid
::
	`is_locked_h”e
(
vv
)) {

342 ià(
T¿n§ùiÚTid
::
	`is_locked_–£wh”e
(
vv
)) {

343 
owÃr_id
 = 
vv
 & 
T¿n§ùiÚTid
::
th»adid_mask
;

344 ià(
CÚ‹ÁiÚMªag”
::
	`should_abÜt
(
TTh»ad
::
	`id
(), 
owÃr_id
)) {

345 
	`TXP_INCREMENT
(
txp_lock_abÜts
);

346  
çl£
;

349 
	`TXP_INCREMENT
(
txp_ob£rve_lock_abÜts
);

352 
	`»Ïx_ãnû
();

355 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
wr™e_b™
 | T¿nsI‹m::
lock_b™
);

356 
V”siÚD–eg©e
::
	`txn_£t_ªy_wr™es
(
	`t
(), 
Œue
);

359  
CÚ‹ÁiÚMªag”
::
	`Ú_wr™e
(
TTh»ad
::
	`id
());

360 
	}
}

362 
	g‹m¶©e
 <
boŞ
 
	gO·que
>em¶©<
ty³Çme
 
	gT
>

363 
šlše
 
boŞ
 
	gTSwissV”siÚ
<
	gO·que
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, cÚ¡ 
T
 &
wd©a
) {

364  
acquœe_wr™e_im¶
<
T
, cÚ¡ T&>(
™em
, 
wd©a
);

365 
	}
}

366 
	g‹m¶©e
 <
boŞ
 
	gO·que
>em¶©<
ty³Çme
 
	gT
>

367 
šlše
 
boŞ
 
	gTSwissV”siÚ
<
	gO·que
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
T
&& 
wd©a
) {

368 
ty³Çme
 
	t¡d
::
	tdeÿy
<
	tT
>::
	tty³
 
	tV
;

369  
acquœe_wr™e_im¶
<
V
, V&&>(
™em
, 
¡d
::
	`move
(
wd©a
));

370 
	}
}

371 
	g‹m¶©e
 <
boŞ
 
	gO·que
>em¶©<
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

372 
šlše
 
boŞ
 
	gTSwissV”siÚ
<
	gO·que
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
Args
&&... 
¬gs
) {

373 ià(
BV
::
	`is_locked_h”e
()) {

374 autØ
Şd_wd©a
 = 
V”siÚD–eg©e
::
	`™em_acûss_wd©a
(
™em
);

375 
V”siÚD–eg©e
::
	`™em_acûss_wd©a
(
™em
èğ
Pack”
<
T
>::
	`»·ck
(
	`t
().
buf_
, 
Şd_wd©a
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

377  
Œue
;

380 
Œue
) {

381 autØ
vv
 = 
	`Œy_lock_v®
();

382 ià(
T¿n§ùiÚTid
::
	`is_locked_h”e
(
vv
)) {

386 ià(
T¿n§ùiÚTid
::
	`is_locked_–£wh”e
(
vv
)) {

387 
owÃr_id
 = 
vv
 & 
T¿n§ùiÚTid
::
th»adid_mask
;

388 ià(
CÚ‹ÁiÚMªag”
::
	`should_abÜt
(
TTh»ad
::
	`id
(), 
owÃr_id
)) {

389 
	`TXP_INCREMENT
(
txp_lock_abÜts
);

390  
çl£
;

393 
	`TXP_INCREMENT
(
txp_ob£rve_lock_abÜts
);

396 
	`»Ïx_ãnû
();

399 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
wr™e_b™
 | T¿nsI‹m::
lock_b™
);

400 
V”siÚD–eg©e
::
	`™em_acûss_wd©a
(
™em
èğ
Pack”
<
T
>::
	`·ck
(
	`t
().
buf_
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

401 
V”siÚD–eg©e
::
	`txn_£t_ªy_wr™es
(
	`t
(), 
Œue
);

405  
CÚ‹ÁiÚMªag”
::
	`Ú_wr™e
(
TTh»ad
::
	`id
());

406 
	}
}

408 
	g‹m¶©e
 <
boŞ
 
	gO·que
>

409 
šlše
 
boŞ
 
	gTSwissV”siÚ
<
	gO·que
>::
	$ob£rve_»ad_im¶
(
T¿nsI‹m
& 
™em
, 
boŞ
 
add_»ad
) {

410 
	`as£¹
(!
™em
.
	`has_¡ash
());

411 autØ
v”siÚ
 = *
this
;

412 
	`ãnû
();

413 ià(
v”siÚ
.
	`is_dœty
()) {

414 
	`t
().
	`m¬k_abÜt_beÿu£
(&
™em
, "swiss_»ad_dœty", 
v”siÚ
.
	`v®ue
());

415 
	`TXP_INCREMENT
(
txp_ob£rve_lock_abÜts
);

416  
çl£
;

418 ià(
is_İaque
 && !
	`t
().
	`check_İac™y
(
™em
, 
v”siÚ
.
	`v®ue
())) {

419  
çl£
;

421 ià(
add_»ad
 && !
™em
.
	`has_»ad
()) {

422 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
»ad_b™
);

423 
V”siÚD–eg©e
::
	`™em_acûss_rd©a
(
™em
).
v
 = 
Pack”
<
TSwissV”siÚ
<
O·que
>>::
	`·ck
(
	`t
().
buf_
, 
¡d
::
	`move
(
v”siÚ
));

424 ià(!
is_İaque
)

425 
V”siÚD–eg©e
::
	`txn_£t_ªy_nÚİaque
(
	`t
(), 
Œue
);

429  
Œue
;

430 
	}
}

434 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>

435 
šlše
 
boŞ
 
	gTicTocV”siÚ
<
	gO·que
, 
	gEx‹nd
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
) {

436 
™em
.
	`cc_mode_check_tiùoc
(
this
, 
çl£
 );

437 ià(!
™em
.
	`has_wr™e
()) {

438 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
wr™e_b™
);

439 ià(!
™em
.
	`has_»ad
()) {

440 
TicTocTid
::
	`·ck_wide
(
™em
.
	`wide_»ad_v®ue
(), 
BV
::
v_
, 
wts_
);

442 
V”siÚD–eg©e
::
	`txn_£t_ªy_wr™es
(
	`t
(), 
Œue
);

444  
Œue
;

445 
	}
}

447 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>em¶©<
ty³Çme
 
	gT
>

448 
šlše
 
boŞ
 
	gTicTocV”siÚ
<
	gO·que
, 
	gEx‹nd
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, cÚ¡ 
T
& 
wd©a
) {

449  
acquœe_wr™e_im¶
<
T
, cÚ¡ T&>(
™em
, 
wd©a
);

450 
	}
}

452 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>em¶©<
ty³Çme
 
	gT
>

453 
šlše
 
boŞ
 
	gTicTocV”siÚ
<
	gO·que
, 
	gEx‹nd
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
T
&& 
wd©a
) {

454 
ty³Çme
 
	t¡d
::
	tdeÿy
<
	tT
>::
	tty³
 
	tV
;

455  
acquœe_wr™e_im¶
<
V
, V&&>(
™em
, 
¡d
::
	`move
(
wd©a
));

456 
	}
}

458 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>em¶©<
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

459 
šlše
 
boŞ
 
	gTicTocV”siÚ
<
	gO·que
, 
	gEx‹nd
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
Args
&&... 
¬gs
) {

460 
™em
.
	`cc_mode_check_tiùoc
(
this
, 
çl£
 );

461 ià(!
™em
.
	`has_wr™e
()) {

462 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
wr™e_b™
);

463 ià(!
™em
.
	`has_»ad
()) {

464 
TicTocTid
::
	`·ck_wide
(
™em
.
	`wide_»ad_v®ue
(), 
BV
::
v_
, 
wts_
);

466 
V”siÚD–eg©e
::
	`txn_£t_ªy_wr™es
(
	`t
(), 
Œue
);

467 
V”siÚD–eg©e
::
	`™em_acûss_wd©a
(
™em
èğ
Pack”
<
T
>::
	`·ck
(
	`t
().
buf_
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

469 autØ
Şd_wd©a
 = 
V”siÚD–eg©e
::
	`™em_acûss_wd©a
(
™em
);

470 
V”siÚD–eg©e
::
	`™em_acûss_wd©a
(
™em
èğ
Pack”
<
T
>::
	`»·ck
(
	`t
().
buf_
, 
Şd_wd©a
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

472  
Œue
;

473 
	}
}

475 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>

476 
šlše
 
boŞ
 
	gTicTocV”siÚ
<
	gO·que
, 
	gEx‹nd
>::
	$ob£rve_»ad_im¶
(
T¿nsI‹m
& 
™em
, 
boŞ
 
add_»ad
) {

477 
™em
.
	`cc_mode_check_tiùoc
(
this
, 
çl£
 );

478 
	`as£¹
(!
™em
.
	`has_¡ash
());

479 ià(
BV
::
	`is_locked_–£wh”e
()) {

480 
	`t
().
	`m¬k_abÜt_beÿu£
(&
™em
, "locked", 
BV
::
	`v®ue
());

481 
	`TXP_INCREMENT
(
txp_ob£rve_lock_abÜts
);

482  
çl£
;

485 ià(
O·que
) {

486 
	`®ways_as£¹
(
çl£
, "opacity‚ot implemented");

489 ià(
add_»ad
 && !
™em
.
	`has_»ad
()) {

490 ià(
O·que
) {

491 
	`®ways_as£¹
(
çl£
, "opacity‚ot implemented 2");

494 
V”siÚD–eg©e
::
	`txn_£t_ªy_nÚİaque
(
	`t
(), 
Œue
);

496 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
»ad_b™
);

497 
TicTocTid
::
	`·ck_wide
(
™em
.
	`wide_»ad_v®ue
(), 
BV
::
v_
, 
wts_
);

501  
Œue
;

502 
	}
}

506 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>

507 
šlše
 
boŞ
 
	gTicTocCom´es£dV”siÚ
<
	gO·que
, 
	gEx‹nd
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
) {

508 
™em
.
	`cc_mode_check_tiùoc
(
this
, 
Œue
 );

509 ià(!
™em
.
	`has_wr™e
()) {

510 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
wr™e_b™
);

511 ià(!
™em
.
	`has_»ad
()) {

512 
™em
.
	`wide_»ad_v®ue
().
v0
 = 
v_
;

513 
	`acquœe_ãnû
();

515 
V”siÚD–eg©e
::
	`txn_£t_ªy_wr™es
(
	`t
(), 
Œue
);

517  
Œue
;

518 
	}
}

520 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>em¶©<
ty³Çme
 
	gT
>

521 
šlše
 
boŞ
 
	gTicTocCom´es£dV”siÚ
<
	gO·que
, 
	gEx‹nd
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, cÚ¡ 
T
& 
wd©a
) {

522  
acquœe_wr™e_im¶
<
T
, cÚ¡ T&>(
™em
, 
wd©a
);

523 
	}
}

525 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>em¶©<
ty³Çme
 
	gT
>

526 
šlše
 
boŞ
 
	gTicTocCom´es£dV”siÚ
<
	gO·que
, 
	gEx‹nd
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
T
&& 
wd©a
) {

527 
ty³Çme
 
	t¡d
::
	tdeÿy
<
	tT
>::
	tty³
 
	tV
;

528  
acquœe_wr™e_im¶
<
V
, V&&>(
™em
, 
wd©a
);

529 
	}
}

531 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>em¶©<
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

532 
šlše
 
boŞ
 
	gTicTocCom´es£dV”siÚ
<
	gO·que
, 
	gEx‹nd
>::
	$acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
Args
&&... 
¬gs
) {

533 
™em
.
	`cc_mode_check_tiùoc
(
this
, 
Œue
 );

534 ià(!
™em
.
	`has_wr™e
()) {

535 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
wr™e_b™
);

536 ià(!
™em
.
	`has_»ad
()) {

537 
™em
.
	`wide_»ad_v®ue
().
v0
 = 
v_
;

538 
	`acquœe_ãnû
();

540 
V”siÚD–eg©e
::
	`™em_acûss_wd©a
(
™em
èğ
Pack”
<
T
>::
	`·ck
(
	`t
().
buf_
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

541 
V”siÚD–eg©e
::
	`txn_£t_ªy_wr™es
(
	`t
(), 
Œue
);

543 autØ
Şd_wd©a
 = 
V”siÚD–eg©e
::
	`™em_acûss_wd©a
(
™em
);

544 
V”siÚD–eg©e
::
	`™em_acûss_wd©a
(
™em
èğ
Pack”
<
T
>::
	`»·ck
(
	`t
().
buf_
, 
Şd_wd©a
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

546  
Œue
;

547 
	}
};

550 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>

551 
šlše
 
boŞ
 
	gTicTocCom´es£dV”siÚ
<
	gO·que
, 
	gEx‹nd
>::
	$ob£rve_»ad_im¶
(
T¿nsI‹m
& 
™em
, 
boŞ
 
add_»ad
) {

552 
™em
.
	`cc_mode_check_tiùoc
(
this
, 
Œue
 );

553 
	`as£¹
(!
™em
.
	`has_¡ash
());

554 ià(
BV
::
	`is_locked_–£wh”e
()) {

555 
	`t
().
	`m¬k_abÜt_beÿu£
(&
™em
, "locked", 
BV
::
	`v®ue
());

556 
	`TXP_INCREMENT
(
txp_ob£rve_lock_abÜts
);

557  
çl£
;

560 ià(
O·que
) {

561 
	`®ways_as£¹
(
çl£
, "opacity‚ot implemented");

564 ià(
add_»ad
 && !
™em
.
	`has_»ad
()) {

565 ià(
O·que
) {

566 
	`®ways_as£¹
(
çl£
, "opacity‚ot implemented 2");

569 
V”siÚD–eg©e
::
	`txn_£t_ªy_nÚİaque
(
	`t
(), 
Œue
);

571 
V”siÚD–eg©e
::
	`™em_Ü_æags
(
™em
, 
T¿nsI‹m
::
»ad_b™
);

572 
	`acquœe_ãnû
();

573 
™em
.
	`wide_»ad_v®ue
().
v0
 = 
v_
;

577  
Œue
;

578 
	}
}

580 
šlše
‡utØ
	gTV”siÚ
::
¢­shÙ
(
T¿nsProxy
& 
™em
è-> 
ty³
 {

581 
ty³
 
v
 = 
v®ue
();

582 ià(!
	g™em
.
ob£rve_İac™y
(*
this
)) {

583 
	gT¿n§ùiÚ
::
AbÜt
();

585  
	gv
;

588 
šlše
‡utØ
	gTV”siÚ
::
¢­shÙ
(cÚ¡ 
T¿nsI‹m
& 
™em
, cÚ¡ 
T¿n§ùiÚ
& 
txn
è-> 
	gty³
 {

589 
ty³
 
	gv
 = 
v®ue
();

590 ià(!
	gcÚ¡_ÿ¡
<
	gT¿n§ùiÚ
&>(
	gtxn
).
check_İac™y
(
cÚ¡_ÿ¡
<
T¿nsI‹m
&>(
™em
), 
v
)) {

591 
	gT¿n§ùiÚ
::
AbÜt
();

593  
	gv
;

596 
šlše
‡utØ
	gTNÚİaqueV”siÚ
::
¢­shÙ
(
T¿nsProxy
& 
™em
è-> 
ty³
 {

597 
™em
.
Œª§ùiÚ
().
ªy_nÚİaque_
 = 
Œue
;

598  
v®ue
();

601 
šlše
‡utØ
	gTNÚİaqueV”siÚ
::
¢­shÙ
(cÚ¡ 
T¿nsI‹m
&, cÚ¡ 
T¿n§ùiÚ
& 
txn
è-> 
	gty³
 {

602 
	gcÚ¡_ÿ¡
<
	gT¿n§ùiÚ
&>(
	gtxn
).
	gªy_nÚİaque_
 = 
Œue
;

603  
v®ue
();

608 
	gTV”siÚ
::
ty³
& 
TV”siÚ
::
	$ı_acûss_tid_im¶
(
T¿n§ùiÚ
 &
txn
) {

609  
V”siÚD–eg©e
::
	`¡ªd¬d_tid
(
txn
);

610 
	}
}

611 
	gTV”siÚ
::
ty³
 
TV”siÚ
::
	$ı_comm™_tid_im¶
(
T¿n§ùiÚ
 &
txn
) {

612  
txn
.
	`comm™_tid
();

613 
	}
}

615 
	gTNÚİaqueV”siÚ
::
ty³
& 
TNÚİaqueV”siÚ
::
	$ı_acûss_tid_im¶
(
T¿n§ùiÚ
 &
txn
) {

616  
V”siÚD–eg©e
::
	`¡ªd¬d_tid
(
txn
);

617 
	}
}

618 
	gTNÚİaqueV”siÚ
::
ty³
 
TNÚİaqueV”siÚ
::
	$ı_comm™_tid_im¶
(
T¿n§ùiÚ
 &
txn
) {

619 autØ
tid
 = 
	`ı_acûss_tid_im¶
(
txn
);

620 ià(
tid
 != 0)

621  
tid
;

623  
T¿n§ùiÚTid
::
	`Ãxt_unæagged_nÚİaque_v”siÚ
(
	`v®ue
());

624 
	}
}

626 
	gTCommutiveV”siÚ
::
ty³
& 
TCommutiveV”siÚ
::
	$ı_acûss_tid_im¶
(
T¿n§ùiÚ
 &
txn
) {

627  
V”siÚD–eg©e
::
	`¡ªd¬d_tid
(
txn
);

628 
	}
}

629 
	gTCommutiveV”siÚ
::
ty³
 
TCommutiveV”siÚ
::
	$ı_comm™_tid_im¶
(
T¿n§ùiÚ
 &
txn
) {

630 ()
txn
;

631 
	`®ways_as£¹
(
çl£
, "not implemented");

632 
	}
}

634 
	g‹m¶©e
 <
boŞ
 
	gAd­tive
>

635 
ty³Çme
 
	gTLockV”siÚ
<
	gAd­tive
>::
ty³
& 
TLockV”siÚ
<
Ad­tive
>::
	$ı_acûss_tid_im¶
(
T¿n§ùiÚ
 &
txn
) {

636  
V”siÚD–eg©e
::
	`¡ªd¬d_tid
(
txn
);

637 
	}
}

639 
	g‹m¶©e
 <
boŞ
 
	gAd­tive
>

640 
ty³Çme
 
	gTLockV”siÚ
<
	gAd­tive
>::
ty³
 
TLockV”siÚ
<
Ad­tive
>::
	$ı_comm™_tid_im¶
(
T¿n§ùiÚ
 &
txn
) {

641 autØ
tid
 = 
	`ı_acûss_tid_im¶
(
txn
);

642 ià(
tid
 != 0)

643  
tid
;

645  
T¿n§ùiÚTid
::
	`Ãxt_unæagged_v”siÚ
(
BV
::
	`v®ue
());

646 
	}
}

648 
	g‹m¶©e
 <
boŞ
 
	gO·que
>

649 
ty³Çme
 
	gTSwissV”siÚ
<
	gO·que
>::
ty³
&

650 
TSwissV”siÚ
<
O·que
>::
	$ı_acûss_tid_im¶
(
T¿n§ùiÚ
 &
txn
) {

651  
V”siÚD–eg©e
::
	`¡ªd¬d_tid
(
txn
);

652 
	}
}

653 
	g‹m¶©e
 <
boŞ
 
	gO·que
>

654 
ty³Çme
 
	gTSwissV”siÚ
<
	gO·que
>::
ty³


655 
TSwissV”siÚ
<
O·que
>::
	$ı_comm™_tid_im¶
(
T¿n§ùiÚ
 &
txn
) {

656 ià(
O·que
) {

657  
txn
.
	`comm™_tid
();

659 autØ
tid
 = 
	`ı_acûss_tid_im¶
(
txn
);

660 ià(
tid
 != 0)

661  
tid
;

663  
T¿n§ùiÚTid
::
	`Ãxt_unæagged_nÚİaque_v”siÚ
(
v_
);

665 
	}
}

667 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>

668 
ty³Çme
 
	gTicTocV”siÚ
<
	gO·que
, 
	gEx‹nd
>::
ty³
&

669 
TicTocV”siÚ
<
O·que
, 
	gEx‹nd
>::
	$ı_acûss_tid_im¶
(
T¿n§ùiÚ
& 
txn
) {

670  
V”siÚD–eg©e
::
	`tiùoc_tid
(
txn
);

671 
	}
}

673 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>

674 
ty³Çme
 
	gTicTocV”siÚ
<
	gO·que
, 
	gEx‹nd
>::
ty³


675 
TicTocV”siÚ
<
O·que
, 
	gEx‹nd
>::
	$ı_comm™_tid_im¶
(
T¿n§ùiÚ
& 
txn
) {

676 autØ
tid
 = 
	`ı_acûss_tid_im¶
(
txn
);

677 ià(
tid
 != 0)

678  
tid
;

680  
txn
.
	`compu‹_tiùoc_comm™_ts
();

681 
	}
}

683 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>

684 
ty³Çme
 
	gTicTocCom´es£dV”siÚ
<
	gO·que
, 
	gEx‹nd
>::
ty³
&

685 
TicTocCom´es£dV”siÚ
<
O·que
, 
	gEx‹nd
>::
	$ı_acûss_tid_im¶
(
T¿n§ùiÚ
& 
txn
) {

686  
V”siÚD–eg©e
::
	`tiùoc_tid
(
txn
);

687 
	}
}

689 
	g‹m¶©e
 <
boŞ
 
	gO·que
, boŞ 
	gEx‹nd
>

690 
ty³Çme
 
	gTicTocCom´es£dV”siÚ
<
	gO·que
, 
	gEx‹nd
>::
ty³


691 
TicTocCom´es£dV”siÚ
<
O·que
, 
	gEx‹nd
>::
	$ı_comm™_tid_im¶
(
T¿n§ùiÚ
& 
txn
) {

692 autØ
tid
 = 
	`ı_acûss_tid_im¶
(
txn
);

693 ià(
tid
 != 0)

694  
tid
;

696  
txn
.
	`compu‹_tiùoc_comm™_ts
();

697 
	}
}

701 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

702 
šlše
 
boŞ
 
	gT¿n§ùiÚ
::
Œy_lock
(
T¿nsI‹m
& 
™em
, 
V”siÚBa£
<
V”sIm¶
>& 
v”s
) {

703 
boŞ
 
	glocked
 = 
çl£
;

704 #ià
STO_SORT_WRITESET


705 (è
	g™em
;

706 
	gv”s_
.
ı_Œy_lock
(
™em
, 
th»adid_
);

707 
	glocked
 = 
Œue
;

711 
	gn
 = 0;

712 
	gŒue
) {

713 ià(
	gv”s
.
ı_Œy_lock
(
™em
, 
th»adid_
)) {

714 
	glocked
 = 
Œue
;

717 ++
	gn
;

718 #ià
STO_SPIN_EXPBACKOFF


719 ià(
	g™em
.
has_»ad
(è|| 
	gn
 =ğ
STO_SPIN_BOUND_WRITE
) {

720 #ià
STO_DEBUG_ABORTS


721 
abÜt_v”siÚ_
 = 
v”s
.
v®ue
();

723 
	glocked
 = 
çl£
;

726 ià(
	gn
 > 3)

727 
	gx
 = 1 << 
¡d
::
mš
(15U, 
n
 - 2); x; --x)

728 
»Ïx_ãnû
();

730 ià(
	g™em
.
has_»ad
(è|| 
	gn
 =ğ(1 << 
STO_SPIN_BOUND_WRITE
)) {

731 #ià
STO_DEBUG_ABORTS


732 
abÜt_v”siÚ_
 = 
v”s
.
v®ue
();

734 
	glocked
 = 
çl£
;

738 
»Ïx_ãnû
();

742 ià(
	glocked
) {

743 ià(
	g¡d
::
is_ba£_of
<
TicTocBa£
<
V”sIm¶
>, 
	gV”sIm¶
>::
v®ue
) {

744 
v”s
.
compu‹_comm™_ts_¡•
(
this
->
tiùoc_tid_
, 
Œue
 );

746 
	gv”s
.
compu‹_comm™_ts_¡•
(
this
->
comm™_tid_
, 
Œue
 );

749  
	glocked
;

752 
šlše
 
	gT¿n§ùiÚ
::
tid_ty³
 
T¿n§ùiÚ
::
	$compu‹_tiùoc_comm™_ts
() const {

754 
tid_ty³
 
comm™_ts
 = 0;

755 
T¿nsI‹m
* 
™
 = 
nuÎ±r
;

756 
tidx
 = 0;idx !ğ
t£t_size_
; ++tidx) {

757 
™
 = (
tidx
 % 
t£t_chunk
 ? iˆ+ 1 : 
t£t_
[tidx/tset_chunk]);

758 ià(
™
->
	`cc_mode
(è=ğ
CCMode
::
tiùoc
) {

759 
boŞ
 
com´es£d
 = 
™
->
	`is_tiùoc_com´es£d
();

760 
tid_ty³
 
t
;

761 ià(
™
->
	`has_wr™e
()) {

762 
t
 = (
com´es£d
 ? 
™
->
tiùoc_ãtch_ts_Üigš
<
TicTocCom´es£dV”siÚ
<>>().
	`»ad_time¡amp
()

763 : 
™
->
tiùoc_ãtch_ts_Üigš
<
TicTocV”siÚ
<>>().
	`»ad_time¡amp
())

766 
t
 = 
com´es£d
 ? 
™
->
tiùoc_exŒaù_»ad_ts
<
TicTocCom´es£dV”siÚ
<>>().
	`wr™e_time¡amp
()

767 : 
™
->
tiùoc_exŒaù_»ad_ts
<
TicTocV”siÚ
<>>().
	`wr™e_time¡amp
();

769 
comm™_ts
 = 
¡d
::
	`max
(comm™_ts, 
t
);

772  
comm™_ts
;

773 
	}
}

	@sto-core/ContentionManager.cc

1 
	~"CÚ‹ÁiÚMªag”.hh
"

2 
	~"T¿n§ùiÚ.hh
"

6 
boŞ
 
	gCÚ‹ÁiÚMªag”
::
	$should_abÜt
(
this_id
, 
owÃr_id
) {

7 
	`TXP_INCREMENT
(
txp_cm_shouldabÜt
);

8 
this_id
 *= 4;

9 
	`acquœe_ãnû
();

10 ià(
abÜ‹d
[
this_id
] == 1){

11  
Œue
;

15 
	`acquœe_ãnû
();

16 ià(
time¡amp
[
this_id
] =ğ
MAX_TS
) {

17  
Œue
;

20 
owÃr_id
 *= 4;

22 ià(
time¡amp
[
owÃr_id
] <ime¡amp[
this_id
]) {

23 
	`acquœe_ãnû
();

24  (
abÜ‹d
[
owÃr_id
] == 0);

27 
abÜ‹d
[
owÃr_id
] = 1;

28 
	`»Ëa£_ãnû
();

29  
çl£
;

32 
	}
}

34 
boŞ
 
	gCÚ‹ÁiÚMªag”
::
	$Ú_wr™e
(
th»adid
) {

35 
	`TXP_INCREMENT
(
txp_cm_Úwr™e
);

36 
th»adid
 *= 4;

37 ià(
abÜ‹d
[
th»adid
] == 1) {

38  
çl£
;

40 
wr™e_£t_size
[
th»adid
] += 1;

41 ià(
time¡amp
[
th»adid
] =ğ
MAX_TS
 && 
wr™e_£t_size
[th»adid] =ğ
TS_THRESHOLD
) {

42 
time¡amp
[
th»adid
] = 
	`ãtch_ªd_add
(&
ts
, 
	`ušt64_t
(1));

45  
Œue
;

46 
	}
}

48 
	gCÚ‹ÁiÚMªag”
::
	$¡¬t
(
T¿n§ùiÚ
 *
tx
) {

49 
	`TXP_INCREMENT
(
txp_cm_¡¬t
);

50 
th»adid
 = 
tx
->
	`th»adid
();

51 
th»adid
 *= 4;

52 ià(
tx
->
	`is_»¡¬‹d
()) {

54 
time¡amp
[
th»adid
] = 
MAX_TS
;

55 
abÜ‹d
[
th»adid
] = 0;

56 
wr™e_£t_size
[
th»adid
] = 0;

58 
time¡amp
[
th»adid
] = 
MAX_TS
;

59 
abÜ‹d
[
th»adid
] = 0;

60 
wr™e_£t_size
[
th»adid
] = 0;

61 
abÜt_couÁ
[
th»adid
] = 0;

63 
	}
}

65 
	gCÚ‹ÁiÚMªag”
::
	$Ú_rŞlback
(
th»adid
) {

66 
	`TXP_INCREMENT
(
txp_cm_ÚrŞlback
);

67 
th»adid
 *= 4;

68 ià(
abÜt_couÁ
[
th»adid
] < 
SUCC_ABORTS_MAX
)

69 ++
abÜt_couÁ
[
th»adid
];

70 
ušt64_t
 
cyşes_to_wa™
 = 
	`¿nd_r
((*)&
£ed
[
th»adid
]è% (
abÜt_couÁ
[th»adid] * 
WAIT_CYCLES_MULTIPLICATOR
);

71 
	`wa™_cyşes
(
cyşes_to_wa™
);

72 
	}
}

75 
ušt64_t
 
	gCÚ‹ÁiÚMªag”
::
ts
 = 0;

76 
ušt128_t
 
	gCÚ‹ÁiÚMªag”
::
abÜ‹d
[4*
MAX_THREADS
] = { 0 };

77 
ušt128_t
 
	gCÚ‹ÁiÚMªag”
::
time¡amp
[4*
MAX_THREADS
] = { 0 };

78 
ušt128_t
 
	gCÚ‹ÁiÚMªag”
::
wr™e_£t_size
[4*
MAX_THREADS
] = { 0 };

79 
ušt128_t
 
	gCÚ‹ÁiÚMªag”
::
abÜt_couÁ
[4*
MAX_THREADS
] = { 0 };

80 
ušt128_t
 
	gCÚ‹ÁiÚMªag”
::
v”siÚ
[4*
MAX_THREADS
] = { 0 };

81 
ušt128_t
 
	gCÚ‹ÁiÚMªag”
::
£ed
[4*
MAX_THREADS
];

	@sto-core/ContentionManager.hh

1 #´agm¨
Úû


3 
	~"IÁ”çû.hh
"

4 
	~"timšg.hh
"

5 
	~<şim™s
>

7 
	#MAX_TS
 
UINT_MAX


	)

8 
	#TS_THRESHOLD
 10

	)

9 
	#SUCC_ABORTS_MAX
 10

	)

10 
	#WAIT_CYCLES_MULTIPLICATOR
 8000

	)

12 
	#MAX_THREADS
 128

	)

14 
__ušt128_t
 
	tušt128_t
;

16 
şass
 
	gT¿n§ùiÚ
;

18 şas 
	cCÚ‹ÁiÚMªag”
 {

19 
	mpublic
:

20 
boŞ
 
should_abÜt
(
this_id
, 
owÃr_id
);

22 
boŞ
 
Ú_wr™e
(
th»adid
);

24 
¡¬t
(
T¿n§ùiÚ
 *
tx
);

26 
Ú_rŞlback
(
th»adid
);

28 
	mpublic
:

30 
ušt64_t
 
ts
;

32 
ušt128_t
 
	mabÜ‹d
[4*
MAX_THREADS
];

33 
ušt128_t
 
	mtime¡amp
[4*
MAX_THREADS
];

34 
ušt128_t
 
	mwr™e_£t_size
[4*
MAX_THREADS
];

35 
ušt128_t
 
	mabÜt_couÁ
[4*
MAX_THREADS
];

36 
ušt128_t
 
	mv”siÚ
[4*
MAX_THREADS
];

37 
ušt128_t
 
	m£ed
[4*
MAX_THREADS
];

	@sto-core/EagerVersions.hh

1 #´agm¨
Úû


7 
	~"V”siÚBa£.hh
"

8 
	~"TTh»ad.hh
"

10 şas 
	cLockRe¥Ú£
 : {
locked
, 
	mçed
, 
	mİtimi¡ic
, 
	m¥š
};

12 
	g‹m¶©e
 <
boŞ
 
	gAd­tive
>

13 
şass
 
	gTLockV”siÚ
 : 
public
 
BasicV”siÚ
<
TLockV”siÚ
<
Ad­tive
>> {

14 
public
:

15 
T¿n§ùiÚTid
::
	tty³
ype;

16 
cÚ¡ex´
 
ty³
 
	gmask
 = 
T¿n§ùiÚTid
::
th»adid_mask
;

17 
cÚ¡ex´
 
ty³
 
	g¾ock_út_max
 =ype(0x10);

18 
cÚ¡ex´
 
ty³
 
	glock_b™
 = 
T¿n§ùiÚTid
::
lock_b™
;

19 
cÚ¡ex´
 
ty³
 
	gİt_b™
 = 
T¿n§ùiÚTid
::
İt_b™
;

20 
cÚ¡ex´
 
ty³
 
	gdœty_b™
 = 
T¿n§ùiÚTid
::
dœty_b™
;

22 
usšg
 
	gBV
 = 
BasicV”siÚ
<
TLockV”siÚ
<
Ad­tive
>>;

23 
usšg
 
	gBV
::
v_
;

25 
TLockV”siÚ
() = ;

26 
ex¶ic™
 
TLockV”siÚ
(
ty³
 
v
)

27 : 
BV
(
v
) {}

28 
TLockV”siÚ
(
ty³
 
v
, 
boŞ
 
š£¹
)

29 : 
BV
(
v
 | (
š£¹
 ? 
lock_b™
 : 0)) {}

31 
boŞ
 
ı_Œy_lock_im¶
(
T¿nsI‹m
& 
™em
, 
th»adid
) {

32 ()
	g™em
;

33 ()
	gth»adid
;

34 
	gv_
 |ğ
dœty_b™
;

35 
»Ëa£_ãnû
();

36  
	gŒue
;

39 
ı_uÆock_im¶
(
T¿nsI‹m
& 
™em
) {

40 
as£¹
(
™em
.
Ãeds_uÆock
());

41 ià(
	g™em
.
has_wr™e
()) {

42 
uÆock_wr™e
();

43 
»Ëa£_ãnû
();

45 
as£¹
(
™em
.
has_»ad
());

46 
uÆock_»ad
();

49 
boŞ
 
ı_check_v”siÚ_im¶
(
T¿n§ùiÚ
& 
txn
, 
T¿nsI‹m
& 
™em
) {

50 ()
	gtxn
;

51 
ty³
 
	gvv
 = 
v_
;

52 
ãnû
();

53 ià(
	gT¿n§ùiÚTid
::
is_dœty
(
vv
è&& !
™em
.
has_wr™e
())

54  
çl£
;

55  
	gT¿n§ùiÚTid
::
check_v”siÚ
(
vv
, 
™em
.
»ad_v®ue
<
ty³
>());

57 
ı_£t_v”siÚ_uÆock_im¶
(
ty³
 
Ãw_v
) {

58 
	gT¿n§ùiÚTid
::
£t_v”siÚ_uÆock_dœty
(
v_
, 
Ãw_v
);

61 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
);

62 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

63 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, cÚ¡ 
T
& 
wd©a
);

64 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

65 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
T
&& 
wd©a
);

66 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

67 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
Args
&&... 
¬gs
);

69 
šlše
 
boŞ
 
ob£rve_»ad_im¶
(
T¿nsI‹m
& 
™em
, boŞ 
add_»ad
);

71 
šlše
 
	gty³
& 
ı_acûss_tid_im¶
(
T¿n§ùiÚ
& 
txn
);

72 
šlše
 
ty³
 
ı_comm™_tid_im¶
(
T¿n§ùiÚ
& 
txn
);

74 
boŞ
 
hšt_İtimi¡ic
() const {

75 
acquœe_ãnû
();

76  (
	gv_
 & 
	gİt_b™
) != 0;

79 
	g´iv©e
:

81 
¡d
::
·œ
<
LockRe¥Ú£
, 
	gty³
> 
Œy_lock_»ad
() {

82 
	gŒue
) {

83 
ty³
 
	gvv
 = 
v_
;

84 
boŞ
 
	gwr™e_locked
 = ((
vv
 & 
lock_b™
) != 0);

85 
ty³
 
	g¾ock_út
 = 
vv
 & 
mask
;

86 
boŞ
 
	g¾ock_ava
 = 
¾ock_út
 < 
¾ock_út_max
;

87 ià(
	gwr™e_locked
)

88  
	g¡d
::
make_·œ
(
LockRe¥Ú£
::
¥š
, 
ty³
());

89 ià(!
	g¾ock_ava
) {

90  
	g¡d
::
make_·œ
(
LockRe¥Ú£
::
İtimi¡ic
, 
vv
);

92 ià(::
boŞ_cmpxchg
(&
v_
, 
vv
, (vv & ~
mask
è| (
¾ock_út
+1)))

93  
	g¡d
::
make_·œ
(
LockRe¥Ú£
::
locked
, 
ty³
());

95 
»Ïx_ãnû
();

99 
LockRe¥Ú£
 
Œy_lock_wr™e
() {

100 
	gŒue
) {

101 
ty³
 
	gvv
 = 
v_
;

102 
boŞ
 
	gwr™e_locked
 = ((
vv
 & 
lock_b™
) != 0);

103 
boŞ
 
	g»ad_locked
 = ((
vv
 & 
mask
) != 0);

104 ià(
	gwr™e_locked
 || 
	g»ad_locked
)

105  
	gLockRe¥Ú£
::
¥š
;

106 ià(::
boŞ_cmpxchg
(&
v_
, 
vv
, (vv | 
lock_b™
)))

107  
	gLockRe¥Ú£
::
locked
;

109 
»Ïx_ãnû
();

113 
LockRe¥Ú£
 
Œy_upg¿de
() {

115 
ty³
 
	gvv
 = 
v_
;

116 
ty³
 
	g¾ock_út
 = 
vv
 & 
mask
;

117 
as£¹
(!
T¿n§ùiÚTid
::
is_locked
(
vv
));

118 
as£¹
(
¾ock_út
 >= 1);

119 ià((
	g¾ock_út
 =ğ1è&& ::
boŞ_cmpxchg
(&
v_
, 
vv
, (vv - 1è| 
lock_b™
))

120  
	gLockRe¥Ú£
::
locked
;

122  
	gLockRe¥Ú£
::
¥š
;

125 
uÆock_»ad
() {

126 ià(!
	gAd­tive
) {

127 
ty³
 
	gvv
 = 
__sync_ãtch_ªd_add
(&
v_
, -1);

128 ()
	gvv
;

129 
as£¹
((
vv
 & 
mask
) >= 1);

131 
boŞ
 
	g»£t_İt_b™
 = 
TTh»ad
::
g’
[TTh»ad::
id
()].
chªû
(50);

132 ià(!
	g»£t_İt_b™
) {

133 
ãtch_ªd_add
(&
v_
, -1);

136 
ty³
 
	gvv
 = 
v_
;

137 
as£¹
((
vv
 & 
mask
) >= 1);

138 
ty³
 
	gÃw_v
 = (
vv
 - 1è| 
İt_b™
;

139 ià(::
boŞ_cmpxchg
(&
v_
, 
vv
, 
Ãw_v
))

141 
»Ïx_ãnû
();

147 
uÆock_wr™e
() {

148 
as£¹
(
BV
::
is_locked
());

149 
ty³
 
	gÃw_v
;

150 ià(!
	gAd­tive
) {

151 
	gÃw_v
 = 
v_
 & ~(
lock_b™
 | 
dœty_b™
 | 
İt_b™
);

153 
	gÃw_v
 = 
v_
 & ~(
lock_b™
 | 
dœty_b™
);

154 ià(((
	gÃw_v
 & 
	gİt_b™
è!ğ0è&& 
TTh»ad
::
g’
[TTh»ad::
id
()].
chªû
(50)) {

155 
Ãw_v
 &ğ~
İt_b™
;

158 
	gv_
 = 
Ãw_v
;

159 
»Ëa£_ãnû
();

162 
šlše
 
boŞ
 
Œy_upg¿de_w™h_¥š
();

163 
šlše
 
boŞ
 
Œy_lock_wr™e_w™h_¥š
();

164 
šlše
 
	g¡d
::
·œ
<
LockRe¥Ú£
, 
	gty³
> 
Œy_lock_»ad_w™h_¥š
();

165 
šlše
 
boŞ
 
lock_fÜ_wr™e
(
T¿nsI‹m
& 
™em
);

168 
	g‹m¶©e
 <
boŞ
 
	gO·c™y
>

169 
şass
 
	gTSwissV”siÚ
 : 
public
 
BasicV”siÚ
<
TSwissV”siÚ
<
O·c™y
>> {

170 
public
:

171 
T¿n§ùiÚTid
::
	tty³
ype;

172 
cÚ¡ex´
 
boŞ
 
	gis_İaque
 = 
O·c™y
;

173 
cÚ¡ex´
 
ty³
 
	glock_b™
 = 
T¿n§ùiÚTid
::
lock_b™
;

174 
cÚ¡ex´
 
ty³
 
	gth»adid_mask
 = 
T¿n§ùiÚTid
::
th»adid_mask
;

175 
cÚ¡ex´
 
ty³
 
	gdœty_b™
 = 
T¿n§ùiÚTid
::
dœty_b™
;

177 
usšg
 
	gBV
 = 
BasicV”siÚ
<
TSwissV”siÚ
<
O·c™y
>>;

178 
usšg
 
	gBV
::
v_
;

180 
TSwissV”siÚ
()

181 : 
BV
(
O·c™y
 ? 
T¿n§ùiÚTid
::
nÚİaque_b™
 : 0) {}

182 
ex¶ic™
 
TSwissV”siÚ
(
ty³
 
v
, 
boŞ
 
š£¹
 = 
Œue
)

183 : 
BV
(
v
 | (
š£¹
 ? (
lock_b™
 | 
TTh»ad
::
id
()) : 0)) {

184 ià(
O·c™y
)

185 
v_
 |ğ
T¿n§ùiÚTid
::
nÚİaque_b™
;

189 
boŞ
 
ı_Œy_lock_im¶
(
T¿nsI‹m
& 
™em
, 
th»adid
) {

190 ()
	g™em
;

191 ()
	gth»adid
;

192 
as£¹
(
BV
::
is_locked_h”e
(
th»adid
));

193 
	gv_
 |ğ
dœty_b™
;

194 
»Ëa£_ãnû
();

195  
	gŒue
;

197 
ı_uÆock_im¶
(
T¿nsI‹m
& 
™em
) {

198 ()
	g™em
;

199 
as£¹
(
™em
.
Ãeds_uÆock
());

200 ià(
	gBV
::
is_locked
()) {

201 
T¿n§ùiÚTid
::
uÆock_dœty
(
v_
);

204 
boŞ
 
ı_check_v”siÚ_im¶
(
T¿n§ùiÚ
& 
txn
, 
T¿nsI‹m
& 
™em
) {

205 ()
	gtxn
;

206 
ty³
 
	gvv
 = 
v_
;

207 
ãnû
();

208 ià(
	gT¿n§ùiÚTid
::
is_dœty
(
vv
è&& !
T¿n§ùiÚTid
::
is_locked_h”e
(vv))

209  
çl£
;

210  
	gT¿n§ùiÚTid
::
check_v”siÚ
(
vv
, 
™em
.
»ad_v®ue
<
ty³
>());

212 
ı_£t_v”siÚ_uÆock_im¶
(
ty³
 
Ãw_v
) {

213 
	gT¿n§ùiÚTid
::
£t_v”siÚ_uÆock_dœty
(
v_
, 
Ãw_v
);

216 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
);

217 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

218 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, cÚ¡ 
T
& 
wd©a
);

219 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

220 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
T
&& 
wd©a
);

221 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

222 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
Args
&&... 
¬gs
);

224 
šlše
 
boŞ
 
ob£rve_»ad_im¶
(
T¿nsI‹m
& 
™em
, boŞ 
add_»ad
);

226 
šlše
 
	gty³
& 
ı_acûss_tid_im¶
(
T¿n§ùiÚ
& 
txn
);

227 
šlše
 
ty³
 
ı_comm™_tid_im¶
(
T¿n§ùiÚ
& 
txn
);

229 
	g´iv©e
:

230 
ty³
 
Œy_lock_v®
() {

231  
T¿n§ùiÚTid
::
Œy_lock_v®
(
v_
);

	@sto-core/Interface.hh

1 #´agm¨
Úû


2 
	~<c¡dšt
>

3 
	~<ÿs£¹
>

4 
	~<io¡»am
>

5 
	~<¿ndom
>

7 
	~"cÚfig.h
"

8 
	~"comp”.hh
"

10 
şass
 
	gT¿n§ùiÚ
;

11 
şass
 
	gT¿nsI‹m
;

13 şas 
	cTObjeù
 {

14 
	mpublic
:

15 
vœtu®
 ~
TObjeù
() = ;

17 
vœtu®
 
boŞ
 
lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
) = 0;

18 
vœtu®
 
boŞ
 
	$check_´ediÿ‹
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
, 
boŞ
 
comm™tšg
) {

19 (è
™em
, (è
txn
, (è
comm™tšg
;

21  
çl£
;

23 
vœtu®
 
boŞ
 
	`check
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
) = 0;

24 
vœtu®
 
	`š¡®l
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
) = 0;

25 
vœtu®
 
	`uÆock
(
T¿nsI‹m
& 
™em
) = 0;

26 
vœtu®
 
	$ş—nup
(
T¿nsI‹m
& 
™em
, 
boŞ
 
comm™‹d
) {

27 (è
™em
, (è
comm™‹d
;

28 
	}
}

29 
vœtu®
 
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
) const;

30 
	}
};

32 
TObjeù
 
	tSh¬ed
;

	@sto-core/OCCVersions.hh

1 #´agm¨
Úû


3 
	~"V”siÚBa£.hh
"

6 
şass
 
	gTV”siÚ
 : 
public
 
BasicV”siÚ
<
TV”siÚ
> {

7 
public
:

8 
TV”siÚ
() = ;

9 
ex¶ic™
 
TV”siÚ
(
ty³
 
v
)

10 : 
BasicV”siÚ
(
v
) {}

11 
TV”siÚ
(
ty³
 
v
, 
boŞ
 
š£¹
)

12 : 
BasicV”siÚ
(
v
è{()
š£¹
;}

14 
boŞ
 
ı_check_v”siÚ_im¶
(
T¿n§ùiÚ
& 
txn
, 
T¿nsI‹m
& 
™em
) {

15 ()
	gtxn
;

16 
as£¹
(
™em
.
has_»ad
());

17 ià(
	gT¿n§ùiÚTid
::
is_locked
(
v_
è&& !
™em
.
has_wr™e
())

18  
çl£
;

19  
check_v”siÚ
(
™em
.
»ad_v®ue
<
TV”siÚ
>());

22 
šlše
 
boŞ
 
ob£rve_»ad_im¶
(
T¿nsI‹m
& 
™em
, boŞ 
add_»ad
);

24 
šlše
 
ty³
 
¢­shÙ
(cÚ¡ 
T¿nsI‹m
& 
™em
, cÚ¡ 
T¿n§ùiÚ
& 
txn
);

25 
šlše
 
ty³
 
¢­shÙ
(
T¿nsProxy
& 
™em
);

27 
šlše
 
	gty³
& 
ı_acûss_tid_im¶
(
T¿n§ùiÚ
& 
txn
);

28 
šlše
 
ty³
 
ı_comm™_tid_im¶
(
T¿n§ùiÚ
& 
txn
);

32 
şass
 
	gTNÚİaqueV”siÚ
 : 
public
 
BasicV”siÚ
<
TNÚİaqueV”siÚ
> {

33 
public
:

34 
TNÚİaqueV”siÚ
()

35 : 
BasicV”siÚ
<
TNÚİaqueV”siÚ
>(
T¿n§ùiÚTid
::
nÚİaque_b™
) {}

36 
ex¶ic™
 
TNÚİaqueV”siÚ
(
ty³
 
v
)

37 : 
BasicV”siÚ
<
TNÚİaqueV”siÚ
>(
v
 | 
T¿n§ùiÚTid
::
nÚİaque_b™
) {}

38 
TNÚİaqueV”siÚ
(
ty³
 
v
, 
boŞ
 
š£¹
)

39 : 
BasicV”siÚ
<
TNÚİaqueV”siÚ
>(
v
 | 
T¿n§ùiÚTid
::
nÚİaque_b™
è{()
š£¹
;};

41 
boŞ
 
ı_check_v”siÚ_im¶
(
T¿n§ùiÚ
& 
txn
, 
T¿nsI‹m
& 
™em
) {

42 ()
	gtxn
;

43 
as£¹
(
™em
.
has_»ad
());

44 ià(
	gT¿n§ùiÚTid
::
is_locked
(
v_
è&& !
™em
.
has_wr™e
())

45  
çl£
;

46  
check_v”siÚ
(
™em
.
»ad_v®ue
<
TNÚİaqueV”siÚ
>());

49 
šlše
 
boŞ
 
ob£rve_»ad_im¶
(
T¿nsI‹m
& 
™em
, boŞ 
add_»ad
);

51 
šlše
 
ty³
 
¢­shÙ
(cÚ¡ 
T¿nsI‹m
& 
™em
, cÚ¡ 
T¿n§ùiÚ
& 
txn
);

52 
šlše
 
ty³
 
¢­shÙ
(
T¿nsProxy
& 
™em
);

54 
šlše
 
	gty³
& 
ı_acûss_tid_im¶
(
T¿n§ùiÚ
& 
txn
);

55 
šlše
 
ty³
 
ı_comm™_tid_im¶
(
T¿n§ùiÚ
& 
txn
);

59 
şass
 
	gTCommutiveV”siÚ
 : 
BasicV”siÚ
<
TCommutiveV”siÚ
> {

60 
public
:

61 
T¿n§ùiÚTid
::
	tty³
ype;

64 
cÚ¡ex´
 
ty³
 
	glock_mask
 = 
T¿n§ùiÚTid
::
th»adid_mask
;

66 
usšg
 
	gBasicV”siÚ
<
	gTCommutiveV”siÚ
>::
v_
;

68 
TCommutiveV”siÚ
() = ;

69 
ex¶ic™
 
TCommutiveV”siÚ
(
ty³
 
v
)

70 : 
BasicV”siÚ
<
TCommutiveV”siÚ
>(
v
) {}

72 
boŞ
 
ı_Œy_lock_im¶
(
T¿nsI‹m
& 
™em
, 
th»adid
) {

73 ()
	g™em
;

74 ()
	gth»adid
;

75  
Œy_lock
();

77 
ı_uÆock_im¶
(
T¿nsI‹m
& 
™em
) {

78 ()
	g™em
;

79 
uÆock
();

81 
ı_£t_v”siÚ_uÆock_im¶
(
TCommutiveV”siÚ
 
Ãw_v
) {

82 (è
	gÃw_v
;

83 
®ways_as£¹
(
çl£
, "not implemented");

85 
ı_£t_v”siÚ_im¶
(
TCommutiveV”siÚ
 
Ãw_v
) {

86 
£t_v”siÚ
(
Ãw_v
);

88 
boŞ
 
ı_check_v”siÚ_im¶
(
T¿nsI‹m
& 
™em
) {

89 autØ
	gŞd_v”s
 = 
™em
.
»ad_v®ue
<
TCommutiveV”siÚ
>();

90 
	glock
 = 
™em
.
Ãeds_uÆock
()? 1 : 0;

91  
	gv_
 =ğ(
Şd_v”s
.
v_
 | 
lock
);

93 
šc_nÚİaque_im¶
() {

94 
šc_nÚİaque_v”siÚ
();

97 
šlše
 
boŞ
 
ob£rve_»ad_im¶
(
T¿nsI‹m
& 
™em
, boŞ 
add_»ad
);

99 
šlše
 
	gty³
& 
ı_acûss_tid_im¶
(
T¿n§ùiÚ
& 
txn
);

100 
šlše
 
ty³
 
ı_comm™_tid_im¶
(
T¿n§ùiÚ
& 
txn
);

102 
	g´iv©e
:

103 
boŞ
 
is_locked
() const {

104  (
v_
 & 
lock_mask
) > 0;

106 
num_locks
() const {

107  (
	gv_
 & 
	glock_mask
);

110 
boŞ
 
Œy_lock
() {

111 
lock
();

113  
	gŒue
;

115 
lock
() {

116 
__sync_ãtch_ªd_add
(&
v_
, 1);

118 
uÆock
() {

119 
__sync_ãtch_ªd_add
(&
v_
, -1);

122 
ty³
 
uÆocked
() const {

123  
	gT¿n§ùiÚTid
::
uÆocked
(
v_
);

126 
£t_v”siÚ
(
TCommutiveV”siÚ
 
Ãw_v
) {

127 
as£¹
((
Ãw_v
.
v_
 & 
lock_mask
) == 0);

128 
	gŒue
) {

129 
ty³
 
	gcur
 = 
v_
;

130 
ãnû
();

138 ià(
	gT¿n§ùiÚTid
::
uÆocked
(
cur
è> 
Ãw_v
.unlocked())

141 
ty³
 
	gcur_acquœed
 = 
cur
 & 
lock_mask
;

142 ià(::
boŞ_cmpxchg
(&
v_
, 
cur
, 
Ãw_v
.v_ | 
cur_acquœed
))

144 
»Ïx_ãnû
();

148 
šc_nÚİaque_v”siÚ
() {

149 
as£¹
(
is_locked
());

152 
	gŒue
) {

153 
ty³
 
	gcur
 = 
v_
;

154 
ãnû
();

155 
ty³
 
	gÃw_v
 = (
cur
 + 
T¿n§ùiÚTid
::
šüem’t_v®ue
è| T¿n§ùiÚTid::
nÚİaque_b™
;

156 
»Ëa£_ãnû
();

157 ià(::
boŞ_cmpxchg
(&
v_
, 
cur
, 
Ãw_v
))

159 
»Ïx_ãnû
();

	@sto-core/Packer.cc

1 
	~"Pack”.hh
"

3 
cÚ¡ex´
 
size_t
 
	gT¿n§ùiÚBufãr
::
deçuÉ_ÿ·c™y
;

5 
	gT¿n§ùiÚBufãr
::
	$h¬d_g‘_¥aû
(
size_t
 
Ãeded
) {

6 
size_t
 
s
 = 
¡d
::
	`max
(
Ãeded
, 
e_
 ?ƒ_->
ÿ·c™y
 * 2 : 
deçuÉ_ÿ·c™y
);

7 
–t
* 
Ã
 = (–t*è
Ãw
 [(
–thdr
è+ 
s
];

8 
Ã
->
Ãxt
 = 
e_
;

9 
Ã
->
pos
 = 0;

10 
Ã
->
ÿ·c™y
 = 
s
;

11 ià(
e_
)

12 
lšked_size_
 +ğ
e_
->
pos
;

13 
e_
 = 
Ã
;

14 
	}
}

16 
	gT¿n§ùiÚBufãr
::
	$h¬d_ş—r
(
boŞ
 
d–‘e_®l
) {

17 
e_
 &&ƒ_->
Ãxt
) {

18 
–t
* 
e
 = 
e_
->
Ãxt
;

19 
e_
->
Ãxt
 = 
e
->next;

20 
e
->
	`ş—r
();

21 
d–‘e
[] (*è
e
;

23 ià(
e_
)

24 
e_
->
	`ş—r
();

25 
lšked_size_
 = 0;

26 ià(
e_
 && 
d–‘e_®l
) {

27 
d–‘e
[] (*è
e_
;

28 
e_
 = 0;

30 
	}
}

	@sto-core/Packer.hh

1 #´agm¨
Úû


2 
	~"comp”.hh
"

3 
	~<®gÜ™hm
>

5 
şass
 
	gT¿n§ùiÚBufãr
;

8 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

9 
__©Œibu‹__
((
may_®Ÿs
)è
	gAlŸ§bË
 {

10 
T
 
	gx
;

13 
	g‹m¶©e
 <
ty³Çme
 
	gT
,

14 
boŞ
 
	gsim¶e
 = (
mass
::
is_ŒivŸÎy_cİyabË
<
T
>::
v®ue


15 && (
T
) <= (*))>

16 
	sPack”
 {};

20 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	sObjeùDe¡roy”
 {

21 
de¡roy
(* 
objeù
) {

22 
	m»š‹½»t_ÿ¡
<
	mT
*>(
	mobjeù
)->~
T
();

24 
de¡roy_ªd_ä“
(* 
objeù
) {

25 
d–‘e
 
	m»š‹½»t_ÿ¡
<
	mT
*>(
	mobjeù
);

27 
de¡roy_ªd_ä“_¬¿y
(* 
objeù
) {

28 
	md–‘e
[] 
	m»š‹½»t_ÿ¡
<
	mT
*>(
	mobjeù
);

32 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	sUniqueKey
 {

33 
T
 
	mkey
;

34 
	m‹m¶©e
 <
	mty³Çme
... 
	mArgs
>

35 
UniqueKey
(
Args
&&... 
¬gs
)

36 : 
key
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {

38 
boŞ
 
İ”©Ü
==(cÚ¡ 
T
& 
x
) const {

39  
key
 =ğ
x
;

43 şas 
	cT¿n§ùiÚBufãr
 {

44 
	m–t
;

45 
	m™em
;

47 
	mpublic
:

48 
	$T¿n§ùiÚBufãr
()

49 : 
	`e_
(), 
	$lšked_size_
(0) {

51 ~
	$T¿n§ùiÚBufãr
() {

52 ià(
e_
)

53 
	`h¬d_ş—r
(
Œue
);

54 
	}
}

56 
cÚ¡ex´
 
size_t
 
	$®igÃd_size
(
size_t
 
x
) {

57  (
x
 + 7) & ~7;

58 
	}
}

60 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

61 
šlše
 
T
* 
®loÿ‹
(
Args
&&... 
¬gs
);

63 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
 = 
T
>

64 cÚ¡ 
T
* 
	$fšd
(cÚ¡ 
U
& 
x
) const;

66 
size_t
 
	$bufãr_size
() const {

67  
lšked_size_
 + (
e_
 ?ƒ_->
pos
 : 0);

68 
	}
}

69 
	$ş—r
() {

70 ià(
e_
 &&ƒ_->
pos
)

71 
	`h¬d_ş—r
(
çl£
);

72 
	}
}

74 
	g´iv©e
:

75 
cÚ¡ex´
 
size_t
 
deçuÉ_ÿ·c™y
 = 4080;

76 
	s™emhdr
 {

77 (*
	gde¡roy”
)(*);

78 
size_t
 
	gsize
;

80 
	g™em
 : 
public
 
™emhdr
 {

81 
buf
[0];

83 
	s–thdr
 {

84 
–t
* 
	gÃxt
;

85 
size_t
 
	gpos
;

86 
size_t
 
	gÿ·c™y
;

88 
	g–t
 : 
public
 
–thdr
 {

89 
buf
[0];

90 
ş—r
() {

91 
size_t
 
	goff
 = 0;

92 
	goff
 < 
	gpos
) {

93 
™emhdr
* 
	gi
 = (™emhdr*è&
buf
[
off
];

94 
	gi
->
de¡roy”
(
i
 + 1);

95 
	goff
 +ğ
i
->
size
;

97 
	gpos
 = 0;

100 
–t
* 
	ge_
;

101 
size_t
 
	glšked_size_
;

103 
™em
* 
	$g‘_¥aû
(
size_t
 
Ãeded
) {

104 ià(!
e_
 ||ƒ_->
pos
 + 
Ãeded
 >ƒ_->
ÿ·c™y
)

105 
	`h¬d_g‘_¥aû
(
Ãeded
);

106 
e_
->
pos
 +ğ
Ãeded
;

107  (
™em
*è&
e_
->
buf
[e_->
pos
 - 
Ãeded
];

108 
	}
}

109 
h¬d_g‘_¥aû
(
size_t
 
Ãeded
);

110 
h¬d_ş—r
(
boŞ
 
d–‘e_®l
);

113 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

114 
T
* 
	gT¿n§ùiÚBufãr
::
	$®loÿ‹
(
Args
&&... 
¬gs
) {

115 
size_t
 
isize
 = 
	`®igÃd_size
((
™emhdr
è+ (
T
));

116 
™em
* 
¥aû
 = 
this
->
	`g‘_¥aû
(
isize
);

117 
¥aû
->
de¡roy”
 = 
ObjeùDe¡roy”
<
T
>::
de¡roy
;

118 
¥aû
->
size
 = 
isize
;

119  
	`Ãw
 (&
¥aû
->
buf
[0]è
	`T
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

120 
	}
}

122 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

123 cÚ¡ 
T
* 
	gT¿n§ùiÚBufãr
::
	$fšd
(cÚ¡ 
U
& 
x
) const {

124 (*
de¡roy”
)(*èğ
ObjeùDe¡roy”
<
T
>::
de¡roy
;

125 
–t
* 
e
 = 
e_
;ƒ;ƒ =ƒ->
Ãxt
)

126 
size_t
 
off
 = 0; ofà< 
e
->
pos
; ) {

127 
™em
* 
i
 = (™em*è&
e
->
buf
[
off
];

128 ià(
i
->
de¡roy”
 == destroyer) {

129 cÚ¡ 
AlŸ§bË
<
T
>* 
cÚ‹Ás
 = (cÚ¡ AlŸ§bË<T>*è&
i
->
buf
[0];

130 ià(
cÚ‹Ás
->
x
 == x)

131  &
cÚ‹Ás
->
x
;

133 
off
 +ğ
i
->
size
;

135  
nuÎ±r
;

136 
	}
}

140 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gPack”
<T, 
	gŒue
> {

141 
cÚ¡ex´
 
boŞ
 
	gis_sim¶e
 = 
Œue
;

142 
T
 
	tty³
;

143 * 
·ck
(
T¿n§ùiÚBufãr
&, cÚ¡ 
T
& 
x
) {

144 * 
	gv
 = 0;

145 
memıy
(&
v
, &
x
, (
T
));

146  
	gv
;

148 * 
·ck_unique
(
T¿n§ùiÚBufãr
& 
buf
, cÚ¡ 
T
& 
x
) {

149  
·ck
(
buf
, 
x
);

151 * 
»·ck
(
T¿n§ùiÚBufãr
& 
buf
, *, cÚ¡ 
T
& 
x
) {

152  
·ck
(
buf
, 
x
);

154 
	gT
& 
uÅack
(*& 
p
) {

155  *(
	gT
*è&
	gp
;

157 cÚ¡ 
	gT
& 
uÅack
(* cÚ¡& 
p
) {

158  *(cÚ¡ 
	gT
*è&
	gp
;

162 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gPack”
<T, 
	gçl£
> {

163 
cÚ¡ex´
 
boŞ
 
	gis_sim¶e
 = 
çl£
;

164 
T
 
	tty³
;

165 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

166 * 
·ck
(
T¿n§ùiÚBufãr
& 
buf
, 
Args
&&... 
¬gs
) {

167  
	gbuf
.
‹m¶©e
 
	g®loÿ‹
<
	gT
>(
	g¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

169 * 
·ck_unique
(
T¿n§ùiÚBufãr
& 
buf
, cÚ¡ 
T
& 
x
) {

170 ià(cÚ¡ * 
	g±r
 = 
buf
.
‹m¶©e
 
fšd
<
UniqueKey
<
T
> >(
x
))

171  
cÚ¡_ÿ¡
<*>(
±r
);

173  
	gbuf
.
‹m¶©e
 
	g®loÿ‹
<
	gUniqueKey
<
	gT
> >(
	gx
);

175 * 
»·ck
(
T¿n§ùiÚBufãr
&, * 
p
, cÚ¡ 
T
& 
x
) {

176 
uÅack
(
p
èğ
x
;

177  
	gp
;

179 * 
»·ck
(
T¿n§ùiÚBufãr
&, * 
p
, 
T
&& 
x
) {

180 
uÅack
(
p
èğ
¡d
::
move
(
x
);

181  
	gp
;

183 
	gT
& 
uÅack
(* 
p
) {

184  *(
	gT
*è
	gp
;

	@sto-core/Sto.hh

1 #´agm¨
Úû


3 
	~"IÁ”çû.hh
"

4 
	~"T¿n§ùiÚ.hh
"

5 
	~"T¿nsI‹m.hh
"

6 
	~"CÚcu¼’cyCÚŒŞ.hh
"

7 
	~"TW¿µed.hh
"

	@sto-core/TRcu.cc

1 
	~"TRcu.hh
"

3 
	gTRcuS‘
::
	$TRcuS‘
()

4 : 
	$ş—n_•och_
(0) {

5 
ÿ·c™y
 = (4080 - (
TRcuGroup
)è/ (TRcuGroup::
TRcuEËm’t
);

6 
cu¼’t_
 = 
fœ¡_
 = 
TRcuGroup
::
	`make
(
ÿ·c™y
);

8 
	}
}

10 
	gTRcuS‘
::~
	$TRcuS‘
() {

11 
fœ¡_
) {

12 
TRcuGroup
* 
Ãxt
 = 
fœ¡_
->
Ãxt_
;

13 
TRcuGroup
::
	`ä“
(
fœ¡_
);

14 
fœ¡_
 = 
Ãxt
;

16 
cu¼’t_
 = 
nuÎ±r
;

18 
	}
}

20 
	gTRcuS‘
::
	$check
() {

22 
TRcuGroup
* 
fœ¡
 = 
fœ¡_
;

23 
n
 = () -1;

24 
boŞ
 
found_cu¼’t
 = 
çl£
;

25 
n
 > 0 && 
fœ¡
) {

26 
	`as£¹
(
fœ¡
->
h—d_
 <ğfœ¡->
_
);

27 
	`as£¹
(
fœ¡
->
_
 <ğfœ¡->
ÿ·c™y_
);

28 ià(
found_cu¼’t
)

29 
	`as£¹
(
fœ¡
->
h—d_
 =ğ0 && fœ¡->
_
 == 0);

30 ià(
fœ¡
 !ğ
cu¼’t_
)

31 
	`as£¹
(
fœ¡
->
h—d_
 !ğfœ¡->
_
);

32 
found_cu¼’t
 = found_cu¼’ˆ|| 
fœ¡
 =ğ
cu¼’t_
;

33 --
n
;

34 
fœ¡
 = fœ¡->
Ãxt_
;

36 
	`as£¹
(!
fœ¡
);

37 
	`as£¹
(
found_cu¼’t
);

40 
	}
}

42 
	gTRcuS‘
::
	$grow
() {

43 ià(!
cu¼’t_
->
Ãxt_
) {

44 
ÿ·c™y
 = (16368 - (
TRcuGroup
)è/ (TRcuGroup::
TRcuEËm’t
);

45 
cu¼’t_
->
Ãxt_
 = 
TRcuGroup
::
	`make
(
ÿ·c™y
);

48 
cu¼’t_
 = cu¼’t_->
Ãxt_
;

49 
	`as£¹
(
cu¼’t_
->
h—d_
 =ğ0 && cu¼’t_->
_
 == 0);

50 
	}
}

52 
šlše
 
boŞ
 
	gTRcuGroup
::
	$ş—n_uÁ
(
•och_ty³
 
max_•och
) {

53 
h—d_
 !ğ
_
 && 
	`sigÃd_•och_ty³
(
max_•och
 - 
e_
[h—d_].
u
.
•och
) > 0) {

54 ++
h—d_
;

55 
h—d_
 !ğ
_
 && 
e_
[h—d_].
funùiÚ
) {

56 
e_
[
h—d_
].
	`funùiÚ
Ó_[h—d_].
u
.
¬gum’t
);

57 ++
h—d_
;

60 ià(
h—d_
 =ğ
_
) {

61 
h—d_
 = 
_
 = 0;

62  
Œue
;

64  
çl£
;

65 
	}
}

67 
	gTRcuS‘
::
	$h¬d_ş—n_uÁ
(
•och_ty³
 
max_•och
) {

68 
TRcuGroup
* 
em±y_h—d
 = 
nuÎ±r
;

69 
TRcuGroup
* 
em±y_
 = 
nuÎ±r
;

71 
fœ¡_
->
	`ş—n_uÁ
(
max_•och
)) {

72 ià(!
em±y_h—d
)

73 
em±y_h—d
 = 
fœ¡_
;

74 
em±y_
 = 
fœ¡_
;

75 ià(
fœ¡_
 =ğ
cu¼’t_
) {

76 
fœ¡_
 = 
cu¼’t_
 = 
em±y_h—d
;

79 
fœ¡_
 = fœ¡_->
Ãxt_
;

82 ià(
em±y_h—d
) {

83 
em±y_
->
Ãxt_
 = 
cu¼’t_
->next_;

84 
cu¼’t_
->
Ãxt_
 = 
em±y_h—d
;

86 
	}
}

	@sto-core/TRcu.hh

1 #´agm¨
Úû


3 
	~<Ãw
>

4 
	~"comp”.hh
"

5 
	~<as£¹.h
>

7 
	sTRcuGroup
 {

8 
ušt64_t
 
	t•och_ty³
;

9 
št64_t
 
	tsigÃd_•och_ty³
;

11 
	sTRcuEËm’t
 {

12 (*
	mfunùiÚ
)(*);

14 * 
	m¬gum’t
;

15 
•och_ty³
 
	m•och
;

16 } 
	mu
;

19 
	mh—d_
;

20 
	m_
;

21 
	mÿ·c™y_
;

22 
•och_ty³
 
	m•och_
;

23 
TRcuGroup
* 
	mÃxt_
;

24 
TRcuEËm’t
 
	me_
[1];

26 
	m´iv©e
:

27 
TRcuGroup
(
ÿ·c™y
)

28 : 
h—d_
(0), 
_
(0), 
ÿ·c™y_
(
ÿ·c™y
), 
Ãxt_
(
nuÎ±r
) {

30 
TRcuGroup
(cÚ¡ TRcuGroup&èğ
d–‘e
;

31 ~
TRcuGroup
() {

32 
	mh—d_
 !ğ
_
) {

33 ià(
e_
[
h—d_
].
funùiÚ
)

34 
e_
[
h—d_
].
funùiÚ
Ó_[h—d_].
u
.
¬gum’t
);

35 ++
	mh—d_
;

39 
	mpublic
:

40 
TRcuGroup
* 
make
(
ÿ·c™y
) {

41 * 
x
 = 
Ãw
 [(
TRcuGroup
è+ (
TRcuEËm’t
è* (
ÿ·c™y
 - 1)];

42  
Ãw
(
x
è
TRcuGroup
(
ÿ·c™y
);

44 
ä“
(
TRcuGroup
* 
g
) {

45 
	mg
->~
TRcuGroup
();

46 
	md–‘e
[] 
	m»š‹½»t_ÿ¡
<*>(
	mg
);

49 
add
(
•och_ty³
 
•och
, (*
funùiÚ
)(*), * 
¬gum’t
) {

50 
as£¹
(
_
 + 2 <ğ
ÿ·c™y_
);

51 ià(
	mh—d_
 =ğ
_
 || 
•och_
 !ğ
•och
) {

52 
e_
[
_
].
funùiÚ
 = 
nuÎ±r
;

53 
	me_
[
_
].
	mu
.
	m•och
 = 
•och
;

54 
	m•och_
 = 
•och
;

55 ++
	m_
;

57 
	me_
[
_
].
	mfunùiÚ
 = 
funùiÚ
;

58 
	me_
[
_
].
	mu
.
	m¬gum’t
 = 
¬gum’t
;

59 ++
	m_
;

61 
šlše
 
boŞ
 
ş—n_uÁ
(
•och_ty³
 
max_•och
);

64 şas 
	cTRcuS‘
 {

65 
	mpublic
:

66 
TRcuGroup
::
	t•och_ty³
ƒpoch_type;

67 
	mTRcuGroup
::
	tsigÃd_•och_ty³
 signed_epoch_type;

69 
TRcuS‘
();

70 ~
TRcuS‘
();

72 
	$add
(
•och_ty³
 
•och
, (*
funùiÚ
)(*), * 
¬gum’t
) {

73 ià(
	`uÆik–y
(
cu¼’t_
->
_
 + 2 > cu¼’t_->
ÿ·c™y_
))

74 
	`grow
();

75 
cu¼’t_
->
	`add
(
•och
, 
funùiÚ
, 
¬gum’t
);

77 
	$ş—n_uÁ
(
•och_ty³
 
max_•och
) {

78 ià(
ş—n_•och_
 !ğ
max_•och
)

79 
	`h¬d_ş—n_uÁ
(
max_•och
);

80 
ş—n_•och_
 = 
max_•och
;

81 
	}
}

82 
•och_ty³
 
	$ş—n_•och
() const {

83  
ş—n_•och_
;

84 
	}
}

86 
	g´iv©e
:

87 
TRcuGroup
* 
cu¼’t_
;

88 
TRcuGroup
* 
	gfœ¡_
;

89 
•och_ty³
 
	gş—n_•och_
;

92 
TRcuS‘
(cÚ¡ TRcuS‘&èğ
d–‘e
;

93 
	gTRcuS‘
& 
	gİ”©Ü
=(cÚ¡ 
TRcuS‘
&èğ
d–‘e
;

94 
check
();

95 
grow
();

96 
h¬d_ş—n_uÁ
(
•och_ty³
 
max_•och
);

	@sto-core/TThread.hh

1 #´agm¨
Úû


3 
	~<ÿs£¹
>

4 
	~<¿ndom
>

6 
şass
 
	gT¿n§ùiÚ
;

8 
	sP”ûÁG’
 {

10 
	m¡d
::
mt19937
 
g’
;

11 
	m¡d
::
unifÜm_št_di¡ributiÚ
<> 
di¡
;

13 
P”ûÁG’
(è: 
g’
(0), 
di¡
(0,99) {}

14 ~
P”ûÁG’
() {}

16 
§m¶e
() {

17  
di¡
(
g’
);

19 
boŞ
 
chªû
(
³rûÁ
) {

20  (
§m¶e
(è< 
	m³rûÁ
);

24 şas 
	cTTh»ad
 {

25 
__th»ad
 
	mthe_id
;

26 
__th»ad
 
boŞ
 
	m®ways_®loÿ‹_
;

27 
__th»ad
 
	mhashsize_
;

28 
	mpublic
:

29 
__th»ad
 
T¿n§ùiÚ
* 
txn
;

30 
P”ûÁG’
 
	mg’
[];

32 
	$id
() {

33  
the_id
;

35 
	$£t_id
(
id
) {

36 
	`as£¹
(
id
 >= 0 && id < 128);

37 
the_id
 = 
id
;

38 
	}
}

39 
boŞ
 
	$®ways_®loÿ‹
() {

40  
®ways_®loÿ‹_
;

41 
	}
}

42 
	$£t_®ways_®loÿ‹
(
boŞ
 
®ways_®loÿ‹
) {

43 
®ways_®loÿ‹_
 = 
®ways_®loÿ‹
;

44 
	}
}

45 
	$hashsize
() {

46  
hashsize_
;

47 
	}
}

48 
	$£t_hashsize
(
hashsize
) {

49 
hashsize_
 = 
hashsize
;

50 
	}
}

	@sto-core/TWrapped.hh

1 #´agm¨
Úû


2 
	~<ut™y
>

4 
	~"CÚcu¼’cyCÚŒŞ.hh
"

6 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

7 
	sis_sm®l
 {

8 
cÚ¡ex´
 
boŞ
 
	mv®ue
 =

9 ((
T
è<ğ(
ušŒ_t
)è&& (
®ignof
(T) == (T));

12 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gO·que
 = 
Œue
,

13 
boŞ
 
	gTrivŸl
 = 
¡d
::
is_ŒivŸÎy_cİyabË
<
T
>::
v®ue
,

14 
boŞ
 
	gSm®l
 = 
is_sm®l
<
T
>::
v®ue


15 > 
şass
 
TW¿µed
;

17 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gO·que
 = 
Œue
,

18 
boŞ
 
	gTrivŸl
 = 
¡d
::
is_ŒivŸÎy_cİyabË
<
T
>::
v®ue
,

19 
boŞ
 
	gSm®l
 = 
is_sm®l
<
T
>::
v®ue


20 > 
şass
 
TAd­tiveW¿µed
;

22 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gO·que
 = 
Œue
,

23 
boŞ
 
	gTrivŸl
 = 
¡d
::
is_ŒivŸÎy_cİyabË
<
T
>::
v®ue
,

24 
boŞ
 
	gSm®l
 = 
is_sm®l
<
T
>::
v®ue


25 > 
şass
 
TSwissW¿µed
;

27 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gO·que
 = 
Œue
,

28 
boŞ
 
	gTrivŸl
 = 
¡d
::
is_ŒivŸÎy_cİyabË
<
T
>::
v®ue
,

29 
boŞ
 
	gSm®l
 = 
is_sm®l
<
T
>::
v®ue


30 > 
şass
 
TicTocW¿µed
;

32 şas 
	cTW¿µedAcûss
 {

33 
	mpublic
:

56 
‹m¶©e
 <
ty³Çme
 
T
,y³Çm
	mV
>

57 
	m¡d
::
·œ
<
boŞ
, 
	mT
> 
	$»ad_©omic
(cÚ¡ 
T
* 
v
, 
T¿nsProxy
 
™em
, cÚ¡ 
V
& 
v”siÚ
, 
boŞ
 
add_»ad
) {

58 #ià
STO_ABORT_ON_LOCKED


63 
V
 
v0
 = 
v”siÚ
;

64 
	`ãnû
();

65 
T
 
»suÉ
 = *
v
;

66 
	`ãnû
();

67 
V
 
v1
 = 
v”siÚ
;

68 ià(
v0
 =ğ
v1
 || v1.
	`is_locked
()) {

69  
¡d
::
	`make_·œ
(
™em
.
	`ob£rve
(
v1
, 
add_»ad
), 
»suÉ
);

71 
	`»Ïx_ãnû
();

74  
	`»ad_wa™_©omic
(
v
, 
™em
, 
v”siÚ
, 
add_»ad
);

78 
‹m¶©e
 <
ty³Çme
 
T
,y³Çm
V
>

79 
¡d
::
·œ
<
boŞ
, 
T
> 
	$»ad_ş—n_©omic
(cÚ¡ 
T
* 
v
, 
T¿nsProxy
 
™em
, cÚ¡ 
V
& 
v”siÚ
, 
boŞ
 
add_»ad
) {

81 
V
 
v0
 = 
v”siÚ
;

82 
	`ãnû
();

84 ià(
v0
.
	`is_dœty
()) {

85 
	`»Ïx_ãnû
();

88 
T
 
»suÉ
 = *
v
;

89 
	`ãnû
();

90 
V
 
v1
 = 
v”siÚ
;

92 ià(
v0
 =ğ
v1
) {

93  
¡d
::
	`make_·œ
(
™em
.
	`ob£rve
(
v1
, 
add_»ad
), 
»suÉ
);

95 
	`»Ïx_ãnû
();

97 
	}
}

99 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gV
>

100 
	g¡d
::
·œ
<
boŞ
, 
	gT
> 
	$»ad_nÚ©omic
(cÚ¡ 
T
* 
v
, 
T¿nsProxy
 
™em
, cÚ¡ 
V
& 
v”siÚ
, 
boŞ
 
add_»ad
) {

101 #ià
STO_ABORT_ON_LOCKED


102 ià(!
™em
.
	`ob£rve
(
cÚ¡_ÿ¡
<
V
&>(
v”siÚ
), 
add_»ad
))

103  
¡d
::
	`make_·œ
(
çl£
, *
v
);

104 
	`ãnû
();

105  
¡d
::
	`make_·œ
(
Œue
, *
v
);

107  
	`»ad_wa™_nÚ©omic
(
v
, 
™em
, 
v”siÚ
, 
add_»ad
);

109 
	}
}

111 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gV
>

112 
boŞ
 
	$»ad_nÚ©omic
(cÚ¡ 
T
* 
v
, 
T¿nsProxy
 
™em
, cÚ¡ 
V
& 
v”siÚ
, 
boŞ
 
add_»ad
, T& 
»t
) {

113 
T¿n§ùiÚ
& 
t
 = 
™em
.
	`Œª§ùiÚ
();

114 
T¿nsI‹m
& 
™
 = 
™em
.
	`™em
();

117 
V
 
v0
 = 
v”siÚ
;

118 
	`ãnû
();

120 ià(
v0
.
	`is_locked
()) {

121 
	`»Ïx_ãnû
();

125 
»t
 = *
v
;

126 
	`ãnû
();

127 
V
 
v1
 = 
v”siÚ
;

129 ià(
v0
 =ğ
v1
) {

130 ià(
add_»ad
 && !
™
.
	`has_»ad
()) {

131 
™
.
	`__Ü_æags
(
T¿nsI‹m
::
»ad_b™
);

132 
™
.
rd©a_
.
v
 = 
Pack”
<
TNÚİaqueV”siÚ
>::
	`·ck
(
t
.
buf_
, 
¡d
::
	`move
(
v1
));

133 
t
.
ªy_nÚİaque_
 = 
Œue
;

135  
Œue
;

137 
	`»Ïx_ãnû
();

139 
	}
}

141 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gV
>

142 
T
 
	$»ad_wa™_©omic
(cÚ¡ 
T
* 
v
, 
T¿nsProxy
 
™em
, cÚ¡ 
V
& 
v”siÚ
, 
boŞ
 
add_»ad
) {

143 
n
 = 0;

144 
Œue
) {

145 
V
 
v0
 = 
v”siÚ
;

146 
	`ãnû
();

147 
T
 
»suÉ
 = *
v
;

148 
	`ãnû
();

149 
V
 
v1
 = 
v”siÚ
;

150 ià(
v0
 =ğ
v1
 && !v1.
	`is_locked_–£wh”e
()) {

151 
™em
.
	`ob£rve
(
v1
, 
add_»ad
);

152  
»suÉ
;

155 #ià!
STO_ABORT_ON_LOCKED


156 
	`»Ïx_ãnû
();

160 #ià
STO_SPIN_EXPBACKOFF


161 ià(++
n
 > 
STO_SPIN_BOUND_WAIT
)

162 
Sto
::
	`abÜt
();

163 ià(
n
 > 3)

164 
x
 = 1 << 
¡d
::
	`mš
(15U, 
n
 - 2); x; --x)

165 
	`»Ïx_ãnû
();

167 ià(++
n
 > (1 << 
STO_SPIN_BOUND_WAIT
))

168 
Sto
::
	`abÜt
();

170 
	`»Ïx_ãnû
();

172 
	}
}

174 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gV
>

175 
T
 
	$»ad_wa™_nÚ©omic
(cÚ¡ 
T
* 
v
, 
T¿nsProxy
 
™em
, cÚ¡ 
V
& 
v”siÚ
, 
boŞ
 
add_»ad
) {

176 
n
 = 0;

177 
Œue
) {

178 
V
 
v0
 = 
v”siÚ
;

179 
	`ãnû
();

180 ià(!
v0
.
	`is_locked_–£wh”e
()) {

181 
™em
.
	`ob£rve
(
v0
, 
add_»ad
);

182  *
v
;

184 
	`»Ïx_ãnû
();

186 #ià!
STO_ABORT_ON_LOCKED


190 #ià
STO_SPIN_EXPBACKOFF


191 ià(++
n
 > 
STO_SPIN_BOUND_WAIT
)

192 
Sto
::
	`abÜt
();

193 ià(
n
 > 3)

194 
x
 = 1 << 
¡d
::
	`mš
(15U, 
n
 - 2); x; --x)

195 
	`»Ïx_ãnû
();

197 ià(++
n
 > (1 << 
STO_SPIN_BOUND_WAIT
))

198 
Sto
::
	`abÜt
();

201 
	}
}

204 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

205 
	g¡d
::
·œ
<
boŞ
, cÚ¡ 
	gT
&> 
nÚŒivŸl_»ad_to_»ã»nû
(
¡d
::·œ<boŞ, 
T
*> 
»ad_»suÉ
) {

206 
¡©ic_as£¹
(!
¡d
::
is_ŒivŸÎy_cİyabË
<
T
>::
v®ue
, "Type isrivially-copyable");

207  
	g¡d
::
make_·œ
(
»ad_»suÉ
.
fœ¡
, *»ad_»suÉ.
£cÚd
);

212 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

213 
şass
 
	gTAd­tiveW¿µed
<
	gT
, 
	gŒue
 ,rue ,rue > {

214 
	gpublic
:

215 
T
 
	t»ad_ty³
;

216 
	gTLockV”siÚ
<
	tŒue
> 
	tv”siÚ_ty³
;

218 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
> 
TAd­tiveW¿µed
(
Args
&&... 
¬gs
)

219 : 
v_
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {}

221 cÚ¡ 
T
& 
acûss
() const {

222  
v_
;

224 
	gT
& 
acûss
() {

225  
	gv_
;

227 
»ad_ty³
 
¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

228  
	gTW¿µedAcûss
::
»ad_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
çl£
);

230 
»ad_ty³
 
wa™_¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
boŞ
 
add_»ad
) const {

231  
	gTW¿µedAcûss
::
»ad_wa™_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
add_»ad
);

233 
	g¡d
::
·œ
<
boŞ
, 
	g»ad_ty³
> 
»ad
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

234 ià(
	g™em
.
cc_mode_is_İtimi¡ic
(
v”siÚ
.
hšt_İtimi¡ic
()))

235  
	gTW¿µedAcûss
::
»ad_ş—n_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
);

237  
	gTW¿µedAcûss
::
»ad_nÚ©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
);

239 
wr™e
(cÚ¡ 
T
& 
v
) {

240 
	gv_
 = 
v
;

242 
wr™e
(
T
&& 
v
) {

243 
	gv_
 = 
¡d
::
move
(
v
);

246 
	g´Ùeùed
:

247 
T
 
v_
;

250 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

251 
şass
 
	gTAd­tiveW¿µed
<
	gT
, 
	gŒue
 , 
	gçl£
 , false > {

252 
	gpublic
:

253 
T
& 
	t»ad_ty³
;

254 
	gTLockV”siÚ
<
	tŒue
> 
	tv”siÚ_ty³
;

256 
TAd­tiveW¿µed
()

257 : 
vp_
(
Ãw
 
T
) {}

258 
ex¶ic™
 
TAd­tiveW¿µed
(cÚ¡ 
T
& 
v
)

259 : 
vp_
(
Ãw
 
T
(
v
)) {}

260 
ex¶ic™
 
TAd­tiveW¿µed
(
T
&& 
v
)

261 : 
vp_
(
¡d
::
move
(
v
)) {}

262 
‹m¶©e
 <
ty³Çme
... 
Args
>

263 
ex¶ic™
 
TAd­tiveW¿µed
(
Args
&&... 
¬gs
)

264 : 
vp_
(
Ãw
 
T
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...)) {}

265 ~
TAd­tiveW¿µed
() {

266 
T¿n§ùiÚ
::
rcu_d–‘e
(
vp_
);

269 cÚ¡ 
	gT
& 
acûss
() const {

270  *
	gvp_
;

272 
	gT
& 
acûss
() {

273  *
	gvp_
;

275 
	g¡d
::
·œ
<
boŞ
, 
	g»ad_ty³
> 
»ad
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

276 autØ
	g»suÉ
 = 
TW¿µedAcûss
::
»ad_nÚ©omic
(&
vp_
, 
™em
, 
v”siÚ
, 
Œue
);

277  {
	g»suÉ
.
	gfœ¡
, *»suÉ.
	g£cÚd
};

280 
wr™e
(cÚ¡ 
T
& 
v
) {

281 
§ve
(
Ãw
 
T
(
v
));

283 
wr™e
(
T
&& 
v
) {

284 
§ve
(
Ãw
 
T
(
¡d
::
move
(
v
)));

287 
	g´iv©e
:

288 
T
 *
vp_
;

290 
§ve
(
T
* 
Ãw_vp
) {

291 
	gT¿n§ùiÚ
::
rcu_d–‘e
(
vp_
);

292 
	gvp_
 = 
Ãw_vp
;

296 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gO·que
, boŞ 
	gTrivŸl
, boŞ 
	gSm®l
>

297 şas 
	cTLockW¿µed
 {

298 
	mpublic
:

299 
‹m¶©e
 <
ty³Çme
... 
Args
>

300 
ex¶ic™
 
	$TLockW¿µed
(
Args
&&... 
¬gs
)

301 : 
	`v_
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {

302 
	`¡©ic_as£¹
(
O·que
 && 
TrivŸl
 && 
Sm®l
, "not implemented");

304 
´Ùeùed
:

305 
T
 
v_
;

306 
	}
};

308 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gO·que
, boŞ 
	gTrivŸl
>

309 
şass
 
	gTSwissW¿µed
<
	gT
, 
	gO·que
, 
	gTrivŸl
, 
	gŒue
 > {

310 
	gpublic
:

311 
T
 
	t»ad_ty³
;

312 
	gTSwissV”siÚ
<
	tO·que
> 
	tv”siÚ_ty³
;

314 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

315 
ex¶ic™
 
TSwissW¿µed
(
Args
&&... 
¬gs
)

316 : 
v_
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {}

318 cÚ¡ 
T
& 
acûss
() const {

319  
v_
;

321 
	gT
& 
acûss
() {

322  
	gv_
;

324 
»ad_ty³
 
¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

325 ià(
	gO·que
 || 
	gTrivŸl
)

326  
	gTW¿µedAcûss
::
»ad_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
çl£
);

328  
	gTW¿µedAcûss
::
»ad_nÚ©omic
(&
v_
, 
™em
, 
v”siÚ
, 
çl£
);

330 
»ad_ty³
 
wa™_¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
boŞ
 
add_»ad
) const {

331 ià(
	gO·que
 || 
	gTrivŸl
)

332  
	gTW¿µedAcûss
::
»ad_wa™_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
add_»ad
);

334  
	gTW¿µedAcûss
::
»ad_wa™_nÚ©omic
(&
v_
, 
™em
, 
v”siÚ
, 
add_»ad
);

336 
	g¡d
::
·œ
<
boŞ
, 
	g»ad_ty³
> 
»ad
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

337 ià(
	gO·que
 || 
	gTrivŸl
)

338  
	gTW¿µedAcûss
::
»ad_ş—n_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
);

340  
	gTW¿µedAcûss
::
»ad_nÚ©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
);

342 
	g¡d
::
·œ
<
boŞ
, 
	g»ad_ty³
> 
»ad
(
T
* 
wÜd
, 
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) {

343 ià(
	gO·que
 || 
	gTrivŸl
)

344  
	gTW¿µedAcûss
::
»ad_ş—n_©omic
(
wÜd
, 
™em
, 
v”siÚ
, 
Œue
);

346  
	gTW¿µedAcûss
::
»ad_nÚ©omic
(
wÜd
, 
™em
, 
v”siÚ
, 
Œue
);

348 
wr™e
(cÚ¡ 
T
& 
v
) {

349 
	gv_
 = 
v
;

351 
wr™e
(
T
&& 
v
) {

352 
	gv_
 = 
¡d
::
move
(
v
);

355 
	g´Ùeùed
:

356 
T
 
v_
;

359 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gO·que
, boŞ 
	gTrivŸl
, boŞ 
	gSm®l
>

360 şas 
	cTSwissW¿µed
 {

361 
	mpublic
:

362 
TSwissW¿µed
(èğ
d–‘e
;

363 
	m‹m¶©e
 <
	mty³Çme
... 
	mArgs
>

364 
ex¶ic™
 
	$TSwissW¿µed
(
Args
&&... 
¬gs
)

365 : 
	`v_
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {

366 
	`¡©ic_as£¹
(
Sm®l
, "not implemented");

368 
´Ùeùed
:

369 
T
 
v_
;

370 
	}
};

372 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gSm®l
>

373 
şass
 
	gTW¿µed
<
	gT
, 
	gŒue
 ,ru , 
	gSm®l
 > {

374 
	gpublic
:

375 
T
 
	t»ad_ty³
;

376 
TV”siÚ
 
	tv”siÚ_ty³
;

378 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

379 
ex¶ic™
 
TW¿µed
(
Args
&&... 
¬gs
)

380 : 
v_
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {

383 cÚ¡ 
T
& 
acûss
() const {

384  
v_
;

386 
	gT
& 
acûss
() {

387  
	gv_
;

389 
»ad_ty³
 
¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

390 autØ
	g»suÉ
 = 
TW¿µedAcûss
::
»ad_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
çl£
);

391 ià(!
	g»suÉ
.
	gfœ¡
) {

392 
	gSto
::
abÜt
();

394  
	g»suÉ
.
	g£cÚd
;

396 
»ad_ty³
 
wa™_¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
boŞ
 
add_»ad
) const {

397  
	gTW¿µedAcûss
::
»ad_wa™_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
add_»ad
);

399 
	g¡d
::
·œ
<
boŞ
, 
	g»ad_ty³
> 
»ad
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

400  
	gTW¿µedAcûss
::
»ad_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
);

402 
	g¡d
::
·œ
<
boŞ
, 
	g»ad_ty³
> 
»ad
(cÚ¡ 
T
* 
v
, 
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) {

403 
®ways_as£¹
(
Sm®l
, "static„ead only‡vailable for smallypes");

404  
	gTW¿µedAcûss
::
»ad_©omic
(
v
, 
™em
, 
v”siÚ
, 
Œue
);

407 
boŞ
 
»ad
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
»ad_ty³
& 
»t
) const {

408  
	gTW¿µedAcûss
::
»ad_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
, 
»t
);

411 
boŞ
 
»ad
(cÚ¡ 
T
* 
v
, 
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
»ad_ty³
& 
»t
) {

412  
	gTW¿µedAcûss
::
»ad_©omic
(
v
, 
™em
, 
v”siÚ
, 
Œue
, 
»t
);

414 
wr™e
(cÚ¡ 
T
& 
v
) {

415 
	gv_
 = 
v
;

417 
wr™e
(
T
&& 
v
) {

418 
	gv_
 = 
¡d
::
move
(
v
);

421 
	g´Ùeùed
:

422 
T
 
v_
;

426 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

427 
şass
 
	gTW¿µed
<
	gT
, 
	gŒue
 ,ru , 
	gçl£
 > {

428 
	gpublic
:

429 
T
 
	t»ad_ty³
;

430 
TV”siÚ
 
	tv”siÚ_ty³
;

432 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
> 
TW¿µed
(
Args
&&... 
¬gs
)

433 : 
v_
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {

436 cÚ¡ 
T
& 
acûss
() const {

437  
v_
;

439 
	gT
& 
acûss
() {

440  
	gv_
;

442 
»ad_ty³
 
¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

443  
	gTW¿µedAcûss
::
»ad_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
çl£
);

445 
»ad_ty³
 
wa™_¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
boŞ
 
add_»ad
) const {

446  
	gTW¿µedAcûss
::
»ad_wa™_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
add_»ad
);

448 
»ad_ty³
 
»ad
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

449  
	gTW¿µedAcûss
::
»ad_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
);

451 
wr™e
(cÚ¡ 
T
& 
v
) {

452 
	gv_
 = 
v
;

454 
wr™e
(
T
&& 
v
) {

455 
	gv_
 = 
¡d
::
move
(
v
);

458 
	g´Ùeùed
:

459 
T
 
v_
;

463 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gSm®l
>

464 
şass
 
	gTW¿µed
<
	gT
, 
	gçl£
 , 
	gŒue
 , 
	gSm®l
 > {

465 
	gpublic
:

466 
T
 
	t»ad_ty³
;

467 
TNÚİaqueV”siÚ
 
	tv”siÚ_ty³
;

469 
TW¿µed
()

470 : 
v_
() {

472 
ex¶ic™
 
TW¿µed
(cÚ¡ 
T
& 
v
)

473 : 
v_
(
v
) {

475 
ex¶ic™
 
TW¿µed
(
T
&& 
v
)

476 : 
v_
(
¡d
::
move
(
v
)) {

478 
‹m¶©e
 <
ty³Çme
... 
Args
>

479 
ex¶ic™
 
TW¿µed
(
Args
&&... 
¬gs
)

480 : 
v_
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {

483 cÚ¡ 
T
& 
acûss
() const {

484  
v_
;

486 
	gT
& 
acûss
() {

487  
	gv_
;

489 
»ad_ty³
 
¢­shÙ
(
T¿nsProxy
, cÚ¡ 
v”siÚ_ty³
&) const {

490  
	gv_
;

492 
»ad_ty³
 
wa™_¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
boŞ
 
add_»ad
) const {

493 ià(
	gSm®l
)

494  
	gTW¿µedAcûss
::
»ad_wa™_nÚ©omic
(&
v_
, 
™em
, 
v”siÚ
, 
add_»ad
);

496  
	gTW¿µedAcûss
::
»ad_wa™_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
add_»ad
);

498 
	g¡d
::
·œ
<
boŞ
, 
	g»ad_ty³
> 
»ad
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

499 ià(
	gSm®l
)

500  
	gTW¿µedAcûss
::
»ad_nÚ©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
);

502  
	gTW¿µedAcûss
::
»ad_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
);

504 
	g¡d
::
·œ
<
boŞ
, 
	g»ad_ty³
> 
»ad
(cÚ¡ 
T
* 
vp
, 
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) {

505 
¡©ic_as£¹
(
Sm®l
, "static„ead only‡vailable for smallypes");

506  
	gTW¿µedAcûss
::
»ad_nÚ©omic
(
vp
, 
™em
, 
v”siÚ
, 
Œue
);

508 
boŞ
 
»ad
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
»ad_ty³
& 
»t
) const {

509 ià(
	gSm®l
)

510  
	gTW¿µedAcûss
::
»ad_nÚ©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
, 
»t
);

512  
	gTW¿µedAcûss
::
»ad_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
, 
»t
);

514 
boŞ
 
»ad
(cÚ¡ 
T
* 
vp
, 
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
»ad_ty³
& 
»t
) {

515 
¡©ic_as£¹
(
Sm®l
, "static„ead only‡vailable for smallypes");

516  
	gTW¿µedAcûss
::
»ad_nÚ©omic
(
vp
, 
™em
, 
v”siÚ
, 
Œue
, 
»t
);

519 
	g‹m¶©e
 <
ty³Çme
 
	gQ
 = 
T
>

520 
ty³Çme
 
¡d
::
’abË_if
<
is_sm®l
<
Q
>::
v®ue
, >::
ty³


521 
wr™e
(
T
 
v
) {

522 
¡©ic_as£¹
(
Sm®l
, "write-by-value only‡vailable for smallypes");

523 
	gv_
 = 
v
;

526 
	g‹m¶©e
 <
ty³Çme
 
	gQ
 = 
T
>

527 
ty³Çme
 
¡d
::
’abË_if
<!
is_sm®l
<
Q
>::
v®ue
, >::
ty³


528 
wr™e
(cÚ¡ 
T
& 
v
) {

529 
¡©ic_as£¹
(!
Sm®l
, "write-by-lvalue-reference only‡vailable for‚on-smallypes");

530 
	gv_
 = 
v
;

533 
	g‹m¶©e
 <
ty³Çme
 
	gQ
 = 
T
>

534 
ty³Çme
 
¡d
::
’abË_if
<!
is_sm®l
<
Q
>::
v®ue
, >::
ty³


535 
wr™e
(
T
&& 
v
) {

536 
¡©ic_as£¹
(!
Sm®l
, "write-with-move only‡vailable for‚on-smallypes");

537 
	gv_
 = 
¡d
::
move
(
v
);

540 
	g´iv©e
:

541 
T
 
v_
;

545 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

546 
şass
 
	gTW¿µed
<
	gT
, 
	gçl£
 , 
	gŒue
 , false > {

547 
	gpublic
:

548 
T
 
	t»ad_ty³
;

549 
TNÚİaqueV”siÚ
 
	tv”siÚ_ty³
;

551 
TW¿µed
()

552 : 
v_
() {

554 
TW¿µed
(cÚ¡ 
T
& 
v
)

555 : 
v_
(
v
) {

557 
TW¿µed
(
T
&& 
v
)

558 : 
v_
(
¡d
::
move
(
v
)) {

560 
‹m¶©e
 <
ty³Çme
... 
Args
> 
TW¿µed
(Args&&... 
¬gs
)

561 : 
v_
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {

564 cÚ¡ 
T
& 
acûss
() const {

565  
v_
;

567 
	gT
& 
acûss
() {

568  
	gv_
;

570 
»ad_ty³
 
¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

571  
	gTW¿µedAcûss
::
»ad_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
çl£
);

573 
»ad_ty³
 
wa™_¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
boŞ
 
add_»ad
) const {

574  
	gTW¿µedAcûss
::
»ad_wa™_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
add_»ad
);

576 
»ad_ty³
 
»ad
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

577  
	gTW¿µedAcûss
::
»ad_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
);

579 
wr™e
(cÚ¡ 
T
& 
v
) {

580 
	gv_
 = 
v
;

582 
wr™e
(
T
&& 
v
) {

583 
	gv_
 = 
¡d
::
move
(
v
);

586 
	g´iv©e
:

587 
T
 
v_
;

591 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gO·que
, boŞ 
	gSm®l
>

592 
şass
 
	gTW¿µed
<
	gT
, 
	gO·que
, 
	gçl£
 , 
	gSm®l
> {

593 
	gpublic
:

594 cÚ¡ 
	tT
& 
	t»ad_ty³
;

595 
ty³Çme
 
	t¡d
::
	tcÚd™iÚ®
<
	tO·que
, 
	tTV”siÚ
, 
	tTNÚİaqueV”siÚ
>::
	tty³
 
	tv”siÚ_ty³
;

597 
TW¿µed
()

598 : 
vp_
(
Ãw
 
T
) {

600 
ex¶ic™
 
TW¿µed
(cÚ¡ 
T
& 
v
)

601 : 
vp_
(
Ãw
 
T
(
v
)) {

603 
ex¶ic™
 
TW¿µed
(
T
&& 
v
)

604 : 
vp_
(
Ãw
 
T
(
¡d
::
move
(
v
))) {

606 
‹m¶©e
 <
ty³Çme
... 
Args
>

607 
ex¶ic™
 
TW¿µed
(
Args
&&... 
¬gs
)

608 : 
vp_
(
Ãw
 
T
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...)) {

610 ~
TW¿µed
() {

611 
T¿n§ùiÚ
::
rcu_d–‘e
(
vp_
);

614 cÚ¡ 
	gT
& 
acûss
() const {

615  *
	gvp_
;

617 
	gT
& 
acûss
() {

618  *
	gvp_
;

620 
»ad_ty³
 
¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

621 ià(
	gO·que
)

622  *
	gTW¿µedAcûss
::
»ad_wa™_©omic
(&
vp_
, 
™em
, 
v”siÚ
, 
çl£
);

624  *
	gvp_
;

626 
»ad_ty³
 
wa™_¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
boŞ
 
add_»ad
) const {

627 ià(
	gO·que
)

628  *
	gTW¿µedAcûss
::
»ad_wa™_©omic
(&
vp_
, 
™em
, 
v”siÚ
, 
add_»ad
);

630  *
	gTW¿µedAcûss
::
»ad_wa™_nÚ©omic
(&
vp_
, 
™em
, 
v”siÚ
, 
add_»ad
);

632 
	g¡d
::
·œ
<
boŞ
, 
	g»ad_ty³
> 
»ad
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

633 ià(
	gO·que
) {

634  
	gTW¿µedAcûss
::
nÚŒivŸl_»ad_to_»ã»nû
(

635 
TW¿µedAcûss
::
»ad_©omic
(&
vp_
, 
™em
, 
v”siÚ
, 
Œue
));

637  
	gTW¿µedAcûss
::
nÚŒivŸl_»ad_to_»ã»nû
(

638 
TW¿µedAcûss
::
»ad_nÚ©omic
(&
vp_
, 
™em
, 
v”siÚ
, 
Œue
));

641 
wr™e
(cÚ¡ 
T
& 
v
) {

642 
§ve
(
Ãw
 
T
(
v
));

644 
wr™e
(
T
&& 
v
) {

645 
§ve
(
Ãw
 
T
(
¡d
::
move
(
v
)));

648 
	g´iv©e
:

649 
T
* 
vp_
;

651 
§ve
(
T
* 
Ãw_vp
) {

652 
	gT¿n§ùiÚ
::
rcu_d–‘e
(
vp_
);

653 
	gvp_
 = 
Ãw_vp
;

658 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gSm®l
>

659 
şass
 
	gTW¿µed
<
	gT
, 
	gçl£
 , f®£ , 
	gSm®l
> {

660 
	gpublic
:

661 cÚ¡ 
	tT
& 
	t»ad_ty³
;

662 
TNÚİaqueV”siÚ
 
	tv”siÚ_ty³
;

664 
TW¿µed
()

665 : 
vp_
(
Ãw
 
T
) {

667 
TW¿µed
(cÚ¡ 
T
& 
v
)

668 : 
vp_
(
Ãw
 
T
(
v
)) {

670 
TW¿µed
(
T
&& 
v
)

671 : 
vp_
(
Ãw
 
T
(
¡d
::
move
(
v
))) {

673 
‹m¶©e
 <
ty³Çme
... 
Args
> 
TW¿µed
(Args&&... 
¬gs
)

674 : 
vp_
(
Ãw
 
T
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...)) {

676 ~
TW¿µed
() {

677 
T¿n§ùiÚ
::
rcu_d–‘e
(
vp_
);

680 cÚ¡ 
	gT
& 
acûss
() const {

681  *
	gvp_
;

683 
	gT
& 
acûss
() {

684  *
	gvp_
;

686 
»ad_ty³
 
¢­shÙ
(
T¿nsProxy
, cÚ¡ 
v”siÚ_ty³
&) const {

687  *
	gvp_
;

689 
»ad_ty³
 
wa™_¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
boŞ
 
add_»ad
) const {

690  *
	gTW¿µedAcûss
::
»ad_wa™_nÚ©omic
(&
vp_
, 
™em
, 
v”siÚ
, 
add_»ad
);

692 
	g¡d
::
·œ
<
boŞ
, 
	g»ad_ty³
> 
»ad
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

693  
	gTW¿µedAcûss
::
»ad_nÚ©omic
(&
vp_
, 
™em
, 
v”siÚ
, 
Œue
);

695 
wr™e
(cÚ¡ 
T
& 
v
) {

696 
§ve
(
Ãw
 
T
(
v
));

698 
wr™e
(
T
&& 
v
) {

699 
§ve
(
Ãw
 
T
(
¡d
::
move
(
v
)));

702 
	g´iv©e
:

703 
T
* 
vp_
;

705 
§ve
(
T
* 
Ãw_vp
) {

706 
	gT¿n§ùiÚ
::
rcu_d–‘e
(
vp_
);

707 
	gvp_
 = 
Ãw_vp
;

712 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gSm®l
>

713 
şass
 
	gTicTocW¿µed
<
	gT
, 
	gçl£
 , 
	gŒue
 , 
	gSm®l
 > {

714 
	gpublic
:

715 
T
 
	t»ad_ty³
;

716 
	gTicTocV”siÚ
<
	tçl£
 , 
	tŒue
 > 
	tv”siÚ_ty³
;

718 
TicTocW¿µed
()

719 : 
v_
() {}

720 
ex¶ic™
 
TicTocW¿µed
(cÚ¡ 
T
& 
v
)

721 : 
v_
(
v
) {}

722 
ex¶ic™
 
TicTocW¿µed
(
T
&& 
v
)

723 : 
v_
(
¡d
::
move
(
v
)) {}

724 
‹m¶©e
 <
ty³Çme
... 
Args
>

725 
ex¶ic™
 
TicTocW¿µed
(
Args
&&... 
¬gs
)

726 : 
v_
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {}

728 cÚ¡ 
T
& 
acûss
() const {

729  
v_
;

731 
	gT
& 
acûss
() {

732  
	gv_
;

734 
»ad_ty³
 
¢­shÙ
(
T¿nsProxy
, cÚ¡ 
v”siÚ_ty³
&) const {

735  
	gv_
;

737 
»ad_ty³
 
wa™_¢­shÙ
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
boŞ
 
add_»ad
) const {

738 ià(
	gSm®l
)

739  
	gTW¿µedAcûss
::
»ad_wa™_nÚ©omic
(&
v_
, 
™em
, 
v”siÚ
, 
add_»ad
);

741  
	gTW¿µedAcûss
::
»ad_wa™_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
add_»ad
);

743 
	g¡d
::
·œ
<
boŞ
, 
	g»ad_ty³
> 
»ad
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
) const {

744 ià(
	gSm®l
)

745  
	gTW¿µedAcûss
::
»ad_nÚ©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
);

747  
	gTW¿µedAcûss
::
»ad_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
);

749 
boŞ
 
»ad
(
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
»ad_ty³
& 
»t
) const {

750 ià(
	gSm®l
)

751  
	gTW¿µedAcûss
::
»ad_nÚ©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
, 
»t
);

753  
	gTW¿µedAcûss
::
»ad_©omic
(&
v_
, 
™em
, 
v”siÚ
, 
Œue
, 
»t
);

756 
	g‹m¶©e
 <
ty³Çme
 
	gQ
 = 
T
> ty³Çm
¡d
::
’abË_if
<
is_sm®l
<
Q
>::
v®ue
, 
	gboŞ
>::
ty³


757 
»ad
(cÚ¡ 
T
* 
vp
, 
T¿nsProxy
 
™em
, cÚ¡ 
v”siÚ_ty³
& 
v”siÚ
, 
»ad_ty³
& 
»t
) {

758 
¡©ic_as£¹
(
Sm®l
, "static„ead only‡vailable for smallypes");

759  
	gTW¿µedAcûss
::
»ad_nÚ©omic
(
vp
, 
™em
, 
v”siÚ
, 
Œue
, 
»t
);

762 
	g‹m¶©e
 <
ty³Çme
 
	gQ
 = 
T
>

763 
ty³Çme
 
¡d
::
’abË_if
<
is_sm®l
<
Q
>::
v®ue
, >::
ty³


764 
wr™e
(
T
 
v
) {

765 
¡©ic_as£¹
(
Sm®l
, "write-by-value only‡vailable for smallypes");

766 
	gv_
 = 
v
;

769 
	g‹m¶©e
 <
ty³Çme
 
	gQ
 = 
T
>

770 
ty³Çme
 
¡d
::
’abË_if
<!
is_sm®l
<
Q
>::
v®ue
, >::
ty³


771 
wr™e
(cÚ¡ 
T
& 
v
) {

772 
¡©ic_as£¹
(!
Sm®l
, "write-by-lvalue-reference only‡vailable for‚on-smallypes");

773 
	gv_
 = 
v
;

776 
	g‹m¶©e
 <
ty³Çme
 
	gQ
 = 
T
>

777 
ty³Çme
 
¡d
::
’abË_if
<!
is_sm®l
<
Q
>::
v®ue
, >::
ty³


778 
wr™e
(
T
&& 
v
) {

779 
¡©ic_as£¹
(!
Sm®l
, "write-with-move only‡vailable for‚on-smallypes");

780 
	gv_
 = 
¡d
::
move
(
v
);

783 
	g´iv©e
:

784 
T
 
v_
;

787 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gO·que
, boŞ 
	gTrivŸl
, boŞ 
	gSm®l
>

788 şas 
	cTicTocW¿µed
 {

789 
	mpublic
:

790 
TicTocW¿µed
(èğ
d–‘e
;

791 
TicTocW¿µed
(cÚ¡ TicTocW¿µed&èğ
d–‘e
;

792 
TicTocW¿µed
(TicTocW¿µed&&èğ
d–‘e
;

793 
	m‹m¶©e
<
	mty³Çme
... 
	mArgs
>

794 
TicTocW¿µed
(
Args
&&...èğ
d–‘e
;

797 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gTO·queW¿µed
 = 
TW¿µed
<
T
>;

798 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gTNÚİaqueW¿µed
 = 
TW¿µed
<
T
, 
	gçl£
>;

800 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gTAd­tiveNÚİaqueW¿µed
 = 
TAd­tiveW¿µed
<
T
>;

801 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gTSwissO·queW¿µed
 = 
TSwissW¿µed
<
T
, 
	gŒue
>;

802 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gTSwissNÚİaqueW¿µed
 = 
TSwissW¿µed
<
T
, 
	gçl£
>;

804 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
usšg
 
	gTicTocNÚİaqueW¿µed
 = 
TicTocW¿µed
<
T
, 
	gçl£
>;

	@sto-core/Tagged64.hh

1 #´agm¨
Úû


2 
	~<¡dšt.h
>

6 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

7 şas 
	cTagged64
 {

8 
cÚ¡ex´
 
	mshiá
 = 64 - 16;

9 #ià
SIZEOF_VOID_P
 == 8

10 
T
* 
	t·cked_ty³
;

11 
cÚ¡ex´
 
ušŒ_t
 
	m±rmask
 = 0xFFFFFFFFFFFFULL;

12 #–ià
SIZEOF_VOID_P
 == 4

13 
ušt64_t
 
	t·cked_ty³
;

14 
cÚ¡ex´
 
ušŒ_t
 
	m±rmask
 = 0xFFFFFFFFU;

18 
ušt64_t
 
	tæags_ty³
;

20 
·cked_ty³
 
	$·ck
(
T
* 
p
, 
æags
) {

21  
»š‹½»t_ÿ¡
<
·cked_ty³
>Ôeš‹½»t_ÿ¡<
ušŒ_t
>(
p
)

22 | (
	`æags_ty³
(
æags
è<< 
shiá
));

25 
public
:

27 
	$Tagged64
(
T
* 
p
)

28 : 
	`p_
(
	$·ck
(
p
, 0)) {

29 
	}
}

31 
T
* 
	$±r
() const {

32  
»š‹½»t_ÿ¡
<
T
*>Ôeš‹½»t_ÿ¡<
ušŒ_t
>(
p_
è& 
±rmask
);

33 
	}
}

35 
ušt16_t
 
	$æags
() const {

36  
»š‹½»t_ÿ¡
<
æags_ty³
>(
p_
è>> 
shiá
;

37 
	}
}

39 
	$assign_æags
(
ušt16_t
 
æags
) {

40 
p_
 = 
	`·ck
(
	`±r
(), 
æags
);

41 
	}
}

43 
	$Ü_æags
(
ušt16_t
 
æags
) {

44 
p_
 = 
»š‹½»t_ÿ¡
<
·cked_ty³
>Ôeš‹½»t_ÿ¡<
æags_ty³
>(p_)

45 | (
	`æags_ty³
(
æags
è<< 
shiá
));

46 
	}
}

48 
	$rm_æags
(
ušt16_t
 
æags
) {

49 
p_
 = 
»š‹½»t_ÿ¡
<
·cked_ty³
>Ôeš‹½»t_ÿ¡<
æags_ty³
>(p_)

50 & ~(
	`æags_ty³
(
æags
è<< 
shiá
));

51 
	}
}

53 
boŞ
 
	gİ”©Ü
<(
	gTagged64
<
	gT
> 
	gx
) const {

54  
	g»š‹½»t_ÿ¡
<
	gæags_ty³
>(
	gp_
è<„eš‹½»t_ÿ¡<æags_ty³>(
	gx
.p_);

57 
	g´iv©e
:

58 
·cked_ty³
 
p_
;

	@sto-core/TaggedLow.hh

1 #´agm¨
Úû


2 
	~"comp”.hh
"

7 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

8 şas 
	cTaggedLow
 {

9 
T
* 
	t·cked_ty³
;

10 
ušŒ_t
 
	tæags_ty³
;

12 
·cked_ty³
 
	$·ck
(
T
* 
±r
, 
ušt8_t
 
æags
) {

13 
	`as£¹
(!(
»š‹½»t_ÿ¡
<
æags_ty³
>(
±r
è& 7è&& !(
æags
 & ~7));

14  
»š‹½»t_ÿ¡
<
·cked_ty³
>Ôeš‹½»t_ÿ¡<
æags_ty³
>(
±r
è| 
æags
);

17 
public
:

18 
	$TaggedLow
(
T
* 
±r
, 
ušt8_t
 
æags
)

19 : 
	`p_
(
	$·ck
(
±r
, 
æags
)) {

20 
	}
}

22 
İ”©Ü
 
	gT
*() {

23  (
	gT
*è
±r
();

26 
İ”©Ü
 cÚ¡ 
	gT
*() const {

27  
±r
();

30 cÚ¡ 
T
* 
	$±r
() const {

31  
»š‹½»t_ÿ¡
<
T
*>Ôeš‹½»t_ÿ¡<
æags_ty³
>(
p_
è& ~
	`æags_ty³
(7));

32 
	}
}

34 
ušt8_t
 
	$æags
() const {

35  
»š‹½»t_ÿ¡
<
æags_ty³
>(
p_
) & 7;

36 
	}
}

38 
	$assign_±r
(
T
* 
±r
) {

39 
	`ãnû
();

40 
p_
 = 
»š‹½»t_ÿ¡
<
·cked_ty³
>Ôeš‹½»t_ÿ¡<
æags_ty³
>(
±r
è| 
	`æags
());

41 
	}
}

43 
	$assign_æags
(
ušt8_t
 
æags
) {

44 
	`as£¹
((
æags
 & ~7) == 0);

45 
	`ãnû
();

46 
p_
 = 
»š‹½»t_ÿ¡
<
·cked_ty³
>(Ôeš‹½»t_ÿ¡<
æags_ty³
>Õ_è& ~
	`æags_ty³
(7)è| 
æags
);

47 
	}
}

49 
	$Ü_æags
(
ušt8_t
 
æags
) {

50 
	`as£¹
((
æags
 & ~7) == 0);

51 
	`ãnû
();

52 
p_
 = 
»š‹½»t_ÿ¡
<
·cked_ty³
>Ôeš‹½»t_ÿ¡<
æags_ty³
>Õ_è| 
æags
);

53 
	}
}

55 
	$©omic_add_æags
(
ušt8_t
 
æags
) {

56 
	`as£¹
((
æags
 & ~7) == 0);

58 autØ
cur
 = 
»š‹½»t_ÿ¡
<
æags_ty³
>(
p_
);

59 
	`ãnû
();

60 ià((
cur
 & 
æags
è=ğ0 && 
	`boŞ_cmpxchg
(&
p_
, 
»š‹½»t_ÿ¡
<
·cked_ty³
>(cur),

61 
»š‹½»t_ÿ¡
<
·cked_ty³
>(
cur
 | 
æags
))) {

64 
	`»Ïx_ãnû
();

66 
	}
}

68 
	g´iv©e
:

69 
T
* 
p_
;

	@sto-core/TicTocStructs.hh

1 #´agm¨
Úû


4 
	sWideTid
 {

5 
ušt64_t
 
	tsšgË_ty³
;

6 
št64_t
 
	tsigÃd_sšgË_ty³
;

8 
WideTid
() = ;

9 
WideTid
(cÚ¡ WideTid&èğ
d–‘e
;

10 
	mWideTid
& 
	mİ”©Ü
=(cÚ¡ 
WideTid
&èğ
d–‘e
;

11 
	mWideTid
& 
	mİ”©Ü
=(
WideTid
&&èğ
d–‘e
;

13 
sšgË_ty³
 
	mv0
;

14 
sšgË_ty³
 
	mv1
;

19 
	urd©a_t
 {

20 * 
	mv
;

21 
WideTid
 
	mw
;

	@sto-core/TicTocVersions.hh

1 #´agm¨
Úû


3 
	~"V”siÚBa£.hh
"

4 
	~"TicTocSŒuùs.hh
"

6 şas 
	cTicTocTid
 : 
public
 
T¿n§ùiÚTid
 {

7 
public
:

8 
usšg
 
T¿n§ùiÚTid
::
is_locked_–£wh”e
;

10 
cÚ¡ex´
 
ty³
 
	mts_shiá
 = 
T¿n§ùiÚTid
::
mask_width
 + 5;

12 
ty³
 
	$time¡amp
(
ty³
 
ts
) {

13  
ts
 >> 
ts_shiá
;

16 
	$£t_time¡amp_locked
(
ty³
& 
ts
,y³ 
Ãw_ts
,y³ 
æags
) {

17 
	`as£¹
(
	`is_locked_h”e
(
ts
));

18 
Ãw_ts
 = (Ãw_t << 
ts_shiá
è| 
lock_b™
 | 
TTh»ad
::
	`id
();

19 
ts
 = 
Ãw_ts
 | 
æags
;

20 
	`»Ëa£_ãnû
();

21 
	}
}

23 
	$£t_time¡amp_uÆock
(
ty³
& 
ts
,y³ 
Ãw_ts
,y³ 
æags
) {

24 
	`as£¹
(
	`is_locked_h”e
(
ts
));

25 
Ãw_ts
 <<ğ
ts_shiá
;

26 
ts
 = 
Ãw_ts
 | 
æags
;

27 
	`»Ëa£_ãnû
();

28 
	}
}

30 
	$£t_time¡amp
(
ty³
& 
ts
,y³ 
Ãw_ts
,y³ 
æags
) {

31 
Ãw_ts
 <<ğ
ts_shiá
;

32 
	`»Ëa£_ãnû
();

33 
ts
 = 
Ãw_ts
 | 
æags
;

34 
	}
}

36 
boŞ
 
	$v®id©e_time¡amps
(
ty³
& 
tu¶e_wts
,y³& 
tu¶e_¹s
,y³ 
»ad_wts
,y³ 
»ad_¹s
,y³ 
comm™_ts
) {

37 
Œue
) {

38 ià(
	`time¡amp
(
»ad_¹s
è>ğ
comm™_ts
)

39  
Œue
;

41 autØ
t_wts
 = 
tu¶e_wts
;

42 
	`acquœe_ãnû
();

43 autØ
t_¹s
 = 
tu¶e_¹s
;

44 
	`acquœe_ãnû
();

45 ià(
	`time¡amp
(
t_wts
è!ğtime¡amp(
»ad_wts
)

46 || ((
	`time¡amp
(
t_¹s
è< 
comm™_ts
è&& 
	`is_locked_–£wh”e
(t_rts)))

47  
çl£
;

48 ià(
	`time¡amp
(
t_¹s
è< 
comm™_ts
) {

49 
ty³
 
v
 = 
comm™_ts
 << 
ts_shiá
 | (
t_¹s
 & (
šüem’t_v®ue
 - 1));

50 ià(
	`boŞ_cmpxchg
(&
tu¶e_¹s
, 
t_¹s
, 
v
))

51  
Œue
;

53  
Œue
;

57 
	}
}

59 
boŞ
 
	$v®id©e_time¡amps_nÛxt
(cÚ¡ 
ty³
& 
tu¶e_wts
, cÚ¡y³& 
tu¶e_¹s
,y³ 
»ad_wts
,y³ 
»ad_¹s
,y³ 
comm™_ts
) {

60 ià(
	`time¡amp
(
»ad_¹s
è>ğ
comm™_ts
)

61  
Œue
;

63 autØ
t_wts
 = 
tu¶e_wts
;

64 
	`acquœe_ãnû
();

65 autØ
t_¹s
 = 
tu¶e_¹s
;

66 
	`acquœe_ãnû
();

67  !(
	`time¡amp
(
t_wts
è!ğtime¡amp(
»ad_wts
)

68 || ((
	`time¡amp
(
t_¹s
è< 
comm™_ts
è&& 
	`is_locked_–£wh”e
(t_rts)));

70 
	}
}

72 
	$·ck_wide
(
WideTid
& 
ts
, cÚ¡ 
ty³
& 
¹s
, cÚ¡y³& 
wts
) {

73 
ts
.
v0
 = 
¹s
;

74 
	`»Ëa£_ãnû
();

75 
ts
.
v1
 = 
wts
;

76 
	`»Ëa£_ãnû
();

77 
	}
}

79 
	g¡d
::
·œ
<
ty³
, 
	gty³
> 
	$uÅack_wide
(cÚ¡ 
WideTid
& 
ts
) {

80 
ty³
 
r
, 
w
;

81 
r
 = 
ts
.
v0
;

82 
	`acquœe_ãnû
();

83 
w
 = 
ts
.
v1
;

84 
	`acquœe_ãnû
();

85  {
r
, 
w
};

86 
	}
};

89 şas 
	cTicTocCom´es£dTid
 : 
public
 
T¿n§ùiÚTid
 {

90 
public
:

98 
cÚ¡ex´
 
ty³
 
d–_shiá
 =ype(12);

99 
cÚ¡ex´
 
ty³
 
	mwts_shiá
 =ype(20);

100 
cÚ¡ex´
 
ty³
 
	md–_mask
 =y³(0xffè<< 
d–_shiá
;

102 
ty³
 
	$wts_v®ue
(
ty³
 
t
) {

103  
t
 >> 
wts_shiá
;

105 
ty³
 
	$¹s_v®ue
(
ty³
 
t
) {

106 
ty³
 
d–
 = (
t
 & 
d–_mask
è>> 
d–_shiá
;

107  
	`wts_v®ue
(
t
è+ 
d–
;

108 
	}
}

110 
	$£t_time¡amps
(
ty³
& 
t
,y³ 
comm™_ts
,y³ 
æags
) {

111 
	`as£¹
(
	`is_locked_h”e
(
t
));

112 
comm™_ts
 = (comm™_t << 
wts_shiá
è| 
lock_b™
 | 
TTh»ad
::
	`id
();

113 
t
 = 
comm™_ts
 | 
æags
;

114 
	`»Ëa£_ãnû
();

115 
	}
}

116 
	$£t_time¡amps_uÆock
(
ty³
& 
t
,y³ 
comm™_ts
,y³ 
æags
) {

117 
comm™_ts
 <<ğ
wts_shiá
;

118 
t
 = 
comm™_ts
 | 
æags
;

119 
	`»Ëa£_ãnû
();

120 
	}
}

121 
boŞ
 
	$v®id©e_time¡amps
(
ty³
& 
t
,y³ 
»ad_tss
,y³ 
comm™_ts
) {

122 
Œue
) {

123 
ty³
 
v
 = 
t
;

124 
	`acquœe_ãnû
();

125 ià(
	`¹s_v®ue
(
»ad_tss
è>ğ
comm™_ts
)

126  
Œue
;

128 ià(
	`wts_v®ue
(
v
è!ğwts_v®ue(
»ad_tss
) ||

129 ((
	`¹s_v®ue
(
v
è< 
comm™_ts
è&& 
	`is_locked_–£wh”e
(
t
)))

130  
çl£
;

131 ià(
	`¹s_v®ue
(
v
è< 
comm™_ts
) {

132 
ty³
 
vv
 = 
v
;

133 
ty³
 
d–
 = 
comm™_ts
 - 
	`wts_v®ue
(
v
);

134 
ty³
 
shiá
 = 
d–
 - (delta & 0xff);

135 
vv
 +ğ(
shiá
 << 
wts_shiá
);

136 
vv
 &ğ~
d–_mask
;

137 
vv
 |ğ(
d–
 & 0xfà<< 
d–_shiá
);

138 ià(
	`boŞ_cmpxchg
(&
t
, 
v
, 
vv
))

139  
Œue
;

141  
Œue
;

145 
	}
}

147 
boŞ
 
	$v®id©e_time¡amps_nÛxt
(cÚ¡ 
ty³
& 
t
,y³ 
»ad_tss
,y³ 
comm™_ts
) {

148 
ty³
 
v
 = 
t
;

149 
	`acquœe_ãnû
();

150 ià(
	`¹s_v®ue
(
»ad_tss
è>ğ
comm™_ts
)

151  
Œue
;

153  !(
	`wts_v®ue
(
v
è!ğwts_v®ue(
»ad_tss
) ||

154 ((
	`¹s_v®ue
(
v
è< 
comm™_ts
è&& 
	`is_locked_–£wh”e
(
t
)));

156 
	}
}

159 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

160 
şass
 
	gTicTocBa£
 : 
public
 
V”siÚBa£
<
V”sIm¶
> {

161 
public
:

162 
usšg
 
BV
 = 
V”siÚBa£
<
V”sIm¶
>;

163 
usšg
 
	gBV
::
v_
;

164 
usšg
 
	gBV
::
im¶
;

166 
ty³Çme
 
	tBV
::
	tty³
ype;

168 
TicTocBa£
(è: 
BV
() {}

169 
ex¶ic™
 
TicTocBa£
(
ty³
 
v
è: 
BV
(v) {}

171 
boŞ
 
is_locked_–£wh”e
() {

172  
TicTocTid
::
is_locked_–£wh”e
(
v_
);

175 
ty³
 
»ad_time¡amp
() const {

176  
im¶
().
»ad_time¡amp_im¶
();

178 
ty³
 
wr™e_time¡amp
() const {

179  
im¶
().
wr™e_time¡amp_im¶
();

182 
tiùoc_compu‹_comm™_ts_¡•
(
ty³
& 
tiùoc_ts
, 
boŞ
 
is_wr™e
) {

183 ià(
	gis_wr™e
)

184 
	gtiùoc_ts
 = 
¡d
::
max
(
tiùoc_ts
, 
»ad_time¡amp
() + 1);

186 
	gtiùoc_ts
 = 
¡d
::
max
(
tiùoc_ts
, 
wr™e_time¡amp
());

189 
V”sIm¶
 
rd©a_exŒaù
(cÚ¡ 
rd©a_t
& 
rd
) {

190  
	gV”sIm¶
::
rd©a_exŒaù_im¶
(
rd
);

194 
	g‹m¶©e
 <
boŞ
 
	gO·que
 = 
çl£
, boŞ 
	gEx‹nd
 = 
Œue
>

195 
şass
 
TicTocV”siÚ
 : 
public
 
TicTocBa£
<TicTocV”siÚ<
O·que
, 
	gEx‹nd
>> {

196 
	gpublic
:

197 
usšg
 
BV
 = 
TicTocBa£
<
TicTocV”siÚ
<
O·que
, 
	gEx‹nd
>>;

199 
ty³Çme
 
	tBV
::
	tty³
ype;

201 
TicTocV”siÚ
(è: 
BV
(), 
wts_
(
š™Ÿlized_tid
) {};

202 
ex¶ic™
 
TicTocV”siÚ
(
ty³
 
v
è: 
BV
(v), 
wts_
(v) {}

203 
ex¶ic™
 
TicTocV”siÚ
(
ty³
 
v
, 
boŞ
 
š£¹
è: 
BV
(v), 
wts_
(vè{()
	gš£¹
;}

205 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
TicTocV”siÚ
<
O·que
, 
	gEx‹nd
>& 
	gÙh”
) const {

206  
	gBV
::
v_
 =ğ
Ùh”
.v_ && 
wts_
 == other.wts_;

209 
boŞ
 
is_locked
() const {

210  
	gTicTocTid
::
is_locked
(
BV
::
v_
);

213 
ty³
 
»ad_time¡amp_im¶
() const {

214  
	gTicTocTid
::
time¡amp
(
BV
::
v_
);

216 
ty³
 
wr™e_time¡amp_im¶
() const {

217  
	gTicTocTid
::
time¡amp
(
wts_
);

220 
TicTocV”siÚ
 
rd©a_exŒaù_im¶
(cÚ¡ 
rd©a_t
& 
rd
) {

221  
TicTocV”siÚ
(
rd
);

224 
boŞ
 
ı_Œy_lock_im¶
(
T¿nsI‹m
& 
™em
, 
th»adid
) {

225 
	g™em
.
cc_mode_check_tiùoc
(
this
, 
çl£
 );

226  
	gT¿n§ùiÚTid
::
Œy_lock
(
BV
::
v_
, 
th»adid
);

228 
ı_uÆock_im¶
(
T¿nsI‹m
& 
™em
) {

229 ()
	g™em
;

230 
	gT¿n§ùiÚTid
::
uÆock
(
BV
::
v_
);

233 
šlše
 
	gty³
& 
ı_acûss_tid_im¶
(
T¿n§ùiÚ
& 
txn
);

234 
šlše
 
ty³
 
ı_comm™_tid_im¶
(
T¿n§ùiÚ
& 
txn
);

236 
ı_£t_v”siÚ_uÆock_im¶
(
ty³
 
Ãw_ts
) {

237 
	gTicTocTid
::
£t_time¡amp
(
wts_
, 
Ãw_ts
, 0);

238 
	gTicTocTid
::
£t_time¡amp_uÆock
(
BV
::
v_
, 
Ãw_ts
, 0);

240 
ı_£t_v”siÚ_im¶
(
ty³
 
Ãw_ts
) {

241 
	gTicTocTid
::
£t_time¡amp_locked
(
BV
::
v_
, 
Ãw_ts
, 0);

242 
	gTicTocTid
::
£t_time¡amp
(
wts_
, 
Ãw_ts
, 0);

245 
boŞ
 
ı_check_v”siÚ_im¶
(
T¿n§ùiÚ
& 
txn
, 
T¿nsI‹m
& 
™em
) {

246 
ty³
 
	g»ad_¹s
, 
	g»ad_wts
;

247 
	g¡d
::
t›
(
»ad_¹s
, 
»ad_wts
èğ
TicTocTid
::
uÅack_wide
(
™em
.
wide_»ad_v®ue
());

248 
ty³
 
	gcu¼’t_ùs
 = 
ı_comm™_tid_im¶
(
txn
);

250 ià(
	gEx‹nd
)

251  
	gTicTocTid
::
v®id©e_time¡amps
(
wts_
, 
BV
::
v_
, 
»ad_wts
, 
»ad_¹s
, 
cu¼’t_ùs
);

253  
	gTicTocTid
::
v®id©e_time¡amps_nÛxt
(
wts_
, 
BV
::
v_
, 
»ad_wts
, 
»ad_¹s
, 
cu¼’t_ùs
);

256 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
);

257 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

258 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, cÚ¡ 
T
& 
wd©a
);

259 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

260 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
T
&& 
wd©a
);

261 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

262 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
Args
&&... 
¬gs
);

264 
šlše
 
boŞ
 
ob£rve_»ad_im¶
(
T¿nsI‹m
& 
™em
, boŞ 
add_»ad
);

266 
compu‹_comm™_ts_¡•_im¶
(
ty³
& 
tiùoc_ts
, 
boŞ
 
is_wr™e
) {

267 
	gthis
->
tiùoc_compu‹_comm™_ts_¡•
(
tiùoc_ts
, 
is_wr™e
);

270 
	g´iv©e
:

272 
ty³
 
wts_
;

273 
ex¶ic™
 
TicTocV”siÚ
(cÚ¡ 
rd©a_t
& 
rd
è: 
BV
Ôd.
w
.
v0
), 
wts_
Ôd.w.
v1
) {}

276 
	g‹m¶©e
 <
boŞ
 
	gO·que
 = 
çl£
, boŞ 
	gEx‹nd
 = 
Œue
>

277 
şass
 
TicTocCom´es£dV”siÚ
 : 
public
 
TicTocBa£
<TicTocCom´es£dV”siÚ<
O·que
, 
	gEx‹nd
>> {

278 
	gpublic
:

279 
usšg
 
BV
 = 
TicTocBa£
<
TicTocCom´es£dV”siÚ
<
O·que
, 
	gEx‹nd
>>;

280 
usšg
 
	gBV
::
v_
;

282 
ty³Çme
 
	tBV
::
	tty³
ype;

284 
TicTocCom´es£dV”siÚ
(è: 
BV
(1 << 
TicTocCom´es£dTid
::
wts_shiá
) {}

285 
ex¶ic™
 
TicTocCom´es£dV”siÚ
(
ty³
 
v
) {

286 
v_
 = (
v
 / 
T¿n§ùiÚTid
::
šüem’t_v®ue
è<< 
TicTocCom´es£dTid
::
wts_shiá
;

288 
ex¶ic™
 
TicTocCom´es£dV”siÚ
(
ty³
 
v
, 
boŞ
 
š£¹
) {

289 ()
	gš£¹
;

290 
	gv_
 = (
v
 / 
T¿n§ùiÚTid
::
šüem’t_v®ue
è<< 
TicTocCom´es£dTid
::
wts_shiá
;

293 
boŞ
 
is_locked
() const {

294  
	gTicTocCom´es£dTid
::
is_locked
(
v_
);

297 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
TicTocCom´es£dV”siÚ
<
O·que
, 
	gEx‹nd
>& 
	gÙh”
) const {

298  
	gv_
 =ğ
Ùh”
.
v_
;

301 
ty³
 
»ad_time¡amp_im¶
() const {

302  
	gTicTocCom´es£dTid
::
¹s_v®ue
(
v_
);

304 
ty³
 
wr™e_time¡amp_im¶
() const {

305  
	gTicTocCom´es£dTid
::
wts_v®ue
(
v_
);

308 
TicTocCom´es£dV”siÚ
 
rd©a_exŒaù_im¶
(cÚ¡ 
rd©a_t
& 
rd
) {

309  
TicTocCom´es£dV”siÚ
(
rd
);

312 
boŞ
 
ı_Œy_lock_im¶
(
T¿nsI‹m
& 
™em
, 
th»adid
) {

313 
	g™em
.
cc_mode_check_tiùoc
(
this
, 
Œue
 );

314  
	gTicTocCom´es£dTid
::
Œy_lock
(
v_
, 
th»adid
);

316 
ı_uÆock_im¶
(
T¿nsI‹m
& 
™em
) {

317 ()
	g™em
;

318 
	gTicTocCom´es£dTid
::
uÆock
(
v_
);

321 
šlše
 
	gty³
& 
ı_acûss_tid_im¶
(
T¿n§ùiÚ
& 
txn
);

322 
šlše
 
ty³
 
ı_comm™_tid_im¶
(
T¿n§ùiÚ
& 
txn
);

324 
ı_£t_v”siÚ_uÆock
(
ty³
 
Ãw_ts
) {

325 
	gTicTocCom´es£dTid
::
£t_time¡amps_uÆock
(
v_
, 
Ãw_ts
, 0);

327 
ı_£t_v”siÚ
(
ty³
 
Ãw_ts
) {

328 
	gTicTocCom´es£dTid
::
£t_time¡amps
(
v_
, 
Ãw_ts
, 0);

331 
boŞ
 
ı_check_v”siÚ_im¶
(
T¿n§ùiÚ
& 
txn
, 
T¿nsI‹m
& 
™em
) {

332 
ty³
 
	g»ad_tss
 = 
™em
.
»ad_v®ue
<type>();

333 
ty³
 
	gcu¼’t_ùs
 = 
ı_comm™_tid_im¶
(
txn
);

335 ià(
	gEx‹nd
)

336  
	gTicTocCom´es£dTid
::
v®id©e_time¡amps
(
v_
, 
»ad_tss
, 
cu¼’t_ùs
);

338  
	gTicTocCom´es£dTid
::
v®id©e_time¡amps_nÛxt
(
v_
, 
»ad_tss
, 
cu¼’t_ùs
);

341 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
);

342 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

343 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, cÚ¡ 
T
& 
wd©a
);

344 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

345 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
T
&& 
wd©a
);

346 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

347 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
Args
&&... 
¬gs
);

349 
šlše
 
boŞ
 
ob£rve_»ad_im¶
(
T¿nsI‹m
& 
™em
, boŞ 
add_»ad
);

351 
compu‹_comm™_ts_¡•_im¶
(
ty³
& 
tiùoc_ts
, 
boŞ
 
is_wr™e
) {

352 
	gthis
->
tiùoc_compu‹_comm™_ts_¡•
(
tiùoc_ts
, 
is_wr™e
);

355 
	g´iv©e
:

356 
ex¶ic™
 
TicTocCom´es£dV”siÚ
(cÚ¡ 
rd©a_t
& 
rd
è: 
BV
(
»š‹½»t_ÿ¡
<
ty³
>Ôd.
v
)) {}

	@sto-core/TransItem.hh

1 #´agm¨
Úû


3 
	~<ty³_Œa™s
>

4 
	~<c¡ršg
>

5 
	~<ÿs£¹
>

6 
	~"comp”.hh
"

7 
	~"Pack”.hh
"

8 
	~"TTh»ad.hh
"

9 
	~"TicTocSŒuùs.hh
"

11 
şass
 
	gTW¿µedAcûss
;

13 
şass
 
	gT¿nsProxy
;

15 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

16 
şass
 
	gV”siÚBa£
;

18 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

19 
şass
 
	gTicTocBa£
;

21 şas 
	cCCMode
 : {
nÚe
 = 0, 
	mİt
, 
	mlock
, 
	mtiùoc
};

23 şas 
	cT¿nsI‹m
 {

24 
	mpublic
:

25 #ià
SIZEOF_VOID_P
 == 8

26 
ušŒ_t
 
	towÃr¡Üe_ty³
;

27 
ušŒ_t
 
	tæags_ty³
;

29 
ušt64_t
 
	towÃr¡Üe_ty³
;

30 
ušt64_t
 
	tæags_ty³
;

33 
cÚ¡ex´
 
æags_ty³
 
	mwr™e_b™
 = flags_type(1) << 63;

34 
cÚ¡ex´
 
æags_ty³
 
	m»ad_b™
 = flags_type(1) << 62;

35 
cÚ¡ex´
 
æags_ty³
 
	mlock_b™
 = flags_type(1) << 61;

36 
cÚ¡ex´
 
æags_ty³
 
	m´ediÿ‹_b™
 = flags_type(1) << 60;

37 
cÚ¡ex´
 
æags_ty³
 
	m¡ash_b™
 = flags_type(1) << 59;

38 
cÚ¡ex´
 
æags_ty³
 
	mş_b™
 = flags_type(1) << 58;

39 
cÚ¡ex´
 
æags_ty³
 
	mpoš‹r_mask
 = (flags_type(1) << 48) - 1;

40 
cÚ¡ex´
 
æags_ty³
 
	mowÃr_mask
 = 
poš‹r_mask
;

41 
cÚ¡ex´
 
æags_ty³
 
	mu£r0_b™
 = flags_type(1) << 48;

42 
cÚ¡ex´
 
	mu£rf_shiá
 = 48;

43 
cÚ¡ex´
 
æags_ty³
 
	mshiáed_u£rf_mask
 = 0x7FF;

44 
cÚ¡ex´
 
æags_ty³
 
	m¥ecŸl_mask
 = 
owÃr_mask
 | 
ş_b™
 | 
»ad_b™
 | 
wr™e_b™
 | 
lock_b™
 | 
´ediÿ‹_b™
 | 
¡ash_b™
;

47 
	$T¿nsI‹m
(è: 
	`s_
(), 
	`key_
(), 
	$mode_
(
CCMode
::
nÚe
) {};

48 
	$T¿nsI‹m
(
TObjeù
* 
owÃr
, * 
k
)

49 : 
	`s_
(
»š‹½»t_ÿ¡
<
owÃr¡Üe_ty³
>(
owÃr
)), 
	`key_
(
k
), 
	$mode_
(
CCMode
::
nÚe
) {

50 
	}
}

52 
TObjeù
* 
	$owÃr
() const {

53  
»š‹½»t_ÿ¡
<
TObjeù
*>(
s_
 & 
poš‹r_mask
);

54 
	}
}

56 
boŞ
 
	$has_wr™e
() const {

57  
	`æags
(è& 
wr™e_b™
;

58 
	}
}

59 
boŞ
 
	$has_»ad
() const {

60  
	`æags
(è& 
»ad_b™
;

61 
	}
}

62 
boŞ
 
	$has_´ediÿ‹
() const {

63  
	`æags
(è& 
´ediÿ‹_b™
;

64 
	}
}

65 
boŞ
 
	$has_¡ash
() const {

66  
	`æags
(è& 
¡ash_b™
;

67 
	}
}

68 
boŞ
 
	$Ãeds_uÆock
() const {

69  
	`æags
(è& 
lock_b™
;

70 
	}
}

71 
boŞ
 
	$locked_©_comm™
() const {

72  
	`æags
(è& 
ş_b™
;

73 
	}
}

74 
boŞ
 
	$§me_™em
(cÚ¡ 
T¿nsI‹m
& 
x
) const {

75  !((
s_
 ^ 
x
.s_è& 
owÃr_mask
è&& 
key_
 == x.key_;

76 
	}
}

77 
boŞ
 
	$has_æag
(
æags_ty³
 
f
) const {

78  
	`æags
(è& 
f
;

79 
	}
}

81 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

82 cÚ¡ 
	gT
& 
	$key
() const {

83  
Pack”
<
T
>::
	`uÅack
(
key_
);

84 
	}
}

86 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

87 
	gT
& 
	$»ad_v®ue
() {

88 
	`as£¹
(
	`has_»ad
());

89  
Pack”
<
T
>::
	`uÅack
(
rd©a_
.
v
);

90 
	}
}

91 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

92 cÚ¡ 
	gT
& 
	$»ad_v®ue
() const {

93 
	`as£¹
(
	`has_»ad
());

94  
Pack”
<
T
>::
	`uÅack
(
rd©a_
.
v
);

95 
	}
}

98 cÚ¡ 
	gWideTid
& 
	$wide_»ad_v®ue
() const {

99 
	`as£¹
(
	`has_»ad
());

100  
rd©a_
.
w
;

101 
	}
}

103 
	gWideTid
& 
	$wide_»ad_v®ue
() {

104  
rd©a_
.
w
;

105 
	}
}

107 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

108 
	gT
& 
	$´ediÿ‹_v®ue
() {

109 
	`as£¹
(
	`has_´ediÿ‹
(è&& !
	`has_»ad
());

110  
Pack”
<
T
>::
	`uÅack
(
rd©a_
.
v
);

111 
	}
}

112 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

113 cÚ¡ 
	gT
& 
	$´ediÿ‹_v®ue
() const {

114 
	`as£¹
(
	`has_´ediÿ‹
(è&& !
	`has_»ad
());

115  
Pack”
<
T
>::
	`uÅack
(
rd©a_
.
v
);

116 
	}
}

118 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

119 
	gT
& 
	$¿w_wr™e_v®ue
() {

120  
Pack”
<
T
>::
	`uÅack
(
wd©a_
);

121 
	}
}

123 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

124 cÚ¡ 
	gT
& 
	$¿w_wr™e_v®ue
() const {

125  
Pack”
<
T
>::
	`uÅack
(
wd©a_
);

126 
	}
}

128 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

129 
	gT
& 
	$wr™e_v®ue
() {

130 
	`as£¹
(
	`has_wr™e
());

131  
Pack”
<
T
>::
	`uÅack
(
wd©a_
);

132 
	}
}

133 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

134 cÚ¡ 
	gT
& 
	$wr™e_v®ue
() const {

135 
	`as£¹
(
	`has_wr™e
());

136  
Pack”
<
T
>::
	`uÅack
(
wd©a_
);

137 
	}
}

138 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

139 
T
 
	$wr™e_v®ue
(
T
 
deçuÉ_v®ue
) const {

140  
	`has_wr™e
(è? 
Pack”
<
T
>::
	`uÅack
(
wd©a_
è: 
deçuÉ_v®ue
;

141 
	}
}

143 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

144 
	gT
& 
	$xwr™e_v®ue
() {

145 
	`¡©ic_as£¹
(
Pack”
<
T
>::
is_sim¶e
, "xwrite_value only works on simpleypes");

146  
Pack”
<
T
>::
	`uÅack
(
wd©a_
);

147 
	}
}

148 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

149 cÚ¡ 
	gT
& 
	$xwr™e_v®ue
() const {

150 
	`¡©ic_as£¹
(
Pack”
<
T
>::
is_sim¶e
, "xwrite_value only works on simpleypes");

151  
Pack”
<
T
>::
	`uÅack
(
wd©a_
);

152 
	}
}

154 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

155 
	gT
& 
	$¡ash_v®ue
() {

156 
	`as£¹
(
	`has_¡ash
());

157  
Pack”
<
T
>::
	`uÅack
(
rd©a_
.
v
);

158 
	}
}

159 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

160 cÚ¡ 
	gT
& 
	$¡ash_v®ue
() const {

161 
	`as£¹
(
	`has_¡ash
());

162  
Pack”
<
T
>::
	`uÅack
(
rd©a_
.
v
);

163 
	}
}

164 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

165 
T
 
	$¡ash_v®ue
(
T
 
deçuÉ_v®ue
) const {

166 
	`as£¹
(!
	`has_»ad
());

167 ià(
	`has_¡ash
())

168  
Pack”
<
T
>::
	`uÅack
(
rd©a_
.
v
);

170  
¡d
::
	`move
(
deçuÉ_v®ue
);

171 
	}
}

173 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
T¿nsI‹m
& 
x
) const {

174  
§me_™em
(
x
);

176 
šlše
 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gT¿nsI‹m
& 
	gx
) const {

179  
	gkey_
 < 
	gx
.key_

180 || (
	gkey_
 =ğ
x
.
key_
 && (
s_
 & 
owÃr_mask
) < (x.s_ & owner_mask));

183 
æags_ty³
 
	$æags
() const {

184  
s_
;

185 
	}
}

186 
æags_ty³
 
	$shiáed_u£r_æags
() const {

187  (
s_
 >> 
u£rf_shiá
è& 
shiáed_u£rf_mask
;

188 
	}
}

190 
	gT¿nsI‹m
& 
	$assign_æags
(
æags_ty³
 
æags
) {

191 
	`as£¹
(!(
æags
 & 
¥ecŸl_mask
));

192 
s_
 = (s_ & 
¥ecŸl_mask
è| 
æags
;

193  *
this
;

194 
	}
}

195 
	gT¿nsI‹m
& 
	$ş—r_æags
(
æags_ty³
 
æags
) {

196 
	`as£¹
(!(
æags
 & 
¥ecŸl_mask
));

197 
s_
 = s_ & ~
æags
;

198  *
this
;

199 
	}
}

201 
	gT¿nsI‹m
& 
	$add_æags
(
æags_ty³
 
æags
) {

202 
	`as£¹
(!(
æags
 & 
¥ecŸl_mask
));

203 
s_
 = s_ | 
æags
;

204  *
this
;

205 
	}
}

207 
	gT¿nsI‹m
& 
	$ş—r_Ãeds_uÆock
() {

208 
	`__rm_æags
(
lock_b™
);

209  *
this
;

210 
	}
}

212 
CCMode
 
	$cc_mode
() const {

213  
mode_
;

214 
	}
}

216 
CCMode
 
	$cc_mode
(
CCMode
 
ob£rve_mode
) {

217 ià(
mode_
 =ğ
CCMode
::
nÚe
) {

218 
mode_
 = 
ob£rve_mode
;

220  
mode_
;

221 
	}
}

223 
	$cc_mode_check_tiùoc
(*
ts_Üigš
, 
boŞ
 
com´es£d
) {

224 ià(
mode_
 =ğ
CCMode
::
nÚe
) {

225 
mode_
 = 
CCMode
::
tiùoc
;

226 ià(
com´es£d
) {

227 
ts_Üigš_
 =

228 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
ts_Üigš
è| 
tiùoc_com´es£d_ty³_b™
;

230 
ts_Üigš_
 = 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
ts_Üigš
);

233 
	`as£¹
(
mode_
 =ğ
CCMode
::
tiùoc
);

234 
	`as£¹
(
ts_Üigš_
 != 0);

235 
	}
}

237 
boŞ
 
	$cc_mode_is_İtimi¡ic
(
boŞ
 
v”siÚ_İtimi¡ic
) {

238 ià(
mode_
 =ğ
CCMode
::
nÚe
)

239 
mode_
 = 
v”siÚ_İtimi¡ic
 ? 
CCMode
::
İt
 : CCMode::
lock
;

240  (
mode_
 =ğ
CCMode
::
İt
);

241 
	}
}

243 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

244 
	gV”sIm¶
& 
	$tiùoc_ãtch_ts_Üigš
() {

245  *
»š‹½»t_ÿ¡
<
V”sIm¶
 *>(
ts_Üigš_
 & ~
tiùoc_com´es£d_ty³_b™
);

246 
	}
}

248 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

249 
V”sIm¶
 
	$tiùoc_exŒaù_»ad_ts
() const {

250  
TicTocBa£
<
V”sIm¶
>::
	`rd©a_exŒaù
(
rd©a_
);

251 
	}
}

253 
boŞ
 
	$is_tiùoc_com´es£d
() {

254 
	`as£¹
(
	`cc_mode
(è=ğ
CCMode
::
tiùoc
);

255  (
ts_Üigš_
 & 
tiùoc_com´es£d_ty³_b™
) != 0;

256 
	}
}

258 
	g´iv©e
:

259 
cÚ¡ex´
 
ušŒ_t
 
tiùoc_com´es£d_ty³_b™
 = 0x1;

261 
owÃr¡Üe_ty³
 
	gs_
;

263 * 
	gkey_
;

264 
rd©a_t
 
	grd©a_
;

265 * 
	gwd©a_
;

266 
ušŒ_t
 
	gts_Üigš_
;

268 
CCMode
 
	gmode_
;

270 
	$__rm_æags
(
æags_ty³
 
æags
) {

271 
s_
 = s_ & ~
æags
;

272 
	}
}

273 
	$__Ü_æags
(
æags_ty³
 
æags
) {

274 
s_
 = s_ | 
æags
;

275 
	}
}

277 
ä›nd
 
şass
 
	gT¿n§ùiÚ
;

278 
ä›nd
 
şass
 
	gT¿nsProxy
;

279 
ä›nd
 
şass
 
	gTW¿µedAcûss
;

280 
ä›nd
 
şass
 
	gV”siÚD–eg©e
;

283 şas 
	cT¿nsProxy
 {

284 
	mpublic
:

285 
	$T¿nsProxy
(
T¿n§ùiÚ
& 
t
, 
T¿nsI‹m
& 
™em
)

286 : 
	`t_
(&
t
), 
	$™em_
(&
™em
) {

287 
	`as£¹
(&
t
 =ğ
TTh»ad
::
txn
);

290 
T¿nsProxy
* 
İ”©Ü
->() {

291  
this
;

292 
	}
}

293 
İ”©Ü
 
	gT¿nsI‹m
&() {

294  
™em
();

297 
boŞ
 
	$has_»ad
() const {

298  
	`™em
().
	`has_»ad
();

299 
	}
}

300 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

301 
boŞ
 
	$has_»ad
(cÚ¡ 
T
& 
v®ue
) const {

302  
	`has_»ad
(è&& 
this
->
‹m¶©e
 
»ad_v®ue
<
T
>(è=ğ
v®ue
;

303 
	}
}

304 
boŞ
 
	$has_´ediÿ‹
() const {

305  
	`™em
().
	`has_´ediÿ‹
();

306 
	}
}

307 
boŞ
 
	$has_wr™e
() const {

308  
	`™em
().
	`has_wr™e
();

309 
	}
}

310 
boŞ
 
	$has_¡ash
() const {

311  
	`™em
().
	`has_¡ash
();

312 
	}
}

313 
boŞ
 
	$has_æag
(
T¿nsI‹m
::
æags_ty³
 
f
) const {

314  
	`™em
().
	`æags
(è& 
f
;

315 
	}
}

316 
CCMode
 
	$cc_mode
(
CCMode
 
obs_mode
) {

317  
	`™em
().
	`cc_mode
(
obs_mode
);

318 
	}
}

319 
boŞ
 
	$cc_mode_is_İtimi¡ic
(
boŞ
 
v_İt
) {

320  
	`™em
().
	`cc_mode_is_İtimi¡ic
(
v_İt
);

321 
	}
}

323 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

324 
šlše
 
boŞ
 
add_»ad
(
T
 
rd©a
);

325 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

326 
šlše
 
boŞ
 
add_»ad_İaque
(
T
 
rd©a
);

328 
šlše
 
	gT¿nsProxy
& 
	$ş—r_»ad
() {

329 
	`™em
().
	`__rm_æags
(
T¿nsI‹m
::
»ad_b™
);

330  *
this
;

331 
	}
}

332 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

333 
šlše
 
	gT¿nsProxy
& 
upd©e_»ad
(
T
 
Şd_rd©a
, T 
Ãw_rd©a
);

335 
šlše
 
	gT¿nsProxy
& 
£t_´ediÿ‹
();

336 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

337 
šlše
 
	gT¿nsProxy
& 
£t_´ediÿ‹
(
T
 
pd©a
);

338 
šlše
 
	gT¿nsProxy
& 
	$ş—r_´ediÿ‹
() {

339 
	`™em
().
	`__rm_æags
(
T¿nsI‹m
::
´ediÿ‹_b™
);

340  *
this
;

341 
	}
}

343 
šlše
 
	gT¿nsProxy
& 
add_wr™e
();

344 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

345 
šlše
 
	gT¿nsProxy
& 
add_wr™e
(cÚ¡ 
T
& 
wd©a
);

346 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

347 
šlše
 
	gT¿nsProxy
& 
add_wr™e
(
T
&& 
wd©a
);

348 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

349 
šlše
 
	gT¿nsProxy
& 
add_wr™e
(
Args
&&... 
wd©a
);

350 
šlše
 
	gT¿nsProxy
& 
	$ş—r_wr™e
() {

351 
	`™em
().
	`__rm_æags
(
T¿nsI‹m
::
wr™e_b™
);

352  *
this
;

353 
	}
}

356 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

357 
boŞ
 
ob£rve
(
V”siÚBa£
<
V”sIm¶
>& 
v”siÚ
) {

358  
	gv”siÚ
.
ob£rve_»ad
(
™em
(), 
Œue
);

360 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

361 
boŞ
 
ob£rve
(
V”siÚBa£
<
V”sIm¶
>& 
v”siÚ
, boŞ 
add_»ad
) {

362  
	gv”siÚ
.
ob£rve_»ad
(
™em
(), 
add_»ad
);

364 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

365 
boŞ
 
ob£rve_İac™y
(
V”siÚBa£
<
V”sIm¶
>& 
v”siÚ
) {

366  
	gv”siÚ
.
ob£rve_»ad
(
™em
(), 
çl£
);

370 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

371 
boŞ
 
acquœe_wr™e
(
V”siÚBa£
<
V”sIm¶
>& 
v”s
) {

372  
	gv”s
.
acquœe_wr™e
(
™em
());

374 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
,y³Çm
	gT
>

375 
boŞ
 
acquœe_wr™e
(
V”siÚBa£
<
V”sIm¶
>& 
v”s
, cÚ¡ 
T
& 
wd©a
) {

376  
	gv”s
.
acquœe_wr™e
(
™em
(), 
wd©a
);

378 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
,y³Çm
	gT
>

379 
boŞ
 
acquœe_wr™e
(
V”siÚBa£
<
V”sIm¶
>& 
v”s
, 
T
&& 
wd©a
) {

380  
	gv”s
.
acquœe_wr™e
(
™em
(), 
wd©a
);

382 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gV”sIm¶
, 
	gty³Çme
... 
	gArgs
>

383 
boŞ
 
acquœe_wr™e
(
V”siÚBa£
<
V”sIm¶
>& 
v”s
, 
Args
&&... 
¬gs
) {

384  
	gv”s
.
‹m¶©e
 
	gacquœe_wr™e
<
	gT
>(
™em
(), 
	g¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

387 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

388 
šlše
 
	gT¿nsProxy
& 
£t_¡ash
(
T
 
sd©a
);

389 
šlše
 
	gT¿nsProxy
& 
	$ş—r_¡ash
() {

390 
	`™em
().
	`__rm_æags
(
T¿nsI‹m
::
¡ash_b™
);

391  *
this
;

392 
	}
}

394 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

395 
	gT
& 
	$»ad_v®ue
() {

396  
	`™em
().
»ad_v®ue
<
T
>();

397 
	}
}

398 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

399 cÚ¡ 
	gT
& 
	$»ad_v®ue
() const {

400  
	`™em
().
»ad_v®ue
<
T
>();

401 
	}
}

403 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

404 
	gT
& 
	$´ediÿ‹_v®ue
() {

405  
	`™em
().
´ediÿ‹_v®ue
<
T
>();

406 
	}
}

407 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

408 
šlše
 
	gT
& 
´ediÿ‹_v®ue
(
T
 
deçuÉ_v®ue
);

409 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

410 cÚ¡ 
	gT
& 
	$´ediÿ‹_v®ue
() const {

411  
	`™em
().
´ediÿ‹_v®ue
<
T
>();

412 
	}
}

414 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

415 
	gT
& 
	$¿w_wr™e_v®ue
() {

416  
	`™em
().
¿w_wr™e_v®ue
<
T
>();

417 
	}
}

419 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

420 cÚ¡ 
	gT
& 
	$¿w_wr™e_v®ue
() const {

421  
	`™em
().
¿w_wr™e_v®ue
<
T
>();

422 
	}
}

424 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

425 
	gT
& 
	$wr™e_v®ue
() {

426  
	`™em
().
wr™e_v®ue
<
T
>();

427 
	}
}

428 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

429 cÚ¡ 
	gT
& 
	$wr™e_v®ue
(cÚ¡ 
T
& 
deçuÉ_v®ue
) {

430 ià(
	`™em
().
	`has_wr™e
())

431  
	`™em
().
wr™e_v®ue
<
T
>();

433  
deçuÉ_v®ue
;

434 
	}
}

435 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

436 cÚ¡ 
	gT
& 
	$wr™e_v®ue
() const {

437  
	`™em
().
wr™e_v®ue
<
T
>();

438 
	}
}

440 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

441 
	gT
& 
	$xwr™e_v®ue
() {

442  
	`™em
().
xwr™e_v®ue
<
T
>();

443 
	}
}

445 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

446 
	gT
& 
	$¡ash_v®ue
() {

447  
	`™em
().
¡ash_v®ue
<
T
>();

448 
	}
}

449 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

450 cÚ¡ 
	gT
& 
	$¡ash_v®ue
() const {

451  
	`™em
().
¡ash_v®ue
<
T
>();

452 
	}
}

453 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

454 
T
 
	$¡ash_v®ue
(
T
 
deçuÉ_v®ue
) const {

455  
	`™em
().
¡ash_v®ue
<
T
>(
¡d
::
	`move
(
deçuÉ_v®ue
));

456 
	}
}

458 
	gT¿nsProxy
& 
	$»move_»ad
() {

459 
	`™em
().
	`__rm_æags
(
T¿nsI‹m
::
»ad_b™
);

460  *
this
;

461 
	}
}

462 
	gT¿nsProxy
& 
	$»move_wr™e
() {

463 
	`™em
().
	`__rm_æags
(
T¿nsI‹m
::
wr™e_b™
);

464  *
this
;

465 
	}
}

468 
	gT¿nsI‹m
::
æags_ty³
 
	$æags
() const {

469  
	`™em
().
	`æags
();

470 
	}
}

471 
	gT¿nsI‹m
::
æags_ty³
 
	$shiáed_u£r_æags
() const {

472  
	`™em
().
	`shiáed_u£r_æags
();

473 
	}
}

474 
	gT¿nsProxy
& 
	$assign_æags
(
T¿nsI‹m
::
æags_ty³
 
æags
) {

475 
	`™em
().
	`assign_æags
(
æags
);

476  *
this
;

477 
	}
}

478 
	gT¿nsProxy
& 
	$ş—r_æags
(
T¿nsI‹m
::
æags_ty³
 
æags
) {

479 
	`™em
().
	`ş—r_æags
(
æags
);

480  *
this
;

481 
	}
}

482 
	gT¿nsProxy
& 
	$add_æags
(
T¿nsI‹m
::
æags_ty³
 
æags
) {

483 
	`™em
().
	`add_æags
(
æags
);

484  *
this
;

485 
	}
}

487 
šlše
 
	gT¿n§ùiÚ
& 
	$Œª§ùiÚ
() const {

488  *
t_
;

489 
	}
}

490 
šlše
 
	gT¿nsI‹m
& 
	$™em
() const {

491  *
™em_
;

492 
	}
}

495 
	g´iv©e
:

496 
T¿n§ùiÚ
* 
t_
;

497 
T¿nsI‹m
* 
	g™em_
;

498 
šlše
 
T¿n§ùiÚ
* 
	$t
() const {

499  
t_
;

500 
	}
}

502 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

503 
ä›nd
 
şass
 
	gV”siÚBa£
;

505 
ä›nd
 
şass
 
	gT¿n§ùiÚ
;

506 
ä›nd
 
şass
 
	gO±iÚ®T¿nsProxy
;

510 şas 
	cO±iÚ®T¿nsProxy
 {

511 
	mpublic
:

512 
	$T¿nsProxy
 (
	tO±iÚ®T¿nsProxy
::*
	tun¥ecif›d_boŞ_ty³
)() const;

513 
İ”©Ü
 
	$un¥ecif›d_boŞ_ty³
() const {

514  
™em_
 ? &
O±iÚ®T¿nsProxy
::
g‘
 : 0;

516 
T¿nsProxy
 
	$g‘
() const {

517 
	`as£¹
(
™em_
);

518  
	`T¿nsProxy
(*
	`t
(), *
™em_
);

519 
	}
}

520 
T¿nsProxy
 
	gİ”©Ü
*() const {

521  
g‘
();

523 
T¿nsProxy
 
	gİ”©Ü
->() const {

524  
g‘
();

526 
	g´iv©e
:

527 
T¿nsI‹m
* 
™em_
;

528 
	$O±iÚ®T¿nsProxy
(
T¿n§ùiÚ
& 
t
, 
T¿nsI‹m
* 
™em
)

529 : 
	$™em_
(
™em
) {

530 (è
t
;

531 
	`as£¹
(&
t
 =ğ
TTh»ad
::
txn
);

532 
	}
}

533 
šlše
 
T¿n§ùiÚ
* 
	$t
() const {

534  
TTh»ad
::
txn
;

535 
	}
}

536 
ä›nd
 
şass
 
	gT¿n§ùiÚ
;

540 
šlše
 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	gT¿nsI‹m
& 
	g™em
) {

541 
	g™em
.
owÃr
()->
´št
(
w
, 
™em
);

542  
	gw
;

	@sto-core/TransScratch.hh

1 #´agm¨
Úû


3 
	~<c¡dlib
>

4 
	~<c¡ršg
>

5 
	~<ÿs£¹
>

7 şas 
	cT¿nsSü©ch
 {

8 
	mpublic
:

9 
cÚ¡ex´
 
size_t
 
š™Ÿl_zÚe_ÿ·c™y
 = 4096;

10 
cÚ¡ex´
 
size_t
 
	mmax_sü©ch_»¡¬t_ÿ·c™y
 = 2097152;

12 
	$T¿nsSü©ch
()

13 : 
	`_Ãxt_ava
(0), 
	`_ÿ·c™y
(0),

14 
	`tÙ®_ÿ·c™y
(0), 
	`zÚe_h—d
(
nuÎ±r
), 
	$zÚe_
(
nuÎ±r
) {}

16 
ex¶ic™
 
	$T¿nsSü©ch
(
size_t
 
š™_size
)

17 : 
	`_Ãxt_ava
(0), 
	`_ÿ·c™y
(
š™_size
),

18 
	$tÙ®_ÿ·c™y
(
š™_size
) {

19 autØ
z
 = 
Ãw
 [(
zÚe_hdr
è+ 
š™_size
];

20 
	`Ãw
 (
»š‹½»t_ÿ¡
<
zÚe_hdr
 *>(
z
)è
	`zÚe_hdr
(
š™_size
);

21 
zÚe_h—d
 = 
zÚe_
 = 
»š‹½»t_ÿ¡
<
zÚe_hdr
 *>(
z
);

22 
	}
}

24 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

25 
šlše
 
	gT
& 
®loÿ‹
();

27 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

28 
šlše
 
	gT
& 
şÚe
(cÚ¡ 
T
& 
Ùh”
);

30 
šlše
 
ş—r
();

32 
	g´iv©e
:

33 
	szÚe_hdr
 {

34 
zÚe_hdr
(è: 
Ëngth
(0), 
Ãxt
(
nuÎ±r
) {}

35 
ex¶ic™
 
zÚe_hdr
(
size_t
 
zÚe_size
è: 
Ëngth
(zÚe_size), 
Ãxt
(
nuÎ±r
) {}

36 *
š_zÚe
(
off_t
 
off£t
) {

37  (
	g»š‹½»t_ÿ¡
<*>(
	gthis
 + 1è+ 
	goff£t
);

39 
size_t
 
	gËngth
;

40 
zÚe_hdr
 *
	gÃxt
;

43 
	g´Ùeùed
:

44 
size_t
 
_Ãxt_ava
;

45 
size_t
 
	g_ÿ·c™y
;

46 
size_t
 
	gtÙ®_ÿ·c™y
;

47 
zÚe_hdr
 *
	gzÚe_h—d
;

48 
zÚe_hdr
 *
	gzÚe_
;

51 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

52 
	gT
& 
	gT¿nsSü©ch
::
	$®loÿ‹
() {

53 * 
±r
 = 
nuÎ±r
;

54 
size_t
 
Ãw_Ãxt_ava
 = 
_Ãxt_ava
 + (
T
);

55 ià(
Ãw_Ãxt_ava
 >ğ
_ÿ·c™y
) {

57 
size_t
 
Ãw_ÿ·c™y
 = (
_ÿ·c™y
 > 0è? (_ÿ·c™y * 2è: 
š™Ÿl_zÚe_ÿ·c™y
;

58 
	`as£¹
(
Ãw_ÿ·c™y
 > (
T
));

60 autØ
z
 = 
Ãw
 [(
zÚe_hdr
è+ 
Ãw_ÿ·c™y
];

61 autØ
Ãw_zÚe
 = 
»š‹½»t_ÿ¡
<
zÚe_hdr
 *>(
z
);

62 
	`Ãw
 (
Ãw_zÚe
è
	`zÚe_hdr
(
Ãw_ÿ·c™y
);

64 ià(
zÚe_h—d
 =ğ
nuÎ±r
) {

65 
	`as£¹
(
zÚe_
 =ğ
nuÎ±r
);

66 
zÚe_h—d
 = 
Ãw_zÚe
;

69 ià(
Ãw_Ãxt_ava
 > 
_ÿ·c™y
) {

71 
±r
 = 
Ãw_zÚe
->
	`š_zÚe
(0);

72 
_Ãxt_ava
 = (
T
);

75 
±r
 = 
zÚe_
->
	`š_zÚe
(
_Ãxt_ava
);

76 
_Ãxt_ava
 = 0;

79 
_ÿ·c™y
 = 
Ãw_ÿ·c™y
;

80 
tÙ®_ÿ·c™y
 +ğ
Ãw_ÿ·c™y
;

81 ià(
zÚe_
 !ğ
nuÎ±r
)

82 
zÚe_
->
Ãxt
 = 
Ãw_zÚe
;

83 
zÚe_
 = 
Ãw_zÚe
;

85 
±r
 = 
zÚe_
->
	`š_zÚe
(
_Ãxt_ava
);

86 
_Ãxt_ava
 = 
Ãw_Ãxt_ava
;

88  *
»š‹½»t_ÿ¡
<
T
 *>(
±r
);

89 
	}
}

91 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

92 
	gT
& 
	gT¿nsSü©ch
::
	$şÚe
(cÚ¡ 
T
 &
Ùh”
) {

93 
T
 *
obj
 = &
®loÿ‹
<T>();

94 
	`memıy
(
obj
, &
Ùh”
, (
T
));

95  *
obj
;

96 
	}
}

98 
	gT¿nsSü©ch
::
	$ş—r
() {

99 ià(
zÚe_h—d
 =ğ
zÚe_
) {

101 
	`as£¹
(
tÙ®_ÿ·c™y
 =ğ
_ÿ·c™y
);

102 
_Ãxt_ava
 = 0;

106 
zÚe_hdr
 *
cu¼
 = 
zÚe_h—d
;

107 
size_t
 
ÿ·c™y_check
 = 0;

108 
cu¼
 !ğ
nuÎ±r
) {

109 autØ
Ãxt_zÚe
 = 
cu¼
->
Ãxt
;

110 
ÿ·c™y_check
 +ğ
cu¼
->
Ëngth
;

111 
d–‘e
[] 
cu¼
;

112 
cu¼
 = 
Ãxt_zÚe
;

114 
	`as£¹
(
ÿ·c™y_check
 =ğ
tÙ®_ÿ·c™y
);

117 ià(
tÙ®_ÿ·c™y
 > 
max_sü©ch_»¡¬t_ÿ·c™y
)

118 
tÙ®_ÿ·c™y
 = 
max_sü©ch_»¡¬t_ÿ·c™y
;

120 autØ
z
 = 
Ãw
 [(
zÚe_hdr
è+ 
tÙ®_ÿ·c™y
];

121 autØ
sšgË_zÚe
 = 
»š‹½»t_ÿ¡
<
zÚe_hdr
 *>(
z
);

122 
	`Ãw
 (
sšgË_zÚe
è
	`zÚe_hdr
(
tÙ®_ÿ·c™y
);

124 
_Ãxt_ava
 = 0;

125 
_ÿ·c™y
 = 
tÙ®_ÿ·c™y
;

126 
zÚe_h—d
 = 
zÚe_
 = 
sšgË_zÚe
;

127 
	}
}

	@sto-core/Transaction.cc

1 
	~"Sto.hh
"

2 
	~<ty³šfo
>

3 
	~<b™£t
>

4 
	~<f¡»am
>

6 
	~<sys/»sourû.h
>

7 
	~<sys/time.h
>

9 
	gT¿n§ùiÚ
::
‹¡šg_ty³
 
T¿n§ùiÚ
::
‹¡šg
;

10 
th»adšfo_t
 
	gT¿n§ùiÚ
::
tšfo
[
MAX_THREADS
];

11 
__th»ad
 
	gTTh»ad
::
the_id
;

12 
P”ûÁG’
 
	gTTh»ad
::
g’
[
MAX_THREADS
];

14 
	gT¿n§ùiÚ
::
•och_¡©e
 
__©Œibu‹__
((
	$®igÃd
(128))è
T¿n§ùiÚ
::
glob®_•ochs
 = {

15 1, 0, 
T¿n§ùiÚTid
::
šüem’t_v®ue
, 
Œue


16 
	}
};

17 
__th»ad
 
T¿n§ùiÚ
 *
	gTTh»ad
::
txn
 = 
nuÎ±r
;

18 
	g¡d
::
funùiÚ
<(
th»adšfo_t
::
•och_ty³
)> 
T¿n§ùiÚ
::
•och_advªû_ÿÎback
;

19 
	gT¿n§ùiÚTid
::
ty³
 
__©Œibu‹__
((
	$®igÃd
(128))è
T¿n§ùiÚ
::
_TID
 = 2 * 
T¿n§ùiÚTid
::
šüem’t_v®ue
;

22 
	`__©Œibu‹__
((
u£d
)è
	$check_¡©ic_as£¹iÚs
() {

23 
	`¡©ic_as£¹
((
th»adšfo_t
) % 128 == 0, "threadinfo is 2-cache-line‡ligned");

24 
	}
}

26 
	gT¿n§ùiÚ
::
	$š™Ÿlize
() {

27 
	`¡©ic_as£¹
(
t£t_š™Ÿl_ÿ·c™y
 % 
t£t_chunk
 == 0, "tset_initial_capacity‚ot‡nƒven multiple ofset_chunk");

28 
hash_ba£_
 = 32768;

29 
t£t_size_
 = 0;

30 
Ìng_¡©e_
 = 12897;

31 
i
 = 0; i !ğ
t£t_š™Ÿl_ÿ·c™y
 / 
t£t_chunk
; ++i)

32 
t£t_
[
i
] = &
t£t0_
[˜* 
t£t_chunk
];

33 
i
 = 
t£t_š™Ÿl_ÿ·c™y
 / 
t£t_chunk
; i !ğ
	`¬¿ysize
(
t£t_
); ++i)

34 
t£t_
[
i
] = 
nuÎ±r
;

35 
	}
}

37 
	gT¿n§ùiÚ
::~
	$T¿n§ùiÚ
() {

38 ià(
	`š_´og»ss
())

39 
	`s’t_abÜt
();

40 
T¿nsI‹m
* 
live
 = 
t£t0_
;

41 
i
 = 0; i !ğ
	`¬¿ysize
(
t£t_
); ++i, 
live
 +ğ
t£t_chunk
)

42 ià(
live
 !ğ
t£t_
[
i
])

43 
d–‘e
[] 
t£t_
[
i
];

44 
	}
}

46 
	gT¿n§ùiÚ
::
	$»äesh_t£t_chunk
() {

47 
	`as£¹
(
t£t_size_
 % 
t£t_chunk
 == 0);

48 
	`as£¹
(
t£t_size_
 < 
t£t_max_ÿ·c™y
);

49 ià(!
t£t_
[
t£t_size_
 / 
t£t_chunk
])

50 
t£t_
[
t£t_size_
 / 
t£t_chunk
] = 
Ãw
 
T¿nsI‹m
[tset_chunk];

51 
t£t_Ãxt_
 = 
t£t_
[
t£t_size_
 / 
t£t_chunk
];

52 
	}
}

54 * 
	gT¿n§ùiÚ
::
	$•och_advªûr
(*) {

55 
num_•och_advªûrs
 = 0;

56 ià(
	`ãtch_ªd_add
(&
num_•och_advªûrs
, 1) != 0)

57 
¡d
::
û¼
 << "WARNING: morehan oneƒpoch_advancerhread\n";

60 
	`u¦“p
(100000);

61 
glob®_•ochs
.
run
) {

62 
•och_ty³
 
g
 = 
glob®_•ochs
.
glob®_•och
;

63 
•och_ty³
 
e
 = 
g
;

64 auto& 
t
 : 
tšfo
) {

65 ià(
t
.
•och
 !ğ0 && 
	`sigÃd_•och_ty³
Ñ.•och - 
e
) < 0)

66 
e
 = 
t
.
•och
;

68 
glob®_•ochs
.
glob®_•och
 = 
¡d
::
	`max
(
g
 + 1, 
	`•och_ty³
(1));

69 
glob®_•ochs
.
aùive_•och
 = 
e
;

70 
glob®_•ochs
.
»ûÁ_tid
 = 
T¿n§ùiÚ
::
_TID
;

72 ià(
•och_advªû_ÿÎback
)

73 
	`•och_advªû_ÿÎback
(
glob®_•ochs
.
glob®_•och
);

75 
	`u¦“p
(100000);

77 
	`ãtch_ªd_add
(&
num_•och_advªûrs
, -1);

78  
NULL
;

79 
	}
}

81 
boŞ
 
	gT¿n§ùiÚ
::
	$´eûdšg_du¶iÿ‹_»ad
(
T¿nsI‹m
* 
ÃedË
) const {

82 cÚ¡ 
T¿nsI‹m
* 
™
 = 
nuÎ±r
;

83 
tidx
 = 0; ; ++tidx) {

84 
™
 = (
tidx
 % 
t£t_chunk
 ? iˆ+ 1 : 
t£t_
[tidx /set_chunk]);

85 ià(
™
 =ğ
ÃedË
)

86  
çl£
;

87 ià(
™
->
	`owÃr
(è=ğ
ÃedË
->owÃr(è&& it->
key_
 ==‚eedle->key_

88 && 
™
->
	`has_»ad
())

89  
Œue
;

91 
	}
}

93 
boŞ
 
	gT¿n§ùiÚ
::
	$h¬d_check_İac™y
(
T¿nsI‹m
* 
™em
, 
T¿n§ùiÚTid
::
ty³
 
t
) {

96 ià(
¡©e_
 =ğ
s_comm™tšg
 || s‹_ =ğ
s_comm™tšg_locked
)

97  
Œue
;

100 ià(
™em
 && i‹m->
	`has_»ad
(è&& i‹m->
»ad_v®ue
<
T¿n§ùiÚTid
::
ty³
>(è=ğ
t
)

101  
Œue
;

104 ià(
	`uÆik–y
(
¡©e_
 =ğ
s_İac™y_check
)) {

105 
	`m¬k_abÜt_beÿu£
(
™em
, "»cursivİac™y check", 
t
);

106 
abÜt
:

107 
	`TXP_INCREMENT
(
txp_hco_abÜt
);

109 
¡©e_
 = 
s_š_´og»ss
;

110  
çl£
;

112 
	`as£¹
(
¡©e_
 =ğ
s_š_´og»ss
);

114 
	`TXP_INCREMENT
(
txp_hco
);

115 ià(
T¿n§ùiÚTid
::
	`is_locked_–£wh”e
(
t
, 
th»adid_
)) {

116 
	`TXP_INCREMENT
(
txp_hco_lock
);

117 
	`m¬k_abÜt_beÿu£
(
™em
, "locked", 
t
);

118 
abÜt
;

120 ià(
t
 & 
T¿n§ùiÚTid
::
nÚİaque_b™
)

121 
	`TXP_INCREMENT
(
txp_hco_šv®id
);

123 
¡©e_
 = 
s_İac™y_check
;

124 
¡¬t_tid_
 = 
_TID
;

125 
	`»Ëa£_ãnû
();

126 
T¿nsI‹m
* 
™
 = 
nuÎ±r
;

127 
tidx
 = 0;idx !ğ
t£t_size_
; ++tidx) {

128 
™
 = (
tidx
 % 
t£t_chunk
 ? iˆ+ 1 : 
t£t_
[tidx /set_chunk]);

129 ià(
™
->
	`has_»ad
()) {

130 
	`TXP_INCREMENT
(
txp_tÙ®_check_»ad
);

131 ià(!
™
->
	`owÃr
()->
	`check
(*™, *
this
)

132 && (!
may_du¶iÿ‹_™ems_
 || !
	`´eûdšg_du¶iÿ‹_»ad
(
™
))) {

133 
	`m¬k_abÜt_beÿu£
(
™em
, "opacity check");

134 
abÜt
;

136 } ià(
™
->
	`has_´ediÿ‹
()) {

137 
	`TXP_INCREMENT
(
txp_tÙ®_check_´ediÿ‹
);

138 ià(!
™
->
	`owÃr
()->
	`check_´ediÿ‹
(*™, *
this
, 
çl£
)) {

139 
	`m¬k_abÜt_beÿu£
(
™em
, "opacity check_predicate");

140 
abÜt
;

144 
¡©e_
 = 
s_š_´og»ss
;

145  
Œue
;

146 
	}
}

148 
	gT¿n§ùiÚ
::
	$ÿÎCM¡¬t
() {

149 
CÚ‹ÁiÚMªag”
::
	`¡¬t
(
this
);

150 
	}
}

152 
	gT¿n§ùiÚ
::
	$¡İ
(
boŞ
 
comm™‹d
, * 
wr™e£t
, 
nwr™e£t
) {

153 #ià
STO_TSC_PROFILE


154 
TimeK“³r
<
tc_ş—nup
> 
tk
;

156 ià(!
comm™‹d
) {

157 
	`TXP_INCREMENT
(
txp_tÙ®_abÜts
);

158 #ià
STO_DEBUG_ABORTS


159 ià(
	`loÿl_¿ndom
(è<ğ
	`ušt32_t
(0xFFFFFFFF * 
STO_DEBUG_ABORTS_FRACTION
)) {

160 
¡d
::
o¡ršg¡»am
 
buf
;

161 
buf
 << "$" << (
th»adid_
 < 10 ? "0" : "") <<hreadid_;

163 ià(
abÜt_»asÚ_
)

164 
buf
 << " " << 
abÜt_»asÚ_
;

165 
buf
 << "£t_size_ = [" << 
t£t_size_
 << "]";

166 ià(
abÜt_™em_
)

167 
buf
 << " " << *
abÜt_™em_
;

168 ià(
abÜt_v”siÚ_
)

169 
buf
 << " V" << 
	`TV”siÚ
(
abÜt_v”siÚ_
);

170 
buf
 << '\n';

171 
¡d
::
û¼
 << 
buf
.
	`¡r
();

176 
	`TXP_ACCOUNT
(
txp_max_Œªsbufãr
, 
buf_
.
	`bufãr_size
());

177 
	`TXP_ACCOUNT
(
txp_tÙ®_Œªsbufãr
, 
buf_
.
	`bufãr_size
());

179 
T¿nsI‹m
* 
™
;

180 ià(!
ªy_wr™es_
)

181 
uÆock_®l
;

183 ià(
comm™‹d
 && !
STO_SORT_WRITESET
) {

195 * 
idx™
 = 
wr™e£t
 + 
nwr™e£t
; idxit != writeset; ) {

196 --
idx™
;

197 ià(*
idx™
 < 
t£t_š™Ÿl_ÿ·c™y
)

198 
™
 = &
t£t0_
[*
idx™
];

200 
™
 = &
t£t_
[*
idx™
 / 
t£t_chunk
][*idxit %set_chunk];

201 ià(
™
->
	`has_wr™e
())

202 
™
->
	`owÃr
()->
	`ş—nup
(*™, 
comm™‹d
);

219 
™
 = &
t£t_
[
t£t_size_
 / 
t£t_chunk
][tset_size_ %set_chunk];

220 
tidx
 = 
t£t_size_
;idx !ğ
fœ¡_wr™e_
; --tidx) {

221 
™
 = (
tidx
 % 
t£t_chunk
 ? iˆ- 1 : &
t£t_
[(tidx - 1) /set_chunk][tset_chunk - 1]);

222 ià(
™
->
	`has_wr™e
())

223 
™
->
	`owÃr
()->
	`ş—nup
(*™, 
comm™‹d
);

227 
uÆock_®l
:

228 
™
 = &
t£t_
[
t£t_size_
 / 
t£t_chunk
][tset_size_ %set_chunk];

229 
tidx
 = 
t£t_size_
;idx != 0; --tidx) {

230 
™
 = (
tidx
 % 
t£t_chunk
 ? iˆ- 1 : &
t£t_
[(tidx - 1) /set_chunk][tset_chunk - 1]);

231 ià(
™
->
	`Ãeds_uÆock
())

232 
™
->
	`owÃr
()->
	`uÆock
(*it);

236 
th»adšfo_t
& 
thr
 = 
tšfo
[
TTh»ad
::
	`id
()];

237 ià(
thr
.
Œªs_’d_ÿÎback
)

238 
thr
.
	`Œªs_’d_ÿÎback
();

240 
¡©e_
 = 
s_abÜ‹d
 + 
comm™‹d
;

241 
»¡¬‹d
 = 
Œue
;

244 ià(!
comm™‹d
) {

245 
CÚ‹ÁiÚMªag”
::
	`Ú_rŞlback
(
TTh»ad
::
	`id
());

249 
sü©ch_
.
	`ş—r
();

251 #ià
STO_TSC_PROFILE


252 autØ
’dtime
 = 
	`»ad_tsc
();

253 ià(!
comm™‹d
)

254 
	`TSC_ACCOUNT
(
tc_abÜt
, 
’dtime
 - 
¡¬t_tsc_
);

258 
	}
}

260 
boŞ
 
	gT¿n§ùiÚ
::
	$Œy_comm™
() {

261 #ià
STO_TSC_PROFILE


262 
TimeK“³r
<
tc_comm™
> 
tk
;

264 
	`as£¹
(
TTh»ad
::
	`id
(è=ğ
th»adid_
);

265 #ià
ASSERT_TX_SIZE


266 ià(
t£t_size_
 > 
TX_SIZE_LIMIT
) {

267 
¡d
::
û¼
 << "ŒªsS‘_ siz© " << 
t£t_size_


268 << ",‡bÜt." << 
¡d
::
’dl
;

269 
	`as£¹
(
çl£
);

272 
	`TXP_ACCOUNT
(
txp_max_£t
, 
t£t_size_
);

273 
	`TXP_ACCOUNT
(
txp_tÙ®_n
, 
t£t_size_
);

275 
	`as£¹
(
¡©e_
 =ğ
s_š_´og»ss
 || s‹_ >ğ
s_abÜ‹d
);

276 ià(
¡©e_
 >ğ
s_abÜ‹d
) {

277  
¡©e_
 > 
s_abÜ‹d
;

280 ià(
ªy_nÚİaque_
)

281 
	`TXP_INCREMENT
(
txp_comm™_time_nÚİaque
);

282 #ià!
CONSISTENCY_CHECK


284 ià(!
ªy_wr™es_
 && !
ªy_nÚİaque_
) {

285 
	`¡İ
(
Œue
, 
nuÎ±r
, 0);

286  
Œue
;

290 
¡©e_
 = 
s_comm™tšg
;

292 
wr™e£t
[
t£t_size_
];

293 
nwr™e£t
 = 0;

294 
wr™e£t
[0] = 
t£t_size_
;

296 
T¿nsI‹m
* 
™
 = 
nuÎ±r
;

297 
tidx
 = 0;idx !ğ
t£t_size_
; ++tidx) {

298 
™
 = (
tidx
 % 
t£t_chunk
 ? iˆ+ 1 : 
t£t_
[tidx /set_chunk]);

299 ià(
™
->
	`has_wr™e
()) {

300 
wr™e£t
[
nwr™e£t
++] = 
tidx
;

301 #ià!
STO_SORT_WRITESET


302 ià(
nwr™e£t
 == 1) {

303 
fœ¡_wr™e_
 = 
wr™e£t
[0];

304 
¡©e_
 = 
s_comm™tšg_locked
;

306 ià(!
™
->
	`Ãeds_uÆock
(è&& !™->
	`owÃr
()->
	`lock
(*™, *
this
)) {

307 
	`m¬k_abÜt_beÿu£
(
™
, "commit†ock");

308 
abÜt
;

310 
™
->
	`__Ü_æags
(
T¿nsI‹m
::
lock_b™
);

311 
™
->
	`__Ü_æags
(
T¿nsI‹m
::
ş_b™
);

314 ià(
™
->
	`has_»ad
()) {

315 
	`TXP_INCREMENT
(
txp_tÙ®_r
);

316 ià(
™
->
	`cc_mode
(è=ğ
CCMode
::
İt
) {

317 
	`TXP_INCREMENT
(
txp_tÙ®_ad­tive_İt
);

320 ià(
™
->
	`cc_mode
(è=ğ
CCMode
::
tiùoc
) {

321 ià(
™
->
	`is_tiùoc_com´es£d
())

322 
™
->
tiùoc_exŒaù_»ad_ts
<
TicTocCom´es£dV”siÚ
<>>().
	`compu‹_comm™_ts_¡•
(
this
->
tiùoc_tid_
, 
çl£
 );

324 
™
->
tiùoc_exŒaù_»ad_ts
<
TicTocV”siÚ
<>>().
	`compu‹_comm™_ts_¡•
(
this
->
tiùoc_tid_
, 
çl£
 );

326 } ià(
™
->
	`has_´ediÿ‹
()) {

327 
	`TXP_INCREMENT
(
txp_tÙ®_check_´ediÿ‹
);

328 ià(!
™
->
	`owÃr
()->
	`check_´ediÿ‹
(*™, *
this
, 
Œue
)) {

329 
	`m¬k_abÜt_beÿu£
(
™
, "commit check_predicate");

330 
abÜt
;

335 
fœ¡_wr™e_
 = 
wr™e£t
[0];

338 #ià
STO_SORT_WRITESET


339 
¡d
::
	`sÜt
(
wr™e£t
, wr™e£ˆ+ 
nwr™e£t
, [&] (
i
, 
j
) {

340 
T¿nsI‹m
* 
ti
 = &
t£t_
[
i
 / 
t£t_chunk
][i %set_chunk];

341 
T¿nsI‹m
* 
tj
 = &
t£t_
[
j
 / 
t£t_chunk
][j %set_chunk];

342  *
ti
 < *
tj
;

345 ià(
nwr™e£t
) {

346 
¡©e_
 = 
s_comm™tšg_locked
;

347 autØ
wr™e£t_’d
 = 
wr™e£t
 + 
nwr™e£t
;

348 autØ
™
 = 
wr™e£t
; iˆ!ğ
wr™e£t_’d
; ) {

349 
T¿nsI‹m
* 
me
 = &
t£t_
[*
™
 / 
t£t_chunk
][*it %set_chunk];

350 ià(!
me
->
	`owÃr
()->
	`lock
(*me, *
this
)) {

351 
	`m¬k_abÜt_beÿu£
(
me
, "commit†ock");

352 
abÜt
;

354 
me
->
	`__Ü_æags
(
T¿nsI‹m
::
lock_b™
);

355 ++
™
;

360 #ià
CONSISTENCY_CHECK


361 
	`ãnû
();

362 
	`comm™_tid
();

363 
	`ãnû
();

367 
tidx
 = 0;idx !ğ
t£t_size_
; ++tidx) {

368 
™
 = (
tidx
 % 
t£t_chunk
 ? iˆ+ 1 : 
t£t_
[tidx /set_chunk]);

369 ià(
™
->
	`has_»ad
(è&& (™->
	`locked_©_comm™
(è|| !™->
	`Ãeds_uÆock
())) {

370 
	`TXP_INCREMENT
(
txp_tÙ®_check_»ad
);

371 ià(!
™
->
	`owÃr
()->
	`check
(*™, *
this
)

372 && (!
may_du¶iÿ‹_™ems_
 || !
	`´eûdšg_du¶iÿ‹_»ad
(
™
))) {

373 
	`m¬k_abÜt_beÿu£
(
™
, "commit check");

374 
abÜt
;

382 #ià
STO_SORT_WRITESET


383 
tidx
 = 
fœ¡_wr™e_
;idx !ğ
t£t_size_
; ++tidx) {

384 
™
 = &
t£t_
[
tidx
 / 
t£t_chunk
][tidx %set_chunk];

385 ià(
™
->
	`has_wr™e
()) {

386 
	`TXP_INCREMENT
(
txp_tÙ®_w
);

387 
™
->
	`owÃr
()->
	`š¡®l
(*™, *
this
);

391 ià(
nwr™e£t
) {

392 autØ
wr™e£t_’d
 = 
wr™e£t
 + 
nwr™e£t
;

393 autØ
idx™
 = 
wr™e£t
; idx™ !ğ
wr™e£t_’d
; ++idxit) {

394 ià(
	`lik–y
(*
idx™
 < 
t£t_š™Ÿl_ÿ·c™y
))

395 
™
 = &
t£t0_
[*
idx™
];

397 
™
 = &
t£t_
[*
idx™
 / 
t£t_chunk
][*idxit %set_chunk];

398 
	`TXP_INCREMENT
(
txp_tÙ®_w
);

399 
™
->
	`owÃr
()->
	`š¡®l
(*™, *
this
);

405 
	`¡İ
(
Œue
, 
wr™e£t
, 
nwr™e£t
);

408  
Œue
;

410 
abÜt
:

413 
	`TXP_INCREMENT
(
txp_comm™_time_abÜts
);

416 
	`¡İ
(
çl£
, 
nuÎ±r
, 0);

417 #ià
STO_TSC_PROFILE


418 autØ
’dtime
 = 
	`»ad_tsc
();

419 
	`TSC_ACCOUNT
(
tc_comm™_wa¡ed
, 
’dtime
 - 
tk
.
	`š™_tsc_v®
());

421  
çl£
;

422 
	}
}

424 
	gT¿n§ùiÚ
::
	$´št_¡©s
() {

425 
txp_couÁ”s
 
out
 = 
	`txp_couÁ”s_combšed
();

426 ià(
txp_couÁ
 >ğ
txp_max_£t
) {

427 
txc_tÙ®_¡¬ts
 = 
out
.
	`p
(
txp_tÙ®_¡¬ts
);

428 
txc_tÙ®_abÜts
 = 
out
.
	`p
(
txp_tÙ®_abÜts
);

429 
txc_comm™_abÜts
 = 
out
.
	`p
(
txp_comm™_time_abÜts
);

430 
txc_tÙ®_comm™s
 = 
txc_tÙ®_¡¬ts
 - 
txc_tÙ®_abÜts
;

431 
	`årštf
(
¡d”r
, "$ %llu starts, %llu max„ead set, %llu commits",

432 
txc_tÙ®_¡¬ts
, 
out
.
	`p
(
txp_max_£t
), 
txc_tÙ®_comm™s
);

433 ià(
txc_tÙ®_abÜts
) {

434 
	`årštf
(
¡d”r
, ", %llu (%.3f%%)‡borts",

435 
out
.
	`p
(
txp_tÙ®_abÜts
),

436 100.0 * (è
out
.
	`p
(
txp_tÙ®_abÜts
è/ out.p(
txp_tÙ®_¡¬ts
));

437 ià(
out
.
	`p
(
txp_comm™_time_abÜts
)) {

438 
	`årštf
(
¡d”r
, "\n$ %llu (%.3f%%) of‡borts‡t commitime",

439 
out
.
	`p
(
txp_comm™_time_abÜts
),

440 100.0 * (è
out
.
	`p
(
txp_comm™_time_abÜts
è/ out.p(
txp_tÙ®_abÜts
));

443 ià(
out
.
	`p
(
txp_lock_abÜts
)) {

444 
	`årštf
(
¡d”r
, "\n$ %llu (%.3f%%) of‡borts dueo†ockime-outs",

445 
out
.
	`p
(
txp_lock_abÜts
),

446 100.0 * (è
out
.
	`p
(
txp_lock_abÜts
è/ out.p(
txp_tÙ®_abÜts
));

449 ià(
out
.
	`p
(
txp_ob£rve_lock_abÜts
)) {

450 
	`årštf
(
¡d”r
, "\n$ %llu (%.3f%%) of‡borts dueo observing write-locked versions",

451 
out
.
	`p
(
txp_ob£rve_lock_abÜts
),

452 100.0 * (è
out
.
	`p
(
txp_ob£rve_lock_abÜts
è/ out.p(
txp_tÙ®_abÜts
));

455 
txc_comm™_©‹m±s
 = 
txc_tÙ®_¡¬ts
 - (
txc_tÙ®_abÜts
 - 
txc_comm™_abÜts
);

456 
	`årštf
(
¡d”r
, "\n$ %llu commit‡ttempts, %llu (%.3f%%)‚onopaque\n",

457 
txc_comm™_©‹m±s
, 
out
.
	`p
(
txp_comm™_time_nÚİaque
),

458 100.0 * (è
out
.
	`p
(
txp_comm™_time_nÚİaque
è/ 
txc_comm™_©‹m±s
);

460 ià(
txp_couÁ
 >ğ
txp_hco_abÜt
)

461 
	`årštf
(
¡d”r
, "$ %llu HCO (%llu†ock, %llu invalid, %llu‡borts) out of %llu check‡ttempts (%.3f%%)\n",

462 
out
.
	`p
(
txp_hco
), out.p(
txp_hco_lock
), out.p(
txp_hco_šv®id
), out.p(
txp_hco_abÜt
), out.p(
txp_tco
),

463 100.0 * (è
out
.
	`p
(
txp_hco
è/ out.p(
txp_tco
));

464 ià(
txp_couÁ
 >ğ
txp_hash_cŞlisiÚ
)

465 
	`årštf
(
¡d”r
, "$ %Îu (%.3f%%èhash cŞlisiÚs, %Îu secÚd†ev–\n", 
out
.
	`p
(
txp_hash_cŞlisiÚ
),

466 100.0 * (è
out
.
	`p
(
txp_hash_cŞlisiÚ
è/ out.p(
txp_hash_fšd
),

467 
out
.
	`p
(
txp_hash_cŞlisiÚ2
));

468 ià(
txp_couÁ
 >ğ
txp_tÙ®_Œªsbufãr
)

469 
	`årštf
(
¡d”r
, "$ %llu max buffer…erxn, %lluotal buffer\n",

470 
out
.
	`p
(
txp_max_Œªsbufãr
), out.p(
txp_tÙ®_Œªsbufãr
));

471 
	`årštf
(
¡d”r
, "$ %Îu‚exˆcomm™-tid\n", (è
_TID
);

473 #ià
STO_TSC_PROFILE


474 
tc_couÁ”s
 
out_tcs
 = 
	`tc_couÁ”s_combšed
();

475 
¡d
::
¡ršg¡»am
 
ss
;

476 
ss
 << 
¡d
::
’dl
 << "$ Timing breakdown: " << std::endl;

477 
ss
 << "ime_comm™: " << 
out_tcs
.
	`to_»®time
(
tc_comm™
è<< 
¡d
::
’dl
;

478 
ss
 << "ime_comm™_wa¡ed: " << 
out_tcs
.
	`to_»®time
(
tc_comm™_wa¡ed
è<< 
¡d
::
’dl
;

479 
ss
 << "ime_fšd_™em: " << 
out_tcs
.
	`to_»®time
(
tc_fšd_™em
è<< 
¡d
::
’dl
;

480 
ss
 << "ime_abÜt: " << 
out_tcs
.
	`to_»®time
(
tc_abÜt
è<< 
¡d
::
’dl
;

481 
ss
 << "ime_ş—nup: " << 
out_tcs
.
	`to_»®time
(
tc_ş—nup
è<< 
¡d
::
’dl
;

482 
ss
 << "ime_İac™y: " << 
out_tcs
.
	`to_»®time
(
tc_İac™y
è<< 
¡d
::
’dl
;

484 
	`årštf
(
¡d”r
, "%s\n", 
ss
.
	`¡r
().
	`c_¡r
());

486 
	}
}

488 cÚ¡ * 
	gT¿n§ùiÚ
::
	$¡©e_Çme
(
¡©e
) {

489 cÚ¡ * 
Çmes
[] = {"in-progress", "opacity-check", "committing", "committing-locked", "aborted", "committed"};

490 ià((
¡©e
è< 
	`¬¿ysize
(
Çmes
))

491  
Çmes
[
¡©e
];

494 
	}
}

496 
	gT¿n§ùiÚ
::
	$´št
(
¡d
::
o¡»am
& 
w
) const {

497 
w
 << "T0x" << (*è
this
 << " " << 
	`¡©e_Çme
(
¡©e_
) << " [";

498 cÚ¡ 
T¿nsI‹m
* 
™
 = 
nuÎ±r
;

499 
tidx
 = 0;idx !ğ
t£t_size_
; ++tidx) {

500 
™
 = (
tidx
 % 
t£t_chunk
 ? iˆ+ 1 : 
t£t_
[tidx /set_chunk]);

501 ià(
tidx
)

502 
w
 << " ";

503 
™
->
	`owÃr
()->
	`´št
(
w
, *it);

505 
w
 << "]\n";

506 
	}
}

508 
	gT¿n§ùiÚ
::
	$´št
() const {

509 
	`´št
(
¡d
::
û¼
);

510 
	}
}

512 
	gTObjeù
::
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
) const {

513 
w
 << "{" << 
	`ty³id
(*
this
).
	`Çme
(è<< " " << (*èthi << "." << 
™em
.
key
<*>();

514 ià(
™em
.
	`has_»ad
())

515 
w
 << " R" << 
™em
.
»ad_v®ue
<*>();

516 ià(
™em
.
	`has_wr™e
())

517 
w
 << " =" << 
™em
.
wr™e_v®ue
<*>();

518 ià(
™em
.
	`has_´ediÿ‹
())

519 
w
 << " P" << 
™em
.
´ediÿ‹_v®ue
<*>();

520 
w
 << "}";

521 
	}
}

523 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	gT¿n§ùiÚ
& 
	gtxn
) {

524 
	gtxn
.
´št
(
w
);

525  
	gw
;

528 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	gTe¡T¿n§ùiÚ
& 
	gtxn
) {

529 
	gtxn
.
´št
(
w
);

530  
	gw
;

533 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	gT¿n§ùiÚGu¬d
& 
	gtxn
) {

534 
	gtxn
.
´št
(
w
);

535  
	gw
;

	@sto-core/Transaction.hh

1 #´agm¨
Úû


3 
	~"cÚfig.h
"

4 
	~"comp”.hh
"

5 
	~"sm®l_veùÜ.hh
"

6 
	~"TRcu.hh
"

7 
	~"CÚ‹ÁiÚMªag”.hh
"

8 
	~"T¿nsSü©ch.hh
"

9 
	~"V”siÚBa£.hh
"

10 
	~<®gÜ™hm
>

11 
	~<funùiÚ®
>

12 
	~<memÜy
>

13 
	~<ty³_Œa™s
>

14 
	~<uni¡d.h
>

15 
	~<io¡»am
>

16 
	~<s¡»am
>

17 
	~<f¡»am
>

21 #iâdeà
STO_PROFILE_COUNTERS


22 
	#STO_PROFILE_COUNTERS
 0

	)

24 #iâdeà
STO_TSC_PROFILE


25 
	#STO_TSC_PROFILE
 0

	)

28 #iâdeà
BILLION


29 
	#BILLION
 1000000000.0

	)

34 #iâdeà
PROC_TSC_FREQ


35 
	#PROC_TSC_FREQ
 2.2

37 

	)

38 #iâdeà
STO_DEBUG_HASH_COLLISIONS


39 
	#STO_DEBUG_HASH_COLLISIONS
 0

	)

41 #iâdeà
STO_DEBUG_HASH_COLLISIONS_FRACTION


42 
	#STO_DEBUG_HASH_COLLISIONS_FRACTION
 0.00001

	)

45 #iâdeà
STO_DEBUG_ABORTS


46 
	#STO_DEBUG_ABORTS
 0

	)

48 #iâdeà
STO_DEBUG_ABORTS_FRACTION


49 
	#STO_DEBUG_ABORTS_FRACTION
 1

	)

52 #iâdeà
STO_SORT_WRITESET


53 
	#STO_SORT_WRITESET
 0

	)

56 #iâdeà
DEBUG_SKEW


57 
	#DEBUG_SKEW
 0

	)

60 #iâdeà
CHECK_PROGRESS


61 
	#CHECK_PROGRESS
 0

	)

64 #iâdeà
STO_SPIN_EXPBACKOFF


65 
	#STO_SPIN_EXPBACKOFF
 0

	)

68 #iâdeà
STO_ABORT_ON_LOCKED


69 
	#STO_ABORT_ON_LOCKED
 1

	)

72 #iâdeà
STO_SPIN_BOUND_WRITE


73 #ià
STO_SPIN_EXPBACKOFF


74 
	#STO_SPIN_BOUND_WRITE
 7

	)

76 
	#STO_SPIN_BOUND_WRITE
 3

	)

80 #iâdeà
STO_SPIN_BOUND_WAIT


81 #ià
STO_SPIN_EXPBACKOFF


82 
	#STO_SPIN_BOUND_WAIT
 18

	)

84 
	#STO_SPIN_BOUND_WAIT
 20

	)

88 
	#CONSISTENCY_CHECK
 0

	)

89 
	#ASSERT_TX_SIZE
 0

	)

90 
	#TRANSACTION_HASHTABLE
 1

	)

93 #ià
ASSERT_TX_SIZE


94 #ià
STO_PROFILE_COUNTERS
 > 1

95 
	#TX_SIZE_LIMIT
 20000

	)

96 
	~<ÿs£¹
>

102 
	~"cÚfig.h
"

104 
	#MAX_THREADS
 128

	)

107 
	#TRANSACTION
 \

109 
__Ïb–__
 
abÜt_š_´og»ss
; \

110 
__Ïb–__
 
Œy_comm™
; \

111 
__Ïb–__
 
aá”_comm™
; \

112 
T¿n§ùiÚLoİGu¬d
 
__txn_gu¬d
; \

114 
__txn_gu¬d
.
	`¡¬t
();

	)

116 
	#RETRY
(
»Œy
) \

117 
Œy_comm™
; \

118 
abÜt_š_´og»ss
: \

119 
__txn_gu¬d
.
	`s’t_abÜt
(); \

120 
aá”_comm™
; \

121 
Œy_comm™
: \

122 ià(
__txn_gu¬d
.
	`Œy_comm™
()) \

124 
aá”_comm™
: \

125 ià(!(
»Œy
)) { \

129 } 
çl£
)

	)

131 
	#TXN_DO
(
Œªs_İ
) \

132 ià(!(
Œªs_İ
)) \

133 
abÜt_š_´og»ss


	)

136 
	#TRANSACTION_E
 \

138 
T¿n§ùiÚLoİGu¬d
 
__txn_gu¬d
; \

140 
__txn_gu¬d
.
	`¡¬t
(); \

141 
Œy
 {

	)

143 
	#RETRY_E
(
»Œy
) \

144 ià(
__txn_gu¬d
.
	`Œy_comm™
()) \

146 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) { \

147 
__txn_gu¬d
.
	`s’t_abÜt
(); \

149 ià(!(
»Œy
)) \

150 
throw
 
T¿n§ùiÚ
::
	`AbÜt
(); \

152 } 
çl£
)

	)

155 
	etxp
 {

157 
	mtxp_tÙ®_abÜts
 = 0,

158 
	mtxp_tÙ®_¡¬ts
,

159 
	mtxp_comm™_time_nÚİaque
,

160 
	mtxp_comm™_time_abÜts
,

161 
	mtxp_ob£rve_lock_abÜts
,

162 
	mtxp_lock_abÜts
,

163 
	mtxp_abÜ‹d_by_Ùh”s
,

164 
	mtxp_max_£t
,

165 
	mtxp_csws
,

166 
	mtxp_cm_shouldabÜt
,

167 
	mtxp_cm_ÚrŞlback
,

168 
	mtxp_cm_Úwr™e
,

169 
	mtxp_cm_¡¬t
,

170 
	mtxp_®loÿ‹
,

171 
	mtxp_bv_h™
,

172 
	mtxp_tco
,

173 
	mtxp_hco
,

174 
	mtxp_hco_lock
,

175 
	mtxp_hco_šv®id
,

176 
	mtxp_hco_abÜt
,

178 
	mtxp_tÙ®_n
,

179 
	mtxp_tÙ®_r
,

180 
	mtxp_tÙ®_ad­tive_İt
,

181 
	mtxp_tÙ®_w
,

182 
	mtxp_max_Œªsbufãr
,

183 
	mtxp_tÙ®_Œªsbufãr
,

184 
	mtxp_push_abÜt
,

185 
	mtxp_pİ_abÜt
,

186 
	mtxp_tÙ®_check_»ad
,

187 
	mtxp_tÙ®_check_´ediÿ‹
,

188 
	mtxp_hash_fšd
,

189 
	mtxp_hash_cŞlisiÚ
,

190 
	mtxp_hash_cŞlisiÚ2
,

191 
	mtxp_tÙ®_£¬ched
,

192 #ià!
STO_PROFILE_COUNTERS


193 
	mtxp_couÁ
 = 0

194 #–ià
STO_PROFILE_COUNTERS
 == 1

195 
txp_couÁ
 = 
txp_hco_abÜt
 + 1

197 
txp_couÁ


200 
ušt64_t
 
	ttxp_couÁ”_ty³
;

202 
šlše
 
cÚ¡ex´
 
boŞ
 
	$txp_is_max
(
p
) {

203  
p
 =ğ
txp_max_£t
 ||… =ğ
txp_max_Œªsbufãr
;

204 
	}
}

206 
	g‹m¶©e
 <
	gP
, 
	gN
, 
boŞ
 
	gLess
 = (
P
 < 
N
)> 
txp_h–³r
;

207 
	g‹m¶©e
 <
	gP
, 
	gN
> 
	gtxp_h–³r
<P, N, 
	gŒue
> {

208 
boŞ
 
couÁ”_exi¡s
(
p
) {

209  
	gp
 < 
	gN
;

211 
accouÁ_¬¿y
(
txp_couÁ”_ty³
* 
p
,xp_couÁ”_ty³ 
v
) {

212 ià(
txp_is_max
(
P
))

213 
	gp
[
P
] = 
¡d
::
max
(
p
[P], 
v
);

215 
	gp
[
P
] +ğ
v
;

218 
	g‹m¶©e
 <
	gP
, 
	gN
> 
	gtxp_h–³r
<P, N, 
	gçl£
> {

219 
boŞ
 
couÁ”_exi¡s
() {

220  
	gçl£
;

222 
accouÁ_¬¿y
(
txp_couÁ”_ty³
*,xp_counter_type) {

226 
	stxp_couÁ”s
 {

227 
txp_couÁ”_ty³
 
	mp_
[
txp_couÁ
];

228 
txp_couÁ”s
() {

229 
	mi
 = 0; i !ğ
txp_couÁ
; ++i)

230 
	mp_
[
i
] = 0;

232 
p
(p) {

233  
	mtxp_h–³r
<0, 
	mtxp_couÁ
>::
couÁ”_exi¡s
(
p
è? 
p_
[p] : 0;

235 
»£t
() {

236 
	mi
 = 0; i !ğ
txp_couÁ
; ++i)

237 
	mp_
[
i
] = 0;

242 
	eTimšgCouÁ”s
 {

243 
	mtc_comm™
 = 0,

244 
	mtc_comm™_wa¡ed
,

245 
	mtc_fšd_™em
,

246 
	mtc_abÜt
,

247 
	mtc_ş—nup
,

248 
	mtc_İac™y
,

249 
	mtc_couÁ


252 
ušt64_t
 
	ttc_couÁ”_ty³
;

254 
	g‹m¶©e
 <
	gC
, 
	gN
, 
boŞ
 
	gLess
 = (
C
 < 
N
)>

255 
tc_h–³r
;

257 
	g‹m¶©e
 <
	gC
, 
	gN
>

258 
	gtc_h–³r
<
	gC
, 
	gN
, 
	gŒue
> {

259 
boŞ
 
couÁ”_exi¡s
(
tc
) {

260  
	gtc
 < 
	gN
;

262 
accouÁ_¬¿y
(
tc_couÁ”_ty³
 *
tcs
,c_couÁ”_ty³ 
v
) {

263 
	gtcs
[
C
] +ğ
v
;

267 
	g‹m¶©e
 <
	gC
, 
	gN
>

268 
	gtc_h–³r
<
	gC
, 
	gN
, 
	gçl£
> {

269 
boŞ
 
couÁ”_exi¡s
(è{  
	gçl£
; }

270 
accouÁ_¬¿y
(
tc_couÁ”_ty³
*,c_counter_type) {}

273 
	stc_couÁ”s
 {

274 
tc_couÁ”_ty³
 
	mtcs_
[
tc_couÁ
];

275 
tc_couÁ”s
(è{ 
»£t
(); }

276 
tc_couÁ”_ty³
 
timšg_couÁ”
(
Çme
) {

277  
	mtc_h–³r
<0, 
	mtc_couÁ
>::
couÁ”_exi¡s
(
Çme
è? 
tcs_
[name] : 0;

279 
to_»®time
(
Çme
) {

280  ()
timšg_couÁ”
(
Çme
è/ 
	mBILLION
 / 
	mPROC_TSC_FREQ
;

282 
»£t
() {

283 
	mi
 = 0; i < 
	mtc_couÁ
; ++i)

284 
	mtcs_
[
i
] = 0;

288 
	~"IÁ”çû.hh
"

289 
	~"T¿nsI‹m.hh
"

291 
»pÜtP”f
();

292 
	#STO_SHUTDOWN
(è
	`»pÜtP”f
()

	)

294 
__©Œibu‹__
((
	$®igÃd
(128))è
th»adšfo_t
 {

295 
usšg
 
•och_ty³
 = 
TRcuS‘
::epoch_type;

296 
•och_ty³
 
•och
;

297 
TRcuS‘
 
rcu_£t
;

300 
¡d
::
funùiÚ
<()> 
Œªs_¡¬t_ÿÎback
;

301 
¡d
::
funùiÚ
<()> 
Œªs_’d_ÿÎback
;

302 
txp_couÁ”s
 
p_
;

303 
tc_couÁ”s
 
tcs_
;

304 
	`th»adšfo_t
()

305 : 
	`•och
(0) {

307 
	}
};

309 
	g‹m¶©e
 <
	gT
, 
boŞ
 
	gtmp_¡©s
=
çl£
>

310 şas 
	cTimeK“³r
 {

311 
public
:

312 
	$TimeK“³r
() {

313 
š™_tsc
 = 
	`»ad_tsc
();

315 ~
	$TimeK“³r
() {

316 ià(
tmp_¡©s
)

317 
	`sync_th»ad_couÁ”_tmp
();

319 
	`sync_th»ad_couÁ”
();

320 
	}
}

322 
tc_couÁ”_ty³
 
	$š™_tsc_v®
() const {

323  
š™_tsc
;

324 
	}
}

326 
	g´iv©e
:

327 
tc_couÁ”_ty³
 
š™_tsc
;

329 
šlše
 
sync_th»ad_couÁ”
();

330 
šlše
 
sync_th»ad_couÁ”_tmp
();

333 
	#TSC_ACCOUNT
(
tc
, 
ticks
) \

334 
tc_h–³r
<
tc
, 
tc_couÁ
>::
	`accouÁ_¬¿y
( \

335 
T¿n§ùiÚ
::
tšfo
[
TTh»ad
::
	`id
()].
tcs_
.tcs_, \

336 
ticks
)

	)

338 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

339 
şass
 
	gTicTocBa£
;

341 şas 
	cT¿n§ùiÚ
 {

342 
	mpublic
:

343 
cÚ¡ex´
 
t£t_š™Ÿl_ÿ·c™y
 = 512;

345 
cÚ¡ex´
 
	mhash_size
 = 32768;

346 
cÚ¡ex´
 
	mhash_¡•
 = 5;

347 
usšg
 
	m•och_ty³
 = 
TRcuS‘
::
•och_ty³
;

348 
usšg
 
	msigÃd_•och_ty³
 = 
TRcuS‘
::
sigÃd_•och_ty³
;

350 
th»adšfo_t
 
	mtšfo
[
MAX_THREADS
];

351 
	s•och_¡©e
 {

352 
•och_ty³
 
	mglob®_•och
;

353 
•och_ty³
 
	maùive_•och
;

354 
	mT¿n§ùiÚTid
::
ty³
 
»ûÁ_tid
;

355 
boŞ
 
	mrun
;

356 } 
	gglob®_•ochs
;

357 
	gT¿n§ùiÚTid
::
	tty³
 
	ttid_ty³
;

358 
	g´iv©e
:

359 
T¿n§ùiÚTid
::
ty³
 
_TID
;

360 
	gpublic
:

362 
¡d
::
funùiÚ
<(
th»adšfo_t
::
•och_ty³
)> 
•och_advªû_ÿÎback
;

364 
txp_couÁ”s
 
	$txp_couÁ”s_combšed
() {

365 
txp_couÁ”s
 
out
;

366 
i
 = 0; i !ğ
MAX_THREADS
; ++i)

367 
p
 = 0;… !ğ
txp_couÁ
; ++p) {

368 ià(
	`txp_is_max
(
p
))

369 
out
.
p_
[
p
] = 
¡d
::
	`max
(out.p_[p], 
tšfo
[
i
].p_.p_[p]);

371 
out
.
p_
[
p
] +ğ
tšfo
[
i
].p_.p_[p];

373  
out
;

374 
	}
}

376 
tc_couÁ”s
 
	$tc_couÁ”s_combšed
() {

377 
tc_couÁ”s
 
»t
;

378 
i
 = 0; i < 
MAX_THREADS
; ++i) {

379 
t
 = 0; < 
tc_couÁ
; ++t) {

380 
»t
.
tcs_
[
t
] +ğ
tšfo
[
i
].tcs_.tcs_[t];

383  
»t
;

384 
	}
}

386 
´št_¡©s
();

388 
	$ş—r_¡©s
() {

389 
i
 = 0; i !ğ
MAX_THREADS
; ++i) {

390 
tšfo
[
i
].
p_
.
	`»£t
();

391 
tšfo
[
i
].
tcs_
.
	`»£t
();

393 
	}
}

395 * 
•och_advªûr
(*);

396 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

397 
	$rcu_d–‘e
(
T
* 
x
) {

398 auto& 
thr
 = 
tšfo
[
TTh»ad
::
	`id
()];

399 
thr
.
rcu_£t
.
	`add
Ñhr.
•och
, 
ObjeùDe¡roy”
<
T
>::
de¡roy_ªd_ä“
, 
x
);

400 
	}
}

401 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

402 
	$rcu_d–‘e_¬¿y
(
T
* 
x
) {

403 auto& 
thr
 = 
tšfo
[
TTh»ad
::
	`id
()];

404 
thr
.
rcu_£t
.
	`add
Ñhr.
•och
, 
ObjeùDe¡roy”
<
T
>::
de¡roy_ªd_ä“_¬¿y
, 
x
);

405 
	}
}

406 
	$rcu_ä“
(* 
±r
) {

407 auto& 
thr
 = 
tšfo
[
TTh»ad
::
	`id
()];

408 
thr
.
rcu_£t
.
	`add
Ñhr.
•och
, ::
ä“
, 
±r
);

409 
	}
}

410 
	$rcu_ÿÎ
((*
funùiÚ
)(*), * 
¬gum’t
) {

411 auto& 
thr
 = 
tšfo
[
TTh»ad
::
	`id
()];

412 
thr
.
rcu_£t
.
	`add
Ñhr.
•och
, 
funùiÚ
, 
¬gum’t
);

413 
	}
}

414 
	$rcu_qu›sû
() {

415 
tšfo
[
TTh»ad
::
	`id
()].
•och
 = 0;

416 
	}
}

418 #ià
STO_PROFILE_COUNTERS


419 
	g‹m¶©e
 <
	gP
> 
	$txp_accouÁ
(
txp_couÁ”_ty³
 
n
) {

420 
txp_h–³r
<
P
, 
txp_couÁ
>::
	`accouÁ_¬¿y
(
tšfo
[
TTh»ad
::
	`id
()].
p_
.p_, 
n
);

421 
	}
}

422 
	g‹m¶©e
 <
	gP
> 
txp_couÁ”_ty³
 
	$txp_š¥eù
() {

423  
tšfo
[
TTh»ad
::
	`id
()].
p_
.
	`p
(
P
);

424 
	}
}

426 
	g‹m¶©e
 <
	gP
> 
	$txp_accouÁ
(
txp_couÁ”_ty³
) {

427 
	}
}

428 
	g‹m¶©e
 <
	gP
> 
txp_couÁ”_ty³
 
	$txp_š¥eù
(è{ 0;
	}
}

431 
	#TXP_INCREMENT
(
p
è
T¿n§ùiÚ
::
txp_accouÁ
<Õ)>(1)

	)

432 
	#TXP_ACCOUNT
(
p
, 
n
è
T¿n§ùiÚ
::
txp_accouÁ
<Õ)>(Ò))

	)

433 
	#TXP_INSPECT
(
p
è
T¿n§ùiÚ
::
txp_š¥eù
<Õ)>()

	)

436 
	g´iv©e
:

437 
cÚ¡ex´
 
t£t_chunk
 = 512;

438 
cÚ¡ex´
 
	gt£t_max_ÿ·c™y
 = 32768;

440 
š™Ÿlize
();

442 
	$T¿n§ùiÚ
()

443 : 
	`th»adid_
(
TTh»ad
::
	`id
()), 
	$is_‹¡_
(
çl£
) {

444 
	`š™Ÿlize
();

445 
	`¡¬t
();

446 
	}
}

448 
	s‹¡šg_ty³
 {};

449 
‹¡šg_ty³
 
	g‹¡šg
;

451 
	$T¿n§ùiÚ
(
th»adid
, cÚ¡ 
‹¡šg_ty³
&)

452 : 
	`th»adid_
(
th»adid
), 
	`is_‹¡_
(
Œue
), 
	$»¡¬‹d
(
çl£
) {

453 
	`š™Ÿlize
();

454 
	`¡¬t
();

455 
	}
}

457 
	$T¿n§ùiÚ
(
boŞ
)

458 : 
	`th»adid_
(
TTh»ad
::
	`id
()), 
	`is_‹¡_
(
çl£
), 
	$»¡¬‹d
(
çl£
) {

459 
	`š™Ÿlize
();

460 
¡©e_
 = 
s_abÜ‹d
;

461 
	}
}

463 ~
T¿n§ùiÚ
();

465 
ÿÎCM¡¬t
();

468 
	$¡¬t
() {

469 
th»adšfo_t
& 
thr
 = 
tšfo
[
TTh»ad
::
	`id
()];

473 #ià
STO_TSC_PROFILE


474 
¡¬t_tsc_
 = 
	`»ad_tsc
();

476 
thr
.
•och
 = 
glob®_•ochs
.
glob®_•och
;

477 
thr
.
rcu_£t
.
	`ş—n_uÁ
(
glob®_•ochs
.
aùive_•och
);

478 ià(
thr
.
Œªs_¡¬t_ÿÎback
)

479 
thr
.
	`Œªs_¡¬t_ÿÎback
();

480 
hash_ba£_
 +ğ
t£t_size_
 + 1;

481 
t£t_size_
 = 0;

482 
t£t_Ãxt_
 = 
t£t0_
;

483 #ià
TRANSACTION_HASHTABLE


484 ià(
hash_ba£_
 >= 32768) {

485 
	`mem£t
(
hashbË_
, 0, (hashtable_));

491 
hash_ba£_
 = 0;

494 
ªy_wr™es_
 = 
ªy_nÚİaque_
 = 
may_du¶iÿ‹_™ems_
 = 
çl£
;

495 
fœ¡_wr™e_
 = 0;

496 
¡¬t_tid_
 = 
comm™_tid_
 = 0;

497 
tiùoc_tid_
 = 0;

498 
buf_
.
	`ş—r
();

499 #ià
STO_DEBUG_ABORTS


500 
abÜt_™em_
 = 
nuÎ±r
;

501 
abÜt_»asÚ_
 = 
nuÎ±r
;

502 
abÜt_v”siÚ_
 = 0;

504 
	`TXP_INCREMENT
(
txp_tÙ®_¡¬ts
);

505 
¡©e_
 = 
s_š_´og»ss
;

506 
	`ÿÎCM¡¬t
();

507 
	}
}

509 #ià
TRANSACTION_HASHTABLE


510 
	$hash_št_¬¿y_šdex
(cÚ¡ 
TObjeù
* 
obj
, * 
key
) {

511 (è
obj
;

512  (
»š‹½»t_ÿ¡
<
ušŒ_t
>(
key
)è% 
hash_size
;

513 
	}
}

515 
	$hash_št_¬¿y_±r
(cÚ¡ 
TObjeù
* 
obj
, * 
key
) {

516 (è
obj
;

517  (
»š‹½»t_ÿ¡
<
ušŒ_t
>(
key
è>> 2è% 
hash_size
;

518 
	}
}

520 
	$hash_»guÏr
(cÚ¡ 
TObjeù
* 
obj
, * 
key
) {

521 autØ
n
 = 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
key
) + 0x4000000;

522 
n
 +ğ-
	`ušŒ_t
Ò < 0x8000000è& (
»š‹½»t_ÿ¡
<
ušŒ_t
>(
obj
) >> 4);

524  (
n
 + (À>> 16è* 9è% 
hash_size
;

525 
	}
}

527 
	$hash
(cÚ¡ 
TObjeù
* 
obj
, * 
key
) {

528  
	`hash_»guÏr
(
obj
, 
key
);

529 
	}
}

532 
»äesh_t£t_chunk
();

534 
	$®loÿ‹_™em_upd©e_hash
(cÚ¡ 
TObjeù
* 
obj
, * 
xkey
) {

535 #ià
TRANSACTION_HASHTABLE


536 
hi
 = 
	`hash
(
obj
, 
xkey
);

538 #ià
TRANSACTION_HASHTABLE
 > 1

539 ià(
hashbË_
[
hi
] > 
hash_ba£_
)

540 
hi
 = (h˜+ 
hash_¡•
è% 
hash_size
;

542 ià(
hashbË_
[
hi
] <ğ
hash_ba£_
)

543 
hashbË_
[
hi
] = 
hash_ba£_
 + 
t£t_size_
;

545 
	}
}

547 
T¿nsI‹m
* 
	$®loÿ‹_™em
(cÚ¡ 
TObjeù
* 
obj
, * 
xkey
) {

549 ià(
t£t_size_
 &&£t_size_ % 
t£t_chunk
 == 0)

550 
	`»äesh_t£t_chunk
();

551 ++
t£t_size_
;

552 
	`Ãw
(
»š‹½»t_ÿ¡
<*>(
t£t_Ãxt_
)è
	`T¿nsI‹m
(
cÚ¡_ÿ¡
<
TObjeù
*>(
obj
), 
xkey
);

555 
	`®loÿ‹_™em_upd©e_hash
(
obj
, 
xkey
);

556  
t£t_Ãxt_
++;

557 
	}
}

559 
	gpublic
:

560 
	$th»adid
() const {

561  
th»adid_
;

562 
	}
}

565 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

566 
T¿nsProxy
 
	$Ãw_™em
(cÚ¡ 
TObjeù
* 
obj
, 
T
 
key
) {

567 * 
xkey
 = 
Pack”
<
T
>::
	`·ck_unique
(
buf_
, 
¡d
::
	`move
(
key
));

568  
	`T¿nsProxy
(*
this
, *
	`®loÿ‹_™em
(
obj
, 
xkey
));

569 
	}
}

572 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

573 
T¿nsProxy
 
	$äesh_™em
(cÚ¡ 
TObjeù
* 
obj
, 
T
 
key
) {

574 
may_du¶iÿ‹_™ems_
 = 
t£t_size_
 > 0;

575 * 
xkey
 = 
Pack”
<
T
>::
	`·ck_unique
(
buf_
, 
¡d
::
	`move
(
key
));

576  
	`T¿nsProxy
(*
this
, *
	`®loÿ‹_™em
(
obj
, 
xkey
));

577 
	}
}

579 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

580 
T¿nsProxy
 
	$™em
(cÚ¡ 
TObjeù
* 
obj
, 
T
 
key
) {

581 * 
xkey
 = 
Pack”
<
T
>::
	`·ck_unique
(
buf_
, 
¡d
::
	`move
(
key
));

582 
T¿nsI‹m
* 
ti
 = 
	`fšd_™em
(
cÚ¡_ÿ¡
<
TObjeù
*>(
obj
), 
xkey
);

583 ià(!
ti
)

584 
ti
 = 
	`®loÿ‹_™em
(
obj
, 
xkey
);

585  
	`T¿nsProxy
(*
this
, *
ti
);

586 
	}
}

589 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

590 
T¿nsProxy
 
	$™em_šlšed
(cÚ¡ 
TObjeù
* 
obj
, 
T
 
key
) {

591 
boŞ
 
found
 = 
çl£
;

592 
T¿nsI‹m
* 
ti
;

593 * 
xkey
 = 
Pack”
<
T
>::
	`·ck_unique
(
buf_
, 
¡d
::
	`move
(
key
));

594 #ià
TRANSACTION_HASHTABLE


595 
	`TXP_INCREMENT
(
txp_hash_fšd
);

596 
hi
 = 
	`hash
(
obj
, 
xkey
);

597 ià(
hashbË_
[
hi
] > 
hash_ba£_
) {

598 
tidx
 = 
hashbË_
[
hi
] - 
hash_ba£_
 - 1;

599 ià(
	`lik–y
(
tidx
 < 
t£t_š™Ÿl_ÿ·c™y
))

600 
ti
 = &
t£t0_
[
tidx
];

602 
ti
 = &
t£t_
[
tidx
 / 
t£t_chunk
][tidx %set_chunk];

603 ià(
ti
->
	`owÃr
(è=ğ
obj
 &&i->
key_
 =ğ
xkey
) {

604 
found
 = 
Œue
;

608 
tidx
 = 0;idx !ğ
t£t_size_
; ++tidx) {

609 
ti
 = (
tidx
 % 
t£t_chunk
 ?˜+ 1 : 
t£t_
[tidx /set_chunk]);

610 
	`TXP_INCREMENT
(
txp_tÙ®_£¬ched
);

611 ià(
ti
->
	`owÃr
(è=ğ
obj
 &&i->
key_
 =ğ
xkey
) {

612 
found
 = 
Œue
;

616 #ià
TRANSACTION_HASHTABLE


621 ià(!
found
) {

622 ià(
t£t_size_
 &&£t_size_ % 
t£t_chunk
 == 0)

623 
	`»äesh_t£t_chunk
();

624 ++
t£t_size_
;

625 
	`Ãw
(
»š‹½»t_ÿ¡
<*>(
t£t_Ãxt_
)è
	`T¿nsI‹m
(
cÚ¡_ÿ¡
<
TObjeù
*>(
obj
), 
xkey
);

626 #ià
TRANSACTION_HASHTABLE


627 ià(
hashbË_
[
hi
] <ğ
hash_ba£_
)

628 
hashbË_
[
hi
] = 
hash_ba£_
 + 
t£t_size_
;

630 
ti
 = 
t£t_Ãxt_
++;

633  
	`T¿nsProxy
(*
this
, *
ti
);

634 
	}
}

638 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

639 
T¿nsProxy
 
	$»ad_™em
(cÚ¡ 
TObjeù
* 
obj
, 
T
 
key
) {

640 * 
xkey
 = 
Pack”
<
T
>::
	`·ck_unique
(
buf_
, 
¡d
::
	`move
(
key
));

641 
T¿nsI‹m
* 
ti
 = 
nuÎ±r
;

642 ià(
ªy_wr™es_
) {

643 
ti
 = 
	`fšd_™em
(
cÚ¡_ÿ¡
<
TObjeù
*>(
obj
), 
xkey
);

646 
may_du¶iÿ‹_™ems_
 = 
t£t_size_
 > 0;

648 ià(!
ti
)

649 
ti
 = 
	`®loÿ‹_™em
(
obj
, 
xkey
);

650  
	`T¿nsProxy
(*
this
, *
ti
);

651 
	}
}

653 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

654 
O±iÚ®T¿nsProxy
 
	$check_™em
(cÚ¡ 
TObjeù
* 
obj
, 
T
 
key
) const {

655 * 
xkey
 = 
Pack”
<
T
>::
	`·ck_unique
(
buf_
, 
¡d
::
	`move
(
key
));

656 
T¿nsI‹m
* 
ti
 = 
	`fšd_™em
(
cÚ¡_ÿ¡
<
TObjeù
*>(
obj
), 
xkey
);

657  
	`O±iÚ®T¿nsProxy
(
cÚ¡_ÿ¡
<
T¿n§ùiÚ
&>(*
this
), 
ti
);

658 
	}
}

660 
	g´iv©e
:

661 
T¿nsI‹m
* 
	$fšd_™em_sÿn
(
TObjeù
* 
obj
, * 
xkey
) const {

662 cÚ¡ 
T¿nsI‹m
* 
™
 = 
nuÎ±r
;

663 
tidx
 = 0;idx !ğ
t£t_size_
; ++tidx) {

664 
™
 = (
tidx
 % 
t£t_chunk
 ? iˆ+ 1 : 
t£t_
[tidx /set_chunk]);

665 
	`TXP_INCREMENT
(
txp_tÙ®_£¬ched
);

666 ià(
™
->
	`owÃr
(è=ğ
obj
 && it->
key_
 =ğ
xkey
)

667  
cÚ¡_ÿ¡
<
T¿nsI‹m
*>(
™
);

669  
nuÎ±r
;

670 
	}
}

672 
T¿nsI‹m
* 
	$fšd_™em
(
TObjeù
* 
obj
, * 
xkey
) const {

673 #ià
STO_TSC_PROFILE


674 
TimeK“³r
<
tc_fšd_™em
> 
tk
;

676 #ià
TRANSACTION_HASHTABLE


677 
	`TXP_INCREMENT
(
txp_hash_fšd
);

678 
hi
 = 
	`hash
(
obj
, 
xkey
);

679 
¡•s
 = 0; s‹p < 
TRANSACTION_HASHTABLE
; ++steps) {

680 ià(
hashbË_
[
hi
] <ğ
hash_ba£_
)

681  
nuÎ±r
;

682 
tidx
 = 
hashbË_
[
hi
] - 
hash_ba£_
 - 1;

683 cÚ¡ 
T¿nsI‹m
* 
ti
;

684 ià(
	`lik–y
(
tidx
 < 
t£t_š™Ÿl_ÿ·c™y
))

685 
ti
 = &
t£t0_
[
tidx
];

687 
ti
 = &
t£t_
[
tidx
 / 
t£t_chunk
][tidx %set_chunk];

688 ià(
ti
->
	`owÃr
(è=ğ
obj
 &&i->
key_
 =ğ
xkey
)

689  
cÚ¡_ÿ¡
<
T¿nsI‹m
*>(
ti
);

690 ià(!
¡•s
) {

691 
	`TXP_INCREMENT
(
txp_hash_cŞlisiÚ
);

692 #ià
STO_DEBUG_HASH_COLLISIONS


693 ià(
	`loÿl_¿ndom
(è<ğ
	`ušt32_t
(0xFFFFFFFF * 
STO_DEBUG_HASH_COLLISIONS_FRACTION
)) {

694 
¡d
::
o¡ršg¡»am
 
buf
;

695 
T¿nsI‹m
 
	`çke_™em
(
obj
, 
xkey
);

696 
buf
 << "$ STO hash cŞlisiÚ: s—rch " << 
çke_™em
 << ", fšd " << *
ti
 << '\n';

697 
¡d
::
û¼
 << 
buf
.
	`¡r
();

701 
	`TXP_INCREMENT
(
txp_hash_cŞlisiÚ2
);

702 
hi
 = (h˜+ 
hash_¡•
è% 
hash_size
;

706  
	`fšd_™em_sÿn
(
obj
, 
xkey
);

707 
	}
}

709 
boŞ
 
	$´eûdšg_du¶iÿ‹_»ad
(
T¿nsI‹m
 *
™
) const;

711 
public
:

712 #ià
STO_DEBUG_ABORTS


713 
	$m¬k_abÜt_beÿu£
(
T¿nsI‹m
* 
™em
, cÚ¡ * 
»asÚ
, 
T¿n§ùiÚTid
::
ty³
 
v”siÚ
 = 0) const {

714 
abÜt_™em_
 = 
™em
;

715 
abÜt_»asÚ_
 = 
»asÚ
;

716 ià(
v”siÚ
)

717 
abÜt_v”siÚ_
 = 
v”siÚ
;

718 
	}
}

720 
	$m¬k_abÜt_beÿu£
(
T¿nsI‹m
*, cÚ¡ *, 
T¿n§ùiÚTid
::
ty³
 = 0) const {

721 
	}
}

724 
	$abÜt_beÿu£
(
T¿nsI‹m
& 
™em
, cÚ¡ * 
»asÚ
, 
T¿n§ùiÚTid
::
ty³
 
v”siÚ
 = 0) {

725 
	`m¬k_abÜt_beÿu£
(&
™em
, 
»asÚ
, 
v”siÚ
);

726 
	`abÜt
();

727 
	}
}

729 
	$s’t_abÜt
() {

730 ià(
	`š_´og»ss
())

731 
	`¡İ
(
çl£
, 
nuÎ±r
, 0);

732 
	}
}

734 
	$abÜt
() {

735 
	`s’t_abÜt
();

736 
throw
 
	`AbÜt
();

738 
	}
}

740 
boŞ
 
Œy_comm™
();

742 
	$comm™
() {

743 ià(!
	`Œy_comm™
())

744 
throw
 
	`AbÜt
();

745 
	}
}

747 
boŞ
 
	$abÜ‹d
() {

748  
¡©e_
 =ğ
s_abÜ‹d
;

749 
	}
}

751 
boŞ
 
	$š_´og»ss
() {

752  
¡©e_
 < 
s_abÜ‹d
;

753 
	}
}

755 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

756 
T
 *
	$tx_®loc
(cÚ¡ 
T
 *
¤c
) {

757  &
sü©ch_
.
şÚe
<
T
>(*
¤c
);

758 
	}
}

760 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

761 
T
 *
	$tx_®loc
() {

762  &
sü©ch_
.
®loÿ‹
<
T
>();

763 
	}
}

768 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

769 
šlše
 
boŞ
 
Œy_lock
(
T¿nsI‹m
& 
™em
, 
V”siÚBa£
<
V”sIm¶
>& 
v”s
);

771 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

772 
uÆock
(
T¿nsI‹m
& 
™em
, 
V”siÚBa£
<
V”sIm¶
>& 
v”s
) {

773 
	gv”s
.
ı_uÆock
(
™em
);

776 
boŞ
 
	$check_İac™y
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚTid
::
ty³
 
v
è
	`__©Œibu‹__
 ((
w¬n_unu£d_»suÉ
)) {

777 #ià
STO_TSC_PROFILE


778 
TimeK“³r
<
tc_İac™y
> 
tk
;

780 
	`as£¹
(
¡©e_
 <ğ
s_comm™tšg_locked
);

781 
	`TXP_INCREMENT
(
txp_tco
);

782 ià(!
¡¬t_tid_
)

783 
¡¬t_tid_
 = 
_TID
;

784 ià(!
T¿n§ùiÚTid
::
	`Œy_check_İac™y
(
¡¬t_tid_
, 
v
)

785 && 
¡©e_
 < 
s_comm™tšg
)

786  
	`h¬d_check_İac™y
(&
™em
, 
v
);

787  
Œue
;

788 
	}
}

799 
boŞ
 
	$check_İac™y
(
T¿n§ùiÚTid
::
ty³
 
v
) {

800 
	`as£¹
(
¡©e_
 <ğ
s_comm™tšg_locked
);

801 ià(!
¡¬t_tid_
)

802 
¡¬t_tid_
 = 
_TID
;

803 ià(!
T¿n§ùiÚTid
::
	`Œy_check_İac™y
(
¡¬t_tid_
, 
v
)

804 && 
¡©e_
 < 
s_comm™tšg
)

805  
	`h¬d_check_İac™y
(
nuÎ±r
, 
v
);

806  
Œue
;

807 
	}
}

809 
boŞ
 
	$check_İac™y
() {

810  
	`check_İac™y
(
_TID
);

811 
	}
}

814 
tid_ty³
 
	$comm™_tid
() const {

815 #ià!
CONSISTENCY_CHECK


816 
	`as£¹
(
¡©e_
 =ğ
s_comm™tšg_locked
 || s‹_ =ğ
s_comm™tšg
);

818 ià(!
comm™_tid_
)

819 
comm™_tid_
 = 
	`ãtch_ªd_add
(&
_TID
, 
T¿n§ùiÚTid
::
šüem’t_v®ue
);

820  
comm™_tid_
;

821 
	}
}

823 
šlše
 
tid_ty³
 
	$compu‹_tiùoc_comm™_ts
() const;

825 
‹m¶©e
 <
ty³Çme
 
V”sIm¶
>

826 
	`£t_v”siÚ
(
V”siÚBa£
<
V”sIm¶
>& 
v”siÚ
, 
ty³Çme
 V”siÚBa£<V”sIm¶>::
ty³
 
æags
 = 0) const {

827 
	`as£¹
(
¡©e_
 =ğ
s_comm™tšg_locked
 || s‹_ =ğ
s_comm™tšg
);

828 
tid_ty³
 
v
 = 
v”siÚ
.
	`ı_comm™_tid
(
cÚ¡_ÿ¡
<
T¿n§ùiÚ
 &>(*
this
));

829 
v”siÚ
.
	`ı_£t_v”siÚ
(
v
 | 
æags
);

830 
	}
}

832 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

833 
£t_v”siÚ_uÆock
(
V”siÚBa£
<
V”sIm¶
>& 
v”siÚ
, 
T¿nsI‹m
& 
™em
, 
ty³Çme
 V”siÚBa£<V”sIm¶>::
ty³
 
æags
 = 0) const {

834 
as£¹
(
¡©e_
 =ğ
s_comm™tšg_locked
 || s‹_ =ğ
s_comm™tšg
);

835 
tid_ty³
 
	gv
 = 
v”siÚ
.
ı_comm™_tid
(
cÚ¡_ÿ¡
<
T¿n§ùiÚ
 &>(*
this
));

836 
	gv”siÚ
.
ı_£t_v”siÚ_uÆock
(
v
 | 
æags
);

837 
	g™em
.
ş—r_Ãeds_uÆock
();

840 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

841 
assign_v”siÚ_uÆock
(
V”siÚBa£
<
V”sIm¶
>& 
v”siÚ
, 
T¿nsI‹m
& 
™em
, 
ty³Çme
 V”siÚBa£<V”sIm¶>::
ty³
 
æags
 = 0) const {

842 
tid_ty³
 
v
 = 
v”siÚ
.
ı_comm™_tid
(
cÚ¡_ÿ¡
<
T¿n§ùiÚ
 &>(*
this
));

843 
	gv”siÚ
.
v®ue
(èğ
v
 | 
æags
;

844 
	g™em
.
ş—r_Ãeds_uÆock
();

915 cÚ¡ * 
¡©e_Çme
(
¡©e
);

916 
	$´št
() const;

917 
	$´št
(
¡d
::
o¡»am
& 
w
) const;

919 şas 
	cAbÜt
 {
	}
};

921 
ušt32_t
 
	$loÿl_¿ndom
() const {

922 
Ìng_¡©e_
 =†rng_state_ * 1664525 + 1013904223;

923  
Ìng_¡©e_
;

924 
	}
}

925 
	$loÿl_¤ªdom
(
ušt32_t
 
¡©e
) {

926 
Ìng_¡©e_
 = 
¡©e
;

927 
	}
}

929 
boŞ
 
	$is_»¡¬‹d
() {

930  
»¡¬‹d
;

931 
	}
}

933 
	$£t_»¡¬‹d
(
boŞ
 
r
) {

934 
»¡¬‹d
 = 
r
;

935 
	}
}

937 
	g´iv©e
:

939 
s_š_´og»ss
 = 0, 
	gs_İac™y_check
 = 1, 
	gs_comm™tšg
 = 2,

940 
	gs_comm™tšg_locked
 = 3, 
	gs_abÜ‹d
 = 4, 
	gs_comm™‹d
 = 5

943 
	gth»adid_
;

944 
ušt16_t
 
	ghash_ba£_
;

945 
ušt16_t
 
	gfœ¡_wr™e_
;

946 
ušt8_t
 
	g¡©e_
;

947 
boŞ
 
	gªy_wr™es_
;

948 
	gpublic
:

949 
boŞ
 
ªy_nÚİaque_
;

950 
	g´iv©e
:

951 
boŞ
 
may_du¶iÿ‹_™ems_
;

952 
boŞ
 
	gis_‹¡_
;

953 
boŞ
 
	g»¡¬‹d
;

954 
T¿nsI‹m
* 
	gt£t_Ãxt_
;

955 
	gt£t_size_
;

956 
mubË
 
tid_ty³
 
	g¡¬t_tid_
;

957 
mubË
 
tid_ty³
 
	gcomm™_tid_
;

958 
mubË
 
tid_ty³
 
	gtiùoc_tid_
;

959 
	gpublic
:

960 
mubË
 
T¿n§ùiÚBufãr
 
buf_
;

961 
mubË
 
T¿nsSü©ch
 
	gsü©ch_
;

962 
	g´iv©e
:

963 
mubË
 
ušt32_t
 
Ìng_¡©e_
;

964 #ià
STO_DEBUG_ABORTS


965 
mubË
 
T¿nsI‹m
* 
	gabÜt_™em_
;

966 
mubË
 cÚ¡ * 
	gabÜt_»asÚ_
;

967 
mubË
 
tid_ty³
 
	gabÜt_v”siÚ_
;

969 #ià
STO_TSC_PROFILE


970 
mubË
 
tc_couÁ”_ty³
 
	g¡¬t_tsc_
;

972 
T¿nsI‹m
* 
	gt£t_
[
t£t_max_ÿ·c™y
 / 
t£t_chunk
];

973 #ià
TRANSACTION_HASHTABLE


974 
ušt16_t
 
	ghashbË_
[
hash_size
];

976 
T¿nsI‹m
 
	gt£t0_
[
t£t_š™Ÿl_ÿ·c™y
];

978 
boŞ
 
h¬d_check_İac™y
(
T¿nsI‹m
* 
™em
, 
T¿n§ùiÚTid
::
ty³
 
t
);

979 
¡İ
(
boŞ
 
comm™‹d
, * 
wr™es
, 
nwr™es
);

981 
ä›nd
 
şass
 
	gT¿nsProxy
;

982 
ä›nd
 
şass
 
	gT¿nsI‹m
;

983 
ä›nd
 
şass
 
	gSto
;

984 
ä›nd
 
şass
 
	gTe¡T¿n§ùiÚ
;

986 
ä›nd
 
şass
 
	gV”siÚD–eg©e
;

989 
	g‹m¶©e
 <
	gT
, 
boŞ
 
	gtmp_¡©s
>

990 
šlše
 
	gTimeK“³r
<
	gT
, 
	gtmp_¡©s
>::
	$sync_th»ad_couÁ”
() {

991 
tc_h–³r
<
T
, 
tc_couÁ
>::
	`accouÁ_¬¿y
(

992 
T¿n§ùiÚ
::
tšfo
[
TTh»ad
::
	`id
()].
tcs_
.tcs_,

993 
	`»ad_tsc
(è- 
š™_tsc


995 
	}
}

997 
	g‹m¶©e
 <
	gT
, 
boŞ
 
	gtmp_¡©s
>

998 
šlše
 
	gTimeK“³r
<
	gT
, 
	gtmp_¡©s
>::
	$sync_th»ad_couÁ”_tmp
() {

1000 
	`abÜt
();

1001 
	}
}

1003 şas 
	cSto
 {

1004 
	mpublic
:

1005 
T¿n§ùiÚ
* 
	$Œª§ùiÚ
() {

1006 ià(!
TTh»ad
::
txn
)

1007 
TTh»ad
::
txn
 = 
Ãw
 
	`T¿n§ùiÚ
(
çl£
);

1008  
TTh»ad
::
txn
;

1011 
	$¡¬t_Œª§ùiÚ
() {

1012 
T¿n§ùiÚ
* 
t
 = 
	`Œª§ùiÚ
();

1013 
	`®ways_as£¹
(!
t
->
	`š_´og»ss
());

1014 
t
->
	`¡¬t
();

1015 
	}
}

1017 
	$d–‘e_Œª§ùiÚ
() {

1018 
d–‘e
 
TTh»ad
::
txn
;

1019 
TTh»ad
::
txn
 = 
nuÎ±r
;

1020 
	}
}

1022 
	$upd©e_th»adid
() {

1023 ià(
TTh»ad
::
txn
)

1024 
TTh»ad
::
txn
->
th»adid_
 = TTh»ad::
	`id
();

1025 
	}
}

1027 
boŞ
 
	$š_´og»ss
() {

1028  
TTh»ad
::
txn
 && TTh»ad::txn->
	`š_´og»ss
();

1029 
	}
}

1031 
	$abÜt
() {

1032 
	`®ways_as£¹
(
	`š_´og»ss
());

1033 
TTh»ad
::
txn
->
	`abÜt
();

1034 
	}
}

1036 
	$s’t_abÜt
() {

1037 ià(
	`š_´og»ss
())

1038 
TTh»ad
::
txn
->
	`s’t_abÜt
();

1039 
	}
}

1041 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1042 
T¿nsProxy
 
	$™em
(cÚ¡ 
TObjeù
* 
s
, 
T
 
key
) {

1044  
TTh»ad
::
txn
->
	`™em
(
s
, 
key
);

1045 
	}
}

1047 
	$check_İac™y
(
T¿n§ùiÚTid
::
ty³
 
t
) {

1048 
	`®ways_as£¹
(
	`š_´og»ss
());

1049 
TTh»ad
::
txn
->
	`check_İac™y
(
t
);

1050 
	}
}

1052 
	$check_İac™y
() {

1053 
	`®ways_as£¹
(
	`š_´og»ss
());

1054 
TTh»ad
::
txn
->
	`check_İac™y
();

1055 
	}
}

1057 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1058 
O±iÚ®T¿nsProxy
 
	$check_™em
(cÚ¡ 
TObjeù
* 
s
, 
T
 
key
) {

1059 
	`®ways_as£¹
(
	`š_´og»ss
());

1060  
TTh»ad
::
txn
->
	`check_™em
(
s
, 
key
);

1061 
	}
}

1063 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1064 
T¿nsProxy
 
	$Ãw_™em
(cÚ¡ 
TObjeù
* 
s
, 
T
 
key
) {

1065 
	`®ways_as£¹
(
	`š_´og»ss
());

1066  
TTh»ad
::
txn
->
	`Ãw_™em
(
s
, 
key
);

1067 
	}
}

1069 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1070 
T¿nsProxy
 
	$»ad_™em
(cÚ¡ 
TObjeù
* 
s
, 
T
 
key
) {

1071 
	`®ways_as£¹
(
	`š_´og»ss
());

1072  
TTh»ad
::
txn
->
	`»ad_™em
(
s
, 
key
);

1073 
	}
}

1075 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1076 
T¿nsProxy
 
	$äesh_™em
(cÚ¡ 
TObjeù
* 
s
, 
T
 
key
) {

1077 
	`®ways_as£¹
(
	`š_´og»ss
());

1078  
TTh»ad
::
txn
->
	`äesh_™em
(
s
, 
key
);

1079 
	}
}

1081 
	$comm™
() {

1082 
	`®ways_as£¹
(
	`š_´og»ss
());

1083 
TTh»ad
::
txn
->
	`comm™
();

1084 
	}
}

1086 
boŞ
 
	$Œy_comm™
() {

1088 ià(!
	`š_´og»ss
())

1089  
çl£
;

1090  
TTh»ad
::
txn
->
	`Œy_comm™
();

1091 
	}
}

1093 
	gT¿n§ùiÚTid
::
ty³
 
	$comm™_tid
() {

1094  
TTh»ad
::
txn
->
	`comm™_tid
();

1095 
	}
}

1097 
	gT¿n§ùiÚTid
::
ty³
 
	$»ûÁ_tid
() {

1098  
T¿n§ùiÚ
::
glob®_•ochs
.
»ûÁ_tid
;

1099 
	}
}

1101 
	gT¿n§ùiÚTid
::
ty³
 
	$š™Ÿlized_tid
() {

1103  
T¿n§ùiÚTid
::
šüem’t_v®ue
;

1104 
	}
}

1106 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1107 
šlše
 
T
* 
	$tx_®loc
(cÚ¡ 
T
* 
blob
) {

1108  
TTh»ad
::
txn
->
tx_®loc
<
T
>(
blob
);

1109 
	}
}

1110 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1111 
šlše
 
T
* 
	$tx_®loc
() {

1112  
TTh»ad
::
txn
->
tx_®loc
<
T
>();

1113 
	}
}

1116 şas 
	cTe¡T¿n§ùiÚ
 {

1117 
	mpublic
:

1118 
	$Te¡T¿n§ùiÚ
(
th»adid
)

1119 : 
	$t_
(
th»adid
, 
T¿n§ùiÚ
::
‹¡šg
) {

1120 
	`u£
();

1122 ~
	$Te¡T¿n§ùiÚ
() {

1127 
	}
}

1128 
	$u£
() {

1129 
TTh»ad
::
txn
 = &
t_
;

1130 
TTh»ad
::
	`£t_id
(
t_
.
th»adid_
);

1131 
	}
}

1132 
	$´št
(
¡d
::
o¡»am
& 
w
) const {

1133 
t_
.
	`´št
(
w
);

1134 
	}
}

1135 
boŞ
 
	$Œy_comm™
() {

1136 
	`u£
();

1137 autØ
r
 = 
t_
.
	`Œy_comm™
();

1138 
Te¡T¿n§ùiÚ
::
	`h¬d_»£t
();

1139  
r
;

1140 
	}
}

1141 
	$h¬d_»£t
() {

1142 
TTh»ad
::
txn
 = 
nuÎ±r
;

1143 
	}
}

1144 
	gT¿n§ùiÚ
 &
	$g‘_tx
() {

1145  
t_
;

1146 
	}
}

1147 
	g´iv©e
:

1148 
T¿n§ùiÚ
 
t_
;

1152 şas 
	cT¿n§ùiÚGu¬d
 {

1153 
	mpublic
:

1154 
	$T¿n§ùiÚGu¬d
() {

1155 
Sto
::
	`¡¬t_Œª§ùiÚ
();

1157 ~
	$T¿n§ùiÚGu¬d
() {

1158 
Sto
::
	`comm™
();

1159 
Sto
::
	`d–‘e_Œª§ùiÚ
();

1160 
	}
}

1161 (
	tT¿n§ùiÚGu¬d
::* 
	tun¥ecif›d_boŞ_ty³
)(
	t¡d
::
	to¡»am
&) const;

1162 
İ”©Ü
 
	$un¥ecif›d_boŞ_ty³
() const {

1163  &
T¿n§ùiÚGu¬d
::
´št
;

1164 
	}
}

1165 
	$´št
(
¡d
::
o¡»am
& 
w
) const {

1166 
TTh»ad
::
txn
->
	`´št
(
w
);

1167 
	}
}

1170 şas 
	cT¿n§ùiÚLoİGu¬d
 {

1171 
	mpublic
:

1172 
	$T¿n§ùiÚLoİGu¬d
() {

1173 
T¿n§ùiÚ
* 
t
 = 
Sto
::
	`Œª§ùiÚ
();

1174 
t
->
	`£t_»¡¬‹d
(
çl£
);

1181 ~
	$T¿n§ùiÚLoİGu¬d
() {

1182 ià(
TTh»ad
::
txn
->
	`š_´og»ss
())

1183 
TTh»ad
::
txn
->
	`s’t_abÜt
();

1184 
	}
}

1185 
	$¡¬t
() {

1186 
Sto
::
	`¡¬t_Œª§ùiÚ
();

1187 
	}
}

1188 
	$s’t_abÜt
() {

1189 
TTh»ad
::
txn
->
	`s’t_abÜt
();

1190 
	}
}

1191 
boŞ
 
	$Œy_comm™
() {

1192  
TTh»ad
::
txn
->
	`š_´og»ss
(è&& TTh»ad::txn->
	`Œy_comm™
();

1193 
	}
}

1197 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1198 
šlše
 
boŞ
 
	gT¿nsProxy
::
	$add_»ad
(
T
 
rd©a
) {

1199 
	`as£¹
(!
	`has_¡ash
());

1200 ià(!
	`has_»ad
()) {

1201 
	`™em
().
	`__Ü_æags
(
T¿nsI‹m
::
»ad_b™
);

1202 
	`™em
().
rd©a_
.
v
 = 
Pack”
<
T
>::
	`·ck
(
	`t
()->
buf_
, 
¡d
::
	`move
(
rd©a
));

1203 
	`t
()->
ªy_nÚİaque_
 = 
Œue
;

1205  
Œue
;

1206 
	}
}

1211 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1212 
šlše
 
boŞ
 
	gT¿nsProxy
::
	$add_»ad_İaque
(
T
 
rd©a
) {

1213 
	`as£¹
(!
	`has_¡ash
());

1214 ià(!
	`t
()->
	`check_İac™y
()) {

1215  
çl£
;

1217 ià(!
	`has_»ad
()) {

1218 
	`™em
().
	`__Ü_æags
(
T¿nsI‹m
::
»ad_b™
);

1219 
	`™em
().
rd©a_
.
v
 = 
Pack”
<
T
>::
	`·ck
(
	`t
()->
buf_
, 
¡d
::
	`move
(
rd©a
));

1221  
Œue
;

1222 
	}
}

1224 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1225 
šlše
 
	gT¿nsProxy
& T¿nsProxy::
	$upd©e_»ad
(
T
 
Şd_rd©a
, T 
Ãw_rd©a
) {

1226 ià(
	`has_»ad
(è&& 
this
->
»ad_v®ue
<
T
>(è=ğ
Şd_rd©a
)

1227 
	`™em
().
rd©a_
.
v
 = 
Pack”
<
T
>::
	`»·ck
(
	`t
()->
buf_
, i‹m().rd©a_.v, 
Ãw_rd©a
);

1228  *
this
;

1229 
	}
}

1232 
šlše
 
	gT¿nsProxy
& T¿nsProxy::
	$£t_´ediÿ‹
() {

1233 
	`as£¹
(!
	`has_»ad
());

1234 
	`™em
().
	`__Ü_æags
(
T¿nsI‹m
::
´ediÿ‹_b™
);

1235  *
this
;

1236 
	}
}

1238 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1239 
šlše
 
	gT¿nsProxy
& T¿nsProxy::
	$£t_´ediÿ‹
(
T
 
pd©a
) {

1240 
	`as£¹
(!
	`has_»ad
());

1241 
	`™em
().
	`__Ü_æags
(
T¿nsI‹m
::
´ediÿ‹_b™
);

1242 
	`™em
().
rd©a_
.
v
 = 
Pack”
<
T
>::
	`·ck
(
	`t
()->
buf_
, 
¡d
::
	`move
(
pd©a
));

1243  *
this
;

1244 
	}
}

1246 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1247 
šlše
 
	gT
& 
	gT¿nsProxy
::
	$´ediÿ‹_v®ue
(
T
 
deçuÉ_pd©a
) {

1248 
	`as£¹
(!
	`has_»ad
());

1249 ià(!
	`has_´ediÿ‹
())

1250 
	`£t_´ediÿ‹
(
deçuÉ_pd©a
);

1251  
this
->
‹m¶©e
 
´ediÿ‹_v®ue
<
T
>();

1252 
	}
}

1254 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1255 
šlše
 
	gT¿nsProxy
& T¿nsProxy::
	$£t_¡ash
(
T
 
sd©a
) {

1256 
	`as£¹
(!
	`has_»ad
());

1257 ià(!
	`has_¡ash
()) {

1258 
	`™em
().
	`__Ü_æags
(
T¿nsI‹m
::
¡ash_b™
);

1259 
	`™em
().
rd©a_
.
v
 = 
Pack”
<
T
>::
	`·ck
(
	`t
()->
buf_
, 
¡d
::
	`move
(
sd©a
));

1261 
	`™em
().
rd©a_
.
v
 = 
Pack”
<
T
>::
	`»·ck
(
	`t
()->
buf_
, i‹m().rd©a_.v, 
¡d
::
	`move
(
sd©a
));

1262  *
this
;

1263 
	}
}

1265 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	gT¿n§ùiÚ
& 
	gtxn
);

1266 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	gTe¡T¿n§ùiÚ
& 
	gtxn
);

1267 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	gT¿n§ùiÚGu¬d
& 
	gtxn
);

	@sto-core/VersionBase.hh

1 #´agm¨
Úû


3 
	~<c¡dšt
>

4 
	~<ÿs£¹
>

5 
	~<io¡»am
>

7 
	~"comp”.hh
"

8 
	~"T¿nsI‹m.hh
"

9 
	~"TTh»ad.hh
"

11 şas 
	cT¿n§ùiÚTid
 {

12 
	mpublic
:

13 
WideTid
::
	tsšgË_ty³
 
	tty³
;

14 
	mWideTid
::
	tsigÃd_sšgË_ty³
 
	tsigÃd_ty³
;

21 
cÚ¡ex´
 
sigÃd_ty³
 
	mmask_width
 = 7;

24 
cÚ¡ex´
 
ty³
 
	mth»adid_mask
 =ype(0x7F);

26 
cÚ¡ex´
 
ty³
 
	mlock_b™
 =y³(0x1 << 
mask_width
);

30 
cÚ¡ex´
 
ty³
 
	mnÚİaque_b™
 =y³(0x1 << (
mask_width
 + 1));

33 
cÚ¡ex´
 
ty³
 
	mu£r_b™
 =y³(0x1 << (
mask_width
 + 2));

35 
cÚ¡ex´
 
ty³
 
	mdœty_b™
 =y³(0x1 << (
mask_width
 + 3));

38 
cÚ¡ex´
 
ty³
 
	mİt_b™
 =y³(0x1 << (
mask_width
 + 4));

40 
cÚ¡ex´
 
ty³
 
	mšüem’t_v®ue
 =y³(0x1 << (
mask_width
 + 5));

42 
boŞ
 
	$is_locked
(
ty³
 
v
) {

43  (
v
 & 
lock_b™
) != 0;

45 
boŞ
 
	$is_dœty
(
ty³
 
v
) {

46  (
v
 & 
dœty_b™
) != 0;

47 
	}
}

48 
boŞ
 
	$is_İtimi¡ic
(
ty³
 
v
) {

49  (
v
 & 
İt_b™
) != 0;

50 
	}
}

51 
boŞ
 
	$is_locked_h”e
(
ty³
 
v
) {

52  (
v
 & (
lock_b™
 | 
th»adid_mask
)è=ğÖock_b™ | 
TTh»ad
::
	`id
());

53 
	}
}

54 
boŞ
 
	$is_locked_h”e
(
ty³
 
v
, 
h”e
) {

55  (
v
 & (
lock_b™
 | 
th»adid_mask
)è=ğÖock_b™ | 
h”e
);

56 
	}
}

57 
boŞ
 
	$is_locked_–£wh”e
(
ty³
 
v
) {

58 
ty³
 
m
 = 
v
 & 
lock_b™
;

59 
ty³
 
t
 = 
v
 & 
th»adid_mask
;

60  
m
 !ğ0 && (
t
 !ğ(
ty³
)
TTh»ad
::
	`id
());

61 
	}
}

62 
boŞ
 
	$is_locked_–£wh”e
(
ty³
 
v
, 
h”e
) {

63 
ty³
 
m
 = 
v
 & 
lock_b™
;

64 
ty³
 
t
 = 
v
 & 
th»adid_mask
;

65  
m
 !ğ0 && 
t
 !ğ(
ty³
)
h”e
;

66 
	}
}

67 
boŞ
 
	$£t_lock
(
ty³
& 
v
) {

68 
v
 = v | 
lock_b™
 | 
TTh»ad
::
	`id
();

69  
Œue
;

70 
	}
}

71 
boŞ
 
	$Œy_lock
(
ty³
& 
v
) {

72 
ty³
 
vv
 = 
v
;

73  
	`boŞ_cmpxchg
(&
v
, 
vv
 & ~
lock_b™
, vv |†ock_b™ | 
TTh»ad
::
	`id
());

74 
	}
}

75 
ty³
 
	$Œy_lock_v®
(
ty³
& 
v
) {

76 
ty³
 
vv
 = 
v
;

77 
ty³
 
ex³ùed
 = 
vv
 & ~
lock_b™
;

78 
ty³
 
desœed
 = 
vv
 | 
lock_b™
 | 
TTh»ad
::
	`id
();

79 
ty³
 
Şd
 = 
	`cmpxchg
(&
v
, 
ex³ùed
, 
desœed
);

80 ià(
Şd
 =ğ
ex³ùed
)

81  
desœed
;

83  
Şd
;

84 
	}
}

85 
boŞ
 
	$Œy_lock
(
ty³
& 
v
, 
h”e
) {

86 
ty³
 
vv
 = 
v
;

87  
	`boŞ_cmpxchg
(&
v
, 
vv
 & ~
lock_b™
, vv |†ock_b™ | 
h”e
);

88 
	}
}

89 
	$lock
(
ty³
& 
v
) {

90 !
	`Œy_lock
(
v
))

91 
	`»Ïx_ãnû
();

92 
	`acquœe_ãnû
();

93 
	}
}

94 
	$lock
(
ty³
& 
v
, 
h”e
) {

95 !
	`Œy_lock
(
v
, 
h”e
))

96 
	`»Ïx_ãnû
();

97 
	`acquœe_ãnû
();

98 
	}
}

99 
	$uÆock
(
ty³
& 
v
) {

101 
ty³
 
Ãw_v
 = 
v
 & ~(
lock_b™
 | 
th»adid_mask
);

102 
	`»Ëa£_ãnû
();

103 
v
 = 
Ãw_v
;

104 
	}
}

105 
	$uÆock_dœty
(
ty³
& 
v
) {

106 
ty³
 
Ãw_v
 = 
v
 & ~(
lock_b™
 | 
dœty_b™
 | 
th»adid_mask
);

107 
	`»Ëa£_ãnû
();

108 
v
 = 
Ãw_v
;

109 
	}
}

110 
	$uÆock
(
ty³
& 
v
, 
h”e
) {

111 (è
h”e
;

112 
	`as£¹
(
	`is_locked_h”e
(
v
, 
h”e
));

113 
ty³
 
Ãw_v
 = 
v
 & ~(
lock_b™
 | 
th»adid_mask
);

114 
	`»Ëa£_ãnû
();

115 
v
 = 
Ãw_v
;

116 
	}
}

117 
ty³
 
	$uÆocked
(
ty³
 
v
) {

118  
v
 & ~(
lock_b™
 | 
th»adid_mask
);

119 
	}
}

121 
	$£t_v”siÚ
(
ty³
& 
v
,y³ 
Ãw_v
) {

122 
	`as£¹
(
	`is_locked_h”e
(
v
));

123 
	`as£¹
(!(
Ãw_v
 & (
lock_b™
 | 
th»adid_mask
)));

124 
Ãw_v
 |ğ
lock_b™
 | 
TTh»ad
::
	`id
();

125 
	`»Ëa£_ãnû
();

126 
v
 = 
Ãw_v
;

127 
	}
}

128 
	$£t_v”siÚ
(
ty³
& 
v
,y³ 
Ãw_v
, 
h”e
) {

129 
	`as£¹
(
	`is_locked_h”e
(
v
, 
h”e
));

130 
	`as£¹
(!(
Ãw_v
 & (
lock_b™
 | 
th»adid_mask
)));

131 
Ãw_v
 |ğ
lock_b™
 | 
h”e
;

132 
	`»Ëa£_ãnû
();

133 
v
 = 
Ãw_v
;

134 
	}
}

135 
	$£t_v”siÚ_locked
(
ty³
& 
v
,y³ 
Ãw_v
) {

136 
	`as£¹
(
	`is_locked_h”e
(
v
));

137 
	`as£¹
(
	`is_locked_h”e
(
Ãw_v
));

138 
	`»Ëa£_ãnû
();

139 
v
 = 
Ãw_v
;

140 
	}
}

141 
	$£t_v”siÚ_locked
(
ty³
& 
v
,y³ 
Ãw_v
, 
h”e
) {

142 (è
h”e
;

143 
	`as£¹
(
	`is_locked_h”e
(
v
, 
h”e
));

144 
	`as£¹
(
	`is_locked_h”e
(
Ãw_v
, 
h”e
));

145 
	`»Ëa£_ãnû
();

146 
v
 = 
Ãw_v
;

147 
	}
}

148 
	$£t_v”siÚ_uÆock
(
ty³
& 
v
,y³ 
Ãw_v
) {

151 
Ãw_v
 &ğ~(
lock_b™
 | 
th»adid_mask
);

152 
	`»Ëa£_ãnû
();

153 
v
 = 
Ãw_v
;

154 
	}
}

155 
	$£t_v”siÚ_uÆock
(
ty³
& 
v
,y³ 
Ãw_v
, 
h”e
) {

156 (è
h”e
;

157 
	`as£¹
(
	`is_locked_h”e
(
v
, 
h”e
));

158 
	`as£¹
(!
	`is_locked
(
Ãw_v
è|| 
	`is_locked_h”e
Òew_v, 
h”e
));

159 
Ãw_v
 &ğ~(
lock_b™
 | 
th»adid_mask
);

160 
	`»Ëa£_ãnû
();

161 
v
 = 
Ãw_v
;

162 
	}
}

163 
	$£t_v”siÚ_uÆock_dœty
(
ty³
&
v
,y³ 
Ãw_v
) {

164 
Ãw_v
 &ğ~(
lock_b™
 | 
dœty_b™
 | 
th»adid_mask
);

165 
	`»Ëa£_ãnû
();

166 
v
 = 
Ãw_v
;

167 
	}
}

169 
	$£t_nÚİaque
(
ty³
& 
v
) {

170 
v
 |ğ
nÚİaque_b™
;

171 
	}
}

172 
ty³
 
	$Ãxt_nÚİaque_v”siÚ
(
ty³
 
v
) {

173  (
v
 + 
šüem’t_v®ue
è| 
nÚİaque_b™
;

174 
	}
}

175 
ty³
 
	$Ãxt_unæagged_v”siÚ
(
ty³
 
v
) {

176  ((
v
 + 
šüem’t_v®ue
) & ~(increment_value - 1));

177 
	}
}

178 
ty³
 
	$Ãxt_unæagged_nÚİaque_v”siÚ
(
ty³
 
v
) {

179  
	`Ãxt_unæagged_v”siÚ
(
v
è| 
nÚİaque_b™
;

180 
	}
}

181 
	$šc_nÚİaque_v”siÚ
(
ty³
& 
v
) {

182 
	`as£¹
(
	`is_locked_h”e
(
v
));

183 
ty³
 
Ãw_v
 = (
v
 + 
šüem’t_v®ue
è| 
nÚİaque_b™
;

184 
	`»Ëa£_ãnû
();

185 
v
 = 
Ãw_v
;

186 
	}
}

188 
boŞ
 
	$check_v”siÚ
(
ty³
 
cur_v”s
,y³ 
Şd_v”s
) {

193  (
cur_v”s
 & ~(
šüem’t_v®ue
 - 1)è=ğ(
Şd_v”s
 & ~(increment_value - 1));

195 
	}
}

196 
boŞ
 
	$check_v”siÚ
(
ty³
 
cur_v”s
,y³ 
Şd_v”s
, 
h”e
) {

197 
	`as£¹
(!
	`is_locked_–£wh”e
(
Şd_v”s
));

199 ià((
cur_v”s
 & 
lock_b™
è&& ((cur_v” & 
th»adid_mask
è!ğ(
ty³
)
h”e
))

200  
çl£
;

201  (
cur_v”s
 & ~(
šüem’t_v®ue
 - 1)è=ğ(
Şd_v”s
 & ~(increment_value - 1));

203 
	}
}

204 
boŞ
 
	$Œy_check_İac™y
(
ty³
 
¡¬t_tid
,y³ 
v
) {

205 
sigÃd_ty³
 
d–
 = 
¡¬t_tid
 - 
v
;

206  
d–
 > 0 && !(
v
 & (
lock_b™
 | 
nÚİaque_b™
));

207 
	}
}

209 
	$´št
(
ty³
 
v
, 
¡d
::
o¡»am
& 
w
) {

210 autØ
f
 = 
w
.
	`æags
();

211 
w
 << 
¡d
::
hex
 << (
v
 & ~(
šüem’t_v®ue
 - 1));

212 
v
 &ğ
šüem’t_v®ue
 - 1;

213 ià(
v
 & 
İt_b™
)

214 
w
 << "O";

215 ià(
v
 & 
dœty_b™
)

216 
w
 << "D";

217 ià(
v
 & 
u£r_b™
)

218 
w
 << "U";

219 ià(
v
 & 
nÚİaque_b™
)

220 
w
 << "!";

221 ià(
v
 & 
lock_b™
)

222 
w
 << "L";

224 
w
 << ".0x" << 
¡d
::
hex
 << (
v
 & 
th»adid_mask
);

225 
w
.
	`æags
(
f
);

226 
	}
}

229 
cÚ¡ex´
 
	gT¿n§ùiÚTid
::
ty³
 
š™Ÿlized_tid
 = 
T¿n§ùiÚTid
::
šüem’t_v®ue
;

232 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

233 şas 
	cV”siÚBa£
 {

234 
	mpublic
:

235 
T¿n§ùiÚTid
::
	tty³
ype;

237 
	$V”siÚBa£
(è: 
	$v_
(
š™Ÿlized_tid
) {}

238 
ex¶ic™
 
	$V”siÚBa£
(
ty³
 
v
è: 
	$v_
(
v
è{
	}
}

240 
ty³
 
	$v®ue
() const {

241  
v_
;

242 
	}
}

243 vŞ©
	gty³
& 
	$v®ue
() {

244  
v_
;

245 
	}
}

249 
boŞ
 
	$ı_Œy_lock
(
T¿nsI‹m
& 
™em
, 
th»ad_id
) {

250  
	`im¶
().
	`ı_Œy_lock_im¶
(
™em
, 
th»ad_id
);

251 
	}
}

252 
	$ı_uÆock
(
T¿nsI‹m
& 
™em
) {

253 
	`im¶
().
	`ı_uÆock_im¶
(
™em
);

254 
	}
}

257 
	gty³
& 
	$ı_acûss_tid
(
T¿n§ùiÚ
& 
txn
) {

258  
V”sIm¶
::
	`ı_acûss_tid_im¶
(
txn
);

259 
	}
}

260 
ty³
 
	$ı_comm™_tid
(
T¿n§ùiÚ
& 
txn
) {

261  
	`im¶
().
	`ı_comm™_tid_im¶
(
txn
);

262 
	}
}

265 
	$ı_£t_v”siÚ_uÆock
(
ty³
 
Ãw_v
) {

266 
	`im¶
().
	`ı_£t_v”siÚ_uÆock_im¶
(
Ãw_v
);

267 
	}
}

268 
	$ı_£t_v”siÚ
(
ty³
 
Ãw_v
) {

269 
	`im¶
().
	`ı_£t_v”siÚ_im¶
(
Ãw_v
);

270 
	}
}

272 
boŞ
 
	$ı_check_v”siÚ
(
T¿n§ùiÚ
& 
txn
, 
T¿nsI‹m
& 
™em
) {

273  
	`im¶
().
	`ı_check_v”siÚ_im¶
(
txn
, 
™em
);

274 
	}
}

277 
boŞ
 
	$acquœe_wr™e
(
T¿nsI‹m
& 
™em
) {

278  
	`im¶
().
	`acquœe_wr™e_im¶
(
™em
);

279 
	}
}

280 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

281 
boŞ
 
	$acquœe_wr™e
(
T¿nsI‹m
& 
™em
, cÚ¡ 
T
& 
wd©a
) {

282  
	`im¶
().
	`acquœe_wr™e_im¶
(
™em
, 
wd©a
);

283 
	}
}

284 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

285 
boŞ
 
	$acquœe_wr™e
(
T¿nsI‹m
& 
™em
, 
T
&& 
wd©a
) {

286  
	`im¶
().
	`acquœe_wr™e_im¶
(
™em
, 
wd©a
);

287 
	}
}

288 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

289 
boŞ
 
	$acquœe_wr™e
(
T¿nsI‹m
& 
™em
, 
Args
&&... 
¬gs
) {

290  
	`im¶
().
	`acquœe_wr™e_im¶
(
™em
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

291 
	}
}

293 
boŞ
 
	$ob£rve_»ad
(
T¿nsI‹m
& 
™em
) {

294  
	`ob£rve_»ad
(
™em
, 
Œue
);

295 
	}
}

296 
boŞ
 
	$ob£rve_»ad
(
T¿nsI‹m
& 
™em
, 
boŞ
 
add_»ad
) {

297  
	`im¶
().
	`ob£rve_»ad_im¶
(
™em
, 
add_»ad
);

298 
	}
}

302 
	$šc_nÚİaque
() {

303 
	`im¶
().
	`šc_nÚİaque_im¶
();

304 
	}
}

305 
	$lock_exşusive
() {

306 
	`im¶
().
	`lock_exşusive_im¶
();

307 
	}
}

308 
	$uÆock_exşusive
() {

309 
	`im¶
().
	`uÆock_exşusive_im¶
();

310 
	}
}

311 
ty³
 
	$uÆocked_v®ue
() const {

312  
	`im¶
().
	`uÆocked_v®ue_im¶
();

313 
	}
}

315 
	$compu‹_comm™_ts_¡•
(
ty³
& 
comm™_ts
, 
boŞ
 
is_wr™e
) {

316 
	`im¶
().
	`compu‹_comm™_ts_¡•_im¶
(
comm™_ts
, 
is_wr™e
);

317 
	}
}

319 
	g´Ùeùed
:

320 
ty³
 
v_
;

322 
	gV”sIm¶
& 
	$im¶
() {

323  
¡©ic_ÿ¡
<
V”sIm¶
&>(*
this
);

324 
	}
}

325 cÚ¡ 
	gV”sIm¶
& 
	$im¶
() const {

326  
¡©ic_ÿ¡
<cÚ¡ 
V”sIm¶
&>(*
this
);

327 
	}
}

330 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

331 
şass
 
	gBasicV”siÚ
 : 
public
 
V”siÚBa£
<
V”sIm¶
> {

332 
public
:

333 
T¿n§ùiÚTid
::
	tty³
ype;

335 
usšg
 
	gBa£
 = 
V”siÚBa£
<
V”sIm¶
>;

336 
usšg
 
	gBa£
::
v_
;

338 
BasicV”siÚ
() = ;

339 
ex¶ic™
 
BasicV”siÚ
(
ty³
 
v
)

340 : 
Ba£
(
v
) {}

342 
boŞ
 
İ”©Ü
==(
BasicV”siÚ
 
x
) const {

343  
v_
 =ğ
x
.v_;

345 
boŞ
 
	gİ”©Ü
!=(
BasicV”siÚ
 
x
) const {

346  
v_
 !ğ
x
.v_;

348 
BasicV”siÚ
 
	gİ”©Ü
|(BasicV”siÚ 
	gx
) const {

349  
BasicV”siÚ
(
v_
 | 
x
.v_);

351 
ty³
 
	gİ”©Ü
&(
	gT¿n§ùiÚTid
::ty³ 
x
) const {

352  (
v_
 & 
x
);

355 
boŞ
 
boŞ_cmpxchg
(
BasicV”siÚ
 
ex³ùed
, BasicV”siÚ 
desœed
) {

356  ::
boŞ_cmpxchg
(&
v_
, 
ex³ùed
.v_, 
desœed
.v_);

362 
boŞ
 
ı_Œy_lock_im¶
(
T¿nsI‹m
& 
™em
, 
th»adid
) {

363 ()
	g™em
;

364  
	gT¿n§ùiÚTid
::
Œy_lock
(
v_
, 
th»adid
);

366 
ı_uÆock_im¶
(
T¿nsI‹m
& 
™em
) {

367 ()
	g™em
;

368 
	gT¿n§ùiÚTid
::
uÆock
(
v_
);

370 
ı_£t_v”siÚ_uÆock_im¶
(
ty³
 
Ãw_v
) {

371 
	gT¿n§ùiÚTid
::
£t_v”siÚ_uÆock
(
v_
, 
Ãw_v
);

373 
ı_£t_v”siÚ_im¶
(
ty³
 
Ãw_v
) {

374 
	gT¿n§ùiÚTid
::
£t_v”siÚ
(
v_
, 
Ãw_v
);

377 
compu‹_comm™_ts_¡•_im¶
(
ty³
& 
ts
, 
boŞ
 
is_wr™e
) {

378 ()
	gts
; ()
	gis_wr™e
;

381 
šc_nÚİaque_im¶
() {

382 
	gT¿n§ùiÚTid
::
šc_nÚİaque_v”siÚ
(
v_
);

384 
lock_exşusive_im¶
() {

385 
	gT¿n§ùiÚTid
::
lock
(
v_
);

387 
uÆock_exşusive_im¶
() {

388 
	gT¿n§ùiÚTid
::
uÆock
(
v_
);

390 
ty³
 
uÆocked_v®ue_im¶
() const {

391  
	gT¿n§ùiÚTid
::
uÆocked
(
v_
);

394 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
);

395 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

396 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, cÚ¡ 
T
& 
wd©a
);

397 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

398 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
T
&& 
wd©a
);

399 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

400 
šlše
 
boŞ
 
acquœe_wr™e_im¶
(
T¿nsI‹m
& 
™em
, 
Args
&&... 
¬gs
);

402 
ä›nd
 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, 
BasicV”siÚ
 
	gv
) {

403 
	gT¿n§ùiÚTid
::
´št
(
v
.
v®ue
(), 
w
);

404  
	gw
;

407 
	g‹m¶©e
 <
ty³Çme
 
	gExû±iÚ
>

408 
šlše
 
İaque_throw
(cÚ¡ 
Exû±iÚ
& 
exû±iÚ
) {

409 
throw
 
	gexû±iÚ
;

412 
boŞ
 
is_locked
() const {

413  
	gT¿n§ùiÚTid
::
is_locked
(
v_
);

415 
boŞ
 
is_locked_h”e
() const {

416  
	gT¿n§ùiÚTid
::
is_locked_h”e
(
v_
);

418 
boŞ
 
is_locked_h”e
(
h”e
) const {

419  
	gT¿n§ùiÚTid
::
is_locked_h”e
(
v_
, 
h”e
);

421 
boŞ
 
is_locked_–£wh”e
() const {

422  
	gT¿n§ùiÚTid
::
is_locked_–£wh”e
(
v_
);

424 
boŞ
 
is_locked_–£wh”e
(
h”e
) const {

425  
	gT¿n§ùiÚTid
::
is_locked_–£wh”e
(
v_
, 
h”e
);

427 
boŞ
 
is_dœty
() const {

428  
	gT¿n§ùiÚTid
::
is_dœty
(
v_
);

430 
£t_nÚİaque
() {

431 
	gT¿n§ùiÚTid
::
£t_nÚİaque
(
v_
);

434 
boŞ
 
check_v”siÚ
(
BasicV”siÚ
 
Şd_v”s
) const {

435  
	gT¿n§ùiÚTid
::
check_v”siÚ
(
v_
, 
Şd_v”s
.v_);

437 
boŞ
 
check_v”siÚ
(
BasicV”siÚ
 
Şd_v”s
, 
h”e
) const {

438  
	gT¿n§ùiÚTid
::
check_v”siÚ
(
v_
, 
Şd_v”s
.v_, 
h”e
);

	@sto-core/VersionSelector.hh

1 #´agm¨
Úû


3 
	~"V”siÚBa£.hh
"

5 
Çme¥aû
 
	gv”_£l
 {

11 
	gT¿n§ùiÚTid
::
	tty³
ype;

14 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gV”sIm¶
>

15 şas 
	cV”S–Ba£
 {

16 
	gpublic
:

17 
V”sIm¶
 
	tv”siÚ_ty³
;

19 
m­
(
cŞ_n
) {

20  
	gT
::
m­_im¶
(
cŞ_n
);

23 
	gv”siÚ_ty³
& 
v”siÚ_©
(
ûÎ
) {

24  
im¶
().
v”siÚ_©_im¶
(
ûÎ
);

27 
	g‹m¶©e
 <
ty³Çme
 
	gRowTy³
>

28 
š¡®l_by_ûÎ
(
RowTy³
 *
d¡
, cÚ¡ RowTy³ *
¤c
, 
ûÎ
) {

29  
im¶
().
š¡®l_by_ûÎ_im¶
(
d¡
, 
¤c
, 
ûÎ
);

32 
	g´iv©e
:

33 
T
& 
im¶
() {

34  
¡©ic_ÿ¡
<
T
&>(*
this
);

36 cÚ¡ 
	gT
& 
im¶
() const {

37  
	g¡©ic_ÿ¡
<cÚ¡ 
	gT
&>(*
	gthis
);

43 
	g‹m¶©e
 <
ty³Çme
 
	gRowTy³
,y³Çm
	gV”sIm¶
>

44 
şass
 
	gV”S–
 : 
public
 
V”S–Ba£
<
V”S–
<
RowTy³
, 
	gV”sIm¶
>, VersImpl> {

45 
	gpublic
:

46 
V”sIm¶
 
	tv”siÚ_ty³
;

47 
cÚ¡ex´
 
size_t
 
	gnum_v”siÚs
 = 1;

49 
ex¶ic™
 
V”S–
(
ty³
 
v
è: 
v”s_
(v) {}

50 
V”S–
(
ty³
 
v
, 
boŞ
 
š£¹
è: 
v”s_
(v, insert) {}

52 
m­_im¶
(
cŞ_n
) {

53 ()
	gcŞ_n
;

57 
	gv”siÚ_ty³
& 
v”siÚ_©_im¶
(
ûÎ
) {

58 ()
	gûÎ
;

59  
	gv”s_
;

62 
š¡®l_by_ûÎ_im¶
(
RowTy³
 *
d¡
, cÚ¡ RowTy³ *
¤c
, 
ûÎ
) {

63 ()
	gûÎ
;

64 *
	gd¡
 = *
¤c
;

67 
	g´iv©e
:

68 
v”siÚ_ty³
 
v”s_
;

74 
	g‹m¶©e
 <
ty³Çme
 
	gRowTy³
,y³Çm
	gV”sIm¶
>

75 
şass
 
	gIndexV®ueCÚš”
 : 
v”_£l
::
V”S–
<
RowTy³
, 
	gV”sIm¶
> {

76 
	gpublic
:

77 
T¿n§ùiÚTid
::
	tty³
ype;

78 
usšg
 
	gS–eùÜ
 = 
v”_£l
::
V”S–
<
RowTy³
, 
	gV”sIm¶
>;

79 
ty³Çme
 
	tS–eùÜ
::
	tv”siÚ_ty³
 version_type;

80 
usšg
 
	gS–eùÜ
::
m­
;

81 
usšg
 
	gS–eùÜ
::
v”siÚ_©
;

82 
usšg
 
	gS–eùÜ
::
num_v”siÚs
;

84 
IndexV®ueCÚš”
(
ty³
 
v
, cÚ¡ 
RowTy³
& 
r
è: 
S–eùÜ
(v), 
row
(r) {}

85 
IndexV®ueCÚš”
(
ty³
 
v
, 
boŞ
 
š£¹
, cÚ¡ 
RowTy³
& 
r
è: 
S–eùÜ
(v, in£¹), 
row
(r) {}

87 
RowTy³
 
	grow
;

89 
š¡®l_ûÎ
(
ûÎ
, cÚ¡ 
RowTy³
 *
Ãw_row
) {

90 
	gS–eùÜ
::
š¡®l_by_ûÎ
(&
row
, 
Ãw_row
, 
ûÎ
);

94 
	gv”siÚ_ty³
& 
row_v”siÚ
() {

95  
v”siÚ_©
(0);

106 
	sexam¶e_row
 {

107 şas 
	cNamedCŞumn
 : { 
ytd
 = 0, 
	m·ym’t_út
, 
	md©e
, 
	mx
, 
	mÃxt_oid
 };

109 
ušt32_t
 
	gd_ytd
;

110 
ušt32_t
 
	gd_·ym’t_út
;

111 
ušt32_t
 
	gd_d©e
;

112 
ušt32_t
 
	gd_x
;

113 
ušt32_t
 
	gd_Ãxt_oid
;

125 
Çme¥aû
 
	gv”_£l
 {

128 
	g‹m¶©e
 <
ty³Çme
 
	gV”sIm¶
>

129 
şass
 
	gV”S–
<
	gexam¶e_row
, 
	gV”sIm¶
> : 
public
 
V”S–Ba£
<
V”S–
<
exam¶e_row
, VersImpl>, VersImpl> {

130 
	gpublic
:

131 
V”sIm¶
 
	tv”siÚ_ty³
;

132 
cÚ¡ex´
 
size_t
 
	gnum_v”siÚs
 = 2;

134 
ex¶ic™
 
V”S–
(
ty³
 
v
è: 
v”s_
() {

135 
Ãw
 (&
v”s_
[0]è
v”siÚ_ty³
(
v
);

137 
V”S–
(
ty³
 
v
, 
boŞ
 
š£¹
è: 
v”s_
() {

138 
Ãw
 (&
v”s_
[0]è
v”siÚ_ty³
(
v
, 
š£¹
);

141 
m­_im¶
(
cŞ_n
) {

142 ià(
	gcŞ_n
 == 0)

148 
	gv”siÚ_ty³
& 
v”siÚ_©_im¶
(
ûÎ
) {

149  
	gv”s_
[
ûÎ
];

152 
š¡®l_by_ûÎ_im¶
(
exam¶e_row
 *
d¡
, cÚ¡ƒxam¶e_row *
¤c
, 
ûÎ
) {

153 ià(
	gûÎ
 == 0) {

154 
d¡
->
d_ytd
 = 
¤c
->d_ytd;

156 
	gd¡
->
	gd_·ym’t_út
 = 
¤c
->
d_·ym’t_út
;

157 
	gd¡
->
	gd_d©e
 = 
¤c
->
d_d©e
;

158 
	gd¡
->
	gd_x
 = 
¤c
->
d_x
;

159 
	gd¡
->
	gd_Ãxt_oid
 = 
¤c
->
d_Ãxt_oid
;

163 
	g´iv©e
:

164 
v”siÚ_ty³
 
v”s_
[
num_v”siÚs
];

	@sto-core/codegen/driver.cpp

1 
	~<cùy³
>

2 
	~<f¡»am
>

3 
	~<ÿs£¹
>

5 
	~"driv”.hµ
"

7 
	gMC
::
MC_Driv”
::~
	$MC_Driv”
()

9 
	`d–‘e
(
sÿÂ”
);

10 
sÿÂ”
 = 
nuÎ±r
;

11 
	`d–‘e
(
·r£r
);

12 
·r£r
 = 
nuÎ±r
;

13 
	}
}

16 
	gMC
::
MC_Driv”
::
·r£
ĞcÚ¡ * cÚ¡ 
f’ame
, 
¡d
::
veùÜ
<
SŒuùS³c
> &
»suÉ
 )

18 
as£¹
Ğ
f’ame
 !ğ
nuÎ±r
 );

19 
	g¡d
::
if¡»am
 
š_fe
Ğ
f’ame
 );

20 ifĞ! 
	gš_fe
.
good
() )

22 
ex™
Ğ
EXIT_FAILURE
 );

24 
·r£_h–³r
Ğ
š_fe
, 
»suÉ
 );

29 
	gMC
::
MC_Driv”
::
·r£
Ğ
¡d
::
i¡»am
 &
¡»am
, std::
veùÜ
<
SŒuùS³c
> &
»suÉ
 )

31 ifĞ! 
¡»am
.
good
(è&& sŒ—m.
eof
() )

36 
·r£_h–³r
Ğ
¡»am
, 
»suÉ
 );

42 
	gMC
::
MC_Driv”
::
·r£_h–³r
Ğ
¡d
::
i¡»am
 &
¡»am
, std::
veùÜ
<
SŒuùS³c
> &
»suÉ
 )

45 
d–‘e
(
sÿÂ”
);

46 
	gŒy


48 
	gsÿÂ”
 = 
Ãw
 
MC
::
MC_SÿÂ”
Ğ&
¡»am
 );

50 
ÿtch
Ğ
¡d
::
bad_®loc
 &
ba
 )

52 
¡d
::
û¼
 << "Failedo‡llocate scanner: (" <<

53 
ba
.
wh©
() << "),ƒxiting!!\n";

54 
ex™
Ğ
EXIT_FAILURE
 );

57 
d–‘e
(
·r£r
);

58 
	gŒy


60 
	g·r£r
 = 
Ãw
 
MC
::
MC_P¬£r
Ğ(*
sÿÂ”
) ,

61 (*
this
) ,

62 
»suÉ
 );

64 
ÿtch
Ğ
¡d
::
bad_®loc
 &
ba
 )

66 
¡d
::
û¼
 << "Failedo‡llocate…arser: (" <<

67 
ba
.
wh©
() << "),ƒxiting!!\n";

68 
ex™
Ğ
EXIT_FAILURE
 );

70 cÚ¡ 
acû±
( 0 );

71 ifĞ
	g·r£r
->
·r£
(è!ğ
acû±
 )

73 
¡d
::
û¼
 << "Parse failed!!\n";

	@sto-core/codegen/driver.hpp

1 #iâdeà
__MCDRIVER_HPP__


2 
	#__MCDRIVER_HPP__
 1

	)

4 
	~<¡ršg
>

5 
	~<c¡ddef
>

6 
	~<i¡»am
>

8 
	~"sÿÂ”.hµ
"

9 
	~"·r£r.b.hh
"

12 
Çme¥aû
 
	gMC
{

14 şas 
	cMC_Driv”
{

15 
	gpublic
:

16 
MC_Driv”
() = ;

18 
	gvœtu®
 ~
MC_Driv”
();

24 
·r£
ĞcÚ¡ * cÚ¡ 
f’ame
, 
¡d
::
veùÜ
<
SŒuùS³c
> &
»suÉ
 );

29 
·r£
Ğ
¡d
::
i¡»am
 &
iss
, std::
veùÜ
<
SŒuùS³c
> &
»suÉ
 );

31 
	g´iv©e
:

33 
·r£_h–³r
Ğ
¡d
::
i¡»am
 &
¡»am
, std::
veùÜ
<
SŒuùS³c
> &
»suÉ
 );

35 
	gMC
::
MC_P¬£r
 *
·r£r
 = 
nuÎ±r
;

36 
	gMC
::
MC_SÿÂ”
 *
sÿÂ”
 = 
nuÎ±r
;

	@sto-core/codegen/lexer.l

3 
	~<¡ršg
>

6 
	~"sÿÂ”.hµ
"

7 #undeà
YY_DECL


8 
	#YY_DECL
 
MC
::
MC_SÿÂ”
::
	`yyËx
ĞMC::
MC_P¬£r
::
£mªtic_ty³
 * cÚ¡ 
lv®
, MC::MC_P¬£r::
loÿtiÚ_ty³
 *
loc
 )

	)

11 
usšg
 
	gtok’
 = 
MC
::
MC_P¬£r
::
tok’
;

14 
	#yy‹rmš©e
(èĞ
tok’
::
END
 )

	)

17 
	#YY_NO_UNISTD_H


	)

20 
	#YY_USER_ACTION
 
loc
->
	`¡•
();†oc->
	`cŞumns
(
yyËng
);

	)

24 %
İtiÚ
 
debug


25 %
İtiÚ
 
nodeçuÉ


26 %
İtiÚ
 
yyşass
="MC::MC_Scanner"

27 %
İtiÚ
 
noyyw¿p


28 %
İtiÚ
 
c
++

30 %% /* 
	$yyËx
 */

32 
	gyylv®
 = 
lv®
;

36 Ğ
tok’
::
AT
 );

39 @
f›lds
 {

40 Ğ
tok’
::
FIELDS
 );

43 @
groups
 {

44 Ğ
tok’
::
GROUPS
 );

47 @
Çme
 {

48  ( 
tok’
::
NAME
 );

52  ( 
tok’
::
LPAREN
 );

56  ( 
tok’
::
RPAREN
 );

60  ( 
tok’
::
LBRACE
 );

64  ( 
tok’
::
RBRACE
 );

68  ( 
tok’
::
COLON
 );

72  ( 
tok’
::
COMMA
 );

76 
BIGINT
 {

77  ( 
tok’
::
BIGINT
 );

80 
SMALLINT
 {

81  ( 
tok’
::
SMALLINT
 );

84 
FLOAT
 {

85  ( 
tok’
::
FLOAT
 );

88 
VARCHAR
 {

89  ( 
tok’
::
VARCHAR
 );

92 
CHAR
 {

93  ( 
tok’
::
CHAR
 );

97 
yylv®
->
bud
<>(
	`©oi
(
yy‹xt
));

98  ( 
tok’
::
NUMBER
 );

101 [
a
-
zA
-
Z_
][a-zA-
Z0
-9
_
]+ {

109 
yylv®
->
bud
< 
¡d
::
¡ršg
 >Ğ
yy‹xt
 );

110 Ğ
tok’
::
IDENTIFIER
 );

113 \
n
 {

115 
loc
->
	`lšes
();

121 
	}
%%

	@sto-core/codegen/main.cpp

1 
	~<io¡»am
>

2 
	~<s¡»am
>

3 
	~<c¡dlib
>

4 
	~<c¡ršg
>

5 
	~<ÿs£¹
>

6 
	~<veùÜ
>

7 
	~<ut™y
>

8 
	~<¡ršg
>

10 
	~<m­
>

11 
	~<£t
>

13 
	~"driv”.hµ
"

15 cÚ¡ 
	g¡d
::
¡ršg
 
TName_¡r
[] = {"int64_t", "int32_t", "float", "var_string", "fix_string"};

17 
	$š‹g”_log2
(
ušt64_t
 
šput
) {

18 ià(
šput
 == 0 && input == 1)

20 
šput
 -= 1;

21 
log
 = 0;

22 
šput
è{ ++
log
; input >>= 1; }

23  
log
;

24 
	}
}

26 
	g¡d
::
¡ršg
 
	$cxx_ty³_Çme
(cÚ¡ 
F›ldTy³
& 
t
) {

27 
¡d
::
¡ršg¡»am
 
ss
;

28 
ss
 << 
TName_¡r
[
t
.
Šame
];

29 
	`as£¹
(
t
.
Šame
 >ğ
BigIÁ
 &&.Šam<ğ
Ch¬
);

30 ià(
t
.
Šame
 =ğ
V¬Ch¬
 ||.Šam=ğ
Ch¬
) {

31 
ss
 << '<' << 
t
.
Ën
 << '>';

33  
ss
.
	`¡r
();

34 
	}
}

36 
ušt64_t
 
	$ıp_cŞ_ûÎ_m­_ušt64
(
SŒuùS³c
& 
»suÉ
) {

37 
¡d
::
veùÜ
<> 
šts
;

38 auto& 
f›lds
 = 
»suÉ
.fields;

39 auto& 
groups
 = 
»suÉ
.groups;

41 
gidx_width
 = 
	`š‹g”_log2
(
groups
.
	`size
());

42 ià((
gidx_width
 * 
f›lds
.
	`size
()) > 64) {

43 
¡d
::
û¼
 << "CodeG’ E¼Ü: m­pšg infÜm©iÚ dÛ nÙ f™ ušt64_t" << std::
’dl
;

44 
	`abÜt
();

47 auto& 
f
 : 
f›lds
) {

48 
size_t
 
gidx
 = 0;

49 auto& 
g
 : 
groups
) {

50 ià(
¡d
::
	`fšd
(
g
.
	`begš
(), g.
	`’d
(), 
f
.
Çme
) != g.end()) {

52 
šts
.
	`push_back
(
gidx
);

55 ++
gidx
;

59 
ušt64_t
 
m­_v®
 = 0;

60 
shiá
 = 0;

61 autØ
i
 : 
šts
) {

62 
m­_v®
 +ğ
i
 << 
shiá
;

63 
shiá
 +ğ
gidx_width
;

66  
m­_v®
;

67 
	}
}

69 
	$´št_sšgË
(
SŒuùS³c
 &
»suÉ
) {

70 
usšg
 
Çme¥aû
 
¡d
;

72 
cout
 << "¡ruù‚ame: " << 
»suÉ
.
¡ruù_Çme
 << 
’dl
;

74 autØ&
f›lds
 = 
»suÉ
.fields;

75 
cout
 << "Numb” oàf›lds: " << 
f›lds
.
	`size
(è<< 
’dl
;

76 
size_t
 
i
 = 0; i < 
f›lds
.
	`size
(); ++i) {

77 
cout
 << 
f›lds
[
i
].
Çme
 << " " << 
	`cxx_ty³_Çme
(f›lds[i].
t
è<< 
’dl
;

80 autØ&
groups
 = 
»suÉ
.groups;

81 
cout
 << "Numb” oàgroups: " << 
groups
.
	`size
(è<< 
’dl
;

82 
size_t
 
i
 = 0; i < 
groups
.
	`size
(); ++i) {

83 
size_t
 
j
 = 0; j < 
groups
[
i
].
	`size
(); j++) {

84 
cout
 << 
groups
[
i
][
j
] << " ";

86 
cout
 << 
’dl
;

88 
	}
}

90 
´št
(
¡d
::
veùÜ
<
SŒuùS³c
> &
»suÉ
) {

91 
¡d
::
cout
 << "Prštšg„esuÉ..." << std::
’dl
;

92 autØ&
	g¥ec
 : 
»suÉ
) {

93 
´št_sšgË
(
¥ec
);

97 
boŞ
 
	$ty³_check_sšgË
(
SŒuùS³c
 &
»suÉ
) {

98 
¡d
::
£t
<¡d::
¡ršg
> 
f›ld_Çme_£t
;

99 auto& 
¡ruù_Çme
 = 
»suÉ
.struct_name;

100 auto& 
f›lds
 = 
»suÉ
.fields;

101 auto& 
f
 : 
f›lds
) {

102 ià(
f›ld_Çme_£t
.
	`fšd
(
f
.
Çme
è!ğf›ld_Çme_£t.
	`’d
()) {

103 
¡d
::
û¼
 << "E¼Ü: SŒuù " << 
¡ruù_Çme
 << " ha ¨du¶iÿ‹ f›ld‚am\"" << 
f
.
Çme
 << "\"" << std::
’dl
;

104  
çl£
;

106 
f›ld_Çme_£t
.
	`š£¹
(
f
.
Çme
);

109 
	`as£¹
(
f›ld_Çme_£t
.
	`size
(è=ğ
f›lds
.size());

111 auto& 
groups
 = 
»suÉ
.groups;

112 
¡d
::
£t
<¡d::
¡ršg
> 
group_âame_£t
;

113 
size_t
 
gf›lds
 = 0;

114 auto& 
g
 : 
groups
) {

115 auto& 
â
 : 
g
) {

116 ià(
f›ld_Çme_£t
.
	`fšd
(
â
è=ğf›ld_Çme_£t.
	`’d
()) {

117 
¡d
::
û¼
 << "E¼Ü: SŒuù " << 
¡ruù_Çme
 << " ha ¨f›ld \"" << 
â
 << "\"„eã»nûd buˆundeş¬ed" << std::
’dl
;

118  
çl£
;

120 ià(
group_âame_£t
.
	`fšd
(
â
è!ğgroup_âame_£t.
	`’d
()) {

121 
¡d
::
û¼
 << "E¼Ü: SŒuù " << 
¡ruù_Çme
 << " ha ¨f›ld \"" << 
â
 << "\"„eã»nûd iÀmuÉË groups" << std::
’dl
;

122  
çl£
;

124 
group_âame_£t
.
	`š£¹
(
â
);

126 
gf›lds
 +ğ
g
.
	`size
();

129 
	`as£¹
(
group_âame_£t
.
	`size
(è=ğ
f›ld_Çme_£t
.size());

130 
	`as£¹
(
group_âame_£t
.
	`size
(è=ğ
gf›lds
);

132  
Œue
;

133 
	}
}

135 
boŞ
 
ty³_check
(
¡d
::
veùÜ
<
SŒuùS³c
> &
»suÉ
) {

136 autØ&
¥ec
 : 
»suÉ
) {

137 ià(!
ty³_check_sšgË
(
¥ec
)) {

138  
çl£
;

141  
	gŒue
;

144 
	$g’”©e_code_sšgË_¡ruù
(
SŒuùS³c
 &
»suÉ
) {

145 
¡d
::
¡ršg¡»am
 
ss
;

146 cÚ¡ 
¡d
::
¡ršg
 
idt
 = " ";

147 
¡d
::
¡ršg
 
¡ruù_Çme
 = 
»suÉ
.struct_name;

149 auto& 
f›lds
 = 
»suÉ
.fields;

150 
ss
 << "// Defš™iÚ fÜ„owy³: " << 
¡ruù_Çme
 << 
¡d
::
’dl
;

153 
ss
 << "¡ruù " << 
¡ruù_Çme
 << " {" << 
¡d
::
’dl
 << std::endl;

155 
ss
 << 
idt
 << "enum class NamedColumn : int { ";

156 
size_t
 
i
 = 0;

157 auto& 
f
 : 
f›lds
) {

158 
ss
 << 
f
.
Çme
;

159 ià(
i
 == 0)

160 
ss
 << " = 0";

161 ià(
i
 !ğ(
f›lds
.
	`size
() - 1))

162 
ss
 << ", ";

163 ++
i
;

165 
ss
 << " };" << 
¡d
::
’dl
 << std::endl;

167 auto& 
f
 : 
f›lds
)

168 
ss
 << 
idt
 << 
	`cxx_ty³_Çme
(
f
.
t
è<< ' ' << f.
Çme
 << ';' << 
¡d
::
’dl
;

169 
ss
 << "};" << 
¡d
::
’dl
;

171 
ss
 << 
¡d
::
’dl
;

172 
¡d
::
cout
 << 
ss
.
	`¡r
(è<< std::
’dl
;

173 
	}
}

176 
	$g’”©e_code_sšgË_v”£l
(
SŒuùS³c
 &
»suÉ
) {

177 
¡d
::
¡ršg¡»am
 
ss
;

178 cÚ¡ 
¡d
::
¡ršg
 
idt
 = " ";

179 auto& 
¡ruù_Çme
 = 
»suÉ
.struct_name;

180 auto& 
groups
 = 
»suÉ
.groups;

181 autØ
gidx_width
 = 
	`š‹g”_log2
(
groups
.
	`size
());

184 
ss
 << "‹m¶©<ty³ÇmV”sIm¶>" << 
¡d
::
’dl
;

185 
ss
 << "şas V”S–<" << 
¡ruù_Çme
 << ", V”sIm¶> :…ubliøV”S–Ba£<V”S–<" << sŒuù_Çm<< ", V”sIm¶>, V”sIm¶> {" << 
¡d
::
’dl
;

186 
ss
 << "public:" << 
¡d
::
’dl
;

187 
ss
 << 
idt
 << "ty³deàV”sIm¶ v”siÚ_ty³;" << 
¡d
::
’dl
;

188 
ss
 << 
idt
 << "¡©iøcÚ¡ex´ size_ˆnum_v”siÚ ğ" << 
groups
.
	`size
(è<< ';' << 
¡d
::
’dl
 << std::endl;

190 
ss
 << 
idt
 << "ex¶ic™ V”S–Ñy³ vè: v”s_(è{ (void)v; }" << 
¡d
::
’dl
;

191 
ss
 << 
idt
 << "V”S–Ñy³ v, boŞ in£¹è: v”s_(è{ (void)v; (void)š£¹; }" << 
¡d
::
’dl
 << std::endl;

193 
ss
 << 
idt
 << "¡©iøšˆm­_im¶(šˆcŞ_nè{" << 
¡d
::
’dl
;

194 
ss
 << 
idt
 << idˆ<< "ušt64_ˆmask = ~(~0uÈ<< vidx_widthè;" << 
¡d
::
’dl
;

195 
ss
 << 
idt
 << idˆ<< "šˆshiá = cŞ_À* vidx_width;" << 
¡d
::
’dl
;

196 
ss
 << 
idt
 << idˆ<< "»tuº ((cŞ_ûÎ_m­ & (mask << shiá)è>> shiá);" << 
¡d
::
’dl
;

197 
ss
 << 
idt
 << '}' << 
¡d
::
’dl
 << std::endl;

199 
ss
 << 
idt
 << "v”siÚ_ty³& v”siÚ_©_im¶(šˆûÎè{" << 
¡d
::
’dl
;

200 
ss
 << 
idt
 << idˆ<< "»tuº v”s_[ûÎ];" << 
¡d
::
’dl
;

201 
ss
 << 
idt
 << '}' << 
¡d
::
’dl
 << std::endl;

203 
ss
 << 
idt
 << "void in¡®l_by_ûÎ_im¶(" << 
¡ruù_Çme
 << " *d¡, cÚ¡ " << sŒuù_Çm<< " *¤c, iÁ c–lè{" << 
¡d
::
’dl
;

204 
ss
 << 
idt
 << idˆ<< "sw™ch (ûÎè{" << 
¡d
::
’dl
;

206 
size_t
 
idx
 = 0;

207 auto& 
g
 : 
groups
) {

208 
ss
 << 
idt
 << idˆ<< "ÿ£ " << 
idx
 << ':' << 
¡d
::
’dl
;

209 auto& 
â
 : 
g
)

210 
ss
 << 
idt
 << idˆ<< idˆ<< "d¡->" << 
â
 << " = " << "¤c->" << fÀ<< ';' << 
¡d
::
’dl
;

211 
ss
 << 
idt
 << idˆ<< idˆ<< "b»ak;" << 
¡d
::
’dl
;

212 ++
idx
;

215 
ss
 << 
idt
 << idˆ<< "deçuÉ:" << 
¡d
::
’dl
;

216 
ss
 << 
idt
 << idˆ<< idˆ<< "®ways_as£¹(çl£, \"ûÎ id ouˆoàbound\\n\");" << 
¡d
::
’dl
;

217 
ss
 << 
idt
 << idˆ<< idˆ<< "b»ak;" << 
¡d
::
’dl
;

218 
ss
 << 
idt
 << idˆ<< '}' << 
¡d
::
’dl
;

219 
ss
 << 
idt
 << '}' << 
¡d
::
’dl
 << std::endl;

221 
ss
 << "´iv©e:" << 
¡d
::
’dl
;

222 
ss
 << 
idt
 << "v”siÚ_ty³ v”s_[num_v”siÚs];" << 
¡d
::
’dl
;

223 
ss
 << 
idt
 << "¡©iøcÚ¡ex´ unsigÃd iÁ vidx_width = " << 
gidx_width
 << "u;" << 
¡d
::
’dl
;

224 
ss
 << 
idt
 << "¡©iøcÚ¡ex´ ušt64_ˆcŞ_ûÎ_m­ = " << 
	`ıp_cŞ_ûÎ_m­_ušt64
(
»suÉ
è<< "ul;" << 
¡d
::
’dl
;

226 
ss
 << "};" << 
¡d
::
’dl
 << std::endl;

227 
¡d
::
cout
 << 
ss
.
	`¡r
(è<< std::
’dl
;

228 
	}
}

232 
g’”©e_code
(
¡d
::
veùÜ
<
SŒuùS³c
> &
»suÉ
) {

233 
¡d
::
cout
 << "#´agm¨Úû" << std::
’dl
 << std::endl;

236 
	g¡d
::
cout
 << "// ThfŞlowšg codi autom©iÿÎy g’”©ed by HaØ& Yihe' ·r£r/codeg’" << 
¡d
::
’dl
;

237 
	g¡d
::
cout
 << "// PËa£ dØnÙ mªu®ly modify!" << 
¡d
::
’dl
 << std::endl;

239 autØ&
	g¥ec
 : 
»suÉ
) {

240 
g’”©e_code_sšgË_¡ruù
(
¥ec
);

243 
	g¡d
::
cout
 << 
¡d
::
’dl
 << "namespace ver_sel {" << std::endl << std::endl;

244 autØ&
	g¥ec
 : 
»suÉ
) {

245 
g’”©e_code_sšgË_v”£l
(
¥ec
);

247 
	g¡d
::
cout
 << "}; //‚ame¥aû v”_£l" << 
¡d
::
’dl
;

250 
	$maš
(cÚ¡ 
¬gc
, cÚ¡ **
¬gv
) {

252 
¡d
::
veùÜ
<
SŒuùS³c
> 
»suÉ
;

253 ifĞ
¬gc
 == 2 ) {

254 
MC
::
MC_Driv”
 
driv”
;

256 ifĞ
¡d
::
	`¡ºcmp
Ğ
¬gv
[ 1 ], "-o", 2 ) == 0 ) {

257 
driv”
.
	`·r£
Ğ
¡d
::
cš
, 
»suÉ
 );

260 ifĞ
¡d
::
	`¡ºcmp
Ğ
¬gv
[ 1 ], "-h", 2 ) == 0 ) {

261 
¡d
::
cout
 << "use -o for…ipeo std::cin\n";

262 
¡d
::
cout
 << "just give‡ filenameo count from‡ file\n";

263 
¡d
::
cout
 << "use -ho gethis menu\n";

264 Ğ
EXIT_SUCCESS
 );

269 
driv”
.
	`·r£
Ğ
¬gv
[1], 
»suÉ
 );

273  ( 
EXIT_FAILURE
 );

277 ià(
»suÉ
.
	`em±y
()) {

278 
¡d
::
cout
 << "NØ¡ruùu» id’tif›d." << std::
’dl
;

279  ( 
EXIT_FAILURE
 );

284 ià(!
	`ty³_check
(
»suÉ
)) {

285 
¡d
::
cout
 << "Ty³ check”ƒ¼Ü: Ex™ed." << std::
’dl
;

286  ( 
EXIT_FAILURE
 );

289 
	`g’”©e_code
(
»suÉ
);

291 Ğ
EXIT_SUCCESS
 );

292 
	}
}

	@sto-core/codegen/scanner.hpp

1 #iâdeà
__MCSCANNER_HPP__


2 
	#__MCSCANNER_HPP__
 1

	)

4 #ià! 
defšed
(
yyFËxLex”Onû
)

5 
	~<FËxLex”.h
>

8 
	~"·r£r.b.hh
"

9 
	~"loÿtiÚ.hh
"

11 
Çme¥aû
 
	gMC
{

13 şas 
	cMC_SÿÂ”
 : 
public
 
yyFËxLex”
{

14 
public
:

16 
MC_SÿÂ”
(
¡d
::
i¡»am
 *
š
è: 
yyFËxLex”
(in)

19 
	gvœtu®
 ~
MC_SÿÂ”
() {

23 
usšg
 
	gFËxLex”
::
yyËx
;

25 
vœtu®


26 
yyËx
Ğ
MC
::
MC_P¬£r
::
£mªtic_ty³
 * cÚ¡ 
lv®
,

27 
MC
::
MC_P¬£r
::
loÿtiÚ_ty³
 *
loÿtiÚ
 );

32 
	g´iv©e
:

34 
MC
::
MC_P¬£r
::
£mªtic_ty³
 *
yylv®
 = 
nuÎ±r
;

	@sto-core/timing.hh

1 #´agm¨
Úû


2 
	~<¡dšt.h
>

3 
	~<time.h
>

5 
šlše
 
ušt64_t
 
	$g‘_şock_couÁ
() {

6 #ifdeà
__i386__


7 
ušt64_t
 
»t
;

8 
__asm__
 vŞ©("rdtsc" : "=A" (
»t
));

9  
»t
;

10 #–ià
__x86_64__


11 
ušt32_t
 
low
, 
high
;

12 
__asm__
 vŞ©e("rdtsc" : "÷" (
low
), "=d" (
high
));

13  (
ušt64_t
)
low
 | (((ušt64_t)
high
) << 32);

18 
	}
}

20 
šlše
 
	$wa™_cyşes
(
ušt64_t
 
cyşes
) {

21 
ušt64_t
 
¡¬t
 = 
	`g‘_şock_couÁ
();

22 
ušt64_t
 
’d
;

24 
Œue
) {

25 
’d
 = 
	`g‘_şock_couÁ
();

27 if(
’d
 - 
¡¬t
 > 
cyşes
) {

31 
	}
}

	@test/IntStr.hh

1 #´agm¨
Úû


2 
	~"¡r.hh
"

4 
	sIÁSŒ
 {

5 
	ms_
[16];

6 
	mlcdf
::
SŒ
 
¡r_
;

7 
IÁSŒ
(
i
) {

8 
	mn
 = 
¢´štf
(
s_
, (s_), "%d", 
i
);

9 
	m¡r_
.
assign
(
s_
, 
n
);

11 
	mlcdf
::
SŒ
& 
¡r
() {

12  
¡r_
;

14 
İ”©Ü
 
	mlcdf
::
SŒ
&() {

15  
¡r_
;

	@test/Testers.hh

1 
	~<¡ršg
>

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

4 
	~<veùÜ
>

5 
	~<¿ndom
>

6 
	~<m­
>

7 
	~"T¿n§ùiÚ.hh
"

8 
	~"PriÜ™yQueue.hh
"

9 
	~"HashbË.hh
"

10 
	~"RBT»e.hh
"

11 
	~"VeùÜ.hh
"

13 
	#MAX_VALUE
 10

14 
	#PRINT_DEBUG
 1

15 

	)

16 
	sRªd
 {

17 
ušt32_t
 
	t»suÉ_ty³
;

19 
»suÉ_ty³
 
	mu
, 
	mv
;

20 
Rªd
(
»suÉ_ty³
 
u
,„esuÉ_ty³ 
v
) : u(u|1), v(v|1) {}

22 
šlše
 
»suÉ_ty³
 
İ”©Ü
()() {

23 
	mv
 = 36969*(
v
 & 65535) + (v >> 16);

24 
	mu
 = 18000*(
u
 & 65535) + (u >> 16);

25  (
	mv
 << 16è+ 
	mu
;

28 
cÚ¡ex´
 
»suÉ_ty³
 
max
() {

29  (
	mušt32_t
)-1;

32 
cÚ¡ex´
 
»suÉ_ty³
 
mš
() {

37 
	sİ_»cÜd
 {

39 
	mİ
;

40 
	m¡d
::
veùÜ
<> 
¬gs
;

41 
	m¡d
::
veùÜ
<> 
rd©a
;

44 
	stxn_»cÜd
 {

46 
	m¡d
::
veùÜ
<
İ_»cÜd
*> 
İs
;

49 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

50 
	sTe¡”Paœ
 {

51 
T
* 
	mt
;

52 
	mme
;

55 
	g¡d
::
veùÜ
<
¡d
::
m­
<
ušt64_t
, 
	gtxn_»cÜd
 *> > 
	gtxn_li¡
;

57 
	gT¿n§ùiÚTid
::
	tty³
 
	tV”siÚ
;

58 
V”siÚ
 
	glock
;

60 
	g‹m¶©e
 <
ty³Çme
 
	gDT
,y³Çm
	gRT
>

61 şas 
	cTe¡”
 {

62 
	mpublic
:

63 
vœtu®
 ~
	$Te¡”
() {}

66 
vœtu®
 
	`š™_sut
(
DT
* 
q
) = 0;

68 
vœtu®
 
	`š™_»f
(
RT
* 
q
) = 0;

70 
vœtu®
 
İ_»cÜd
* 
	`doOp
(
DT
* 
q
, 
İ
, 
me
, 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
¦Ùdi¡
, 
Rªd
 
Œªsg’
) = 0 ;

72 
vœtu®
 
	`»doOp
(
RT
* 
q
, 
İ_»cÜd
 *
İ
) = 0;

74 
vœtu®
 
	`check
(
DT
* 
q
, 
RT
* 
q1
) = 0;

75 #ià
PRINT_DEBUG


79 
	}
};

81 
	g‹m¶©e
 <
ty³Çme
 
	gDT
,y³Çm
	gRT
>

82 
şass
 
	gRBT»eTe¡”
: 
Te¡”
<
DT
, 
	gRT
> {

83 
	gpublic
:

84 
‹m¶©e
 <
ty³Çme
 
T
>

85 
š™
(
T
* 
q
) {

86 
i
 = 0; 
	gi
 < 
	gMAX_VALUE
; i++) {

87 
	gTRANSACTION
 {

88 (*
	gq
)[
i
] = i;

89 } 
RETRY
(
çl£
);

93 
š™_sut
(
DT
* 
q
è{
	gš™
<
	gDT
>(
	gq
);}

94 
š™_»f
(
RT
* 
q
è{
	gš™
<
	gRT
>(
	gq
);}

96 
İ_»cÜd
* 
doOp
(
DT
* 
q
, 
İ
, 
me
, 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
¦Ùdi¡
, 
Rªd
 
Œªsg’
) {

97 #ià!
PRINT_DEBUG


98 ()
	gme
;

100 
	gkey
 = 
¦Ùdi¡
(
Œªsg’
);

101 ià(
	gİ
 == 0) {

102 
v®
 = 
¦Ùdi¡
(
Œªsg’
);

103 #ià
PRINT_DEBUG


104 
	gT¿n§ùiÚTid
::
lock
(lock);

105 
	g¡d
::
cout
 << "[" << 
me
 << "]ryØİ”©Ü[] key " << 
key
 << "‡nd v® " << 
v®
 << 
¡d
::
’dl
;

106 
	gT¿n§ùiÚTid
::
uÆock
(
lock
);

108 (*
	gq
)[
key
] = 
v®
;

109 #ià
PRINT_DEBUG


110 
	gT¿n§ùiÚTid
::
lock
(lock);

111 
	g¡d
::
cout
 << "[" << 
me
 << "] in£¹ key " << 
key
 << "‡nd v® " << 
v®
 << 
¡d
::
’dl
;

112 
	gT¿n§ùiÚTid
::
uÆock
(
lock
);

114 
İ_»cÜd
* 
	g»c
 = 
Ãw
 op_record;

115 
	g»c
->
	gİ
 = 
İ
;

116 
	g»c
->
	g¬gs
.
push_back
(
key
);

117 
	g»c
->
	g¬gs
.
push_back
(
v®
);

118  
	g»c
;

119 } ià(
	gİ
 == 1) {

120 #ià
PRINT_DEBUG


121 
T¿n§ùiÚTid
::
lock
(lock);

122 
	g¡d
::
cout
 << "[" << 
me
 << "]ryØ”a£ " << 
key
<< 
¡d
::
’dl
;

123 
	gT¿n§ùiÚTid
::
uÆock
(
lock
);

125 
	gnum
 = 
q
->
”a£
(
key
);

126 #ià
PRINT_DEBUG


127 
	gT¿n§ùiÚTid
::
lock
(lock);

128 
	g¡d
::
cout
 << "[" << 
me
 << "]ƒ¿£d " << 
num
 << " i‹m w™h key " << 
key
 << 
¡d
::
’dl
;

129 
	gT¿n§ùiÚTid
::
uÆock
(
lock
);

131 
İ_»cÜd
* 
	g»c
 = 
Ãw
 op_record;

132 
	g»c
->
	gİ
 = 
İ
;

133 
	g»c
->
	g¬gs
.
push_back
(
key
);

134 
	g»c
->
	grd©a
.
push_back
(
num
);

135  
	g»c
;

136 } ià(
	gİ
 == 2) {

137 #ià
PRINT_DEBUG


138 
T¿n§ùiÚTid
::
lock
(lock);

139 
	g¡d
::
cout
 << "[" << 
me
 << "]ryØcouÁ " << 
key
 << 
¡d
::
’dl
;

140 
	gT¿n§ùiÚTid
::
uÆock
(
lock
);

142 
	gnum
 = 
q
->
couÁ
(
key
);

143 #ià
PRINT_DEBUG


144 
	gT¿n§ùiÚTid
::
lock
(lock);

145 
	g¡d
::
cout
 << "[" << 
me
 << "] couÁed " << 
num
 << " i‹m w™h key " << 
key
 << 
¡d
::
’dl
;

146 
	gT¿n§ùiÚTid
::
uÆock
(
lock
);

148 
İ_»cÜd
* 
	g»c
 = 
Ãw
 op_record;

149 
	g»c
->
	gİ
 = 
İ
;

150 
	g»c
->
	g¬gs
.
push_back
(
key
);

151 
	g»c
->
	grd©a
.
push_back
(
num
);

152  
	g»c
;

153 } ià(
	gİ
 == 3) {

154 #ià
PRINT_DEBUG


155 
T¿n§ùiÚTid
::
lock
(lock);

156 
	g¡d
::
cout
 << "[" << 
me
 << "]ryØsize" << 
¡d
::
’dl
;

157 
	gT¿n§ùiÚTid
::
uÆock
(
lock
);

159 
size_t
 
	gsize
 = 
q
->
size
();

160 #ià
PRINT_DEBUG


161 
	gT¿n§ùiÚTid
::
lock
(lock);

162 
	g¡d
::
cout
 << "[" << 
me
 << "] siz" << 
size
 << 
¡d
::
’dl
;

163 
	gT¿n§ùiÚTid
::
uÆock
(
lock
);

165 
İ_»cÜd
* 
	g»c
 = 
Ãw
 op_record;

166 
	g»c
->
	gİ
 = 
İ
;

167 
	g»c
->
	grd©a
.
push_back
(
size
);

168  
	g»c
;

293  
	gnuÎ±r
;

296 
»doOp
(
RT
* 
q
, 
İ_»cÜd
 *
İ
) {

297 ià(
	gİ
->op == 0) {

298 
key
 = 
İ
->
¬gs
[0];

299 
	gv®
 = 
İ
->
¬gs
[1];

300 (*
	gq
)[
key
] = 
v®
;

301 #ià
PRINT_DEBUG


302 
	g¡d
::
cout
 << "š£¹šg: " << 
key
 << ", " << 
v®
 << 
¡d
::
’dl
;

304 } ià(
	gİ
->op == 1) {

305 
key
 = 
İ
->
¬gs
[0];

306 
	g”a£d
 = 
q
->
”a£
(
key
);

307 #ià
PRINT_DEBUG


308 
	g¡d
::
cout
 << "”asšg: " << 
key
 << 
¡d
::
’dl
;

309 
	g¡d
::
cout
 << "”a£„•Ïy: " << 
”a£d
 << 
¡d
::
’dl
;

310 
	g¡d
::
cout
 << "”a£ƒx³ùed: " << 
İ
->
rd©a
[0] << 
¡d
::
’dl
;

312 
as£¹
 (
”a£d
 =ğ
İ
->
rd©a
[0]);

313 } ià(
	gİ
->op == 2) {

314 
key
 = 
İ
->
¬gs
[0];

315 
	gcouÁed
 = 
q
->
couÁ
(
key
);

316 #ià
PRINT_DEBUG


317 
	g¡d
::
cout
 << "couÁšg: " << 
key
 << 
¡d
::
’dl
;

318 
	g¡d
::
cout
 << "couÁ„•Ïy: " << 
couÁed
 << 
¡d
::
’dl
;

319 
	g¡d
::
cout
 << "couÁƒx³ùed: " << 
İ
->
rd©a
[0] << 
¡d
::
’dl
;

321 
as£¹
(
couÁed
 =ğ
İ
->
rd©a
[0]);

322 } ià(
	gİ
->op == 3) {

323 
size_t
 
size
 = 
q
->size();

324 #ià
PRINT_DEBUG


325 
	g¡d
::
cout
 << "siz»¶ay: " << 
size
 << 
¡d
::
’dl
;

326 
	g¡d
::
cout
 << "sizex³ùed: " << 
İ
->
rd©a
[0] << 
¡d
::
’dl
;

328 
as£¹
(
size
 =ğ(
size_t
è
İ
->
rd©a
[0]);

379 
check
(
DT
* 
q
, 
RT
*
q1
) {

380 
	gi
 = 0; i < 
	gMAX_VALUE
; i++) {

381 #ià
PRINT_DEBUG


382 
	g¡d
::
cout
 << "˜is: " << 
i
 << 
¡d
::
’dl
;

384 
	gTRANSACTION
 {

394 
size_t
 
	gs
 = 
q
->
size
();

395 
size_t
 
	gs1
 = 
q1
->
size
();

396 #ià
PRINT_DEBUG


397 
	g¡d
::
cout
 << "q size: " << 
¡d
::
’dl
;

398 
	g¡d
::
cout
 << "q1 size: " << 
s1
 << 
¡d
::
’dl
;

400 
as£¹
(
s
 =ğ
s1
);

401 
size_t
 
	gc
 = 
q
->
couÁ
(
i
);

402 
size_t
 
	gc1
 = 
q1
->
couÁ
(
i
);

403 #ià
PRINT_DEBUG


404 
	g¡d
::
cout
 << "q couÁ: " << 
c
 << 
¡d
::
’dl
;

405 
	g¡d
::
cout
 << "q1 couÁ: " << 
c1
 << 
¡d
::
’dl
;

407 
as£¹
(
c
 =ğ
c1
);

408 
	gv1
 = (*
q
)[
i
];

409 
	gv2
 = (*
q1
)[
i
];

410 #ià
PRINT_DEBUG


411 
	g¡d
::
cout
 << "v1: " << 
v1
 << 
¡d
::
’dl
;

412 
	g¡d
::
cout
 << "v2: " << 
v2
 << 
¡d
::
’dl
;

414 
as£¹
(
v1
 =ğ
v2
);

416 
	gs
 = 
q
->
size
();

417 
	gs1
 = 
q1
->
size
();

418 #ià
PRINT_DEBUG


419 
	g¡d
::
cout
 << "q size: " << 
s
 << 
¡d
::
’dl
;

420 
	g¡d
::
cout
 << "q1 size: " << 
s1
 << 
¡d
::
’dl
;

422 
as£¹
(
s
 =ğ
s1
);

426 
size_t
 
	ge
 = 
q
->
”a£
(
i
);

427 
size_t
 
	ge1
 = 
q1
->
”a£
(
i
);

428 #ià
PRINT_DEBUG


429 
	g¡d
::
cout
 << "qƒ¿£d: " << 
e
 << 
¡d
::
’dl
;

430 
	g¡d
::
cout
 << "q1ƒ¿£d: " << 
e1
 << 
¡d
::
’dl
;

432 
as£¹
(
e
 =ğ
e1
);

433 } 
RETRY
(
çl£
);

435 
	gTRANSACTION
 {

436 
	gi
 = 0; i < 
	gMAX_VALUE
; i++) {

437 
as£¹
(
q
->
couÁ
(
i
) == 0);

439 } 
RETRY
(
çl£
);

442 #ià
PRINT_DEBUG


443 
´št_¡©s
(
DT
* 
q
) {

444 ()
	gq
;

449 cÚ¡ 
	gnum_İs_
 = 4;

	@test/bench-tart.cc

1 #undeà
NDEBUG


2 
	~<¡ršg
>

3 
	~<th»ad
>

4 
	~<io¡»am
>

5 
	~<ÿs£¹
>

6 
	~<veùÜ
>

7 
	~"Sto.hh
"

8 
	~"TART.hh
"

9 
	~"T¿n§ùiÚ.hh
"

10 
	~<uni¡d.h
>

12 
	#NTHREAD
 100

	)

13 
	#NVALS
 1000

	)

14 
	#KEYSIZE
 5

	)

16 
TART
 
	g¬t
;

17 
	g¡d
::
¡ršg
 
keys
[
NVALS
];

18 
	gv®s
[
NVALS
];

20 
	g¡d
::
¡ršg
 
	$¿nd_¡ršg
() {

21 autØ
¿ndch¬
 = []() -> 

23 cÚ¡ 
ch¬£t
[] = "abcdefghijklmnopqrstuvwxyz";

24 cÚ¡ 
size_t
 
max_šdex
 = ((
ch¬£t
) - 1);

25  
ch¬£t
[ 
	`¿nd
(è% 
max_šdex
 ];

27 
¡d
::
¡ršg
 
	`¡r
(
KEYSIZE
, 0);

28 
¡d
::
	`g’”©e_n
(
¡r
.
	`begš
(), 
KEYSIZE
, 
¿ndch¬
);

29  
¡r
;

30 
	}
}

32 
	$¿nd_št
() {

33  
¡d
::
	`¿nd
();

34 
	}
}

36 
	$doB’ch
(
i
) {

37 
TTh»ad
::
	`£t_id
(
i
);

38 
TRANSACTION_E
 {

39 
i
 = 0; i < 
NVALS
/10; i++) {

40 autØ
keyI
 = 
	`¿nd_št
(è% 
NVALS
;

41 autØ
v®I
 = 
	`¿nd_št
(è% 
NVALS
;

42 autØ
”a£I
 = 
	`¿nd_št
(è% 
NVALS
;

43 
¬t
.
	`š£¹
(
keys
[
keyI
], 
v®s
[
v®I
]);

44 
	`as£¹
(
¬t
.
	`lookup
(
keys
[
keyI
]è=ğ
v®s
[
v®I
]);

45 
¬t
.
	`”a£
(
keys
[
”a£I
]);

47 } 
	`RETRY_E
(
Œue
);

48 
	}
}

50 
	$maš
() {

51 
	`¤ªd
(
	`time
(
NULL
));

52 
¬t
 = 
	`TART
();

54 
i
 = 0; i < 
NVALS
; i++) {

55 
keys
[
i
] = 
	`¿nd_¡ršg
();

56 
v®s
[
i
] = 
	`¿nd_št
();

57 
	`´štf
("%d: key: %s, v®: %d\n", 
i
, 
keys
[i].
	`c_¡r
(), 
v®s
[i]);

60 
¡d
::
th»ad
 
th»ads
[
NTHREAD
];

62 
¡d
::
şock_t
 
¡¬t
;

63 
¡¬t
 = 
¡d
::
	`şock
();

64 
i
 = 0; i < 
NTHREAD
; i++) {

65 
th»ads
[
i
] = 
¡d
::
	`th»ad
(
doB’ch
, i);

68 
i
 = 0; i < 
NTHREAD
; i++) {

69 
th»ads
[
i
].
	`još
();

71 
¡d
::
cout
 << "Time: " << (¡d::
	`şock
(è- 
¡¬t
è/ ()(
CLOCKS_PER_SEC
 / 1000è<< " ms" << std::
’dl
;

72 
	}
}

	@test/concurrent.cc

1 
	~<io¡»am
>

2 
	~<iomª
>

3 
	~<s¡»am
>

4 
	~<f¡»am
>

5 
	~<£t
>

6 
	~<¿ndom
>

7 
	~<th»ad
>

8 
	~<şim™s
>

9 
	~<ÿs£¹
>

10 
	~<c¡dlib
>

11 
	~<sys/time.h
>

12 
	~<sys/»sourû.h
>

13 
	~<f¡»am
>

15 
	~"PÏtfÜmF—tu»s.hh
"

17 
	~"TFËxA¼ay.hh
"

24 
	~"IÁSŒ.hh
"

25 
	~"şp.h
"

26 
	~"¿ndg’.hh
"

28 
	~"§m¶šg.hh
"

29 
	~"Sy¡emProf”.hh
"

35 #iâdeà
ARRAY_SZ


36 
	#ARRAY_SZ
 10000000

	)

39 
	#USE_ARRAY
 0

	)

40 
	#USE_HASHTABLE
 1

	)

41 
	#USE_MASSTREE
 2

	)

42 
	#USE_TGENERICARRAY
 4

	)

43 
	#USE_QUEUE
 5

	)

45 
	#USE_TVECTOR
 7

	)

46 
	#USE_MASSTREE_STR
 8

	)

47 
	#USE_HASHTABLE_STR
 9

	)

48 
	#USE_ARRAY_NONOPAQUE
 10

	)

49 
	#USE_ARRAY_ADAPTIVE
 11

	)

50 
	#USE_SWISSARRAY
 12

	)

52 
	#USE_ARRAY_TICTOC
 14

	)

55 
	#DATA_STRUCTURE
 
USE_HASHTABLE


	)

58 
	#NON_CONFLICTING
 0

	)

61 
	#ALL_UNIQUE_SLOTS
 0

	)

64 
	#STRING_VALUES
 0

	)

67 
	#UNBOXED_STRINGS
 0

	)

71 
	#DATA_COLLECT
 0

	)

74 
	#HASHTABLE_LOAD_FACTOR
 1.1

	)

78 
	#GLOBAL_SEED
 0

	)

87 
	#MAINTAIN_TRUE_ARRAY_STATE
 0

	)

90 
	#TRY_READ_MY_WRITES
 0

	)

94 
	#RAND_DELETES
 0

	)

97 
	#RANDOM_REPORT
 0

	)

103 #ifdeà
BOOSTING


104 #ifdeà
BOOSTING_STANDALONE


105 
	~"Boo¡šg_¡ªd®Úe.hh
"

107 
	~"Boo¡šg_¡o.hh
"

108 
T¿nsPessimi¡icLockšg
 
	g__³ssimi¡Lockšg
;

110 
	~"Boo¡šg_m­.hh
"

114 #ifdeà
DEBUG


115 
	#debug
(...è
	`´štf
(
__VA_ARGS__
)

	)

117 
	#debug
(...è

	)

120 #ià
STRING_VALUES


121 
	g¡d
::
	t¡ršg
 
	tv®ue_ty³
;

123 
	tv®ue_ty³
;

126 
šlše
 
v®ue_ty³
 
	$v®
(
v
) {

127 #ià
STRING_VALUES


128  
¡d
::
	`to_¡ršg
(
v
);

130  
v
;

132 
	}
}

134 
šlše
 
	$unv®
(cÚ¡ 
v®ue_ty³
& 
v
) {

135 #ià
STRING_VALUES


136  
¡d
::
	`¡oi
(
v
);

138  
v
;

140 
	}
}

142 
šlše
 
	g¡d
::
¡ršg
 
	$v®to¡r
(
v®ue_ty³
 
v
) {

143 #ià
STRING_VALUES


144  
v
;

146  
¡d
::
	`to_¡ršg
(
v
);

148 
	}
}

150 
šlše
 
v®ue_ty³
 
	$¡¹ov®
(cÚ¡ 
¡d
::
¡ršg
& 
s
) {

151 #ià
STRING_VALUES


152  
s
;

154  
s
.
	`em±y
(è? 0 : 
¡d
::
	`¡oi
(s);

156 
	}
}

160 
	gš™Ÿl_£eds
[64];

163 
	g‹m¶©e
 <
	gDS
> 
	sCÚš”
 {};

166 
	g‹m¶©e
 <> 
	gCÚš”
<
	gUSE_ARRAY
> {

167 
	gTFËxA¼ay
<
	tv®ue_ty³
, 
	tARRAY_SZ
, 
	tTO·queW¿µed
> 
	tty³
;

168 
	tšdex_ty³
;

169 
cÚ¡ex´
 
boŞ
 
	ghas_d–‘e
 = 
çl£
;

170 
v®ue_ty³
 
nÚŒªs_g‘
(
šdex_ty³
 
key
) {

171  
	gv_
.
nÚŒªs_g‘
(
key
);

173 
nÚŒªs_put
(
šdex_ty³
 
key
, cÚ¡ 
v®ue_ty³
& 
v®
) {

174 
	gv_
.
nÚŒªs_put
(
key
, 
v®
);

176 
boŞ
 
ŒªsG‘
(
šdex_ty³
 
key
, 
v®ue_ty³
& 
»t
) {

177  
	gv_
.
ŒªsG‘
(
key
, 
»t
);

179 
boŞ
 
ŒªsPut
(
šdex_ty³
 
key
, 
v®ue_ty³
 
v®ue
) {

180  
	gv_
.
ŒªsPut
(
key
, 
v®ue
);

182 
š™
() {

184 
š™_ns
() {

186 
fš®ize
() {

188 
th»ad_š™
(
CÚš”
<
USE_ARRAY
>&) {

190 
	g´iv©e
:

191 
ty³
 
v_
;

194 
	g‹m¶©e
 <> 
	gCÚš”
<
	gUSE_SWISSARRAY
> {

195 
	gTSwissA¼ay
<
	tv®ue_ty³
, 
	tARRAY_SZ
> 
	tty³
;

196 
	tšdex_ty³
;

197 
cÚ¡ex´
 
boŞ
 
	ghas_d–‘e
 = 
çl£
;

198 
v®ue_ty³
 
nÚŒªs_g‘
(
šdex_ty³
 
key
) {

199  
	gv_
.
nÚŒªs_g‘
(
key
);

201 
nÚŒªs_put
(
šdex_ty³
 
key
, cÚ¡ 
v®ue_ty³
& 
v®
) {

202 
	gv_
.
nÚŒªs_put
(
key
, 
v®
);

204 
boŞ
 
ŒªsG‘
(
šdex_ty³
 
key
, 
v®ue_ty³
& 
»t
) {

205  
	gv_
.
ŒªsG‘
(
key
, 
»t
);

207 
boŞ
 
ŒªsPut
(
šdex_ty³
 
key
, 
v®ue_ty³
 
v®ue
) {

208  
	gv_
.
ŒªsPut
(
key
, 
v®ue
);

210 
š™
() {

212 
š™_ns
() {

214 
fš®ize
() {

216 
th»ad_š™
(
CÚš”
<
USE_SWISSARRAY
>&) {

218 
	g´iv©e
:

219 
ty³
 
v_
;

222 
	g‹m¶©e
 <> 
	gCÚš”
<
	gUSE_ARRAY_NONOPAQUE
> {

223 
	gTOCCA¼ay
<
	tv®ue_ty³
, 
	tARRAY_SZ
> 
	tty³
;

224 
	tšdex_ty³
;

225 
cÚ¡ex´
 
boŞ
 
	ghas_d–‘e
 = 
çl£
;

226 
v®ue_ty³
 
nÚŒªs_g‘
(
šdex_ty³
 
key
) {

227  
	gv_
.
nÚŒªs_g‘
(
key
);

229 
nÚŒªs_put
(
šdex_ty³
 
key
, cÚ¡ 
v®ue_ty³
& 
v®
) {

230 
	gv_
.
nÚŒªs_put
(
key
, 
v®
);

232 
boŞ
 
ŒªsG‘
(
šdex_ty³
 
key
, 
v®ue_ty³
& 
»t
) {

233  
	gv_
.
ŒªsG‘
(
key
, 
»t
);

235 
boŞ
 
ŒªsPut
(
šdex_ty³
 
key
, 
v®ue_ty³
 
v®ue
) {

236  
	gv_
.
ŒªsPut
(
key
, 
v®ue
);

238 
š™
() {

240 
š™_ns
() {

242 
fš®ize
() {

244 
th»ad_š™
(
CÚš”
<
USE_ARRAY_NONOPAQUE
>&) {

246 
	g´iv©e
:

247 
ty³
 
v_
;

250 
	g‹m¶©e
 <> 
	gCÚš”
<
	gUSE_ARRAY_ADAPTIVE
> {

251 
	gTAd­tiveA¼ay
<
	tv®ue_ty³
, 
	tARRAY_SZ
> 
	tty³
;

252 
	tšdex_ty³
;

253 
cÚ¡ex´
 
boŞ
 
	ghas_d–‘e
 = 
çl£
;

254 
v®ue_ty³
 
nÚŒªs_g‘
(
šdex_ty³
 
key
) {

255  
	gv_
.
nÚŒªs_g‘
(
key
);

257 
nÚŒªs_put
(
šdex_ty³
 
key
, cÚ¡ 
v®ue_ty³
& 
v®
) {

258 
	gv_
.
nÚŒªs_put
(
key
, 
v®
);

260 
boŞ
 
ŒªsG‘
(
šdex_ty³
 
key
, 
v®ue_ty³
& 
»t
) {

261  
	gv_
.
ŒªsG‘
(
key
, 
»t
);

263 
boŞ
 
ŒªsPut
(
šdex_ty³
 
key
, 
v®ue_ty³
 
v®ue
) {

264  
	gv_
.
ŒªsPut
(
key
, 
v®ue
);

266 
š™
() {}

267 
š™_ns
() {}

268 
fš®ize
() {}

269 
th»ad_š™
(
CÚš”
<
USE_ARRAY_ADAPTIVE
>&) {}

270 
	g´iv©e
:

271 
ty³
 
v_
;

274 
	g‹m¶©e
 <> 
	gCÚš”
<
	gUSE_ARRAY_TICTOC
> {

275 
	gTicTocA¼ay
<
	tv®ue_ty³
, 
	tARRAY_SZ
> 
	tty³
;

276 
	tšdex_ty³
;

277 
cÚ¡ex´
 
boŞ
 
	ghas_d–‘e
 = 
çl£
;

278 
v®ue_ty³
 
nÚŒªs_g‘
(
šdex_ty³
 
key
) {

279  
	gv_
.
nÚŒªs_g‘
(
key
);

281 
nÚŒªs_put
(
šdex_ty³
 
key
, cÚ¡ 
v®ue_ty³
& 
v®
) {

282 
	gv_
.
nÚŒªs_put
(
key
, 
v®
);

284 
boŞ
 
ŒªsG‘
(
šdex_ty³
 
key
, 
v®ue_ty³
& 
»t
) {

285  
	gv_
.
ŒªsG‘
(
key
, 
»t
);

287 
boŞ
 
ŒªsPut
(
šdex_ty³
 
key
, 
v®ue_ty³
 
v®ue
) {

288  
	gv_
.
ŒªsPut
(
key
, 
v®ue
);

290 
š™
() {}

291 
š™_ns
() {}

292 
fš®ize
() {}

293 
th»ad_š™
(
CÚš”
<
USE_ARRAY_TICTOC
>&) {}

294 
	g´iv©e
:

295 
ty³
 
v_
;

331 
	g‹m¶©e
 <> 
	gCÚš”
<
	gUSE_TVECTOR
> {

332 
	gTVeùÜ
<
	tv®ue_ty³
> 
	tty³
;

333 
ty³Çme
 
	tty³
::
	tsize_ty³
 
	tšdex_ty³
;

334 
cÚ¡ex´
 
boŞ
 
	ghas_d–‘e
 = 
çl£
;

335 
CÚš”
() {

336 
	gv_
.
nÚŒªs_»£rve
(
ARRAY_SZ
);

337 
	gv_
.
nÚŒªs_size
(è< 
	gARRAY_SZ
)

338 
	gv_
.
nÚŒªs_push_back
(
v®ue_ty³
());

340 
v®ue_ty³
 
nÚŒªs_g‘
(
šdex_ty³
 
key
) {

341  
	gv_
.
nÚŒªs_g‘
(
key
);

343 
v®ue_ty³
 
ŒªsG‘
(
šdex_ty³
 
key
) {

344  
	gv_
.
ŒªsG‘
(
key
);

346 
ŒªsPut
(
šdex_ty³
 
key
, 
v®ue_ty³
 
v®ue
) {

347 
	gv_
.
ŒªsPut
(
key
, 
v®ue
);

349 
š™
() {

351 
š™_ns
() {

353 
fš®ize
() {

355 
th»ad_š™
(
CÚš”
<
USE_TVECTOR
>&) {

357 
	g´iv©e
:

358 
ty³
 
v_
;

361 
	g‹m¶©e
 <> 
	gCÚš”
<
	gUSE_TGENERICARRAY
> {

362 
	tšdex_ty³
;

363 
cÚ¡ex´
 
boŞ
 
	ghas_d–‘e
 = 
çl£
;

364 
v®ue_ty³
 
nÚŒªs_g‘
(
šdex_ty³
 
key
) {

365  
	ga_
[
key
];

367 
v®ue_ty³
 
ŒªsG‘
(
šdex_ty³
 
key
) {

368 
as£¹
(
key
 >ğ0 && key < 
ARRAY_SZ
);

369  
	g¡m_
.
»ad
(&
a_
[
key
]);

371 
ŒªsPut
(
šdex_ty³
 
key
, 
v®ue_ty³
 
v®ue
) {

372 
as£¹
(
key
 >ğ0 && key < 
ARRAY_SZ
);

373 
	g¡m_
.
wr™e
(&
a_
[
key
], 
v®ue
);

375 
š™
() {

377 
š™_ns
() {

379 
fš®ize
() {

381 
th»ad_š™
(
CÚš”
<
USE_TGENERICARRAY
>&) {

383 
	g´iv©e
:

384 
TG’”ic
 
¡m_
;

385 
v®ue_ty³
 
	ga_
[
ARRAY_SZ
];

388 
	g‹m¶©e
 <> 
	gCÚš”
<
	gUSE_SWISSGENERICARRAY
> {

389 
	tšdex_ty³
;

390 
cÚ¡ex´
 
boŞ
 
	ghas_d–‘e
 = 
çl£
;

391 
v®ue_ty³
 
nÚŒªs_g‘
(
šdex_ty³
 
key
) {

392  
	ga_
[
key
];

394 
boŞ
 
ŒªsG‘
(
šdex_ty³
 
key
, 
v®ue_ty³
& 
»t
) {

395  
	g¡m_
.
»ad
(&
a_
[
key
], 
»t
);

397 
boŞ
 
ŒªsPut
(
šdex_ty³
 
key
, 
v®ue_ty³
 
v®ue
) {

398  
	g¡m_
.
wr™e
(&
a_
[
key
], 
v®ue
);

400 
š™
() {

402 
š™_ns
() {

403 
	g¡d
::
cout
 << "CÚš”<USE_SWISSGENERIC>::š™ s¹s!" << 
¡d
::
’dl
;

406 
fš®ize
() {

407 
	g¡d
::
cout
 << "CÚš”<USE_SWISSGENERIC>::fš®iz¡¬ts!" << 
¡d
::
’dl
;

410 
th»ad_š™
(
CÚš”
<
USE_SWISSGENERICARRAY
>&) {

412 
	g´iv©e
:

414 
SwissTNÚİaqueG’”ic
 
¡m_
;

415 
v®ue_ty³
 
	ga_
[
ARRAY_SZ
] 
__©Œibu‹__
 ((
®igÃd
 ((value_type))));

595 #ià
DATA_STRUCTURE
 =ğ
USE_QUEUE


596 
	gQueue
<
	tv®ue_ty³
, 
	tARRAY_SZ
> 
	tQueueTy³
;

597 
QueueTy³
* 
	gq
;

598 
QueueTy³
* 
	gq2
;

601 
boŞ
 
	g»adMyWr™es
 = 
Œue
;

602 
boŞ
 
	grunCheck
 = 
çl£
;

603 
	gÁh»ads
 = 4;

604 
	gÁ¿ns
 = 1000000;

605 
	gİ¥”Œªs
 = 10;

606 
	gİ¥”Œªs_ro
 = -1;

607 
	g´•İuÏ‹
 = 
ARRAY_SZ
;

608 
	g»adÚly_³rûÁ
 = 0.0;

609 
	gwr™e_³rûÁ
 = 0.5;

610 
boŞ
 
	gblšdRªdomWr™e
 = 
Œue
;

611 
	gzf_skew
 = 1.0;

612 
boŞ
 
	g´ofe
 = 
çl£
;

613 
boŞ
 
	gdump_Œaû
 = 
çl£
;

614 
boŞ
 
	g¡İ
 = 
çl£
;

617 
usšg
 
Çme¥aû
 
	g¡d
;

619 #ià
MAINTAIN_TRUE_ARRAY_STATE


620 
boŞ
 
	gmašš_Œue_¬¿y_¡©e
 = 
Œue
;

621 
	gŒue_¬¿y_¡©e
[
ARRAY_SZ
];

624 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

625 
	$´•İuÏ‹_func
(
T
& 
a
) {

626 
i
 = 0; i < 
´•İuÏ‹
; ++i) {

627 
a
.
	`nÚŒªs_put
(
i
, 
	`v®
(i+1));

629 
¡d
::
cout
 << "DÚ´•İuÏtšg " << std::
’dl
;

630 
	}
}

632 
	$´•İuÏ‹_func
(*
¬¿y
) {

633 
i
 = 0; i < 
´•İuÏ‹
; ++i) {

634 
¬¿y
[
i
] = i+1;

636 
	}
}

638 #ià
DATA_STRUCTURE
 =ğ
USE_QUEUE


640 
	$´•İuÏ‹_func
() {

641 
i
 = 0; i < 
´•İuÏ‹
; ++i) {

642 
q
->
	`push
(
	`v®
(
i
));

644 
	}
}

646 
	$em±y_func
() {

647 !
q
->
	`em±y
()) {

648 
q
->
	`pİ
();

650 
	}
}

655 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

656 
boŞ
 
	$doR—d
(
T
& 
a
, 
¦Ù
, 
v®ue_ty³
& 
»t
) {

657  
a
.
	`ŒªsG‘
(
¦Ù
, 
»t
);

658 
	}
}

660 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

661 
boŞ
 
	$doWr™e
(
T
& 
a
, 
¦Ù
, & 
ùr
) {

662  
a
.
	`ŒªsPut
(
¦Ù
, 
	`v®
(
ùr
));

673 #ià
TRY_READ_MY_WRITES


675 
	`as£¹
(
a
.
	`ŒªsG‘
(
¦Ù
è=ğ
v0
+1);

676 
a
.
	`ŒªsPut
(
¦Ù
, 
v0
+2);

678 
	`as£¹
(
a
.
	`ŒªsG‘
(
¦Ù
è=ğ
v0
+2);

680 
	}
}

681 ++
	gùr
;

686 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

687 
šlše
 
Ä—ds
(
T
& 
a
, 
n
, 
¡d
::
funùiÚ
<()> 
¦Ùg’
) {

688 
i
 = 0; 
	gi
 < 
	gn
; ++i) {

689 
doR—d
(
a
, 
¦Ùg’
());

693 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

694 
šlše
 
nwr™es
(
T
& 
a
, 
n
, 
¡d
::
funùiÚ
<()> 
¦Ùg’
) {

695 
i
 = 0; 
	gi
 < 
	gn
; ++i) {

696 
doWr™e
(
a
, 
¦Ùg’
(), 
i
);

700 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
boŞ
 
	gSuµÜt
 = 
T
::
has_d–‘e
> 
DoD–‘eH–³r
;

701 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gDoD–‘eH–³r
<T, 
	gŒue
> {

702 
run
(
T
& 
a
, 
ty³Çme
 T::
šdex_ty³
 
¦Ù
) {

703 
a
.
ŒªsD–‘e
(
¦Ù
);

706 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
	gDoD–‘eH–³r
<T, 
	gçl£
> {

707 
run
(
T
&, 
ty³Çme
 T::
šdex_ty³
) {

710 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

711 
	$doD–‘e
(
T
& 
a
, 
¦Ù
) {

712 
DoD–‘eH–³r
<
T
>::
	`run
(
a
, 
¦Ù
);

713 
	}
}

717 
	sTe¡”
 {

718 
Te¡”
() {}

719 
vœtu®
 
š™Ÿlize
() = 0;

720 
vœtu®
 
fš®ize
() = 0;

721 
vœtu®
 
run
(
me
, 
ušt64_t
 
¡¬t_tsc
) {

722 (è
	mme
; ()
	m¡¬t_tsc
;

723 
as£¹
(0 && "Test‚ot supported");

725 
vœtu®
 
boŞ
 
check
(è{  
	mçl£
; }

726 
vœtu®
 
»pÜt
() {

727 #ià
DEBUG_SKEW


728 
	m¡d
::
cout
 << "skew„eporting‚ot‡vailable forhisest"

729 << 
¡d
::
’dl
;

734 
	g‹m¶©e
 <
	gDS
> 
	gDSTe¡”
 : 
public
 
Te¡”
 {

735 
DSTe¡”
(è: 
a
() {}

736 
š™Ÿlize
();

737 
fš®ize
() {

738 
	ga
->
fš®ize
();

740 
vœtu®
 
boŞ
 
´•İuÏ‹
(è{  
	gŒue
; }

741 
	gCÚš”
<
	tDS
> 
	tcÚš”_ty³
;

742 
	g´Ùeùed
:

743 
cÚš”_ty³
* 
a
;

746 
	g‹m¶©e
 <
	gDS
> 
	gDSTe¡”
<DS>::
	$š™Ÿlize
() {

747 
a
 = 
Ãw
 
cÚš”_ty³
;

748 ià(
	`´•İuÏ‹
()) {

749 
	`´•İuÏ‹_func
(*
a
);

750 #ià
MAINTAIN_TRUE_ARRAY_STATE


751 
	`´•İuÏ‹_func
(
Œue_¬¿y_¡©e
);

754 
cÚš”_ty³
::
	`š™
();

755 
a
->
	`š™_ns
();

756 
	}
}

759 şas 
	cOpTy³
 : {
»ad
, 
	mwr™e
, 
	mšc
};

761 
	sRWO³¿tiÚ
 {

762 
RWO³¿tiÚ
(è: 
ty³
(
OpTy³
::
»ad
), 
key
(), 
v®ue
() {}

763 
RWO³¿tiÚ
(
OpTy³
 
t
, 
§m¶šg
::
šdex_t
 
k
, 
v®ue_ty³
 
v
 = value_type())

764 : 
ty³
(
t
), 
key
(
k
), 
v®ue
(
v
) {}

766 
OpTy³
 
	mty³
;

767 
	m§m¶šg
::
šdex_t
 
key
;

768 
v®ue_ty³
 
	mv®ue
;

771 
šlše
 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
os
, cÚ¡ 
	gRWO³¿tiÚ
& 
	gİ
) {

772 
	gos
 << "[";

773 ià(
	gİ
.
	gty³
 =ğ
OpTy³
::
»ad
) {

774 
os
 << "r,k=" << 
İ
.
key
;

775 } ià(
	gİ
.
	gty³
 =ğ
OpTy³
::
wr™e
) {

776 
os
 << "w,k=" << 
İ
.
key
 << ",v=" << op.
v®ue
;

778 
as£¹
(
İ
.
ty³
 =ğ
OpTy³
::
šc
);

779 
	gos
 << "šc,k=" << 
	gİ
.
	gkey
;

781 
	gos
 << "]";

782  
	gos
;

785 
šlše
 
	g¡d
::
o¡»am
& 
İ”©Ü
 <<(
¡d
::o¡»am& 
os
, cÚ¡ std::
veùÜ
<
RWO³¿tiÚ
>& 
qu”y
) {

786 
os
 << "{";

787 auto& 
	gİ
 : 
qu”y
)

788 
os
 << 
İ
 << ",";

789 
	gos
 << "}" << 
	g¡d
::
’dl
;

790  
	gos
;

793 
	sskew_accouÁ_¡ruù
 {

794 
	mtime_to_¡İ
;

795 
	mÁxns_©_¡İ
;

796 
	mtime_to_quÙa
;

798 
skew_accouÁ_¡ruù
() {

799 
	mtime_to_¡İ
 = 0;

800 
	mÁxns_©_¡İ
 = 0;

801 
	mtime_to_quÙa
 = 0;

803 } 
	tskew_accouÁ_t
;

805 
	g‹m¶©e
 <
	gDS
>

806 
	gHÙ¥ÙRW
 : 
public
 
DSTe¡”
<
DS
> {

807 
ty³Çme
 
	tDSTe¡”
<
	tDS
>::
	tcÚš”_ty³
 container_type;

808 
	g¡d
::
	tveùÜ
<
	tRWO³¿tiÚ
> 
	tqu”y_ty³
;

809 
	g¡d
::
	tveùÜ
<
	tqu”y_ty³
> 
	twÜklßd_ty³
;

810 
HÙ¥ÙRW
() {

811 
	gi
 = 0; i < 
	gMAX_THREADS
; ++i) {

812 
	g´og»ss
[
i
].
»£rve
(100000);

813 
	gİtimi¡ic_¿‹
[
i
].
»£rve
(100000);

816 
run
(
me
, 
ušt64_t
 
¡¬t_tsc
è
	gov”ride
;

817 
boŞ
 
´•İuÏ‹
(è
	gov”ride
;

818 
»pÜt
(è
	gov”ride
;

820 
	g¡d
::
veùÜ
<
wÜklßd_ty³
> 
wÜklßds
;

821 
	g¡d
::
veùÜ
<
ušt64_t
> 
´og»ss
[
MAX_THREADS
];

822 
	g¡d
::
veùÜ
<> 
İtimi¡ic_¿‹
[
MAX_THREADS
];

823 
vœtu®
 
³r_th»ad_wÜklßd_š™
(
th»ad_id
);

825 #ià
DEBUG_SKEW


826 
	g¡d
::
veùÜ
<
skew_accouÁ_t
> 
skew_accouÁ
;

830 
šlše
 
dump_th»ad_Œaû
(
th»ad_id
, cÚ¡ 
¡d
::
veùÜ
<¡d::veùÜ<
RWO³¿tiÚ
>>& 
wÜklßd
) {

831 
¡d
::
¡ršg¡»am
 
â
;

832 
	gâ
 << "th»ad_dump_" << 
	gth»ad_id
 << ".txt";

833 
	g¡d
::
f¡»am
 
fs
(
â
.
¡r
(), 
¡d
::
ios
::
out
 | std::ios::
Œunc
);

834 ià(!
	gfs
.
is_İ’
()) {

835 
	g¡d
::
û¼
 << "CªnÙ o³Àf" << 
â
.
¡r
(è<< 
¡d
::
’dl
;

836 
as£¹
(
çl£
);

838 auto& 
	gqu”y
 : 
wÜklßd
) {

839 
fs
 << 
qu”y
;

841 
	gfs
.
æush
();

842 
	gfs
.
şo£
();

845 
	g‹m¶©e
 <
	gDS
>

846 
	gHÙ¥ÙRW
<
	gDS
>::
	$³r_th»ad_wÜklßd_š™
(
th»ad_id
) {

847 
§m¶šg
::
StoUnifÜmDi¡ributiÚ
 
	`ud
(
th»ad_id
, 0, 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
	`max
());

849 auto& 
th»ad_wÜklßd
 = 
wÜklßds
[
th»ad_id
];

851 
Œªs_³r_th»ad
 = 
Á¿ns
 / 
Áh»ads
;

852 
ušt64_t
 
»adÚly_û
 = (ušt64_t)(
»adÚly_³rûÁ
 * 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
	`max
());

853 
wr™e_th»sh
 = ()(
wr™e_³rûÁ
 * 
İ¥”Œªs
);

855 
i
 = 0; i < 
Œªs_³r_th»ad
; ++i) {

856 
qu”y_ty³
 
qu”y
;

858 autØ
r
 = 
ud
.
	`§m¶e
();

859 
boŞ
 
ro_txn
 = 
r
 < 
»adÚly_û
;

861 
¡d
::
£t
<
§m¶šg
::
šdex_t
> 
»q_keys
;

864 autØ
k
 = 
ud
.
	`§m¶e
(è% 
ARRAY_SZ
;

865 ià(
k
 == 0)

867 
»q_keys
.
	`š£¹
(
k
);

868 ià(
»q_keys
.
	`size
(è=ğ(
size_t
)
İ¥”Œªs
)

872 ià(
ro_txn
)

873 
qu”y
.
	`em¶aû_back
(
OpTy³
::
»ad
, 0);

875 
idx
 = 0;

876 autØ
™
 = 
»q_keys
.
	`begš
(); iˆ!ğ»q_keys.
	`’d
(); ++it) {

877 
RWO³¿tiÚ
 
İ
;

878 ià(!
ro_txn
 && 
idx
 >ğ
wr™e_th»sh
)

879 
İ
.
ty³
 = 
OpTy³
::
wr™e
;

881 
İ
.
ty³
 = 
OpTy³
::
»ad
;

882 
İ
.
key
 = *
™
;

883 ià(
İ
.
ty³
 =ğ
OpTy³
::
wr™e
)

884 
İ
.
v®ue
 = op.
key
 + 1;

885 
qu”y
.
	`push_back
(
İ
);

886 
idx
++;

889 
	`as£¹
((
size_t
)
idx
 =ğ
»q_keys
.
	`size
());

891 ià(!
ro_txn
)

892 
qu”y
.
	`em¶aû_back
(
OpTy³
::
wr™e
, 0, 
th»ad_id
);

894 
th»ad_wÜklßd
.
	`push_back
(
qu”y
);

897 ià(
dump_Œaû
)

898 
	`dump_th»ad_Œaû
(
th»ad_id
, 
th»ad_wÜklßd
);

899 
	}
}

901 
	g‹m¶©e
 <
	gDS
>

902 
boŞ
 
	gHÙ¥ÙRW
<
	gDS
>::
	$´•İuÏ‹
() {

903 
¡d
::
cout
 << "G’”©šg wÜklßd..." << std::
’dl
;

904 
wÜklßds
.
	`»size
(
Áh»ads
);

906 
¡d
::
veùÜ
<¡d::
th»ad
> 
thrs
;

907 
i
 = 0; i < 
Áh»ads
; ++i)

908 
thrs
.
	`em¶aû_back
(&
HÙ¥ÙRW
::
³r_th»ad_wÜklßd_š™
, 
this
, 
i
);

909 autØ&
t
 : 
thrs
)

910 
t
.
	`još
();

912 
¡d
::
cout
 << "G’”©iÚ com¶‘e." << std::
’dl
;

914 #ià
DEBUG_SKEW


915 
skew_accouÁ
.
	`»size
(
Áh»ads
);

918  
Œue
;

919 
	}
}

921 
	g‹m¶©e
 <
	gDS
>

922 
	gHÙ¥ÙRW
<
	gDS
>::
	$run
(
me
, 
ušt64_t
 
¡¬t_tsc
) {

923 
TTh»ad
::
	`£t_id
(
me
);

924 
cÚš”_ty³
* 
a
 = 
this
->a;

925 
cÚš”_ty³
::
	`th»ad_š™
(*
a
);

928 autØ&
tw
 = 
wÜklßds
[
me
];

930 #ià
DEBUG_SKEW


931 
boŞ
 
£’_¡İ
 = 
çl£
;

932 
¡¬t_tsc
 = 
	`»ad_tsc
();

935 #ià
CHECK_PROGRESS


936 
cÚ¡ex´
 
ušt64_t
 
d–_t
 = 10 * 2200000;

937 
ušt64_t
 
tÙ®_d–
 = 
d–_t
;

938 autØ
™_´ev
 = 
tw
.
	`begš
();

939 
ušt64_t
 
´ev_tÙ®_»ads
 = 0;

940 
ušt64_t
 
´ev_tÙ®_İt_»ads
 = 0;

943 autØ
txn_™
 = 
tw
.
	`begš
();xn_™ !ğtw.
	`’d
(); ++txn_it) {

944 #ià
DEBUG_SKEW


945 ià(
¡İ
 && !
£’_¡İ
) {

946 autØ
ticks
 = 
	`»ad_tsc
(è- 
¡¬t_tsc
;

947 
skew_accouÁ
[
me
].
Áxns_©_¡İ
 = 
txn_™
 - 
tw
.
	`begš
();

948 
skew_accouÁ
[
me
].
time_to_¡İ
 = 
ticks
;

949 
£’_¡İ
 = 
Œue
;

952 
TRANSACTION
 {

953 autØ&
»q
 : *
txn_™
) {

954 
»q
.
ty³
) {

955 
OpTy³
::
»ad
: {

956 
v®ue_ty³
 
r
;

957 
	`TXN_DO
(
	`doR—d
(*
a
, 
»q
.
key
, 
r
));}

959 
OpTy³
::
wr™e
:

960 
	`TXN_DO
(
	`doWr™e
(*
a
, 
»q
.
key
,„eq.
v®ue
));

962 
OpTy³
::
šc
: {

963 
v®ue_ty³
 
r
;

964 
	`TXN_DO
(
	`doR—d
(*
a
, 
»q
.
key
, 
r
));

965 ++
r
;

966 
	`TXN_DO
(
	`doWr™e
(*
a
, 
»q
.
key
, 
r
));

970 
¡d
::
û¼
 << "unkowÀOpTy³: " << ()
»q
.
ty³
 << std::
’dl
;

971 
	`abÜt
();

975 } 
	`RETRY
(
Œue
);

977 #ià
CHECK_PROGRESS


978 
ušt64_t
 
now
 = 
	`»ad_tsc
();

979 ià(
now
 - 
¡¬t_tsc
 >ğ
tÙ®_d–
) {

980 
tÙ®_d–
 +ğ
d–_t
;

981 autØ
Áxns
 = 
txn_™
 - 
™_´ev
;

982 
™_´ev
 = 
txn_™
;

984 autØ
tÙ®_»ads
 = 
	`TXP_INSPECT
(
txp_tÙ®_r
);

985 autØ
tÙ®_İt_»ads
 = 
	`TXP_INSPECT
(
txp_tÙ®_ad­tive_İt
);

987 
İt_¿‹
 = ()(
tÙ®_İt_»ads
 - 
´ev_tÙ®_İt_»ads
è/ (
tÙ®_»ads
 - 
´ev_tÙ®_»ads
);

989 
´ev_tÙ®_»ads
 = 
tÙ®_»ads
;

990 
´ev_tÙ®_İt_»ads
 = 
tÙ®_İt_»ads
;

992 
´og»ss
[
me
].
	`push_back
(
Áxns
);

993 
İtimi¡ic_¿‹
[
me
].
	`push_back
(
İt_¿‹
);

998 #ià
DEBUG_SKEW


999 
skew_accouÁ
[
me
].
time_to_quÙa
 = 
	`»ad_tsc
(è- 
¡¬t_tsc
;

1001 ià(!
¡İ
) {

1002 
	`boŞ_cmpxchg
(&
¡İ
, 
çl£
, 
Œue
);

1003 ià(!
£’_¡İ
) {

1004 
skew_accouÁ
[
me
].
Áxns_©_¡İ
 = 
tw
.
	`size
();

1005 
skew_accouÁ
[
me
].
time_to_¡İ
 = skew_accouÁ[me].
time_to_quÙa
;

1009 
	}
}

1011 
	g‹m¶©e
 <
	gDS
>

1012 
	gHÙ¥ÙRW
<
	gDS
>::
	$»pÜt
() {

1013 #ià
DEBUG_SKEW


1014 
¡d
::
veùÜ
<> 
times_to_quÙa
;

1015 
¡d
::
¡ršg¡»am
 
ss
;

1016 
i
 = 0; i < 
Áh»ads
; ++i) {

1017 
ss
 << "Th»ad " << 
i
;

1018 
ss
 << ":‚=" << 
skew_accouÁ
[
i
].
Áxns_©_¡İ
;

1019 
ss
 << ",_¡İ=" << ()(()
skew_accouÁ
[
i
].
time_to_¡İ
 / 
PROC_TSC_FREQ
);

1020 autØ
‰q
 = ()(()
skew_accouÁ
[
i
].
time_to_quÙa
 / 
PROC_TSC_FREQ
);

1021 
times_to_quÙa
.
	`push_back
(
‰q
);

1022 
ss
 << ",_quÙa=" << 
‰q
;

1023 
ss
 << 
¡d
::
’dl
;

1025 
ss
 << "MšimumimtØquÙa: " << *
¡d
::
	`mš_–em’t
(
times_to_quÙa
.
	`begš
(),imes_to_quÙa.
	`’d
()è<< std::
’dl
;

1026 
¡d
::
cout
 << 
ss
.
	`¡r
(è<< std::
æush
;

1028 #ià
CHECK_PROGRESS


1029 
¡d
::
¡ršg¡»am
 
ss
;

1030 
ss
 << "In¡ªÃou throughpuˆÒtxns), o±„—d„©(š %,ƒv”y 10 ms):" << 
¡d
::
’dl
;

1031 
size_t
 
efãùive_Ëngth
 = 
´og»ss
[0].
	`size
();

1032 
i
 = 0; i < 
Áh»ads
; ++i) {

1033 
efãùive_Ëngth
 = 
¡d
::
	`mš
Ófãùive_Ëngth, 
´og»ss
[
i
].
	`size
());

1036 
size_t
 
idx
 = 0; idx < 
efãùive_Ëngth
; ++idx) {

1037 
ušt64_t
 
agg
 = 0;

1038 
avg_¿‹
 = 0;

1039 
t
 = 0; < 
Áh»ads
; ++t) {

1040 
agg
 +ğ
´og»ss
[
t
][
idx
];

1041 
avg_¿‹
 +ğ
İtimi¡ic_¿‹
[
t
][
idx
];

1044 
ss
 << 
agg
 << ", " << 
avg_¿‹
 * 100 / 
Áh»ads
 << 
¡d
::
’dl
;

1047 
¡d
::
cout
 << 
ss
.
	`¡r
(è<< std::
æush
;

1049 
	}
}

1051 
	g‹m¶©e
 <
	gDS
>

1052 
	gHÙ¥Ù2RW
 : 
public
 
HÙ¥ÙRW
<
DS
> {

1053 
¡d
::
	tveùÜ
<
	tRWO³¿tiÚ
> 
	tqu”y_ty³
;

1054 
³r_th»ad_wÜklßd_š™
(
th»ad_id
è
	gov”ride
;

1057 
	g‹m¶©e
 <
	gDS
>

1058 
	gHÙ¥Ù2RW
<
	gDS
>::
	$³r_th»ad_wÜklßd_š™
(
th»ad_id
) {

1059 
§m¶šg
::
StoUnifÜmDi¡ributiÚ
 
	`ud
(
th»ad_id
, 0, 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
	`max
());

1061 auto& 
th»ad_wÜklßd
 = 
this
->
wÜklßds
[
th»ad_id
];

1063 
Œªs_³r_th»ad
 = 
Á¿ns
 / 
Áh»ads
;

1064 
ušt64_t
 
»adÚly_û
 = (ušt64_t)(
»adÚly_³rûÁ
 * 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
	`max
());

1065 
wr™e_th»sh
 = ()(
wr™e_³rûÁ
 * 
İ¥”Œªs
);

1067 
i
 = 0; i < 
Œªs_³r_th»ad
; ++i) {

1068 
qu”y_ty³
 
qu”y
;

1070 autØ
r
 = 
ud
.
	`§m¶e
();

1071 
boŞ
 
ro_txn
 = 
r
 < 
»adÚly_û
;

1073 
¡d
::
£t
<
§m¶šg
::
šdex_t
> 
»q_keys
;

1076 autØ
k
 = 
ud
.
	`§m¶e
(è% 
ARRAY_SZ
;

1077 ià(
k
 == 0)

1079 
»q_keys
.
	`š£¹
(
k
);

1080 ià(
»q_keys
.
	`size
(è=ğ(
size_t
)
İ¥”Œªs
)

1084 ià(!
ro_txn
)

1085 
qu”y
.
	`em¶aû_back
(
OpTy³
::
šc
, 0);

1087 
idx
 = 0;

1088 autØ
™
 = 
»q_keys
.
	`begš
(); iˆ!ğ»q_keys.
	`’d
(); ++it) {

1089 
RWO³¿tiÚ
 
İ
;

1090 ià(!
ro_txn
 && 
idx
 >ğ
wr™e_th»sh
)

1091 
İ
.
ty³
 = 
OpTy³
::
wr™e
;

1093 
İ
.
ty³
 = 
OpTy³
::
»ad
;

1094 
İ
.
key
 = *
™
;

1095 ià(
İ
.
ty³
 =ğ
OpTy³
::
wr™e
)

1096 
İ
.
v®ue
 = op.
key
 + 1;

1097 
qu”y
.
	`push_back
(
İ
);

1098 ià(
ro_txn
 && 
idx
 =ğ(
İ¥”Œªs
/2))

1099 
qu”y
.
	`em¶aû_back
(
OpTy³
::
»ad
, 0);

1100 
idx
++;

1103 
	`as£¹
((
size_t
)
idx
 =ğ
»q_keys
.
	`size
());

1104 
	`as£¹
(
qu”y
.
	`size
(è=ğ(
size_t
)
İ¥”Œªs
 + 1);

1109 
th»ad_wÜklßd
.
	`push_back
(
qu”y
);

1112 ià(
dump_Œaû
)

1113 
	`dump_th»ad_Œaû
(
th»ad_id
, 
th»ad_wÜklßd
);

1114 
	}
}

1117 
	g‹m¶©e
 <
	gDS
>

1118 
	gSšgËRW
 : 
public
 
HÙ¥ÙRW
<
DS
> {

1119 
¡d
::
	tveùÜ
<
	tRWO³¿tiÚ
> 
	tqu”y_ty³
;

1120 
³r_th»ad_wÜklßd_š™
(
th»ad_id
è
	gov”ride
;

1123 
	g‹m¶©e
 <
	gDS
>

1124 
	gSšgËRW
<
	gDS
>::
	$³r_th»ad_wÜklßd_š™
(
th»ad_id
) {

1125 
§m¶šg
::
StoUnifÜmDi¡ributiÚ
 
	`ud
(
th»ad_id
, 0, 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
	`max
());

1127 auto& 
th»ad_wÜklßd
 = 
this
->
wÜklßds
[
th»ad_id
];

1129 
Œªs_³r_th»ad
 = 
Á¿ns
/
Áh»ads
;

1131 
i
 = 0; i < 
Œªs_³r_th»ad
; ++i) {

1132 
qu”y_ty³
 
qu”y
;

1133 
qu”y
.
	`em¶aû_back
(
OpTy³
::
šc
, 
ud
.
	`§m¶e
(è% 
ARRAY_SZ
);

1134 
th»ad_wÜklßd
.
	`push_back
(
qu”y
);

1137 ià(
dump_Œaû
)

1138 
	`dump_th»ad_Œaû
(
th»ad_id
, 
th»ad_wÜklßd
);

1139 
	}
}

1142 
	g‹m¶©e
 <
	gDS
>

1143 
	gZfRW
 : 
public
 
HÙ¥ÙRW
<
DS
> {

1144 
¡d
::
	tveùÜ
<
	tRWO³¿tiÚ
> 
	tqu”y_ty³
;

1145 
³r_th»ad_wÜklßd_š™
(
th»ad_id
è
	gov”ride
;

1148 
	g‹m¶©e
 <
	gDS
>

1149 
	gZfRW
<
	gDS
>::
	$³r_th»ad_wÜklßd_š™
(
th»ad_id
) {

1150 
§m¶šg
::
StoUnifÜmDi¡ributiÚ
 
	`ud
(
th»ad_id
, 0, 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
	`max
());

1151 
§m¶šg
::
StoRªdomDi¡ributiÚ
 *
dd
 = 
nuÎ±r
;

1153 ià(
zf_skew
 == 0.0)

1154 
dd
 = 
Ãw
 
§m¶šg
::
	`StoUnifÜmDi¡ributiÚ
(
th»ad_id
, 0, 
ARRAY_SZ
-1);

1156 
dd
 = 
Ãw
 
§m¶šg
::
	`StoZfDi¡ributiÚ
(
th»ad_id
, 0, 
ARRAY_SZ
-1, 
zf_skew
);

1158 
ušt32_t
 
ro_th»shŞd
 = (ušt32_t)(
¡d
::
num”ic_lim™s
<ušt32_t>::
	`max
(è* 
»adÚly_³rûÁ
);

1159 
ušt32_t
 
wr™e_th»shŞd
 = (ušt32_t)(
¡d
::
num”ic_lim™s
<ušt32_t>::
	`max
(è* 
wr™e_³rûÁ
);

1161 auto& 
th»ad_wÜklßd
 = 
this
->
wÜklßds
[
th»ad_id
];

1162 
Œªs_³r_th»ad
 = 
Á¿ns
 / 
Áh»ads
;

1164 
i
 = 0; i < 
Œªs_³r_th»ad
; ++i) {

1165 
qu”y_ty³
 
qu”y
;

1166 
boŞ
 
»ad_Úly
 = 
ud
.
	`§m¶e
(è< 
ro_th»shŞd
;

1167 
nİs
 = 
»ad_Úly
 ? 
İ¥”Œªs_ro
 : 
İ¥”Œªs
;

1169 
¡d
::
veùÜ
<
§m¶šg
::
šdex_t
> 
idx_£t
;

1170 
idx_£t
.
	`size
(è!ğ(
size_t
)
nİs
) {

1171 
idx_£t
.
	`push_back
(
dd
->
	`§m¶e
());

1174 autØ
idx
 : 
idx_£t
) {

1175 ià(
»ad_Úly
)

1176 
qu”y
.
	`em¶aû_back
(
OpTy³
::
»ad
, 
idx
);

1178 ià(
ud
.
	`§m¶e
(è< 
wr™e_th»shŞd
)

1179 
qu”y
.
	`em¶aû_back
(
OpTy³
::
wr™e
, 
idx
, idx + 1);

1181 
qu”y
.
	`em¶aû_back
(
OpTy³
::
»ad
, 
idx
);

1184 
th»ad_wÜklßd
.
	`push_back
(
qu”y
);

1187 ià(
dump_Œaû
)

1188 
	`dump_th»ad_Œaû
(
th»ad_id
, 
th»ad_wÜklßd
);

1190 
d–‘e
 
dd
;

1191 
	}
}

1195 
	g‹m¶©e
 <
	gDS
> 
	gR—dTh’Wr™e
 : 
public
 
DSTe¡”
<
DS
> {

1196 
ty³Çme
 
	tDSTe¡”
<
	tDS
>::
	tcÚš”_ty³
 container_type;

1197 
R—dTh’Wr™e
() {}

1198 
run
(
me
);

1201 
	g‹m¶©e
 <
	gDS
> 
	gR—dTh’Wr™e
<DS>::
	$run
(
me
) {

1202 
TTh»ad
::
	`£t_id
(
me
);

1203 
cÚš”_ty³
* 
a
 = 
this
->a;

1204 
cÚš”_ty³
::
	`th»ad_š™
(*
a
);

1206 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(0, 
ARRAY_SZ
-1);

1207 
Rªd
 
	`Œªsg’
(
š™Ÿl_£eds
[2*
me
], initial_seeds[2*me + 1]);

1209 
N
 = 
Á¿ns
/
Áh»ads
;

1210 
OPS
 = 
İ¥”Œªs
;

1211 
i
 = 0; i < 
N
; ++i) {

1213 
Rªd
 
Œªsg’_¢­
 = 
Œªsg’
;

1214 
TRANSACTION
 {

1215 
Œªsg’
 = 
Œªsg’_¢­
;

1216 autØ
g’
 = [&](è{  
	`¦Ùdi¡
(
Œªsg’
); };

1217 
	`Ä—ds
(*
a
, 
OPS
 - OPS*
wr™e_³rûÁ
, 
g’
);

1218 
	`nwr™es
(*
a
, 
OPS
*
wr™e_³rûÁ
, 
g’
);

1219 } 
	`RETRY
(
Œue
);

1221 
	}
}

1223 
	g‹m¶©e
 <
	gDS
> 
	gRªdomRWs_·»Á
 : 
public
 
DSTe¡”
<
DS
> {

1224 
ty³Çme
 
	tDSTe¡”
<
	tDS
>::
	tcÚš”_ty³
 container_type;

1225 
RªdomRWs_·»Á
() {}

1226 
	g‹m¶©e
 <
boŞ
 
	gdo_d–‘e
> 
do_run
(
me
);

1229 
	g‹m¶©e
 <
	gDS
>em¶©<
boŞ
 
	gdo_d–‘e
>

1230 
	gRªdomRWs_·»Á
<
	gDS
>::
	$do_run
(
me
) {

1231 
TTh»ad
::
	`£t_id
(
me
);

1233 
Sto
::
	`upd©e_th»adid
();

1234 #ifdeà
BOOSTING_STANDALONE


1235 
boo¡šg_th»adid
 = 
me
;

1237 
cÚš”_ty³
* 
a
 = 
this
->a;

1238 
cÚš”_ty³
::
	`th»ad_š™
(*
a
);

1242 #ià
NON_CONFLICTING


1243 
¿nge
 = 
ARRAY_SZ
/
Áh»ads
;

1244 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(
me
*
¿nge
 + 10, (me + 1) *„ange - 1 - 10);

1246 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(0, 
ARRAY_SZ
-1);

1249 
ušt32_t
 
wr™e_th»sh
 = (ušt32_tè(
wr™e_³rûÁ
 * 
Rªd
::
	`max
());

1250 
Rªd
 
	`Œªsg’
(
š™Ÿl_£eds
[2*
me
], initial_seeds[2*me + 1]);

1252 #ià
RANDOM_REPORT


1253 *
¦Ù_¥»ad
 = (*)
	`ÿÎoc
((*¦Ù_¥»adè* 
ARRAY_SZ
, 1);

1254 
fœ¡»Œy
 = 0;

1257 
N
 = 
Á¿ns
/
Áh»ads
;

1258 
OPS
 = 
İ¥”Œªs
;

1259 
i
 = 0; i < 
N
; ++i) {

1261 
Rªd
 
Œªsg’_¢­
 = 
Œªsg’
;

1262 #ià
MAINTAIN_TRUE_ARRAY_STATE


1263 
¦Ùs_wr™‹n
[
OPS
], 
n¦Ùs_wr™‹n
;

1266 
TRANSACTION
 {

1267 
boŞ
 
sucûss
 = 
Œue
;

1268 #ià
MAINTAIN_TRUE_ARRAY_STATE


1269 
n¦Ùs_wr™‹n
 = 0;

1271 
Œªsg’
 = 
Œªsg’_¢­
;

1272 #ià
ALL_UNIQUE_SLOTS


1273 
boŞ
 
u£d
[
ARRAY_SZ
] = {
çl£
};

1276 
j
 = 0; j < 
OPS
; ++j) {

1277 
¦Ù
 = 
	`¦Ùdi¡
(
Œªsg’
);

1280 #ià
ALL_UNIQUE_SLOTS


1281 
u£d
[
¦Ù
]è¦Ù = 
	`¦Ùdi¡
(
Œªsg’
);

1282 
u£d
[
¦Ù
]=
Œue
;

1285 autØ
r
 = 
	`Œªsg’
();

1290 ià(
r
 > 
wr™e_th»sh
) {

1292 
sucûss
 = 
	`doWr™e
(*
a
, 
¦Ù
, 
j
);

1295 
v®ue_ty³
 
r
;

1296 
sucûss
 = 
	`doR—d
(*
a
, 
¦Ù
, 
r
);

1298 #ià
MAINTAIN_TRUE_ARRAY_STATE


1299 
¦Ùs_wr™‹n
[
n¦Ùs_wr™‹n
++] = 
¦Ù
;

1302 
	`TXN_DO
(
sucûss
);

1304 } 
	`RETRY
(
Œue
);

1308 #ià
MAINTAIN_TRUE_ARRAY_STATE


1309 ià(
mašš_Œue_¬¿y_¡©e
) {

1310 
¡d
::
	`sÜt
(
¦Ùs_wr™‹n
, slÙs_wr™‹À+ 
n¦Ùs_wr™‹n
);

1311 autØ
™’d
 = 
»adMyWr™es
 ? 
¦Ùs_wr™‹n
 + 
n¦Ùs_wr™‹n
 : 
¡d
::
	`unique
(slots_written, slots_written +‚slots_written);

1312 autØ
™
 = 
¦Ùs_wr™‹n
; iˆ!ğ
™’d
; ++it) {

1313 
	`__sync_add_ªd_ãtch
(&
Œue_¬¿y_¡©e
[*
™
], 1);

1314 #ià
RANDOM_REPORT


1315 
¦Ù_¥»ad
[*
™
]++;

1322 #ià
RANDOM_REPORT


1323 
	`´štf
("fœ¡»Œy: %d\n", 
fœ¡»Œy
);

1324 
	`´štf
("¦Ù di¡ributiÚ (%d¿ns, %d…”¿ns): \n", 
N
, 
OPS
);

1325 
ušt64_t
 
sum
 = 0;

1326 
ušt64_t
 
tÙ®
 = 0;

1327 
ušt64_t
 
i
 = 0; i < 
ARRAY_SZ
; ++i) {

1328 
tÙ®
 +ğ
¦Ù_¥»ad
[
i
];

1329 
sum
 +ğ
i
*
¦Ù_¥»ad
[i];

1331 
št64_t
 
avg
 = 
sum
 / 
tÙ®
;

1332 
	`´štf
("avg: %Îu\n", 
avg
);

1333 
v¬
 = 0;

1334 
št64_t
 
i
 = 0; i < 
ARRAY_SZ
; ++i) {

1335 
v¬
 +ğ
¦Ù_¥»ad
[
i
] * (˜- 
avg
) * (i -‡vg);

1337 
	`´štf
("¡ddev: %Lf\n", 
	`sq¹
(
v¬
 / 
tÙ®
));

1339 
cur
 = 0;

1340 
i
 = 0; i < 
ARRAY_SZ
; ++i) {

1341 
cur
 +ğ
¦Ù_¥»ad
[
i
];

1342 ià(
i
 % (
ARRAY_SZ
/100) == (ARRAY_SZ/100 - 1)) {

1343 
	`´štf
("£ùiÚ %d has: %dƒËms\n", 
i
 / (
ARRAY_SZ
/100), 
cur
);

1344 
cur
 = 0;

1348 
i
 = 0; i < 1000; ++i) {

1349 ià(
¦Ù_¥»ad
[
i
] > 0)

1350 
	`´štf
("š£¹©: %d (%d)\n", 
i
, 
¦Ù_¥»ad
[i]);

1353 
	}
}

1356 
	g‹m¶©e
 <
	gDS
, 
boŞ
 
	gdo_d–‘e
> 
	gRªdomRWs
 : 
public
 
RªdomRWs_·»Á
<
DS
> {

1357 
ty³Çme
 
	tDSTe¡”
<
	tDS
>::
	tcÚš”_ty³
 container_type;

1358 
RªdomRWs
() {}

1359 
run
(
me
);

1360 
boŞ
 
check
();

1363 
	g‹m¶©e
 <
	gDS
, 
boŞ
 
	gdo_d–‘e
> 
	gRªdomRWs
<DS, do_d–‘e>::
	$run
(
me
) {

1364 
this
->
‹m¶©e
 
do_run
<
do_d–‘e
 && 
CÚš”
<
DS
>::
has_d–‘e
>(
me
);

1365 
	}
}

1367 
	g‹m¶©e
 <
	gDS
, 
boŞ
 
	gdo_d–‘e
> boŞ 
	gRªdomRWs
<DS, do_d–‘e>::
	$check
() {

1368 ià(
do_d–‘e
 && 
CÚš”
<
DS
>::
has_d–‘e
)

1369  
çl£
;

1371 
cÚš”_ty³
* 
Şd
 = 
this
->
a
;

1372 
cÚš”_ty³
* 
ch
 = 
Ãw
 container_type;;

1373 
this
->
a
 = 
ch
;

1376 #ià
MAINTAIN_TRUE_ARRAY_STATE


1377 
mašš_Œue_¬¿y_¡©e
 = !maintain_true_array_state;

1379 
	`´•İuÏ‹_func
(*
ch
);

1381 
i
 = 0; i < 
Áh»ads
; ++i) {

1382 
this
->
‹m¶©e
 
do_run
<
çl£
>(
i
);

1384 #ià
MAINTAIN_TRUE_ARRAY_STATE


1385 
mašš_Œue_¬¿y_¡©e
 = !maintain_true_array_state;

1387 
this
->
a
 = 
Şd
;

1389 
i
 = 0; i < 
ARRAY_SZ
; ++i) {

1390 #ià
MAINTAIN_TRUE_ARRAY_STATE


1391 ià(
Şd
->
	`nÚŒªs_g‘
(
i
è!ğ
Œue_¬¿y_¡©e
[i])

1392 
	`årštf
(
¡d”r
, "index [%d]:…arallel %d,‡tomic %d\n",

1393 
i
, 
Şd
->
	`nÚŒªs_g‘
(i), 
Œue_¬¿y_¡©e
[i]);

1395 ià(
Şd
->
	`nÚŒªs_g‘
(
i
è!ğ
ch
->nontrans_get(i))

1396 
	`årštf
(
¡d”r
, "index [%d]:…arallel %d, sequential %d\n",

1397 
i
, 
Şd
->
	`nÚŒªs_g‘
(i), 
ch
->nontrans_get(i));

1398 
	`as£¹
(
Şd
->
	`nÚŒªs_g‘
(
i
è=ğ
ch
->nontrans_get(i));

1400 
d–‘e
 
ch
;

1401 
¡d
::
cout
 << "Checked" << std::
’dl
;

1402  
Œue
;

1403 
	}
}

1406 
	g‹m¶©e
 <
	gDS
, 
boŞ
 
	gOk
 = 
CÚš”
<
DS
>::
has_d–‘e
> 
KšgD–‘e
;

1407 
	g‹m¶©e
 <
	gDS
> 
	gKšgD–‘e
<DS, 
	gçl£
> : 
public
 
DSTe¡”
<
DS
> {};

1408 
	g‹m¶©e
 <
	gDS
> 
	gKšgD–‘e
<DS, 
	gŒue
> : 
public
 
DSTe¡”
<
DS
> {

1409 
ty³Çme
 
	tDSTe¡”
<
	tDS
>::
	tcÚš”_ty³
 container_type;

1410 
KšgD–‘e
() {}

1411 
run
(
me
);

1412 
boŞ
 
check
();

1415 
	g‹m¶©e
 <
	gDS
> 
	gKšgD–‘e
<DS, 
	gŒue
>::
	$run
(
me
) {

1416 
TTh»ad
::
	`£t_id
(
me
);

1417 
cÚš”_ty³
* 
a
 = 
this
->a;

1418 
CÚš”
<
DS
>::
	`th»ad_š™
(*
a
);

1420 
TRANSACTION
 {

1421 
i
 = 0; i < 
Áh»ads
; ++i) {

1422 ià(
i
 !ğ
me
) {

1423 
a
->
	`ŒªsD–‘e
(
i
);

1425 
a
->
	`ŒªsPut
(
i
, 
	`v®
(i+1));

1428 } 
	`RETRY
(
Œue
);

1429 
	}
}

1431 
	g‹m¶©e
 <
	gDS
> 
boŞ
 
	gKšgD–‘e
<DS, 
	gŒue
>::
	$check
() {

1432 
cÚš”_ty³
* 
a
 = 
this
->a;

1433 
couÁ
 = 0;

1434 
i
 = 0; i < 
Áh»ads
; ++i) {

1435 ià(
a
->
	`nÚŒªs_g‘
(
i
)) {

1436 
couÁ
++;

1439 
	`as£¹
(
couÁ
==1);

1440  
Œue
;

1441 
	}
}

1444 
	g‹m¶©e
 <
	gDS
, 
boŞ
 
	gOk
 = 
CÚš”
<
DS
>::
has_d–‘e
> 
XÜD–‘e
;

1445 
	g‹m¶©e
 <
	gDS
> 
	gXÜD–‘e
<DS, 
	gçl£
> : 
public
 
DSTe¡”
<
DS
> {};

1446 
	g‹m¶©e
 <
	gDS
> 
	gXÜD–‘e
<DS, 
	gŒue
> : 
public
 
DSTe¡”
<
DS
> {

1447 
ty³Çme
 
	tDSTe¡”
<
	tDS
>::
	tcÚš”_ty³
 container_type;

1448 
XÜD–‘e
() {}

1449 
run
(
me
);

1450 
boŞ
 
check
();

1453 
	g‹m¶©e
 <
	gDS
> 
	gXÜD–‘e
<DS, 
	gŒue
>::
	$run
(
me
) {

1454 
TTh»ad
::
	`£t_id
(
me
);

1455 
Sto
::
	`upd©e_th»adid
();

1456 #ifdeà
BOOSTING_STANDALONE


1457 
boo¡šg_th»adid
 = 
me
;

1459 
cÚš”_ty³
* 
a
 = 
this
->a;

1460 
cÚš”_ty³
::
	`th»ad_š™
(*
a
);

1463 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(1, 
ARRAY_SZ
-1);

1464 
ušt32_t
 
d–‘e_th»sh
 = (ušt32_tè(
wr™e_³rûÁ
 * 
Rªd
::
	`max
());

1465 
Rªd
 
	`Œªsg’
(
š™Ÿl_£eds
[2*
me
], initial_seeds[2*me + 1]);

1467 
N
 = 
Á¿ns
/
Áh»ads
;

1468 
OPS
 = 
İ¥”Œªs
;

1470 
i
 = 0; i < 
N
; ++i) {

1471 
Rªd
 
Œªsg’_¢­
 = 
Œªsg’
;

1472 
TRANSACTION
 {

1473 
Œªsg’
 = 
Œªsg’_¢­
;

1474 
j
 = 0; j < 
OPS
; ++j) {

1475 
¦Ù
 = 
	`¦Ùdi¡
(
Œªsg’
);

1476 autØ
r
 = 
	`Œªsg’
();

1477 ià(
r
 > 
d–‘e_th»sh
) {

1480 
a
->
	`ŒªsUpd©e
(
¦Ù
, 
	`v®
(slot + 1));

1481 } ià(!
a
->
	`ŒªsIn£¹
(
¦Ù
, 
	`v®
(slot+1))) {

1484 
a
->
	`ŒªsD–‘e
(
¦Ù
);

1487 } 
	`RETRY
(
Œue
);

1489 
	}
}

1491 
	g‹m¶©e
 <
	gDS
> 
boŞ
 
	gXÜD–‘e
<DS, 
	gŒue
>::
	$check
() {

1492 
cÚš”_ty³
* 
Şd
 = 
this
->
a
;

1493 
cÚš”_ty³
* 
ch
 = 
Ãw
 container_type;

1494 
this
->
a
 = 
ch
;

1495 
	`´•İuÏ‹_func
(*
this
->
a
);

1497 
i
 = 0; i < 
Áh»ads
; ++i) {

1498 
	`run
(
i
);

1500 
this
->
a
 = 
Şd
;

1502 
i
 = 0; i < 
ARRAY_SZ
; ++i) {

1503 
	`as£¹
(
Şd
->
	`nÚŒªs_g‘
(
i
è=ğ
ch
->nontrans_get(i));

1505 
d–‘e
 
ch
;

1506  
Œue
;

1507 
	}
}

1510 
	g‹m¶©e
 <
	gDS
> 
	gIsŞ©edWr™es
 : 
public
 
DSTe¡”
<
DS
> {

1511 
ty³Çme
 
	tDSTe¡”
<
	tDS
>::
	tcÚš”_ty³
 container_type;

1512 
IsŞ©edWr™es
() {}

1513 
run
(
me
);

1514 
boŞ
 
check
();

1517 
	g‹m¶©e
 <
	gDS
> 
	gIsŞ©edWr™es
<DS>::
	$run
(
me
) {

1518 
TTh»ad
::
	`£t_id
(
me
);

1519 
cÚš”_ty³
* 
a
 = 
this
->a;

1520 
cÚš”_ty³
::
	`th»ad_š™
(*
a
);

1522 
TRANSACTION
 {

1523 
i
 = 0; i < 
Áh»ads
; ++i) {

1524 
a
->
	`ŒªsG‘
(
i
);

1526 
a
->
	`ŒªsPut
(
me
, 
	`v®
(me+1));

1527 } 
	`RETRY
(
Œue
);

1528 
	}
}

1530 
	g‹m¶©e
 <
	gDS
> 
boŞ
 
	gIsŞ©edWr™es
<DS>::
	$check
() {

1531 
i
 = 0; i < 
Áh»ads
; ++i) {

1532 
	`as£¹
(
this
->
a
->
	`nÚŒªs_g‘
(
i
) == i+1);

1534  
Œue
;

1535 
	}
}

1538 
	g‹m¶©e
 <
	gDS
> 
	gBlšdWr™es
 : 
public
 
DSTe¡”
<
DS
> {

1539 
ty³Çme
 
	tDSTe¡”
<
	tDS
>::
	tcÚš”_ty³
 container_type;

1540 
BlšdWr™es
() {}

1541 
run
(
me
);

1542 
boŞ
 
check
();

1545 
	g‹m¶©e
 <
	gDS
> 
	gBlšdWr™es
<DS>::
	$run
(
me
) {

1546 
TTh»ad
::
	`£t_id
(
me
);

1547 
cÚš”_ty³
* 
a
 = 
this
->a;

1548 
cÚš”_ty³
::
	`th»ad_š™
(*
a
);

1550 
TRANSACTION
 {

1551 ià(
	`unv®
(
a
->
	`ŒªsG‘
(0)è=ğ0 || 
me
 =ğ
Áh»ads
-1) {

1552 
i
 = 1; i < 
ARRAY_SZ
; ++i) {

1553 
a
->
	`ŒªsPut
(
i
, 
	`v®
(
me
));

1558 ià(
me
 =ğ
Áh»ads
-1) {

1559 
a
->
	`ŒªsPut
(0, 
	`v®
(
me
));

1561 } 
	`RETRY
(
Œue
);

1562 
	}
}

1564 
	g‹m¶©e
 <
	gDS
> 
boŞ
 
	gBlšdWr™es
<DS>::
	$check
() {

1565 
i
 = 0; i < 
ARRAY_SZ
; ++i) {

1566 
	`debug
("»ad %d\n", 
this
->
a
->
	`nÚŒªs_g‘
(
i
));

1567 
	`as£¹
(
this
->
a
->
	`nÚŒªs_g‘
(
i
è=ğ
Áh»ads
-1);

1569  
Œue
;

1570 
	}
}

1573 
	g‹m¶©e
 <
	gDS
> 
	gIÁ”ãršgRWs
 : 
public
 
DSTe¡”
<
DS
> {

1574 
ty³Çme
 
	tDSTe¡”
<
	tDS
>::
	tcÚš”_ty³
 container_type;

1575 
IÁ”ãršgRWs
() {}

1576 
run
(
me
);

1577 
boŞ
 
check
();

1580 
	g‹m¶©e
 <
	gDS
> 
	gIÁ”ãršgRWs
<DS>::
	$run
(
me
) {

1581 
TTh»ad
::
	`£t_id
(
me
);

1582 
cÚš”_ty³
* 
a
 = 
this
->a;

1583 
cÚš”_ty³
::
	`th»ad_š™
(*
a
);

1584 
N
 = 
Á¿ns
 / 
Áh»ads
;

1586 
j
 = 0; j < 
N
; j++) {

1587 
TRANSACTION
 {

1588 
i
 = 0; i < 
ARRAY_SZ
; ++i) {

1589 ià((
i
 % 
Áh»ads
è>ğ
me
) {

1590 autØ
cur
 = 
a
->
	`ŒªsG‘
(
i
);

1595 
a
->
	`ŒªsPut
(
i
, 
	`v®
(
	`unv®
(
cur
)+1));

1603 } 
	`RETRY
(
Œue
);

1605 
	}
}

1607 
	g‹m¶©e
 <
	gDS
> 
boŞ
 
	gIÁ”ãršgRWs
<DS>::
	$check
() {

1608 
i
 = 0; i < 
ARRAY_SZ
; ++i) {

1609 
	`as£¹
(
this
->
a
->
	`nÚŒªs_g‘
(
i
è=ğ(˜% 
Áh»ads
)+1);

1611  
Œue
;

1612 
	}
}

1614 #ià
DATA_STRUCTURE
 =ğ
USE_QUEUE


1615 
	$QxÜd–‘”un
(
me
) {

1616 
TTh»ad
::
	`£t_id
(
me
);

1617 
Sto
::
	`upd©e_th»adid
();

1619 
N
 = 
Á¿ns
/
Áh»ads
;

1620 
OPS
 = 
İ¥”Œªs
;

1622 
i
 = 0; i < 
N
; ++i) {

1623 
TRANSACTION
 {

1624 
j
 = 0; j < 
OPS
; ++j) {

1625 
v®ue_ty³
 
v
 = 
	`v®
(
j
);

1626 
v®ue_ty³
 
u
;

1627 ià(!
q
->
	`ŒªsFrÚt
(
t
, 
u
)) {

1629 
q
->
	`ŒªsPush
(
t
, 
v
);

1632 
q
->
	`ŒªsPİ
(
t
);

1634 } 
	`RETRY
(
Œue
);

1636 
	}
}

1638 
boŞ
 
	$QxÜd–‘echeck
() {

1639 
QueueTy³
* 
Şd
 = 
q
;

1640 
QueueTy³
& 
ch
 = *(
Ãw
 QueueType);

1641 
q
 = &
ch
;

1643 
	`em±y_func
();

1644 
	`´•İuÏ‹_func
();

1646 
i
 = 0; i < 
Áh»ads
; ++i) {

1647 
	`QxÜd–‘”un
(
i
);

1649 
q
 = 
Şd
;

1652 !
q
->
	`em±y
(è&& !
ch
.empty()) {

1653 
	`as£¹
 (
	`unv®
(
q
->
	`pİ
()è=ğunv®(
ch
.pop()));

1655  
Œue
;

1656 
	}
}

1658 
	$QŒªsã¼un
(
me
) {

1659 
TTh»ad
::
	`£t_id
(
me
);

1661 
N
 = 
Á¿ns
/
Áh»ads
;

1662 
OPS
 = 
İ¥”Œªs
;

1664 
i
 = 0; i < 
N
; ++i) {

1665 
TRANSACTION
 {

1666 
j
 = 0; j < 
OPS
; ++j) {

1667 
v®ue_ty³
 
v
;

1669 ià(
q
->
	`ŒªsFrÚt
(
t
, 
v
)) {

1670 
q
->
	`ŒªsPİ
(
t
);

1671 
q2
->
	`ŒªsPush
(
t
, 
v
);

1674 } 
	`RETRY
(
Œue
);

1676 
	}
}

1678 
boŞ
 
	$QŒªsãrcheck
() {

1680 
	`em±y_func
();

1681 
	`´•İuÏ‹_func
();

1684 !
q2
->
	`em±y
()) {

1685 
	`as£¹
 (
	`unv®
(
q
->
	`pİ
()è=ğunv®(
q2
->pop()));

1687  
Œue
;

1688 
	}
}

1690 
	sQTe¡”
 {

1691 
	mme
;

1694 * 
	$xÜrunfunc
(* 
x
) {

1695 
QTe¡”
* 
qt
 = (QTe¡”*è
x
;

1696 
	`QxÜd–‘”un
(
qt
->
me
);

1697  
nuÎ±r
;

1698 
	}
}

1700 * 
	$Œªsã¼unfunc
(* 
x
) {

1701 
QTe¡”
* 
qt
 = (QTe¡”*è
x
;

1702 
	`QŒªsã¼un
(
qt
->
me
);

1703  
nuÎ±r
;

1704 
	}
}

1706 
	$q¡¬tAndWa™
(
n
, *(*
runfunc
)(*)) {

1707 
±h»ad_t
 
tids
[
n
];

1708 
QTe¡”
 
‹¡”
[
n
];

1710 
i
 = 0; i < 
n
; ++i) {

1711 
‹¡”
[
i
].
me
 = i;

1712 
	`±h»ad_ü—‹
(&
tids
[
i
], 
NULL
, 
runfunc
, &
‹¡”
[i]);

1714 
±h»ad_t
 
advªûr
;

1715 
	`±h»ad_ü—‹
(&
advªûr
, 
NULL
, 
T¿n§ùiÚ
::
•och_advªûr
, NULL);

1716 
	`±h»ad_d‘ach
(
advªûr
);

1718 
i
 = 0; i < 
n
; ++i) {

1719 
	`±h»ad_još
(
tids
[
i
], 
NULL
);

1721 
	}
}

1724 
	sTe¡”Paœ
 {

1725 
Te¡”
* 
	mt
;

1726 
	mme
;

1727 
ušt64_t
 
	m¡¬t_tsc
;

1730 * 
	$runfunc
(* 
x
) {

1731 
Te¡”Paœ
* 

 = (Te¡”Paœ*è
x
;

1732 
	`£t_affš™y
(

->
me
 + 1);

1733 

->
t
->
	`run
Ñp->
me
,p->
¡¬t_tsc
);

1734  
nuÎ±r
;

1735 
	}
}

1737 
	$¡¬tAndWa™
(
n
, 
Te¡”
* 
‹¡”
, 
ušt64_t
 
¡¬t_tsc
) {

1738 
±h»ad_t
 
tids
[
n
];

1739 
Te¡”Paœ
 
‹¡”s
[
n
];

1740 
i
 = 0; i < 
n
; ++i) {

1741 
‹¡”s
[
i
].
t
 = 
‹¡”
;

1742 
‹¡”s
[
i
].
me
 = i;

1743 
‹¡”s
[
i
].
¡¬t_tsc
 = start_tsc;

1744 
	`±h»ad_ü—‹
(&
tids
[
i
], 
NULL
, 
runfunc
, &
‹¡”s
[i]);

1746 
±h»ad_t
 
advªûr
;

1747 
	`±h»ad_ü—‹
(&
advªûr
, 
NULL
, 
T¿n§ùiÚ
::
•och_advªûr
, NULL);

1748 
	`±h»ad_d‘ach
(
advªûr
);

1750 
i
 = 0; i < 
n
; ++i) {

1751 
	`±h»ad_još
(
tids
[
i
], 
NULL
);

1753 
	}
}

1756 
	$´št_time
(
timev®
 
tv1
, timev® 
tv2
) {

1757 
	`´štf
("%f\n", (
tv2
.
tv_£c
-
tv1
.tv_£cè+ (tv2.
tv_u£c
-tv1.tv_usec)/1000000.0);

1758 
	}
}

1760 
	$´št_time
(
time
) {

1761 
	`´štf
("%f\n", 
time
);

1762 
	}
}

1764 
	#MAKE_TESTER
(
Çme
, 
desc
, 
ty³
, ...) \

1765 {
Çme
, 
desc
, 0, 
Ãw
 
ty³
<0, ## 
__VA_ARGS__
>}, \

1766 {
Çme
, 
desc
, 10, 
Ãw
 
ty³
<10, ## 
__VA_ARGS__
>}, \

1767 {
Çme
, 
desc
, 11, 
Ãw
 
ty³
<11, ## 
__VA_ARGS__
>}, \

1768 {
Çme
, 
desc
, 12, 
Ãw
 
ty³
<12, ## 
__VA_ARGS__
>}, \

1769 {
Çme
, 
desc
, 14, 
Ãw
 
ty³
<14, ## 
__VA_ARGS__
>}

	)

1780 
	sTe¡
 {

1781 cÚ¡ * 
	mÇme
;

1782 cÚ¡ * 
	mdesc
;

1783 
	mds
;

1784 
Te¡”
* 
	m‹¡”
;

1785 } 
	g‹¡s
[] = {

1789 
MAKE_TESTER
("¿ndomrw", "typiÿÎy be¡ choiû", 
RªdomRWs
, 
çl£
),

1794 
MAKE_TESTER
("hÙ¥Ù", "cÚ‹ndšg hÙ¥Ù", 
HÙ¥ÙRW
),

1795 
MAKE_TESTER
("hÙ¥Ù2", "cÚ‹ndšg hÙ¥Ù (Ës ¡upid)", 
HÙ¥Ù2RW
),

1796 
MAKE_TESTER
("sšgËrw", "šüem’ˆ¨sšgË„ªdomƒËm’t", 
SšgËRW
),

1797 
MAKE_TESTER
("zäw", "Zà¿ndom„w", 
ZfRW
)

1801 cÚ¡ * 
	mÇme
;

1802 
	mds
;

1803 } 
	gds_Çmes
[] = {

1804 {"¬¿y", 
USE_ARRAY
},

1805 {"¬¿y-nÚİaque", 
USE_ARRAY_NONOPAQUE
},

1806 {"¬¿y-ad­tive", 
USE_ARRAY_ADAPTIVE
},

1807 {"¬¿y-tiùoc", 
USE_ARRAY_TICTOC
},

1808 {"hashbË", 
USE_HASHTABLE
},

1809 {"hash", 
USE_HASHTABLE
},

1810 {"hash-¡r", 
USE_HASHTABLE_STR
},

1811 {"mas¡»e", 
USE_MASSTREE
},

1812 {"mass", 
USE_MASSTREE
},

1813 {"mas¡»e-¡r", 
USE_MASSTREE_STR
},

1814 {"tg’”ic", 
USE_TGENERICARRAY
},

1815 {"queue", 
USE_QUEUE
},

1817 {"tveùÜ", 
USE_TVECTOR
},

1818 {"swis§¼ay", 
USE_SWISSARRAY
}

1823 
	mİt_‹¡
 = 1, 
	mİt_Ämyw
, 
	mİt_check
, 
	mİt_´ofe
, 
	mİt_dump
, 
	mİt_Áh»ads
, 
	mİt_Á¿ns
, 
	mİt_İ¥”Œªs
, 
	mİt_İ¥”Œªs_ro
, 
	mİt_wr™•”ûÁ
, 
	mİt_»adÚly³rûÁ
, 
	mİt_blšd¿ndwr™es
, 
	mİt_´•İuÏ‹
, 
	mİt_£ed
, 
	mİt_skew


1826 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

1827 { "no-»admywr™es", 'n', 
İt_Ämyw
, 0, 0 },

1828 { "check", 'c', 
İt_check
, 0, 
CÍ_Neg©e
 },

1829 { "´ofe", 'p', 
İt_´ofe
, 0, 
CÍ_Neg©e
},

1830 { "dump", 'd', 
İt_dump
, 0, 
CÍ_Neg©e
},

1831 { "Áh»ads", 'j', 
İt_Áh»ads
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

1832 { "Á¿ns", 0, 
İt_Á¿ns
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

1833 { "İ¥”Œªs", 0, 
İt_İ¥”Œªs
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

1834 { "İ¥”Œªs_ro", 0, 
İt_İ¥”Œªs_ro
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

1835 { "wr™•”ûÁ", 0, 
İt_wr™•”ûÁ
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

1836 { "»adÚly³rûÁ", 0, 
İt_»adÚly³rûÁ
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

1837 { "blšd¿ndwr™es", 0, 
İt_blšd¿ndwr™es
, 0, 
CÍ_Neg©e
 },

1838 { "´•İuÏ‹", 0, 
İt_´•İuÏ‹
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

1839 { "£ed", 's', 
İt_£ed
, 
CÍ_V®UnsigÃd
, 0 },

1840 { "skew", 0, 
İt_skew
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
}

1843 
	$h–p
(cÚ¡ *
Çme
) {

1844 
	`´štf
("Usage: %sest-number [OPTIONS]\n\
:\n\
-n, --no-readmywrites\n\
-c, --check,„un‡ check ofhe„esults‡fterwards\n\
-p, --profile,„un‡…erf…rofile ofheƒxecution…orition ofhe benchmark\n\
-d, --dump, dumphe workloadƒxecuted byƒachhread (works only for hotspot (8))\n\
--nthreads=NTHREADS (default %d)\n\
--ntrans=NTRANS, how manyotalransactionso„un (they'll be split betweenhreads) (default %d)\n\
--opspertrans=OPSPERTRANS, how many operationso„un…erransaction (default %d)\n\
--opspertrans_ro=OPRP, how many operations in„ead onlyransactions (defaulto opspertrans)\n\
--writepercent=WRITEPERCENT,…robability with whicho do writes versus„eads (default %f)\n\
--readonlypercent=ROPERCENT,…robability with which‡ransaction is„ead-only (default %f)\n\
--blindrandwrites, do blind„andom writes for„andomests. makes checking impossible\n\
--prepopulate=PREPOPULATE,…repopulateable with given‚umber of items (default %d)\n\
--seed=SEED\n\
--skew=SKEW, skew…arameter for zipfrwestype (default %f)\n",

1860 
Çme
, 
Áh»ads
, 
Á¿ns
, 
İ¥”Œªs
, 
wr™e_³rûÁ
, 
»adÚly_³rûÁ
, 
´•İuÏ‹
, 
zf_skew
);

1861 
	`´štf
("\nTests:\n");

1862 
size_t
 
‹¡idx
 = 0;

1863 
size_t
 
ti
 = 0;˜!ğ(
‹¡s
)/(tests[0]); ++ti)

1864 ià(
ti
 =ğ0 || 
	`¡rcmp
(
‹¡s
[ti].
Çme
,ests[ti-1].name) != 0) {

1865 ià(
‹¡s
[
ti
].
desc
)

1866 
	`´štf
(" %zu: %-10 (%s)\n", 
‹¡idx
, 
‹¡s
[
ti
].
Çme
,e¡s[ti].
desc
);

1868 
	`´štf
(" %zu: %s\n", 
‹¡idx
, 
‹¡s
[
ti
].
Çme
);

1869 ++
‹¡idx
;

1871 
	`´štf
("\nData structures:\n");

1872 
size_t
 
ti
 = 0;˜!ğ(
ds_Çmes
)/(ds_names[0]); ++ti)

1873 
	`´štf
(" %s", 
ds_Çmes
[
ti
].
Çme
);

1874 
	`´štf
("\n");

1875 
	`ex™
(1);

1876 
	}
}

1878 
	$time_ªd_run
(*
»®_time
,

1879 
ru§ge
* 
ru1
, ru§ge* 
ru2
,

1880 
Áh»ads
, 
Te¡”
* 
‹¡”
) {

1881 
t1
 = 
	`»ad_tsc
();

1882 
	`g‘ru§ge
(
RUSAGE_SELF
, 
ru1
);

1883 
	`¡¬tAndWa™
(
Áh»ads
, 
‹¡”
, 
t1
);

1884 
t2
 = 
	`»ad_tsc
();

1885 
	`g‘ru§ge
(
RUSAGE_SELF
, 
ru2
);

1886 *
»®_time
 = (()(
t2
-
t1
)è/ 
BILLION
 / 
PROC_TSC_FREQ
;

1887 
‹¡”
->
	`»pÜt
();

1888 
	}
}

1890 
	$maš
(
¬gc
, *
¬gv
[]) {

1891 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
	`¬¿ysize
(
İtiÚs
), options);

1893 
ds
 = 
DATA_STRUCTURE
;

1894 cÚ¡ * 
‹¡_Çme
 = 
nuÎ±r
;

1895 
£ed
 = 
GLOBAL_SEED
;

1897 
İt
;

1898 (
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
) {

1899 
İt
) {

1900 
CÍ_NÙO±iÚ
:

1901 
size_t
 
ti
 = 0;˜!ğ(
ds_Çmes
) / (ds_names[0]); ++ti)

1902 ià(
	`¡rcmp
(
ds_Çmes
[
ti
].
Çme
, 
şp
->
v¡r
) == 0) {

1903 
ds
 = 
ds_Çmes
[
ti
].ds;

1904 
found_ds
;

1906 
‹¡_Çme
 = 
şp
->
v¡r
;

1907 
found_ds
: ;

1908 
İt_Ämyw
:

1909 
»adMyWr™es
 = 
çl£
;

1911 
İt_check
:

1912 
runCheck
 = !
şp
->
Ãg©ed
;

1914 
İt_´ofe
:

1915 
´ofe
 = !
şp
->
Ãg©ed
;

1917 
İt_dump
:

1918 
dump_Œaû
 = !
şp
->
Ãg©ed
;

1920 
İt_Áh»ads
:

1921 
Áh»ads
 = 
şp
->
v®
.
i
;

1923 
İt_Á¿ns
:

1924 
Á¿ns
 = 
şp
->
v®
.
i
;

1926 
İt_İ¥”Œªs
:

1927 
İ¥”Œªs
 = 
şp
->
v®
.
i
;

1929 
İt_İ¥”Œªs_ro
:

1930 
İ¥”Œªs_ro
 = 
şp
->
v®
.
i
;

1932 
İt_wr™•”ûÁ
:

1933 
wr™e_³rûÁ
 = 
şp
->
v®
.
d
;

1935 
İt_»adÚly³rûÁ
:

1936 
»adÚly_³rûÁ
 = 
şp
->
v®
.
d
;

1938 
İt_blšd¿ndwr™es
:

1939 
blšdRªdomWr™e
 = !
şp
->
Ãg©ed
;

1941 
İt_´•İuÏ‹
:

1942 
´•İuÏ‹
 = 
şp
->
v®
.
i
;

1944 
İt_£ed
:

1945 
£ed
 = 
şp
->
v®
.
u
;

1947 
İt_skew
:

1948 
zf_skew
 = 
şp
->
v®
.
d
;

1951 
	`h–p
(
¬gv
[0]);

1955 ià(
İ¥”Œªs_ro
 == -1)

1956 
İ¥”Œªs_ro
 = 
İ¥”Œªs
;

1958 
	`CÍ_D–‘eP¬£r
(
şp
);

1960 ià(
£ed
)

1961 
	`¤ªdom
(
£ed
);

1963 
	`¤ªdomdev
();

1964 
i
 = 0; i < 
	`¬¿ysize
(
š™Ÿl_£eds
); ++i) {

1965 autØ
¿
 = 
	`¿ndom
();

1967 
š™Ÿl_£eds
[
i
] = 
¿
;

1971 #ià
DATA_STRUCTURE
 =ğ
USE_QUEUE


1972 
QueueTy³
 
¡ack_q
;

1973 
QueueTy³
 
¡ack_q2
;

1974 
q
 = &
¡ack_q
;

1975 
q2
 = &
¡ack_q2
;

1977 
	`em±y_func
();

1978 
	`´•İuÏ‹_func
();

1979 
	`q¡¬tAndWa™
(
Áh»ads
, 
xÜrunfunc
);

1980 
	`as£¹
(
	`QxÜd–‘echeck
());

1982 
	`em±y_func
();

1983 
	`´•İuÏ‹_func
();

1984 
	`q¡¬tAndWa™
(
Áh»ads
, 
Œªsã¼unfunc
);

1985 
	`as£¹
(
	`QŒªsãrcheck
());

1988 
‹¡idx
 = 0;

1989 
‹¡
 = -1;

1990 
size_t
 
ti
 = 0;˜!ğ(
‹¡s
) / (tests[0]); ++ti) {

1991 ià(
ti
 > 0 && 
	`¡rcmp
(
‹¡s
[ti].
Çme
,ests[ti-1].name) != 0)

1992 ++
‹¡idx
;

1993 ià(
‹¡s
[
ti
].
ds
 == ds

1994 && 
‹¡_Çme


1995 && (
	`isdig™
((è
‹¡_Çme
[0])

1996 ? 
	`©oi
(
‹¡_Çme
è=ğ
‹¡idx


1997 : 
	`¡rcmp
(
‹¡s
[
ti
].
Çme
, 
‹¡_Çme
) == 0)) {

1998 
‹¡
 = 
ti
;

2003 ià(
‹¡
 == -1) {

2004 
	`h–p
(
¬gv
[0]);

2007 ià(
Áh»ads
 > 
MAX_THREADS
) {

2008 
	`´štf
("Asked fÜ %dh»ad buˆMAX_THREADS i %d\n", 
Áh»ads
, 
MAX_THREADS
);

2009 
	`ex™
(1);

2012 ià(!
	`¡rcmp
(
‹¡s
[
‹¡
].
Çme
, "zäw"è&& (
zf_skew
 < 0.0 || zipf_skew >= 1000.0)) {

2013 
	`´štf
("PËa£ƒÁ”‡ skew…¬am‘” b‘w“À0‡nd 1000 (cu¼’yƒÁ”ed %f)\n", 
zf_skew
);

2014 
	`ex™
(1);

2017 ià(
´ofe
) {

2018 
	`´štf
("INFO: System…rofiler will be spawned‡fter initialization.\n");

2021 
Te¡”
* 
‹¡”
 = 
‹¡s
[
‹¡
].tester;

2022 
‹¡”
->
	`š™Ÿlize
();

2024 
»®_time
;

2025 
ru§ge
 
ru1
,
ru2
;

2026 ià(
´ofe
) {

2027 
Prof”
::
	`´ofe
([&]() {

2028 
	`time_ªd_run
(&
»®_time
, &
ru1
, &
ru2
, 
Áh»ads
, 
‹¡”
);

2031 
	`time_ªd_run
(&
»®_time
, &
ru1
, &
ru2
, 
Áh»ads
, 
‹¡”
);

2034 
‹¡”
->
	`fš®ize
();

2036 #ià!
DATA_COLLECT


2037 
	`´štf
("realime: ");

2039 
	`´št_time
(
»®_time
);

2040 #ià!
DATA_COLLECT


2041 
	`´štf
("utime: ");

2042 
	`´št_time
(
ru1
.
ru_utime
, 
ru2
.ru_utime);

2043 
	`´štf
("stime: ");

2044 
	`´št_time
(
ru1
.
ru_¡ime
, 
ru2
.ru_stime);

2046 
size_t
 
dsi
 = 0;

2047 
ds_Çmes
[
dsi
].
ds
 != ds)

2048 ++
dsi
;

2049 
	`´štf
("Rªe¡ % %s\n", 
‹¡s
[
‹¡
].
Çme
, 
ds_Çmes
[
dsi
].name);

2050 
	`´štf
(" ARRAY_SZ: %d,„eadmywrites: %d,„esult check: %d, %dhreads, %dransactions, %d ops…erransaction, %f%% writes,…repopulate: %d, blindrandwrites: %d\n \
_TRUE_ARRAY_STATE: %d, INIT_SET_SIZE: %d, GLOBAL_SEED: %d, STO_PROFILE_COUNTERS: %d\n",

2052 
ARRAY_SZ
, 
»adMyWr™es
, 
runCheck
, 
Áh»ads
, 
Á¿ns
, 
İ¥”Œªs
, 
wr™e_³rûÁ
*100, 
´•İuÏ‹
, 
blšdRªdomWr™e
,

2053 
MAINTAIN_TRUE_ARRAY_STATE
, 
T¿n§ùiÚ
::
t£t_š™Ÿl_ÿ·c™y
, 
£ed
, 
STO_PROFILE_COUNTERS
);

2054 ià(!
	`¡rcmp
(
‹¡s
[
‹¡
].
Çme
, "zipfrw"))

2055 
	`´štf
(" Zàdi¡ributiÚ…¬am‘”(s): zf_skew = %f,„—d-ÚlyxÀ´ob. = %f, wr™´ob. = %f\n", 
zf_skew
, 
»adÚly_³rûÁ
, 
wr™e_³rûÁ
);

2056 
	`´štf
(" STO_SORT_WRITESET: %d\n", 
STO_SORT_WRITESET
);

2059 #ià
STO_PROFILE_COUNTERS


2060 
T¿n§ùiÚ
::
	`´št_¡©s
();

2061 ià(
txp_couÁ
 >ğ
txp_tÙ®_abÜts
) {

2062 
txp_couÁ”s
 
tc
 = 
T¿n§ùiÚ
::
	`txp_couÁ”s_combšed
();

2063 cÚ¡ * 
£p
 = "";

2064 ià(
txp_couÁ
 > 
txp_tÙ®_w
) {

2065 
	`´štf
("%¡Ù®_n: %Îu,Ù®_r: %Îu,Ù®_w: %Îu", 
£p
, 
tc
.
	`p
(
txp_tÙ®_n
),c.p(
txp_tÙ®_r
),c.p(
txp_tÙ®_w
));

2066 
£p
 = ", ";

2068 ià(
txp_couÁ
 > 
txp_tÙ®_£¬ched
) {

2069 
	`´štf
("%¡Ù®_£¬ched: %Îu", 
£p
, 
tc
.
	`p
(
txp_tÙ®_£¬ched
));

2070 
£p
 = ", ";

2072 ià(
txp_couÁ
 > 
txp_tÙ®_abÜts
) {

2073 
	`´štf
("%¡Ù®_abÜts: %Îu (%Îu‡bÜt © comm™ime, %Îu iÀob£rve, %Îu dutØwr™lockime-outs)\ÀCM::should_abÜt: %Îu, CM::Ú_wr™e: %Îu, CM::Ú_rŞlback: %Îu, CM::¡¬t: %Îu\ÀAÎoÿ‹‚ew i‹ms: %Îu, BV h™: %Îu", 
£p
, 
tc
.
	`p
(
txp_tÙ®_abÜts
),c.p(
txp_comm™_time_abÜts
),c.p(
txp_ob£rve_lock_abÜts
),c.p(
txp_lock_abÜts
),c.p(
txp_cm_shouldabÜt
),c.p(
txp_cm_Úwr™e
),c.p(
txp_cm_ÚrŞlback
),c.p(
txp_cm_¡¬t
),c.p(
txp_®loÿ‹
),c.p(
txp_bv_h™
));

2074 
£p
 = ", ";

2076 ià(*
£p
)

2077 
	`´štf
("\n");

2081 ià(
runCheck
) {

2082 ià(
‹¡”
->
	`check
())

2083 
	`´štf
("Check succeeded\n");

2085 
	`´štf
("CHECK FAILED\n");

2088 
	}
}

	@test/concurrentqueue.cc

1 
	~<io¡»am
>

2 
	~<as£¹.h
>

3 
	~<¿ndom
>

4 
	~<şim™s
>

5 
	~<sys/time.h
>

6 
	~<sys/»sourû.h
>

8 
	~"T¿n§ùiÚ.hh
"

9 
	~"şp.h
"

10 
	~"Queue.hh
"

11 
	~"¿ndg’.hh
"

14 
	#QUEUE_SZ
 4096

	)

17 
	#GLOBAL_SEED
 0

	)

18 
	#TRY_READ_MY_WRITES
 0

	)

19 
	#MAINTAIN_TRUE_ARRAY_STATE
 1

	)

22 
	#DATA_COLLECT
 0

	)

23 
	#RANDOM_REPORT
 0

	)

24 
	#STRING_VALUES
 0

	)

25 
	#UNBOXED_STRINGS
 0

	)

29 #ifdeà
DEBUG


30 
	#debug
(...è
	`´štf
(
__VA_ARGS__
)

	)

32 
	#debug
(...è

	)

35 #ià
STRING_VALUES


36 
	g¡d
::
	t¡ršg
 
	tv®ue_ty³
;

38 
	tv®ue_ty³
;

41 
	gQueue
<
	tv®ue_ty³
> 
	tQueueTy³
;

42 
QueueTy³
* 
	gq
;

43 
QueueTy³
* 
	gq2
;

45 
boŞ
 
	g»adMyWr™es
 = 
Œue
;

46 
boŞ
 
	grunCheck
 = 
çl£
;

47 
	gÁh»ads
 = 4;

48 
	gÁ¿ns
 = 1000000;

49 
	gİ¥”Œªs
 = 10;

50 
	g´•İuÏ‹
 = 
QUEUE_SZ
/8;

51 
	gwr™e_³rûÁ
 = 0.5;

52 
boŞ
 
	gblšdRªdomWr™e
 = 
çl£
;

54 
usšg
 
Çme¥aû
 
	g¡d
;

56 
šlše
 
v®ue_ty³
 
	$v®
(
v
) {

57 #ià
STRING_VALUES


58 
s
[64];

59 
	`¥rštf
(
s
, "%d", 
v
);

60  
¡d
::
	`move
(¡d::
	`¡ršg
(
s
));

62  
v
;

64 
	}
}

66 
šlše
 
	$unv®
(cÚ¡ 
v®ue_ty³
& 
v
) {

67 #ià
STRING_VALUES


68  
	`©oi
(
v
.
	`c_¡r
());

70  
v
;

72 
	}
}

74 
	$doR—d
(
T¿n§ùiÚ
& 
t
) {

75 ià(
»adMyWr™es
) {

76 
v®ue_ty³
 
v
;

77 
q
->
	`ŒªsFrÚt
(
t
, 
v
);

78 
q
->
	`ŒªsPİ
(
t
);

80 
	}
}

82 
	$doWr™e
(
T¿n§ùiÚ
& 
t
, & 
ùr
) {

83 
q
->
	`ŒªsPush
(
t
, 
	`v®
(
ùr
));

84 ++
ùr
;

85 
	}
}

87 
šlše
 
	$Ä—ds
(
n
, 
T¿n§ùiÚ
& 
t
) {

88 
i
 = 0; i < 
n
; ++i) {

89 
	`doR—d
(
t
);

91 
	}
}

92 
šlše
 
	$nwr™es
(
n
, 
T¿n§ùiÚ
& 
t
) {

93 
i
 = 0; i < 
n
; ++i) {

94 
	`doWr™e
(
t
, 
i
);

96 
	}
}

98 *
	$¿ndomRWs
(*
p
) {

99 
me
 = (
šŒ_t
)
p
;

100 
TTh»ad
::
id
 = 
me
;

103 
ušt32_t
 
wr™e_th»sh
 = (ušt32_tè(
wr™e_³rûÁ
 * 
Rªd
::
	`max
());

105 
N
 = 
Á¿ns
/
Áh»ads
;

106 
OPS
 = 
İ¥”Œªs
;

107 
i
 = 0; i < 
N
; ++i) {

109 autØ
Œªs£ed
 = 
i
;

111 
boŞ
 
dÚe
 = 
çl£
;

113 
Œy
{

114 
ušt32_t
 
£ed
 = 
Œªs£ed
*3 + (ušt32_t)
me
*
N
*7 + (ušt32_t)
GLOBAL_SEED
*
MAX_THREADS
*N*11;

115 autØ
£edlow
 = 
£ed
 & 0xffff;

116 autØ
£edhigh
 = 
£ed
 >> 16;

117 
Rªd
 
	`Œªsg’
(
£ed
, 
£edlow
 << 16 | 
£edhigh
);

119 
T¿n§ùiÚ
 
t
;

120 
j
 = 0; j < 
OPS
; ++j) {

122 autØ
r
 = 
	`Œªsg’
();

123 ià(
r
 > 
wr™e_th»sh
) {

124 
	`doR—d
(
t
);

126 
	`doWr™e
(
t
, 
j
);

129 ià(
t
.
	`comm™
())

131 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
E
) {}

132 ià(!
dÚe
) {

133 
	`debug
("th»ad%d„‘ryšg\n", 
me
);

137  
NULL
;

138 
	}
}

140 
	$checkRªdomRWs
() {

141 
QueueTy³
 *
Şd
 = 
q
;

142 
QueueTy³
 
check
;

143 
q
 = &
check
;

145 
i
 = 0; i < 
´•İuÏ‹
; ++i) {

146 
T¿n§ùiÚ
 
t
;

147 
q
->
	`ŒªsPush
(
t
, 
	`v®
(0));

148 
t
.
	`comm™
();

151 
i
 = 0; i < 
Áh»ads
; ++i) {

152 
	`¿ndomRWs
((*)(
šŒ_t
)
i
);

155 
q
 = 
Şd
;

156 !
q
->
	`em±y
()) {

157 ià(
	`unv®
(
q
->
	`pİ
()è!ğunv®(
check
.pop()))

158 
	`årštf
(
¡d”r
, "·¿Î– %d, sequ’tŸÈ%d\n", 
	`unv®
(
q
->
	`pİ
()), unv®(
check
.pop()));

160 
	`as£¹
(
check
.
	`em±y
(è=ğ
q
->empty());

161 
	}
}

164 *
	$xÜD–‘e
(*
p
) {

165 
me
 = (
šŒ_t
)
p
;

166 
TTh»ad
::
id
 = 
me
;

168 
N
 = 
Á¿ns
/
Áh»ads
;

169 
OPS
 = 
İ¥”Œªs
;

171 ià(
me
 == 0) {

173 
T¿n§ùiÚ
 
t
;

174 
i
 = 0; i < 
´•İuÏ‹
; ++i) {

175 
q
->
	`ŒªsPush
(
t
, 
	`v®
(
i
));

177 
	`as£¹
(
t
.
	`comm™
());

180 
q
->
	`em±y
()) {}

183 
i
 = 0; i < 
N
; ++i) {

185 
Œy
 {

186 
T¿n§ùiÚ
 
t
;

187 
j
 = 0; j < 
OPS
; ++j) {

188 
v®ue_ty³
 
v
 = 
	`v®
(1);

189 ià(!
q
->
	`ŒªsPİ
(
t
)) {

191 
q
->
	`ŒªsPush
(
t
, 
v
);

194 ià(
t
.
	`comm™
())

196 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
E
) {}

199  
NULL
;

200 
	}
}

202 
	$checkXÜD–‘e
() {

203 
QueueTy³
 *
Şd
 = 
q
;

204 
QueueTy³
 
check
;

205 
q
 = &
check
;

207 
i
 = 0; i < 
Áh»ads
; ++i) {

208 
	`xÜD–‘e
((*)(
šŒ_t
)
i
);

210 
q
 = 
Şd
;

212 !
q
->
	`em±y
()) {

213 ià(
	`unv®
(
q
->
	`pİ
()è!ğunv®(
check
.pop()))

214 
	`årštf
(
¡d”r
, "·¿Î– %d, sequ’tŸÈ%d\n", 
	`unv®
(
q
->
	`pİ
()), unv®(
check
.pop()));

216 
	`as£¹
(
check
.
	`em±y
(è=ğ
q
->empty());

217 
	}
}

220 *
	$queueT¿nsãr
(*
p
) {

221 
me
 = (
šŒ_t
)
p
;

222 
TTh»ad
::
id
 = 
me
;

224 
N
 = 
Á¿ns
/
Áh»ads
;

225 
OPS
 = 
İ¥”Œªs
;

227 ià(
me
 == 0) {

229 
T¿n§ùiÚ
 
t
;

230 
i
 = 0; i < 
´•İuÏ‹
; ++i) {

231 
q
->
	`ŒªsPush
(
t
, 
	`v®
(
i
));

233 
	`as£¹
(
t
.
	`comm™
());

236 
q
->
	`em±y
()) {}

239 
i
 = 0; i < 
N
; ++i) {

241 
Œy
 {

242 
T¿n§ùiÚ
 
t
;

243 
j
 = 0; j < 
OPS
; ++j) {

244 
v®ue_ty³
 
v
;

246 ià(
q
->
	`ŒªsFrÚt
(
t
, 
v
)) {

247 
q
->
	`ŒªsPİ
(
t
);

248 
q2
->
	`ŒªsPush
(
t
, 
v
);

251 ià(
t
.
	`comm™
())

253 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
E
) {}

256  
NULL
;

257 
	}
}

259 
	$checkQueueT¿nsãr
() {

261 
i
 = 0; i < 
´•İuÏ‹
; ++i) {

262 
q
->
	`push
(
	`v®
(
i
));

265 
i
 = 0; i < 
Áh»ads
; ++i) {

266 
	`queueT¿nsãr
((*)(
šŒ_t
)
i
);

270 
i
 = 0; i < 
´•İuÏ‹
; ++i) {

271 
q
->
	`push
(
	`v®
(
i
));

274 !
q
->
	`em±y
()) {

275 ià(
	`unv®
(
q
->
	`pİ
()è!ğunv®(
q2
->pop()))

276 
	`årštf
(
¡d”r
, "·¿Î– %d, sequ’tŸÈ%d\n", 
	`unv®
(
q
->
	`pİ
()), unv®(
q2
->pop()));

278 
	`as£¹
(
q
->
	`em±y
(è=ğ
q2
->empty());

279 
	}
}

281 
	$¡¬tAndWa™
(
n
, *(*
¡¬t_routše
) (*)) {

282 
±h»ad_t
 
tids
[
n
];

283 
i
 = 0; i < 
n
; ++i) {

284 
	`±h»ad_ü—‹
(&
tids
[
i
], 
NULL
, 
¡¬t_routše
, (*)(
šŒ_t
)i);

286 
±h»ad_t
 
advªûr
;

287 
	`±h»ad_ü—‹
(&
advªûr
, 
NULL
, 
T¿n§ùiÚ
::
•och_advªûr
, NULL);

288 
	`±h»ad_d‘ach
(
advªûr
);

290 
i
 = 0; i < 
n
; ++i) {

291 
	`±h»ad_još
(
tids
[
i
], 
NULL
);

293 
	}
}

295 
	$´št_time
(
timev®
 
tv1
, timev® 
tv2
) {

296 
	`´štf
("%f\n", (
tv2
.
tv_£c
-
tv1
.tv_£cè+ (tv2.
tv_u£c
-tv1.tv_usec)/1000000.0);

297 
	}
}

299 
	sTe¡
 {

300 *(*
	mth»adfunc
) (*);

301 (*
	mcheckfunc
) ();

304 
Te¡
 
	g‹¡s
[] = {

305 {
¿ndomRWs
, 
checkRªdomRWs
},

306 {
xÜD–‘e
, 
checkXÜD–‘e
},

307 {
queueT¿nsãr
, 
checkQueueT¿nsãr
}

311 
	mİt_‹¡
 = 1, 
	mİt_Ämyw
, 
	mİt_check
, 
	mİt_Áh»ads
, 
	mİt_Á¿ns
, 
	mİt_İ¥”Œªs
, 
	mİt_wr™•”ûÁ
, 
	mİt_blšd¿ndwr™es
, 
	mİt_´•İuÏ‹


314 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

315 { "no-»admywr™es", 'n', 
İt_Ämyw
, 0, 0 },

316 { "check", 'c', 
İt_check
, 0, 
CÍ_Neg©e
 },

317 { "Áh»ads", 0, 
İt_Áh»ads
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

318 { "Á¿ns", 0, 
İt_Á¿ns
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

319 { "İ¥”Œªs", 0, 
İt_İ¥”Œªs
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

320 { "wr™•”ûÁ", 0, 
İt_wr™•”ûÁ
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

321 { "blšd¿ndwr™es", 0, 
İt_blšd¿ndwr™es
, 0, 
CÍ_Neg©e
 },

322 { "´•İuÏ‹", 0, 
İt_´•İuÏ‹
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

325 
	$h–p
(cÚ¡ *
Çme
) {

326 
	`´štf
("Usage: %sest-number [OPTIONS]\n\
:\n\
-n, --no-readmywrites\n\
-c, --check,„un‡ check ofhe„esults‡fterwards\n\
--nthreads=NTHREADS (default %d)\n\
--ntrans=NTRANS, how manyotalransactionso„un (they'll be split betweenhreads) (default %d)\n\
--opspertrans=OPSPERTRANS, how many operationso„un…erransaction (default %d)\n\
--writepercent=WRITEPERCENT,…robability with whicho do writes versus„eads (default %f)\n\
--blindrandwrites, do blind„andom writes for„andomests. makes checking impossible\n\
--prepopulate=PREPOPULATE,…repopulateable with given‚umber of items (default %d)\n",

336 
Çme
, 
Áh»ads
, 
Á¿ns
, 
İ¥”Œªs
, 
wr™e_³rûÁ
, 
´•İuÏ‹
);

337 
	`ex™
(1);

338 
	}
}

340 
	$maš
(
¬gc
, *
¬gv
[]) {

341 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
	`¬¿ysize
(
İtiÚs
), options);

343 
‹¡
 = -1;

345 
İt
;

346 (
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
) {

347 
İt
) {

348 
CÍ_NÙO±iÚ
:

349 
‹¡
 = 
	`©oi
(
şp
->
v¡r
);

351 
İt_Ämyw
:

352 
»adMyWr™es
 = 
çl£
;

354 
İt_check
:

355 
runCheck
 = !
şp
->
Ãg©ed
;

357 
İt_Áh»ads
:

358 
Áh»ads
 = 
şp
->
v®
.
i
;

360 
İt_Á¿ns
:

361 
Á¿ns
 = 
şp
->
v®
.
i
;

363 
İt_İ¥”Œªs
:

364 
İ¥”Œªs
 = 
şp
->
v®
.
i
;

366 
İt_wr™•”ûÁ
:

367 
wr™e_³rûÁ
 = 
şp
->
v®
.
d
;

369 
İt_blšd¿ndwr™es
:

370 
blšdRªdomWr™e
 = !
şp
->
Ãg©ed
;

372 
İt_´•İuÏ‹
:

373 
´•İuÏ‹
 = 
şp
->
v®
.
i
;

376 
	`h–p
(
¬gv
[0]);

379 
	`CÍ_D–‘eP¬£r
(
şp
);

381 ià(
‹¡
 == -1) {

382 
	`h–p
(
¬gv
[0]);

385 ià(
Áh»ads
 > 
MAX_THREADS
) {

386 
	`´štf
("Asked fÜ %dh»ad buˆMAX_THREADS i %d\n", 
Áh»ads
, 
MAX_THREADS
);

387 
	`ex™
(1);

390 
timev®
 
tv1
,
tv2
;

391 
ru§ge
 
ru1
,
ru2
;

392 
	`g‘timeofday
(&
tv1
, 
NULL
);

393 
	`g‘ru§ge
(
RUSAGE_SELF
, &
ru1
);

394 
	`¡¬tAndWa™
(
Áh»ads
, 
‹¡s
[
‹¡
].
th»adfunc
);

395 
	`g‘timeofday
(&
tv2
, 
NULL
);

396 
	`g‘ru§ge
(
RUSAGE_SELF
, &
ru2
);

397 #ià!
DATA_COLLECT


398 
	`´štf
("realime: ");

400 
	`´št_time
(
tv1
,
tv2
);

401 #ià!
DATA_COLLECT


402 
	`´štf
("utime: ");

403 
	`´št_time
(
ru1
.
ru_utime
, 
ru2
.ru_utime);

404 
	`´štf
("stime: ");

405 
	`´št_time
(
ru1
.
ru_¡ime
, 
ru2
.ru_stime);

412 #ià
STO_PROFILE_COUNTERS


413 
	#LLU
(
x
è(()x)

	)

414 
	`´štf
("tÙ®_n: %Îu,Ù®_r: %Îu,Ù®_w: %Îu,Ù®_£¬ched: %Îu,Ù®_abÜts: %Îu (%Îu‡bÜt © comm™ime)\n", 
	`LLU
(
T¿n§ùiÚ
::
tÙ®_n
), LLU(T¿n§ùiÚ::
tÙ®_r
), LLU(T¿n§ùiÚ::
tÙ®_w
), LLU(T¿n§ùiÚ::
tÙ®_£¬ched
), LLU(T¿n§ùiÚ::
tÙ®_abÜts
), LLU(T¿n§ùiÚ::
comm™_time_abÜts
));

415 #ià
MASSTREE


416 
	`´štf
("nodabÜts: %Îu\n", 
	`LLU
(
node_abÜts
));

418 #undeà
LLU


421 ià(
runCheck
)

422 
‹¡s
[
‹¡
].
	`checkfunc
();

423 
	}
}

	@test/ex-counter.cc

1 
	~<¡ršg
>

2 
	~<io¡»am
>

3 
	~<sys/time.h
>

4 
	~<as£¹.h
>

5 
	~<sys/»sourû.h
>

6 
	~<veùÜ
>

7 
	~"T¿n§ùiÚ.hh
"

8 
	~"TIÁRªge.hh
"

9 
	~"TW¿µed.hh
"

10 
	~"¿ndg’.hh
"

11 
	~"şp.h
"

12 
	#GUARDED
 ià(
T¿n§ùiÚGu¬d
 
tgu¬d
{})

	)

13 
	gš™Ÿl_£eds
[64];

14 
	gİs_³r_Œªs
 = 1;

15 
	gu¦“p_äaùiÚ
 = 0.1;

17 
	s»suÉs_t
 {

18 
ušt64_t
 
	mŒªs
, 
	ma
, 
	mb
, 
	mc
, 
	mrbuf_fšd
;

19 
timev®
 
	mfšished
;

20 } 
	g»suÉs
[32];

22 
	$´št_time
(
timev®
 
tv1
, timev® 
tv2
) {

23 
	`´štf
("%f", (
tv2
.
tv_£c
-
tv1
.tv_£cè+ (tv2.
tv_u£c
-tv1.tv_usec)/1000000.0);

24 
	}
}

26 şas 
	cTCouÁ”0
 : 
public
 
TObjeù
 {

27 
TW¿µed
<> 
n_
;

28 
TV”siÚ
 
	mv_
;

29 
	mpublic
:

30 
	$TCouÁ”0
(
n
 = 0)

31 : 
	$n_
(
n
) {

33 
	$nÚŒªs_acûss
() {

34  
n_
.
	`acûss
();

35 
	}
}

36 
	$šüem’t
() {

37 
T¿nsProxy
 
™
 = 
Sto
::
	`™em
(
this
, 0);

38 
n
 = 
™
.
	`has_wr™e
(è? it.
wr™e_v®ue
<>(è: 
n_
.
	`»ad
(™, 
v_
);

39 
™
.
	`add_wr™e
(
n
 + 1);

40 
	}
}

41 
	$deüem’t
() {

42 
T¿nsProxy
 
™
 = 
Sto
::
	`™em
(
this
, 0);

43 
n
 = 
™
.
	`has_wr™e
(è? it.
wr™e_v®ue
<>(è: 
n_
.
	`»ad
(™, 
v_
);

44 
™
.
	`add_wr™e
(
n
 - 1);

45 
	}
}

46 
boŞ
 
	$‹¡
() const {

47 
T¿nsProxy
 
™
 = 
Sto
::
	`™em
(
this
, 0);

48  (
™
.
	`has_wr™e
(è? it.
wr™e_v®ue
<>(è: 
n_
.
	`»ad
(™, 
v_
)) > 0;

49 
	}
}

51 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

52  
txn
.
	`Œy_lock
(
™em
, 
v_
);

53 
	}
}

54 
boŞ
 
	$check
(
T¿nsI‹m
& 
™
, 
T¿n§ùiÚ
&è
ov”ride
 {

55  
™
.
	`check_v”siÚ
(
v_
);

56 
	}
}

57 
	$š¡®l
(
T¿nsI‹m
& 
™
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

58 
n_
.
	`acûss
(èğ
™
.
wr™e_v®ue
<>();

59 
txn
.
	`£t_v”siÚ_uÆock
(
v_
, 
™
);

60 
	}
}

61 
	$uÆock
(
T¿nsI‹m
&è
ov”ride
 {

62 
v_
.
	`uÆock
();

63 
	}
}

65 
	$´št
(
¡d
::
o¡»am
& 
w
) const {

66 
w
 << "{TCouÁ”0 " << 
n_
.
	`acûss
(è<< " V" << 
v_
 << "}";

67 
	}
}

68 
ä›nd
 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	gTCouÁ”0
& 
	gtc
) {

69 
	gtc
.
´št
(
w
);

70  
	gw
;

74 şas 
	cTCouÁ”1
 : 
public
 
TObjeù
 {

75 
TW¿µed
<> 
n_
;

76 
TV”siÚ
 
	mv_
;

77 
	$wv®
(
T¿nsProxy
 
™
) {

78  
™
.
wr™e_v®ue
<>(0);

80 
	$wv®
(cÚ¡ 
T¿nsI‹m
& 
™
) {

81  
™
.
wr™e_v®ue
<>(0);

82 
	}
}

83 
	gpublic
:

84 
	$TCouÁ”1
(
n
 = 0)

85 : 
	$n_
(
n
) {

86 
	}
}

87 
	$nÚŒªs_acûss
() {

88  
n_
.
	`acûss
();

89 
	}
}

90 
	$šüem’t
() {

91 autØ
™
 = 
Sto
::
	`™em
(
this
, 0);

92 
™
.
	`add_wr™e
(
	`wv®
(it) + 1);

93 
	}
}

94 
	$deüem’t
() {

95 autØ
™
 = 
Sto
::
	`™em
(
this
, 0);

96 
™
.
	`add_wr™e
(
	`wv®
(it) - 1);

97 
	}
}

98 
boŞ
 
	$‹¡
() const {

99 autØ
™
 = 
Sto
::
	`™em
(
this
, 0);

100 
n
 = 
n_
.
	`»ad
(
™
, 
v_
);

101  
n
 + 
	`wv®
(
™
) > 0;

102 
	}
}

104 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

105  
txn
.
	`Œy_lock
(
™em
, 
v_
);

106 
	}
}

107 
boŞ
 
	$check
(
T¿nsI‹m
& 
™
, 
T¿n§ùiÚ
&è
ov”ride
 {

108  
™
.
	`check_v”siÚ
(
v_
);

109 
	}
}

110 
	$š¡®l
(
T¿nsI‹m
& 
™
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

111 
n_
.
	`acûss
(è+ğ
	`wv®
(
™
);

112 
txn
.
	`£t_v”siÚ_uÆock
(
v_
, 
™
);

113 
	}
}

114 
	$uÆock
(
T¿nsI‹m
&è
ov”ride
 {

115 
v_
.
	`uÆock
();

116 
	}
}

118 
	$´št
(
¡d
::
o¡»am
& 
w
) const {

119 
w
 << "{TCouÁ”1 " << 
n_
.
	`acûss
(è<< " V" << 
v_
 << "}";

120 
	}
}

121 
ä›nd
 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	gTCouÁ”1
& 
	gtc
) {

122 
	gtc
.
´št
(
w
);

123  
	gw
;

127 şas 
	cTCouÁ”2
 : 
public
 
TObjeù
 {

128 
TW¿µed
<> 
n_
;

129 
TV”siÚ
 
	mv_
;

131 
	mTW¿µed
<> 
	mzc_n_
;

132 
TV”siÚ
 
	mzc_v_
;

133 
	$wv®
(
T¿nsProxy
 
™
) {

134  
™
.
wr™e_v®ue
<>(0);

136 
	$wv®
(cÚ¡ 
T¿nsI‹m
& 
™
) {

137  
™
.
wr™e_v®ue
<>(0);

138 
	}
}

139 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
zc_b™
 = 
T¿nsI‹m
::
u£r0_b™
;

140 
cÚ¡ex´
 
	gT¿nsI‹m
::
æags_ty³
 
zc_£t_b™
 = 
zc_b™
 << 1;

141 
	gpublic
:

142 
	$TCouÁ”2
(
n
 = 0)

143 : 
	`n_
(
n
), 
	$zc_n_
(
n
) {

144 
	}
}

145 
	$nÚŒªs_acûss
() {

146  
n_
.
	`acûss
();

147 
	}
}

148 
	$šüem’t
() {

149 autØ
™
 = 
Sto
::
	`™em
(
this
, 0);

150 
™
.
	`add_wr™e
(
	`wv®
(it) + 1);

151 
	}
}

152 
	$deüem’t
() {

153 autØ
™
 = 
Sto
::
	`™em
(
this
, 0);

154 
™
.
	`add_wr™e
(
	`wv®
(it) - 1);

155 
	}
}

156 
boŞ
 
	$‹¡
() const {

157 autØ
™
 = 
Sto
::
	`™em
(
this
, 0);

158 ià(!
™
.
	`has_wr™e
()) {

159 
™
.
	`add_æags
(
zc_b™
);

160  
zc_n_
.
	`»ad
(
™
, 
zc_v_
) > 0;

162 ià(
™
.
	`has_æag
(
zc_b™
))

163 
™
.
	`ş—r_æags
(
zc_b™
).
	`ş—r_»ad
();

164  
n_
.
	`»ad
(
™
, 
v_
è+ 
	`wv®
(it) > 0;

166 
	}
}

168 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

169 
boŞ
 
ok
 = 
txn
.
	`Œy_lock
(
™
, 
v_
);

170 ià(
ok
) {

171 
n
 = 
n_
.
	`acûss
();

172 ià((
n
 > 0è!ğÒ + 
	`wv®
(
™
) > 0)) {

173 
zc_v_
.
	`v®ue
(è|ğ(
v_
.v®ue(è& (
T¿n§ùiÚTid
::
nÚİaque_b™
 - 1));

174 
™
.
	`add_æags
(
zc_£t_b™
);

177  
ok
;

178 
	}
}

179 
boŞ
 
	$check
(
T¿nsI‹m
& 
™
, 
T¿n§ùiÚ
&è
ov”ride
 {

180  
™
.
	`check_v”siÚ
(™.
	`has_æag
(
zc_b™
è? 
zc_v_
 : 
v_
);

181 
	}
}

182 
	$š¡®l
(
T¿nsI‹m
& 
™
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

183 
n_
.
	`acûss
(è+ğ
	`wv®
(
™
);

184 ià(
™
.
	`has_æag
(
zc_£t_b™
)) {

185 
zc_n_
.
	`acûss
(èğ
n_
.access();

186 
txn
.
	`£t_v”siÚ_uÆock
(
zc_v_
, 
™
);

188 
txn
.
	`£t_v”siÚ_uÆock
(
v_
, 
™
);

189 
	}
}

190 
	$uÆock
(
T¿nsI‹m
& 
™
è
ov”ride
 {

191 ià(
™
.
	`has_æag
(
zc_£t_b™
))

192 
zc_v_
.
	`uÆock
();

193 
v_
.
	`uÆock
();

194 
	}
}

195 
	$´št
(
¡d
::
o¡»am
& 
w
, cÚ¡ 
T¿nsI‹m
& 
™em
ècÚ¡ 
ov”ride
 {

196 
w
 << "{TCounter2";

197 ià(
™em
.
	`has_æag
(
zc_b™
))

198 
w
 << ".ZC";

199 ià(
™em
.
	`has_»ad
())

200 
w
 << " R" << 
™em
.
»ad_v®ue
<
TV”siÚ
>();

201 ià(
™em
.
	`has_wr™e
())

202 
w
 << " Î”" << 
™em
.
wr™e_v®ue
<>();

203 ià(
™em
.
	`has_æag
(
zc_£t_b™
))

204 
w
 << "ZC";

205 
w
 << "}";

206 
	}
}

207 
	$´št
(
¡d
::
o¡»am
& 
w
) const {

208 
w
 << "{TCouÁ”2 " << 
n_
.
	`acûss
(è<< " V" << 
v_
 << " ZCV" << 
zc_v_
 << "}";

209 
	}
}

210 
ä›nd
 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	gTCouÁ”2
& 
	gtc
) {

211 
	gtc
.
´št
(
w
);

212  
	gw
;

216 şas 
	cTCouÁ”3
 : 
public
 
TObjeù
 {

217 
TW¿µed
<> 
n_
;

218 
TV”siÚ
 
	mv_
;

219 
	mTIÁRªge
<> 
	t´ed_ty³
;

220 
	$wv®
(
T¿nsProxy
 
™
) {

221  
™
.
wr™e_v®ue
<>(0);

223 
	$wv®
(cÚ¡ 
T¿nsI‹m
& 
™
) {

224  
™
.
wr™e_v®ue
<>(0);

225 
	}
}

226 
	gpublic
:

227 
	$TCouÁ”3
(
n
 = 0)

228 : 
	$n_
(
n
) {

229 
	}
}

230 
	$nÚŒªs_acûss
() {

231  
n_
.
	`acûss
();

232 
	}
}

233 
	$šüem’t
() {

234 autØ
™
 = 
Sto
::
	`™em
(
this
, 0);

235 
™
.
	`add_wr™e
(
	`wv®
(it) + 1);

236 
	}
}

237 
	$deüem’t
() {

238 autØ
™
 = 
Sto
::
	`™em
(
this
, 0);

239 
™
.
	`add_wr™e
(
	`wv®
(it) - 1);

240 
	}
}

241 
boŞ
 
	$‹¡
() const {

242 
T¿nsProxy
 
™
 = 
Sto
::
	`™em
(
this
, 0);

243 ià(!
™
.
	`has_´ediÿ‹
())

244 
™
.
	`£t_´ediÿ‹
(
´ed_ty³
::
	`uncÚ¡¿šed
());

245 
n
 = 
n_
.
	`¢­shÙ
(
™
, 
v_
);

246 
boŞ
 
gt
 = 
n
 + 
	`wv®
(
™
) > 0;

247 
™
.
´ediÿ‹_v®ue
<
´ed_ty³
>().
	`ob£rve_gt
(-
	`wv®
(™), 
gt
);

248  
gt
;

249 
	}
}

251 
boŞ
 
	$lock
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

252  
txn
.
	`Œy_lock
(
™em
, 
v_
);

253 
	}
}

254 
boŞ
 
	$check_´ediÿ‹
(
T¿nsI‹m
& 
™em
, 
T¿n§ùiÚ
& 
txn
, 
boŞ
 
comm™tšg
è
ov”ride
 {

255 
T¿nsProxy
 
	`p
(
txn
, 
™em
);

256 
´ed_ty³
 
´ed
 = 
™em
.
‹m¶©e
 
´ediÿ‹_v®ue
<pred_type>();

257 
n
 = 
n_
.
	`wa™_¢­shÙ
(
p
, 
v_
, 
comm™tšg
);

258  
´ed
.
	`v”ify
(
n
);

259 
	}
}

260 
boŞ
 
	$check
(
T¿nsI‹m
& 
™
, 
T¿n§ùiÚ
&è
ov”ride
 {

261  
™
.
	`check_v”siÚ
(
v_
);

262 
	}
}

263 
	$š¡®l
(
T¿nsI‹m
& 
™
, 
T¿n§ùiÚ
& 
txn
è
ov”ride
 {

264 
n_
.
	`acûss
(è+ğ
	`wv®
(
™
);

265 
txn
.
	`£t_v”siÚ_uÆock
(
v_
, 
™
);

266 
	}
}

267 
	$uÆock
(
T¿nsI‹m
&è
ov”ride
 {

268 
v_
.
	`uÆock
();

269 
	}
}

271 
	$´št
(
¡d
::
o¡»am
& 
w
) const {

272 
w
 << "{TCouÁ”3 " << 
n_
.
	`acûss
(è<< " V" << 
v_
 << "}";

273 
	}
}

274 
ä›nd
 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
w
, cÚ¡ 
	gTCouÁ”3
& 
	gtc
) {

275 
	gtc
.
´št
(
w
);

276  
	gw
;

281 
	gš™Ÿl_v®ue
 = -100;

282 
	g‹¡_äaùiÚ
 = 0.5;

283 
	gÁh»ads
 = 4;

284 
	gex±ime
 = 10;

286 ’um { 
	mİt_Áh»ads
 = 1, 
	mİt_‹¡_äaùiÚ
, 
	mİt_š™Ÿl_v®ue
, 
	mİt_£ed
,

287 
	mİt_İs_³r
, 
	mİt_time
, 
	mİt_u¦“p_äaùiÚ
 };

289 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

290 { "Áh»ads", 'j', 
İt_Áh»ads
, 
CÍ_V®IÁ
, 0 },

291 { "‹¡-äaùiÚ", 'f', 
İt_‹¡_äaùiÚ
, 
CÍ_V®DoubË
, 0 },

292 { "š™Ÿl-v®ue", 'i', 
İt_š™Ÿl_v®ue
, 
CÍ_V®IÁ
, 0 },

293 { "İ¥”Œªs", 'o', 
İt_İs_³r
, 
CÍ_V®UnsigÃd
, 0 },

294 { "time", 't', 
İt_time
, 
CÍ_V®DoubË
, 0 },

295 { "u¦“p-äaùiÚ", 'u', 
İt_u¦“p_äaùiÚ
, 
CÍ_V®DoubË
, 0 },

296 { "£ed", 0, 
İt_£ed
, 
CÍ_V®UnsigÃd
, 0 }

300 
	s»suÉ
 {

301 
ušt64_t
 
	mngt
;

302 
	mfš®_v®ue
;

305 şas 
	cTe¡”
 {

306 
	mpublic
:

307 
vœtu®
 
»suÉ
 
run
() = 0;

310 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

311 şas 
	cTTe¡”
 : 
public
 
Te¡”
 {

312 
public
:

313 
T
* 
couÁ”
;

314 vŞ©
	mgo
;

315 * 
runfunc
(*);

316 
»suÉ
 
run
();

319 
	g‹m¶©e
 <
ty³Çme
 
	gT
> 
T
* 
	gTTe¡”
<T>::
couÁ”
;

320 
	g‹m¶©e
 <
ty³Çme
 
	gT
> vŞ©
	gTTe¡”
<T>::
go
;

322 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

323 * 
	gTTe¡”
<
	gT
>::
	$runfunc
(* 
¬g
) {

324 
me
 = (è(
ušŒ_t
è
¬g
;

325 
T
* 
couÁ”
 = 
TTe¡”
<T>::counter;

326 
TTh»ad
::
	`£t_id
(
me
);

327 
Rªd
 
	`Œªsg’
(
š™Ÿl_£eds
[2*
me
], initial_seeds[2*me + 1]);

328 
‹¡_th»shŞd
 = 
‹¡_äaùiÚ
 * 
Œªsg’
.
	`max
();

329 
šüem’t_th»shŞd
 = (0.499 * 
‹¡_äaùiÚ
 + 0.501è* 
Œªsg’
.
	`max
();

330 
u¦“p_th»shŞd
 = 
u¦“p_äaùiÚ
 * 
Œªsg’
.
	`max
();

332 !
go
)

333 
	`»Ïx_ãnû
();

334 
ušt64_t
 
Œªs
 = 0, 
a
 = 0, 
b
 = 0, 
c
 = 0, 
couÁ_‹¡
 = 0, 
rbuf_fšd
 = 0, 
»Œy
 = 0;

336 
go
) {

337 
Rªd
 
¢­_Œªsg’
 = 
Œªsg’
;

338 
Ç
, 
nb
, 
nc
, 
ngt
, 
nfšd
;

340 
Ç
 = 
nb
 = 
nc
 = 
ngt
 = 
nfšd
 = 0;

341 ++
»Œy
;

342 
Œy
 {

343 
Sto
::
	`¡¬t_Œª§ùiÚ
();

344 
k
 = 0; k < 
İs_³r_Œªs
; ++k) {

345 
İ
 = 
	`Œªsg’
();

346 ià(
İ
 < 
‹¡_th»shŞd
) {

347 
ngt
 +ğ
couÁ”
->
	`‹¡
();

348 ++
Ç
;

349 } ià(
İ
 < 
šüem’t_th»shŞd
) {

350 
couÁ”
->
	`šüem’t
();

351 ++
nb
;

353 
couÁ”
->
	`deüem’t
();

354 ++
nc
;

357 ià(
	`Œªsg’
(è< 
u¦“p_th»shŞd
)

358 
	`u¦“p
(1);

359 ià(
Sto
::
	`Œy_comm™
())

361 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

363 
Œªsg’
 = 
¢­_Œªsg’
;

365 
a
 +ğ
Ç
;

366 
b
 +ğ
nb
;

367 
c
 +ğ
nc
;

368 
couÁ_‹¡
 +ğ
ngt
;

369 
rbuf_fšd
 +ğ
nfšd
;

370 ++
Œªs
;

373 
»suÉs
[
me
].
Œªs
 =rans;

374 
»suÉs
[
me
].
a
 =‡;

375 
»suÉs
[
me
].
b
 = b;

376 
»suÉs
[
me
].
c
 = c;

377 
»suÉs
[
me
].
rbuf_fšd
 =„buf_find;

378 
	`g‘timeofday
(&
»suÉs
[
me
].
fšished
, 
NULL
);

379  
»š‹½»t_ÿ¡
<*>(
couÁ_‹¡
);

380 
	}
}

382 
boŞ
 
	ghas_•och_advªûr
 = 
çl£
;

384 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

385 
»suÉ
 
	gTTe¡”
<
	gT
>::
	$run
() {

386 
couÁ”
 = 
Ãw
 
	`T
(
š™Ÿl_v®ue
);

387 
±h»ad_t
 
tids
[
Áh»ads
];

388 
go
 = 0;

390 
ušŒ_t
 
i
 = 0; i < 
	`ušŒ_t
(
Áh»ads
); ++i)

391 
	`±h»ad_ü—‹
(&
tids
[
i
], 
NULL
, 
runfunc
, 
»š‹½»t_ÿ¡
<*>(i));

393 ià(!
has_•och_advªûr
) {

394 
±h»ad_t
 
advªûr
;

395 
	`±h»ad_ü—‹
(&
advªûr
, 
NULL
, 
T¿n§ùiÚ
::
•och_advªûr
, NULL);

396 
	`±h»ad_d‘ach
(
advªûr
);

397 
has_•och_advªûr
 = 
Œue
;

400 
go
 = 1;

401 
	`u¦“p
(
ex±ime
 * 1000000);

402 
go
 = 0;

403 
ušt64_t
 
tÙ®
 = 0;

404 
i
 = 0; i < 
Áh»ads
; ++i) {

405 * 
mše
;

406 
	`±h»ad_još
(
tids
[
i
], &
mše
);

407 
tÙ®
 +ğ
»š‹½»t_ÿ¡
<
ušŒ_t
>(
mše
);

409 
¡d
::
cout
 << *
couÁ”
 << '\n';

410  
»suÉ
{
tÙ®
, 
couÁ”
->
	`nÚŒªs_acûss
()};

411 
	}
}

413 
Te¡”
* 
	g‰e¡”s
[] = { 
Ãw
 
TTe¡”
<
TCouÁ”0
>,‚ew TTe¡”<
TCouÁ”1
>,

414 
Ãw
 
TTe¡”
<
TCouÁ”2
>,‚ew TTe¡”<
TCouÁ”3
> };

416 
	$maš
(
¬gc
, *
¬gv
[]) {

417 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
	`¬¿ysize
(
İtiÚs
), options);

418 
	`¤ªdomdev
();

419 
¡d
::
veùÜ
<> 
‹¡s
;

420 
£ed
 = 0;

422 
İt
;

423 (
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
) {

424 
İt
) {

425 
İt_Áh»ads
:

426 
Áh»ads
 = 
şp
->
v®
.
i
;

428 
İt_İs_³r
:

429 
İs_³r_Œªs
 = 
şp
->
v®
.
u
;

431 
İt_‹¡_äaùiÚ
:

432 
‹¡_äaùiÚ
 = 
şp
->
v®
.
d
;

434 
İt_š™Ÿl_v®ue
:

435 
š™Ÿl_v®ue
 = 
şp
->
v®
.
i
;

437 
İt_£ed
:

438 
£ed
 = 
şp
->
v®
.
u
;

440 
İt_time
:

441 
ex±ime
 = 
şp
->
v®
.
d
;

443 
İt_u¦“p_äaùiÚ
:

444 
u¦“p_äaùiÚ
 = 
şp
->
v®
.
d
;

446 
CÍ_NÙO±iÚ
: {

447 
‹¡num
 = 
	`©oi
(
şp
->
v¡r
);

448 
	`as£¹
(
‹¡num
 >= 0 &&estnum <= 3);

449 
‹¡s
.
	`push_back
(
‹¡num
);

453 
	`as£¹
(0);

456 
	`CÍ_D–‘eP¬£r
(
şp
);

458 ià(
£ed
)

459 
	`¤ªdom
(
£ed
);

461 
	`¤ªdomdev
();

462 
i
 = 0; i < 
	`¬¿ysize
(
š™Ÿl_£eds
); ++i)

463 
š™Ÿl_£eds
[
i
] = 
	`¿ndom
();

465 ià(
‹¡s
.
	`em±y
())

466 
‹¡s
.
	`push_back
(1);

467 autØ
‹¡num
 : 
‹¡s
) {

468 
timev®
 
tv1
,
tv2
;

469 
ru§ge
 
ru1
,
ru2
;

470 
	`g‘timeofday
(&
tv1
, 
NULL
);

471 
	`g‘ru§ge
(
RUSAGE_SELF
, &
ru1
);

472 
»suÉ
 
r
 = 
‰e¡”s
[
‹¡num
]->
	`run
();

473 
	`g‘timeofday
(&
tv2
, 
NULL
);

474 
	`g‘ru§ge
(
RUSAGE_SELF
, &
ru2
);

476 
ušt64_t
 
tÙ®_Œªs
 = 0;

477 
i
 = 0; i !ğ
Áh»ads
; ++i)

478 
tÙ®_Œªs
 +ğ
»suÉs
[
i
].
Œªs
;

479 
	`´štf
("THROUGHPUT: %àTRANS/SEC\n", 
tÙ®_Œªs
 / 
ex±ime
);

481 
	`´štf
("„ealime: ");

482 
	`´št_time
(
tv1
,
tv2
);

483 
	`´štf
(", utime: ");

484 
	`´št_time
(
ru1
.
ru_utime
, 
ru2
.ru_utime);

485 
	`´štf
(", stime: ");

486 
	`´št_time
(
ru1
.
ru_¡ime
, 
ru2
.ru_stime);

488 
	`´štf
("\n ./ex-counter -j%d -t%g -f%g -u%g -i%d -o%u %d\n",

489 
Áh»ads
, 
ex±ime
, 
‹¡_äaùiÚ
, 
u¦“p_äaùiÚ
,

490 
š™Ÿl_v®ue
, 
İs_³r_Œªs
, 
‹¡num
);

491 
	`´štf
("e¡(èŒu%Îu, v®u%d\n", (è
r
.
ngt
,„.
fš®_v®ue
);

492 
	`´štf
(" duration: ");

493 
i
 = 0; i !ğ
Áh»ads
; ++i) {

494 
	`´štf
(
i
 ? ", %Îu/" : "%Îu/", (è
»suÉs
[i].
Œªs
);

495 
	`´št_time
(
tv1
, 
»suÉs
[
i
].
fšished
);

497 
	`´štf
("\n");

498 #ià
STO_PROFILE_COUNTERS


499 
T¿n§ùiÚ
::
	`´št_¡©s
();

500 ià(
txp_couÁ
 >ğ
txp_tÙ®_abÜts
) {

501 
txp_couÁ”s
 
tc
 = 
T¿n§ùiÚ
::
	`txp_couÁ”s_combšed
();

502 cÚ¡ * 
£p
 = "";

503 ià(
txp_couÁ
 > 
txp_tÙ®_w
) {

504 
	`´štf
("%¡Ù®_n: %Îu,Ù®_r: %Îu,Ù®_w: %Îu", 
£p
, 
tc
.
	`p
(
txp_tÙ®_n
),c.p(
txp_tÙ®_r
),c.p(
txp_tÙ®_w
));

505 
£p
 = ", ";

507 ià(
txp_couÁ
 > 
txp_tÙ®_£¬ched
) {

508 
	`´štf
("%¡Ù®_£¬ched: %Îu", 
£p
, 
tc
.
	`p
(
txp_tÙ®_£¬ched
));

509 
£p
 = ", ";

511 ià(
txp_couÁ
 > 
txp_tÙ®_abÜts
) {

512 
	`´štf
("%¡Ù®_abÜts: %Îu (%Îu‡bÜt © comm™ime)\n", 
£p
, 
tc
.
	`p
(
txp_tÙ®_abÜts
),c.p(
txp_comm™_time_abÜts
));

513 
£p
 = ", ";

515 ià(*
£p
)

516 
	`´štf
("\n");

518 
T¿n§ùiÚ
::
	`ş—r_¡©s
();

521 
	}
}

	@test/hashtable_nostm.cc

1 
	#STO_NO_STM


	)

7 
	g‹m¶©e
 <
ty³Çme
 
	gM­Ty³
>

8 
	$basicTe¡s
(
M­Ty³
& 
m
) {

9 
	`as£¹
(
m
.
	`š£¹
(1, "foo"));

10 
	`as£¹
(!
m
.
	`put
(2, "bar"));

12 
¡d
::
¡ršg
 
v®
;

13 
	`as£¹
(
m
.
	`»ad
(1, 
v®
));

14 
	`as£¹
(
v®
 == "foo");

15 
	`as£¹
(
m
.
	`»ad
(2, 
v®
));

16 
	`as£¹
(
v®
 == "bar");

18 
	`as£¹
(
m
.
	`put
(1, "baz"));

19 
	`as£¹
(
m
.
	`»move
(2));

20 
	`as£¹
(!
m
.
	`»move
(2));

22 
	`as£¹
(
m
.
	`»ad
(1, 
v®
));

23 
	`as£¹
(
v®
 == "baz");

24 
	`as£¹
(!
m
.
	`»ad
(2, 
v®
));

27 
	`as£¹
(!
m
.
	`š£¹
(1, "fuzz"));

28 
	`as£¹
(
m
.
	`»ad
(1, 
v®
));

29 
	`as£¹
(
v®
 == "baz");

30 
	}
}

32 
	$maš
() {

33 
HashbË
<, 
¡d
::
¡ršg
> 
h
;

34 
	`basicTe¡s
(
h
);

35 
	}
}

	@test/ht_mt.cc

1 
	~<io¡»am
>

2 
	~<as£¹.h
>

3 
	~<¡dio.h
>

5 
	~"HashbË.hh
"

6 
	~"MassT¿ns.hh
"

7 
	~"T¿n§ùiÚ.hh
"

8 
	~"sim¶e_¡r.hh
"

9 
	~"¿ndg’.hh
"

11 
	#DS
 0

	)

12 
	#USE_STRINGS
 1

	)

14 #ià
DS
 == 0

15 #ià
USE_STRINGS
 == 1

16 
	gHashbË
<
	t¡d
::
	t¡ršg
, std::¡ršg, 
	tçl£
, 1000000, 
	tsim¶e_¡r
> 
	tds
;

18 
	gHashbË
<, 
	t¡d
::
	t¡ršg
, 
	tçl£
, 1000000, 
	tsim¶e_¡r
> 
	tds
;

21 
	gMassT¿ns
<
	t¡d
::
	t¡ršg
> 
	tds
;

24 
	#NTRANS
 5000000

	)

25 
	#NINIT
 100000

	)

26 
	#MAX_VALUE
 
NINIT


	)

27 
usšg
 
Çme¥aû
 
	g¡d
;

29 
	g¡d
::
¡ršg
 
v®ue
;

32 
	$run
(
ds
& 
h
) {

33 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(0, 
MAX_VALUE
);

34 
i
 = 0; i < 
NTRANS
; ++i) {

35 autØ
Œªs£ed
 = 
i
;

36 
ušt32_t
 
£ed
 = 
Œªs£ed
*3;

37 autØ
£edlow
 = 
£ed
 & 0xffff;

38 autØ
£edhigh
 = 
£ed
 >> 16;

39 
Rªd
 
	`Œªsg’
(
£ed
, 
£edlow
 << 16 | 
£edhigh
);

41 
key
 = 
	`¦Ùdi¡
(
Œªsg’
);

42 
¡d
::
¡ršg
 
v®ue
;

43 #ià
DS
 == 0

44 
TRANSACTION
{

45 #ià
USE_STRINGS
 == 1

46 
¡d
::
¡ršg
 
s
 = std::
	`to_¡ršg
(
key
);

47 
h
.
	`ŒªsG‘
(
s
, 
v®ue
);

49 
h
.
	`ŒªsG‘
(
key
, 
v®ue
);

51 } 
	`RETRY
(
çl£
);

53 
TRANSACTION
{

54 #ià
USE_STRINGS
 == 1

55 
¡d
::
¡ršg
 
s
 = std::
	`to_¡ršg
(
key
);

56 
h
.
	`ŒªsG‘
(
s
, 
v®ue
);

58 
h
.
	`ŒªsG‘
(
key
, 
v®ue
);

60 } 
	`RETRY
(
çl£
);

64 
	}
}

67 
	$š™
(
ds
& 
h
) {

68 
i
 = 0; i < 
NINIT
; ++i) {

69 
TRANSACTION
{

70 #ià
USE_STRINGS
 == 1

71 
¡d
::
¡ršg
 
s
 = std::
	`to_¡ršg
(
i
);

72 
h
.
	`ŒªsPut
(
s
, 
v®ue
);

74 
h
.
	`ŒªsPut
(
i
, 
v®ue
);

76 } 
	`RETRY
(
çl£
);

79 
	}
}

82 
	$´št_time
(
timev®
 
tv1
, timev® 
tv2
) {

83 
	`´štf
("%f\n", (
tv2
.
tv_£c
-
tv1
.tv_£cè+ (tv2.
tv_u£c
-tv1.tv_usec)/1000000.0);

84 
	}
}

86 
	$maš
() {

87 
v®ue
 = 
¡d
::
	`¡ršg
('a', 100);

88 
ds
 
h
;

89 #ià
DS
 != 0

90 
h
.
	`th»ad_š™
();

93 
	`š™
(
h
);

94 
timev®
 
tv1
,
tv2
;

95 
	`g‘timeofday
(&
tv1
, 
NULL
);

97 
	`run
(
h
);

99 
	`g‘timeofday
(&
tv2
, 
NULL
);

100 
	`´štf
("Timeaken: ");

101 
	`´št_time
(
tv1
, 
tv2
);

102 
	}
}

	@test/iterators.cc

1 
	~<¡ršg
>

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

4 
	~<veùÜ
>

5 
	~<¿ndom
>

6 
	~<m­
>

7 
	~"T¿n§ùiÚ.hh
"

8 
	~"VeùÜ.hh
"

9 
	~"şp.h
"

10 
	~"¿ndg’.hh
"

12 
	gmax_v®ue
 = 10000;

13 
	gglob®_£ed
 = 11;

14 
	gÁh»ads
 = 16;

15 
	gÁ¿ns
 = 1000000;

16 
	gİ¥”Œªs
 = 1;

17 
	g´•İuÏ‹
 = 1000;

18 
	gmax_key
 = 1000;

19 
	g£¬ch_³rûÁ
 = 0.3;

20 
	gupd©e_³rûÁ
 = 0.3;

21 
boŞ
 
	gu£_™”©Üs
 = 
çl£
;

24 
	gT¿n§ùiÚTid
::
ty³
 
lock
;

26 
	gVeùÜ
<> 
	td©a_¡ruùu»
;

28 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

29 
	sTe¡”Paœ
 {

30 
T
* 
	mt
;

31 
	mme
;

35 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

36 
	$fšdK
(
T
* 
q
, 
v®
) {

37 ià(
u£_™”©Üs
) {

38 
d©a_¡ruùu»
::
™”©Ü
 
f™
 = 
q
->
	`begš
();

39 
d©a_¡ruùu»
::
™”©Ü
 
e™
 = 
q
->
	`’d
();

40 
d©a_¡ruùu»
::
™”©Ü
 
™
 = 
¡d
::
	`fšd
(
f™
, 
e™
, 
v®
);

41  
™
-
f™
;

44 
fœ¡
 = 0;

45 
Ï¡
 = 
q
->
	`size
();

46 
fœ¡
 !ğ
Ï¡
) {

47 ià(
q
->
	`ŒªsG‘
(
fœ¡
è=ğ
v®
)  first;

48 ++
fœ¡
;

50  
Ï¡
;

52 
	}
}

54 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

55 
	$run
(
T
* 
q
, 
me
) {

56 
TTh»ad
::
	`£t_id
(
me
);

58 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(0, 
max_v®ue
);

59 
N
 = 
Á¿ns
/
Áh»ads
;

60 
OPS
 = 
İ¥”Œªs
;

62 
i
 = 0; i < 
N
; ++i) {

64 autØ
Œªs£ed
 = 
i
;

66 
Sto
::
	`¡¬t_Œª§ùiÚ
();

67 
Œy
 {

68 
ušt32_t
 
£ed
 = 
Œªs£ed
*3 + (ušt32_t)
me
*
Á¿ns
*7 + (ušt32_t)
glob®_£ed
*
MAX_THREADS
*ntrans*11;

69 autØ
£edlow
 = 
£ed
 & 0xffff;

70 autØ
£edhigh
 = 
£ed
 >> 16;

71 
Rªd
 
	`Œªsg’
(
£ed
, 
£edlow
 << 16 | 
£edhigh
);

73 
j
 = 0; j < 
OPS
; ++j) {

74 
İ
 = 
	`¦Ùdi¡
(
Œªsg’
) % 100;

75 ià(
İ
 < 
£¬ch_³rûÁ
 * 100) {

76 
v®
 = 
	`¦Ùdi¡
(
Œªsg’
);

77 
	`fšdK
(
q
, 
v®
);

78 } ià(
İ
 < (
£¬ch_³rûÁ
 + 
upd©e_³rûÁ
) *100){

79 
key
 = 
	`¦Ùdi¡
(
Œªsg’
è% 
max_key
;

80 
v®
 = 
	`¦Ùdi¡
(
Œªsg’
è% 
max_v®ue
;

81 
q
->
	`ŒªsUpd©e
(
key
, 
v®
);

83 
key
 = 
	`¦Ùdi¡
(
Œªsg’
è% 
max_key
;

84 
q
->
	`ŒªsG‘
(
key
);

89 ià(
Sto
::
	`Œy_comm™
()) {

93 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) { }

96 
	}
}

98 
‹m¶©e
 <
ty³Çme
 
T
>

99 * 
	$runFunc
(* 
x
) {

100 
Te¡”Paœ
<
T
>* 

 = (Te¡”Paœ<T>*è
x
;

101 
	`run
(

->
t
,p->
me
);

102  
nuÎ±r
;

103 
	}
}

105 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

106 
	$¡¬tAndWa™
(
n
, 
T
* 
queue
) {

107 
±h»ad_t
 
tids
[
Áh»ads
];

108 
Te¡”Paœ
<
T
> *
‹¡”s
 = 
Ãw
 Te¡”Paœ<T>[
n
];

109 
i
 = 0; i < 
Áh»ads
; ++i) {

110 
‹¡”s
[
i
].
t
 = 
queue
;

111 
‹¡”s
[
i
].
me
 = i;

112 
	`±h»ad_ü—‹
(&
tids
[
i
], 
NULL
, 
runFunc
<
T
>, &
‹¡”s
[i]);

114 
±h»ad_t
 
advªûr
;

115 
	`±h»ad_ü—‹
(&
advªûr
, 
NULL
, 
T¿n§ùiÚ
::
•och_advªûr
, NULL);

116 
	`±h»ad_d‘ach
(
advªûr
);

118 
i
 = 0; i < 
Áh»ads
; ++i) {

119 
	`±h»ad_još
(
tids
[
i
], 
NULL
);

121 
	}
}

123 
	$´št_time
(
timev®
 
tv1
, timev® 
tv2
) {

124 
	`´štf
("%f\n", (
tv2
.
tv_£c
-
tv1
.tv_£cè+ (tv2.
tv_u£c
-tv1.tv_usec)/1000000.0);

125 
	}
}

128 
	mİt_Áh»ads
, 
	mİt_Á¿ns
, 
	mİt_İ¥”Œªs
, 
	mİt_£¬ch³rûÁ
, 
	mİt_upd©•”ûÁ
, 
	mİt_´•İuÏ‹
, 
	mİt_£ed
, 
	mİt_u£™”©Üs


131 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

132 { "Áh»ads", 0, 
İt_Áh»ads
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

133 { "Á¿ns", 0, 
İt_Á¿ns
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

134 { "İ¥”Œªs", 0, 
İt_İ¥”Œªs
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

135 { "£¬ch³rûÁ", 0, 
İt_£¬ch³rûÁ
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

136 { "upd©•”ûÁ", 0, 
İt_upd©•”ûÁ
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

137 { "´•İuÏ‹", 0, 
İt_´•İuÏ‹
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

138 { "£ed", 0, 
İt_£ed
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

139 { "u£™”©Üs", 0, 
İt_u£™”©Üs
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
}

142 
	$h–p
() {

143 
	`´štf
("Usage: [OPTIONS]\n\
:\n\
--nthreads=NTHREADS (default %d)\n\
--ntrans=NTRANS, how manyotalransactionso„un (they'll be split betweenhreads) (default %d)\n\
--opspertrans=OPSPERTRANS, how many operationso„un…erransaction (default %d)\n\
--searchpercent=SEARCHPERCENT,…robability with whicho do searches (default %f)\n\
--updatepercent=UPDATEPERCENT,…robability with whicho do updates (default %f)\n\
--prepopulate=PREPOPULATE,…repopulateable with given‚umber of items (default %d)\n\
--seed=SEED, global seedo„unheƒxperiment \n",

152 
Áh»ads
, 
Á¿ns
, 
İ¥”Œªs
, 
£¬ch_³rûÁ
, 
upd©e_³rûÁ
, 
´•İuÏ‹
);

153 
	`ex™
(1);

154 
	}
}

156 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

157 
	$š™
(
T
* 
q
) {

158 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(0, 
max_v®ue
);

159 
ušt32_t
 
£ed
 = 
glob®_£ed
 * 11;

160 autØ
£edlow
 = 
£ed
 & 0xffff;

161 autØ
£edhigh
 = 
£ed
 >> 16;

162 
Rªd
 
	`Œªsg’
(
£ed
, 
£edlow
 << 16 | 
£edhigh
);

163 
i
 = 0; i < 
´•İuÏ‹
; i++) {

164 
TRANSACTION
 {

165 
q
->
	`push_back
(
	`¦Ùdi¡
(
Œªsg’
));

166 } 
	`RETRY
(
çl£
);

168 
	}
}

170 
	$maš
(
¬gc
, *
¬gv
[]) {

171 
lock
 = 0;

172 
timev®
 
tv1
,
tv2
;

174 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
	`¬¿ysize
(
İtiÚs
), options);

176 
İt
;

177 (
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
) {

178 
İt
) {

179 
İt_Áh»ads
:

180 
Áh»ads
 = 
şp
->
v®
.
i
;

182 
İt_Á¿ns
:

183 
Á¿ns
 = 
şp
->
v®
.
i
;

185 
İt_İ¥”Œªs
:

186 
İ¥”Œªs
 = 
şp
->
v®
.
i
;

188 
İt_£¬ch³rûÁ
:

189 
£¬ch_³rûÁ
 = 
şp
->
v®
.
d
;

191 
İt_upd©•”ûÁ
:

192 
upd©e_³rûÁ
 = 
şp
->
v®
.
d
;

194 
İt_´•İuÏ‹
:

195 
´•İuÏ‹
 = 
şp
->
v®
.
i
;

197 
İt_£ed
:

198 
glob®_£ed
 = 
şp
->
v®
.
i
;

200 
İt_u£™”©Üs
:

201 
u£_™”©Üs
 = 
şp
->
v®
.
i
 == 1;

204 
	`h–p
();

207 
	`CÍ_D–‘eP¬£r
(
şp
);

209 ià(!
u£_™”©Üs
) {

211 
d©a_¡ruùu»
 
q
;

212 
	`š™
(&
q
);

214 
	`g‘timeofday
(&
tv1
, 
NULL
);

216 
	`¡¬tAndWa™
(
Áh»ads
, &
q
);

218 
	`g‘timeofday
(&
tv2
, 
NULL
);

219 
	`´štf
("Parallel PQime: ");

220 
	`´št_time
(
tv1
, 
tv2
);

222 #ià
STO_PROFILE_COUNTERS


223 
T¿n§ùiÚ
::
	`´št_¡©s
();

225 
txp_couÁ”s
 
tc
 = 
T¿n§ùiÚ
::
	`txp_couÁ”s_combšed
();

226 
	`´štf
("tÙ®_n: %Îu,Ù®_r: %Îu,Ù®_w: %Îu,Ù®_£¬ched: %Îu,Ù®_abÜts: %Îu (%Îu‡bÜt © comm™ime)\n", 
tc
.
	`p
(
txp_tÙ®_n
),c.p(
txp_tÙ®_r
),c.p(
txp_tÙ®_w
),c.p(
txp_tÙ®_£¬ched
),c.p(
txp_tÙ®_abÜts
),c.p(
txp_comm™_time_abÜts
));

228 
T¿n§ùiÚ
::
	`ş—r_¡©s
();

232 
d©a_¡ruùu»
 
q2
;

233 
	`š™
(&
q2
);

234 
	`g‘timeofday
(&
tv1
, 
NULL
);

236 
	`¡¬tAndWa™
(
Áh»ads
, &
q2
);

238 
	`g‘timeofday
(&
tv2
, 
NULL
);

239 
	`´štf
("Iterator…arallelime: ");

240 
	`´št_time
(
tv1
, 
tv2
);

242 #ià
STO_PROFILE_COUNTERS


243 
T¿n§ùiÚ
::
	`´št_¡©s
();

245 
txp_couÁ”s
 
tc
 = 
T¿n§ùiÚ
::
	`txp_couÁ”s_combšed
();

246 
	`´štf
("tÙ®_n: %Îu,Ù®_r: %Îu,Ù®_w: %Îu,Ù®_£¬ched: %Îu,Ù®_abÜts: %Îu (%Îu‡bÜt © comm™ime)\n", 
tc
.
	`p
(
txp_tÙ®_n
),c.p(
txp_tÙ®_r
),c.p(
txp_tÙ®_w
),c.p(
txp_tÙ®_£¬ched
),c.p(
txp_tÙ®_abÜts
),c.p(
txp_comm™_time_abÜts
));

248 
T¿n§ùiÚ
::
	`ş—r_¡©s
();

252 
	}
}

	@test/list1.cc

1 
	~<¡ršg
>

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

4 
	~<veùÜ
>

5 
	~"T¿n§ùiÚ.hh
"

6 
	~"Li¡1.hh
"

8 
	$‹¡Sim¶eIÁ
() {

9 
Li¡1
<> 
f
;

12 
T¿n§ùiÚGu¬d
 
t
;

13 
f
.
	`ŒªsIn£¹
(100);

17 
T¿n§ùiÚGu¬d
 
t2
;

18 
	`as£¹
(
f
.
	`ŒªsFšd
(100));

21 
	`´štf
("PASS:estSimpleInt\n");

22 
	}
}

24 
	$‹¡Sim¶eSŒšg
() {

25 
Li¡1
<
¡d
::
¡ršg
> 
f
;

28 
T¿n§ùiÚGu¬d
 
t
;

29 
f
.
	`ŒªsIn£¹
("100");

33 
T¿n§ùiÚGu¬d
 
t2
;

34 
	`as£¹
(
f
.
	`ŒªsFšd
("100"));

37 
	`´štf
("PASS:estSimpleString\n");

38 
	}
}

40 
	$‹¡I‹r
() {

41 
¡d
::
veùÜ
<> 
¬r
;

42 
Li¡1
<> 
f
;

43 
i
 = 0; i < 10; i++) {

44 
x
 = 
	`¿nd
();

45 
¬r
.
	`push_back
(
x
);

46 
f
.
	`š£¹
(
x
);

48 
max
;

49 
TRANSACTION
 {

50 
max
 = *(
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
()));

51 } 
	`RETRY
(
çl£
);

53 
	`as£¹
(
max
 =ğ*(
¡d
::
	`max_–em’t
(
¬r
.
	`begš
(),‡¼.
	`’d
())));

54 
	`´štf
("Max i %i\n", 
max
);

55 
	`´štf
("PASS:‡rray max_elementest\n");

56 
	}
}

59 
	$‹¡CÚæiùšgI‹r
() {

60 
Li¡1
<> 
f
;

61 
i
 = 0; i < 10; i++) {

62 
f
.
	`š£¹
(
i
);

66 
Te¡T¿n§ùiÚ
 
	`t
(1);

67 
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
());

69 
Te¡T¿n§ùiÚ
 
	`t1
(2);

70 
f
.
	`ŒªsIn£¹
(10);

71 
	`as£¹
(
t1
.
	`Œy_comm™
());

72 
	`as£¹
(!
t
.
	`Œy_comm™
());

75 
	`´štf
("PASS: conflicting‡rray max_elementest\n");

76 
	}
}

78 
	$‹¡ModifyšgI‹r
() {

79 
Li¡1
<> 
f
;

80 
i
 = 0; i < 10; i++) {

81 
f
.
	`š£¹
(
i
);

85 
T¿n§ùiÚGu¬d
 
t
;

86 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

90 
T¿n§ùiÚGu¬d
 
t1
;

91 
	`as£¹
(!
f
.
	`ŒªsFšd
(4));

94 
	`´štf
("PASS:‡rray„eplaceest\n");

95 
	}
}

97 
	$‹¡CÚæiùšgModifyI‹r1
() {

98 
Li¡1
<, 
Œue
> 
f
;

99 
i
 = 0; i < 10; i++) {

100 
f
.
	`š£¹
(
i
);

103 
Te¡T¿n§ùiÚ
 
	`t
(1);

104 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

106 
Te¡T¿n§ùiÚ
 
	`t1
(2);

107 
f
.
	`ŒªsIn£¹
(4);

108 
	`as£¹
(
t1
.
	`Œy_comm™
());

109 
	`as£¹
(!
t
.
	`Œy_comm™
());

112 
T¿n§ùiÚGu¬d
 
t2
;

113 
	`as£¹
(
f
.
	`ŒªsFšd
(4));

116 
	`´štf
("PASS:‡rray conflicting„eplaceest1\n");

117 
	}
}

119 
	$‹¡CÚæiùšgModifyI‹r2
() {

120 
Li¡1
<> 
f
;

121 
i
 = 0; i < 10; i++) {

122 
f
.
	`š£¹
(
i
);

126 
T¿n§ùiÚGu¬d
 
t
;

127 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

131 
T¿n§ùiÚGu¬d
 
t1
;

132 
f
.
	`ŒªsIn£¹
(4);

136 
T¿n§ùiÚGu¬d
 
t2
;

137 
	`as£¹
(
f
.
	`ŒªsFšd
(4));

140 
	`´štf
("PASS:‡rray conflicting„eplaceest2\n");

141 
	}
}

143 
	$‹¡CÚæiùšgModifyI‹r3
() {

144 
Li¡1
<> 
f
;

145 
i
 = 0; i < 10; i++) {

146 
f
.
	`š£¹
(
i
);

149 
Te¡T¿n§ùiÚ
 
	`t1
(1);

150 
f
.
	`ŒªsFšd
(4);

152 
Te¡T¿n§ùiÚ
 
	`t
(2);

153 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

154 
	`as£¹
(
t
.
	`Œy_comm™
());

155 
	`as£¹
(!
t1
.
	`Œy_comm™
());

158 
T¿n§ùiÚGu¬d
 
t2
;

159 
	`as£¹
(!
f
.
	`ŒªsFšd
(4));

162 
	`´štf
("PASS:‡rray conflicting„eplaceest3\n");

163 
	}
}

166 
	$maš
() {

167 
	`‹¡Sim¶eIÁ
();

168 
	`‹¡Sim¶eSŒšg
();

169 
	`‹¡I‹r
();

170 
	`‹¡CÚæiùšgI‹r
();

171 
	`‹¡ModifyšgI‹r
();

172 
	`‹¡CÚæiùšgModifyI‹r1
();

173 
	`‹¡CÚæiùšgModifyI‹r2
();

174 
	`‹¡CÚæiùšgModifyI‹r3
();

176 
	}
}

	@test/pqVsIt.cc

1 
	#TVECTOR_DEFAULT_CAPACITY
 16384

	)

2 
	~<¡ršg
>

3 
	~<io¡»am
>

4 
	~<as£¹.h
>

5 
	~<veùÜ
>

6 
	~<¿ndom
>

7 
	~<m­
>

8 
	~<queue
>

9 
	~"T¿n§ùiÚ.hh
"

10 
	~"TVeùÜ.hh
"

11 
	~"TVeùÜ_nİ»d.hh
"

12 
	~"PriÜ™yQueue.hh
"

13 
	~"PriÜ™yQueue1.hh
"

14 
	~"şp.h
"

15 
	~"¿ndg’.hh
"

16 
	gwa™šg
 = 5000;

17 
	gmax_v®ue
 = 100000;

18 
	gglob®_£ed
 = 0;

19 
	gÁh»ads
 = 4;

20 
	gİ¥”Œªs
 = 1;

21 
	g´•İuÏ‹
 = 1000;

22 
	gpush_³rûÁ
 = 0.75;

23 
	gblocks
 = 1000;

24 
	gruÁime
 = 10;

25 
	gš™Ÿl_£eds
[128];

27 vŞ©
boŞ
 
	gruÂšg
 = 
Œue
;

29 
	#SMALLER_WRITES
 0

	)

30 
	#SINGLE_POP
 0

	)

31 
	#FIX_RUNTIME
 1

	)

32 #ià
FIX_RUNTIME


33 
	gÁ¿ns
 = 1000000;

35 
	gÁ¿ns
 = 300000;

38 
	gT¿n§ùiÚTid
::
ty³
 
lock
;

40 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

41 
	sTe¡”Paœ
 {

42 
T
* 
	mt
;

43 
	mme
;

44 
ušt64_t
 
	mnum_Œªs
;

47 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

48 
ušt64_t
 
	$run
(
T
* 
q
, 
me
) {

49 
TTh»ad
::
	`£t_id
(
me
);

50 #ià
SMALLER_WRITES


51 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(0, 
max_v®ue
/
blocks
);

53 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(0, 
max_v®ue
);

55 
Rªd
 
	`Œªsg’
(
š™Ÿl_£eds
[2*
me
], initial_seeds[2*me + 1]);

56 
ušt64_t
 
num_Œªs
 = 0;

57 #ià!
FIX_RUNTIME


58 
N
 = 
Á¿ns
/
Áh»ads
;

60 
OPS
 = 
İ¥”Œªs
;

61 
¿tio
 = ( 
push_³rûÁ
 / (1 -…ush_percent));

62 ià(
¿tio
 < 1)„atio = 1;

63 
boŞ
 
Úly_pİ
 = 
çl£
;

64 
boŞ
 
Úly_push
 = 
çl£
;

65 #ià
SINGLE_POP


66 ià(
me
 =ğ0è
Úly_pİ
 = 
Œue
;

67 
Úly_push
 = 
Œue
;

70 #ià
FIX_RUNTIME


71 
i
 = -1;

72 
ruÂšg
) {

73 
i
++;

75 
i
 = 0; i < 
N
; ++i) {

78 
Rªd
 
Œªsg’_¢­
 = 
Œªsg’
;

80 
Sto
::
	`¡¬t_Œª§ùiÚ
();

81 
Œy
 {

82 
j
 = 0; j < 
OPS
; ++j) {

83 
İ
 = 
	`¦Ùdi¡
(
Œªsg’
) % 100;

84 ià(
Úly_push
 || (!
Úly_pİ
 && 
İ
 < 
push_³rûÁ
 * 100)) {

85 
v®
 = 
	`¦Ùdi¡
(
Œªsg’
);

86 #ià
SMALLER_READS


87 
v®
 = v® + (1 - (
i
/
N
))*
max_v®ue
;

89 
q
->
	`push
(
v®
);

91 
r
 = 0;„ < 
¿tio
;„++) {

92 
Œy
 {

93 
q
->
	`pİ
();

94 } 
	`ÿtch
 (
¡d
::
out_of_¿nge
 
e
) {

101 ià(
Sto
::
	`Œy_comm™
()) {

102 #ià
FIX_RUNTIME


103 
num_Œªs
++;

108 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) { }

109 
Œªsg’
 = 
Œªsg’_¢­
;

112 
k
 = 0; k < 
wa™šg
; k++è{
__asm__
 
	`__vŞ©e__
("");}

114  
num_Œªs
;

115 
	}
}

117 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

118 * 
	$runFunc
(* 
x
) {

119 
Te¡”Paœ
<
T
>* 

 = (Te¡”Paœ<T>*è
x
;

120 
ušt64_t
 
num_Œªs
 = 
	`run
(

->
t
,p->
me
);

121 

->
num_Œªs
 =‚um_trans;

122  
nuÎ±r
;

123 
	}
}

125 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

126 
ušt64_t
 
	$¡¬tAndWa™
(
n
, 
T
* 
queue
) {

127 
ruÂšg
 = 
Œue
;

128 
±h»ad_t
 
tids
[
Áh»ads
];

129 
Te¡”Paœ
<
T
> *
‹¡”s
 = 
Ãw
 Te¡”Paœ<T>[
n
];

130 
i
 = 0; i < 
Áh»ads
; ++i) {

131 
‹¡”s
[
i
].
t
 = 
queue
;

132 
‹¡”s
[
i
].
me
 = i;

133 
	`±h»ad_ü—‹
(&
tids
[
i
], 
NULL
, 
runFunc
<
T
>, &
‹¡”s
[i]);

135 #ià
FIX_RUNTIME


136 
	`¦“p
(
ruÁime
);

137 
	`´štf
("stopping...\n");

138 
ruÂšg
 = 
çl£
;

140 
	`__sync_synchrÚize
();

141 
i
 = 0; i < 
Áh»ads
; ++i) {

142 
	`±h»ad_još
(
tids
[
i
], 
NULL
);

145 
ušt64_t
 
tÙ_Œªs
 = 0;

146 
i
 = 0; i < 
Áh»ads
; ++i) {

147 
tÙ_Œªs
 +ğ
‹¡”s
[
i
].
num_Œªs
;

149  
tÙ_Œªs
;

150 
	}
}

152 
	$´št_time
(
timev®
 
tv1
, timev® 
tv2
) {

153 
	`´štf
("%f\n", (
tv2
.
tv_£c
-
tv1
.tv_£cè+ (tv2.
tv_u£c
-tv1.tv_usec)/1000000.0);

154 
	}
}

157 
	mİt_Áh»ads
 = 1, 
	mİt_Á¿ns
, 
	mİt_İ¥”Œªs
, 
	mİt_push³rûÁ
, 
	mİt_tİ³rûÁ
, 
	mİt_´•İuÏ‹
, 
	mİt_£ed


160 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

161 { "Áh»ads", 0, 
İt_Áh»ads
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

162 { "Á¿ns", 0, 
İt_Á¿ns
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

163 { "İ¥”Œªs", 0, 
İt_İ¥”Œªs
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

164 { "push³rûÁ", 0, 
İt_push³rûÁ
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

165 { "tİ³rûÁ", 0, 
İt_tİ³rûÁ
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

166 { "´•İuÏ‹", 0, 
İt_´•İuÏ‹
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

167 { "£ed", 0, 
İt_£ed
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 }

170 
	$h–p
() {

171 
	`´štf
("Usage: [OPTIONS]\n\
:\n\
--nthreads=NTHREADS (default %d)\n\
--ntrans=NTRANS, how manyotalransactionso„un (they'll be split betweenhreads) (default %d)\n\
--opspertrans=OPSPERTRANS, how many operationso„un…erransaction (default %d)\n\
--pushpercent=PUSHPERCENT,…robability with whicho do…ushes (default %f)\n\
--prepopulate=PREPOPULATE,…repopulateable with given‚umber of items (default %d)\n\
--seed=SEED, global seedo„unheƒxperiment \n",

179 
Áh»ads
, 
Á¿ns
, 
İ¥”Œªs
, 
push_³rûÁ
, 
´•İuÏ‹
);

180 
	`ex™
(1);

181 
	}
}

183 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

184 
	$š™
(
T
* 
q
) {

185 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(0, 
max_v®ue
);

186 
Rªd
 
	`Œªsg’
(
	`¿ndom
(),„andom());

187 
i
 = 0; i < 
´•İuÏ‹
; i++) {

188 
TRANSACTION
 {

189 
v®
 = 
	`¦Ùdi¡
(
Œªsg’
);

190 #ià
SMALLER_WRITES


191 
v®
 = v® + 
max_v®ue
*(1+
blocks
)/blocks;

193 
q
->
	`push
(
v®
);

194 } 
	`RETRY
(
çl£
);

196 
	}
}

198 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

199 
	$run_ªd_»pÜt
(cÚ¡ * 
Çme
) {

200 
T
* 
q
;

201 
TRANSACTION
 {

202 
q
 = 
Ãw
 
T
;

203 } 
	`RETRY
(
Œue
);

204 
	`š™
(
q
);

206 
timev®
 
tv1
, 
tv2
;

207 
	`g‘timeofday
(&
tv1
, 
NULL
);

208 
num_Œªs
 = 
	`¡¬tAndWa™
(
Áh»ads
, 
q
);

209 
	`g‘timeofday
(&
tv2
, 
NULL
);

211 #ià
FIX_RUNTIME


212 
time
 = 
tv2
.
tv_£c
 - 
tv1
.tv_£ø+ (tv2.
tv_u£c
-tv1.tv_usec)/1000000.0;

213 
throughput
 = 
num_Œªs
/
time
;

214 
	`´štf
("%s: %Îu\n", 
Çme
, 
throughput
);

216 
	`´štf
("% time: ", 
Çme
);

217 
	`´št_time
(
tv1
, 
tv2
);

219 #ià
STO_PROFILE_COUNTERS


220 
T¿n§ùiÚ
::
	`´št_¡©s
();

222 
txp_couÁ”s
 
tc
 = 
T¿n§ùiÚ
::
	`txp_couÁ”s_combšed
();

223 
	`´štf
("tÙ®_n: %Îu,Ù®_r: %Îu,Ù®_w: %Îu,Ù®_£¬ched: %Îu,Ù®_abÜts: %Îu (%Îu‡bÜt © comm™ime)\n", 
tc
.
	`p
(
txp_tÙ®_n
),c.p(
txp_tÙ®_r
),c.p(
txp_tÙ®_w
),c.p(
txp_tÙ®_£¬ched
),c.p(
txp_tÙ®_abÜts
),c.p(
txp_comm™_time_abÜts
));

225 
T¿n§ùiÚ
::
	`ş—r_¡©s
();

227 
	}
}

229 
	$maš
(
¬gc
, *
¬gv
[]) {

230 
lock
 = 0;

231 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
	`¬¿ysize
(
İtiÚs
), options);

232 
¡d
::
veùÜ
<cÚ¡ *> 
‹¡s
;

234 
İt
;

235 (
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
) {

236 
İt
) {

237 
İt_Áh»ads
:

238 
Áh»ads
 = 
şp
->
v®
.
i
;

240 
İt_Á¿ns
:

241 
Á¿ns
 = 
şp
->
v®
.
i
;

243 
İt_İ¥”Œªs
:

244 
İ¥”Œªs
 = 
şp
->
v®
.
i
;

246 
İt_push³rûÁ
:

247 
push_³rûÁ
 = 
şp
->
v®
.
d
;

249 
İt_´•İuÏ‹
:

250 
´•İuÏ‹
 = 
şp
->
v®
.
i
;

252 
İt_£ed
:

253 
glob®_£ed
 = 
şp
->
v®
.
i
;

255 
CÍ_NÙO±iÚ
:

256 
‹¡s
.
	`push_back
(
şp
->
v¡r
);

259 
	`h–p
();

262 
	`CÍ_D–‘eP¬£r
(
şp
);

264 ià(
‹¡s
.
	`em±y
()) {

265 
‹¡s
.
	`push_back
("PQ");

266 
‹¡s
.
	`push_back
("it");

269 ià(
glob®_£ed
)

270 
	`¤ªdom
(
glob®_£ed
);

272 
	`¤ªdomdev
();

273 
i
 = 0; i < 
	`¬¿ysize
(
š™Ÿl_£eds
); ++i)

274 
š™Ÿl_£eds
[
i
] = 
	`¿ndom
();

276 
±h»ad_t
 
advªûr
;

277 
	`±h»ad_ü—‹
(&
advªûr
, 
NULL
, 
T¿n§ùiÚ
::
•och_advªûr
, NULL);

278 
	`±h»ad_d‘ach
(
advªûr
);

281 autØ
‹¡
 : 
‹¡s
) {

282 ià(
	`¡rcmp
(
‹¡
, "PQ") == 0 || strcmp(test, "pq") == 0)

283 
run_ªd_»pÜt
<
PriÜ™yQueue
<>>("PQ");

284 ià(
	`¡rcmp
(
‹¡
, "PQ1") == 0 || strcmp(test, "pq1") == 0 || strcmp(test, "it") == 0)

285 
run_ªd_»pÜt
<
PriÜ™yQueue1
<>>("PQ1");

286 ià(
	`¡rcmp
(
‹¡
, "std") == 0)

287 
run_ªd_»pÜt
<
¡d
::
´iÜ™y_queue
<, 
TVeùÜ
<>>>("std");

288 ià(
	`¡rcmp
(
‹¡
, "std-nopred") == 0)

289 
run_ªd_»pÜt
<
¡d
::
´iÜ™y_queue
<, 
TVeùÜ_nİ»d
<>>>("std-nopred");

291 
	`as£¹
(
çl£
);

295 
	}
}

	@test/pqueue.cc

1 
	~<¡ršg
>

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

4 
	~<veùÜ
>

5 
	~<¿ndom
>

6 
	~<m­
>

7 
	~"T¿n§ùiÚ.hh
"

8 
	~"VeùÜ.hh
"

9 
	~"PriÜ™yQueue.hh
"

10 
	~"PriÜ™yQueue1.hh
"

11 
	~"¿ndg’.hh
"

13 
	#GLOBAL_SEED
 0

	)

14 
	#MAX_VALUE
 100000

	)

15 
	#NTRANS
 1000

	)

16 
	#N_THREADS
 4

	)

18 
	gPriÜ™yQueue
<> 
	td©a_¡ruùu»
;

19 
	gš™Ÿl_£eds
[128];

22 
	stxn_»cÜd
 {

24 
	m¡d
::
veùÜ
<> 
pushes
;

25 
	m¡d
::
veùÜ
<> 
tİs
;

26 
	mpİs
;

31 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

32 
	sTe¡”Paœ
 {

33 
T
* 
	mt
;

34 
	mme
;

37 
	g¡d
::
veùÜ
<
¡d
::
m­
<
ušt64_t
, 
	gtxn_»cÜd
 *> > 
	gtxn_li¡
;

38 
	gT¿n§ùiÚTid
::
	tty³
 
	tV”siÚ
;

39 
V”siÚ
 
	glock
;

41 
	$run_cÚc
(
d©a_¡ruùu»
* 
q
, 
me
) {

42 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(0, 
MAX_VALUE
);

43 
Rªd
 
	`Œªsg’
(
š™Ÿl_£eds
[2*
me
], initial_seeds[2*me + 1]);

45 
i
 = 0; i < 
NTRANS
; ++i) {

47 
v®1
 = 
	`¦Ùdi¡
(
Œªsg’
);

48 
v®2
 = 
	`¦Ùdi¡
(
Œªsg’
);

49 
v®3
 = 
	`¦Ùdi¡
(
Œªsg’
);

50 
q
->
	`push_nÚŒªs
(
v®1
);

51 
q
->
	`push_nÚŒªs
(
v®2
);

52 
q
->
	`push_nÚŒªs
(
v®3
);

56 
	}
}

58 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

59 
	$run
(
T
* 
q
, 
me
) {

60 
TTh»ad
::
	`£t_id
(
me
);

62 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(0, 
MAX_VALUE
);

63 
Rªd
 
	`Œªsg’
(
š™Ÿl_£eds
[2*
me
], initial_seeds[2*me + 1]);

65 
i
 = 0; i < 
NTRANS
; ++i) {

67 
Rªd
 
Œªsg’_¢­
 = 
Œªsg’
;

68 
txn_»cÜd
 *
Œ
 = 
Ãw
xn_record;

70 
Sto
::
	`¡¬t_Œª§ùiÚ
();

71 
Œy
 {

72 
Œ
->
pushes
.
	`ş—r
();

73 
Œ
->
pİs
 = 0;

74 
Œ
->
tİs
.
	`ş—r
();

76 
v®1
 = 
	`¦Ùdi¡
(
Œªsg’
);

77 
v®2
 = 
	`¦Ùdi¡
(
Œªsg’
);

78 
v®3
 = 
	`¦Ùdi¡
(
Œªsg’
);

79 
q
->
	`pİ
();

83 
q
->
	`push
(
v®1
);

90 
q
->
	`push
(
v®2
);

104 
rv®
 = 
q
->
	`tİ
();

112 
q
->
	`push
(
v®3
);

118 
Œ
->
pushes
.
	`push_back
(
v®1
);

119 
Œ
->
pushes
.
	`push_back
(
v®2
);

120 
Œ
->
pushes
.
	`push_back
(
v®3
);

121 
Œ
->
pİs
 = 1;

122 
Œ
->
tİs
.
	`push_back
(
rv®
);

124 ià(
Sto
::
	`Œy_comm™
()) {

128 
txn_li¡
[
me
][
Sto
::
	`comm™_tid
()] = 
Œ
;

132 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

135 
Œªsg’
 = 
Œªsg’_¢­
;

138 
	}
}

140 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

141 * 
	$runFunc
(* 
x
) {

142 
Te¡”Paœ
<
T
>* 

 = (Te¡”Paœ<T>*è
x
;

143 
	`run
(

->
t
,p->
me
);

144  
nuÎ±r
;

145 
	}
}

147 * 
	$runCÚcFunc
(* 
x
) {

148 
Te¡”Paœ
<
d©a_¡ruùu»
>* 

 = (Te¡”Paœ<d©a_¡ruùu»>*è
x
;

149 
	`run_cÚc
(

->
t
,p->
me
);

150  
nuÎ±r
;

151 
	}
}

153 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

154 
	$¡¬tAndWa™
(
T
* 
queue
, 
boŞ
 
·¿Î–
 = 
Œue
) {

155 
±h»ad_t
 
tids
[
N_THREADS
];

156 
Te¡”Paœ
<
T
> 
‹¡”s
[
N_THREADS
];

157 
i
 = 0; i < 
N_THREADS
; ++i) {

158 
‹¡”s
[
i
].
t
 = 
queue
;

159 
‹¡”s
[
i
].
me
 = i;

160 ià(
·¿Î–
)

161 
	`±h»ad_ü—‹
(&
tids
[
i
], 
NULL
, 
runFunc
<
T
>, &
‹¡”s
[i]);

163 
	`±h»ad_ü—‹
(&
tids
[
i
], 
NULL
, 
runCÚcFunc
, &
‹¡”s
[i]);

166 
i
 = 0; i < 
N_THREADS
; ++i) {

167 
	`±h»ad_još
(
tids
[
i
], 
NULL
);

169 
	}
}

172 
	$queueTe¡s
() {

173 
d©a_¡ruùu»
 
q
;

178 
T¿n§ùiÚGu¬d
 
t
;

180 
q
.
	`push
(1);

181 
q
.
	`push
(2);

182 
	`as£¹
(
q
.
	`tİ
() == 2);

183 
q
.
	`pİ
();

184 
	`as£¹
(
q
.
	`tİ
() == 1);

185 
q
.
	`pİ
();

189 
T¿n§ùiÚGu¬d
 
t
;

191 
q
.
	`push
(1);

192 
q
.
	`push
(2);

197 
T¿n§ùiÚGu¬d
 
t
;

198 
	`as£¹
(
q
.
	`tİ
() == 2);

199 
	`as£¹
(
q
.
	`tİ
() == 2);

204 
T¿n§ùiÚGu¬d
 
t
;

205 
q
.
	`pİ
();

206 
q
.
	`pİ
();

209 
q
.
	`push
(1);

210 
q
.
	`push
(2);

211 
q
.
	`push
(3);

216 
T¿n§ùiÚGu¬d
 
t
;

217 
	`as£¹
(
q
.
	`tİ
() == 3);

218 
q
.
	`pİ
();

219 
	`as£¹
(
q
.
	`tİ
() == 2);

220 
q
.
	`pİ
();

221 
	`as£¹
(
q
.
	`tİ
() == 1);

222 
q
.
	`pİ
();

226 
q
.
	`push
(1);

227 
q
.
	`push
(2);

228 
q
.
	`push
(3);

233 
T¿n§ùiÚGu¬d
 
t
;

234 
	`as£¹
(
q
.
	`tİ
() == 3);

235 
	`as£¹
(
q
.
	`tİ
() == 3);

236 
q
.
	`push
(4);

237 
	`as£¹
(
q
.
	`tİ
() == 4);

243 
T¿n§ùiÚGu¬d
 
t
;

244 
q
.
	`pİ
();

245 
	`as£¹
(
q
.
	`tİ
() == 3);

246 
q
.
	`push
(5);

248 
q
.
	`pİ
();

249 
	`as£¹
(
q
.
	`tİ
() == 3);

250 
q
.
	`push
(6);

257 
T¿n§ùiÚGu¬d
 
t
;

259 
q
.
	`pİ
();

260 
q
.
	`pİ
();

261 
q
.
	`pİ
();

262 
q
.
	`pİ
();

267 
q
.
	`push
(1);

268 
	`as£¹
(
q
.
	`tİ
() == 1);

269 
	`as£¹
(
q
.
	`tİ
() == 1);

274 
T¿n§ùiÚGu¬d
 
t
;

276 
q
.
	`pİ
();

281 
q
.
	`push
(1);

282 
q
.
	`pİ
();

288 
T¿n§ùiÚGu¬d
 
t
;

291 
q
.
	`push
(1);

292 
	`as£¹
(
q
.
	`tİ
() == 1);

293 
q
.
	`pİ
();

295 
q
.
	`push
(1);

296 
q
.
	`pİ
();

301 
q
.
	`push
(1);

302 
q
.
	`push
(2);

308 
Te¡T¿n§ùiÚ
 
	`t1
(1);

309 
Te¡T¿n§ùiÚ
 
	`t2
(2);

311 
t1
.
	`u£
();

312 
q
.
	`pİ
();

313 
t2
.
	`u£
();

314 
boŞ
 
abÜ‹d
 = 
çl£
;

315 
Œy
 {

316 
q
.
	`pİ
();

317 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

318 
abÜ‹d
 = 
Œue
;

320 
	`as£¹
(
t1
.
	`Œy_comm™
());

321 
	`as£¹
(
abÜ‹d
);

326 
Te¡T¿n§ùiÚ
 
	`t1
(1);

327 
Te¡T¿n§ùiÚ
 
	`t2
(2);

329 
t1
.
	`u£
();

331 
q
.
	`pİ
();

332 
t2
.
	`u£
();

333 
boŞ
 
abÜ‹d
 = 
çl£
;

334 
Œy
 {

335 
q
.
	`push
(3);

336 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

337 
abÜ‹d
 = 
Œue
;

339 
	`as£¹
(
t1
.
	`Œy_comm™
());

340 
	`as£¹
(
abÜ‹d
);

343 
T¿n§ùiÚGu¬d
 
t3
;

344 
q
.
	`push
(3);

348 
T¿n§ùiÚGu¬d
 
t1
;

349 
	`as£¹
(
q
.
	`tİ
() == 3);

350 
q
.
	`pİ
();

355 
Te¡T¿n§ùiÚ
 
	`t1
(1);

356 
Te¡T¿n§ùiÚ
 
	`t2
(2);

358 
t1
.
	`u£
();

359 
q
.
	`pİ
();

360 
q
.
	`push
(1);

361 
q
.
	`push
(2);

363 
t2
.
	`u£
();

364 
q
.
	`push
(3);

365 
q
.
	`push
(4);

366 
q
.
	`push
(5);

367 
q
.
	`pİ
();

369 
	`as£¹
(!
t1
.
	`Œy_comm™
());

370 
	`as£¹
(
t2
.
	`Œy_comm™
());

374 
T¿n§ùiÚGu¬d
 
t
;

375 
q
.
	`pİ
();

376 
q
.
	`pİ
();

377 
q
.
	`push
(1);

378 
q
.
	`push
(2);

383 
Te¡T¿n§ùiÚ
 
	`t1
(1);

384 
Te¡T¿n§ùiÚ
 
	`t2
(2);

387 
t1
.
	`u£
();

388 
	`as£¹
(
q
.
	`tİ
() == 2);

389 
q
.
	`push
(4);

392 
q
.
	`pİ
();

393 
	`as£¹
(
q
.
	`tİ
() == 2);

394 
	`as£¹
(
t1
.
	`Œy_comm™
());

396 
t2
.
	`u£
();

397 
q
.
	`push
(3);

399 
	`as£¹
(
t2
.
	`Œy_comm™
());

404 
T¿n§ùiÚGu¬d
 
t
;

405 
	`as£¹
(
q
.
	`tİ
() == 3);

406 
q
.
	`pİ
();

407 
	`as£¹
(
q
.
	`tİ
() == 2);

408 
q
.
	`pİ
();

409 
	`as£¹
(
q
.
	`tİ
() == 1);

410 
q
.
	`pİ
();

414 
T¿n§ùiÚGu¬d
 
t
;

415 
q
.
	`push
(10);

416 
q
.
	`push
(4);

417 
q
.
	`push
(5);

421 
Te¡T¿n§ùiÚ
 
	`t1
(1);

422 
q
.
	`pİ
();

423 
q
.
	`push
(20);

425 
Te¡T¿n§ùiÚ
 
	`t2
(2);

426 
boŞ
 
abÜ‹d
 = 
çl£
;

427 
Œy
 {

428 
q
.
	`push
(12);

429 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

430 
abÜ‹d
 = 
Œue
;

433 
	`as£¹
(
t1
.
	`Œy_comm™
());

434 
	`as£¹
(
abÜ‹d
);

438 
Te¡T¿n§ùiÚ
 
	`t
(1);

439 
q
.
	`tİ
();

441 
Te¡T¿n§ùiÚ
 
	`t1
(2);

442 
q
.
	`push
(100);

444 
	`as£¹
(
t1
.
	`Œy_comm™
());

445 
	`as£¹
(!
t
.
	`Œy_comm™
());

450 
T¿n§ùiÚGu¬d
 
t
;

451 
q
.
	`pİ
();

452 
q
.
	`pİ
();

453 
q
.
	`pİ
();

454 
q
.
	`pİ
();

455 
q
.
	`push
(5);

459 
Te¡T¿n§ùiÚ
 
	`t
(1);

460 
q
.
	`tİ
();

461 
q
.
	`push
(10);

463 
Te¡T¿n§ùiÚ
 
	`t1
(2);

464 
q
.
	`push
(7);

465 
	`as£¹
(
t1
.
	`Œy_comm™
());

466 
	`as£¹
(!
t
.
	`Œy_comm™
());

471 
T¿n§ùiÚGu¬d
 
t
;

472 
q
.
	`pİ
();

473 
q
.
	`pİ
();

477 
Te¡T¿n§ùiÚ
 
	`t
(1);

478 
q
.
	`pİ
();

480 
Te¡T¿n§ùiÚ
 
	`t1
(2);

481 
q
.
	`push
(4);

482 
	`as£¹
(
t1
.
	`Œy_comm™
());

483 
	`as£¹
(!
t
.
	`Œy_comm™
());

487 
Te¡T¿n§ùiÚ
 
	`t
(1);

488 
	`as£¹
(
q
.
	`tİ
() == 4);

490 
Te¡T¿n§ùiÚ
 
	`t1
(2);

491 
q
.
	`push
(6);

492 
	`as£¹
(
t1
.
	`Œy_comm™
());

494 
Te¡T¿n§ùiÚ
 
	`t2
(3);

495 
q
.
	`pİ
();

497 
	`as£¹
(!
t
.
	`Œy_comm™
());

498 
	`as£¹
(
t2
.
	`Œy_comm™
());

503 
Te¡T¿n§ùiÚ
 
	`t
(1);

504 
	`as£¹
(
q
.
	`tİ
() == 4);

506 
Te¡T¿n§ùiÚ
 
	`t1
(2);

507 
q
.
	`push
(6);

508 
	`as£¹
(
t1
.
	`Œy_comm™
());

510 
t
.
	`u£
();

511 
boŞ
 
abÜ‹d
 = 
çl£
;

512 
Œy
 {

513 
q
.
	`pİ
();

514 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

515 
abÜ‹d
 = 
Œue
;

517 
	`as£¹
(
abÜ‹d
);

519 
	}
}

521 
	$´št_time
(
timev®
 
tv1
, timev® 
tv2
) {

522 
	`´štf
("%f\n", (
tv2
.
tv_£c
-
tv1
.tv_£cè+ (tv2.
tv_u£c
-tv1.tv_usec)/1000000.0);

523 
	}
}

525 
	$maš
() {

526 
	`queueTe¡s
();

527 
¡d
::
cout
 << "DÚqueu‹¡s" << std::
’dl
;

528 
lock
 = 0;

530 
d©a_¡ruùu»
 
q
;

542 #ià
GLOBAL_SEED


543 
	`¤ªdom
(
GLOBAL_SEED
);

545 
	`¤ªdomdev
();

547 
i
 = 0; i < 
	`¬¿ysize
(
š™Ÿl_£eds
); ++i)

548 
š™Ÿl_£eds
[
i
] = 
	`¿ndom
();

550 
timev®
 
tv1
,
tv2
;

551 
	`g‘timeofday
(&
tv1
, 
NULL
);

553 
i
 = 0; i < 
N_THREADS
; i++) {

554 
txn_li¡
.
	`em¶aû_back
();

557 
±h»ad_t
 
advªûr
;

558 
	`±h»ad_ü—‹
(&
advªûr
, 
NULL
, 
T¿n§ùiÚ
::
•och_advªûr
, NULL);

559 
	`±h»ad_d‘ach
(
advªûr
);

561 
	`¡¬tAndWa™
(&
q
);

563 
	`g‘timeofday
(&
tv2
, 
NULL
);

564 
	`´štf
("Parallelime: ");

565 
	`´št_time
(
tv1
, 
tv2
);

567 #ià
STO_PROFILE_COUNTERS


568 
T¿n§ùiÚ
::
	`´št_¡©s
();

570 
txp_couÁ”s
 
tc
 = 
T¿n§ùiÚ
::
	`txp_couÁ”s_combšed
();

571 
	`´štf
("tÙ®_n: %Îu,Ù®_r: %Îu,Ù®_w: %Îu,Ù®_£¬ched: %Îu,Ù®_abÜts: %Îu (%Îu‡bÜt © comm™ime)\n", 
tc
.
	`p
(
txp_tÙ®_n
),c.p(
txp_tÙ®_r
),c.p(
txp_tÙ®_w
),c.p(
txp_tÙ®_£¬ched
),c.p(
txp_tÙ®_abÜts
),c.p(
txp_comm™_time_abÜts
));

576 
¡d
::
m­
<
ušt64_t
, 
txn_»cÜd
 *> 
combšed_txn_li¡
;

578 
i
 = 0; i < 
N_THREADS
; i++) {

579 
combšed_txn_li¡
.
	`š£¹
(
txn_li¡
[
i
].
	`begš
(),xn_li¡[i].
	`’d
());

582 
¡d
::
cout
 << "SšgËh»ad„•Ïy" << std::
’dl
;

583 
d©a_¡ruùu»
 
q1
;

584 
	`g‘timeofday
(&
tv1
, 
NULL
);

586 
¡d
::
m­
<
ušt64_t
, 
txn_»cÜd
 *>::
™”©Ü
 
™
 = 
combšed_txn_li¡
.
	`begš
();

588 ; 
™
 !ğ
combšed_txn_li¡
.
	`’d
(); it++) {

589 
Sto
::
	`¡¬t_Œª§ùiÚ
();

590 
q1
.
	`pİ
();

591 
q1
.
	`push
(
™
->
£cÚd
->
pushes
[0]);

593 
q1
.
	`push
(
™
->
£cÚd
->
pushes
[1]);

596 
	`as£¹
(
q1
.
	`tİ
(è=ğ
™
->
£cÚd
->
tİs
[0]);

598 
q1
.
	`push
(
™
->
£cÚd
->
pushes
[2]);

600 
	`as£¹
(
Sto
::
	`Œy_comm™
());

607 
	`g‘timeofday
(&
tv2
, 
NULL
);

608 
	`´štf
("Serialime: ");

609 
	`´št_time
(
tv1
, 
tv2
);

638 ià(
Œue
) {

639 
TRANSACTION
 {

642 } 
	`RETRY
(
çl£
);

645 
	`as£¹
(
q1
.
	`un§ã_size
(è=ğ
N_THREADS
* 
NTRANS
*2 + 1);

646 
size
 = 
q1
.
	`un§ã_size
();

647 
i
 = 0; i < 
size
; i++) {

648 
TRANSACTION
 {

649 
v1
 = 
q
.
	`tİ
();

650 
v2
 = 
q1
.
	`tİ
();

652 ià(
v1
 !ğ
v2
)

653 
q1
.
	`´št
();

654 
	`as£¹
(
v1
 =ğ
v2
);

655 
	`as£¹
(
q
.
	`pİ
(è=ğ
v1
);

656 
	`as£¹
(
q1
.
	`pİ
(è=ğ
v2
);

657 } 
	`RETRY
(
çl£
);

659 
TRANSACTION
 {

660 
q
.
	`´št
();

661 
	`as£¹
(
q
.
	`tİ
() == -1);

663 } 
	`RETRY
(
çl£
);

667 
	}
}

	@test/predicates.cc

1 
	~<¡ršg
>

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

4 
	~<veùÜ
>

5 
	~<s¡»am
>

6 
	~<¿ndom
>

7 
	~<m­
>

8 
	~"T¿n§ùiÚ.hh
"

9 
	~"TVeùÜ.hh
"

10 
	~"TVeùÜ_nİ»d.hh
"

11 
	~"şp.h
"

12 
	~"¿ndg’.hh
"

13 
	~<sys/time.h
>

14 
	gmax_¿nge
 = 10000;

15 
	gmax_v®ue
 = 1000;

16 
	gglob®_£ed
 = 0;

17 
	gÁh»ads
 = 2;

18 
	gÁ¿ns
 = 1000000;

19 
	gİ¥”Œªs
 = 1;

20 
	g´•İuÏ‹
 = 1000;

21 
	gmax_key
 = 1000;

22 
	g£¬ch_³rûÁ
 = 0.6;

23 
	gpushback_³rûÁ
 = 0.2;

25 
	gfšd_abÜts
[32];

26 
ušt64_t
 
	gchecksums
[32];

27 
ušt32_t
 
	gš™Ÿl_£eds
[64];

28 
	gunsucûssful_fšds
 = 0;

29 
	gT¿n§ùiÚTid
::
ty³
 
lock
;

31 
	gTVeùÜ
<> 
	t´ed_d©a_¡ruùu»
;

32 
	gTVeùÜ_nİ»d
<> 
	tnİ»d_d©a_¡ruùu»
;

35 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

36 
	sTe¡”Paœ
 {

37 
T
* 
	mt
;

38 
	mme
;

41 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

42 
	$fšdK
(
T
* 
q
, 
v®
) {

43 
ty³Çme
 
T
::
cÚ¡_™”©Ü
 
f™
 = 
q
->
	`cbegš
();

44 
ty³Çme
 
T
::
cÚ¡_™”©Ü
 
e™
 = 
q
->
	`ûnd
();

45 
ty³Çme
 
T
::
cÚ¡_™”©Ü
 
™
 = 
f™
;

46 
™
 !ğ
e™
 && *™ !ğ
v®
)

47 ++
™
;

48  
™
 - 
f™
;

49 
	}
}

51 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

52 
	$run_fšd_push_pİ_g‘
(
T
* 
q
, 
me
) {

53 
TTh»ad
::
	`£t_id
(
me
);

54 
usšg
 
size_ty³
 = 
ty³Çme
 
T
::size_type;

55 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(0, 
max_¿nge
);

56 
Rªd
 
	`Œªsg’
(
š™Ÿl_£eds
[2*
me
], initial_seeds[2*me + 1]);

58 
N
 = 
Á¿ns
/
Áh»ads
;

59 
OPS
 = 
İ¥”Œªs
;

60 
boŞ
 
fšd_İ
 = 
çl£
;

61 
ÇbÜts
 = 0;

63 
size_ty³
 
maxkey50
 = 
	`size_ty³
(
max_key
 * 0.5);

64 
size_ty³
 
maxkey90
 = 
	`size_ty³
(
max_key
 * 0.9);

65 
size_ty³
 
maxkey110
 = 
	`size_ty³
(
max_key
 * 1.1);

66 
Rªd
::
»suÉ_ty³
 
£¬ch_th»sh
 = 
£¬ch_³rûÁ
 * Rªd::
	`max
();

67 
Rªd
::
»suÉ_ty³
 
pushback_th»sh
 = (
£¬ch_³rûÁ
 + 
pushback_³rûÁ
è* Rªd::
	`max
();

68 
Rªd
::
»suÉ_ty³
 
pİback_th»sh
 = (
£¬ch_³rûÁ
 + 2 * 
pushback_³rûÁ
è* Rªd::
	`max
();

70 
ty³Çme
 
T
::
v®ue_ty³
 
»suÉs
[
OPS
];

71 
ÄesuÉs
;

72 
ušt64_t
 
checksum
 = 0;

74 
i
 = 0; i < 
N
; ++i) {

76 
Rªd
 
¢­_Œªsg’
 = 
Œªsg’
;

78 
Sto
::
	`¡¬t_Œª§ùiÚ
();

79 
ÄesuÉs
 = 0;

80 
Œy
 {

81 
j
 = 0; j < 
OPS
; ++j) {

82 
fšd_İ
 = 
çl£
;

83 
Rªd
::
»suÉ_ty³
 
İ
 = 
	`Œªsg’
();

84 ià(
İ
 < 
£¬ch_th»sh
) {

85 
v®
 = 
	`¦Ùdi¡
(
Œªsg’
è% 
maxkey50
;

86 
fšd_İ
 = 
Œue
;

87 
»suÉs
[
ÄesuÉs
++] = 
	`fšdK
(
q
, 
v®
);

88 } ià(
İ
 < 
pushback_th»sh
) {

89 ià(
q
->
	`size
(è< 
	`size_ty³
(
maxkey110
)) {

90 
v®
 = 
	`¦Ùdi¡
(
Œªsg’
è% 
max_v®ue
;

91 
q
->
	`push_back
(
v®
);

93 
q
->
	`pİ_back
();

95 } ià(
İ
 < 
pİback_th»sh
) {

96 ià(
q
->
	`size
(è> 
	`size_ty³
(
maxkey90
)) {

97 
q
->
	`pİ_back
();

99 
v®
 = 
	`¦Ùdi¡
(
Œªsg’
è% 
max_v®ue
;

100 
q
->
	`push_back
(
v®
);

102 } ià(
q
->
	`size
(è>ğ
	`size_ty³
(
max_key
)) {

103 
key
 = 
	`¦Ùdi¡
(
Œªsg’
è% 
max_key
;

104 
»suÉs
[
ÄesuÉs
++] = 
q
->
	`ŒªsG‘
(
key
);

106 
key
 = 
	`¦Ùdi¡
(
Œªsg’
è% 
q
->
	`size
();

107 
»suÉs
[
ÄesuÉs
++] = 
q
->
	`ŒªsG‘
(
key
);

111 ià(
Sto
::
	`Œy_comm™
())

113 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

115 ià(
fšd_İ
)

116 ++
ÇbÜts
;

117 
Œªsg’
 = 
¢­_Œªsg’
;

120 
x
 = 0; x !ğ
ÄesuÉs
; ++x)

121 
checksum
 +ğ
»suÉs
[
x
] << x;

124 
fšd_abÜts
[
me
] = 
ÇbÜts
;

125 
checksums
[
me
] = 
checksum
;

126 
	}
}

128 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

129 
	$run_push_pİ
(
T
* 
q
, 
me
) {

130 
TTh»ad
::
	`£t_id
(
me
);

131 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(0, 999);

132 
Rªd
 
	`Œªsg’
(
š™Ÿl_£eds
[2*
me
], initial_seeds[2*me + 1]);

134 
N
 = 
Á¿ns
/
Áh»ads
;

135 
OPS
 = 
İ¥”Œªs
;

136 
Ä‘r›s
 = 0;

137 
¡d
::
o¡ršg¡»am
 
ob
;

138 
kšds
[3] = {0, 0, 0};

140 
i
 = 0; i < 
N
; ++i) {

141 
Rªd
 
Œªsg’_¢­
 = 
Œªsg’
;

142 
wh©
;

144 
Sto
::
	`¡¬t_Œª§ùiÚ
();

145 
wh©
 = 0;

146 
Œy
 {

147 
j
 = 0; j < 
OPS
; ++j) {

148 ià(
q
->
	`size
() < 1001) {

149 
q
->
	`push_back
(
	`¦Ùdi¡
(
Œªsg’
));

150 
wh©
 = 1;

151 } ià(
q
->
	`size
() > 4000) {

152 
q
->
	`pİ_back
();

153 
wh©
 = 2;

154 } ià((*
q
)[
	`¦Ùdi¡
(
Œªsg’
)] >= 500)

155 
q
->
	`pİ_back
();

157 
q
->
	`push_back
(
	`¦Ùdi¡
(
Œªsg’
));

159 ià(
Sto
::
	`Œy_comm™
())

161 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
) {}

162 
Œªsg’
 = 
Œªsg’_¢­
;

163 ++
Ä‘r›s
;

165 ++
kšds
[
wh©
];

169 
fšd_abÜts
[
me
] = 
Ä‘r›s
;

170 
	}
}

172 cÚ¡ * 
	g‹¡_Çme
 = "find-push-pop-get";

174 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

175 * 
	$runFunc
(* 
x
) {

176 
Te¡”Paœ
<
T
>* 

 = (Te¡”Paœ<T>*è
x
;

177 ià(
	`¡rcmp
(
‹¡_Çme
, "find-push-pop-get") == 0)

178 
	`run_fšd_push_pİ_g‘
(

->
t
,p->
me
);

179 ià(
	`¡rcmp
(
‹¡_Çme
, "push-pop") == 0)

180 
	`run_push_pİ
(

->
t
,p->
me
);

182 
	`abÜt
();

183  
nuÎ±r
;

184 
	}
}

186 
boŞ
 
	ghas_•och_advªûr
 = 
çl£
;

188 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

189 
	$¡¬tAndWa™
(
n
, 
T
* 
queue
) {

190 
±h»ad_t
 
tids
[
Áh»ads
];

191 
Te¡”Paœ
<
T
> *
‹¡”s
 = 
Ãw
 Te¡”Paœ<T>[
n
];

192 
i
 = 0; i < 
Áh»ads
; ++i) {

193 
‹¡”s
[
i
].
t
 = 
queue
;

194 
‹¡”s
[
i
].
me
 = i;

195 
	`±h»ad_ü—‹
(&
tids
[
i
], 
NULL
, 
runFunc
<
T
>, &
‹¡”s
[i]);

198 ià(!
has_•och_advªûr
) {

199 
±h»ad_t
 
advªûr
;

200 
	`±h»ad_ü—‹
(&
advªûr
, 
NULL
, 
T¿n§ùiÚ
::
•och_advªûr
, NULL);

201 
	`±h»ad_d‘ach
(
advªûr
);

202 
has_•och_advªûr
 = 
Œue
;

205 
i
 = 0; i < 
Áh»ads
; ++i)

206 
	`±h»ad_još
(
tids
[
i
], 
NULL
);

207 
	}
}

209 
	$´št_time
(
timev®
 
tv1
, timev® 
tv2
) {

210 
	`´štf
("%f\n", (
tv2
.
tv_£c
-
tv1
.tv_£cè+ (tv2.
tv_u£c
-tv1.tv_usec)/1000000.0);

211 
	}
}

214 
	mİt_Áh»ads
 = 1, 
	mİt_Á¿ns
, 
	mİt_İ¥”Œªs
, 
	mİt_£¬ch³rûÁ
, 
	mİt_pushback³rûÁ
, 
	mİt_´•İuÏ‹
, 
	mİt_£ed
, 
	mİt_´ediÿ‹s


217 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

218 { "Áh»ads", 'j', 
İt_Áh»ads
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

219 { "Á¿ns", 0, 
İt_Á¿ns
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

220 { "İ¥”Œªs", 0, 
İt_İ¥”Œªs
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

221 { "£¬ch³rûÁ", 0, 
İt_£¬ch³rûÁ
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

222 { "pushback³rûÁ", 0, 
İt_pushback³rûÁ
, 
CÍ_V®DoubË
, 
CÍ_O±iÚ®
 },

223 { "´•İuÏ‹", 0, 
İt_´•İuÏ‹
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

224 { "£ed", 0, 
İt_£ed
, 
CÍ_V®IÁ
, 
CÍ_O±iÚ®
 },

225 { "´ediÿ‹s", 0, 
İt_´ediÿ‹s
, 0, 
CÍ_Neg©e
 }

228 
	$h–p
() {

229 
	`´štf
("Usage: [OPTIONS] [find-push-pop-get|push-pop]\n\
:\n\
--nthreads=NTHREADS (default %d)\n\
--ntrans=NTRANS, how manyotalransactionso„un (they'll be split betweenhreads) (default %d)\n\
--opspertrans=OPSPERTRANS, how many operationso„un…erransaction (default %d)\n\
--searchpercent=SEARCHPERCENT,…robability with whicho do searches (default %f)\n\
--pushbackpercent=PUSHBACKPERCENT,…robability with whicho do…ush backs (default %f)\n\
--prepopulate=PREPOPULATE,…repopulateable with given‚umber of items (default %d)\n\
--seed=SEED, global seedo„unheƒxperiment \n",

238 
Áh»ads
, 
Á¿ns
, 
İ¥”Œªs
, 
£¬ch_³rûÁ
, 
pushback_³rûÁ
, 
´•İuÏ‹
);

239 
	`ex™
(1);

240 
	}
}

242 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

243 
	$š™
(
T
* 
q
) {

244 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(0, 
max_v®ue
 - 1);

245 
Rªd
 
	`Œªsg’
(
	`¿ndom
(),„andom());

246 
i
 = 0; i < 
´•İuÏ‹
; i++) {

247 
TRANSACTION
 {

248 
q
->
	`push_back
(
i
);

249 } 
	`RETRY
(
çl£
);

251 
	}
}

253 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

254 
	$run_ªd_»pÜt
(cÚ¡ * 
Çme
) {

255 
timev®
 
tv1
,
tv2
;

257 
i
 = 0; i < 
	`¬¿ysize
(
fšd_abÜts
); ++i)

258 
fšd_abÜts
[
i
] = 
checksums
[i] = 0;

259 
unsucûssful_fšds
 = 0;

261 
T
 
q
;

262 
q
.
	`nÚŒªs_»£rve
(4096);

263 
	`š™
(&
q
);

265 
	`g‘timeofday
(&
tv1
, 
NULL
);

267 
	`¡¬tAndWa™
(
Áh»ads
, &
q
);

269 
	`g‘timeofday
(&
tv2
, 
NULL
);

271 
tÙ®_abÜts
 = 0, 
checksum
 = 0;

272 
i
 = 0; i < 
	`¬¿ysize
(
fšd_abÜts
); i++) {

273 
tÙ®_abÜts
 +ğ
fšd_abÜts
[
i
];

274 
checksum
 +ğ
checksums
[
i
] << i;

276 
	`´štf
("R‘r›s: %Îu, unsucûssfuÈfšds: %i", 
tÙ®_abÜts
, 
unsucûssful_fšds
);

277 ià(
Áh»ads
 == 1)

278 
	`´štf
(", checksum: %Îx", 
checksum
);

279 
	`´štf
("\n%s: ", 
Çme
);

280 
	`´št_time
(
tv1
, 
tv2
);

282 #ià
STO_PROFILE_COUNTERS


283 
T¿n§ùiÚ
::
	`´št_¡©s
();

285 
txp_couÁ”s
 
tc
 = 
T¿n§ùiÚ
::
	`txp_couÁ”s_combšed
();

286 
	`´štf
("tÙ®_n: %Îu,Ù®_r: %Îu,Ù®_w: %Îu,Ù®_£¬ched: %Îu,Ù®_abÜts: %Îu (%Îu‡bÜt © comm™ime)\n", 
tc
.
	`p
(
txp_tÙ®_n
),c.p(
txp_tÙ®_r
),c.p(
txp_tÙ®_w
),c.p(
txp_tÙ®_£¬ched
),c.p(
txp_tÙ®_abÜts
),c.p(
txp_comm™_time_abÜts
));

288 
T¿n§ùiÚ
::
	`ş—r_¡©s
();

290 
	}
}

292 
	$maš
(
¬gc
, *
¬gv
[]) {

293 
lock
 = 0;

295 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
	`¬¿ysize
(
İtiÚs
), options);

296 
İt
;

297 
aùiÚs
 = 3;

299 (
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
) {

300 
İt
) {

301 
İt_Áh»ads
:

302 
Áh»ads
 = 
şp
->
v®
.
i
;

304 
İt_Á¿ns
:

305 
Á¿ns
 = 
şp
->
v®
.
i
;

307 
İt_İ¥”Œªs
:

308 
İ¥”Œªs
 = 
şp
->
v®
.
i
;

310 
İt_£¬ch³rûÁ
:

311 
£¬ch_³rûÁ
 = 
şp
->
v®
.
d
;

313 
İt_pushback³rûÁ
:

314 
pushback_³rûÁ
 = 
şp
->
v®
.
d
;

316 
İt_´•İuÏ‹
:

317 
´•İuÏ‹
 = 
şp
->
v®
.
i
;

319 
İt_£ed
:

320 
glob®_£ed
 = 
şp
->
v®
.
i
;

322 
İt_´ediÿ‹s
:

323 
aùiÚs
 = 
şp
->
Ãg©ed
 ? 2 : 1;

325 
CÍ_NÙO±iÚ
:

326 
‹¡_Çme
 = 
şp
->
v¡r
;

329 
	`h–p
();

332 
	`CÍ_D–‘eP¬£r
(
şp
);

334 ià(
glob®_£ed
)

335 
	`¤ªdom
(
glob®_£ed
);

337 
	`¤ªdomdev
();

338 
i
 = 0; i < 
	`¬¿ysize
(
š™Ÿl_£eds
); ++i)

339 
š™Ÿl_£eds
[
i
] = 
	`¿ndom
();

341 
	`´štf
("%s, %dh»ads, %d¿ns, %d op¥”Œªs\n", 
‹¡_Çme
, 
Áh»ads
, 
Á¿ns
, 
İ¥”Œªs
);

342 #ià!
NDEBUG


343 
	`´štf
("THIS IS NOT AN NDEBUG RUN,…redicates‡ssertions‡re $$expensive$$\n");

345 ià(
aùiÚs
 & 1)

346 
run_ªd_»pÜt
<
´ed_d©a_¡ruùu»
>("Predicates");

347 ià(
aùiÚs
 & 2)

348 
run_ªd_»pÜt
<
nİ»d_d©a_¡ruùu»
>("No…redicates");

350 
	}
}

	@test/rbtree.cc

1 
	#INTERVAL_TREE_DEBUG
 1

	)

2 
	#rbaccouÁ
(
x
è++
rbaccouÁ_
##
	)
x

3 
	grbaccouÁ_rÙ©iÚ
, 
	grbaccouÁ_æ
, 
	grbaccouÁ_š£¹
, 
	grbaccouÁ_”a£
;

4 
	~<io¡»am
>

5 
	~<ut™y
>

6 
	~<m­
>

7 
	~<veùÜ
>

8 
	~<¡ršg.h
>

9 
	~"RBT»e.hh
"

10 
	~<sys/time.h
>

11 
	~<sys/»sourû.h
>

13 
	$rbaccouÁ_»pÜt
() {

14 
®l
 = 
rbaccouÁ_š£¹
 + 
rbaccouÁ_”a£
;

15 
	`årštf
(
¡d”r
, "{\"insert\":%llu,\"erase\":%llu,\"rotation_per_operation\":%g,\"flip_per_operation\":%g}\n",

16 
rbaccouÁ_š£¹
, 
rbaccouÁ_”a£
, (è
rbaccouÁ_rÙ©iÚ
 / 
®l
, (è
rbaccouÁ_æ
 /‡ll);

17 
	}
}

19 
	#PAIR
(
k
,
v
è
¡d
::
·œ
<, >(k, v)

	)

20 
	gRBT»e
<, , 
	tŒue
> 
	tŒ“_ty³
;

21 
	gT¿n§ùiÚTid
::
ty³
 
lock
;

23 
	$»£t_Œ“
(
Œ“_ty³
& 
Œ“
) {

24 
Te¡T¿n§ùiÚ
 
	`t
(1);

25 
t
.
	`u£
();

27 
Œ“
[1] = 1;

28 
Œ“
[2] = 2;

29 
Œ“
[3] = 3;

30 
	`as£¹
(
t
.
	`Œy_comm™
());

31 
	}
}

33 
	$upd©e_cÚæiù_‹¡s
() {

35 
Œ“_ty³
 
Œ“
;

36 
Te¡T¿n§ùiÚ
 
	`t1
(1), 
	`t2
(2);

37 
t1
.
	`u£
();

38 
Œ“
[55] = 56;

39 
Œ“
[57] = 58;

40 
t2
.
	`u£
();

41 
x
 = 
Œ“
[58];

42 
	`as£¹
(
x
 == 0);

43 
	`as£¹
(
t2
.
	`Œy_comm™
());

44 
	`as£¹
(
t1
.
	`Œy_comm™
());

47 
Œ“_ty³
 
Œ“
;

48 
Te¡T¿n§ùiÚ
 
	`t1
(1), 
	`t2
(2);

49 
t1
.
	`u£
();

50 
Œ“
[10] = 10;

51 
t2
.
	`u£
();

52 
x
 = 
Œ“
[58];

53 
	`as£¹
(
x
 == 0);

54 
	`as£¹
(
t2
.
	`Œy_comm™
());

55 
t1
.
	`u£
();

56 
	`as£¹
(
t1
.
	`Œy_comm™
());

58 
	}
}

60 
	$”a£_cÚæiù_‹¡s
() {

63 
Œ“_ty³
 
Œ“
;

64 
	`»£t_Œ“
(
Œ“
);

65 
Te¡T¿n§ùiÚ
 
	`t1
(1), 
	`t2
(2), 
	`aá”
(3);

66 
t1
.
	`u£
();

67 
	`as£¹
(
Œ“
.
	`couÁ
(1) == 1);

68 
	`as£¹
(
Œ“
.
	`”a£
(1) == 1);

69 
t2
.
	`u£
();

70 
Œ“
[50] = 50;

71 
	`as£¹
(
Œ“
.
	`couÁ
(1) == 1);

72 
	`as£¹
(
t1
.
	`Œy_comm™
());

73 
	`as£¹
(!
t2
.
	`Œy_comm™
());

75 
aá”
.
	`u£
();

76 
	`as£¹
(
Œ“
.
	`couÁ
(1)==0);

77 
	`as£¹
(
aá”
.
	`Œy_comm™
());

81 
Œ“_ty³
 
Œ“
;

82 
	`»£t_Œ“
(
Œ“
);

83 
Te¡T¿n§ùiÚ
 
	`t1
(1), 
	`t2
(2), 
	`aá”
(3);

84 
t1
.
	`u£
();

85 
	`as£¹
(
Œ“
.
	`couÁ
(1) == 1);

86 
	`as£¹
(
Œ“
.
	`”a£
(1) == 1);

87 
t2
.
	`u£
();

88 
	`as£¹
(
Œ“
.
	`couÁ
(1) == 1);

89 
	`as£¹
(
t2
.
	`Œy_comm™
());

90 
	`as£¹
(
t1
.
	`Œy_comm™
());

91 
aá”
.
	`u£
();

92 
	`as£¹
(
Œ“
.
	`couÁ
(1)==0);

93 
	`as£¹
(
aá”
.
	`Œy_comm™
());

97 
Œ“_ty³
 
Œ“
;

98 
	`»£t_Œ“
(
Œ“
);

99 
Te¡T¿n§ùiÚ
 
	`t1
(1), 
	`t2
(2), 
	`aá”
(3);

100 
t1
.
	`u£
();

101 
	`as£¹
(
Œ“
.
	`couÁ
(1) == 1);

102 
	`as£¹
(
Œ“
.
	`”a£
(1) == 1);

103 
	`as£¹
(
Œ“
.
	`couÁ
(1) == 0);

104 
t2
.
	`u£
();

105 
	`as£¹
(
Œ“
.
	`”a£
(1) == 1);

106 
	`as£¹
(
t2
.
	`Œy_comm™
());

107 
	`as£¹
(!
t1
.
	`Œy_comm™
());

108 
aá”
.
	`u£
();

109 
	`as£¹
(
Œ“
.
	`couÁ
(1)==0);

110 
	`as£¹
(
aá”
.
	`Œy_comm™
());

114 
Œ“_ty³
 
Œ“
;

115 
	`»£t_Œ“
(
Œ“
);

116 
Te¡T¿n§ùiÚ
 
	`t1
(1), 
	`t2
(2), 
	`aá”
(3);

117 
t1
.
	`u£
();

118 
	`as£¹
(
Œ“
.
	`couÁ
(1) == 1);

119 
	`as£¹
(
Œ“
.
	`”a£
(1) == 1);

120 
	`as£¹
(
Œ“
.
	`couÁ
(1) == 0);

121 
t2
.
	`u£
();

122 
	`as£¹
(
Œ“
.
	`”a£
(1) == 1);

123 
	`as£¹
(
t1
.
	`Œy_comm™
());

124 
	`as£¹
(!
t2
.
	`Œy_comm™
());

125 
aá”
.
	`u£
();

126 
	`as£¹
(
Œ“
.
	`couÁ
(1)==0);

127 
	`as£¹
(
aá”
.
	`Œy_comm™
());

129 
	}
}

131 
	$š£¹_th’_d–‘e_‹¡s
() {

133 
Œ“_ty³
 
Œ“
;

134 
	`»£t_Œ“
(
Œ“
);

135 
Te¡T¿n§ùiÚ
 
	`t1
(1), 
	`aá”
(2);

136 
t1
.
	`u£
();

137 
Œ“
[5] = 5;

138 
Œ“
[4] = 4;

139 
	`as£¹
(
Œ“
.
	`couÁ
(4) == 1);

141 
	`as£¹
(
Œ“
.
	`”a£
(4) == 1);

142 
	`as£¹
(
Œ“
.
	`couÁ
(4) == 0);

143 
	`as£¹
(
Œ“
.
	`”a£
(4) == 0);

145 
Œ“
[4] = 44;

146 
	`as£¹
(
Œ“
[4] == 44);

147 
	`as£¹
(
Œ“
.
	`couÁ
(4) == 1);

148 
	`as£¹
(
t1
.
	`Œy_comm™
());

151 
aá”
.
	`u£
();

152 
	`as£¹
(
Œ“
.
	`couÁ
(4) == 1);

153 
	`as£¹
(
Œ“
[4] == 44);

154 
i
 = 1; i <= 5; ++i) {

155 ià(
i
 != 4)

156 
	`as£¹
(
Œ“
[
i
] == i);

158 
	`as£¹
(
aá”
.
	`Œy_comm™
());

161 
Œ“_ty³
 
Œ“
;

162 
	`»£t_Œ“
(
Œ“
);

163 
Te¡T¿n§ùiÚ
 
	`t1
(1), 
	`aá”
(2);

164 
t1
.
	`u£
();

167 
	`as£¹
(
Œ“
.
	`couÁ
(4) == 0);

169 
Œ“
[5] = 5;

171 
	`as£¹
(
Œ“
.
	`couÁ
(4) == 0);

172 
Œ“
[4] = 4;

173 
	`as£¹
(
Œ“
.
	`couÁ
(4) == 1);

174 
	`as£¹
(
t1
.
	`Œy_comm™
());

175 
aá”
.
	`u£
();

176 
i
 = 0; i <= 5; ++i)

177 
	`as£¹
(
Œ“
[
i
] == i);

178 
	`as£¹
(
aá”
.
	`Œy_comm™
());

181 
Œ“_ty³
 
Œ“
;

182 
	`»£t_Œ“
(
Œ“
);

183 
Te¡T¿n§ùiÚ
 
	`t1
(1), 
	`t2
(2), 
	`t3
(3), 
	`aá”
(4);

184 
t1
.
	`u£
();

186 
Œ“
[3] = 13;

188 
t2
.
	`u£
();

190 
	`as£¹
(
Œ“
.
	`”a£
(3) == 1);

192 
	`as£¹
(
t2
.
	`Œy_comm™
());

194 
t3
.
	`u£
();

197 
	`as£¹
(
Œ“
.
	`couÁ
(3) == 0);

198 
Œ“
[3] = 33;

200 
	`as£¹
(
t3
.
	`Œy_comm™
());

202 
t1
.
	`u£
();

204 
	`as£¹
(!
t1
.
	`Œy_comm™
());

206 
aá”
.
	`u£
();

207 
	`as£¹
(
Œ“
[3] == 33);

208 
	`as£¹
(
aá”
.
	`Œy_comm™
());

210 
	}
}

212 
	$mem_‹¡s
() {

214 
Œ“_ty³
 
Œ“
;

215 
	`»£t_Œ“
(
Œ“
);

216 
Te¡T¿n§ùiÚ
 
	`t1
(1), 
	`t2
(2), 
	`aá”
(3);

218 
t1
.
	`u£
();

220 
Œ“
[50] = 50;

222 
	`as£¹
(
Œ“
.
	`couÁ
(4) == 0);

223 
t2
.
	`u£
();

224 
Œ“
[5] = 5;

225 
	`as£¹
(
t2
.
	`Œy_comm™
());

226 
t1
.
	`u£
();

228 
	`as£¹
(!
t1
.
	`Œy_comm™
());

230 
aá”
.
	`u£
();

231 
	`as£¹
(
Œ“
.
	`couÁ
(4) == 0);

232 
	`as£¹
(
Œ“
[5] == 5);

233 
	`as£¹
(
aá”
.
	`Œy_comm™
());

236 
Œ“_ty³
 
Œ“
;

237 
	`»£t_Œ“
(
Œ“
);

238 
Te¡T¿n§ùiÚ
 
	`t1
(1);

240 
t1
.
	`u£
();

241 
Œ“
.
	`”a£
(1);

242 
Œ“
.
	`”a£
(2);

243 
Œ“
.
	`”a£
(3);

244 
	`as£¹
(
t1
.
	`Œy_comm™
());

246 
	}
}

248 
	$maš
() {

249 
TTh»ad
::
txn
 = 
nuÎ±r
;

250 
TTh»ad
::
	`£t_id
(0);

253 
Œ“_ty³
 
Œ“
;

254 
Te¡T¿n§ùiÚ
 
	`t
(1);

256 
	`as£¹
(
Œ“
.
	`size
() == 0);

257 
i
 = 0; i < 100; ++i) {

258 
Œ“
[
i
] = i;

259 
	`as£¹
(
Œ“
[
i
]==i);

260 
Œ“
[
i
] = 100-i;

261 
	`as£¹
(
Œ“
[
i
]==100-i);

263 
	`as£¹
(
Œ“
.
	`size
() == 100);

273 
i
 = 0; i < 100; ++i) {

274 
	`as£¹
(
Œ“
.
	`couÁ
(
i
) == 1);

276 
	`as£¹
(
Œ“
.
	`size
() == 100);

278 
i
 = 0; i < 100; ++i) {

279 
	`as£¹
(
Œ“
.
	`”a£
(
i
) == 1);

280 
	`as£¹
(
Œ“
.
	`couÁ
(
i
) == 0);

282 
	`as£¹
(
Œ“
.
	`size
() == 0);

284 
i
 = 0; i < 100; ++i) {

285 
	`as£¹
(
Œ“
.
	`”a£
(
i
) == 0);

286 
	`as£¹
(
Œ“
.
	`couÁ
(
i
) == 0);

288 
	`as£¹
(
Œ“
.
	`size
() == 0);

290 
i
 = 0; i < 100; ++i) {

291 
Œ“
[
i
] = 1;

292 
	`as£¹
(
Œ“
.
	`couÁ
(
i
) == 1);

294 
	`as£¹
(
Œ“
.
	`size
() == 100);

296 
x
 = 
Œ“
[102];

297 
	`as£¹
(
x
==0);

298 
	`as£¹
(
Œ“
.
	`couÁ
(102)==1);

299 
	`as£¹
(
Œ“
.
	`size
() == 101);

300 
	`as£¹
(
t
.
	`Œy_comm™
());

302 
	`”a£_cÚæiù_‹¡s
();

303 
	`upd©e_cÚæiù_‹¡s
();

304 
	`š£¹_th’_d–‘e_‹¡s
();

305 
	`mem_‹¡s
();

307 
¡d
::
cout
 << "ALL TESTS PASS!!" << std:: 
’dl
;

309 
	}
}

	@test/single.cc

1 
	~<io¡»am
>

2 
	~<as£¹.h
>

3 
	~<¡dio.h
>

5 
	~"HashbË.hh
"

6 
	~"MassT¿ns.hh
"

7 
	~"Li¡.hh
"

8 
	~"Queue.hh
"

9 
	~"T¿n§ùiÚ.hh
"

10 
	~"IÁSŒ.hh
"

12 
	#N
 100

	)

14 vŞ©
mrcu_•och_ty³
 
	gaùive_•och
 = 1;

16 
usšg
 
Çme¥aû
 
	g¡d
;

18 
	g‹m¶©e
 <
ty³Çme
 
	gT
> cÏs 
	cIÁMassT¿ns
 {

19 
	mMassT¿ns
<
	mT
> 
	mm_
;

20 
	mpublic
:

21 
boŞ
 
	$ŒªsG‘
(
k
, 
T
& 
v
) {

22  
m_
.
	`ŒªsG‘
(
	`IÁSŒ
(
k
).
	`¡r
(), 
v
);

24 
boŞ
 
	$ŒªsPut
(
k
, 
T
 
v
) {

25  
m_
.
	`ŒªsPut
(
	`IÁSŒ
(
k
).
	`¡r
(), 
v
);

26 
	}
}

27 
boŞ
 
	$ŒªsUpd©e
(
k
, 
T
 
v
) {

28  
m_
.
	`ŒªsUpd©e
(
	`IÁSŒ
(
k
).
	`¡r
(), 
v
);

29 
	}
}

30 
boŞ
 
	$ŒªsIn£¹
(
k
, 
T
 
v
) {

31  
m_
.
	`ŒªsIn£¹
(
	`IÁSŒ
(
k
).
	`¡r
(), 
v
);

32 
	}
}

33 
boŞ
 
	$ŒªsD–‘e
(
k
) {

34  
m_
.
	`ŒªsD–‘e
(
	`IÁSŒ
(
k
).
	`¡r
());

35 
	}
}

36 
	$th»ad_š™
() {

37 
m_
.
	`th»ad_š™
();

38 
	}
}

41 
	$queueTe¡s
() {

42 
Queue
<> 
q
;

43 
p
;

48 
T¿n§ùiÚGu¬d
 
t
;

50 
q
.
	`ŒªsPush
(1);

51 
q
.
	`ŒªsPush
(2);

52 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
è&&… =ğ1);‡s£¹(q.
	`ŒªsPİ
());‡ssert(q.transFront(p) &&… == 2);

53 
	`as£¹
(
q
.
	`ŒªsPİ
());

57 
T¿n§ùiÚGu¬d
 
t
;

59 
q
.
	`ŒªsPush
(1);

60 
q
.
	`ŒªsPush
(2);

65 
T¿n§ùiÚGu¬d
 
t
;

66 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

67 
	`as£¹
(
p
 == 1);

68 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

69 
	`as£¹
(
p
 == 1);

74 
T¿n§ùiÚGu¬d
 
t
;

75 
	`as£¹
(
q
.
	`ŒªsPİ
());

76 
	`as£¹
(
q
.
	`ŒªsPİ
());

77 
	`as£¹
 (!
q
.
	`ŒªsPİ
());

80 
q
.
	`ŒªsPush
(1);

81 
q
.
	`ŒªsPush
(2);

82 
q
.
	`ŒªsPush
(3);

87 
T¿n§ùiÚGu¬d
 
t
;

88 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

89 
	`as£¹
(
p
 == 1);

90 
	`as£¹
(
q
.
	`ŒªsPİ
());

91 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

92 
	`as£¹
(
p
 == 2);

93 
	`as£¹
(
q
.
	`ŒªsPİ
());

94 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

95 
	`as£¹
(
p
 == 3);

96 
	`as£¹
(
q
.
	`ŒªsPİ
());

97 
	`as£¹
(!
q
.
	`ŒªsPİ
());

100 
q
.
	`ŒªsPush
(1);

101 
q
.
	`ŒªsPush
(2);

102 
q
.
	`ŒªsPush
(3);

107 
T¿n§ùiÚGu¬d
 
t
;

108 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

109 
	`as£¹
(
p
 == 1);

110 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

111 
	`as£¹
(
p
 == 1);

112 
q
.
	`ŒªsPush
(4);

113 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

114 
	`as£¹
(
p
 == 1);

120 
T¿n§ùiÚGu¬d
 
t
;

121 
	`as£¹
(
q
.
	`ŒªsPİ
());

122 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

123 
	`as£¹
(
p
 == 2);

124 
q
.
	`ŒªsPush
(5);

126 
	`as£¹
(
q
.
	`ŒªsPİ
());

127 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

128 
	`as£¹
(
p
 == 3);

129 
q
.
	`ŒªsPush
(6);

136 
T¿n§ùiÚGu¬d
 
t
;

138 
	`as£¹
(
q
.
	`ŒªsPİ
());

139 
	`as£¹
(
q
.
	`ŒªsPİ
());

140 
	`as£¹
(
q
.
	`ŒªsPİ
());

141 
	`as£¹
(
q
.
	`ŒªsPİ
());

142 
	`as£¹
(!
q
.
	`ŒªsPİ
());

144 
	`as£¹
(!
q
.
	`ŒªsFrÚt
(
p
));

146 
q
.
	`ŒªsPush
(1);

147 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

148 
	`as£¹
(
p
 == 1);

149 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

150 
	`as£¹
(
p
 == 1);

155 
T¿n§ùiÚGu¬d
 
t
;

157 
	`as£¹
(
q
.
	`ŒªsPİ
());

158 
	`as£¹
(!
q
.
	`ŒªsPİ
());

160 
	`as£¹
(!
q
.
	`ŒªsFrÚt
(
p
));

162 
q
.
	`ŒªsPush
(1);

163 
	`as£¹
(
q
.
	`ŒªsPİ
());

164 
	`as£¹
(!
q
.
	`ŒªsPİ
());

169 
T¿n§ùiÚGu¬d
 
t
;

170 
	`as£¹
(!
q
.
	`ŒªsFrÚt
(
p
));

172 
q
.
	`ŒªsPush
(1);

173 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

174 
	`as£¹
(
p
 == 1);

175 
	`as£¹
(
q
.
	`ŒªsPİ
());

177 
q
.
	`ŒªsPush
(1);

178 
	`as£¹
(
q
.
	`ŒªsPİ
());

179 
	`as£¹
(!
q
.
	`ŒªsFrÚt
(
p
));

180 
	`as£¹
(!
q
.
	`ŒªsPİ
());

183 
q
.
	`ŒªsPush
(1);

184 
q
.
	`ŒªsPush
(2);

190 
Te¡T¿n§ùiÚ
 
	`t1
(1);

192 
	`as£¹
(
q
.
	`ŒªsPİ
());

193 
Te¡T¿n§ùiÚ
 
	`t2
(2);

194 
	`as£¹
(
q
.
	`ŒªsPİ
());

195 
	`as£¹
(
t1
.
	`Œy_comm™
());

196 
	`as£¹
(!
t2
.
	`Œy_comm™
());

201 
Te¡T¿n§ùiÚ
 
	`t1
(1);

203 
	`as£¹
(
q
.
	`ŒªsPİ
());

204 
Te¡T¿n§ùiÚ
 
	`t2
(2);

205 
q
.
	`ŒªsPush
(3);

206 
	`as£¹
(
t1
.
	`Œy_comm™
());

207 
	`as£¹
(
t2
.
	`Œy_comm™
());

212 
T¿n§ùiÚGu¬d
 
t1
;

213 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
) &&… == 3);

214 
	`as£¹
(
q
.
	`ŒªsPİ
());

215 
	`as£¹
(!
q
.
	`ŒªsPİ
());

220 
Te¡T¿n§ùiÚ
 
	`t1
(1);

222 
	`as£¹
(!
q
.
	`ŒªsPİ
());

223 
q
.
	`ŒªsPush
(1);

224 
q
.
	`ŒªsPush
(2);

225 
Te¡T¿n§ùiÚ
 
	`t2
(2);

226 
q
.
	`ŒªsPush
(3);

227 
q
.
	`ŒªsPush
(4);

228 
q
.
	`ŒªsPush
(5);

231 
	`as£¹
(
q
.
	`ŒªsPİ
());

233 
	`as£¹
(
t1
.
	`Œy_comm™
());

234 
	`as£¹
(!
t2
.
	`Œy_comm™
());

239 
Te¡T¿n§ùiÚ
 
	`t1
(1);

241 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
) &&… == 1);

242 
q
.
	`ŒªsPush
(4);

245 
	`as£¹
(
q
.
	`ŒªsPİ
());

246 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

247 
	`as£¹
(
p
 == 2);

249 
Te¡T¿n§ùiÚ
 
	`t2
(2);

250 
q
.
	`ŒªsPush
(3);

252 
	`as£¹
(
t2
.
	`Œy_comm™
());

253 
	`as£¹
(
t1
.
	`Œy_comm™
());

256 
Te¡T¿n§ùiÚ
 
	`t
(3);

257 
	`as£¹
(
q
.
	`ŒªsPİ
());

258 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

259 
	`as£¹
(
p
 == 3);

260 
	`as£¹
(
q
.
	`ŒªsPİ
());

261 
	`as£¹
(
q
.
	`ŒªsFrÚt
(
p
));

262 
	`as£¹
(
p
 == 4);

263 
	`as£¹
(
q
.
	`ŒªsPİ
());

264 
	`as£¹
(!
q
.
	`ŒªsPİ
());

265 
	`as£¹
(
t
.
	`Œy_comm™
());

267 
	}
}

269 
	$lškedLi¡Te¡s
() {

270 
Li¡
<> 
l
;

273 
T¿n§ùiÚGu¬d
 
t
;

274 
	`as£¹
(!
l
.
	`ŒªsFšd
(5));

275 
	`as£¹
(
l
.
	`ŒªsIn£¹
(5));

276 *
p
 = 
l
.
	`ŒªsFšd
(5);

277 
	`as£¹
(*
p
 == 5);

281 
T¿n§ùiÚGu¬d
 
t
;

282 
	`as£¹
(!
l
.
	`ŒªsIn£¹
(5));

283 
	`as£¹
(*
l
.
	`ŒªsFšd
(5) == 5);

284 
	`as£¹
(!
l
.
	`ŒªsFšd
(7));

285 
	`as£¹
(
l
.
	`ŒªsIn£¹
(7));

289 
T¿n§ùiÚGu¬d
 
t
;

290 
	`as£¹
(
l
.
	`size
() == 2);

291 
	`as£¹
(
l
.
	`ŒªsIn£¹
(10));

292 
	`as£¹
(
l
.
	`size
() == 3);

293 autØ
™
 = 
l
.
	`ŒªsI‹r
();

294 
i
 = 0;

295 
–ems
[] = {5,7,10};

296 
™
.
	`ŒªsHasNext
()) {

297 
	`as£¹
(*
™
.
	`ŒªsNext
(è=ğ
–ems
[
i
++]);

303 
T¿n§ùiÚGu¬d
 
t
;

304 
	`as£¹
(
l
.
	`ŒªsD–‘e
(7));

305 
	`as£¹
(!
l
.
	`ŒªsD–‘e
(1000));

306 
	`as£¹
(
l
.
	`size
() == 2);

307 
	`as£¹
(!
l
.
	`ŒªsFšd
(7));

308 autØ
™
 = 
l
.
	`ŒªsI‹r
();

309 
	`as£¹
(*
™
.
	`ŒªsNext
() == 5);

310 
	`as£¹
(*
™
.
	`ŒªsNext
() == 10);

314 
T¿n§ùiÚGu¬d
 
t
;

315 
	`as£¹
(
l
.
	`ŒªsIn£¹
(7));

316 
	`as£¹
(
l
.
	`ŒªsD–‘e
(7));

317 
	`as£¹
(
l
.
	`size
() == 2);

318 
	`as£¹
(!
l
.
	`ŒªsFšd
(7));

320 
	}
}

322 
	$¡ršgKeyTe¡s
() {

324 
HashbË
<
¡d
::
¡ršg
, std::¡ršg> 
h
;

325 
¡d
::
¡ršg
 
s
;

328 
T¿n§ùiÚGu¬d
 
t
;

330 
¡d
::
¡ršg
 
	`s1
("bar");

331 
	`as£¹
(
h
.
	`ŒªsIn£¹
("foo", 
s1
));

333 
	`as£¹
(
h
.
	`ŒªsG‘
("foo", 
s
));

334 
	`as£¹
(
s
 == "bar");

338 
T¿n§ùiÚGu¬d
 
t2
;

339 
	`as£¹
(
h
.
	`ŒªsG‘
("foo", 
s
));

340 
	`as£¹
(
s
 == "bar");

343 
	}
}

345 
	$š£¹D–‘eTe¡
(
boŞ
 
shouldAbÜt
) {

346 
MassT¿ns
<> 
h
;

348 
T¿n§ùiÚGu¬d
 
t
;

349 
i
 = 10; i < 25; ++i) {

350 
	`as£¹
(
h
.
	`ŒªsIn£¹
(
	`IÁSŒ
(
i
).
	`¡r
(), i+1));

354 
Te¡T¿n§ùiÚ
 
	`t2
(1);

355 
	`as£¹
(
h
.
	`ŒªsIn£¹
(
	`IÁSŒ
(25).
	`¡r
(), 26));

356 
x
;

357 
	`as£¹
(
h
.
	`ŒªsG‘
(
	`IÁSŒ
(25).
	`¡r
(), 
x
));

358 
	`as£¹
(!
h
.
	`ŒªsG‘
(
	`IÁSŒ
(26).
	`¡r
(), 
x
));

360 
	`as£¹
(
h
.
	`ŒªsD–‘e
(
	`IÁSŒ
(25).
	`¡r
()));

362 ià(
shouldAbÜt
) {

363 
Te¡T¿n§ùiÚ
 
	`t3
(2);

364 
	`as£¹
(
h
.
	`ŒªsIn£¹
(
	`IÁSŒ
(26).
	`¡r
(), 27));

365 
	`as£¹
(
t3
.
	`Œy_comm™
());

366 
	`as£¹
(!
t2
.
	`Œy_comm™
());

368 
	`as£¹
(
t2
.
	`Œy_comm™
());

369 
	}
}

371 
	$š£¹D–‘eS•¬©eTe¡
() {

372 
MassT¿ns
<> 
h
;

374 
T¿n§ùiÚGu¬d
 
t_š™
;

375 
i
 = 10; i < 12; ++i) {

376 
	`as£¹
(
h
.
	`ŒªsIn£¹
(
	`IÁSŒ
(
i
).
	`¡r
(), i+1));

380 
Te¡T¿n§ùiÚ
 
	`t
(1);

381 
x
;

382 
	`as£¹
(!
h
.
	`ŒªsG‘
(
	`IÁSŒ
(12).
	`¡r
(), 
x
));

384 
h
.
	`ŒªsPut
(
	`IÁSŒ
(1000).
	`¡r
(), 0);

386 
Te¡T¿n§ùiÚ
 
	`t2
(2);

387 
	`as£¹
(
h
.
	`ŒªsIn£¹
(
	`IÁSŒ
(12).
	`¡r
(), 13));

388 
	`as£¹
(
h
.
	`ŒªsD–‘e
(
	`IÁSŒ
(10).
	`¡r
()));

389 
	`as£¹
(
t2
.
	`Œy_comm™
());

390 
	`as£¹
(!
t
.
	`Œy_comm™
());

393 
Te¡T¿n§ùiÚ
 
	`t3
(3);

394 
	`as£¹
(!
h
.
	`ŒªsG‘
(
	`IÁSŒ
(13).
	`¡r
(), 
x
));

396 
h
.
	`ŒªsPut
(
	`IÁSŒ
(1000).
	`¡r
(), 0);

398 
Te¡T¿n§ùiÚ
 
	`t4
(4);

399 
	`as£¹
(
h
.
	`ŒªsIn£¹
(
	`IÁSŒ
(10).
	`¡r
(), 11));

400 
	`as£¹
(
h
.
	`ŒªsIn£¹
(
	`IÁSŒ
(13).
	`¡r
(), 14));

401 
	`as£¹
(
h
.
	`ŒªsD–‘e
(
	`IÁSŒ
(11).
	`¡r
()));

402 
	`as£¹
(
h
.
	`ŒªsD–‘e
(
	`IÁSŒ
(12).
	`¡r
()));

403 
	`as£¹
(
t4
.
	`Œy_comm™
());

404 
	`as£¹
(!
t3
.
	`Œy_comm™
());

405 
	}
}

407 
	$¿ngeQu”yTe¡
() {

408 
MassT¿ns
<> 
h
;

409 
n
 = 99;

410 
ns
[64];

413 
T¿n§ùiÚGu¬d
 
t_š™
;

414 
	`¥rštf
(
ns
, "%d", 
n
);

415 
i
 = 10; i <ğ
n
; ++i) {

416 
	`as£¹
(
h
.
	`ŒªsIn£¹
(
	`IÁSŒ
(
i
).
	`¡r
(), i+1));

421 
T¿n§ùiÚGu¬d
 
t
;

422 
x
 = 0;

423 
h
.
	`ŒªsQu”y
("10", 
Mas¡»e
::
	`SŒ
(), [&] (Mas¡»e::
SŒ
 , è{ 
x
++;  
Œue
; });

424 
	`as£¹
(
x
 =ğ
n
-10+1);

426 
x
 = 0;

427 
h
.
	`ŒªsQu”y
("10", 
ns
, [&] (
Mas¡»e
::
SŒ
 , è{ 
x
++;  
Œue
; });

428 
	`as£¹
(
x
 =ğ
n
-10);

430 
x
 = 0;

431 
h
.
	`ŒªsRQu”y
(
ns
, 
Mas¡»e
::
	`SŒ
(), [&] (Mas¡»e::
SŒ
 , è{ 
x
++;  
Œue
; });

432 
	`as£¹
(
x
 =ğ
n
-10+1);

434 
x
 = 0;

435 
h
.
	`ŒªsRQu”y
(
ns
, "90", [&] (
Mas¡»e
::
SŒ
 , è{ 
x
++;  
Œue
; });

436 
	`as£¹
(
x
 =ğ
n
-90);

438 
x
 = 0;

439 
h
.
	`ŒªsQu”y
("10", "25", [&] (
Mas¡»e
::
SŒ
 , è{ 
x
++;  
Œue
; });

440 
	`as£¹
(
x
 == 25-10);

442 
x
 = 0;

443 
h
.
	`ŒªsQu”y
("10", "26", [&] (
Mas¡»e
::
SŒ
 , è{ 
x
++;  
Œue
; });

444 
	`as£¹
(
x
 == 26-10);

446 
	}
}

448 
	g‹m¶©e
 <
ty³Çme
 
	gK
,y³Çm
	gV
>

449 
basicQu”yTe¡s
(
MassT¿ns
<
K
, 
V
>& 
h
) {

450 
T¿n§ùiÚGu¬d
 
	gt19
;

451 
	gh
.
ŒªsQu”y
("0", "2", [] (
Mas¡»e
::
SŒ
 
s
, 
v®
è{ 
´štf
("%s, %d\n", s.
d©a
(), v®);  
Œue
; });

452 
	gh
.
ŒªsQu”y
("4", "4", [] (
Mas¡»e
::
SŒ
 
s
, 
v®
è{ 
´štf
("%s, %d\n", s.
d©a
(), v®);  
Œue
; });

455 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

456 
	$basicQu”yTe¡s
(
T
&è{
	}
}

458 
	g‹m¶©e
 <
ty³Çme
 
	gM­Ty³
>

459 
	$basicM­Te¡s
(
M­Ty³
& 
h
) {

460 
	tV®ue
;

461 
V®ue
 
v1
,
v2
,
vunu£d
;

464 
T¿n§ùiÚGu¬d
 
t
;

466 
	`as£¹
(
h
.
	`ŒªsIn£¹
(0, 1));

467 
h
.
	`ŒªsPut
(1, 3);

471 
T¿n§ùiÚGu¬d
 
tm
;

472 
	`as£¹
(
h
.
	`ŒªsUpd©e
(1, 2));

476 
T¿n§ùiÚGu¬d
 
t2
;

477 
	`as£¹
(
h
.
	`ŒªsG‘
(1, 
v1
));

481 
T¿n§ùiÚGu¬d
 
t3
;

482 
h
.
	`ŒªsPut
(0, 4);

485 
T¿n§ùiÚGu¬d
 
t4
;

486 
	`as£¹
(
h
.
	`ŒªsG‘
(0, 
v2
));

490 
T¿n§ùiÚGu¬d
 
t5
;

491 
	`as£¹
(!
h
.
	`ŒªsIn£¹
(0, 5));

495 
T¿n§ùiÚGu¬d
 
t6
;

496 
	`as£¹
(!
h
.
	`ŒªsUpd©e
(2, 1));

499 
Te¡T¿n§ùiÚ
 
	`t7
(1);

500 
	`as£¹
(!
h
.
	`ŒªsG‘
(2, 
vunu£d
));

502 
h
.
	`ŒªsPut
(1000, 0);

503 
Te¡T¿n§ùiÚ
 
	`t8
(2);

504 
	`as£¹
(
h
.
	`ŒªsIn£¹
(2, 2));

505 
	`as£¹
(
t8
.
	`Œy_comm™
());

507 
	`as£¹
(!
t7
.
	`Œy_comm™
());

509 
Te¡T¿n§ùiÚ
 
	`t9
(3);

510 
	`as£¹
(
h
.
	`ŒªsIn£¹
(3, 0));

511 
Te¡T¿n§ùiÚ
 
	`t10
(4);

512 
	`as£¹
(
h
.
	`ŒªsIn£¹
(4, 4));

513 
Œy
{

515 
h
.
	`ŒªsUpd©e
(3, 
vunu£d
);

516 
	`as£¹
(0);

517 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
E
) {}

518 
Te¡T¿n§ùiÚ
 
	`t10_2
(5);

519 
Œy
 {

521 
h
.
	`ŒªsD–‘e
(3);

522 
	`as£¹
(0);

523 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
E
) {}

524 
	`as£¹
(
t9
.
	`Œy_comm™
());

525 
	`as£¹
(!
t10
.
	`Œy_comm™
(è&& !
t10_2
.try_commit());

528 
T¿n§ùiÚGu¬d
 
t11
;

529 
	`as£¹
(
h
.
	`ŒªsIn£¹
(4, 5));

534 
T¿n§ùiÚGu¬d
 
t12
;

535 
	`as£¹
(!
h
.
	`ŒªsD–‘e
(5));

536 
	`as£¹
(
h
.
	`ŒªsUpd©e
(4, 0));

537 
	`as£¹
(
h
.
	`ŒªsD–‘e
(4));

538 
	`as£¹
(!
h
.
	`ŒªsG‘
(4, 
vunu£d
));

539 
	`as£¹
(!
h
.
	`ŒªsUpd©e
(4, 0));

540 
	`as£¹
(!
h
.
	`ŒªsD–‘e
(4));

545 
T¿n§ùiÚGu¬d
 
t13
;

546 
	`as£¹
(
h
.
	`ŒªsG‘
(3, 
vunu£d
));

547 
	`as£¹
(
h
.
	`ŒªsD–‘e
(3));

548 
	`as£¹
(
h
.
	`ŒªsIn£¹
(3, 1));

549 
	`as£¹
(
h
.
	`ŒªsG‘
(3, 
vunu£d
));

554 
T¿n§ùiÚGu¬d
 
t14
;

555 
	`as£¹
(!
h
.
	`ŒªsG‘
(4, 
vunu£d
));

556 
	`as£¹
(
h
.
	`ŒªsIn£¹
(4, 14));

557 
	`as£¹
(
h
.
	`ŒªsG‘
(4, 
vunu£d
));

558 
	`as£¹
(
h
.
	`ŒªsD–‘e
(4));

559 
	`as£¹
(!
h
.
	`ŒªsG‘
(4, 
vunu£d
));

563 
Te¡T¿n§ùiÚ
 
	`t15
(1);

564 
	`as£¹
(
h
.
	`ŒªsUpd©e
(3, 15));

565 
Te¡T¿n§ùiÚ
 
	`t16
(2);

566 
	`as£¹
(
h
.
	`ŒªsUpd©e
(3, 16));

567 
	`as£¹
(
t16
.
	`Œy_comm™
());

569 
	`as£¹
(!
t15
.
	`Œy_comm™
());

573 
Te¡T¿n§ùiÚ
 
	`t17
(1);

574 
	`as£¹
(
h
.
	`ŒªsUpd©e
(3, 17));

575 
Te¡T¿n§ùiÚ
 
	`t18
(2);

576 
	`as£¹
(
h
.
	`ŒªsD–‘e
(3));

577 
	`as£¹
(
t18
.
	`Œy_comm™
());

578 
	`as£¹
(!
t17
.
	`Œy_comm™
());

580 
	`basicQu”yTe¡s
(
h
);

581 
	}
}

583 
	$maš
() {

586 
HashbË
<, > 
h
;

587 
	`basicM­Te¡s
(
h
);

588 
IÁMassT¿ns
<> 
m
;

589 
m
.
	`th»ad_š™
();

590 
	`basicM­Te¡s
(
m
);

593 
	`š£¹D–‘eTe¡
(
çl£
);

594 
	`š£¹D–‘eTe¡
(
Œue
);

597 
	`š£¹D–‘eS•¬©eTe¡
();

599 
	`¿ngeQu”yTe¡
();

602 
	`¡ršgKeyTe¡s
();

604 
	`lškedLi¡Te¡s
();

606 
	`queueTe¡s
();

607 
	}
}

	@test/singleelems.cc

1 
	~"T¿n§ùiÚ.hh
"

2 
	~"SšgËEËm.hh
"

3 
	~"TG’”ic.hh
"

4 
	~<¡ršg
>

5 
	~<as£¹.h
>

7 
	$bigObjTe¡s
() {

8 
	sfoo
 {

9 
a
;

10 
b
;

11 
c
;

13 
SšgËEËm
<
foo
> 
f
;

14 
	`´štf
("big obj size: %lu\n", (
f
));

17 
T¿n§ùiÚGu¬d
 
t
;

18 
f
 = 
foo
{1, 2, 3.4};

22 
T¿n§ùiÚGu¬d
 
t2
;

23 
foo
 
f_»ad
 = 
f
;

24 
	`as£¹
(
f_»ad
.
a
 == 1);

25 
	`as£¹
(
f_»ad
.
b
 == 2);

26 
	`as£¹
(
f_»ad
.
c
 - 3.4 < .001);

28 
	}
}

30 
	$nÚŒivŸlObjTe¡s
() {

31 
SšgËEËm
<
¡d
::
¡ršg
> 
f
;

32 
	`´štf
("¡d sŒšg size: %lu\n", (
f
));

35 
T¿n§ùiÚGu¬d
 
t
;

36 
f
 = "foobarbaz";

40 
T¿n§ùiÚGu¬d
 
t2
;

41 
¡d
::
¡ršg
 
s
 = 
f
;

42 
	`as£¹
(
s
 =ğ
¡d
::
	`¡ršg
("foobarbaz"));

44 
	}
}

46 
	gy
 = 1.1;

47 
	$g’”icSTMTe¡s
() {

48 
TG’”ic
 
¡m
;

49 
x
 = 4;

50 
ušt64_t
 *
z
 = (ušt64_t*)
	`m®loc
((*z));

51 *
z
 = 0xffffffffffULL;

52 {
T¿n§ùiÚGu¬d
 
t
;

53 
	`as£¹
(
¡m
.
	`»ad
(&
x
) == 4);

54 
¡m
.
	`wr™e
(&
x
, 5);

55 
	`as£¹
(
¡m
.
	`»ad
(&
x
) == 5);

57 
	`as£¹
(
¡m
.
	`»ad
(&
y
) - 1.1 < 0.01);

59 
	`as£¹
(
¡m
.
	`»ad
(
z
è=ğ(
ušt64_t
)0xffffffffffULL);

60 
¡m
.
	`wr™e
(
z
, (
ušt64_t
)0x7777777777ULL);

61 
	`as£¹
(
¡m
.
	`»ad
(
z
è=ğ(
ušt64_t
)0x7777777777ULL);

64 
	`as£¹
(
x
 == 5);

66 {
T¿n§ùiÚGu¬d
 
t
;

67 
	`as£¹
(
¡m
.
	`»ad
(&
x
) == 5);

68 
	`as£¹
(
¡m
.
	`»ad
(&
y
) - 1.1 < 0.01);

69 
	`as£¹
(
¡m
.
	`»ad
(
z
è=ğ(
ušt64_t
)0x7777777777ULL);

71 
	}
}

73 
	$šüem’tTe¡
() {

74 
SšgËEËm
<> 
f
;

76 
TRANSACTION
 {

77 
f
 = 1;

78 } 
	`RETRY
(
çl£
);

80 
TRANSACTION
 {

81 
f
 = f + 1;

82 } 
	`RETRY
(
çl£
);

84 
v
;

85 
TRANSACTION
 {

86 
v
 = 
f
;

87 } 
	`RETRY
(
çl£
);

89 
	`as£¹
(
v
 == 2);

90 
	}
}

92 
	$maš
() {

93 
SšgËEËm
<> 
f
;

94 
	`´štf
("size: %lu\n", (
f
));

97 
T¿n§ùiÚGu¬d
 
t
;

98 
f
 = 1;

99 
	`as£¹
(
f
 == 1);

103 
T¿n§ùiÚGu¬d
 
t2
;

104 
	`as£¹
(
f
 == 1);

107 
	`bigObjTe¡s
();

108 
	`nÚŒivŸlObjTe¡s
();

110 
	`g’”icSTMTe¡s
();

112 
	`šüem’tTe¡
();

115 
	}
}

	@test/trans_test.cc

1 
	~<¡ršg
>

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

4 
	~<veùÜ
>

5 
	~<¿ndom
>

6 
	~<m­
>

7 
	~"T¿n§ùiÚ.hh
"

8 
	~"Te¡”s.hh
"

10 
	#GLOBAL_SEED
 10

	)

11 
	#NTRANS
 200

12 
	#N_THREADS
 3

13 
	#MAX_OPS
 3

14 

	)

15 
	#PRIORITY_QUEUE
 0

	)

16 
	#HASHTABLE
 1

	)

17 
	#RBTREE
 2

	)

18 
	#VECTOR
 3

	)

19 
	#DS
 
RBTREE


	)

21 #ià
DS
 =ğ
PRIORITY_QUEUE


22 
	gPqueueTe¡”
<
	gPriÜ™yQueue
<>> 
	g‹¡”
 = 
PqueueTe¡”
<
PriÜ™yQueue
<>>();

23 #–ià
DS
 =ğ
HASHTABLE


24 
	gHashbËTe¡”
<
	gHashbË
<, , 
	gçl£
, 1000000>> 
	g‹¡”
 = 
HashbËTe¡”
<
HashbË
<, , false, 1000000>>();

25 #–ià
DS
 =ğ
RBTREE


26 
	gRBT»eTe¡”
<
	gRBT»e
<, , 
	gŒue
>, 
	g¡d
::
m­
<, >> 
	g‹¡”
 = 
RBT»eTe¡”
<
RBT»e
<, ,rue>, std::map<, >>();

27 #–ià
DS
 =ğ
VECTOR


28 
	gVeùÜTe¡”
<
	gVeùÜ
<>> 
	g‹¡”
 = 
VeùÜTe¡”
<
VeùÜ
<>>();

31 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

32 
	$run
(
T
* 
q
, 
me
) {

33 
TTh»ad
::
	`£t_id
(
me
);

35 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`¦Ùdi¡
(0, 
MAX_VALUE
);

36 
i
 = 0; i < 
NTRANS
; ++i) {

38 autØ
Œªs£ed
 = 
i
;

39 
txn_»cÜd
 *
Œ
 = 
Ãw
xn_record;

41 
Sto
::
	`¡¬t_Œª§ùiÚ
();

42 
Œy
 {

43 
Œ
->
İs
.
	`ş—r
();

45 
ušt32_t
 
£ed
 = 
Œªs£ed
*3 + (ušt32_t)
me
*
NTRANS
*7 + (ušt32_t)
GLOBAL_SEED
*
MAX_THREADS
*NTRANS*11;

46 autØ
£edlow
 = 
£ed
 & 0xffff;

47 autØ
£edhigh
 = 
£ed
 >> 16;

48 
Rªd
 
	`Œªsg’
(
£ed
, 
£edlow
 << 16 | 
£edhigh
);

50 
numOps
 = 
	`¦Ùdi¡
(
Œªsg’
è% 
MAX_OPS
 + 1;

52 
j
 = 0; j < 
numOps
; j++) {

53 
İ
 = 
	`¦Ùdi¡
(
Œªsg’
è% 
‹¡”
.
num_İs_
;

54 
Œ
->
İs
.
	`push_back
(
‹¡”
.
	`doOp
(
q
, 
İ
, 
me
, 
¦Ùdi¡
, 
Œªsg’
));

57 ià(
Sto
::
	`Œy_comm™
()) {

58 #ià
PRINT_DEBUG


59 
T¿n§ùiÚTid
::
	`lock
(
lock
);

60 
¡d
::
cout
 << "[" << 
me
 << "] comm™‹d " << 
Sto
::
	`comm™_tid
(è<< std::
’dl
;

61 
T¿n§ùiÚTid
::
	`uÆock
(
lock
);

63 
txn_li¡
[
me
][
Sto
::
	`comm™_tid
()] = 
Œ
;

66 #ià
PRINT_DEBUG


67 
T¿n§ùiÚTid
::
	`lock
(
lock
); 
¡d
::
cout
 << "[" << 
me
 << "]‡bÜ‹d "<< std::
’dl
; T¿n§ùiÚTid::
	`uÆock
(lock);

71 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

72 #ià
PRINT_DEBUG


73 
T¿n§ùiÚTid
::
	`lock
(
lock
); 
¡d
::
cout
 << "[" << 
me
 << "]‡bÜ‹d "<< std::
’dl
; T¿n§ùiÚTid::
	`uÆock
(lock);

78 
	}
}

80 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

81 * 
	$runFunc
(* 
x
) {

82 
Te¡”Paœ
<
T
>* 

 = (Te¡”Paœ<T>*è
x
;

83 
	`run
(

->
t
,p->
me
);

84 #ià
PRINT_DEBUG


85 
T¿n§ùiÚTid
::
	`lock
(
lock
); 
‹¡”
.
	`´št_¡©s
(

->
t
); T¿n§ùiÚTid::
	`uÆock
(lock);

87  
nuÎ±r
;

88 
	}
}

91 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

92 
	$¡¬tAndWa™
(
T
* 
ds
) {

93 
±h»ad_t
 
tids
[
N_THREADS
];

94 
Te¡”Paœ
<
T
> 
‹¡”s
[
N_THREADS
];

95 
i
 = 0; i < 
N_THREADS
; ++i) {

96 
‹¡”s
[
i
].
t
 = 
ds
;

97 
‹¡”s
[
i
].
me
 = i;

98 
	`±h»ad_ü—‹
(&
tids
[
i
], 
NULL
, 
runFunc
<
T
>, &
‹¡”s
[i]);

100 
±h»ad_t
 
advªûr
;

101 
	`±h»ad_ü—‹
(&
advªûr
, 
NULL
, 
T¿n§ùiÚ
::
•och_advªûr
, NULL);

102 
	`±h»ad_d‘ach
(
advªûr
);

104 
i
 = 0; i < 
N_THREADS
; ++i) {

105 
	`±h»ad_još
(
tids
[
i
], 
NULL
);

107 
	}
}

109 
	$´št_time
(
timev®
 
tv1
, timev® 
tv2
) {

110 
	`´štf
("%f\n", (
tv2
.
tv_£c
-
tv1
.tv_£cè+ (tv2.
tv_u£c
-tv1.tv_usec)/1000000.0);

111 
	}
}

113 
	$maš
() {

114 
¡d
::
ios_ba£
::
	`sync_w™h_¡dio
(
Œue
);

115 
	`as£¹
(
CONSISTENCY_CHECK
);

116 
lock
 = 0;

118 #ià
DS
 =ğ
PRIORITY_QUEUE


119 
PriÜ™yQueue
<> 
q
;

120 
PriÜ™yQueue
<> 
q1
;

121 #–ià
DS
 =ğ
HASHTABLE


122 
HashbË
<, , 
çl£
, 1000000> 
q
;

123 
HashbË
<, , 
çl£
, 1000000> 
q1
;

124 #–ià
DS
 =ğ
RBTREE


125 
RBT»e
<, , 
Œue
> 
q
;

126 
¡d
::
m­
<, > 
q1
;

127 #–ià
DS
 =ğ
VECTOR


128 
VeùÜ
<> 
q
;

129 
VeùÜ
<> 
q1
;

132 
‹¡”
.
	`š™
(&
q
);

133 
‹¡”
.
	`š™
(&
q1
);

135 
timev®
 
tv1
,
tv2
;

136 
	`g‘timeofday
(&
tv1
, 
NULL
);

138 
i
 = 0; i < 
N_THREADS
; i++) {

139 
txn_li¡
.
	`em¶aû_back
();

142 
	`¡¬tAndWa™
(&
q
);

144 
	`g‘timeofday
(&
tv2
, 
NULL
);

145 
	`´štf
("Parallelime: ");

146 
	`´št_time
(
tv1
, 
tv2
);

148 #ià
STO_PROFILE_COUNTERS


149 
T¿n§ùiÚ
::
	`´št_¡©s
();

151 
txp_couÁ”s
 
tc
 = 
T¿n§ùiÚ
::
	`txp_couÁ”s_combšed
();

152 
	`´štf
("tÙ®_n: %Îu,Ù®_r: %Îu,Ù®_w: %Îu,Ù®_£¬ched: %Îu,Ù®_abÜts: %Îu (%Îu‡bÜt © comm™ime)\n", 
tc
.
	`p
(
txp_tÙ®_n
),c.p(
txp_tÙ®_r
),c.p(
txp_tÙ®_w
),c.p(
txp_tÙ®_£¬ched
),c.p(
txp_tÙ®_abÜts
),c.p(
txp_comm™_time_abÜts
));

157 
¡d
::
m­
<
ušt64_t
, 
txn_»cÜd
 *> 
combšed_txn_li¡
;

159 
i
 = 0; i < 
N_THREADS
; i++) {

160 
combšed_txn_li¡
.
	`š£¹
(
txn_li¡
[
i
].
	`begš
(),xn_li¡[i].
	`’d
());

163 
¡d
::
cout
 << "SšgËh»ad„•Ïy" << std::
’dl
;

164 
	`g‘timeofday
(&
tv1
, 
NULL
);

166 
¡d
::
m­
<
ušt64_t
, 
txn_»cÜd
 *>::
™”©Ü
 
™
 = 
combšed_txn_li¡
.
	`begš
();

167 ; 
™
 !ğ
combšed_txn_li¡
.
	`’d
(); it++) {

168 #ià
PRINT_DEBUG


169 
¡d
::
cout
 << "BEGINxÀ" << 
™
->
fœ¡
 << std::
’dl
;

171 
Sto
::
	`¡¬t_Œª§ùiÚ
();

172 
i
 = 0; i < 
™
->
£cÚd
->
İs
.
	`size
(); i++) {

173 
‹¡”
.
	`»doOp
(&
q1
, 
™
->
£cÚd
->
İs
[
i
]);

175 
	`as£¹
(
Sto
::
	`Œy_comm™
());

176 #ià
PRINT_DEBUG


177 
¡d
::
cout
 << "COMMITTED" << std::
’dl
;

181 
	`g‘timeofday
(&
tv2
, 
NULL
);

182 
	`´štf
("Serialime: ");

183 
	`´št_time
(
tv1
, 
tv2
);

186 
‹¡”
.
	`check
(&
q
, &
q1
);

188 
	}
}

	@test/unit-dboindex.cc

1 
	~"DB_šdex.hh
"

2 
	~"DB_¡ruùs.hh
"

3 
	~"DB_·¿ms.hh
"

5 
	scßr£_g¿šed_row
 {

6 şas 
	cNamedCŞumn
 : { 
¯
 = 0, 
	mbb
, 
	mcc
 };

8 
ušt64_t
 
	g¯
;

9 
ušt64_t
 
	gbb
;

10 
ušt64_t
 
	gcc
;

12 
	$cßr£_g¿šed_row
(è: 
	`¯
(), 
	`bb
(), 
	$cc
(è{
	}
}

14 
	$cßr£_g¿šed_row
(
ušt64_t
 
a
, ušt64_ˆ
b
, ušt64_ˆ
c
)

15 : 
	`¯
(
a
), 
	`bb
(
b
), 
	$cc
(
c
è{
	}
}

18 
	skey_ty³
 {

19 
ušt64_t
 
	mid
;

21 
ex¶ic™
 
key_ty³
(
ušt64_t
 
key
è: 
id
(
b’ch
::
bsw­
(key)) {}

22 
İ”©Ü
 
lcdf
::
SŒ
() const {

23  
lcdf
::
SŒ
((cÚ¡ *)
this
, (*this));

29 
usšg
 
	gCßr£Index
 = 
b’ch
::
Üd”ed_šdex
<
key_ty³
, 
	gcßr£_g¿šed_row
, 
	gdb_·¿ms
::
db_deçuÉ_·¿ms
>;

30 
usšg
 
	gFšeIndex
 = 
b’ch
::
Üd”ed_šdex
<
key_ty³
, 
	gexam¶e_row
, 
	gdb_·¿ms
::
db_deçuÉ_·¿ms
>;

32 
	$š™_cšdex
(
Cßr£Index
& 
ci
) {

33 
ušt64_t
 
i
 = 1; i <= 10; ++i)

34 
ci
.
	`nÚŒªs_put
(
	`key_ty³
(
i
), 
	`cßr£_g¿šed_row
(i, i, i));

35 
	}
}

37 
	$š™_fšdex
(
FšeIndex
& 
fi
) {

38 
exam¶e_row
 
row
;

39 
row
.
d_ytd
 = 3000;

40 
row
.
d_x
 = 10;

41 
row
.
d_d©e
 = 200;

42 
row
.
d_Ãxt_oid
 = 100;

43 
row
.
d_·ym’t_út
 = 50;

45 
ušt64_t
 
i
 = 1; i <= 10; ++i)

46 
fi
.
	`nÚŒªs_put
(
	`key_ty³
(
i
), 
row
);

47 
	}
}

49 
	$‹¡_cßr£_basic
() {

50 
Cßr£Index
::
	tNamedCŞumn
 
	tnc
;

51 
Cßr£Index
 
ci
;

52 
ci
.
	`th»ad_š™
();

54 
	`š™_cšdex
(
ci
);

55 
boŞ
 
sucûss
, 
found
;

56 
ušŒ_t
 
row
;

57 cÚ¡ 
cßr£_g¿šed_row
 *
v®ue
;

60 
Te¡T¿n§ùiÚ
 
	`t
(0);

61 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
ci
.
	`£Ëù_row
(
	`key_ty³
(1), {{
nc
::
¯
, 
çl£
}});

62 
	`as£¹
(
sucûss
 && 
found
);

63 
	`as£¹
(
v®ue
->
¯
 == 1);

64 
	`as£¹
(
t
.
	`Œy_comm™
());

68 
Te¡T¿n§ùiÚ
 
	`t
(0);

69 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
ci
.
	`£Ëù_row
(
	`key_ty³
(1), {{
nc
::
¯
, 
Œue
}});

70 autØ
Ãw_row
 = 
Sto
::
	`tx_®loc
(
v®ue
);

71 
Ãw_row
->
¯
 = 2;

72 
ci
.
	`upd©e_row
(
row
, 
Ãw_row
);

73 
	`as£¹
(
t
.
	`Œy_comm™
());

75 
Te¡T¿n§ùiÚ
 
	`t1
(1);

76 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
ci
.
	`£Ëù_row
(
	`key_ty³
(1), {{
nc
::
¯
, 
çl£
}});

77 
	`as£¹
(
v®ue
->
¯
 == 2);

78 
	`as£¹
(
t1
.
	`Œy_comm™
());

81 
	`´štf
("·s %s\n", 
__FUNCTION__
);

82 
	}
}

84 
	$‹¡_cßr£_»ad_my_¥l™
() {

85 
Cßr£Index
::
	tNamedCŞumn
 
	tnc
;

86 
Cßr£Index
 
ci
;

87 
ci
.
	`th»ad_š™
();

89 
	`š™_cšdex
(
ci
);

90 
boŞ
 
sucûss
, 
found
;

91 
ušŒ_t
 
row
;

92 cÚ¡ 
cßr£_g¿šed_row
 *
v®ue
;

95 
Te¡T¿n§ùiÚ
 
	`t
(0);

96 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
ci
.
	`£Ëù_row
(
	`key_ty³
(20), {{
nc
::
¯
, 
çl£
}});

97 
	`as£¹
(
sucûss
 && !
found
);

98 
i
 = 0; i < 10; ++i) {

99 autØ
r
 = 
Sto
::
tx_®loc
<
cßr£_g¿šed_row
>();

100 
	`Ãw
 (
r
è
	`cßr£_g¿šed_row
(
i
, i, i);

101 
ci
.
	`š£¹_row
(
	`key_ty³
(10 + 
i
), 
r
);

103 
	`as£¹
(
t
.
	`Œy_comm™
());

106 
	`´štf
("·s %s\n", 
__FUNCTION__
);

107 
	}
}

109 
	$‹¡_cßr£_cÚæiù0
() {

110 
Cßr£Index
::
	tNamedCŞumn
 
	tnc
;

111 
Cßr£Index
 
ci
;

112 
ci
.
	`th»ad_š™
();

114 
	`š™_cšdex
(
ci
);

115 
boŞ
 
sucûss
, 
found
;

116 
ušŒ_t
 
row
;

117 cÚ¡ 
cßr£_g¿šed_row
 *
v®ue
;

120 
Te¡T¿n§ùiÚ
 
	`t1
(0);

121 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
ci
.
	`£Ëù_row
(
	`key_ty³
(1), {{
nc
::
¯
, 
çl£
}});

122 
	`as£¹
(
sucûss
 && 
found
);

123 
	`as£¹
(
v®ue
->
¯
 == 1);

125 
Te¡T¿n§ùiÚ
 
	`t2
(1);

126 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
ci
.
	`£Ëù_row
(
	`key_ty³
(1), {{
nc
::
¯
, 
Œue
}});

127 
	`as£¹
(
sucûss
 && 
found
);

128 autØ
Ãw_row
 = 
Sto
::
	`tx_®loc
(
v®ue
);

129 
Ãw_row
->
¯
 = 2;

130 
ci
.
	`upd©e_row
(
row
, 
Ãw_row
);

131 
	`as£¹
(
t2
.
	`Œy_comm™
());

133 
t1
.
	`u£
();

134 
	`as£¹
(!
t1
.
	`Œy_comm™
());

138 
Te¡T¿n§ùiÚ
 
	`t1
(0);

139 
cßr£_g¿šed_row
 
	`row_v®ue
(100, 100, 100);

140 
¡d
::
	`t›
(
sucûss
, 
found
èğ
ci
.
	`š£¹_row
(
	`key_ty³
(100), &
row_v®ue
);

141 
	`as£¹
(
sucûss
 && !
found
);

143 
Te¡T¿n§ùiÚ
 
	`t2
(0);

144 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
ci
.
	`£Ëù_row
(
	`key_ty³
(100), {{
nc
::
¯
, 
çl£
}});

145 
	`as£¹
(!
sucûss
 || !
found
);

147 
t1
.
	`u£
();

148 
	`as£¹
(
t1
.
	`Œy_comm™
());

151 
	`´štf
("·s %s\n", 
__FUNCTION__
);

152 
	}
}

154 
	$‹¡_cßr£_cÚæiù1
() {

155 
Cßr£Index
::
	tNamedCŞumn
 
	tnc
;

156 
Cßr£Index
 
ci
;

157 
ci
.
	`th»ad_š™
();

159 
	`š™_cšdex
(
ci
);

160 
boŞ
 
sucûss
, 
found
;

161 
ušŒ_t
 
row
;

162 cÚ¡ 
cßr£_g¿šed_row
 *
v®ue
;

165 
Te¡T¿n§ùiÚ
 
	`t1
(0);

166 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
ci
.
	`£Ëù_row
(
	`key_ty³
(1), {{
nc
::
¯
, 
çl£
}});

167 
	`as£¹
(
sucûss
 && 
found
);

168 
	`as£¹
(
v®ue
->
¯
 == 1);

170 
Te¡T¿n§ùiÚ
 
	`t2
(1);

171 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
ci
.
	`£Ëù_row
(
	`key_ty³
(1), {{
nc
::
bb
, 
Œue
}});

172 
	`as£¹
(
sucûss
 && 
found
);

173 autØ
Ãw_row
 = 
Sto
::
	`tx_®loc
(
v®ue
);

174 
Ãw_row
->
¯
 = 2;

175 
Ãw_row
->
bb
 = 2;

176 
ci
.
	`upd©e_row
(
row
, 
Ãw_row
);

177 
	`as£¹
(
t2
.
	`Œy_comm™
());

179 
t1
.
	`u£
();

180 
	`as£¹
(
v®ue
->
¯
 == 2);

181 
	`as£¹
(!
t1
.
	`Œy_comm™
());

184 
	`´štf
("·s %s\n", 
__FUNCTION__
);

185 
	}
}

187 
	$‹¡_fše_cÚæiù0
() {

188 
FšeIndex
::
	tNamedCŞumn
 
	tnc
;

189 
FšeIndex
 
fi
;

190 
fi
.
	`th»ad_š™
();

192 
	`š™_fšdex
(
fi
);

193 
boŞ
 
sucûss
, 
found
;

194 
ušŒ_t
 
row
;

195 cÚ¡ 
exam¶e_row
 *
v®ue
;

198 
Te¡T¿n§ùiÚ
 
	`t1
(0);

199 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
fi
.
	`£Ëù_row
(
	`key_ty³
(1), {{
nc
::
ytd
, 
çl£
}});

200 
	`as£¹
(
sucûss
 && 
found
);

201 
	`as£¹
(
v®ue
->
d_ytd
 == 3000);

203 
Te¡T¿n§ùiÚ
 
	`t2
(1);

204 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
fi
.
	`£Ëù_row
(
	`key_ty³
(1), {{
nc
::
ytd
, 
Œue
}});

205 
	`as£¹
(
sucûss
 && 
found
);

206 autØ
Ãw_row
 = 
Sto
::
	`tx_®loc
(
v®ue
);

207 
Ãw_row
->
d_ytd
 += 10;

208 
fi
.
	`upd©e_row
(
row
, 
Ãw_row
);

209 
	`as£¹
(
t2
.
	`Œy_comm™
());

211 
t1
.
	`u£
();

212 
	`as£¹
(
v®ue
->
d_ytd
 == 3010);

213 
	`as£¹
(!
t1
.
	`Œy_comm™
());

216 
	`´štf
("·s %s\n", 
__FUNCTION__
);

217 
	}
}

219 
	$‹¡_fše_cÚæiù1
() {

220 
FšeIndex
::
	tNamedCŞumn
 
	tnc
;

221 
FšeIndex
 
fi
;

222 
fi
.
	`th»ad_š™
();

224 
	`š™_fšdex
(
fi
);

225 
boŞ
 
sucûss
, 
found
;

226 
ušŒ_t
 
row
;

227 cÚ¡ 
exam¶e_row
 *
v®ue
;

230 
Te¡T¿n§ùiÚ
 
	`t1
(0);

231 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
fi
.
	`£Ëù_row
(
	`key_ty³
(1), {{
nc
::
ytd
, 
çl£
}});

232 
	`as£¹
(
sucûss
 && 
found
);

233 
	`as£¹
(
v®ue
->
d_ytd
 == 3000);

235 
Te¡T¿n§ùiÚ
 
	`t2
(1);

236 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
fi
.
	`£Ëù_row
(
	`key_ty³
(1), {{
nc
::
·ym’t_út
, 
Œue
}});

237 
	`as£¹
(
sucûss
 && 
found
);

238 autØ
Ãw_row
 = 
Sto
::
	`tx_®loc
(
v®ue
);

239 
Ãw_row
->
d_ytd
 += 10;

240 
Ãw_row
->
d_·ym’t_út
 += 1;

241 
fi
.
	`upd©e_row
(
row
, 
Ãw_row
);

242 
	`as£¹
(
t2
.
	`Œy_comm™
());

244 
t1
.
	`u£
();

245 
	`as£¹
(
v®ue
->
d_ytd
 == 3000);

246 
	`as£¹
(
v®ue
->
d_·ym’t_út
 == 51);

247 
	`as£¹
(!
t1
.
	`Œy_comm™
());

250 
	`´štf
("·s %s\n", 
__FUNCTION__
);

251 
	}
}

253 
	$‹¡_fše_cÚæiù2
() {

254 
FšeIndex
::
	tNamedCŞumn
 
	tnc
;

255 
FšeIndex
 
fi
;

256 
fi
.
	`th»ad_š™
();

258 
	`š™_fšdex
(
fi
);

259 
boŞ
 
sucûss
, 
found
;

260 
ušŒ_t
 
row
;

261 cÚ¡ 
exam¶e_row
 *
v®ue
;

264 
Te¡T¿n§ùiÚ
 
	`t1
(0);

265 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
fi
.
	`£Ëù_row
(
	`key_ty³
(1), {{
nc
::
x
, 
çl£
}});

266 
	`as£¹
(
sucûss
 && 
found
);

267 
	`as£¹
(
v®ue
->
d_x
 == 10);

269 
Te¡T¿n§ùiÚ
 
	`t2
(1);

270 
¡d
::
	`t›
(
sucûss
, 
found
, 
row
, 
v®ue
èğ
fi
.
	`£Ëù_row
(
	`key_ty³
(1), {{
nc
::
ytd
, 
Œue
}});

271 
	`as£¹
(
sucûss
 && 
found
);

272 autØ
Ãw_row
 = 
Sto
::
	`tx_®loc
(
v®ue
);

273 
Ãw_row
->
d_ytd
 += 10;

274 
Ãw_row
->
d_·ym’t_út
 += 1;

275 
fi
.
	`upd©e_row
(
row
, 
Ãw_row
);

276 
	`as£¹
(
t2
.
	`Œy_comm™
());

278 
t1
.
	`u£
();

279 
	`as£¹
(
v®ue
->
d_ytd
 == 3010);

280 
	`as£¹
(
v®ue
->
d_·ym’t_út
 == 50);

281 
	`as£¹
(
t1
.
	`Œy_comm™
());

284 
	`´štf
("·s %s\n", 
__FUNCTION__
);

285 
	}
}

287 
	$maš
() {

288 
	`‹¡_cßr£_basic
();

289 
	`‹¡_cßr£_»ad_my_¥l™
();

290 
	`‹¡_cßr£_cÚæiù0
();

291 
	`‹¡_cßr£_cÚæiù1
();

292 
	`‹¡_fše_cÚæiù0
();

293 
	`‹¡_fše_cÚæiù1
();

294 
	`‹¡_fše_cÚæiù2
();

295 
	`´štf
("Allests…ass!\n");

297 
	}
}

	@test/unit-masstree.cc

1 
	~<io¡»am
>

2 
	~<¿ndom
>

3 
	~<veùÜ
>

4 
	~<th»ad
>

5 
	~<by‹sw­.h
>

7 
	~<±h»ad.h
>

9 
	~"cÚfig.h
"

10 
	~"comp”.hh
"

12 
	~"mas¡»e.hh
"

13 
	~"kvth»ad.hh
"

14 
	~"mas¡»e_tcursÜ.hh
"

15 
	~"mas¡»e_š£¹.hh
"

16 
	~"mas¡»e_´št.hh
"

17 
	~"mas¡»e_»move.hh
"

18 
	~"mas¡»e_sÿn.hh
"

19 
	~"¡ršg.hh
"

21 
	#NUM_THREADS
 4

	)

23 şas 
	cMas¡»eW¿µ”
 {

24 
	mpublic
:

25 
cÚ¡ex´
 
ušt64_t
 
š£¹_bound
 = 0xffffff;

26 
	mbË_·¿ms
 : 
public
 
Mas¡»e
::
nod•¬ams
<15,15> {

27 
ušt64_t
 
	tv®ue_ty³
;

28 
	mMas¡»e
::
	tv®ue_´št
<
	tv®ue_ty³
> 
	tv®ue_´št_ty³
;

29 
th»adšfo
 
	tth»adšfo_ty³
;

32 
	gMas¡»e
::
	tSŒ
 Str;

33 
	gMas¡»e
::
	tbasic_bË
<
	tbË_·¿ms
> 
	tbË_ty³
;

34 
	gMas¡»e
::
	tuÆocked_tcursÜ
<
	tbË_·¿ms
> 
	tuÆocked_cursÜ_ty³
;

35 
	gMas¡»e
::
	ttcursÜ
<
	tbË_·¿ms
> 
	tcursÜ_ty³
;

36 
	gMas¡»e
::
	tËaf
<
	tbË_·¿ms
> 
	tËaf_ty³
;

38 
ty³Çme
 
	tbË_ty³
::
	tnode_ty³
‚ode_type;

39 
ty³Çme
 
	tuÆocked_cursÜ_ty³
::
	tnodev”siÚ_v®ue_ty³
‚odeversion_value_type;

41 
__th»ad
 
ty³Çme
 
	gbË_·¿ms
::
th»adšfo_ty³
 *
ti
;

43 
	$Mas¡»eW¿µ”
() {

44 
this
->
	`bË_š™
();

45 
	}
}

47 
	$bË_š™
() {

48 ià(
ti
 =ğ
nuÎ±r
)

49 
ti
 = 
th»adšfo
::
	`make
Ñh»adšfo::
TI_MAIN
, -1);

50 
bË_
.
	`š™Ÿlize
(*
ti
);

51 
key_g’_
 = 0;

52 
	}
}

54 
	$keyg’_»£t
() {

55 
key_g’_
 = 0;

56 
	}
}

58 
	$th»ad_š™
(
th»ad_id
) {

59 ià(
ti
 =ğ
nuÎ±r
)

60 
ti
 = 
th»adšfo
::
	`make
Ñh»adšfo::
TI_PROCESS
, 
th»ad_id
);

61 
	}
}

63 
	$š£¹_‹¡
() {

65 autØ
št_key
 = 
	`ãtch_ªd_add
(&
key_g’_
, 1);

66 
ušt64_t
 
key_buf
;

67 ià(
št_key
 > 
š£¹_bound
)

69 
SŒ
 
key
 = 
	`make_key
(
št_key
, 
key_buf
);

71 
cursÜ_ty³
 
	`Í
(
bË_
, 
key
);

72 
boŞ
 
found
 = 
Í
.
	`fšd_š£¹
(*
ti
);

73 
	`®ways_as£¹
(!
found
, "keys should‡ll be unique");

75 
Í
.
	`v®ue
(èğ
št_key
;

77 
	`ãnû
();

78 
Í
.
	`fšish
(1, *
ti
);

80 
	}
}

82 
	$»move_‹¡
() {

84 autØ
št_key
 = 
	`ãtch_ªd_add
(&
key_g’_
, 1);

85 
ušt64_t
 
key_buf
;

86 ià(
št_key
 > 
š£¹_bound
)

88 
SŒ
 
key
 = 
	`make_key
(
št_key
, 
key_buf
);

90 
cursÜ_ty³
 
	`Í
(
bË_
, 
key
);

91 
boŞ
 
found
 = 
Í
.
	`fšd_locked
(*
ti
);

92 
	`®ways_as£¹
(
found
, "keys must‡llƒxist");

93 
Í
.
	`fšish
(-1, *
ti
);

95 
	}
}

97 
	$š£¹_»move_‹¡
(
th»ad_id
) {

98 
¡d
::
mt19937
 
	`g’
(
th»ad_id
);

99 
¡d
::
unifÜm_št_di¡ributiÚ
<> 
	`di¡
(1, 6);

101 autØ
št_key
 = 
	`ãtch_ªd_add
(&
key_g’_
, 1);

102 
ušt64_t
 
key_buf
;

103 ià(
št_key
 > 
š£¹_bound
)

105 
SŒ
 
key
 = 
	`make_key
(
št_key
, 
key_buf
);

107 
cursÜ_ty³
 
	`Í
(
bË_
, 
key
);

108 
boŞ
 
found
 = 
Í
.
	`fšd_š£¹
(*
ti
);

109 
	`®ways_as£¹
(!
found
, "keys should‡ll be unique 1");

111 
Í
.
	`v®ue
(èğ
št_key
;

112 
	`ãnû
();

113 
Í
.
	`fšish
(1, *
ti
);

115 ià(
	`di¡
(
g’
) <= 2) {

116 
cursÜ_ty³
 
	`Í1
(
bË_
, 
key
);

117 
boŞ
 
found1
 = 
Í1
.
	`fšd_š£¹
(*
ti
);

118 ià(!
found1
) {

119 
¡d
::
û¼
 << "çed‡ˆkey: " << 
št_key
 << std::
’dl
;

120 
	`®ways_as£¹
(
found1
, "this is my key!");

122 
Í1
.
	`fšish
(-1, *
ti
);

125 
	}
}

127 
	g´iv©e
:

128 
bË_ty³
 
bË_
;

129 
ušt64_t
 
	gkey_g’_
;

131 
šlše
 
SŒ
 
	$make_key
(
ušt64_t
 
št_key
, ušt64_t& 
key_buf
) {

132 
key_buf
 = 
	`__bsw­_64
(
št_key
);

133  
	`SŒ
((cÚ¡ *)&
key_buf
, (key_buf));

134 
	}
}

137 
±h»ad_b¬r›r_t
 
	gb¬r›r
;

138 
__th»ad
 
ty³Çme
 
	gMas¡»eW¿µ”
::
bË_·¿ms
::
th»adšfo_ty³
* 
Mas¡»eW¿µ”
::
ti
 = 
nuÎ±r
;

140 vŞ©
mrcu_•och_ty³
 
	gaùive_•och
 = 1;

141 vŞ©
ušt64_t
 
	gglob®•och
 = 1;

142 vŞ©
boŞ
 
	g»cov”šg
 = 
çl£
;

144 
	$‹¡_th»ad
(
Mas¡»eW¿µ”
* 
mt
, 
th»ad_id
) {

145 
mt
->
	`th»ad_š™
(
th»ad_id
);

146 
mt
->
	`š£¹_»move_‹¡
(
th»ad_id
);

147 
	}
}

149 
	$maš
() {

150 
	`±h»ad_b¬r›r_š™
(&
b¬r›r
, 
nuÎ±r
, 
NUM_THREADS
);

151 autØ
mt
 = 
Ãw
 
	`Mas¡»eW¿µ”
();

152 
mt
->
	`keyg’_»£t
();

153 
¡d
::
cout
 << "š£¹_»move_‹¡..." << std::
’dl
;

155 
¡d
::
veùÜ
<¡d::
th»ad
> 
ths
;

157 
i
 = 0; i < 
NUM_THREADS
; ++i)

158 
ths
.
	`em¶aû_back
(
‹¡_th»ad
, 
mt
, 
i
);

159 auto& 
t
 : 
ths
)

160 
t
.
	`još
();

162 
¡d
::
cout
 << "‹¡…ass." << std::
’dl
;

164 
	`±h»ad_b¬r›r_de¡roy
(&
b¬r›r
);

166 
	}
}

	@test/unit-mbta.cc

1 
	~<io¡»am
>

2 
	~<iomª
>

3 
	~<s¡»am
>

4 
	~<ÿs£¹
>

6 
	~<chrÚo
>

7 
	~<th»ad
>

9 
	~"DB_šdex.hh
"

16 
	gMassT¿ns
<
	t¡d
::
	t¡ršg
> 
	tmb_ty³
;

18 vŞ©
mrcu_•och_ty³
 
	gaùive_•och
 = 1;

20 
	$sÿÂ”
(
mb_ty³
* 
mb
) {

21 
TTh»ad
::
	`£t_id
(0);

22 
mb
->
	`th»ad_š™
();

23 
¡d
::
cout
 << "sÿÂ” s¹ed" << std::
’dl
;

24 
Œue
) {

25 
út
 = 0;

26 
út_¢­
;

28 
TRANSACTION
 {

29 
út_¢­
 = 
út
;

30 
mb
->
	`ŒªsQu”y
("00000", "99999", [&] (
Mas¡»e
::
SŒ
 
key
, 
mb_ty³
::
v®ue_ty³
& 
v®ue
) {

31 
	`as£¹
(
v®ue
 =ğ(
¡d
::
	`¡ršg
(
key
.
s
, key.
Ën
)+"v"));

32 ++
út_¢­
;

33  
Œue
;

35 } 
	`RETRY
(
Œue
);

37 
	`as£¹
(
út_¢­
 >ğ
út
);

38 
út
 = 
út_¢­
;

40 ià(
út
 % 5) {

41 
¡d
::
¡ršg¡»am
 
ss
;

42 
ss
 << "Inv®id‚umb” oàkeys: " << 
út
 << 
¡d
::
’dl
;

43 
¡d
::
û¼
 << 
ss
.
	`¡r
(è<< std::
æush
;

45 
	`as£¹
(0);

48 ià(
út
 > 999ul)

51 
	}
}

53 
	$š£¹”
(
mb_ty³
* 
mb
) {

54 
TTh»ad
::
	`£t_id
(1);

55 
mb
->
	`th»ad_š™
();

56 
¡d
::
cout
 << "š£¹” s¹ed" << std::
’dl
;

57 
key
 = 0;

58 
Œue
) {

59 
key_¢­
;

60 
TRANSACTION
 {

61 
key_¢­
 = 
key
;

62 
i
 = 0; i < 5; ++i) {

63 
¡d
::
¡ršg¡»am
 
ss
;

64 
ss
 << 
¡d
::
	`£tw
(5è<< std::
	`£tfl
('0'è<< 
key_¢­
;

65 
mb
->
	`ŒªsIn£¹
(
ss
.
	`¡r
(), ss.str()+"v");

66 ++
key_¢­
;

69 } 
	`RETRY
(
Œue
);

71 
key
 = 
key_¢­
;

73 ià(
key
 > 999ul)

76 
	}
}

78 
	$maš
() {

79 
mb_ty³
 
mb
;

81 
¡d
::
th»ad
 
	`sú
(
sÿÂ”
, &
mb
);

82 
¡d
::
th»ad
 
	`šs
(
š£¹”
, &
mb
);

83 
sú
.
	`još
();

84 
šs
.
	`još
();

85 
¡d
::
cout
 << "Te¡…ass." << std::
’dl
;

87 
	}
}

	@test/unit-opacity.cc

1 
	~<io¡»am
>

2 
	~<s¡»am
>

3 
	~<th»ad
>

5 
	~"TA¼ay.hh
"

6 
	~"TBox.hh
"

8 
cÚ¡ex´
 
	g¬¿y_size
 = 512;

10 
	gTA¼ay
<, 
	t¬¿y_size
> 
	t¬¿y_ty³
;

12 
	$wr™”
(
¬¿y_ty³
& 
¬r
) {

13 
TTh»ad
::
	`£t_id
(0);

14 
¡d
::
cout
 << "wr™”‡dvªû w™h s‹p oà2." << std::
’dl
;

15 
n
 = 0;‚ < 10000; ++n) {

16 
TRANSACTION_E
 {

17 
k
 = 0;

18 
idx
 = 2*
k
+1;

19 
idx
 < 
¬¿y_size
) {

20 
¬r
[
idx
] =‡rr[idx] + 1;

21 ++
k
;

22 
idx
 = 2*
k
+1;

24 } 
	`RETRY_E
(
Œue
);

26 
¡d
::
cout
 << "wr™” fšished." << std::
’dl
;

28 
	}
}

30 
	$»ad”
(
¬¿y_ty³
& 
¬r
) {

31 
TTh»ad
::
	`£t_id
(1);

32 
¡d
::
cout
 << "»ad”‡dvªû w™h s‹p oà4." << std::
’dl
;

33 
n
 = 0;‚ < 10000; ++n) {

34 
TRANSACTION_E
 {

35 
k
 = 0;

36 
idx
 = 4*
k
+1;

37 
v®
 = -1;

38 
idx
 < 
¬¿y_size
) {

39 
v_
 = 
¬r
[
idx
];

40 ià(
v®
 == -1)

41 
v®
 = 
v_
;

42 ià(
v®
 !ğ
v_
) {

43 
¡d
::
¡ršg¡»am
 
ss
;

44 
ss
 << "E¼Ü‡ˆšdex " << 
idx


45 << ",ƒx³ùšg " << 
v®
 << ", got "

46 << 
v_
 << "." << 
¡d
::
’dl
;

47 
¡d
::
cout
 << 
ss
.
	`¡r
(è<< std::
æush
;

48 
	`abÜt
();

51 ++
k
;

52 
idx
 = 4*
k
+1;

54 } 
	`RETRY_E
(
Œue
);

56 
¡d
::
cout
 << "»ad” fšished." << std::
’dl
;

57 
	}
}

59 
	$¬¿y_š™
(
¬¿y_ty³
& 
¬r
) {

60 
i
 = 0; i < 
¬¿y_size
; ++i)

61 
¬r
.
	`nÚŒªs_put
(
i
, 0);

62 
	}
}

64 
	$maš
() {

65 
¬¿y_ty³
 
¬r
;

66 
	`¬¿y_š™
(
¬r
);

68 autØ
tw
 = 
¡d
::
	`th»ad
(
wr™”
, std::
	`»f
(
¬r
));

69 autØ
Œ
 = 
¡d
::
	`th»ad
(
»ad”
, std::
	`»f
(
¬r
));

71 
tw
.
	`još
();

72 
Œ
.
	`još
();

74 
¡d
::
cout
 << "Te¡…ass." << std::
’dl
;

77 
	}
}

	@test/unit-rcu.cc

1 #undeà
NDEBUG


2 
	~"T¿n§ùiÚ.hh
"

3 
	~"şp.h
"

4 
	~<¡dlib.h
>

5 
	~<š‰y³s.h
>

7 
ušt64_t
 
	gÇÎoÿ‹d
;

8 
ušt64_t
 
	gnä“d
;

9 
	gd–ay
;

10 
boŞ
 
	g¡İ
;

12 şas 
	cT¿ck”
 {

13 
	mpublic
:

14 
	$T¿ck”
() {

15 
	`__sync_ãtch_ªd_add
(&
ÇÎoÿ‹d
, 1);

17 ~
	$T¿ck”
() {

18 
	`__sync_ãtch_ªd_add
(&
nä“d
, 1);

19 
	}
}

23 * 
	$Œack”_run
(* 
¬gum’t
) {

24 
tid
 = 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
¬gum’t
);

25 
TTh»ad
::
	`£t_id
(
tid
);

27 !
¡İ
) {

28 
this_d–ay
 = 
d–ay
 + (
	`d¿nd48
() - 0.5) * delay / 3;

29 
	`u¦“p
(
	`u£cÚds_t
(
this_d–ay
 * 0.7e6));

30 
TRANSACTION_E
 {

31 
T¿n§ùiÚ
::
	`rcu_d–‘e
(
Ãw
 
T¿ck”
);

32 
	`u¦“p
(
	`u£cÚds_t
(
this_d–ay
 * 0.3e6));

33 } 
	`RETRY_E
(
çl£
);

35  
nuÎ±r
;

36 
	}
}

39 cÚ¡ 
CÍ_O±iÚ
 
	gİtiÚs
[] = {

40 { "d–ay", 'd', 'd', 
CÍ_V®DoubË
, 
CÍ_Neg©e
 },

41 { "Áh»ads", 'j', 'j', 
CÍ_V®IÁ
, 0 },

42 { "Ãpochs", 'e', 'e', 
CÍ_V®IÁ
, 0 }

45 
	$maš
(
¬gc
, * 
¬gv
[]) {

46 
Áh»ads
 = 4;

47 
TRcuS‘
::
•och_ty³
 
Ãpochs
 = 10;

48 
d–ay
 = 0.000001;

50 
CÍ_P¬£r
 *
şp
 = 
	`CÍ_NewP¬£r
(
¬gc
, 
¬gv
, 
	`¬¿ysize
(
İtiÚs
), options);

51 
İt
;

52 (
İt
 = 
	`CÍ_Next
(
şp
)è!ğ
CÍ_DÚe
) {

53 
İt
) {

55 
d–ay
 = 
şp
->
v®
.
d
;

58 
Áh»ads
 = 
şp
->
v®
.
i
;

61 
Ãpochs
 = 
şp
->
v®
.
i
;

64 
	`abÜt
();

67 
	`CÍ_D–‘eP¬£r
(
şp
);

69 ià(
Áh»ads
 > 
MAX_THREADS
) {

70 
	`´štf
("Asked fÜ %dh»ad buˆMAX_THREADS i %d\n", 
Áh»ads
, 
MAX_THREADS
);

71 
	`ex™
(1);

74 
±h»ad_t
 
tids
[
Áh»ads
];

75 
ušŒ_t
 
i
 = 0; i < 
Áh»ads
; ++i)

76 
	`±h»ad_ü—‹
(&
tids
[
i
], 
NULL
, 
Œack”_run
, 
»š‹½»t_ÿ¡
<*>(i));

77 
±h»ad_t
 
advªûr
;

78 
	`±h»ad_ü—‹
(&
advªûr
, 
NULL
, 
T¿n§ùiÚ
::
•och_advªûr
, NULL);

79 
	`±h»ad_d‘ach
(
advªûr
);

81 
T¿n§ùiÚ
::
glob®_•ochs
.
glob®_•och
 < 
Ãpochs
 + 1)

82 
	`u¦“p
(
	`u£cÚds_t
(
d–ay
 * 1e6));

83 
¡İ
 = 
Œue
;

85 
i
 = 0; i < 
Áh»ads
; ++i)

86 
	`±h»ad_još
(
tids
[
i
], 
NULL
);

88 autØ
nä“d_befÜe
 = 
nä“d
;

89 
i
 = 0; i < 
Áh»ads
; ++i)

90 
T¿n§ùiÚ
::
tšfo
[
i
].
rcu_£t
.~
	`TRcuS‘
();

92 
	`®ways_as£¹
(
ÇÎoÿ‹d
 =ğ
nä“d
, "rcu check");

93 
	`®ways_as£¹
(
nä“d_befÜe
 > 0, "rcu check");

94 
	`´štf
("ü—‹d %" 
PRIu64
 ", d–‘ed %" PRIu64 ", fš®ly d–‘ed %" PRIu64 "\n", 
ÇÎoÿ‹d
, 
nä“d_befÜe
, 
nä“d
);

95 
	`´štf
("Test…ass.\n");

97 
	}
}

	@test/unit-sampling.cc

1 
	~<io¡»am
>

2 
	~"§m¶šg.hh
"

4 
usšg
 
Çme¥aû
 
	g§m¶šg
;

6 
	$maš
() {

8 
StoRªdomDi¡ributiÚ
<>::
ºg_ty³
 
	`ºg
(1 );

9 
StoRªdomDi¡ributiÚ
<> *
di¡
 = 
Ãw
 
StoZfDi¡ributiÚ
<>(
ºg
 , 1 , 1000 , 0.8 );

11 
i
 = 0; i < 1000; ++i)

12 
¡d
::
cout
 << 
di¡
->
	`§m¶e
() << ", ";

13 
¡d
::
cout
 << std::
’dl
;

15 
d–‘e
 
di¡
;

18 
	}
}

	@test/unit-swisstarray.cc

1 #undeà
NDEBUG


2 
	~<¡ršg
>

3 
	~<io¡»am
>

4 
	~<as£¹.h
>

5 
	~<veùÜ
>

6 
	~"T¿n§ùiÚ.hh
"

7 
	~"SwissTA¼ay.hh
"

8 
	~"TBox.hh
"

10 
	$‹¡Sim¶eIÁ
() {

11 
SwissTA¼ay
<, 100> 
f
;

14 
T¿n§ùiÚGu¬d
 
t
;

15 
f
[1] = 100;

16 
f
[1] = 200;

20 
T¿n§ùiÚGu¬d
 
t2
;

21 
f_»ad
 = 
f
[1];

22 
	`as£¹
(
f_»ad
 == 200);

25 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

26 
	}
}

28 
	$‹¡Wr™eWr™eCÚæiù
() {

29 
SwissTA¼ay
<, 100> 
f
;

32 
Te¡T¿n§ùiÚ
 
	`t1
(1);

34 
Te¡T¿n§ùiÚ
 
	`t2
(2);

36 
Œy
 {

37 
t1
.
	`u£
();

38 
f
[1] = 100;

40 
t2
.
	`u£
();

41 
f
[1] = 100;

42 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

45 
	`as£¹
(
t2
.
	`g‘_tx
().
	`is_»¡¬‹d
());

47 
t1
.
	`u£
();

48 
	`as£¹
(
t1
.
	`Œy_comm™
());

50 
t2
.
	`u£
();

51 
Sto
::
	`¡¬t_Œª§ùiÚ
();

52 
a
 = 
f
[1];

53 
	`as£¹
(
a
 == 100);

55 
f
[1] = 200;

56 
a
 = 
f
[1];

57 
	`as£¹
(
a
 == 200);

61 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

62 
	}
}

64 
	$‹¡AbÜtR–—£Lock
() {

65 
¡d
::
cout
 << "S¹šge¡‡bÜˆ»Ëa£†ock!" << std::
’dl
;

66 
SwissTA¼ay
<, 100> 
f
;

69 
Te¡T¿n§ùiÚ
 
	`t1
(1);

71 
Te¡T¿n§ùiÚ
 
	`t2
(2);

73 
Œy
 {

74 
t1
.
	`u£
();

75 
f
[1] = 100;

77 
t2
.
	`u£
();

78 
f
[2] = 200;

79 
f
[1] = 300;

80 } 
	`ÿtch
(
T¿n§ùiÚ
::
AbÜt
 
e
) {

84 
	`as£¹
(
t2
.
	`g‘_tx
().
	`is_»¡¬‹d
());

86 
t1
.
	`u£
();

87 
f
[2] = 400;

88 
f
[1] = 500;

89 
	`as£¹
(
t1
.
	`Œy_comm™
());

92 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

93 
	}
}

95 
	$maš
() {

97 
	`‹¡Wr™eWr™eCÚæiù
();

98 
	`‹¡AbÜtR–—£Lock
();

99 
¡d
::
cout
 << "Te¡ fšished." << std::
’dl
;

101 
	}
}

	@test/unit-swisstgeneric.cc

1 #undeà
NDEBUG


2 
	~<¡ršg
>

3 
	~<io¡»am
>

4 
	~<as£¹.h
>

5 
	~<veùÜ
>

6 
	~"T¿n§ùiÚ.hh
"

7 
	~"SwissTG’”ic.hh
"

9 
	$‹¡Sim¶eIÁ
() {

10 
SwissTNÚİaqueG’”ic
& 
f
 = *
Ãw
 SwissTNonopaqueGeneric;

11 
f1
 = 0;

14 
T¿n§ùiÚGu¬d
 
t
;

15 
f
.
	`wr™e_throws
(&
f1
, 100);

19 
T¿n§ùiÚGu¬d
 
t2
;

20 
f_»ad_throws
;

21 
f
.
	`»ad_throws
(&
f1
, 
f_»ad_throws
);

22 
	`as£¹
(
f_»ad_throws
 == 100);

25 
	`as£¹
(
f1
 == 100);

27 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

28 
	}
}

30 
	$‹¡Sim¶eIÁ2
() {

31 
SwissTNÚİaqueG’”ic
& 
g
 = *
Ãw
 SwissTNonopaqueGeneric;

32 
f
[100];

35 
T¿n§ùiÚGu¬d
 
t
;

36 
g
.
	`wr™e_throws
(&
f
[1], 100);

37 
g
.
	`wr™e_throws
(&
f
[1], 200);

41 
T¿n§ùiÚGu¬d
 
t2
;

42 
f_»ad_throws
;

43 
g
.
	`»ad_throws
(&
f
[1], 
f_»ad_throws
);

44 
	`as£¹
(
f_»ad_throws
 == 200);

47 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

48 
	}
}

168 
	$‹¡Wr™eWr™eCÚæiù
() {

169 
SwissTNÚİaqueG’”ic
& 
g
 = *
Ãw
 SwissTNonopaqueGeneric;

170 
f
[100];

173 
Te¡T¿n§ùiÚ
 
	`t1
(1);

175 
Te¡T¿n§ùiÚ
 
	`t2
(2);

177 
Œy
 {

178 
t1
.
	`u£
();

179 
g
.
	`wr™e_throws
(&
f
[1], 100);

181 
t2
.
	`u£
();

182 
g
.
	`wr™e_throws
(&
f
[1], 100);

183 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

186 
	`as£¹
(
t2
.
	`g‘_tx
().
	`is_»¡¬‹d
());

188 
t1
.
	`u£
();

189 
	`as£¹
(
t1
.
	`Œy_comm™
());

191 
t2
.
	`u£
();

192 
Sto
::
	`¡¬t_Œª§ùiÚ
();

193 
a
;

194 
g
.
	`»ad_throws
(&
f
[1], 
a
);

195 
	`as£¹
(
a
 == 100);

197 
g
.
	`wr™e_throws
(&
f
[1], 200);

198 
g
.
	`»ad_throws
(&
f
[1], 
a
);

199 
	`as£¹
(
a
 == 200);

203 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

204 
	}
}

207 
	$‹¡AbÜtR–—£Lock
() {

208 
SwissTNÚİaqueG’”ic
& 
g
 = *
Ãw
 SwissTNonopaqueGeneric;

209 
f
[100];

212 
Te¡T¿n§ùiÚ
 
	`t1
(1);

214 
Te¡T¿n§ùiÚ
 
	`t2
(2);

216 
Œy
 {

217 
t1
.
	`u£
();

218 
g
.
	`wr™e_throws
(&
f
[1], 100);

220 
t2
.
	`u£
();

221 
g
.
	`wr™e_throws
(&
f
[2], 200);

222 
g
.
	`wr™e_throws
(&
f
[1], 300);

223 } 
	`ÿtch
(
T¿n§ùiÚ
::
AbÜt
 
e
) {

227 
	`as£¹
(
t2
.
	`g‘_tx
().
	`is_»¡¬‹d
());

229 
t1
.
	`u£
();

230 
g
.
	`wr™e_throws
(&
f
[2], 400);

231 
g
.
	`wr™e_throws
(&
f
[1], 500);

232 
	`as£¹
(
t1
.
	`Œy_comm™
());

235 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

236 
	}
}

240 
	$maš
() {

241 
	`‹¡Sim¶eIÁ
();

242 
	`‹¡Sim¶eIÁ2
();

246 
	`‹¡Wr™eWr™eCÚæiù
();

247 
	`‹¡AbÜtR–—£Lock
();

249 
	}
}

	@test/unit-tarray.cc

1 #undeà
NDEBUG


2 
	~<¡ršg
>

3 
	~<io¡»am
>

4 
	~<as£¹.h
>

5 
	~<veùÜ
>

6 
	~"Sto.hh
"

7 
	~"TA¼ay.hh
"

8 
	~"TA¼ayAd­tive.hh
"

9 
	~"TBox.hh
"

10 
	~<time.h
>

12 
šlše
 
	$g‘time_d
() {

13 
time¥ec
 
ts
;

14 
	`şock_g‘time
(
CLOCK_REALTIME
, &
ts
);

15  
ts
.
tv_£c
 +s.
tv_n£c
 / 1.0e9;

16 
	}
}

18 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gN
,em¶©<
	gty³Çme
> 
şass
 
	gW
 = 
TO·queW¿µed
>

19 
usšg
 
Te¡A¼ay
 = 
TA¼ay
<
T
, 
	gN
, 
	gW
>;

21 
	$‹¡Sim¶eIÁ
() {

22 
Te¡A¼ay
<, 100> 
f
;

25 
T¿n§ùiÚGu¬d
 
t
;

26 
f
[1] = 100;

30 
T¿n§ùiÚGu¬d
 
t2
;

31 
f_»ad
 = 
f
[1];

32 
	`as£¹
(
f_»ad
 == 100);

35 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

36 
	}
}

38 
	$‹¡Sim¶eSŒšg
() {

39 
Te¡A¼ay
<
¡d
::
¡ršg
, 100> 
f
;

42 
T¿n§ùiÚGu¬d
 
t
;

43 
f
[1] = "100";

47 
T¿n§ùiÚGu¬d
 
t2
;

48 
¡d
::
¡ršg
 
f_»ad
 = 
f
[1];

49 
	`as£¹
(
f_»ad
.
	`com·»
("100") == 0);

52 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

53 
	}
}

55 
	$‹¡I‹r
() {

56 
¡d
::
veùÜ
<> 
¬r
;

57 
Te¡A¼ay
<, 10> 
f
;

58 
i
 = 0; i < 10; i++) {

59 
x
 = 
	`¿nd
();

60 
¬r
.
	`push_back
(
x
);

61 
f
.
	`nÚŒªs_put
(
i
, 
x
);

63 
max
;

64 
TRANSACTION_E
 {

65 
max
 = *(
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
()));

66 } 
	`RETRY_E
(
çl£
);

68 
	`as£¹
(
max
 =ğ*(
¡d
::
	`max_–em’t
(
¬r
.
	`begš
(),‡¼.
	`’d
())));

69 
	`´štf
("Max i %i\n", 
max
);

70 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

71 
	}
}

73 
	$‹¡TicToc0
() {

74 
TA¼ay
<, 10, 
TNÚİaqueW¿µed
> 
f
;

75 
i
 = 0; i < 10; ++i) {

76 
f
.
	`nÚŒªs_put
(
i
, i);

80 
Te¡T¿n§ùiÚ
 
	`t1
(1);

81 
a
 = 
f
[4];

82 
	`as£¹
(
a
 == 4);

84 
Te¡T¿n§ùiÚ
 
	`t2
(2);

85 
f
[4] = 5;

86 
	`as£¹
(
t2
.
	`Œy_comm™
());

88 
t1
.
	`u£
();

89 
a
 = 
f
[5];

90 
	`as£¹
(
a
 == 5);

91 
	`as£¹
(!
t1
.
	`Œy_comm™
());

94 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

95 
	}
}

97 
	$‹¡CÚæiùšgI‹r
() {

98 
TA¼ay
<, 10> 
f
;

99 
TBox
<> 
box
;

100 
i
 = 0; i < 10; i++) {

101 
f
.
	`nÚŒªs_put
(
i
, i);

105 
Te¡T¿n§ùiÚ
 
	`t
(1);

106 
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
());

107 
box
 = 9;

109 
Te¡T¿n§ùiÚ
 
	`t1
(2);

110 
f
[4] = 10;

111 
	`as£¹
(
t1
.
	`Œy_comm™
());

112 
	`as£¹
(!
t
.
	`Œy_comm™
());

115 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

116 
	}
}

118 
	$‹¡ModifyšgI‹r
() {

119 
Te¡A¼ay
<, 10> 
f
;

120 
i
 = 0; i < 10; i++)

121 
f
.
	`nÚŒªs_put
(
i
, i);

124 
T¿n§ùiÚGu¬d
 
t
;

125 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

129 
T¿n§ùiÚGu¬d
 
t1
;

130 
v
 = 
f
[4];

131 
	`as£¹
(
v
 == 6);

134 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

135 
	}
}

137 
	$‹¡CÚæiùšgModifyI‹r1
() {

138 
TA¼ay
<, 10> 
f
;

139 
i
 = 0; i < 10; i++)

140 
f
.
	`nÚŒªs_put
(
i
, i);

143 
Te¡T¿n§ùiÚ
 
	`t
(1);

144 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

146 
Te¡T¿n§ùiÚ
 
	`t1
(2);

147 
f
[4] = 10;

149 
	`as£¹
(
t1
.
	`Œy_comm™
());

150 
	`as£¹
(!
t
.
	`Œy_comm™
());

154 
T¿n§ùiÚGu¬d
 
t2
;

155 
v
 = 
f
[4];

156 
	`as£¹
(
v
 == 10);

159 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

160 
	}
}

162 
	$‹¡CÚæiùšgModifyI‹r2
() {

163 
Te¡A¼ay
<, 10> 
f
;

164 
i
 = 0; i < 10; i++)

165 
f
.
	`nÚŒªs_put
(
i
, i);

168 
T¿n§ùiÚGu¬d
 
t
;

169 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

173 
T¿n§ùiÚGu¬d
 
t1
;

174 
f
[4] = 10;

178 
T¿n§ùiÚGu¬d
 
t2
;

179 
v
 = 
f
[4];

180 
	`as£¹
(
v
 == 10);

183 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

184 
	}
}

186 
	$‹¡CÚæiùšgModifyI‹r3
() {

187 
TA¼ay
<, 10> 
f
;

188 
TBox
<> 
box
;

189 
i
 = 0; i < 10; i++)

190 
f
.
	`nÚŒªs_put
(
i
, i);

193 
Te¡T¿n§ùiÚ
 
	`t1
(1);

194 
x
 = 
f
[4];

195 
	`as£¹
(
x
 == 4);

196 
box
 = 9;

198 
Te¡T¿n§ùiÚ
 
	`t
(2);

199 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

201 
	`as£¹
(
t
.
	`Œy_comm™
());

202 
	`as£¹
(!
t1
.
	`Œy_comm™
());

206 
T¿n§ùiÚGu¬d
 
t2
;

207 
v
 = 
f
[4];

208 
	`as£¹
(
v
 == 6);

211 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

212 
	}
}

215 
	$‹¡O·c™y1
() {

216 
TA¼ay
<, 10> 
f
;

217 
i
 = 0; i < 10; i++)

218 
f
.
	`nÚŒªs_put
(
i
, i);

220 
Œy
 {

221 
Te¡T¿n§ùiÚ
 
	`t1
(1);

222 
x
 = 
f
[3];

223 
	`as£¹
(
x
 == 3);

225 
Te¡T¿n§ùiÚ
 
	`t
(2);

226 
f
[3] = 2;

227 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

228 
	`as£¹
(
t
.
	`Œy_comm™
());

230 
t1
.
	`u£
();

231 
x
 = 
f
[4];

232 
	`as£¹
(
çl£
 && "shouldn't get here");

233 
	`as£¹
(
x
 == 6);

234 
	`as£¹
(!
t1
.
	`Œy_comm™
());

235 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

236 
Te¡T¿n§ùiÚ
::
	`h¬d_»£t
();

240 
T¿n§ùiÚGu¬d
 
t2
;

241 
v
 = 
f
[4];

242 
	`as£¹
(
v
 == 6);

245 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

246 
	}
}

248 
	$‹¡NoO·c™y1
() {

249 
TA¼ay
<, 10, 
TNÚİaqueW¿µed
> 
f
;

250 
i
 = 0; i < 10; i++)

251 
f
.
	`nÚŒªs_put
(
i
, i);

254 
Te¡T¿n§ùiÚ
 
	`t1
(1);

255 
x
 = 
f
[3];

256 
	`as£¹
(
x
 == 3);

258 
Te¡T¿n§ùiÚ
 
	`t
(2);

259 
f
[3] = 2;

260 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

261 
	`as£¹
(
t
.
	`Œy_comm™
());

263 
t1
.
	`u£
();

264 
x
 = 
f
[4];

265 
	`as£¹
(
x
 == 6);

266 
	`as£¹
(!
t1
.
	`Œy_comm™
());

270 
T¿n§ùiÚGu¬d
 
t2
;

271 
v
 = 
f
[4];

272 
	`as£¹
(
v
 == 6);

275 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

276 
	}
}

278 
	$b’chA¼ay64
() {

279 
TA¼ay
<, 64> 
a
;

280 
i
 = 0; i < 64; ++i)

281 
a
.
	`nÚŒªs_put
(
i
, 0);

283 cÚ¡ 
n™”s
 = 1000;

284 
befÜe
 = 
	`g‘time_d
();

285 
™”
 = 0; i‹¸< 
n™”s
; ++iter) {

286 
j
 = 0; j < 1000; ++j) {

287 
TRANSACTION_E
 {

288 
i
 = 0; i < 64; ++i)

289 
a
[
i
] =‡[i] + i;

290 } 
	`RETRY_E
(
Œue
);

293 
aá”
 = 
	`g‘time_d
();

295 
	`´štf
("NS PER ITER (™” = 1000tx): %g\n", (
aá”
 - 
befÜe
è* 1.0e9 / 
n™”s
);

296 
	}
}

298 
	$‹¡RWLock1
() {

299 
TA¼ayAd­tive
<, 10> 
f
;

300 
i
 = 0; i < 10; i++)

301 
f
.
	`nÚŒªs_put
(
i
, i);

303 
Te¡T¿n§ùiÚ
 
	`t0
(1);

304 
x
 = 
f
[3];

305 
	`as£¹
(
x
 == 3);

307 
Te¡T¿n§ùiÚ
 
	`t1
(2);

308 
y
 = 
f
[3];

309 
	`as£¹
(
y
 == 3);

311 
	`as£¹
(
t1
.
	`Œy_comm™
());

312 
	`as£¹
(
t0
.
	`Œy_comm™
());

315 
Te¡T¿n§ùiÚ
 
	`t0
(1);

316 
x
 = 
f
[3];

317 
	`as£¹
(
x
 == 3);

319 
Œy
 {

320 
Te¡T¿n§ùiÚ
 
	`t1
(2);

321 
f
[3] = 4;

322 
	`as£¹
(!
t1
.
	`Œy_comm™
());

323 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {}

325 
	`as£¹
(
t0
.
	`Œy_comm™
());

328 
Te¡T¿n§ùiÚ
 
	`t0
(1);

329 
f
[3] = 4;

331 
Œy
 {

332 
Te¡T¿n§ùiÚ
 
	`t1
(2);

333 
f
[3] = 5;

334 
	`as£¹
(!
t1
.
	`Œy_comm™
());

335 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {}

337 
	`as£¹
(
t0
.
	`Œy_comm™
());

339 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

340 
	}
}

342 
	$maš
() {

343 
	`‹¡Sim¶eIÁ
();

344 
	`‹¡Sim¶eSŒšg
();

345 
	`‹¡I‹r
();

346 
	`‹¡TicToc0
();

347 
	`‹¡CÚæiùšgI‹r
();

348 
	`‹¡ModifyšgI‹r
();

349 
	`‹¡CÚæiùšgModifyI‹r1
();

350 
	`‹¡CÚæiùšgModifyI‹r2
();

351 
	`‹¡CÚæiùšgModifyI‹r3
();

352 
	`‹¡O·c™y1
();

353 
	`‹¡NoO·c™y1
();

354 
	`b’chA¼ay64
();

355 
	`‹¡RWLock1
();

357 
	}
}

	@test/unit-tart-threads.hh

1 #undeà
NDEBUG


2 
	~<¡ršg
>

3 
	~<io¡»am
>

4 
	~<ÿs£¹
>

5 
	~<veùÜ
>

6 
	~"Sto.hh
"

7 
	~"TART.hh
"

8 
	~"T¿n§ùiÚ.hh
"

9 
	~<uni¡d.h
>

12 
	g¡d
::
¡ršg
 
ab£Ákey1
 = "absent";

13 
	g¡d
::
¡ršg
 
ab£Ákey2
 = "willbewritten";

14 
TART
 
	gaTART
;

16 
	$CËªATART
() {

18 
T¿n§ùiÚGu¬d
 
t
;

19 
aTART
.
	`”a£
(
ab£Ákey2
);

20 
aTART
.
	`”a£
(
ab£Ákey1
);

22 
	}
}

24 
	$R—dK1Wr™eK2
() {

26 
T¿n§ùiÚGu¬d
 
t
;

27 autØ
x
 = 
aTART
.
	`lookup
(
ab£Ákey1
);

28 
aTART
.
	`š£¹
(
ab£Ákey2
, 123);

29 
	`u¦“p
(1000);

31 
	}
}

33 
	$Wr™eK2
() {

36 
T¿n§ùiÚGu¬d
 
t
;

37 
aTART
.
	`š£¹
(
ab£Ákey2
, 456);

40 
	}
}

41 
	$D–ayWr™eK2
() {

43 
T¿n§ùiÚGu¬d
 
t
;

44 
	`u¦“p
(1000);

45 autØ
x
 = 
aTART
.
	`lookup
(
ab£Ákey2
);

46 
	`´štf
("looked u°ab£Á key 2 i %d\n", 
x
);

47 
aTART
.
	`š£¹
(
ab£Ákey2
, 123);

50 
	}
}

52 
	$Wr™eK1K2
() {

54 
T¿n§ùiÚGu¬d
 
t
;

55 
aTART
.
	`š£¹
(
ab£Ákey1
, 101112);

56 
aTART
.
	`š£¹
(
ab£Ákey1
, 131415);

58 
	}
}

60 
	$ABA1
() {

62 
Te¡T¿n§ùiÚ
 
	`t
(1);

63 autØ
x
 = 
aTART
.
	`lookup
(
ab£Ákey2
);

64 
aTART
.
	`š£¹
(
ab£Ákey1
, 123);

65 
	`u¦“p
(20000);

66 
	`´štf
("ABA1 TO COMMIT\n");

67 
	`as£¹
(!
t
.
	`Œy_comm™
());

68 
	}
}

70 
	$ABA2
() {

71 
Œy
 {

72 
T¿n§ùiÚGu¬d
 
t
;

73 
	`u¦“p
(1000);

74 
aTART
.
	`”a£
(
ab£Ákey2
);

75 
	`´štf
("ABA2 TO COMMIT\n");

76 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

77 
	`´štf
("aba 2‡bored\n");

79 
	`´štf
("ABA2 commited\n");

81 
	}
}

83 
	$ABA3
() {

84 
Œy
 {

85 
T¿n§ùiÚGu¬d
 
t
;

86 
	`u¦“p
(10000);

87 
aTART
.
	`š£¹
(
ab£Ákey2
, 456);

88 
	`´štf
("ABA3 TO COMMIT\n");

89 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

90 
	`´štf
("aba3‡borted\n");

92 
	}
}

	@test/unit-tart.cc

1 #undeà
NDEBUG


2 
	~<¡ršg
>

3 
	~<th»ad
>

4 
	~<io¡»am
>

5 
	~<ÿs£¹
>

6 
	~<veùÜ
>

7 
	~"Sto.hh
"

8 
	~"TART.hh
"

9 
	~"T¿n§ùiÚ.hh
"

10 
	~<uni¡d.h
>

11 
	~"un™-¹-th»ads.hh
"

13 
	#GUARDED
 ià(
T¿n§ùiÚGu¬d
 
tgu¬d
{})

	)

15 
	$‹¡Sim¶e
() {

16 
TART
 
a
;

18 
¡d
::
¡ršg
 
key1
 = "hello world";

19 
¡d
::
¡ršg
 
key2
 = "1234";

20 
	`´štf
("PASS -5: %s\n", 
__FUNCTION__
);

23 
T¿n§ùiÚGu¬d
 
t
;

24 
a
.
	`š£¹
(
key1
, 123);

25 
a
.
	`š£¹
(
key2
, 321);

27 
	`´štf
("PASS -4: %s\n", 
__FUNCTION__
);

30 
T¿n§ùiÚGu¬d
 
t
;

31 autØ
x
 = 
a
.
	`lookup
(
key1
);

32 autØ
y
 = 
a
.
	`lookup
(
key2
);

33 
	`as£¹
(
x
 == 123);

34 
	`as£¹
(
y
 == 321);

36 
	`´štf
("PASS -3: %s\n", 
__FUNCTION__
);

39 
T¿n§ùiÚGu¬d
 
t
;

40 
a
.
	`”a£
(
key1
);

41 autØ
x
 = 
a
.
	`lookup
(
key1
);

42 
	`as£¹
(
x
 == 0);

44 
	`´štf
("PASS -2: %s\n", 
__FUNCTION__
);

47 
T¿n§ùiÚGu¬d
 
t
;

48 autØ
x
 = 
a
.
	`lookup
(
key1
);

49 
	`as£¹
(
x
 == 0);

50 
a
.
	`š£¹
(
key1
, 567);

52 
	`´štf
("PASS -1: %s\n", 
__FUNCTION__
);

55 
T¿n§ùiÚGu¬d
 
t
;

56 autØ
x
 = 
a
.
	`lookup
(
key1
);

57 
	`as£¹
(
x
 == 567);

60 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

61 
	}
}

63 
	$‹¡E¿£
() {

64 
TART
 
a
;

66 
¡d
::
¡ršg
 
key1
 = "hello world";

70 
T¿n§ùiÚGu¬d
 
t
;

71 
a
.
	`”a£
(
key1
);

72 autØ
x
 = 
a
.
	`lookup
(
key1
);

73 
	`as£¹
(
x
 == 0);

77 
T¿n§ùiÚGu¬d
 
t
;

78 
a
.
	`”a£
(
key1
);

79 autØ
x
 = 
a
.
	`lookup
(
key1
);

80 
	`as£¹
(
x
 == 0);

81 
a
.
	`š£¹
(
key1
, 123);

82 
a
.
	`”a£
(
key1
);

83 
x
 = 
a
.
	`lookup
(
key1
);

84 
	`as£¹
(
x
 == 0);

87 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

89 
	}
}

91 
	$muÉiWr™e
() {

93 
T¿n§ùiÚGu¬d
 
t
;

94 
aTART
.
	`š£¹
(
ab£Ákey2
, 456);

98 
T¿n§ùiÚGu¬d
 
t
;

99 
aTART
.
	`š£¹
(
ab£Ákey2
, 123);

102 
T¿n§ùiÚGu¬d
 
t
;

103 autØ
x
 = 
aTART
.
	`lookup
(
ab£Ákey2
);

104 
	`as£¹
(
x
 == 123);

106 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

107 
	}
}

109 
	$Th»adWr™es1
() {

110 
¡d
::
th»ad
 
thr1
 = std::
	`th»ad
(
D–ayWr™eK2
);

111 
¡d
::
th»ad
 
thr2
 = std::
	`th»ad
(
Wr™eK2
);

112 
	`´štf
("to joinhr2\n");

113 
thr2
.
	`još
();

114 
	`´štf
("to joinhr1\n");

115 
thr1
.
	`još
();

116 
	`´štf
("joined\n");

120 
T¿n§ùiÚGu¬d
 
t
;

121 
	`´štf
("to†ookup\n");

122 autØ
x
 = 
aTART
.
	`lookup
(
ab£Ákey2
);

123 
	`´štf
("looked\n");

124 
	`as£¹
(
x
 == 123);

126 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

128 
	}
}

132 
	$ABA
() {

133 
	`´štf
("HI IM ABA\n");

135 
T¿n§ùiÚGu¬d
 
t
;

136 
aTART
.
	`š£¹
(
ab£Ákey2
, 456);

139 
¡d
::
th»ad
 
thr1
 = std::
	`th»ad
(
ABA1
);

140 
¡d
::
th»ad
 
thr2
 = std::
	`th»ad
(
ABA2
);

141 
¡d
::
th»ad
 
thr3
 = std::
	`th»ad
(
ABA3
);

142 
thr2
.
	`još
();

143 
thr3
.
	`još
();

144 
thr1
.
	`još
();

145 
	`´štf
("joined\n");

147 
Œy
 {

148 
T¿n§ùiÚGu¬d
 
t
;

149 autØ
x
 = 
aTART
.
	`lookup
(
ab£Ákey2
);

150 autØ
y
 = 
aTART
.
	`lookup
(
ab£Ákey1
);

151 
	`as£¹
(
x
 == 456);

152 
	`as£¹
(
y
 == 0);

153 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

154 
	`´štf
("main‡ba‡borted\n");

157 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

160 
	}
}

162 
	$Ab£Á1
() {

179 
	}
}

183 
	$Ab£Á2
() {

184 
¡d
::
th»ad
 
thr1
 = std::
	`th»ad
(
R—dK1Wr™eK2
);

185 
	`u¦“p
(10);

186 
¡d
::
th»ad
 
thr2
 = std::
	`th»ad
(
Wr™eK2
);

188 
T¿n§ùiÚGu¬d
 
t
;

189 autØ
x
 = 
aTART
.
	`lookup
(
ab£Ákey2
);

190 
	`as£¹
(
x
 == 123);

192 
	}
}

194 
	$‹¡R—dR—d
() {

195 
TART
 
¬t
;

197 
T¿n§ùiÚGu¬d
 
t
;

198 
¬t
.
	`š£¹
("hello", 4);

200 
	`´štf
("PASS -3: %s\n", 
__FUNCTION__
);

202 
Te¡T¿n§ùiÚ
 
	`t1
(0);

203 autØ
x
 = 
¬t
.
	`lookup
("hello");

204 
	`´štf
("PASS -2: %s\n", 
__FUNCTION__
);

206 
Te¡T¿n§ùiÚ
 
	`t2
(1);

207 autØ
y
 = 
¬t
.
	`lookup
("hello");

208 
	`´štf
("PASS -1: %s\n", 
__FUNCTION__
);

209 
	`as£¹
(
t2
.
	`Œy_comm™
());

211 
t1
.
	`u£
();

212 
	`as£¹
(
t1
.
	`Œy_comm™
());

213 
	`as£¹
(
x
 =ğ
y
);

214 
	`as£¹
(
x
 == 4);

215 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

216 
	}
}

218 
	$‹¡R—dWr™e
() {

219 
TART
 
¬t
;

221 
T¿n§ùiÚGu¬d
 
t
;

222 
¬t
.
	`š£¹
("hello", 4);

225 
Te¡T¿n§ùiÚ
 
	`t1
(0);

226 autØ
x
 = 
¬t
.
	`lookup
("hello");

227 
¬t
.
	`š£¹
("world", 1);

229 
Te¡T¿n§ùiÚ
 
	`t2
(1);

230 
¬t
.
	`š£¹
("hello", 6);

231 
	`as£¹
(
t2
.
	`Œy_comm™
());

232 
	`¦“p
(1);

233 
	`as£¹
(!
t1
.
	`Œy_comm™
());

236 
T¿n§ùiÚGu¬d
 
t
;

237 autØ
x
 = 
¬t
.
	`lookup
("world");

238 autØ
y
 = 
¬t
.
	`lookup
("hello");

239 
	`as£¹
(
y
 == 6);

242 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

243 
	}
}

245 
	$‹¡P”NodeV
() {

246 
TART
 
¬t
;

248 
T¿n§ùiÚGu¬d
 
t
;

249 
¬t
.
	`š£¹
("x", 1);

250 
¬t
.
	`š£¹
("y", 2);

251 
¬t
.
	`š£¹
("z", 3);

255 
T¿n§ùiÚGu¬d
 
t
;

256 autØ
x
 = 
¬t
.
	`lookup
("x");

257 autØ
y
 = 
¬t
.
	`lookup
("y");

258 autØ
z
 = 
¬t
.
	`lookup
("z");

259 
	`as£¹
(
x
 == 1);

260 
	`as£¹
(
y
 == 2);

261 
	`as£¹
(
z
 == 3);

264 
Te¡T¿n§ùiÚ
 
	`t1
(0);

265 autØ
x
 = 
¬t
.
	`lookup
("x");

266 
¬t
.
	`š£¹
("z", 13);

268 
Te¡T¿n§ùiÚ
 
	`t2
(1);

269 
¬t
.
	`š£¹
("y", 12);

270 
	`as£¹
(
t2
.
	`Œy_comm™
());

271 
	`as£¹
(
t1
.
	`Œy_comm™
());

274 
T¿n§ùiÚGu¬d
 
t
;

275 autØ
x
 = 
¬t
.
	`lookup
("x");

276 autØ
y
 = 
¬t
.
	`lookup
("y");

277 autØ
z
 = 
¬t
.
	`lookup
("z");

278 
	`as£¹
(
x
 == 1);

279 
	`as£¹
(
y
 == 12);

280 
	`as£¹
(
z
 == 13);

282 
	}
}

284 
	$maš
() {

285 
aTART
 = 
	`TART
();

287 
	`‹¡R—dWr™e
();

289 
	`‹¡R—dR—d
();

291 
	`‹¡Sim¶e
();

292 
	`‹¡E¿£
();

293 
	`muÉiWr™e
();

294 
	`CËªATART
();

296 
	`CËªATART
();

297 
	`ABA
();

298 
	`CËªATART
();

299 
	`‹¡P”NodeV
();

301 
	`´štf
("TARTests…ass\n");

304 
	}
}

	@test/unit-tbox.cc

1 #undeà
NDEBUG


2 
	~<¡ršg
>

3 
	~<io¡»am
>

4 
	~<ÿs£¹
>

5 
	~<veùÜ
>

6 
	~"Sto.hh
"

7 
	~"TBox.hh
"

11 
	#GUARDED
 ià(
T¿n§ùiÚGu¬d
 
tgu¬d
{})

	)

13 
	$‹¡Sim¶eIÁ
() {

14 
TBox
<> 
f
;

17 
T¿n§ùiÚGu¬d
 
t
;

18 
f
 = 100;

22 
T¿n§ùiÚGu¬d
 
t2
;

23 
f_»ad
 = 
f
;

24 
	`as£¹
(
f_»ad
 == 100);

27 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

28 
	}
}

30 
	$‹¡Sim¶eSŒšg
() {

31 
TBox
<
¡d
::
¡ršg
> 
f
;

34 
T¿n§ùiÚGu¬d
 
t
;

35 
f
 = "100";

39 
T¿n§ùiÚGu¬d
 
t2
;

40 
¡d
::
¡ršg
 
f_»ad
 = 
f
;

41 
	`as£¹
(
f_»ad
.
	`com·»
("100") == 0);

44 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

45 
	}
}

47 
	$‹¡CÚcu¼’tIÁ
() {

48 
TBox
<> 
ib
;

49 
TBox
<> 
box
;

50 
boŞ
 
m©ch
;

53 
Te¡T¿n§ùiÚ
 
	`t1
(1);

54 
m©ch
 = 
ib
 < 3;

55 
	`as£¹
(
m©ch
);

56 
box
 = 9;

58 
Te¡T¿n§ùiÚ
 
	`t2
(2);

59 
ib
 = 1;

60 
	`as£¹
(
t2
.
	`Œy_comm™
());

61 
	`as£¹
(!
t1
.
	`Œy_comm™
());

65 
Te¡T¿n§ùiÚ
 
	`t1
(1);

66 
ib
 = 1;

68 
Te¡T¿n§ùiÚ
 
	`t2
(2);

69 
ib
 = 2;

70 
	`as£¹
(
t2
.
	`Œy_comm™
());

71 
	`as£¹
(
t1
.
	`Œy_comm™
());

73 
	`as£¹
(
ib
.
	`nÚŒªs_»ad
() == 1);

76 
ib
.
	`nÚŒªs_wr™e
(2);

79 
Te¡T¿n§ùiÚ
 
	`t1
(1);

80 
m©ch
 = 
ib
 == 2;

81 
	`as£¹
(
m©ch
);

82 
box
 = 9;

84 
Te¡T¿n§ùiÚ
 
	`t2
(2);

85 
ib
 = 0;

86 
	`as£¹
(
t2
.
	`Œy_comm™
());

88 
Te¡T¿n§ùiÚ
 
	`t3
(3);

89 
ib
 = 2;

90 
	`as£¹
(
t3
.
	`Œy_comm™
());

91 
	`as£¹
(!
t1
.
	`Œy_comm™
());

94 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

95 
	}
}

99 
	$‹¡O·c™y1
() {

100 
TBox
<> 
f
, 
g
;

101 
TBox
<> 
box
;

102 
f
.
	`nÚŒªs_wr™e
(3);

104 
Œy
 {

105 
Te¡T¿n§ùiÚ
 
	`t1
(1);

106 
x
 = 
f
;

107 
	`as£¹
(
x
 == 3);

108 
box
 = 9;

110 
Te¡T¿n§ùiÚ
 
	`t
(2);

111 
f
 = 2;

112 
g
 = 4;

113 
	`as£¹
(
t
.
	`Œy_comm™
());

115 
t1
.
	`u£
();

116 
x
 = 
g
;

117 
	`as£¹
(
çl£
 && "shouldn't get here");

118 
	`as£¹
(
x
 == 4);

119 
	`as£¹
(!
t1
.
	`Œy_comm™
());

120 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

121 
Te¡T¿n§ùiÚ
::
	`h¬d_»£t
();

125 
T¿n§ùiÚGu¬d
 
t2
;

126 
v
 = 
f
;

127 
	`as£¹
(
v
 == 2);

130 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

131 
	}
}

133 
	$‹¡NoO·c™y1
() {

134 
TBox
<, 
TNÚİaqueW¿µed
<> > 
f
, 
g
;

135 
TBox
<, 
TNÚİaqueW¿µed
<> > 
box
;

136 
f
.
	`nÚŒªs_wr™e
(3);

139 
Te¡T¿n§ùiÚ
 
	`t1
(1);

140 
x
 = 
f
;

141 
	`as£¹
(
x
 == 3);

142 
box
 = 9;

144 
Te¡T¿n§ùiÚ
 
	`t
(2);

145 
f
 = 2;

146 
g
 = 4;

147 
	`as£¹
(
t
.
	`Œy_comm™
());

149 
t1
.
	`u£
();

150 
x
 = 
g
;

151 
	`as£¹
(
x
 == 4);

152 
	`as£¹
(!
t1
.
	`Œy_comm™
());

156 
T¿n§ùiÚGu¬d
 
t2
;

157 
v
 = 
f
;

158 
	`as£¹
(
v
 == 2);

161 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

162 
	}
}

165 
	$‹¡SŒšgW¿µ”
() {

166 
TBox
<
¡d
::
¡ršg
> 
f
;

168 
GUARDED
 {

169 
f
 = "100";

172 
	`as£¹
(
f
.
	`nÚŒªs_»ad
() == "100");

174 
GUARDED
 {

175 
¡d
::
¡ršg
 
	`x
("200");

177 
f
 = 
x
;

178 
	`as£¹
(
f
.
	`»ad
() == "200");

179 
	`as£¹
(
f
.
	`nÚŒªs_»ad
() == "100");

180 
	`as£¹
(
x
 == "200");

183 
	`as£¹
(
f
.
	`nÚŒªs_»ad
() == "200");

185 
GUARDED
 {

186 
¡d
::
¡ršg
 
	`x
("300");

188 
f
 = 
¡d
::
	`move
(
x
);

189 
	`as£¹
(
f
.
	`»ad
() == "300");

190 
	`as£¹
(
f
.
	`nÚŒªs_»ad
() == "200");

191 ià(
x
 != "")

192 
¡d
::
û¼
 << "move‡ssignmento string box did‚ot‡ppearo move\n"

194 
	`as£¹
(
x
 == "");

197 
	`as£¹
(
f
.
	`nÚŒªs_»ad
() == "300");

199 
GUARDED
 {

200 
f
 = "400";

201 
	`as£¹
(
f
.
	`»ad
().
	`com·»
("400") == 0);

204 
	`as£¹
(
f
.
	`nÚŒªs_»ad
() == "400");

206 
GUARDED
 {

207 
¡d
::
¡ršg
 
	`x
("500");

208 
f
 = 
x
;

209 
	`as£¹
(
f
.
	`»ad
().
	`com·»
("500") == 0);

210 
	`as£¹
(
Sto
::
	`™em
(&
f
, 0).
	`has_wr™e
());

212 
	`as£¹
(&
Sto
::
	`™em
(&
f
, 0).
wr™e_v®ue
<
¡d
::
¡ršg
>(è!ğ&
x
);

214 
x
 = "501";

216 
	`as£¹
(
f
.
	`»ad
().
	`com·»
("500") == 0);

219 
	`as£¹
(
f
.
	`nÚŒªs_»ad
() == "500");

225 
Te¡T¿n§ùiÚ
 
	`t
(1);

226 
¡d
::
¡ršg
 
	`x
("600");

227 
f
 = 
	`SŒšgW¿µ”
(
x
);

228 
	`as£¹
(
f
.
	`»ad
().
	`com·»
("600") == 0);

229 
	`as£¹
(
Sto
::
	`™em
(&
f
, 0).
	`has_wr™e
());

232 
	`as£¹
(&
Sto
::
	`™em
(&
f
, 0).
wr™e_v®ue
<
¡d
::
¡ršg
>(è=ğ&
x
);

234 
x
 = "601";

236 
	`as£¹
(
f
.
	`»ad
().
	`com·»
("601") == 0);

237 
	`as£¹
(
t
.
	`Œy_comm™
());

240 ià(
x
 != "")

241 
¡d
::
û¼
 << "commit of StringWrapper did‚ot‡ppearo move\n"

243 
	`as£¹
(
x
 == "");

246 
	`as£¹
(
f
.
	`nÚŒªs_»ad
() == "601");

248 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

249 
	}
}

252 
	$maš
() {

253 
	`‹¡Sim¶eIÁ
();

254 
	`‹¡Sim¶eSŒšg
();

255 
	`‹¡CÚcu¼’tIÁ
();

256 
	`‹¡O·c™y1
();

257 
	`‹¡NoO·c™y1
();

260 
	}
}

	@test/unit-tcounter.cc

1 #undeà
NDEBUG


2 
	~<¡ršg
>

3 
	~<io¡»am
>

4 
	~<as£¹.h
>

5 
	~<veùÜ
>

6 
	~<®gÜ™hm
>

7 
	~"T¿n§ùiÚ.hh
"

8 
	~"TCouÁ”.hh
"

9 
	~"TBox.hh
"

11 
	$‹¡TrivŸl
() {

12 
TCouÁ”
<> 
c
;

15 
T¿n§ùiÚGu¬d
 
t
;

16 
c
 = 1;

20 
T¿n§ùiÚGu¬d
 
t
;

21 
i_»ad
 = 
c
;

22 
	`as£¹
(
i_»ad
 == 1);

25 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

26 
	}
}

28 
	$‹¡CÚcu¼’tUpd©e
() {

29 
TCouÁ”
<> 
c
;

30 
boŞ
 
b
;

32 
¡d
::
veùÜ
<> 
³rmutiÚ
{1, 2, 3, 4};

34 
c
.
	`nÚŒªs_wr™e
(0);

36 
Te¡T¿n§ùiÚ
 
	`t1
(1);

37 ++
c
;

39 
Te¡T¿n§ùiÚ
 
	`t2
(2);

40 ++
c
;

42 
Te¡T¿n§ùiÚ
 
	`t3
(3);

43 
c
 -= 1;

45 
Te¡T¿n§ùiÚ
 
	`t4
(4);

46 
c
 += 5;

48 autØ
which
 : 
³rmutiÚ
)

49 
which
) {

51 
	`as£¹
(
t1
.
	`Œy_comm™
());

54 
	`as£¹
(
t2
.
	`Œy_comm™
());

57 
	`as£¹
(
t3
.
	`Œy_comm™
());

60 
	`as£¹
(
t4
.
	`Œy_comm™
());

64 
	`as£¹
(
c
.
	`nÚŒªs_»ad
() == 6);

65 } 
¡d
::
	`Ãxt_³rmutiÚ
(
³rmutiÚ
.
	`begš
(),…”mutiÚ.
	`’d
()));

68 
Te¡T¿n§ùiÚ
 
	`t1
(1);

69 
b
 = 
c
 >= 4;

70 
	`as£¹
(
b
);

71 
c
 += 4;

73 
Te¡T¿n§ùiÚ
 
	`t2
(2);

74 
c
 -= 2;

75 
	`as£¹
(
t2
.
	`Œy_comm™
());

77 
t1
.
	`u£
();

78 
b
 = 
c
 >= 8;

79 
	`as£¹
(
b
);

80 
	`as£¹
(
t1
.
	`Œy_comm™
());

81 
	`as£¹
(
c
.
	`nÚŒªs_»ad
() == 8);

84 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

85 
	}
}

87 
	$‹¡Sim¶eRªgesOk
() {

88 
TCouÁ”
<> 
c
;

89 
TBox
<> 
box
;

90 
boŞ
 
m©ch
;

93 
Te¡T¿n§ùiÚ
 
	`t1
(1);

94 ++
c
;

96 
Te¡T¿n§ùiÚ
 
	`t2
(2);

97 
c
 = 1;

98 
	`as£¹
(
t2
.
	`Œy_comm™
());

99 
t1
.
	`u£
();

100 
	`as£¹
(
t1
.
	`Œy_comm™
());

104 
Te¡T¿n§ùiÚ
 
	`t1
(1);

105 
m©ch
 = 
c
 > -4;

106 
	`as£¹
(
m©ch
);

107 
box
 = 9;

109 
Te¡T¿n§ùiÚ
 
	`t2
(2);

110 
c
 = -1;

111 
	`as£¹
(
t2
.
	`Œy_comm™
());

112 
	`as£¹
(
t1
.
	`Œy_comm™
());

115 
c
.
	`nÚŒªs_wr™e
(1);

118 
Te¡T¿n§ùiÚ
 
	`t1
(1);

119 
m©ch
 = 
c
 == 1;

120 
	`as£¹
(
m©ch
);

121 
box
 = 9;

123 
Te¡T¿n§ùiÚ
 
	`t2
(2);

124 
c
 = 2;

125 
	`as£¹
(
t2
.
	`Œy_comm™
());

127 
Te¡T¿n§ùiÚ
 
	`t3
(2);

128 
c
 = 1;

129 
	`as£¹
(
t3
.
	`Œy_comm™
());

131 
	`as£¹
(
t1
.
	`Œy_comm™
());

134 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

135 
	}
}

137 
	$‹¡Sim¶eRªgesFa
() {

138 
TCouÁ”
<> 
c
;

139 
TBox
<> 
box
;

140 
boŞ
 
m©ch
;

143 
Te¡T¿n§ùiÚ
 
	`t1
(1);

144 
m©ch
 = 
c
 < 3;

145 
	`as£¹
(
m©ch
);

146 
box
 = 9;

148 
Te¡T¿n§ùiÚ
 
	`t2
(2);

149 
c
 = 5;

150 
	`as£¹
(
t2
.
	`Œy_comm™
());

151 
	`as£¹
(!
t1
.
	`Œy_comm™
());

154 
c
.
	`nÚŒªs_wr™e
(0);

156 
Œy
 {

157 
Te¡T¿n§ùiÚ
 
	`t1
(1);

158 
m©ch
 = 
c
 < 3;

159 
	`as£¹
(
m©ch
);

160 
box
 = 9;

162 
Te¡T¿n§ùiÚ
 
	`t2
(2);

163 
c
 = 5;

164 
	`as£¹
(
t2
.
	`Œy_comm™
());

166 
t1
.
	`u£
();

167 
m©ch
 = 
c
 > 1;

168 
	`as£¹
(
çl£
 && "should‚ot get here b/c opacity");

169 
	`as£¹
(!
t1
.
	`Œy_comm™
());

170 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

171 
Te¡T¿n§ùiÚ
::
	`h¬d_»£t
();

174 
c
.
	`nÚŒªs_wr™e
(0);

176 
Œy
 {

177 
Te¡T¿n§ùiÚ
 
	`t1
(1);

178 
m©ch
 = 
c
 < 3;

179 
	`as£¹
(
m©ch
);

180 
box
 = 9;

182 
Te¡T¿n§ùiÚ
 
	`t2
(2);

183 
c
 = 5;

184 
	`as£¹
(
t2
.
	`Œy_comm™
());

186 
t1
.
	`u£
();

187 
m©ch
 = 
c
 > 1;

188 
	`as£¹
(
çl£
 && "should‚ot get here b/c opacity");

189 
	`as£¹
(
m©ch
);

191 
Te¡T¿n§ùiÚ
 
	`t3
(2);

192 
c
 = 2;

193 
	`as£¹
(
t3
.
	`Œy_comm™
());

194 
	`as£¹
(
t1
.
	`Œy_comm™
());

195 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

196 
Te¡T¿n§ùiÚ
::
	`h¬d_»£t
();

199 
c
.
	`nÚŒªs_wr™e
(4);

201 
Œy
 {

202 
Te¡T¿n§ùiÚ
 
	`t1
(1);

203 
m©ch
 = 
c
 > 1;

204 
	`as£¹
(
m©ch
);

205 
box
 = 9;

207 
Te¡T¿n§ùiÚ
 
	`t2
(2);

208 
c
 = 0;

209 
	`as£¹
(
t2
.
	`Œy_comm™
());

211 
t1
.
	`u£
();

212 
m©ch
 = 
c
 < 1;

213 
	`as£¹
(
çl£
 && "should‚ot get here");

214 
	`as£¹
(!
t1
.
	`Œy_comm™
());

215 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

216 
Te¡T¿n§ùiÚ
::
	`h¬d_»£t
();

219 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

220 
	}
}

222 
	$‹¡Sim¶eRªgesFaNoO·c™y
() {

223 
TCouÁ”
<, 
TNÚİaqueW¿µed
<> > 
c
;

224 
TBox
<> 
box
;

225 
boŞ
 
m©ch
;

228 
Te¡T¿n§ùiÚ
 
	`t1
(1);

229 
m©ch
 = 
c
 < 3;

230 
	`as£¹
(
m©ch
);

231 
box
 = 9;

233 
Te¡T¿n§ùiÚ
 
	`t2
(2);

234 
c
 = 5;

235 
	`as£¹
(
t2
.
	`Œy_comm™
());

236 
	`as£¹
(!
t1
.
	`Œy_comm™
());

239 
c
.
	`nÚŒªs_wr™e
(0);

241 
Œy
 {

242 
Te¡T¿n§ùiÚ
 
	`t1
(1);

243 
m©ch
 = 
c
 < 3;

244 
	`as£¹
(
m©ch
);

245 
box
 = 9;

247 
Te¡T¿n§ùiÚ
 
	`t2
(2);

248 
c
 = 5;

249 
	`as£¹
(
t2
.
	`Œy_comm™
());

251 
t1
.
	`u£
();

252 
m©ch
 = 
c
 > 1;

253 
	`as£¹
(!
t1
.
	`Œy_comm™
());

254 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

255 
Te¡T¿n§ùiÚ
::
	`h¬d_»£t
();

258 
c
.
	`nÚŒªs_wr™e
(0);

260 
Œy
 {

261 
Te¡T¿n§ùiÚ
 
	`t1
(1);

262 
m©ch
 = 
c
 < 3;

263 
	`as£¹
(
m©ch
);

264 
box
 = 9;

266 
Te¡T¿n§ùiÚ
 
	`t2
(2);

267 
c
 = 5;

268 
	`as£¹
(
t2
.
	`Œy_comm™
());

270 
t1
.
	`u£
();

271 
m©ch
 = 
c
 > 1;

272 
	`as£¹
(
m©ch
);

274 
Te¡T¿n§ùiÚ
 
	`t3
(2);

275 
c
 = 2;

276 
	`as£¹
(
t3
.
	`Œy_comm™
());

277 
	`as£¹
(
t1
.
	`Œy_comm™
());

278 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

279 
Te¡T¿n§ùiÚ
::
	`h¬d_»£t
();

282 
c
.
	`nÚŒªs_wr™e
(4);

284 
Œy
 {

285 
Te¡T¿n§ùiÚ
 
	`t1
(1);

286 
m©ch
 = 
c
 > 1;

287 
	`as£¹
(
m©ch
);

288 
box
 = 9;

290 
Te¡T¿n§ùiÚ
 
	`t2
(2);

291 
c
 = 0;

292 
	`as£¹
(
t2
.
	`Œy_comm™
());

294 
t1
.
	`u£
();

295 
m©ch
 = 
c
 < 1;

296 
	`as£¹
(!
t1
.
	`Œy_comm™
());

297 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

298 
Te¡T¿n§ùiÚ
::
	`h¬d_»£t
();

301 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

302 
	}
}

304 
	$‹¡Upd©eR—d
() {

305 
TCouÁ”
<> 
c
;

306 
TBox
<> 
box
;

307 
boŞ
 
m©ch
;

310 
Te¡T¿n§ùiÚ
 
	`t1
(1);

311 ++
c
;

312 
m©ch
 = 
c
 > 0;

313 
	`as£¹
(
m©ch
);

315 
Te¡T¿n§ùiÚ
 
	`t2
(2);

316 
c
 = 1;

317 
	`as£¹
(
t2
.
	`Œy_comm™
());

318 
	`as£¹
(
t1
.
	`Œy_comm™
());

321 
	`as£¹
(
c
.
	`nÚŒªs_»ad
() == 2);

324 
Te¡T¿n§ùiÚ
 
	`t1
(1);

325 ++
c
;

326 
m©ch
 = 
c
 > 0;

327 
	`as£¹
(
m©ch
);

329 
Te¡T¿n§ùiÚ
 
	`t2
(2);

330 
c
 = -1;

331 
	`as£¹
(
t2
.
	`Œy_comm™
());

332 
	`as£¹
(!
t1
.
	`Œy_comm™
());

335 
	`as£¹
(
c
.
	`nÚŒªs_»ad
() == -1);

337 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

338 
	}
}

340 
	$‹¡O·c™y
() {

341 
TCouÁ”
<> 
c1
, 
c2
;

342 
boŞ
 
m©ch
;

344 
Œy
 {

345 
Te¡T¿n§ùiÚ
 
	`t1
(1);

346 ++
c1
;

347 
m©ch
 = 
c1
 > 0;

348 
	`as£¹
(
m©ch
);

350 
Te¡T¿n§ùiÚ
 
	`t2
(2);

351 
c2
 = 5;

352 --
c1
;

353 
	`as£¹
(
t2
.
	`Œy_comm™
());

355 
t1
.
	`u£
();

356 
m©ch
 = 
c2
 > 4;

357 
	`as£¹
(
çl£
 && "shouldn't get here");

358 
	`as£¹
(
m©ch
);

359 
	`as£¹
(!
t1
.
	`Œy_comm™
());

360 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

361 
Te¡T¿n§ùiÚ
::
	`h¬d_»£t
();

365 
T¿n§ùiÚGu¬d
 
g
;

366 
m©ch
 = 
c2
 > 4;

367 
	`as£¹
(
m©ch
);

370 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

371 
	}
}

373 
	$‹¡NoO·c™y
() {

374 
TCouÁ”
<, 
TNÚİaqueW¿µed
<> > 
c1
, 
c2
;

375 
boŞ
 
m©ch
;

377 
Œy
 {

378 
Te¡T¿n§ùiÚ
 
	`t1
(1);

379 ++
c1
;

380 
m©ch
 = 
c1
 > 0;

381 
	`as£¹
(
m©ch
);

383 
Te¡T¿n§ùiÚ
 
	`t2
(2);

384 
c2
 = 5;

385 --
c1
;

386 
	`as£¹
(
t2
.
	`Œy_comm™
());

388 
t1
.
	`u£
();

389 
m©ch
 = 
c2
 > 4;

390 
	`as£¹
(
m©ch
);

391 
	`as£¹
(!
t1
.
	`Œy_comm™
());

392 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

393 
Te¡T¿n§ùiÚ
::
	`h¬d_»£t
();

397 
T¿n§ùiÚGu¬d
 
g
;

398 
m©ch
 = 
c2
 > 4;

399 
	`as£¹
(
m©ch
);

402 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

403 
	}
}

405 
	$maš
() {

406 
	`‹¡TrivŸl
();

407 
	`‹¡CÚcu¼’tUpd©e
();

408 
	`‹¡Sim¶eRªgesOk
();

409 
	`‹¡Sim¶eRªgesFa
();

410 
	`‹¡Sim¶eRªgesFaNoO·c™y
();

411 
	`‹¡Upd©eR—d
();

412 
	`‹¡O·c™y
();

413 
	`‹¡NoO·c™y
();

415 
	}
}

	@test/unit-tflexarray.cc

1 
	~"TFËxA¼ay.hh
"

2 
	~<io¡»am
>

4 
	$‹¡_compe
() {

5 
cÚ¡ex´
 
sz
 = 1000;

6 
TOCCA¼ay
<
ušt64_t
 , 
sz
> 
occ_¬¿y
;

7 
TAd­tiveA¼ay
<
ušt64_t
 , 
sz
> 
lock_¬¿y
;

8 
TSwissA¼ay
<
ušt64_t
 , 
sz
> 
swiss_¬¿y
;

9 
TicTocA¼ay
<
ušt64_t
, 
sz
> 
tiùoc_¬¿y
;

12 
T¿n§ùiÚGu¬d
 
gu¬d
;

13 
i
 = 0; i < 10; ++i) {

14 
boŞ
 
ok
 = 
occ_¬¿y
.
	`ŒªsPut
(
i
, 
	`ušt64_t
(i));

15 
	`as£¹
(
ok
);

16 
ok
 = 
lock_¬¿y
.
	`ŒªsPut
(
i
, 
	`ušt64_t
(i));

17 
	`as£¹
(
ok
);

18 
ok
 = 
swiss_¬¿y
.
	`ŒªsPut
(
i
, 
	`ušt64_t
(i));

19 
	`as£¹
(
ok
);

20 
ok
 = 
tiùoc_¬¿y
.
	`ŒªsPut
(
i
, 
	`ušt64_t
(i));

21 
	`as£¹
(
ok
);

26 
T¿n§ùiÚGu¬d
 
gu¬d
;

27 
i
 = 0; i < 10; ++i) {

28 
ušt64_t
 
v®
;

29 
boŞ
 
ok
 = 
occ_¬¿y
.
	`ŒªsG‘
(
i
, 
v®
);

30 
	`as£¹
(
ok
 && 
v®
 =ğ
	`ušt64_t
(
i
));

31 
ok
 = 
lock_¬¿y
.
	`ŒªsG‘
(
i
, 
v®
);

32 
	`as£¹
(
ok
 && 
v®
 =ğ
	`ušt64_t
(
i
));

33 
ok
 = 
swiss_¬¿y
.
	`ŒªsG‘
(
i
, 
v®
);

34 
	`as£¹
(
ok
 && 
v®
 =ğ
	`ušt64_t
(
i
));

35 
ok
 = 
tiùoc_¬¿y
.
	`ŒªsG‘
(
i
, 
v®
);

36 
	`as£¹
(
ok
 && 
v®
 =ğ
	`ušt64_t
(
i
));

39 
¡d
::
cout
 << "PASS: " << std::
	`¡ršg
(
__FUNCTION__
è<< std::
’dl
;

40 
	}
}

42 
	$‹¡_tiùoc0
() {

43 
TOCCA¼ay
<, 10> 
¬¿y
;

44 
i
 = 0; i < 10; ++i)

45 
¬¿y
.
	`nÚŒªs_put
(
i
, i);

47 
Te¡T¿n§ùiÚ
 
	`t1
(1);

48 
a
;

49 
boŞ
 
ok
 = 
¬¿y
.
	`ŒªsG‘
(4, 
a
);

50 
	`as£¹
(
ok
 && 
a
 == 4);

52 
Te¡T¿n§ùiÚ
 
	`t2
(2);

53 
ok
 = 
¬¿y
.
	`ŒªsPut
(4, 5);

54 
	`as£¹
(
ok
 && 
t2
.
	`Œy_comm™
());

55 
t1
.
	`u£
();

56 
ok
 = 
¬¿y
.
	`ŒªsG‘
(5, 
a
);

57 
	`as£¹
(
ok
 && 
a
 == 5);

58 
	`as£¹
(!
t1
.
	`Œy_comm™
());

60 
¡d
::
cout
 << "PASS: " << std::
	`¡ršg
(
__FUNCTION__
è<< std::
’dl
;

61 
	}
}

63 
	$‹¡_tiùoc1
() {

64 
TicTocA¼ay
<, 10> 
¬¿y
;

65 
i
 = 0; i < 10; ++i)

66 
¬¿y
.
	`nÚŒªs_put
(
i
, i);

68 
Te¡T¿n§ùiÚ
 
	`t1
(1);

69 
a
;

70 
boŞ
 
ok
 = 
¬¿y
.
	`ŒªsG‘
(4, 
a
);

71 
	`as£¹
(
ok
 && 
a
 == 4);

73 
Te¡T¿n§ùiÚ
 
	`t2
(2);

74 
ok
 = 
¬¿y
.
	`ŒªsPut
(4, 5);

75 
	`as£¹
(
ok
 && 
t2
.
	`Œy_comm™
());

76 
t1
.
	`u£
();

77 
ok
 = 
¬¿y
.
	`ŒªsG‘
(5, 
a
);

78 
	`as£¹
(
ok
 && 
a
 == 5);

79 
	`as£¹
(
t1
.
	`Œy_comm™
());

81 
¡d
::
cout
 << "PASS: " << std::
	`¡ršg
(
__FUNCTION__
è<< std::
’dl
;

82 
	}
}

84 
	$‹¡_tiùoc2
() {

85 
TicTocA¼ay
<, 10> 
¬¿y
;

86 
i
 = 0; i < 10; ++i)

87 
¬¿y
.
	`nÚŒªs_put
(
i
, i);

89 
Te¡T¿n§ùiÚ
 
	`t1
(1);

90 
a
;

91 
boŞ
 
ok
 = 
¬¿y
.
	`ŒªsG‘
(4, 
a
);

92 
	`as£¹
(
ok
 && 
a
 == 4);

94 
Te¡T¿n§ùiÚ
 
	`t2
(2);

95 
b
;

96 
ok
 = 
¬¿y
.
	`ŒªsG‘
(4, 
b
);

97 
	`as£¹
(
ok
 && 
b
 == 4);

99 
t1
.
	`u£
();

100 
¬¿y
.
	`ŒªsPut
(4, 
a
+1);

101 
	`as£¹
(
ok
 && 
t1
.
	`Œy_comm™
());

103 
t2
.
	`u£
();

104 
ok
 = 
¬¿y
.
	`ŒªsPut
(4, 
b
+1);

105 
	`as£¹
(
ok
 && !
t2
.
	`Œy_comm™
());

107 
¡d
::
cout
 << "PASS: " << std::
	`¡ršg
(
__FUNCTION__
è<< std::
’dl
;

108 
	}
}

110 
	$maš
() {

111 
	`‹¡_compe
();

112 
	`‹¡_tiùoc0
();

113 
	`‹¡_tiùoc1
();

114 
	`‹¡_tiùoc2
();

115 
¡d
::
cout
 << "ALL TESTS PASS!" << std::
’dl
;

117 
	}
}

	@test/unit-tgeneric.cc

1 #undeà
NDEBUG


2 
	~<¡ršg
>

3 
	~<io¡»am
>

4 
	~<as£¹.h
>

5 
	~<veùÜ
>

6 
	~"T¿n§ùiÚ.hh
"

7 
	~"TG’”ic.hh
"

9 
	$‹¡Sim¶eIÁ
() {

10 
TG’”ic
 
f
;

11 
f1
 = 0;

14 
T¿n§ùiÚGu¬d
 
t
;

15 
f
.
	`wr™e
(&
f1
, 100);

19 
T¿n§ùiÚGu¬d
 
t2
;

20 
f_»ad
 = 
f
.
	`»ad
(&
f1
);

21 
	`as£¹
(
f_»ad
 == 100);

24 
	`as£¹
(
f1
 == 100);

26 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

27 
	}
}

29 
	$‹¡O·c™y1
() {

30 
f
[10];

31 
i
 = 0; i < 10; i++)

32 
f
[
i
] = i;

33 
TG’”ic
 
g
;

35 
Œy
 {

36 
Te¡T¿n§ùiÚ
 
	`t1
(1);

37 
x
 = 
g
.
	`»ad
(&
f
[3]);

38 
	`as£¹
(
x
 == 3);

40 
Te¡T¿n§ùiÚ
 
	`t
(2);

41 
g
.
	`wr™e
(&
f
[3], 2);

42 
g
.
	`wr™e
(&
f
[4], 6);

43 
	`as£¹
(
t
.
	`Œy_comm™
());

45 
t1
.
	`u£
();

46 
x
 = 
g
.
	`»ad
(&
f
[4]);

47 
	`as£¹
(
çl£
 && "shouldn't get here");

48 
	`as£¹
(
x
 == 6);

49 
	`as£¹
(!
t1
.
	`Œy_comm™
());

50 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

54 
T¿n§ùiÚGu¬d
 
t2
;

55 
v
 = 
g
.
	`»ad
(&
f
[4]);

56 
	`as£¹
(
v
 == 6);

57 
	`as£¹
(
f
[4] == 6);

60 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

61 
	}
}

63 
	$‹¡NoO·c™y1
() {

64 
f
[10];

65 
i
 = 0; i < 10; i++)

66 
f
[
i
] = i;

67 
TNÚİaqueG’”ic
 
g
;

70 
Te¡T¿n§ùiÚ
 
	`t1
(1);

71 
x
 = 
g
.
	`»ad
(&
f
[3]);

72 
	`as£¹
(
x
 == 3);

74 
Te¡T¿n§ùiÚ
 
	`t
(2);

75 
g
.
	`wr™e
(&
f
[3], 2);

76 
g
.
	`wr™e
(&
f
[4], 6);

77 
	`as£¹
(
t
.
	`Œy_comm™
());

79 
t1
.
	`u£
();

80 
x
 = 
g
.
	`»ad
(&
f
[4]);

81 
	`as£¹
(
x
 == 6);

82 
	`as£¹
(!
t1
.
	`Œy_comm™
());

86 
T¿n§ùiÚGu¬d
 
t2
;

87 
v
 = 
g
.
	`»ad
(&
f
[4]);

88 
	`as£¹
(
v
 == 6);

89 
	`as£¹
(
f
[4] == 6);

92 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

93 
	}
}

95 
	$‹¡V¬ŸbËSizes
() {

97 
a
;

98 
b
;

99 
c
;

100 
d
;

101 } 
foo
 = { 100, 1, 2, 3 };

102 
TG’”ic
 
g
;

105 
Te¡T¿n§ùiÚ
 
	`t1
(1);

106 
x
 = 
g
.
	`»ad
(&
foo
.
a
);

107 
	`as£¹
(
x
 == 100);

108 
x
 = 
g
.
	`»ad
(&
foo
.
b
);

109 
	`as£¹
(
x
 == 1);

110 
g
.
	`wr™e
(&
foo
.
b
, 10);

111 
g
.
	`wr™e
(&
foo
.
a
, 10000);

112 
g
.
	`wr™e
(&
foo
.
d
, 99);

113 
	`as£¹
(
foo
.
a
 == 100);

114 
	`as£¹
(
foo
.
b
 == 1);

115 
	`as£¹
(
foo
.
d
 == 3);

116 
x
 = 
g
.
	`»ad
(&
foo
.
a
);

117 
	`as£¹
(
x
 == 10000);

118 
x
 = 
g
.
	`»ad
(&
foo
.
b
);

119 
	`as£¹
(
x
 == 10);

120 
x
 = 
g
.
	`»ad
(&
foo
.
c
);

121 
	`as£¹
(
x
 == 2);

122 
x
 = 
g
.
	`»ad
(&
foo
.
d
);

123 
	`as£¹
(
x
 == 99);

124 
	`as£¹
(
t1
.
	`Œy_comm™
());

126 
	`as£¹
(
foo
.
a
 == 10000);

127 
	`as£¹
(
foo
.
b
 == 10);

128 
	`as£¹
(
foo
.
c
 == 2);

129 
	`as£¹
(
foo
.
d
 == 99);

132 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

133 
	}
}

135 
	$maš
() {

136 
	`‹¡Sim¶eIÁ
();

137 
	`‹¡O·c™y1
();

138 
	`‹¡NoO·c™y1
();

139 
	`‹¡V¬ŸbËSizes
();

141 
	}
}

	@test/unit-tint.cc

1 #undeà
NDEBUG


2 
	~<¡ršg
>

3 
	~<io¡»am
>

4 
	~<ÿs£¹
>

5 
	~<veùÜ
>

6 
	~"Sto.hh
"

7 
	~"TIÁ.hh
"

8 
	~"T¿n§ùiÚ.hh
"

12 
	#GUARDED
 ià(
T¿n§ùiÚGu¬d
 
tgu¬d
{})

	)

14 
	$‹¡Sim¶eIÁ
() {

15 
TIÁ
 
f
;

18 
T¿n§ùiÚGu¬d
 
t
;

19 
f
 = 100;

23 
T¿n§ùiÚGu¬d
 
t2
;

24 
f_»ad
 = 
f
;

25 
	`as£¹
(
f_»ad
 == 100);

28 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

29 
	}
}

31 
	$‹¡Inüem’t
() {

32 
TIÁ
 
f
;

35 
T¿n§ùiÚGu¬d
 
t
;

36 
f
 = 100;

37 
f
.
	`šc
(1);

38 
f_»ad
 = 
f
;

39 
	`as£¹
(
f_»ad
 == 101);

40 
f
 = 10;

41 
	`as£¹
(
f
 == 10);

43 
f
.
	`šc
(1);

44 
f
 = f + 1;

45 
	`as£¹
(
f
 == 12);

46 
f
.
	`šc
(1);

47 
f
.
	`šc
(1);

51 
T¿n§ùiÚGu¬d
 
t2
;

52 
f_»ad
 = 
f
;

53 
	`as£¹
(
f_»ad
 == 14);

56 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

57 
	}
}

59 
	$‹¡1
() {

60 
TIÁ
 
x
;

63 
T¿n§ùiÚGu¬d
 
t
;

64 
x
 = 0;

68 
T¿n§ùiÚGu¬d
 
t
;

69 
tmp
 = 
x
;

70 
x
.
	`šc
(1);

71 
	`as£¹
(
tmp
 == 0);

75 
T¿n§ùiÚGu¬d
 
t
;

76 
	`as£¹
(
x
 == 1);

77 
x
 = 0;

81 
T¿n§ùiÚGu¬d
 
t
;

82 
x
.
	`šc
(1);

83 
tmp
 = 
x
;

84 
	`as£¹
(
tmp
 == 1);

88 
T¿n§ùiÚGu¬d
 
t
;

89 
	`as£¹
(
x
 == 1);

90 
x
 = 0;

94 
T¿n§ùiÚGu¬d
 
t
;

95 
x
.
	`šc
(1);

99 
T¿n§ùiÚGu¬d
 
t
;

100 
	`as£¹
(
x
 == 1);

101 
x
 = 0;

105 
T¿n§ùiÚGu¬d
 
t
;

106 
x
 = 5;

107 
x
.
	`šc
(1);

111 
T¿n§ùiÚGu¬d
 
t
;

112 
	`as£¹
(
x
 == 6);

113 
x
 = 0;

117 
T¿n§ùiÚGu¬d
 
t
;

118 
x
.
	`šc
(1);

119 
x
.
	`šc
(1);

120 
x
.
	`šc
(1);

124 
T¿n§ùiÚGu¬d
 
t
;

125 
	`as£¹
(
x
 == 3);

126 
x
 = 0;

130 
T¿n§ùiÚGu¬d
 
t
;

131 
x
 = 5;

132 
x
.
	`šc
(1);

133 
tmp
 = 
x
;

134 
	`as£¹
(
tmp
 == 6);

138 
T¿n§ùiÚGu¬d
 
t
;

139 
	`as£¹
(
x
 == 6);

140 
x
 = 0;

144 
T¿n§ùiÚGu¬d
 
t
;

145 
x
.
	`šc
(1);

146 
x
 = 5;

150 
T¿n§ùiÚGu¬d
 
t
;

151 
	`as£¹
(
x
 == 5);

152 
x
 = 0;

156 
T¿n§ùiÚGu¬d
 
t
;

157 
x
.
	`šc
(1);

158 
x
 = 5;

159 
x
.
	`šc
(1);

163 
T¿n§ùiÚGu¬d
 
t
;

164 
	`as£¹
(
x
 == 6);

167 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

168 
	}
}

170 
	$maš
() {

171 
	`‹¡Sim¶eIÁ
();

172 
	`‹¡Inüem’t
();

173 
	`‹¡1
();

175 
	}
}

	@test/unit-tintpredicate.cc

1 #undeà
NDEBUG


2 
	~<¡ršg
>

3 
	~<io¡»am
>

4 
	~<as£¹.h
>

5 
	~<veùÜ
>

6 
	~"T¿n§ùiÚ.hh
"

7 
	~"TIÁP»diÿ‹.hh
"

8 
	~"SŒšgW¿µ”.hh
"

9 
	~"TBox.hh
"

11 
	$‹¡TrivŸl
() {

12 
TIÁP»diÿ‹
<> 

;

15 
T¿n§ùiÚGu¬d
 
t
;

16 

 = 1;

20 
T¿n§ùiÚGu¬d
 
t
;

21 
i_»ad
 = 

;

22 
	`as£¹
(
i_»ad
 == 1);

25 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

26 
	}
}

28 
	$‹¡Sim¶eRªgesOk
() {

29 
TIÁP»diÿ‹
<> 

;

30 
TBox
<> 
box
;

31 
boŞ
 
m©ch
;

34 
Te¡T¿n§ùiÚ
 
	`t1
(1);

35 
m©ch
 = 

 < 3;

36 
	`as£¹
(
m©ch
);

37 
box
 = 9;

39 
Te¡T¿n§ùiÚ
 
	`t2
(2);

40 

 = 1;

41 
	`as£¹
(
t2
.
	`Œy_comm™
());

42 
	`as£¹
(
t1
.
	`Œy_comm™
());

46 
Te¡T¿n§ùiÚ
 
	`t1
(1);

47 
m©ch
 = 

 < 0;

48 
	`as£¹
(!
m©ch
);

49 
box
 = 9;

51 
Te¡T¿n§ùiÚ
 
	`t2
(2);

52 

 = 0;

53 
	`as£¹
(
t2
.
	`Œy_comm™
());

54 
	`as£¹
(
t1
.
	`Œy_comm™
());

58 
Te¡T¿n§ùiÚ
 
	`t1
(1);

59 
m©ch
 = 

 > -1;

60 
	`as£¹
(
m©ch
);

61 
box
 = 9;

63 
Te¡T¿n§ùiÚ
 
	`t2
(2);

64 

 = -1;

65 
	`as£¹
(
t2
.
	`Œy_comm™
());

66 
	`as£¹
(!
t1
.
	`Œy_comm™
());

70 
Te¡T¿n§ùiÚ
 
	`t1
(1);

71 
m©ch
 = 

 > 0;

72 
	`as£¹
(!
m©ch
);

73 
box
 = 9;

75 
Te¡T¿n§ùiÚ
 
	`t2
(2);

76 

 = 0;

77 
	`as£¹
(
t2
.
	`Œy_comm™
());

78 
	`as£¹
(
t1
.
	`Œy_comm™
());

82 
Te¡T¿n§ùiÚ
 
	`t1
(1);

83 
m©ch
 = 

 >= 0;

84 
	`as£¹
(
m©ch
);

85 
m©ch
 = 

 < 4;

86 
	`as£¹
(
m©ch
);

87 
box
 = 9;

89 
Te¡T¿n§ùiÚ
 
	`t2
(2);

90 

 = 3;

91 
	`as£¹
(
t2
.
	`Œy_comm™
());

92 
	`as£¹
(
t1
.
	`Œy_comm™
());

96 
Te¡T¿n§ùiÚ
 
	`t1
(1);

97 
m©ch
 = 

 >= 0;

98 
	`as£¹
(
m©ch
);

99 
m©ch
 = 

 < 4;

100 
	`as£¹
(
m©ch
);

101 
box
 = 9;

103 
Te¡T¿n§ùiÚ
 
	`t2
(2);

104 

 = -1;

105 
	`as£¹
(
t2
.
	`Œy_comm™
());

106 
	`as£¹
(!
t1
.
	`Œy_comm™
());

109 

.
	`nÚŒªs_wr™e
(3);

112 
Te¡T¿n§ùiÚ
 
	`t1
(1);

113 
m©ch
 = 

 >= 0;

114 
	`as£¹
(
m©ch
);

115 
m©ch
 = 

 < 4;

116 
	`as£¹
(
m©ch
);

117 
box
 = 9;

119 
Te¡T¿n§ùiÚ
 
	`t2
(2);

120 

 = 4;

121 
	`as£¹
(
t2
.
	`Œy_comm™
());

122 
	`as£¹
(!
t1
.
	`Œy_comm™
());

126 
Te¡T¿n§ùiÚ
 
	`t1
(1);

127 
m©ch
 = 

 > -4;

128 
	`as£¹
(
m©ch
);

129 
box
 = 9;

131 
Te¡T¿n§ùiÚ
 
	`t2
(2);

132 

 = -1;

133 
	`as£¹
(
t2
.
	`Œy_comm™
());

134 
	`as£¹
(
t1
.
	`Œy_comm™
());

137 

.
	`nÚŒªs_wr™e
(1);

140 
Te¡T¿n§ùiÚ
 
	`t1
(1);

141 
m©ch
 = 

 == 1;

142 
	`as£¹
(
m©ch
);

143 
box
 = 9;

145 
Te¡T¿n§ùiÚ
 
	`t2
(2);

146 

 = 2;

147 
	`as£¹
(
t2
.
	`Œy_comm™
());

149 
Te¡T¿n§ùiÚ
 
	`t3
(2);

150 

 = 1;

151 
	`as£¹
(
t3
.
	`Œy_comm™
());

153 
	`as£¹
(
t1
.
	`Œy_comm™
());

156 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

157 
	}
}

159 
	$‹¡Sim¶eRªgesFa
() {

160 
TIÁP»diÿ‹
<> 

;

161 
TBox
<> 
box
;

162 
boŞ
 
m©ch
;

165 
Te¡T¿n§ùiÚ
 
	`t1
(1);

166 
m©ch
 = 

 < 3;

167 
	`as£¹
(
m©ch
);

168 
box
 = 9;

170 
Te¡T¿n§ùiÚ
 
	`t2
(2);

171 

 = 5;

172 
	`as£¹
(
t2
.
	`Œy_comm™
());

174 
	`as£¹
(!
t1
.
	`Œy_comm™
());

177 

.
	`nÚŒªs_wr™e
(0);

180 
Te¡T¿n§ùiÚ
 
	`t1
(1);

181 
m©ch
 = 

 < 3;

182 
	`as£¹
(
m©ch
);

183 
box
 = 9;

185 
Te¡T¿n§ùiÚ
 
	`t2
(2);

186 

 = 5;

187 
	`as£¹
(
t2
.
	`Œy_comm™
());

189 
t1
.
	`u£
();

190 
m©ch
 = 

 > 1;

193 
	`as£¹
(!
t1
.
	`Œy_comm™
());

196 

.
	`nÚŒªs_wr™e
(0);

199 
Te¡T¿n§ùiÚ
 
	`t1
(1);

200 
m©ch
 = 

 < 3;

201 
	`as£¹
(
m©ch
);

202 
box
 = 9;

204 
Te¡T¿n§ùiÚ
 
	`t2
(2);

205 

 = 5;

206 
	`as£¹
(
t2
.
	`Œy_comm™
());

208 
t1
.
	`u£
();

209 
m©ch
 = 

 > 1;

213 
	`as£¹
(
m©ch
);

215 
Te¡T¿n§ùiÚ
 
	`t3
(2);

216 

 = 2;

217 
	`as£¹
(
t3
.
	`Œy_comm™
());

218 
	`as£¹
(
t1
.
	`Œy_comm™
());

221 

.
	`nÚŒªs_wr™e
(4);

223 
Œy
 {

224 
Te¡T¿n§ùiÚ
 
	`t1
(1);

225 
m©ch
 = 

 > 1;

226 
	`as£¹
(
m©ch
);

227 
box
 = 9;

229 
Te¡T¿n§ùiÚ
 
	`t2
(2);

230 

 = 0;

231 
	`as£¹
(
t2
.
	`Œy_comm™
());

233 
t1
.
	`u£
();

234 
m©ch
 = 

 < 1;

235 
	`as£¹
(
çl£
 && "should‚ot get here");

236 
	`as£¹
(!
t1
.
	`Œy_comm™
());

237 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

240 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

241 
	}
}

243 
	$maš
() {

244 
	`as£¹
((
mass
::
is_ŒivŸÎy_cİyabË
<
TIÁP»diÿ‹
<>::
´ed_ty³
>::
v®ue
));

245 
	`as£¹
((
mass
::
is_ŒivŸÎy_cİyabË
<
TV”siÚ
>::
v®ue
));

246 
	`as£¹
((
mass
::
is_ŒivŸÎy_cİyabË
<
TNÚİaqueV”siÚ
>::
v®ue
));

250 
T¿n§ùiÚBufãr
 
buf
;

251 * 
v1
 = 
Pack”
<
ušŒ_t
>::
	`·ck
(
buf
, 12938);

252 * 
v2
 = 
Pack”
<
ušŒ_t
>::
	`·ck_unique
(
buf
, 12938);

253 * 
v3
 = 
Pack”
<
ušŒ_t
>::
	`·ck
(
buf
, 12938);

254 * 
v4
 = 
Pack”
<
ušŒ_t
>::
	`·ck_unique
(
buf
, 12938);

255 
	`as£¹
(
v1
 =ğ
v2
 && v2 =ğ
v3
 && v3 =ğ
v4
 && v4 =ğ(*è(
ušŒ_t
) 12938);

256 
	`as£¹
(
Pack”
<
ušŒ_t
>::
	`uÅack
(
v1
) == 12938);

257 
	`as£¹
(
Pack”
<
ušŒ_t
>::
	`uÅack
(
v2
) == 12938);

258 
	`as£¹
(
Pack”
<
ušŒ_t
>::
	`uÅack
(
v3
) == 12938);

259 
	`as£¹
(
Pack”
<
ušŒ_t
>::
	`uÅack
(
v4
) == 12938);

261 
v1
 = 
Pack”
<
¡d
::
¡ršg
>::
	`·ck
(
buf
, "Hello");

262 
v2
 = 
Pack”
<
¡d
::
¡ršg
>::
	`·ck_unique
(
buf
, "Hello");

263 
v3
 = 
Pack”
<
¡d
::
¡ršg
>::
	`·ck
(
buf
, "Hello2");

264 
v4
 = 
Pack”
<
¡d
::
¡ršg
>::
	`·ck_unique
(
buf
, "Hello2");

265 * 
v5
 = 
Pack”
<
¡d
::
¡ršg
>::
	`·ck
(
buf
, "Hello");

266 * 
v6
 = 
Pack”
<
¡d
::
¡ršg
>::
	`·ck_unique
(
buf
, "Hello");

267 
	`as£¹
(
v1
 !ğ
v2
 && v1 !ğ
v5
 && v2 !ğv5 && v1 !ğ
v6
 && v5 != v6);

268 
	`as£¹
(
v2
 =ğ
v6
);

269 
	`as£¹
(
Pack”
<
¡d
::
¡ršg
>::
	`uÅack
(
v1
) == "Hello");

270 
	`as£¹
(
Pack”
<
¡d
::
¡ršg
>::
	`uÅack
(
v2
) == "Hello");

271 
	`as£¹
(
Pack”
<
¡d
::
¡ršg
>::
	`uÅack
(
v3
) == "Hello2");

272 
	`as£¹
(
Pack”
<
¡d
::
¡ršg
>::
	`uÅack
(
v4
) == "Hello2");

273 
	`as£¹
(
Pack”
<
¡d
::
¡ršg
>::
	`uÅack
(
v5
) == "Hello");

274 
	`as£¹
(
Pack”
<
¡d
::
¡ršg
>::
	`uÅack
(
v6
) == "Hello");

276 
¡d
::
¡ršg
 
	`h–lo
("Hello");

277 * 
v7
 = 
Pack”
<
¡d
::
¡ršg
>::
	`·ck
(
buf
, 
	`SŒšgW¿µ”
(
h–lo
));

278 
	`as£¹
(
v7
 =ğ&
h–lo
);

282 
	`‹¡TrivŸl
();

283 
	`‹¡Sim¶eRªgesOk
();

284 
	`‹¡Sim¶eRªgesFa
();

286 
	}
}

	@test/unit-tvector-nopred.cc

1 #undeà
NDEBUG


2 
	~<¡ršg
>

3 
	~<io¡»am
>

4 
	~<as£¹.h
>

5 
	~<veùÜ
>

6 
	~"T¿n§ùiÚ.hh
"

7 
	~"TVeùÜ_nİ»d.hh
"

8 
	~"TBox.hh
"

9 
	#GUARDED
 ià(
T¿n§ùiÚGu¬d
 
tgu¬d
{})

	)

11 
	$‹¡Sim¶eIÁ
() {

12 
TVeùÜ_nİ»d
<> 
f
;

15 
T¿n§ùiÚGu¬d
 
t
;

16 
f
.
	`push_back
(100);

17 
f
.
	`push_back
(200);

18 *(
f
.
	`begš
()) = *(f.begin() + 1);

22 
T¿n§ùiÚGu¬d
 
t2
;

23 
f_»ad
 = 
f
[0];

24 
	`as£¹
(
f_»ad
 == 200);

27 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

28 
	}
}

30 
	$‹¡Wr™eNPushBack
() {

31 
TVeùÜ_nİ»d
<> 
f
;

34 
T¿n§ùiÚGu¬d
 
t
;

35 
f
.
	`push_back
(10);

38 
Te¡T¿n§ùiÚ
 
	`t2
(1);

39 
f
[0] = 4;

41 
Te¡T¿n§ùiÚ
 
	`t3
(2);

42 
f
.
	`push_back
(20);

44 
	`as£¹
(
t3
.
	`Œy_comm™
());

46 
	`as£¹
(
t2
.
	`Œy_comm™
());

49 
T¿n§ùiÚGu¬d
 
t4
;

50 
	`as£¹
(
f
[0] == 4);

53 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

54 
	}
}

56 
	$‹¡PushBack
() {

57 
TVeùÜ_nİ»d
<> 
f
;

60 
T¿n§ùiÚGu¬d
 
t
;

61 
f
.
	`push_back
(10);

64 
Te¡T¿n§ùiÚ
 
	`t2
(1);

65 
f
.
	`push_back
(4);

67 
Te¡T¿n§ùiÚ
 
	`t3
(2);

68 
f
.
	`push_back
(20);

69 
	`as£¹
(
t3
.
	`Œy_comm™
());

70 
	`as£¹
(!
t2
.
	`Œy_comm™
());

73 
T¿n§ùiÚGu¬d
 
t4
;

74 
	`as£¹
(
f
[0] == 10);

75 
	`as£¹
(
f
[1] == 20);

78 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

79 
	}
}

82 
	$‹¡PushBackNR—d
() {

83 
TVeùÜ_nİ»d
<> 
f
;

86 
T¿n§ùiÚGu¬d
 
t
;

87 
f
.
	`push_back
(10);

91 
T¿n§ùiÚGu¬d
 
t2
;

92 
f
.
	`push_back
(4);

93 
	`as£¹
(
f
[1] == 4);

96 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

97 
	}
}

99 
	$‹¡PushBackNR—d1
() {

100 
TVeùÜ_nİ»d
<> 
f
;

103 
T¿n§ùiÚGu¬d
 
t
;

104 
f
.
	`push_back
(10);

107 
Te¡T¿n§ùiÚ
 
	`t2
(1);

108 
f
.
	`push_back
(4);

109 
	`as£¹
(
f
[1] == 4);

111 
Te¡T¿n§ùiÚ
 
	`t3
(2);

112 
f
.
	`push_back
(20);

113 
	`as£¹
(
t3
.
	`Œy_comm™
());

114 
	`as£¹
(!
t2
.
	`Œy_comm™
());

116 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

117 
	}
}

119 
	$‹¡PushBackNR—d2
() {

120 
TVeùÜ_nİ»d
<> 
f
;

123 
T¿n§ùiÚGu¬d
 
t
;

124 
f
.
	`push_back
(10);

127 
Te¡T¿n§ùiÚ
 
	`t2
(1);

128 
f
.
	`push_back
(4);

129 
	`as£¹
(
f
[f.
	`size
() - 1] == 4);

131 
Te¡T¿n§ùiÚ
 
	`t3
(2);

132 
f
.
	`push_back
(20);

134 
	`as£¹
(
t3
.
	`Œy_comm™
());

135 
	`as£¹
(!
t2
.
	`Œy_comm™
());

137 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

138 
	}
}

141 
	$‹¡PushBackNWr™e
() {

142 
TVeùÜ_nİ»d
<> 
f
;

145 
T¿n§ùiÚGu¬d
 
t
;

146 
f
.
	`push_back
(10);

150 
T¿n§ùiÚGu¬d
 
t2
;

151 
f
.
	`push_back
(4);

152 
f
[1] = 10;

156 
T¿n§ùiÚGu¬d
 
t3
;

157 
	`as£¹
(
f
[1] == 10);

160 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

161 
	}
}

165 
	$‹¡Sim¶eSŒšg
() {

166 
TVeùÜ_nİ»d
<
¡d
::
¡ršg
> 
f
;

169 
T¿n§ùiÚGu¬d
 
t
;

170 
f
.
	`push_back
("100");

174 
T¿n§ùiÚGu¬d
 
t2
;

175 
¡d
::
¡ršg
 
f_»ad
 = 
f
[0];

176 
	`as£¹
(
f_»ad
.
	`com·»
("100") == 0);

179 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

180 
	}
}

182 
	$‹¡I‹r
() {

183 
¡d
::
veùÜ
<> 
¬r
;

184 
TVeùÜ_nİ»d
<> 
f
;

185 
TRANSACTION_E
 {

186 
i
 = 0; i < 10; i++) {

187 
x
 = 
	`¿nd
();

188 
f
.
	`push_back
(
x
);

189 
¬r
.
	`push_back
(
x
);

191 } 
	`RETRY_E
(
çl£
);

193 
max
;

194 
TRANSACTION_E
 {

195 
max
 = *(
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
()));

196 } 
	`RETRY_E
(
çl£
);

198 
	`as£¹
(
max
 =ğ*(
¡d
::
	`max_–em’t
(
¬r
.
	`begš
(),‡¼.
	`’d
())));

199 
	`´štf
("Max i %i\n", 
max
);

200 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

201 
	}
}

204 
	$‹¡CÚæiùšgI‹r
() {

205 
TVeùÜ_nİ»d
<> 
f
;

206 
TBox
<> 
box
;

207 
TRANSACTION_E
 {

208 
i
 = 0; i < 10; i++) {

209 
f
.
	`push_back
(
i
);

211 } 
	`RETRY_E
(
çl£
);

213 
Te¡T¿n§ùiÚ
 
	`t
(1);

214 
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
());

215 
box
 = 9;

217 
Te¡T¿n§ùiÚ
 
	`t1
(2);

218 
f
[4] = 10;

219 
	`as£¹
(
t1
.
	`Œy_comm™
());

220 
	`as£¹
(!
t
.
	`Œy_comm™
());

222 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

223 
	}
}

225 
	$‹¡ModifyšgI‹r
() {

226 
TVeùÜ_nİ»d
<> 
f
;

228 
T¿n§ùiÚGu¬d
 
‰
;

229 
i
 = 0; i < 10; i++) {

230 
f
.
	`push_back
(
i
);

235 
T¿n§ùiÚGu¬d
 
t
;

236 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

240 
T¿n§ùiÚGu¬d
 
t1
;

241 
v
 = 
f
[4];

242 
	`as£¹
(
v
 == 6);

245 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

246 
	}
}

248 
	$‹¡CÚæiùšgModifyI‹r1
() {

249 
TVeùÜ_nİ»d
<> 
f
;

250 
TRANSACTION_E
 {

251 
i
 = 0; i < 10; i++) {

252 
f
.
	`push_back
(
i
);

254 } 
	`RETRY_E
(
çl£
);

256 
Te¡T¿n§ùiÚ
 
	`t
(1);

257 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

259 
Te¡T¿n§ùiÚ
 
	`t1
(2);

260 
f
[4] = 10;

261 
	`as£¹
(
t1
.
	`Œy_comm™
());

262 
	`as£¹
(!
t
.
	`Œy_comm™
());

265 
T¿n§ùiÚGu¬d
 
t2
;

266 
v
 = 
f
[4];

267 
	`as£¹
(
v
 == 10);

270 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

271 
	}
}

273 
	$‹¡CÚæiùšgModifyI‹r2
() {

274 
TVeùÜ_nİ»d
<> 
f
;

275 
TRANSACTION_E
 {

276 
i
 = 0; i < 10; i++) {

277 
f
.
	`push_back
(
i
);

279 } 
	`RETRY_E
(
çl£
);

282 
T¿n§ùiÚGu¬d
 
t
;

283 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

287 
T¿n§ùiÚGu¬d
 
t1
;

288 
f
[4] = 10;

292 
T¿n§ùiÚGu¬d
 
t2
;

293 
v
 = 
f
[4];

294 
	`as£¹
(
v
 == 10);

297 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

298 
	}
}

300 
	$‹¡CÚæiùšgModifyI‹r3
() {

301 
TVeùÜ_nİ»d
<> 
f
;

302 
TBox
<> 
box
;

303 
TRANSACTION_E
 {

304 
i
 = 0; i < 10; i++) {

305 
f
.
	`push_back
(
i
);

307 } 
	`RETRY_E
(
çl£
);

309 
Te¡T¿n§ùiÚ
 
	`t1
(1);

310 (è
f
[4];

311 
box
 = 9;

313 
Te¡T¿n§ùiÚ
 
	`t
(2);

314 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

315 
	`as£¹
(
t
.
	`Œy_comm™
());

316 
	`as£¹
(!
t1
.
	`Œy_comm™
());

319 
T¿n§ùiÚGu¬d
 
t2
;

320 
v
 = 
f
[4];

321 
	`as£¹
(
v
 == 6);

324 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

325 
	}
}

327 
	$‹¡I‹rNPushBack
() {

328 
TVeùÜ_nİ»d
<> 
f
;

329 
TRANSACTION_E
 {

330 
i
 = 0; i < 10; i++) {

331 
f
.
	`push_back
(
i
);

333 } 
	`RETRY_E
(
çl£
);

335 
max
;

336 
TRANSACTION_E
 {

337 
f
.
	`push_back
(20);

338 
max
 = *(
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
()));

339 } 
	`RETRY_E
(
çl£
);

341 
	`as£¹
(
max
 == 20);

342 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

343 
	}
}

345 
	$‹¡I‹rNPushBack1
() {

346 
TVeùÜ_nİ»d
<> 
f
;

348 
T¿n§ùiÚGu¬d
 
‰
;

349 
i
 = 0; i < 10; i++) {

350 
f
.
	`push_back
(
i
);

354 
max
;

355 
Te¡T¿n§ùiÚ
 
	`t1
(1);

356 
f
.
	`push_back
(20);

357 
max
 = *(
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
()));

358 
	`as£¹
(
max
 == 20);

360 
Te¡T¿n§ùiÚ
 
	`t2
(2);

361 
f
.
	`push_back
(12);

362 
	`as£¹
(
t2
.
	`Œy_comm™
());

363 
	`as£¹
(!
t1
.
	`Œy_comm™
());

365 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

366 
	}
}

368 
	$‹¡I‹rNPushBack2
() {

369 
TVeùÜ_nİ»d
<> 
f
;

370 
TBox
<> 
box
;

373 
T¿n§ùiÚGu¬d
 
‰
;

374 
i
 = 0; i < 10; i++) {

375 
f
.
	`push_back
(
i
);

379 
Te¡T¿n§ùiÚ
 
	`t1
(1);

380 
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
());

381 
box
 = 9;

383 
Te¡T¿n§ùiÚ
 
	`t2
(2);

384 
f
.
	`push_back
(2);

385 
	`as£¹
(
t2
.
	`Œy_comm™
());

386 
	`as£¹
(!
t1
.
	`Œy_comm™
());

388 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

389 
	}
}

392 
	$‹¡E¿£
() {

393 
TVeùÜ_nİ»d
<> 
f
;

395 
TRANSACTION_E
 {

396 
i
 = 0; i < 10; i++)

397 
f
.
	`push_back
(
i
);

398 } 
	`RETRY_E
(
çl£
);

401 
T¿n§ùiÚGu¬d
 
t1
;

402 
f
.
	`”a£
(f.
	`begš
() + 5);

405 
TRANSACTION_E
 {

406 
	`as£¹
(
f
.
	`size
() == 9);

407 
x
[9] = {0, 1, 2, 3, 4, 6, 7, 8, 9};

408 
i
 = 0; i < 9; ++i)

409 
	`as£¹
(
f
[
i
] =ğ
x
[i]);

410 } 
	`RETRY_E
(
çl£
);

412 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

413 
	}
}

415 
	$‹¡In£¹
() {

416 
TVeùÜ_nİ»d
<> 
f
;

418 
TRANSACTION_E
 {

419 
i
 = 0; i < 10; i++)

420 
f
.
	`push_back
(
i
);

421 } 
	`RETRY_E
(
çl£
);

424 
T¿n§ùiÚGu¬d
 
t1
;

425 
f
.
	`š£¹
(f.
	`begš
() + 5, 25);

428 
TRANSACTION_E
 {

429 
	`as£¹
(
f
.
	`size
() == 11);

430 
x
[] = {0, 1, 2, 3, 4, 25, 5, 6, 7, 8, 9};

431 
i
 = 0; i < 11; ++i)

432 
	`as£¹
(
f
[
i
] =ğ
x
[i]);

433 } 
	`RETRY_E
(
çl£
);

435 
GUARDED
 {

436 
f
.
	`š£¹
(f.
	`’d
(), 30);

439 
TRANSACTION_E
 {

440 
	`as£¹
(
f
.
	`size
() == 12);

441 
x
[] = {0, 1, 2, 3, 4, 25, 5, 6, 7, 8, 9, 30};

442 
i
 = 0; i < 12; ++i)

443 
	`as£¹
(
f
[
i
] =ğ
x
[i]);

444 } 
	`RETRY_E
(
çl£
);

446 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

447 
	}
}

449 
	$‹¡PushNPİ
() {

450 
TVeùÜ_nİ»d
<> 
f
;

451 
TBox
<> 
box
;

453 
TRANSACTION_E
 {

454 
i
 = 0; i < 10; i++) {

455 
f
.
	`push_back
(
i
);

457 } 
	`RETRY_E
(
çl£
);

460 
T¿n§ùiÚGu¬d
 
t
;

461 
f
.
	`push_back
(20);

462 
f
.
	`push_back
(21);

463 
	`as£¹
(
f
[0] == 0);

464 
	`as£¹
(
f
.
	`size
() == 12);

466 
f
.
	`pİ_back
();

467 
f
.
	`pİ_back
();

471 
Te¡T¿n§ùiÚ
 
	`t1
(1);

472 
f
.
	`pİ_back
();

473 
f
.
	`push_back
(15);

475 
Te¡T¿n§ùiÚ
 
	`t2
(2);

476 
f
.
	`push_back
(20);

477 
	`as£¹
(
t2
.
	`Œy_comm™
());

478 
	`as£¹
(!
t1
.
	`Œy_comm™
());

480 
TRANSACTION_E
 {

481 
	`as£¹
(
f
.
	`size
() == 11);

482 
	`as£¹
(
f
[10] == 20);

483 } 
	`RETRY_E
(
çl£
);

487 
Te¡T¿n§ùiÚ
 
	`t1
(1);

488 
f
.
	`push_back
(18);

489 
	`as£¹
(
f
[11] == 18);

491 
Te¡T¿n§ùiÚ
 
	`t2
(2);

492 
f
.
	`push_back
(21);

493 
	`as£¹
(
t2
.
	`Œy_comm™
());

495 
	`as£¹
(!
t1
.
	`Œy_comm™
());

497 
TRANSACTION_E
 {

498 
	`as£¹
(
f
.
	`size
() == 12);

499 
	`as£¹
(
f
[10] == 20);

500 
	`as£¹
(
f
[11] == 21);

501 
f
.
	`pİ_back
();

502 } 
	`RETRY_E
(
çl£
);

505 
	`´štf
("PASS:estPushNPop\n");

507 
Te¡T¿n§ùiÚ
 
	`t3
(1);

508 
f
.
	`pİ_back
();

509 
f
.
	`push_back
(15);

511 
Te¡T¿n§ùiÚ
 
	`t4
(2);

512 
f
.
	`pİ_back
();

513 
	`as£¹
(
t4
.
	`Œy_comm™
());

514 
	`as£¹
(!
t3
.
	`Œy_comm™
());

516 
TRANSACTION_E
 {

517 
	`as£¹
(
f
.
	`size
() == 10);

518 } 
	`RETRY_E
(
çl£
);

520 
	`´štf
("PASS:estPushNPop1\n");

522 
Te¡T¿n§ùiÚ
 
	`t5
(1);

523 
f
.
	`pİ_back
();

524 
f
.
	`pİ_back
();

525 
f
.
	`push_back
(15);

527 
Te¡T¿n§ùiÚ
 
	`t6
(2);

528 
f
[8] = 16;

529 
	`as£¹
(
t6
.
	`Œy_comm™
());

531 
Te¡T¿n§ùiÚ
 
	`t7
(3);

532 (è
f
[8];

533 
box
 = 9;

535 
	`as£¹
(
t5
.
	`Œy_comm™
());

536 
	`as£¹
(!
t7
.
	`Œy_comm™
());

538 
TRANSACTION_E
 {

539 
	`as£¹
(
f
.
	`size
() == 9);

540 
	`as£¹
(
f
[8] == 15);

541 } 
	`RETRY_E
(
çl£
);

543 
	`´štf
("PASS:estPushNPop2\n");

544 
	}
}

546 
	$‹¡PİAndUd·‹
() {

547 
TVeùÜ_nİ»d
<> 
f
;

549 
TRANSACTION_E
 {

550 
i
 = 0; i < 10; i++) {

551 
f
.
	`push_back
(
i
);

553 } 
	`RETRY_E
(
çl£
);

555 
Te¡T¿n§ùiÚ
 
	`t1
(1);

556 
f
[9] = 20;

558 
Te¡T¿n§ùiÚ
 
	`t2
(2);

559 
f
.
	`pİ_back
();

560 
f
.
	`pİ_back
();

561 
	`as£¹
(
t2
.
	`Œy_comm™
());

562 
	`as£¹
(!
t1
.
	`Œy_comm™
());

563 
	}
}

565 
	$‹¡MulPushPİs
() {

566 
TVeùÜ_nİ»d
<> 
f
;

568 
TRANSACTION_E
 {

569 
i
 = 0; i < 10; i++) {

570 
f
.
	`push_back
(
i
);

572 } 
	`RETRY_E
(
çl£
);

575 
T¿n§ùiÚGu¬d
 
t1
;

576 
f
.
	`push_back
(100);

577 
f
.
	`push_back
(200);

578 
f
.
	`pİ_back
();

579 
f
.
	`pİ_back
();

580 
f
.
	`pİ_back
();

582 
	}
}

584 
	$‹¡MulPushPİs1
() {

585 
TVeùÜ_nİ»d
<> 
f
;

587 
TRANSACTION_E
 {

588 
i
 = 0; i < 10; i++) {

589 
f
.
	`push_back
(
i
);

591 } 
	`RETRY_E
(
çl£
);

594 
T¿n§ùiÚGu¬d
 
t1
;

595 
f
.
	`push_back
(100);

596 
f
.
	`push_back
(200);

597 
f
.
	`pİ_back
();

598 
f
.
	`pİ_back
();

599 
f
.
	`push_back
(300);

601 
	}
}

603 
	$‹¡Upd©ePİ
() {

604 
TVeùÜ_nİ»d
<> 
f
;

606 
TRANSACTION_E
 {

607 
i
 = 0; i < 10; i++) {

608 
f
.
	`push_back
(
i
);

610 } 
	`RETRY_E
(
çl£
);

613 
T¿n§ùiÚGu¬d
 
t1
;

614 
f
[9] = 20;

615 
f
.
	`pİ_back
();

617 
	}
}

619 
	$‹¡I‹¿tÜB‘‹rSemªtics
() {

620 
TVeùÜ_nİ»d
<> 
f
;

621 
TBox
<> 
box
;

623 
TRANSACTION_E
 {

624 
i
 = 0; i < 10; i++) {

625 
f
.
	`push_back
(
i
);

627 } 
	`RETRY_E
(
çl£
);

629 
Te¡T¿n§ùiÚ
 
	`t1
(1);

632 
TVeùÜ_nİ»d
<>::
™”©Ü
 
™
;

633 
™
 = 
f
.
	`begš
(); iˆ!ğf.
	`’d
(); ++it)

634 ià(*
™
 == 5)

636 
box
 = 9;

638 
Te¡T¿n§ùiÚ
 
	`t2
(2);

639 
f
.
	`push_back
(12);

640 
	`as£¹
(
t2
.
	`Œy_comm™
());

641 
t1
.
	`u£
();

642 
x
 = *
™
;

643 
	`as£¹
(!
t1
.
	`Œy_comm™
());

644 (è
x
;

646 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

647 
	}
}

649 
	$‹¡SizeP»diÿ‹s
() {

650 
TVeùÜ_nİ»d
<> 
f
;

651 
TBox
<> 
box
;

653 
TRANSACTION_E
 {

654 
i
 = 0; i < 10; i++)

655 
f
.
	`push_back
(
i
);

656 } 
	`RETRY_E
(
çl£
);

659 
Te¡T¿n§ùiÚ
 
	`t1
(1);

660 
	`as£¹
(
f
.
	`size
() > 5);

661 
box
 = 9;

663 
Te¡T¿n§ùiÚ
 
	`t2
(2);

664 
i
 = 0; i < 4; ++i)

665 
f
.
	`pİ_back
();

666 
	`as£¹
(
t2
.
	`Œy_comm™
());

667 
	`as£¹
(!
t1
.
	`Œy_comm™
());

669 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 6);

673 
Te¡T¿n§ùiÚ
 
	`t1
(1);

674 
	`as£¹
(
f
.
	`size
() > 4);

675 
box
 = 9;

677 
Te¡T¿n§ùiÚ
 
	`t2
(2);

678 
f
.
	`size
() > 4)

679 
f
.
	`pİ_back
();

680 
	`as£¹
(
t2
.
	`Œy_comm™
());

681 
	`as£¹
(!
t1
.
	`Œy_comm™
());

683 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 4);

687 
Te¡T¿n§ùiÚ
 
	`t0
(1);

688 
f
.
	`size
() < 6)

689 
f
.
	`push_back
(f.
	`size
());

690 
	`as£¹
(
t0
.
	`Œy_comm™
());

692 
Te¡T¿n§ùiÚ
 
	`t1
(1);

693 
	`as£¹
(
f
.
	`size
() > 4);

694 
box
 = 9;

696 
Te¡T¿n§ùiÚ
 
	`t2
(2);

697 
f
.
	`size
() > 4)

698 
f
.
	`pİ_back
();

699 
	`as£¹
(
t1
.
	`Œy_comm™
());

700 
	`as£¹
(
t2
.
	`Œy_comm™
());

702 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 4);

706 
Te¡T¿n§ùiÚ
 
	`t1
(1);

707 
	`as£¹
(
f
.
	`size
() < 6);

708 
box
 = 9;

710 
Te¡T¿n§ùiÚ
 
	`t2
(2);

711 
f
.
	`size
() < 6)

712 
f
.
	`push_back
(f.
	`size
());

713 
	`as£¹
(
t2
.
	`Œy_comm™
());

714 
	`as£¹
(!
t1
.
	`Œy_comm™
());

716 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 6);

720 
Te¡T¿n§ùiÚ
 
	`t1
(1);

721 
	`as£¹
(
f
.
	`size
() < 8);

722 
box
 = 9;

724 
Te¡T¿n§ùiÚ
 
	`t2
(2);

725 
f
.
	`size
() < 8)

726 
f
.
	`push_back
(f.
	`size
());

727 
	`as£¹
(
t1
.
	`Œy_comm™
());

728 
	`as£¹
(
t2
.
	`Œy_comm™
());

730 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 8);

733 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

734 
	}
}

736 
	$‹¡I‹rP»diÿ‹s
() {

737 
TVeùÜ_nİ»d
<> 
f
;

738 
TBox
<> 
box
;

740 
TRANSACTION_E
 {

741 
i
 = 0; i < 10; i++)

742 
f
.
	`push_back
(
i
);

743 } 
	`RETRY_E
(
çl£
);

746 
Te¡T¿n§ùiÚ
 
	`t1
(1);

747 
	`as£¹
(
f
.
	`begš
(è+ 5 < f.
	`’d
());

748 
box
 = 9;

750 
Te¡T¿n§ùiÚ
 
	`t2
(2);

751 
i
 = 0; i < 4; ++i)

752 
f
.
	`pİ_back
();

753 
	`as£¹
(
t2
.
	`Œy_comm™
());

754 
	`as£¹
(!
t1
.
	`Œy_comm™
());

756 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 6);

760 
Te¡T¿n§ùiÚ
 
	`t1
(1);

761 
	`as£¹
(
f
.
	`begš
(è+ 4 < f.
	`’d
());

762 
box
 = 9;

764 
Te¡T¿n§ùiÚ
 
	`t2
(2);

765 
f
.
	`size
() > 4)

766 
f
.
	`pİ_back
();

767 
	`as£¹
(
t2
.
	`Œy_comm™
());

768 
	`as£¹
(!
t1
.
	`Œy_comm™
());

770 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 4);

774 
Te¡T¿n§ùiÚ
 
	`t0
(1);

775 
f
.
	`size
() < 6)

776 
f
.
	`push_back
(f.
	`size
());

777 
	`as£¹
(
t0
.
	`Œy_comm™
());

779 
Te¡T¿n§ùiÚ
 
	`t1
(1);

780 
	`as£¹
(
f
.
	`’d
(è> f.
	`begš
() + 4);

781 
box
 = 9;

783 
Te¡T¿n§ùiÚ
 
	`t2
(2);

784 
f
.
	`size
() > 4)

785 
f
.
	`pİ_back
();

786 
	`as£¹
(
t1
.
	`Œy_comm™
());

787 
	`as£¹
(
t2
.
	`Œy_comm™
());

789 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 4);

793 
Te¡T¿n§ùiÚ
 
	`t1
(1);

794 
	`as£¹
(
f
.
	`’d
(è<ğf.
	`begš
() + 5);

795 
box
 = 9;

797 
Te¡T¿n§ùiÚ
 
	`t2
(2);

798 
f
.
	`size
() < 6)

799 
f
.
	`push_back
(f.
	`size
());

800 
	`as£¹
(
t2
.
	`Œy_comm™
());

801 
	`as£¹
(!
t1
.
	`Œy_comm™
());

803 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 6);

807 
Te¡T¿n§ùiÚ
 
	`t1
(1);

808 
	`as£¹
(
f
.
	`’d
(è- f.
	`begš
() < 8);

809 
box
 = 9;

811 
Te¡T¿n§ùiÚ
 
	`t2
(2);

812 
f
.
	`size
() < 8)

813 
f
.
	`push_back
(f.
	`size
());

814 
	`as£¹
(
t1
.
	`Œy_comm™
());

815 
	`as£¹
(
t2
.
	`Œy_comm™
());

817 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 8);

821 
Te¡T¿n§ùiÚ
 
	`t1
(1);

822 
	`as£¹
(
f
.
	`’d
(è- f.
	`begš
() < 9);

823 
box
 = 9;

825 
Te¡T¿n§ùiÚ
 
	`t2
(2);

826 
f
.
	`size
() < 9)

827 
f
.
	`push_back
(f.
	`size
());

828 
	`as£¹
(
t2
.
	`Œy_comm™
());

829 
	`as£¹
(!
t1
.
	`Œy_comm™
());

831 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 9);

835 
Te¡T¿n§ùiÚ
 
	`t1
(1);

836 
	`as£¹
(
f
.
	`begš
(è- f.
	`’d
() == -9);

837 
	`as£¹
(
t1
.
	`Œy_comm™
());

839 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 9);

842 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

843 
	}
}

845 
	$‹¡Resize
() {

846 
TVeùÜ_nİ»d
<> 
f
;

847 
TBox
<> 
box
;

849 
TRANSACTION_E
 {

850 
i
 = 0; i < 10; i++)

851 
f
.
	`push_back
(
i
);

852 } 
	`RETRY_E
(
çl£
);

855 
Te¡T¿n§ùiÚ
 
	`t1
(1);

856 
	`as£¹
(
f
[1] == 1);

857 
box
 = 9;

859 
Te¡T¿n§ùiÚ
 
	`t2
(2);

860 
f
.
	`»size
(4);

861 
	`as£¹
(
t2
.
	`Œy_comm™
());

863 
t1
.
	`u£
();

864 
	`as£¹
(
f
.
	`size
() >= 4);

865 
	`as£¹
(
t1
.
	`Œy_comm™
());

867 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 4);

871 
Te¡T¿n§ùiÚ
 
	`t1
(1);

872 
	`as£¹
(
f
[1] == 1);

873 
	`as£¹
(
f
.
	`size
() >= 4);

874 
box
 = 9;

876 
Te¡T¿n§ùiÚ
 
	`t2
(2);

877 
f
.
	`»size
(5, -100);

878 
	`as£¹
(
t2
.
	`Œy_comm™
());

879 
	`as£¹
(!
t1
.
	`Œy_comm™
());

881 
Te¡T¿n§ùiÚ
 
	`t3
(3);

882 
	`as£¹
(
f
.
	`size
() == 5);

883 
	`as£¹
(
f
[0] == 0);

884 
	`as£¹
(
f
[1] == 1);

885 
	`as£¹
(
f
[2] == 2);

886 
	`as£¹
(
f
[3] == 3);

887 
	`as£¹
(
f
[4] == -100);

888 
	`as£¹
(
t3
.
	`Œy_comm™
());

891 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

892 
	}
}

894 
	$‹¡FrÚtBack
() {

895 
TVeùÜ_nİ»d
<> 
v
;

897 
GUARDED
 {

898 
i
 = 0; i < 10; ++i)

899 
v
.
	`push_back
(
i
);

902 
GUARDED
 {

903 
	`as£¹
(
v
.
	`size
() == 10);

906 
GUARDED
 {

907 
	`as£¹
(
v
.
	`äÚt
() == 0);

908 
	`as£¹
(
v
.
	`back
() == 9);

910 
v
.
	`pİ_back
();

912 
	`as£¹
(
v
.
	`back
() == 8);

914 
v
.
	`push_back
(30);

916 
	`as£¹
(
v
.
	`back
() == 30);

919 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

920 
	}
}

922 
	$‹¡O·c™y
() {

923 
TVeùÜ_nİ»d
<> 
f
;

924 
TBox
<> 
box
;

926 
TRANSACTION_E
 {

927 
i
 = 0; i < 10; i++)

928 
f
.
	`push_back
(
i
);

929 } 
	`RETRY_E
(
çl£
);

932 
Te¡T¿n§ùiÚ
 
	`t1
(1);

933 
	`as£¹
(
f
[1] == 1);

934 
box
 = 9;

936 
Te¡T¿n§ùiÚ
 
	`t2
(2);

937 
f
.
	`pİ_back
();

938 
	`as£¹
(
t2
.
	`Œy_comm™
());

940 
t1
.
	`u£
();

941 
	`as£¹
(
f
[2] == 2);

942 
	`as£¹
(
t1
.
	`Œy_comm™
());

944 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 9);

948 
Te¡T¿n§ùiÚ
 
	`t1
(1);

949 
	`as£¹
(
f
[1] == 1);

950 
	`as£¹
(
f
[4] == 4);

951 
box
 = 9;

953 
Te¡T¿n§ùiÚ
 
	`t2
(2);

954 
f
.
	`size
() > 3)

955 
f
.
	`pİ_back
();

956 
	`as£¹
(
t2
.
	`Œy_comm™
());

958 
t1
.
	`u£
();

959 
	`as£¹
(
f
[2] == 2);

960 
	`as£¹
(!
t1
.
	`Œy_comm™
());

962 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 3);

965 
TRANSACTION_E
 {

966 
f
.
	`size
() < 10)

967 
f
.
	`push_back
(f.
	`size
());

968 } 
	`RETRY_E
(
çl£
);

970 
Œy
 {

971 
Te¡T¿n§ùiÚ
 
	`t1
(1);

972 
	`as£¹
(
f
[1] == 1);

973 
	`as£¹
(
f
[4] == 4);

974 
box
 = 9;

976 
Te¡T¿n§ùiÚ
 
	`t2
(2);

977 
f
.
	`size
() > 3)

978 
f
.
	`pİ_back
();

979 
f
[2] = -1;

980 
	`as£¹
(
t2
.
	`Œy_comm™
());

982 
t1
.
	`u£
();

983 
	`as£¹
(
f
[2] == -1);

984 
	`as£¹
(
çl£
 && "should‚ot get here b/c opacity");

985 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

988 
TRANSACTION_E
 {

989 
f
.
	`size
() < 10)

990 
f
.
	`push_back
(f.
	`size
());

991 } 
	`RETRY_E
(
çl£
);

993 
Œy
 {

994 
Te¡T¿n§ùiÚ
 
	`t1
(1);

995 
	`as£¹
(
f
[1] == 1);

996 
	`as£¹
(
f
[4] == 4);

997 
box
 = 9;

999 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1000 
f
.
	`size
() > 3)

1001 
f
.
	`pİ_back
();

1002 
f
[2] = -1;

1003 
	`as£¹
(
t2
.
	`Œy_comm™
());

1005 
t1
.
	`u£
();

1006 
	`as£¹
(
f
.
	`size
() > 4);

1007 
	`as£¹
(
çl£
 && "should‚ot get here b/c opacity");

1008 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

1011 
TRANSACTION_E
 {

1012 
f
.
	`size
() < 10)

1013 
f
.
	`push_back
(f.
	`size
());

1014 } 
	`RETRY_E
(
çl£
);

1016 
Œy
 {

1017 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1018 
f
[1] = 1;

1019 
f
[4] = 4;

1021 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1022 
f
.
	`size
() > 3)

1023 
f
.
	`pİ_back
();

1024 
f
[2] = -1;

1025 
	`as£¹
(
t2
.
	`Œy_comm™
());

1027 
t1
.
	`u£
();

1028 
	`as£¹
(
f
.
	`size
() > 4);

1029 
	`as£¹
(
çl£
 && "should‚ot get here b/c opacity");

1030 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

1033 
TRANSACTION_E
 {

1034 
f
.
	`size
() < 10)

1035 
f
.
	`push_back
(f.
	`size
());

1036 } 
	`RETRY_E
(
çl£
);

1039 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1040 
	`as£¹
(
f
[1] == 1);

1041 
	`as£¹
(
f
[4] == 4);

1042 
box
 = 9;

1044 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1045 
f
.
	`size
() > 5)

1046 
f
.
	`pİ_back
();

1047 
f
[2] = -1;

1048 
	`as£¹
(
t2
.
	`Œy_comm™
());

1050 
t1
.
	`u£
();

1051 
	`as£¹
(
f
[2] == -1);

1052 
	`as£¹
(
t1
.
	`Œy_comm™
());

1055 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

1056 
	}
}

1058 
	$‹¡NoO·c™y
() {

1059 
TVeùÜ_nİ»d
<, 
TNÚİaqueW¿µed
> 
f
;

1060 
TBox
<, 
TNÚİaqueW¿µed
<> > 
box
;

1062 
TRANSACTION_E
 {

1063 
i
 = 0; i < 10; i++)

1064 
f
.
	`push_back
(
i
);

1065 } 
	`RETRY_E
(
çl£
);

1068 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1069 
	`as£¹
(
f
[1] == 1);

1070 
box
 = 9;

1072 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1073 
f
.
	`pİ_back
();

1074 
	`as£¹
(
t2
.
	`Œy_comm™
());

1076 
t1
.
	`u£
();

1077 
	`as£¹
(
f
[2] == 2);

1078 
	`as£¹
(
t1
.
	`Œy_comm™
());

1080 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 9);

1084 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1085 
	`as£¹
(
f
[1] == 1);

1086 
	`as£¹
(
f
[4] == 4);

1087 
box
 = 9;

1089 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1090 
f
.
	`size
() > 3)

1091 
f
.
	`pİ_back
();

1092 
	`as£¹
(
t2
.
	`Œy_comm™
());

1094 
t1
.
	`u£
();

1095 
	`as£¹
(
f
[2] == 2);

1096 
	`as£¹
(!
t1
.
	`Œy_comm™
());

1098 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 3);

1101 
TRANSACTION_E
 {

1102 
f
.
	`size
() < 10)

1103 
f
.
	`push_back
(f.
	`size
());

1104 } 
	`RETRY_E
(
çl£
);

1107 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1108 
	`as£¹
(
f
[1] == 1);

1109 
	`as£¹
(
f
[4] == 4);

1110 
box
 = 9;

1112 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1113 
f
.
	`size
() > 3)

1114 
f
.
	`pİ_back
();

1115 
f
[2] = -1;

1116 
	`as£¹
(
t2
.
	`Œy_comm™
());

1118 
t1
.
	`u£
();

1119 
	`as£¹
(
f
[2] == -1);

1120 
	`as£¹
(!
t1
.
	`Œy_comm™
());

1123 
TRANSACTION_E
 {

1124 
f
.
	`size
() < 10)

1125 
f
.
	`push_back
(f.
	`size
());

1126 } 
	`RETRY_E
(
çl£
);

1129 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1130 
	`as£¹
(
f
[1] == 1);

1131 
	`as£¹
(
f
[4] == 4);

1132 
box
 = 9;

1134 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1135 
f
.
	`size
() > 3)

1136 
f
.
	`pİ_back
();

1137 
f
[2] = -1;

1138 
	`as£¹
(
t2
.
	`Œy_comm™
());

1140 
t1
.
	`u£
();

1141 
	`as£¹
(
f
.
	`size
() <= 4);

1142 
	`as£¹
(!
t1
.
	`Œy_comm™
());

1145 
TRANSACTION_E
 {

1146 
f
.
	`size
() < 10)

1147 
f
.
	`push_back
(f.
	`size
());

1148 } 
	`RETRY_E
(
çl£
);

1151 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1152 
	`as£¹
(
f
[1] == 1);

1153 
	`as£¹
(
f
[4] == 4);

1154 
box
 = 9;

1156 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1157 
f
.
	`size
() > 5)

1158 
f
.
	`pİ_back
();

1159 
f
[2] = -1;

1160 
	`as£¹
(
t2
.
	`Œy_comm™
());

1162 
t1
.
	`u£
();

1163 
	`as£¹
(
f
[2] == -1);

1164 
	`as£¹
(
t1
.
	`Œy_comm™
());

1167 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

1168 
	}
}

1172 
	$maš
() {

1173 
	`‹¡Sim¶eIÁ
();

1174 
	`‹¡Wr™eNPushBack
();

1175 
	`‹¡PushBack
();

1176 
	`‹¡PushBackNR—d
();

1177 
	`‹¡PushBackNR—d1
();

1178 
	`‹¡PushBackNR—d2
();

1179 
	`‹¡PushBackNWr™e
();

1180 
	`‹¡Sim¶eSŒšg
();

1181 
	`‹¡I‹r
();

1182 
	`‹¡CÚæiùšgI‹r
();

1183 
	`‹¡ModifyšgI‹r
();

1184 
	`‹¡CÚæiùšgModifyI‹r1
();

1185 
	`‹¡CÚæiùšgModifyI‹r2
();

1186 
	`‹¡CÚæiùšgModifyI‹r3
();

1187 
	`‹¡I‹rNPushBack
();

1188 
	`‹¡I‹rNPushBack1
();

1189 
	`‹¡I‹rNPushBack2
();

1190 
	`‹¡E¿£
();

1191 
	`‹¡In£¹
();

1192 
	`‹¡PushNPİ
();

1193 
	`‹¡PİAndUd·‹
();

1194 
	`‹¡MulPushPİs
();

1195 
	`‹¡MulPushPİs1
();

1196 
	`‹¡Upd©ePİ
();

1197 
	`‹¡I‹¿tÜB‘‹rSemªtics
();

1198 
	`‹¡SizeP»diÿ‹s
();

1199 
	`‹¡I‹rP»diÿ‹s
();

1200 
	`‹¡Resize
();

1201 
	`‹¡FrÚtBack
();

1202 
	`‹¡O·c™y
();

1203 
	`‹¡NoO·c™y
();

1205 
	}
}

	@test/unit-tvector.cc

1 #undeà
NDEBUG


2 
	~<¡ršg
>

3 
	~<io¡»am
>

4 
	~<as£¹.h
>

5 
	~<veùÜ
>

6 
	~"T¿n§ùiÚ.hh
"

7 
	~"TVeùÜ.hh
"

8 
	~"TBox.hh
"

9 
	#GUARDED
 ià(
T¿n§ùiÚGu¬d
 
tgu¬d
{})

	)

11 
	$‹¡Sim¶eIÁ
() {

12 
TVeùÜ
<> 
f
;

15 
T¿n§ùiÚGu¬d
 
t
;

16 
f
.
	`push_back
(100);

17 
f
.
	`push_back
(200);

18 *(
f
.
	`begš
()) = *(f.begin() + 1);

22 
T¿n§ùiÚGu¬d
 
t2
;

23 
f_»ad
 = 
f
[0];

24 
	`as£¹
(
f_»ad
 == 200);

27 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

28 
	}
}

30 
	$‹¡Wr™eNPushBack
() {

31 
TVeùÜ
<> 
f
;

34 
T¿n§ùiÚGu¬d
 
t
;

35 
f
.
	`push_back
(10);

38 
Te¡T¿n§ùiÚ
 
	`t2
(1);

39 
f
[0] = 4;

41 
Te¡T¿n§ùiÚ
 
	`t3
(2);

42 
f
.
	`push_back
(20);

44 
	`as£¹
(
t3
.
	`Œy_comm™
());

46 
	`as£¹
(
t2
.
	`Œy_comm™
());

49 
T¿n§ùiÚGu¬d
 
t4
;

50 
	`as£¹
(
f
[0] == 4);

53 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

54 
	}
}

56 
	$‹¡PushBack
() {

57 
TVeùÜ
<> 
f
;

60 
T¿n§ùiÚGu¬d
 
t
;

61 
f
.
	`push_back
(10);

64 
Te¡T¿n§ùiÚ
 
	`t2
(1);

65 
f
.
	`push_back
(4);

67 
Te¡T¿n§ùiÚ
 
	`t3
(2);

68 
f
.
	`push_back
(20);

69 
	`as£¹
(
t3
.
	`Œy_comm™
());

70 
	`as£¹
(
t2
.
	`Œy_comm™
());

73 
T¿n§ùiÚGu¬d
 
t4
;

74 
	`as£¹
(
f
[0] == 10);

75 
	`as£¹
(
f
[1] == 20);

76 
	`as£¹
(
f
[2] == 4);

79 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

80 
	}
}

83 
	$‹¡PushBackNR—d
() {

84 
TVeùÜ
<> 
f
;

87 
T¿n§ùiÚGu¬d
 
t
;

88 
f
.
	`push_back
(10);

92 
T¿n§ùiÚGu¬d
 
t2
;

93 
f
.
	`push_back
(4);

94 
	`as£¹
(
f
[1] == 4);

97 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

98 
	}
}

100 
	$‹¡PushBackNR—d1
() {

101 
TVeùÜ
<> 
f
;

104 
T¿n§ùiÚGu¬d
 
t
;

105 
f
.
	`push_back
(10);

108 
Te¡T¿n§ùiÚ
 
	`t2
(1);

109 
f
.
	`push_back
(4);

110 
	`as£¹
(
f
[1] == 4);

112 
Te¡T¿n§ùiÚ
 
	`t3
(2);

113 
f
.
	`push_back
(20);

114 
	`as£¹
(
t3
.
	`Œy_comm™
());

115 
	`as£¹
(!
t2
.
	`Œy_comm™
());

119 
Te¡T¿n§ùiÚ
 
	`t1
(1);

120 
	`as£¹
(
f
.
	`ŒªsG‘_throws
(0) == 10);

122 
Te¡T¿n§ùiÚ
 
	`t2
(2);

123 
f
.
	`pİ_back
();

124 
	`as£¹
(
t2
.
	`Œy_comm™
());

125 
	`as£¹
(
t1
.
	`Œy_comm™
());

129 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

130 
	}
}

132 
	$‹¡PushBackNR—d2
() {

133 
TVeùÜ
<> 
f
;

136 
T¿n§ùiÚGu¬d
 
t
;

137 
f
.
	`push_back
(10);

140 
Te¡T¿n§ùiÚ
 
	`t2
(1);

141 
f
.
	`push_back
(4);

142 
	`as£¹
(
f
[f.
	`size
() - 1] == 4);

144 
Te¡T¿n§ùiÚ
 
	`t3
(2);

145 
f
.
	`push_back
(20);

147 
	`as£¹
(
t3
.
	`Œy_comm™
());

148 
	`as£¹
(!
t2
.
	`Œy_comm™
());

150 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

151 
	}
}

154 
	$‹¡PushBackNWr™e
() {

155 
TVeùÜ
<> 
f
;

158 
T¿n§ùiÚGu¬d
 
t
;

159 
f
.
	`push_back
(10);

163 
T¿n§ùiÚGu¬d
 
t2
;

164 
f
.
	`push_back
(4);

165 
f
[1] = 10;

169 
T¿n§ùiÚGu¬d
 
t3
;

170 
	`as£¹
(
f
[1] == 10);

173 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

174 
	}
}

178 
	$‹¡Sim¶eSŒšg
() {

179 
TVeùÜ
<
¡d
::
¡ršg
> 
f
;

182 
T¿n§ùiÚGu¬d
 
t
;

183 
f
.
	`push_back
("100");

187 
T¿n§ùiÚGu¬d
 
t2
;

188 
¡d
::
¡ršg
 
f_»ad
 = 
f
[0];

189 
	`as£¹
(
f_»ad
.
	`com·»
("100") == 0);

192 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

193 
	}
}

195 
	$‹¡I‹r
() {

196 
¡d
::
veùÜ
<> 
¬r
;

197 
TVeùÜ
<> 
f
;

198 
TRANSACTION_E
 {

199 
i
 = 0; i < 10; i++) {

200 
x
 = 
	`¿nd
();

201 
f
.
	`push_back
(
x
);

202 
¬r
.
	`push_back
(
x
);

204 } 
	`RETRY_E
(
çl£
);

206 
max
;

207 
TRANSACTION_E
 {

208 
max
 = *(
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
()));

209 } 
	`RETRY_E
(
çl£
);

211 
	`as£¹
(
max
 =ğ*(
¡d
::
	`max_–em’t
(
¬r
.
	`begš
(),‡¼.
	`’d
())));

212 
	`´štf
("Max i %i\n", 
max
);

213 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

214 
	}
}

217 
	$‹¡CÚæiùšgI‹r
() {

218 
TVeùÜ
<> 
f
;

219 
TBox
<> 
box
;

220 
TRANSACTION_E
 {

221 
i
 = 0; i < 10; i++) {

222 
f
.
	`push_back
(
i
);

224 } 
	`RETRY_E
(
çl£
);

226 
Te¡T¿n§ùiÚ
 
	`t
(1);

227 
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
());

228 
box
 = 9;

230 
Te¡T¿n§ùiÚ
 
	`t1
(2);

231 
f
[4] = 10;

232 
	`as£¹
(
t1
.
	`Œy_comm™
());

233 
	`as£¹
(!
t
.
	`Œy_comm™
());

235 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

236 
	}
}

238 
	$‹¡ModifyšgI‹r
() {

239 
TVeùÜ
<> 
f
;

241 
T¿n§ùiÚGu¬d
 
‰
;

242 
i
 = 0; i < 10; i++) {

243 
f
.
	`push_back
(
i
);

248 
T¿n§ùiÚGu¬d
 
t
;

249 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

253 
T¿n§ùiÚGu¬d
 
t1
;

254 
v
 = 
f
[4];

255 
	`as£¹
(
v
 == 6);

258 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

259 
	}
}

261 
	$‹¡CÚæiùšgModifyI‹r1
() {

262 
TVeùÜ
<> 
f
;

263 
TRANSACTION_E
 {

264 
i
 = 0; i < 10; i++) {

265 
f
.
	`push_back
(
i
);

267 } 
	`RETRY_E
(
çl£
);

269 
Te¡T¿n§ùiÚ
 
	`t
(1);

270 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

272 
Te¡T¿n§ùiÚ
 
	`t1
(2);

273 
f
[4] = 10;

274 
	`as£¹
(
t1
.
	`Œy_comm™
());

275 
	`as£¹
(!
t
.
	`Œy_comm™
());

278 
T¿n§ùiÚGu¬d
 
t2
;

279 
v
 = 
f
[4];

280 
	`as£¹
(
v
 == 10);

283 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

284 
	}
}

286 
	$‹¡CÚæiùšgModifyI‹r2
() {

287 
TVeùÜ
<> 
f
;

288 
TRANSACTION_E
 {

289 
i
 = 0; i < 10; i++) {

290 
f
.
	`push_back
(
i
);

292 } 
	`RETRY_E
(
çl£
);

295 
T¿n§ùiÚGu¬d
 
t
;

296 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

300 
T¿n§ùiÚGu¬d
 
t1
;

301 
f
[4] = 10;

305 
T¿n§ùiÚGu¬d
 
t2
;

306 
v
 = 
f
[4];

307 
	`as£¹
(
v
 == 10);

310 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

311 
	}
}

313 
	$‹¡CÚæiùšgModifyI‹r3
() {

314 
TVeùÜ
<> 
f
;

315 
TBox
<> 
box
;

316 
TRANSACTION_E
 {

317 
i
 = 0; i < 10; i++) {

318 
f
.
	`push_back
(
i
);

320 } 
	`RETRY_E
(
çl£
);

322 
Te¡T¿n§ùiÚ
 
	`t1
(1);

323 (è
f
[4];

324 
box
 = 9;

326 
Te¡T¿n§ùiÚ
 
	`t
(2);

327 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

328 
	`as£¹
(
t
.
	`Œy_comm™
());

329 
	`as£¹
(!
t1
.
	`Œy_comm™
());

332 
T¿n§ùiÚGu¬d
 
t2
;

333 
v
 = 
f
[4];

334 
	`as£¹
(
v
 == 6);

337 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

338 
	}
}

340 
	$‹¡I‹rNPushBack
() {

341 
TVeùÜ
<> 
f
;

342 
TRANSACTION_E
 {

343 
i
 = 0; i < 10; i++) {

344 
f
.
	`push_back
(
i
);

346 } 
	`RETRY_E
(
çl£
);

348 
max
;

349 
TRANSACTION_E
 {

350 
f
.
	`push_back
(20);

351 
max
 = *(
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
()));

352 } 
	`RETRY_E
(
çl£
);

354 
	`as£¹
(
max
 == 20);

355 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

356 
	}
}

358 
	$‹¡I‹rNPushBack1
() {

359 
TVeùÜ
<> 
f
;

361 
T¿n§ùiÚGu¬d
 
‰
;

362 
i
 = 0; i < 10; i++) {

363 
f
.
	`push_back
(
i
);

367 
max
;

368 
Te¡T¿n§ùiÚ
 
	`t1
(1);

369 
f
.
	`push_back
(20);

370 
max
 = *(
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
()));

371 
	`as£¹
(
max
 == 20);

373 
Te¡T¿n§ùiÚ
 
	`t2
(2);

374 
f
.
	`push_back
(12);

375 
	`as£¹
(
t2
.
	`Œy_comm™
());

376 
	`as£¹
(!
t1
.
	`Œy_comm™
());

378 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

379 
	}
}

381 
	$‹¡I‹rNPushBack2
() {

382 
TVeùÜ
<> 
f
;

383 
TBox
<> 
box
;

386 
T¿n§ùiÚGu¬d
 
‰
;

387 
i
 = 0; i < 10; i++) {

388 
f
.
	`push_back
(
i
);

392 
Te¡T¿n§ùiÚ
 
	`t1
(1);

393 
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
());

394 
box
 = 9;

396 
Te¡T¿n§ùiÚ
 
	`t2
(2);

397 
f
.
	`push_back
(2);

398 
	`as£¹
(
t2
.
	`Œy_comm™
());

399 
	`as£¹
(!
t1
.
	`Œy_comm™
());

401 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

402 
	}
}

405 
	$‹¡E¿£
() {

406 
TVeùÜ
<> 
f
;

408 
TRANSACTION_E
 {

409 
i
 = 0; i < 10; i++)

410 
f
.
	`push_back
(
i
);

411 } 
	`RETRY_E
(
çl£
);

414 
T¿n§ùiÚGu¬d
 
t1
;

415 
f
.
	`”a£
(f.
	`begš
() + 5);

418 
TRANSACTION_E
 {

419 
	`as£¹
(
f
.
	`size
() == 9);

420 
x
[9] = {0, 1, 2, 3, 4, 6, 7, 8, 9};

421 
i
 = 0; i < 9; ++i)

422 
	`as£¹
(
f
[
i
] =ğ
x
[i]);

423 } 
	`RETRY_E
(
çl£
);

425 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

426 
	}
}

428 
	$‹¡In£¹
() {

429 
TVeùÜ
<> 
f
;

431 
TRANSACTION_E
 {

432 
i
 = 0; i < 10; i++)

433 
f
.
	`push_back
(
i
);

434 } 
	`RETRY_E
(
çl£
);

437 
T¿n§ùiÚGu¬d
 
t1
;

438 
f
.
	`š£¹
(f.
	`begš
() + 5, 25);

441 
TRANSACTION_E
 {

442 
	`as£¹
(
f
.
	`size
() == 11);

443 
x
[] = {0, 1, 2, 3, 4, 25, 5, 6, 7, 8, 9};

444 
i
 = 0; i < 11; ++i)

445 
	`as£¹
(
f
[
i
] =ğ
x
[i]);

446 } 
	`RETRY_E
(
çl£
);

448 
GUARDED
 {

449 
f
.
	`š£¹
(f.
	`’d
(), 30);

452 
TRANSACTION_E
 {

453 
	`as£¹
(
f
.
	`size
() == 12);

454 
x
[] = {0, 1, 2, 3, 4, 25, 5, 6, 7, 8, 9, 30};

455 
i
 = 0; i < 12; ++i)

456 
	`as£¹
(
f
[
i
] =ğ
x
[i]);

457 } 
	`RETRY_E
(
çl£
);

459 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

460 
	}
}

462 
	$‹¡PushNPİ
() {

463 
TVeùÜ
<> 
f
;

464 
TBox
<> 
box
;

466 
TRANSACTION_E
 {

467 
i
 = 0; i < 10; i++) {

468 
f
.
	`push_back
(
i
);

470 } 
	`RETRY_E
(
çl£
);

473 
T¿n§ùiÚGu¬d
 
t
;

474 
f
.
	`push_back
(20);

475 
f
.
	`push_back
(21);

476 
	`as£¹
(
f
[0] == 0);

477 
	`as£¹
(
f
.
	`size
() == 12);

479 
f
.
	`pİ_back
();

480 
f
.
	`pİ_back
();

484 
Te¡T¿n§ùiÚ
 
	`t1
(1);

485 
f
.
	`pİ_back
();

486 
f
.
	`push_back
(15);

488 
Te¡T¿n§ùiÚ
 
	`t2
(2);

489 
f
.
	`push_back
(20);

490 
	`as£¹
(
t2
.
	`Œy_comm™
());

491 
	`as£¹
(
t1
.
	`Œy_comm™
());

493 
TRANSACTION_E
 {

494 
	`as£¹
(
f
.
	`size
() == 11);

495 
	`as£¹
(
f
[10] == 15);

496 } 
	`RETRY_E
(
çl£
);

500 
Te¡T¿n§ùiÚ
 
	`t1
(1);

501 
f
.
	`pİ_back
();

502 
f
.
	`push_back
(18);

503 
	`as£¹
(
f
[10] == 18);

505 
Te¡T¿n§ùiÚ
 
	`t2
(2);

506 
f
.
	`push_back
(21);

507 
	`as£¹
(
t2
.
	`Œy_comm™
());

509 
	`as£¹
(!
t1
.
	`Œy_comm™
());

511 
TRANSACTION_E
 {

512 
	`as£¹
(
f
.
	`size
() == 12);

513 
	`as£¹
(
f
[10] == 15);

514 
f
.
	`pİ_back
();

515 } 
	`RETRY_E
(
çl£
);

518 
	`´štf
("PASS:estPushNPop\n");

520 
Te¡T¿n§ùiÚ
 
	`t3
(1);

521 
f
.
	`pİ_back
();

522 
f
.
	`push_back
(15);

524 
Te¡T¿n§ùiÚ
 
	`t4
(2);

525 
f
.
	`pİ_back
();

526 
	`as£¹
(
t4
.
	`Œy_comm™
());

527 
	`as£¹
(
t3
.
	`Œy_comm™
());

529 
TRANSACTION_E
 {

530 
	`as£¹
(
f
.
	`size
() == 10);

531 } 
	`RETRY_E
(
çl£
);

533 
	`´štf
("PASS:estPushNPop1\n");

535 
Te¡T¿n§ùiÚ
 
	`t5
(1);

536 
f
.
	`pİ_back
();

537 
f
.
	`pİ_back
();

538 
f
.
	`push_back
(15);

540 
Te¡T¿n§ùiÚ
 
	`t6
(2);

541 
f
[8] = 16;

542 
	`as£¹
(
t6
.
	`Œy_comm™
());

544 
Te¡T¿n§ùiÚ
 
	`t7
(3);

545 (è
f
[8];

546 
box
 = 9;

548 
	`as£¹
(
t5
.
	`Œy_comm™
());

549 
	`as£¹
(!
t7
.
	`Œy_comm™
());

551 
TRANSACTION_E
 {

552 
	`as£¹
(
f
.
	`size
() == 9);

553 
	`as£¹
(
f
[8] == 15);

554 } 
	`RETRY_E
(
çl£
);

556 
	`´štf
("PASS:estPushNPop2\n");

557 
	}
}

559 
	$‹¡PİAndUpd©e
() {

560 
TVeùÜ
<> 
f
;

562 
TRANSACTION_E
 {

563 
i
 = 0; i < 10; i++) {

564 
f
.
	`push_back
(
i
);

566 } 
	`RETRY_E
(
çl£
);

568 
Te¡T¿n§ùiÚ
 
	`t1
(1);

569 
f
[9] = 20;

571 
Te¡T¿n§ùiÚ
 
	`t2
(2);

572 
f
.
	`pİ_back
();

573 
f
.
	`pİ_back
();

574 
	`as£¹
(
t2
.
	`Œy_comm™
());

575 
	`as£¹
(!
t1
.
	`Œy_comm™
());

576 
	}
}

578 
	$‹¡MulPushPİs
() {

579 
TVeùÜ
<> 
f
;

581 
TRANSACTION_E
 {

582 
i
 = 0; i < 10; i++) {

583 
f
.
	`push_back
(
i
);

585 } 
	`RETRY_E
(
çl£
);

588 
T¿n§ùiÚGu¬d
 
t1
;

589 
f
.
	`push_back
(100);

590 
f
.
	`push_back
(200);

591 
f
.
	`pİ_back
();

592 
f
.
	`pİ_back
();

593 
f
.
	`pİ_back
();

595 
	}
}

597 
	$‹¡MulPushPİs1
() {

598 
TVeùÜ
<> 
f
;

600 
TRANSACTION_E
 {

601 
i
 = 0; i < 10; i++) {

602 
f
.
	`push_back
(
i
);

604 } 
	`RETRY_E
(
çl£
);

607 
T¿n§ùiÚGu¬d
 
t1
;

608 
f
.
	`push_back
(100);

609 
f
.
	`push_back
(200);

610 
f
.
	`pİ_back
();

611 
f
.
	`pİ_back
();

612 
f
.
	`push_back
(300);

614 
	}
}

616 
	$‹¡Upd©ePİ
() {

617 
TVeùÜ
<> 
f
;

619 
TRANSACTION_E
 {

620 
i
 = 0; i < 10; i++) {

621 
f
.
	`push_back
(
i
);

623 } 
	`RETRY_E
(
çl£
);

626 
T¿n§ùiÚGu¬d
 
t1
;

627 
f
[9] = 20;

628 
f
.
	`pİ_back
();

630 
	}
}

632 
	$‹¡I‹¿tÜB‘‹rSemªtics
() {

633 
TVeùÜ
<> 
f
;

634 
TBox
<> 
box
;

636 
TRANSACTION_E
 {

637 
i
 = 0; i < 10; i++) {

638 
f
.
	`push_back
(
i
);

640 } 
	`RETRY_E
(
çl£
);

642 
Te¡T¿n§ùiÚ
 
	`t1
(1);

645 
TVeùÜ
<>::
™”©Ü
 
™
;

646 
™
 = 
f
.
	`begš
(); iˆ!ğf.
	`’d
(); ++it)

647 ià(*
™
 == 5)

649 
box
 = 9;

651 
Te¡T¿n§ùiÚ
 
	`t2
(2);

652 
f
.
	`push_back
(12);

653 
	`as£¹
(
t2
.
	`Œy_comm™
());

654 
t1
.
	`u£
();

655 
x
 = *
™
;

656 
	`as£¹
(
t1
.
	`Œy_comm™
());

657 
	`as£¹
(
x
 == 5);

659 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

660 
	}
}

662 
	$‹¡SizeP»diÿ‹s
() {

663 
TVeùÜ
<> 
f
;

664 
TBox
<> 
box
;

666 
TRANSACTION_E
 {

667 
i
 = 0; i < 10; i++)

668 
f
.
	`push_back
(
i
);

669 } 
	`RETRY_E
(
çl£
);

672 
Te¡T¿n§ùiÚ
 
	`t1
(1);

673 
	`as£¹
(
f
.
	`size
() > 5);

674 
box
 = 9;

676 
Te¡T¿n§ùiÚ
 
	`t2
(2);

677 
i
 = 0; i < 4; ++i)

678 
f
.
	`pİ_back
();

679 
	`as£¹
(
t2
.
	`Œy_comm™
());

680 
	`as£¹
(
t1
.
	`Œy_comm™
());

682 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 6);

686 
Te¡T¿n§ùiÚ
 
	`t1
(1);

687 
	`as£¹
(
f
.
	`size
() > 4);

688 
box
 = 9;

690 
Te¡T¿n§ùiÚ
 
	`t2
(2);

691 
f
.
	`size
() > 4)

692 
f
.
	`pİ_back
();

693 
	`as£¹
(
t2
.
	`Œy_comm™
());

694 
	`as£¹
(!
t1
.
	`Œy_comm™
());

696 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 4);

700 
Te¡T¿n§ùiÚ
 
	`t0
(1);

701 
f
.
	`size
() < 6)

702 
f
.
	`push_back
(f.
	`size
());

703 
	`as£¹
(
t0
.
	`Œy_comm™
());

705 
Te¡T¿n§ùiÚ
 
	`t1
(1);

706 
	`as£¹
(
f
.
	`size
() > 4);

707 
box
 = 9;

709 
Te¡T¿n§ùiÚ
 
	`t2
(2);

710 
f
.
	`size
() > 4)

711 
f
.
	`pİ_back
();

712 
	`as£¹
(
t1
.
	`Œy_comm™
());

713 
	`as£¹
(
t2
.
	`Œy_comm™
());

715 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 4);

719 
Te¡T¿n§ùiÚ
 
	`t1
(1);

720 
	`as£¹
(
f
.
	`size
() < 6);

721 
box
 = 9;

723 
Te¡T¿n§ùiÚ
 
	`t2
(2);

724 
f
.
	`size
() < 6)

725 
f
.
	`push_back
(f.
	`size
());

726 
	`as£¹
(
t2
.
	`Œy_comm™
());

727 
	`as£¹
(!
t1
.
	`Œy_comm™
());

729 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 6);

733 
Te¡T¿n§ùiÚ
 
	`t1
(1);

734 
	`as£¹
(
f
.
	`size
() < 8);

735 
box
 = 9;

737 
Te¡T¿n§ùiÚ
 
	`t2
(2);

738 
f
.
	`size
() < 8)

739 
f
.
	`push_back
(f.
	`size
());

740 
	`as£¹
(
t1
.
	`Œy_comm™
());

741 
	`as£¹
(
t2
.
	`Œy_comm™
());

743 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 8);

746 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

747 
	}
}

749 
	$‹¡I‹rP»diÿ‹s
() {

750 
TVeùÜ
<> 
f
;

751 
TBox
<> 
box
;

753 
TRANSACTION_E
 {

754 
i
 = 0; i < 10; i++)

755 
f
.
	`push_back
(
i
);

756 } 
	`RETRY_E
(
çl£
);

759 
Te¡T¿n§ùiÚ
 
	`t1
(1);

760 
	`as£¹
(
f
.
	`begš
(è+ 5 < f.
	`’d
());

761 
box
 = 9;

763 
Te¡T¿n§ùiÚ
 
	`t2
(2);

764 
i
 = 0; i < 4; ++i)

765 
f
.
	`pİ_back
();

766 
	`as£¹
(
t2
.
	`Œy_comm™
());

767 
	`as£¹
(
t1
.
	`Œy_comm™
());

769 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 6);

773 
Te¡T¿n§ùiÚ
 
	`t1
(1);

774 
	`as£¹
(
f
.
	`begš
(è+ 4 < f.
	`’d
());

775 
box
 = 9;

777 
Te¡T¿n§ùiÚ
 
	`t2
(2);

778 
f
.
	`size
() > 4)

779 
f
.
	`pİ_back
();

780 
	`as£¹
(
t2
.
	`Œy_comm™
());

781 
	`as£¹
(!
t1
.
	`Œy_comm™
());

783 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 4);

787 
Te¡T¿n§ùiÚ
 
	`t0
(1);

788 
f
.
	`size
() < 6)

789 
f
.
	`push_back
(f.
	`size
());

790 
	`as£¹
(
t0
.
	`Œy_comm™
());

792 
Te¡T¿n§ùiÚ
 
	`t1
(1);

793 
	`as£¹
(
f
.
	`’d
(è> f.
	`begš
() + 4);

794 
box
 = 9;

796 
Te¡T¿n§ùiÚ
 
	`t2
(2);

797 
f
.
	`size
() > 4)

798 
f
.
	`pİ_back
();

799 
	`as£¹
(
t1
.
	`Œy_comm™
());

800 
	`as£¹
(
t2
.
	`Œy_comm™
());

802 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 4);

806 
Te¡T¿n§ùiÚ
 
	`t1
(1);

807 
	`as£¹
(
f
.
	`’d
(è<ğf.
	`begš
() + 5);

808 
box
 = 9;

810 
Te¡T¿n§ùiÚ
 
	`t2
(2);

811 
f
.
	`size
() < 6)

812 
f
.
	`push_back
(f.
	`size
());

813 
	`as£¹
(
t2
.
	`Œy_comm™
());

814 
	`as£¹
(!
t1
.
	`Œy_comm™
());

816 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 6);

820 
Te¡T¿n§ùiÚ
 
	`t1
(1);

821 
	`as£¹
(
f
.
	`’d
(è- f.
	`begš
() < 8);

822 
box
 = 9;

824 
Te¡T¿n§ùiÚ
 
	`t2
(2);

825 
f
.
	`size
() < 8)

826 
f
.
	`push_back
(f.
	`size
());

827 
	`as£¹
(
t1
.
	`Œy_comm™
());

828 
	`as£¹
(
t2
.
	`Œy_comm™
());

830 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 8);

834 
Te¡T¿n§ùiÚ
 
	`t1
(1);

835 
	`as£¹
(
f
.
	`’d
(è- f.
	`begš
() < 9);

836 
box
 = 9;

838 
Te¡T¿n§ùiÚ
 
	`t2
(2);

839 
f
.
	`size
() < 9)

840 
f
.
	`push_back
(f.
	`size
());

841 
	`as£¹
(
t2
.
	`Œy_comm™
());

842 
	`as£¹
(!
t1
.
	`Œy_comm™
());

844 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 9);

848 
Te¡T¿n§ùiÚ
 
	`t1
(1);

849 
	`as£¹
(
f
.
	`begš
(è- f.
	`’d
() == -9);

850 
	`as£¹
(
t1
.
	`Œy_comm™
());

852 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 9);

855 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

856 
	}
}

858 
	$‹¡Resize
() {

859 
TVeùÜ
<> 
f
;

860 
TBox
<> 
box
;

862 
TRANSACTION_E
 {

863 
i
 = 0; i < 10; i++)

864 
f
.
	`push_back
(
i
);

865 } 
	`RETRY_E
(
çl£
);

868 
Te¡T¿n§ùiÚ
 
	`t1
(1);

869 
	`as£¹
(
f
[1] == 1);

870 
box
 = 9;

872 
Te¡T¿n§ùiÚ
 
	`t2
(2);

873 
f
.
	`»size
(4);

874 
	`as£¹
(
t2
.
	`Œy_comm™
());

876 
t1
.
	`u£
();

877 
	`as£¹
(
f
.
	`size
() >= 4);

878 
	`as£¹
(
t1
.
	`Œy_comm™
());

880 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 4);

884 
Te¡T¿n§ùiÚ
 
	`t1
(1);

885 
	`as£¹
(
f
[1] == 1);

886 
	`as£¹
(
f
.
	`size
() >= 4);

887 
box
 = 9;

889 
Te¡T¿n§ùiÚ
 
	`t2
(2);

890 
f
.
	`»size
(5, -100);

891 
	`as£¹
(
t2
.
	`Œy_comm™
());

892 
	`as£¹
(
t1
.
	`Œy_comm™
());

894 
Te¡T¿n§ùiÚ
 
	`t3
(3);

895 
	`as£¹
(
f
.
	`size
() == 5);

896 
	`as£¹
(
f
[0] == 0);

897 
	`as£¹
(
f
[1] == 1);

898 
	`as£¹
(
f
[2] == 2);

899 
	`as£¹
(
f
[3] == 3);

900 
	`as£¹
(
f
[4] == -100);

901 
	`as£¹
(
t3
.
	`Œy_comm™
());

904 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

905 
	}
}

907 
	$‹¡FrÚtBack
() {

908 
TVeùÜ
<> 
v
;

910 
GUARDED
 {

911 
i
 = 0; i < 10; ++i)

912 
v
.
	`push_back
(
i
);

915 
GUARDED
 {

916 
	`as£¹
(
v
.
	`size
() == 10);

919 
GUARDED
 {

920 
	`as£¹
(
v
.
	`äÚt
() == 0);

921 
	`as£¹
(
v
.
	`back
() == 9);

923 
v
.
	`pİ_back
();

925 
	`as£¹
(
v
.
	`back
() == 8);

927 
v
.
	`push_back
(30);

929 
	`as£¹
(
v
.
	`back
() == 30);

932 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

933 
	}
}

935 
	$‹¡IndexPushOv”Ïp
() {

936 
TVeùÜ
<> 
v
;

938 
TRANSACTION_E
 {

939 
i
 = 0; i < 3; i++)

940 
v
.
	`push_back
(
i
);

941 } 
	`RETRY_E
(
çl£
);

944 
Te¡T¿n§ùiÚ
 
	`t1
(1);

945 
v
[0] = -1;

946 
v
.
	`pİ_back
();

947 
v
.
	`pİ_back
();

948 
v
.
	`push_back
(-2);

949 
v
[0] = -3;

950 
	`as£¹
(
t1
.
	`Œy_comm™
());

951 
	`as£¹
(
v
.
	`nÚŒªs_size
() == 2);

952 
	`as£¹
(
v
.
	`nÚŒªs_g‘
(0) == -3);

953 
	`as£¹
(
v
.
	`nÚŒªs_g‘
(1) == -2);

956 
TRANSACTION_E
 {

957 
v
.
	`ş—r
();

958 
i
 = 0; i < 3; i++)

959 
v
.
	`push_back
(
i
);

960 } 
	`RETRY_E
(
çl£
);

963 
Te¡T¿n§ùiÚ
 
	`t1
(1);

964 
v
[0] = -1;

965 
v
.
	`pİ_back
();

966 
v
.
	`pİ_back
();

967 
v
.
	`push_back
(-2);

968 
v
[0] = -3;

970 
Te¡T¿n§ùiÚ
 
	`t2
(2);

971 
v
.
	`pİ_back
();

972 
	`as£¹
(
t2
.
	`Œy_comm™
());

973 
	`as£¹
(!
t1
.
	`Œy_comm™
());

976 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

977 
	}
}

979 
	$‹¡O·c™y
() {

980 
TVeùÜ
<> 
f
;

981 
TBox
<> 
box
;

983 
TRANSACTION_E
 {

984 
i
 = 0; i < 10; i++)

985 
f
.
	`push_back
(
i
);

986 } 
	`RETRY_E
(
çl£
);

989 
Te¡T¿n§ùiÚ
 
	`t1
(1);

990 
	`as£¹
(
f
[1] == 1);

991 
box
 = 9;

993 
Te¡T¿n§ùiÚ
 
	`t2
(2);

994 
f
.
	`pİ_back
();

995 
	`as£¹
(
t2
.
	`Œy_comm™
());

997 
t1
.
	`u£
();

998 
	`as£¹
(
f
[2] == 2);

999 
	`as£¹
(
t1
.
	`Œy_comm™
());

1001 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 9);

1005 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1006 
	`as£¹
(
f
[1] == 1);

1007 
	`as£¹
(
f
[4] == 4);

1008 
box
 = 9;

1010 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1011 
f
.
	`size
() > 3)

1012 
f
.
	`pİ_back
();

1013 
	`as£¹
(
t2
.
	`Œy_comm™
());

1015 
t1
.
	`u£
();

1016 
	`as£¹
(
f
[2] == 2);

1017 
	`as£¹
(!
t1
.
	`Œy_comm™
());

1019 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 3);

1022 
TRANSACTION_E
 {

1023 
f
.
	`size
() < 10)

1024 
f
.
	`push_back
(f.
	`size
());

1025 } 
	`RETRY_E
(
çl£
);

1027 
Œy
 {

1028 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1029 
	`as£¹
(
f
[1] == 1);

1030 
	`as£¹
(
f
[4] == 4);

1031 
box
 = 9;

1033 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1034 
f
.
	`size
() > 3)

1035 
f
.
	`pİ_back
();

1036 
f
[2] = -1;

1037 
	`as£¹
(
t2
.
	`Œy_comm™
());

1039 
t1
.
	`u£
();

1040 
	`as£¹
(
f
[2] == -1);

1041 
	`as£¹
(
çl£
 && "should‚ot get here b/c opacity");

1042 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

1045 
TRANSACTION_E
 {

1046 
f
.
	`size
() < 10)

1047 
f
.
	`push_back
(f.
	`size
());

1048 } 
	`RETRY_E
(
çl£
);

1050 
Œy
 {

1051 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1052 
	`as£¹
(
f
[1] == 1);

1053 
	`as£¹
(
f
[4] == 4);

1054 
box
 = 9;

1056 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1057 
f
.
	`size
() > 3)

1058 
f
.
	`pİ_back
();

1059 
f
[2] = -1;

1060 
	`as£¹
(
t2
.
	`Œy_comm™
());

1062 
t1
.
	`u£
();

1063 
	`as£¹
(
f
.
	`size
() > 4);

1064 
	`as£¹
(
çl£
 && "should‚ot get here b/c opacity");

1065 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

1068 
TRANSACTION_E
 {

1069 
f
.
	`size
() < 10)

1070 
f
.
	`push_back
(f.
	`size
());

1071 } 
	`RETRY_E
(
çl£
);

1073 
Œy
 {

1074 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1075 
f
[1] = 1;

1076 
f
[4] = 4;

1078 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1079 
f
.
	`size
() > 3)

1080 
f
.
	`pİ_back
();

1081 
f
[2] = -1;

1082 
	`as£¹
(
t2
.
	`Œy_comm™
());

1084 
t1
.
	`u£
();

1085 
	`as£¹
(
f
.
	`size
() > 4);

1086 
	`as£¹
(
çl£
 && "should‚ot get here b/c opacity");

1087 } 
	`ÿtch
 (
T¿n§ùiÚ
::
AbÜt
 
e
) {

1090 
TRANSACTION_E
 {

1091 
f
.
	`size
() < 10)

1092 
f
.
	`push_back
(f.
	`size
());

1093 } 
	`RETRY_E
(
çl£
);

1096 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1097 
	`as£¹
(
f
[1] == 1);

1098 
	`as£¹
(
f
[4] == 4);

1099 
box
 = 9;

1101 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1102 
f
.
	`size
() > 5)

1103 
f
.
	`pİ_back
();

1104 
f
[2] = -1;

1105 
	`as£¹
(
t2
.
	`Œy_comm™
());

1107 
t1
.
	`u£
();

1108 
	`as£¹
(
f
[2] == -1);

1109 
	`as£¹
(
t1
.
	`Œy_comm™
());

1112 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

1113 
	}
}

1115 
	$‹¡NoO·c™y
() {

1116 
TVeùÜ
<, 
TNÚİaqueW¿µed
> 
f
;

1117 
TBox
<, 
TNÚİaqueW¿µed
<> > 
box
;

1119 
TRANSACTION_E
 {

1120 
i
 = 0; i < 10; i++)

1121 
f
.
	`push_back
(
i
);

1122 } 
	`RETRY_E
(
çl£
);

1125 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1126 
	`as£¹
(
f
[1] == 1);

1127 
box
 = 9;

1129 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1130 
f
.
	`pİ_back
();

1131 
	`as£¹
(
t2
.
	`Œy_comm™
());

1133 
t1
.
	`u£
();

1134 
	`as£¹
(
f
[2] == 2);

1135 
	`as£¹
(
t1
.
	`Œy_comm™
());

1137 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 9);

1141 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1142 
	`as£¹
(
f
[1] == 1);

1143 
	`as£¹
(
f
[4] == 4);

1144 
box
 = 9;

1146 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1147 
f
.
	`size
() > 3)

1148 
f
.
	`pİ_back
();

1149 
	`as£¹
(
t2
.
	`Œy_comm™
());

1151 
t1
.
	`u£
();

1152 
	`as£¹
(
f
[2] == 2);

1153 
	`as£¹
(!
t1
.
	`Œy_comm™
());

1155 
	`as£¹
(
f
.
	`nÚŒªs_size
() == 3);

1158 
TRANSACTION_E
 {

1159 
f
.
	`size
() < 10)

1160 
f
.
	`push_back
(f.
	`size
());

1161 } 
	`RETRY_E
(
çl£
);

1164 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1165 
	`as£¹
(
f
[1] == 1);

1166 
	`as£¹
(
f
[4] == 4);

1167 
box
 = 9;

1169 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1170 
f
.
	`size
() > 3)

1171 
f
.
	`pİ_back
();

1172 
f
[2] = -1;

1173 
	`as£¹
(
t2
.
	`Œy_comm™
());

1175 
t1
.
	`u£
();

1176 
	`as£¹
(
f
[2] == -1);

1177 
	`as£¹
(!
t1
.
	`Œy_comm™
());

1180 
TRANSACTION_E
 {

1181 
f
.
	`size
() < 10)

1182 
f
.
	`push_back
(f.
	`size
());

1183 } 
	`RETRY_E
(
çl£
);

1186 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1187 
	`as£¹
(
f
[1] == 1);

1188 
	`as£¹
(
f
[4] == 4);

1189 
box
 = 9;

1191 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1192 
f
.
	`size
() > 3)

1193 
f
.
	`pİ_back
();

1194 
f
[2] = -1;

1195 
	`as£¹
(
t2
.
	`Œy_comm™
());

1197 
t1
.
	`u£
();

1198 
	`as£¹
(
f
.
	`size
() == 3);

1199 
	`as£¹
(!
t1
.
	`Œy_comm™
());

1202 
TRANSACTION_E
 {

1203 
f
.
	`size
() < 10)

1204 
f
.
	`push_back
(f.
	`size
());

1205 } 
	`RETRY_E
(
çl£
);

1208 
Te¡T¿n§ùiÚ
 
	`t1
(1);

1209 
	`as£¹
(
f
[1] == 1);

1210 
	`as£¹
(
f
[4] == 4);

1211 
box
 = 9;

1213 
Te¡T¿n§ùiÚ
 
	`t2
(2);

1214 
f
.
	`size
() > 5)

1215 
f
.
	`pİ_back
();

1216 
f
[2] = -1;

1217 
	`as£¹
(
t2
.
	`Œy_comm™
());

1219 
t1
.
	`u£
();

1220 
	`as£¹
(
f
[2] == -1);

1221 
	`as£¹
(
t1
.
	`Œy_comm™
());

1224 
	`´štf
("PASS: %s\n", 
__FUNCTION__
);

1225 
	}
}

1229 
	$maš
() {

1230 
	`‹¡Sim¶eIÁ
();

1231 
	`‹¡Wr™eNPushBack
();

1232 
	`‹¡PushBack
();

1233 
	`‹¡PushBackNR—d
();

1234 
	`‹¡PushBackNR—d1
();

1235 
	`‹¡PushBackNR—d2
();

1236 
	`‹¡PushBackNWr™e
();

1237 
	`‹¡Sim¶eSŒšg
();

1238 
	`‹¡I‹r
();

1239 
	`‹¡CÚæiùšgI‹r
();

1240 
	`‹¡ModifyšgI‹r
();

1241 
	`‹¡CÚæiùšgModifyI‹r1
();

1242 
	`‹¡CÚæiùšgModifyI‹r2
();

1243 
	`‹¡CÚæiùšgModifyI‹r3
();

1244 
	`‹¡I‹rNPushBack
();

1245 
	`‹¡I‹rNPushBack1
();

1246 
	`‹¡I‹rNPushBack2
();

1247 
	`‹¡E¿£
();

1248 
	`‹¡In£¹
();

1249 
	`‹¡PushNPİ
();

1250 
	`‹¡PİAndUpd©e
();

1251 
	`‹¡MulPushPİs
();

1252 
	`‹¡MulPushPİs1
();

1253 
	`‹¡Upd©ePİ
();

1254 
	`‹¡I‹¿tÜB‘‹rSemªtics
();

1255 
	`‹¡SizeP»diÿ‹s
();

1256 
	`‹¡I‹rP»diÿ‹s
();

1257 
	`‹¡Resize
();

1258 
	`‹¡FrÚtBack
();

1259 
	`‹¡IndexPushOv”Ïp
();

1260 
	`‹¡O·c™y
();

1261 
	`‹¡NoO·c™y
();

1263 
	}
}

	@test/vector.cc

1 
	~<¡ršg
>

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

4 
	~<veùÜ
>

5 
	~"T¿n§ùiÚ.hh
"

6 
	~"VeùÜ.hh
"

8 
	$‹¡Sim¶eIÁ
() {

9 
VeùÜ
<> 
f
;

12 
T¿n§ùiÚGu¬d
 
t
;

13 
f
.
	`push_back
(100);

14 
f
.
	`push_back
(200);

15 *(
f
.
	`begš
()) = *(f.begin() + 1);

19 
T¿n§ùiÚGu¬d
 
t2
;

20 
f_»ad
 = 
f
[0];

21 
	`as£¹
(
f_»ad
 == 200);

24 
	`´štf
("PASS:estSimpleInt\n");

25 
	}
}

27 
	$‹¡Wr™eNPushBack
() {

28 
VeùÜ
<> 
f
;

31 
T¿n§ùiÚGu¬d
 
t
;

32 
f
.
	`push_back
(10);

35 
Te¡T¿n§ùiÚ
 
	`t2
(1);

36 
f
[0] = 4;

38 
Te¡T¿n§ùiÚ
 
	`t3
(2);

39 
f
.
	`push_back
(20);

40 
	`as£¹
(
t3
.
	`Œy_comm™
());

41 
	`as£¹
(
t2
.
	`Œy_comm™
());

44 
T¿n§ùiÚGu¬d
 
t4
;

45 
	`as£¹
(
f
[0] == 4);

48 
	`´štf
("PASS:estWriteNPushBack\n");

49 
	}
}

51 
	$‹¡PushBack
() {

52 
VeùÜ
<> 
f
;

55 
T¿n§ùiÚGu¬d
 
t
;

56 
f
.
	`push_back
(10);

59 
Te¡T¿n§ùiÚ
 
	`t2
(1);

60 
f
.
	`push_back
(4);

62 
Te¡T¿n§ùiÚ
 
	`t3
(2);

63 
f
.
	`push_back
(20);

64 
	`as£¹
(
t3
.
	`Œy_comm™
());

65 
	`as£¹
(
t2
.
	`Œy_comm™
());

68 
T¿n§ùiÚGu¬d
 
t4
;

69 
	`as£¹
(
f
[0] == 10);

70 
	`as£¹
(
f
[1] == 20);

71 
	`as£¹
(
f
[2] == 4);

74 
	`´štf
("PASS:estPushBack\n");

75 
	}
}

78 
	$‹¡PushBackNR—d
() {

79 
VeùÜ
<> 
f
;

82 
T¿n§ùiÚGu¬d
 
t
;

83 
f
.
	`push_back
(10);

87 
T¿n§ùiÚGu¬d
 
t2
;

88 
f
.
	`push_back
(4);

89 
	`as£¹
(
f
[1] == 4);

92 
	`´štf
("PASS:estPushBackNRead\n");

93 
	}
}

95 
	$‹¡PushBackNR—d1
() {

96 
VeùÜ
<> 
f
;

99 
T¿n§ùiÚGu¬d
 
t
;

100 
f
.
	`push_back
(10);

103 
Te¡T¿n§ùiÚ
 
	`t2
(1);

104 
f
.
	`push_back
(4);

105 
	`as£¹
(
f
[1] == 4);

107 
Te¡T¿n§ùiÚ
 
	`t3
(2);

108 
f
.
	`push_back
(20);

109 
	`as£¹
(
t3
.
	`Œy_comm™
());

110 
	`as£¹
(!
t2
.
	`Œy_comm™
());

112 
	`´štf
("PASS:estPushBackNRead1\n");

113 
	}
}

115 
	$‹¡PushBackNR—d2
() {

116 
VeùÜ
<> 
f
;

119 
T¿n§ùiÚGu¬d
 
t
;

120 
f
.
	`push_back
(10);

123 
Te¡T¿n§ùiÚ
 
	`t2
(1);

124 
f
.
	`push_back
(4);

125 
	`as£¹
(
f
[f.
	`size
() - 1] == 4);

127 
Te¡T¿n§ùiÚ
 
	`t3
(2);

128 
f
.
	`push_back
(20);

130 
	`as£¹
(
t3
.
	`Œy_comm™
());

131 
	`as£¹
(!
t2
.
	`Œy_comm™
());

133 
	`´štf
("PASS:estPushBackNRead2\n");

134 
	}
}

137 
	$‹¡PushBackNWr™e
() {

138 
VeùÜ
<> 
f
;

141 
T¿n§ùiÚGu¬d
 
t
;

142 
f
.
	`push_back
(10);

146 
T¿n§ùiÚGu¬d
 
t2
;

147 
f
.
	`push_back
(4);

148 
f
[1] = 10;

152 
T¿n§ùiÚGu¬d
 
t3
;

153 
	`as£¹
(
f
[1] == 10);

156 
	`´štf
("PASS:estPushBackNRead\n");

157 
	}
}

161 
	$‹¡Sim¶eSŒšg
() {

162 
VeùÜ
<
¡d
::
¡ršg
> 
f
;

165 
T¿n§ùiÚGu¬d
 
t
;

166 
f
.
	`push_back
("100");

170 
T¿n§ùiÚGu¬d
 
t2
;

171 
¡d
::
¡ršg
 
f_»ad
 = 
f
[0];

172 
	`as£¹
(
f_»ad
.
	`com·»
("100") == 0);

175 
	`´štf
("PASS:estSimpleString\n");

176 
	}
}

178 
	$‹¡I‹r
() {

179 
¡d
::
veùÜ
<> 
¬r
;

180 
VeùÜ
<> 
f
;

181 
TRANSACTION
 {

182 
i
 = 0; i < 10; i++) {

183 
x
 = 
	`¿nd
();

184 
f
.
	`push_back
(
x
);

185 
¬r
.
	`push_back
(
x
);

187 } 
	`RETRY
(
çl£
);

189 
max
;

190 
TRANSACTION
 {

191 
max
 = *(
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
()));

192 } 
	`RETRY
(
çl£
);

194 
	`as£¹
(
max
 =ğ*(
¡d
::
	`max_–em’t
(
¬r
.
	`begš
(),‡¼.
	`’d
())));

195 
	`´štf
("Max i %i\n", 
max
);

196 
	`´štf
("PASS: vector max_elementest\n");

198 
	}
}

201 
	$‹¡CÚæiùšgI‹r
() {

202 
VeùÜ
<> 
f
;

203 
TRANSACTION
 {

204 
i
 = 0; i < 10; i++) {

205 
f
.
	`push_back
(
i
);

207 } 
	`RETRY
(
çl£
);

209 
Te¡T¿n§ùiÚ
 
	`t
(1);

210 
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
());

212 
Te¡T¿n§ùiÚ
 
	`t1
(2);

213 
f
[4] = 10;

214 
	`as£¹
(
t1
.
	`Œy_comm™
());

215 
	`as£¹
(!
t
.
	`Œy_comm™
());

217 
	`´štf
("PASS: conflicting vector max_elementest\n");

219 
	}
}

221 
	$‹¡ModifyšgI‹r
() {

222 
VeùÜ
<> 
f
;

224 
T¿n§ùiÚGu¬d
 
‰
;

225 
i
 = 0; i < 10; i++) {

226 
f
.
	`push_back
(
i
);

231 
T¿n§ùiÚGu¬d
 
t
;

232 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

236 
T¿n§ùiÚGu¬d
 
t1
;

237 
v
 = 
f
[4];

238 
	`as£¹
(
v
 == 6);

241 
	`´štf
("PASS: vector„eplaceest\n");

242 
	}
}

244 
	$‹¡CÚæiùšgModifyI‹r1
() {

245 
VeùÜ
<> 
f
;

246 
TRANSACTION
 {

247 
i
 = 0; i < 10; i++) {

248 
f
.
	`push_back
(
i
);

250 } 
	`RETRY
(
çl£
);

252 
Te¡T¿n§ùiÚ
 
	`t
(1);

253 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

255 
Te¡T¿n§ùiÚ
 
	`t1
(2);

256 
f
[4] = 10;

257 
	`as£¹
(
t1
.
	`Œy_comm™
());

258 
	`as£¹
(!
t
.
	`Œy_comm™
());

261 
T¿n§ùiÚGu¬d
 
t2
;

262 
v
 = 
f
[4];

263 
	`as£¹
(
v
 == 10);

266 
	`´štf
("PASS: vector conflicting„eplaceest1\n");

267 
	}
}

269 
	$‹¡CÚæiùšgModifyI‹r2
() {

270 
VeùÜ
<> 
f
;

271 
TRANSACTION
 {

272 
i
 = 0; i < 10; i++) {

273 
f
.
	`push_back
(
i
);

275 } 
	`RETRY
(
çl£
);

278 
T¿n§ùiÚGu¬d
 
t
;

279 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

283 
T¿n§ùiÚGu¬d
 
t1
;

284 
f
[4] = 10;

288 
T¿n§ùiÚGu¬d
 
t2
;

289 
v
 = 
f
[4];

290 
	`as£¹
(
v
 == 10);

293 
	`´štf
("PASS: vector conflicting„eplaceest2\n");

294 
	}
}

296 
	$‹¡CÚæiùšgModifyI‹r3
() {

297 
VeùÜ
<> 
f
;

298 
TRANSACTION
 {

299 
i
 = 0; i < 10; i++) {

300 
f
.
	`push_back
(
i
);

302 } 
	`RETRY
(
çl£
);

304 
Te¡T¿n§ùiÚ
 
	`t1
(1);

305 (è
f
[4];

307 
Te¡T¿n§ùiÚ
 
	`t
(2);

308 
¡d
::
	`»¶aû
(
f
.
	`begš
(), f.
	`’d
(), 4, 6);

309 
	`as£¹
(
t
.
	`Œy_comm™
());

310 
	`as£¹
(!
t1
.
	`Œy_comm™
());

313 
T¿n§ùiÚGu¬d
 
t2
;

314 
v
 = 
f
[4];

315 
	`as£¹
(
v
 == 6);

318 
	`´štf
("PASS: vector conflicting„eplaceest3\n");

319 
	}
}

321 
	$‹¡I‹rNPushBack
() {

322 
VeùÜ
<> 
f
;

323 
TRANSACTION
 {

324 
i
 = 0; i < 10; i++) {

325 
f
.
	`push_back
(
i
);

327 } 
	`RETRY
(
çl£
);

329 
max
;

330 
TRANSACTION
 {

331 
f
.
	`push_back
(20);

332 
max
 = *(
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
()));

333 } 
	`RETRY
(
çl£
);

335 
	`as£¹
(
max
 == 20);

336 
	`´štf
("PASS: IterNPushBack\n");

337 
	}
}

339 
	$‹¡I‹rNPushBack1
() {

340 
VeùÜ
<> 
f
;

342 
T¿n§ùiÚGu¬d
 
‰
;

343 
i
 = 0; i < 10; i++) {

344 
f
.
	`push_back
(
i
);

348 
max
;

349 
Te¡T¿n§ùiÚ
 
	`t1
(1);

350 
f
.
	`push_back
(20);

351 
max
 = *(
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
()));

352 
	`as£¹
(
max
 == 20);

354 
Te¡T¿n§ùiÚ
 
	`t2
(2);

355 
f
.
	`push_back
(12);

356 
	`as£¹
(
t2
.
	`Œy_comm™
());

357 
	`as£¹
(!
t1
.
	`Œy_comm™
());

359 
	`´štf
("PASS: IterNPushBack1\n");

360 
	}
}

362 
	$‹¡I‹rNPushBack2
() {

363 
VeùÜ
<> 
f
;

366 
T¿n§ùiÚGu¬d
 
‰
;

367 
i
 = 0; i < 10; i++) {

368 
f
.
	`push_back
(
i
);

372 
Te¡T¿n§ùiÚ
 
	`t1
(1);

373 
¡d
::
	`max_–em’t
(
f
.
	`begš
(), f.
	`’d
());

375 
Te¡T¿n§ùiÚ
 
	`t2
(2);

376 
f
.
	`push_back
(2);

377 
	`as£¹
(
t2
.
	`Œy_comm™
());

378 
	`as£¹
(!
t1
.
	`Œy_comm™
());

380 
	`´štf
("PASS: IterNPushBack2\n");

382 
	}
}

385 
	$‹¡E¿£
() {

386 
VeùÜ
<> 
f
;

388 
TRANSACTION
 {

389 
i
 = 0; i < 10; i++) {

390 
f
.
	`push_back
(
i
);

392 } 
	`RETRY
(
çl£
);

395 
T¿n§ùiÚGu¬d
 
t1
;

396 
f
.
	`”a£
(f.
	`begš
() + 5);

399 
TRANSACTION
 {

400 
VeùÜ
<>::
™”©Ü
 
™
 = 
f
.
	`begš
();

401 
VeùÜ
<>::
™”©Ü
 
e™
 = 
f
.
	`’d
();

402 ; 
™
 !ğ
e™
; ++it) {

403 
	`´štf
("%i\n", ()*
™
);

405 } 
	`RETRY
(
çl£
);

407 
	`´štf
("PASS:estErase\n");

408 
	}
}

410 
	$‹¡In£¹
() {

411 
VeùÜ
<> 
f
;

413 
TRANSACTION
 {

414 
i
 = 0; i < 10; i++) {

415 
f
.
	`push_back
(
i
);

417 } 
	`RETRY
(
çl£
);

420 
T¿n§ùiÚGu¬d
 
t1
;

421 
f
.
	`š£¹
(f.
	`begš
() + 5, 25);

424 
TRANSACTION
 {

425 
VeùÜ
<>::
™”©Ü
 
™
 = 
f
.
	`begš
();

426 
VeùÜ
<>::
™”©Ü
 
e™
 = 
f
.
	`’d
();

427 ; 
™
 !ğ
e™
; ++it) {

428 
	`´štf
("%i\n", ()*
™
);

430 } 
	`RETRY
(
çl£
);

432 
	`´štf
("PASS:estInsert\n");

433 
	}
}

436 
	$‹¡PushNPİ
() {

437 
VeùÜ
<> 
f
;

439 
TRANSACTION
 {

440 
i
 = 0; i < 10; i++) {

441 
f
.
	`push_back
(
i
);

443 } 
	`RETRY
(
çl£
);

446 
T¿n§ùiÚGu¬d
 
t
;

447 
f
.
	`push_back
(20);

448 
f
.
	`push_back
(21);

449 
	`as£¹
(
f
[0] == 0);

450 
	`as£¹
(
f
.
	`size
() == 12);

451 
f
.
	`pİ_back
();

452 
f
.
	`pİ_back
();

455 
Te¡T¿n§ùiÚ
 
	`t1
(1);

456 
f
.
	`pİ_back
();

457 
f
.
	`push_back
(15);

459 
Te¡T¿n§ùiÚ
 
	`t2
(2);

460 
f
.
	`push_back
(20);

461 
	`as£¹
(
t2
.
	`Œy_comm™
());

462 
	`as£¹
(!
t1
.
	`Œy_comm™
());

464 
TRANSACTION
 {

465 
	`as£¹
(
f
.
	`size
() == 11);

466 
	`as£¹
(
f
[10] == 20);

467 } 
	`RETRY
(
çl£
);

470 
	`´štf
("PASS:estPushNPop\n");

472 
Te¡T¿n§ùiÚ
 
	`t3
(1);

473 
f
.
	`pİ_back
();

474 
f
.
	`push_back
(15);

476 
Te¡T¿n§ùiÚ
 
	`t4
(2);

477 
f
.
	`pİ_back
();

478 
	`as£¹
(
t4
.
	`Œy_comm™
());

479 
	`as£¹
(!
t3
.
	`Œy_comm™
());

481 
TRANSACTION
 {

482 
	`as£¹
(
f
.
	`size
() == 10);

483 } 
	`RETRY
(
çl£
);

485 
	`´štf
("PASS:estPushNPop1\n");

487 
Te¡T¿n§ùiÚ
 
	`t5
(1);

488 
f
.
	`pİ_back
();

489 
f
.
	`pİ_back
();

490 
f
.
	`push_back
(15);

492 
Te¡T¿n§ùiÚ
 
	`t6
(2);

493 
f
[8] = 16;

494 
	`as£¹
(
t6
.
	`Œy_comm™
());

496 
Te¡T¿n§ùiÚ
 
	`t7
(3);

497 (è
f
[8];

499 
	`as£¹
(
t5
.
	`Œy_comm™
());

500 
	`as£¹
(!
t7
.
	`Œy_comm™
());

502 
TRANSACTION
 {

503 
	`as£¹
(
f
.
	`size
() == 9);

504 
	`as£¹
(
f
[8] == 15);

505 } 
	`RETRY
(
çl£
);

507 
	`´štf
("PASS:estPushNPop2\n");

508 
	}
}

510 
	$‹¡PİAndUd·‹
() {

511 
VeùÜ
<> 
f
;

513 
TRANSACTION
 {

514 
i
 = 0; i < 10; i++) {

515 
f
.
	`push_back
(
i
);

517 } 
	`RETRY
(
çl£
);

519 
Te¡T¿n§ùiÚ
 
	`t1
(1);

520 
f
[9] = 20;

522 
Te¡T¿n§ùiÚ
 
	`t2
(2);

523 
f
.
	`pİ_back
();

524 
f
.
	`pİ_back
();

525 
	`as£¹
(
t2
.
	`Œy_comm™
());

526 
	`as£¹
(!
t1
.
	`Œy_comm™
());

527 
	}
}

529 
	$‹¡MulPushPİs
() {

530 
VeùÜ
<> 
f
;

532 
TRANSACTION
 {

533 
i
 = 0; i < 10; i++) {

534 
f
.
	`push_back
(
i
);

536 } 
	`RETRY
(
çl£
);

539 
T¿n§ùiÚGu¬d
 
t1
;

540 
f
.
	`push_back
(100);

541 
f
.
	`push_back
(200);

542 
f
.
	`pİ_back
();

543 
f
.
	`pİ_back
();

544 
f
.
	`pİ_back
();

546 
	}
}

548 
	$‹¡MulPushPİs1
() {

549 
VeùÜ
<> 
f
;

551 
TRANSACTION
 {

552 
i
 = 0; i < 10; i++) {

553 
f
.
	`push_back
(
i
);

555 } 
	`RETRY
(
çl£
);

558 
T¿n§ùiÚGu¬d
 
t1
;

559 
f
.
	`push_back
(100);

560 
f
.
	`push_back
(200);

561 
f
.
	`pİ_back
();

562 
f
.
	`pİ_back
();

563 
f
.
	`push_back
(300);

565 
	}
}

567 
	$‹¡Upd©ePİ
() {

568 
VeùÜ
<> 
f
;

570 
TRANSACTION
 {

571 
i
 = 0; i < 10; i++) {

572 
f
.
	`push_back
(
i
);

574 } 
	`RETRY
(
çl£
);

577 
T¿n§ùiÚGu¬d
 
t1
;

578 
f
[9] = 20;

579 
f
.
	`pİ_back
();

581 
	}
}

583 
	$‹¡I‹¿tÜB‘‹rSemªtics
() {

584 
VeùÜ
<> 
f
;

586 
TRANSACTION
 {

587 
i
 = 0; i < 10; i++) {

588 
f
.
	`push_back
(
i
);

590 } 
	`RETRY
(
çl£
);

592 
Te¡T¿n§ùiÚ
 
	`t1
(1);

595 
VeùÜ
<>::
™”©Ü
 
™
;

596 
™
 = 
f
.
	`begš
(); iˆ!ğf.
	`’d
(); ++it)

597 ià(*
™
 == 5)

600 
Te¡T¿n§ùiÚ
 
	`t2
(2);

601 
f
.
	`push_back
(12);

602 
	`as£¹
(
t2
.
	`Œy_comm™
());

603 
t1
.
	`u£
();

604 
x
 = *
™
;

605 
	`as£¹
(
t1
.
	`Œy_comm™
());

606 
	`as£¹
(
x
 == 5);

608 
	`´štf
("PASS: IteratorBetterSemantics\n");

610 
	}
}

616 
	$maš
() {

617 
	`‹¡Sim¶eIÁ
();

618 
	`‹¡Wr™eNPushBack
();

619 
	`‹¡PushBack
();

620 
	`‹¡PushBackNR—d
();

621 
	`‹¡PushBackNR—d1
();

622 
	`‹¡PushBackNR—d2
();

623 
	`‹¡PushBackNWr™e
();

624 
	`‹¡Sim¶eSŒšg
();

625 
	`‹¡I‹r
();

626 
	`‹¡CÚæiùšgI‹r
();

627 
	`‹¡ModifyšgI‹r
();

628 
	`‹¡CÚæiùšgModifyI‹r1
();

629 
	`‹¡CÚæiùšgModifyI‹r2
();

630 
	`‹¡CÚæiùšgModifyI‹r3
();

631 
	`‹¡I‹rNPushBack
();

632 
	`‹¡I‹rNPushBack1
();

633 
	`‹¡I‹rNPushBack2
();

634 
	`‹¡E¿£
();

635 
	`‹¡In£¹
();

636 
	`‹¡PushNPİ
();

637 
	`‹¡PİAndUd·‹
();

638 
	`‹¡MulPushPİs
();

639 
	`‹¡MulPushPİs1
();

640 
	`‹¡Upd©ePİ
();

641 
	`‹¡I‹¿tÜB‘‹rSemªtics
();

643 
	}
}

	@third-party/xxHash/xxhash.c

52 #iâdeà
XXH_FORCE_MEMORY_ACCESS


53 #ià
defšed
(
__GNUC__
è&& ( defšed(
__ARM_ARCH_6__
è|| defšed(
__ARM_ARCH_6J__
è|| defšed(
__ARM_ARCH_6K__
è|| defšed(
__ARM_ARCH_6Z__
è|| defšed(
__ARM_ARCH_6ZK__
è|| defšed(
__ARM_ARCH_6T2__
) )

54 
	#XXH_FORCE_MEMORY_ACCESS
 2

	)

55 #–ià
defšed
(
__INTEL_COMPILER
) || \

56 (
defšed
(
__GNUC__
è&& ( defšed(
__ARM_ARCH_7__
è|| defšed(
__ARM_ARCH_7A__
è|| defšed(
__ARM_ARCH_7R__
è|| defšed(
__ARM_ARCH_7M__
è|| 
	$defšed
(
__ARM_ARCH_7S__
) ))

57 
	#XXH_FORCE_MEMORY_ACCESS
 1

	)

76 #iâdeà
XXH_FORCE_NATIVE_FORMAT


77 
	#XXH_FORCE_NATIVE_FORMAT
 0

	)

87 #iâdeà
XXH_FORCE_ALIGN_CHECK


88 #ià
	`defšed
(
__i386
è|| defšed(
_M_IX86
è|| defšed(
__x86_64__
è|| defšed(
_M_X64
)

89 
	#XXH_FORCE_ALIGN_CHECK
 0

	)

91 
	#XXH_FORCE_ALIGN_CHECK
 1

	)

101 
	~<¡dlib.h
>

102 * 
	$XXH_m®loc
(
size_t
 
s
è{  
	`m®loc
(s); 
	}
}

103 
	$XXH_ä“
 (* 
p
è{ 
	`ä“
Õ); 
	}
}

105 
	~<¡ršg.h
>

106 * 
	$XXH_memıy
(* 
de¡
, cÚ¡ * 
¤c
, 
size_t
 
size
è{  
	`memıy
(de¡,¤c,size); 
	}
}

108 
	#XXH_STATIC_LINKING_ONLY


	)

109 
	~"xxhash.h
"

115 #ifdeà
_MSC_VER


116 #´agm¨
w¬nšg
(
di§bË
 : 4127)

117 
	#FORCE_INLINE
 
__fÜûšlše


	)

119 #ià
defšed
 (
__ılu¥lus
è|| defšed (
__STDC_VERSION__
) && __STDC_VERSION__ >= 199901L

120 #ifdeà
__GNUC__


121 
	#FORCE_INLINE
 
šlše
 
	`__©Œibu‹__
((
®ways_šlše
))

	)

123 
	#FORCE_INLINE
 
šlše


	)

126 
	#FORCE_INLINE
 

	)

134 #iâdeà
MEM_MODULE


135 #ià!
defšed
 (
__VMS
è&& (defšed (
__ılu¥lus
è|| (defšed (
__STDC_VERSION__
) && (__STDC_VERSION__ >= 199901L) ) )

136 
	~<¡dšt.h
>

137 
ušt8_t
 
	tBYTE
;

138 
ušt16_t
 
	tU16
;

139 
ušt32_t
 
	tU32
;

141 
	tBYTE
;

142 
	tU16
;

143 
	tU32
;

147 #ià(
defšed
(
XXH_FORCE_MEMORY_ACCESS
) && (XXH_FORCE_MEMORY_ACCESS==2))

150 
U32
 
	$XXH_»ad32
(cÚ¡ * 
memPŒ
è{  *(cÚ¡ 
U32
*èmemPŒ; 
	}
}

152 #–ià(
defšed
(
XXH_FORCE_MEMORY_ACCESS
) && (XXH_FORCE_MEMORY_ACCESS==1))

156 uniÚ { 
U32
 
	mu32
; } 
	t__©Œibu‹__
((
	t·cked
)è
	tuÇlign
;

157 
U32
 
	$XXH_»ad32
(cÚ¡ * 
±r
è{  ((cÚ¡ 
uÇlign
*íŒ)->
u32
; 
	}
}

164 
U32
 
	$XXH_»ad32
(cÚ¡ * 
memPŒ
)

166 
U32
 
v®
;

167 
	`memıy
(&
v®
, 
memPŒ
, (val));

168  
v®
;

169 
	}
}

177 
	#XXH_GCC_VERSION
 (
__GNUC__
 * 100 + 
__GNUC_MINOR__
)

	)

180 #ià
defšed
(
_MSC_VER
)

181 
	#XXH_rÙl32
(
x
,
r
è
	`_rÙl
(x,r)

	)

182 
	#XXH_rÙl64
(
x
,
r
è
	`_rÙl64
(x,r)

	)

184 
	#XXH_rÙl32
(
x
,
r
è((x <<„è| (x >> (32 -„)))

	)

185 
	#XXH_rÙl64
(
x
,
r
è((x <<„è| (x >> (64 -„)))

	)

188 #ià
defšed
(
_MSC_VER
)

189 
	#XXH_sw­32
 
_by‹sw­_ulÚg


	)

190 #–ià
XXH_GCC_VERSION
 >= 403

191 
	#XXH_sw­32
 
__butš_bsw­32


	)

193 
U32
 
	$XXH_sw­32
 (
U32
 
x
)

195  ((
x
 << 24) & 0xff000000 ) |

196 ((
x
 << 8) & 0x00ff0000 ) |

197 ((
x
 >> 8) & 0x0000ff00 ) |

198 ((
x
 >> 24) & 0x000000ff );

199 
	}
}

206 ’um { 
	mXXH_bigEndŸn
=0, 
	mXXH_l™eEndŸn
=1 } 
	tXXH_’dŸÃss
;

209 #iâdeà
XXH_CPU_LITTLE_ENDIAN


210 cÚ¡ 
	gg_Úe
 = 1;

211 
	#XXH_CPU_LITTLE_ENDIAN
 (*(cÚ¡ *)(&
g_Úe
))

	)

218 ’um { 
	mXXH_®igÃd
, 
	mXXH_uÇligÃd
 } 
	tXXH_®ignm’t
;

220 
FORCE_INLINE
 
U32
 
	$XXH_»adLE32_®ign
(cÚ¡ * 
±r
, 
XXH_’dŸÃss
 
’dŸn
, 
XXH_®ignm’t
 
®ign
)

222 ià(
®ign
==
XXH_uÇligÃd
)

223  
’dŸn
==
XXH_l™eEndŸn
 ? 
	`XXH_»ad32
(
±r
è: 
	`XXH_sw­32
(XXH_read32(ptr));

225  
’dŸn
==
XXH_l™eEndŸn
 ? *(cÚ¡ 
U32
*)
±r
 : 
	`XXH_sw­32
(*(const U32*)ptr);

226 
	}
}

228 
FORCE_INLINE
 
U32
 
	$XXH_»adLE32
(cÚ¡ * 
±r
, 
XXH_’dŸÃss
 
’dŸn
)

230  
	`XXH_»adLE32_®ign
(
±r
, 
’dŸn
, 
XXH_uÇligÃd
);

231 
	}
}

233 
U32
 
	$XXH_»adBE32
(cÚ¡ * 
±r
)

235  
XXH_CPU_LITTLE_ENDIAN
 ? 
	`XXH_sw­32
(
	`XXH_»ad32
(
±r
)) : XXH_read32(ptr);

236 
	}
}

242 
	#XXH_STATIC_ASSERT
(
c
è{ƒnum { 
XXH_¡©ic_as£¹
 = 1/()(!!(c)è}; }

	)

243 
XXH_PUBLIC_API
 
	$XXH_v”siÚNumb”
 (è{  
XXH_VERSION_NUMBER
; 
	}
}

249 cÚ¡ 
U32
 
	gPRIME32_1
 = 2654435761U;

250 cÚ¡ 
U32
 
	gPRIME32_2
 = 2246822519U;

251 cÚ¡ 
U32
 
	gPRIME32_3
 = 3266489917U;

252 cÚ¡ 
U32
 
	gPRIME32_4
 = 668265263U;

253 cÚ¡ 
U32
 
	gPRIME32_5
 = 374761393U;

255 
U32
 
	$XXH32_round
(
U32
 
£ed
, U32 
šput
)

257 
£ed
 +ğ
šput
 * 
PRIME32_2
;

258 
£ed
 = 
	`XXH_rÙl32
(seed, 13);

259 
£ed
 *ğ
PRIME32_1
;

260  
£ed
;

261 
	}
}

263 
FORCE_INLINE
 
U32
 
	$XXH32_’dŸn_®ign
(cÚ¡ * 
šput
, 
size_t
 
Ën
, 
U32
 
£ed
, 
XXH_’dŸÃss
 
’dŸn
, 
XXH_®ignm’t
 
®ign
)

265 cÚ¡ 
BYTE
* 
p
 = (cÚ¡ BYTE*)
šput
;

266 cÚ¡ 
BYTE
* 
bEnd
 = 
p
 + 
Ën
;

267 
U32
 
h32
;

268 
	#XXH_g‘32b™s
(
p
è
	`XXH_»adLE32_®ign
Õ, 
’dŸn
, 
®ign
)

	)

270 #ifdeà
XXH_ACCEPT_NULL_INPUT_POINTER


271 ià(
p
==
NULL
) {

272 
Ën
=0;

273 
bEnd
=
p
=(cÚ¡ 
BYTE
*)(
size_t
)16;

277 ià(
Ën
>=16) {

278 cÚ¡ 
BYTE
* cÚ¡ 
lim™
 = 
bEnd
 - 16;

279 
U32
 
v1
 = 
£ed
 + 
PRIME32_1
 + 
PRIME32_2
;

280 
U32
 
v2
 = 
£ed
 + 
PRIME32_2
;

281 
U32
 
v3
 = 
£ed
 + 0;

282 
U32
 
v4
 = 
£ed
 - 
PRIME32_1
;

285 
v1
 = 
	`XXH32_round
(v1, 
	`XXH_g‘32b™s
(
p
));…+=4;

286 
v2
 = 
	`XXH32_round
(v2, 
	`XXH_g‘32b™s
(
p
));…+=4;

287 
v3
 = 
	`XXH32_round
(v3, 
	`XXH_g‘32b™s
(
p
));…+=4;

288 
v4
 = 
	`XXH32_round
(v4, 
	`XXH_g‘32b™s
(
p
));…+=4;

289 } 
p
<=
lim™
);

291 
h32
 = 
	`XXH_rÙl32
(
v1
, 1è+ XXH_rÙl32(
v2
, 7è+ XXH_rÙl32(
v3
, 12è+ XXH_rÙl32(
v4
, 18);

293 
h32
 = 
£ed
 + 
PRIME32_5
;

296 
h32
 +ğ(
U32
è
Ën
;

298 
p
+4<=
bEnd
) {

299 
h32
 +ğ
	`XXH_g‘32b™s
(
p
è* 
PRIME32_3
;

300 
h32
 = 
	`XXH_rÙl32
(h32, 17è* 
PRIME32_4
 ;

301 
p
+=4;

304 
p
<
bEnd
) {

305 
h32
 +ğ(*
p
è* 
PRIME32_5
;

306 
h32
 = 
	`XXH_rÙl32
(h32, 11è* 
PRIME32_1
 ;

307 
p
++;

310 
h32
 ^= h32 >> 15;

311 
h32
 *ğ
PRIME32_2
;

312 
h32
 ^= h32 >> 13;

313 
h32
 *ğ
PRIME32_3
;

314 
h32
 ^= h32 >> 16;

316  
h32
;

317 
	}
}

320 
XXH_PUBLIC_API
 
	$XXH32
 (cÚ¡ * 
šput
, 
size_t
 
Ën
, 
£ed
)

324 
XXH32_¡©e_t
 
¡©e
;

325 
	`XXH32_»£t
(&
¡©e
, 
£ed
);

326 
	`XXH32_upd©e
(&
¡©e
, 
šput
, 
Ën
);

327  
	`XXH32_dige¡
(&
¡©e
);

329 
XXH_’dŸÃss
 
’dŸn_d‘eùed
 = (XXH_’dŸÃss)
XXH_CPU_LITTLE_ENDIAN
;

331 ià(
XXH_FORCE_ALIGN_CHECK
) {

332 ià((((
size_t
)
šput
) & 3) == 0) {

333 ià((
’dŸn_d‘eùed
==
XXH_l™eEndŸn
è|| 
XXH_FORCE_NATIVE_FORMAT
)

334  
	`XXH32_’dŸn_®ign
(
šput
, 
Ën
, 
£ed
, 
XXH_l™eEndŸn
, 
XXH_®igÃd
);

336  
	`XXH32_’dŸn_®ign
(
šput
, 
Ën
, 
£ed
, 
XXH_bigEndŸn
, 
XXH_®igÃd
);

339 ià((
’dŸn_d‘eùed
==
XXH_l™eEndŸn
è|| 
XXH_FORCE_NATIVE_FORMAT
)

340  
	`XXH32_’dŸn_®ign
(
šput
, 
Ën
, 
£ed
, 
XXH_l™eEndŸn
, 
XXH_uÇligÃd
);

342  
	`XXH32_’dŸn_®ign
(
šput
, 
Ën
, 
£ed
, 
XXH_bigEndŸn
, 
XXH_uÇligÃd
);

344 
	}
}

350 
XXH_PUBLIC_API
 
XXH32_¡©e_t
* 
	$XXH32_ü—‹S‹
()

352  (
XXH32_¡©e_t
*)
	`XXH_m®loc
((XXH32_state_t));

353 
	}
}

354 
XXH_PUBLIC_API
 
XXH_”rÜcode
 
	$XXH32_ä“S‹
(
XXH32_¡©e_t
* 
¡©ePŒ
)

356 
	`XXH_ä“
(
¡©ePŒ
);

357  
XXH_OK
;

358 
	}
}

360 
XXH_PUBLIC_API
 
	$XXH32_cİyS‹
(
XXH32_¡©e_t
* 
d¡S‹
, cÚ¡ XXH32_¡©e_t* 
¤cS‹
)

362 
	`memıy
(
d¡S‹
, 
¤cS‹
, (*dstState));

363 
	}
}

365 
XXH_PUBLIC_API
 
XXH_”rÜcode
 
	$XXH32_»£t
(
XXH32_¡©e_t
* 
¡©ePŒ
, 
£ed
)

367 
XXH32_¡©e_t
 
¡©e
;

368 
	`mem£t
(&
¡©e
, 0, (state)-4);

369 
¡©e
.
v1
 = 
£ed
 + 
PRIME32_1
 + 
PRIME32_2
;

370 
¡©e
.
v2
 = 
£ed
 + 
PRIME32_2
;

371 
¡©e
.
v3
 = 
£ed
 + 0;

372 
¡©e
.
v4
 = 
£ed
 - 
PRIME32_1
;

373 
	`memıy
(
¡©ePŒ
, &
¡©e
, (state));

374  
XXH_OK
;

375 
	}
}

378 
FORCE_INLINE
 
XXH_”rÜcode
 
	$XXH32_upd©e_’dŸn
 (
XXH32_¡©e_t
* 
¡©e
, cÚ¡ * 
šput
, 
size_t
 
Ën
, 
XXH_’dŸÃss
 
’dŸn
)

380 cÚ¡ 
BYTE
* 
p
 = (cÚ¡ BYTE*)
šput
;

381 cÚ¡ 
BYTE
* cÚ¡ 
bEnd
 = 
p
 + 
Ën
;

383 ià(
šput
==
NULL
)

384 #ifdeà
XXH_ACCEPT_NULL_INPUT_POINTER


385  
XXH_OK
;

387  
XXH_ERROR
;

390 
¡©e
->
tÙ®_Ën_32
 +ğ()
Ën
;

391 
¡©e
->
Ïrge_Ën
 |ğ(
Ën
>=16è| (¡©e->
tÙ®_Ën_32
>=16);

393 ià(
¡©e
->
memsize
 + 
Ën
 < 16) {

394 
	`XXH_memıy
((
BYTE
*)(
¡©e
->
mem32
è+ s‹->
memsize
, 
šput
, 
Ën
);

395 
¡©e
->
memsize
 +ğ()
Ën
;

396  
XXH_OK
;

399 ià(
¡©e
->
memsize
) {

400 
	`XXH_memıy
((
BYTE
*)(
¡©e
->
mem32
è+ s‹->
memsize
, 
šput
, 16-state->memsize);

401 { cÚ¡ 
U32
* 
p32
 = 
¡©e
->
mem32
;

402 
¡©e
->
v1
 = 
	`XXH32_round
(¡©e->v1, 
	`XXH_»adLE32
(
p32
, 
’dŸn
));…32++;

403 
¡©e
->
v2
 = 
	`XXH32_round
(¡©e->v2, 
	`XXH_»adLE32
(
p32
, 
’dŸn
));…32++;

404 
¡©e
->
v3
 = 
	`XXH32_round
(¡©e->v3, 
	`XXH_»adLE32
(
p32
, 
’dŸn
));…32++;

405 
¡©e
->
v4
 = 
	`XXH32_round
(¡©e->v4, 
	`XXH_»adLE32
(
p32
, 
’dŸn
));

407 
p
 +ğ16-
¡©e
->
memsize
;

408 
¡©e
->
memsize
 = 0;

411 ià(
p
 <ğ
bEnd
-16) {

412 cÚ¡ 
BYTE
* cÚ¡ 
lim™
 = 
bEnd
 - 16;

413 
U32
 
v1
 = 
¡©e
->v1;

414 
U32
 
v2
 = 
¡©e
->v2;

415 
U32
 
v3
 = 
¡©e
->v3;

416 
U32
 
v4
 = 
¡©e
->v4;

419 
v1
 = 
	`XXH32_round
(v1, 
	`XXH_»adLE32
(
p
, 
’dŸn
));…+=4;

420 
v2
 = 
	`XXH32_round
(v2, 
	`XXH_»adLE32
(
p
, 
’dŸn
));…+=4;

421 
v3
 = 
	`XXH32_round
(v3, 
	`XXH_»adLE32
(
p
, 
’dŸn
));…+=4;

422 
v4
 = 
	`XXH32_round
(v4, 
	`XXH_»adLE32
(
p
, 
’dŸn
));…+=4;

423 } 
p
<=
lim™
);

425 
¡©e
->
v1
 = v1;

426 
¡©e
->
v2
 = v2;

427 
¡©e
->
v3
 = v3;

428 
¡©e
->
v4
 = v4;

431 ià(
p
 < 
bEnd
) {

432 
	`XXH_memıy
(
¡©e
->
mem32
, 
p
, (
size_t
)(
bEnd
-p));

433 
¡©e
->
memsize
 = ()(
bEnd
-
p
);

436  
XXH_OK
;

437 
	}
}

439 
XXH_PUBLIC_API
 
XXH_”rÜcode
 
	$XXH32_upd©e
 (
XXH32_¡©e_t
* 
¡©e_š
, cÚ¡ * 
šput
, 
size_t
 
Ën
)

441 
XXH_’dŸÃss
 
’dŸn_d‘eùed
 = (XXH_’dŸÃss)
XXH_CPU_LITTLE_ENDIAN
;

443 ià((
’dŸn_d‘eùed
==
XXH_l™eEndŸn
è|| 
XXH_FORCE_NATIVE_FORMAT
)

444  
	`XXH32_upd©e_’dŸn
(
¡©e_š
, 
šput
, 
Ën
, 
XXH_l™eEndŸn
);

446  
	`XXH32_upd©e_’dŸn
(
¡©e_š
, 
šput
, 
Ën
, 
XXH_bigEndŸn
);

447 
	}
}

451 
FORCE_INLINE
 
U32
 
	$XXH32_dige¡_’dŸn
 (cÚ¡ 
XXH32_¡©e_t
* 
¡©e
, 
XXH_’dŸÃss
 
’dŸn
)

453 cÚ¡ 
BYTE
 * 
p
 = (cÚ¡ BYTE*)
¡©e
->
mem32
;

454 cÚ¡ 
BYTE
* cÚ¡ 
bEnd
 = (cÚ¡ BYTE*)(
¡©e
->
mem32
è+ s‹->
memsize
;

455 
U32
 
h32
;

457 ià(
¡©e
->
Ïrge_Ën
) {

458 
h32
 = 
	`XXH_rÙl32
(
¡©e
->
v1
, 1è+ XXH_rÙl32(¡©e->
v2
, 7è+ XXH_rÙl32(¡©e->
v3
, 12è+ XXH_rÙl32(¡©e->
v4
, 18);

460 
h32
 = 
¡©e
->
v3
 + 
PRIME32_5
;

463 
h32
 +ğ
¡©e
->
tÙ®_Ën_32
;

465 
p
+4<=
bEnd
) {

466 
h32
 +ğ
	`XXH_»adLE32
(
p
, 
’dŸn
è* 
PRIME32_3
;

467 
h32
 = 
	`XXH_rÙl32
(h32, 17è* 
PRIME32_4
;

468 
p
+=4;

471 
p
<
bEnd
) {

472 
h32
 +ğ(*
p
è* 
PRIME32_5
;

473 
h32
 = 
	`XXH_rÙl32
(h32, 11è* 
PRIME32_1
;

474 
p
++;

477 
h32
 ^= h32 >> 15;

478 
h32
 *ğ
PRIME32_2
;

479 
h32
 ^= h32 >> 13;

480 
h32
 *ğ
PRIME32_3
;

481 
h32
 ^= h32 >> 16;

483  
h32
;

484 
	}
}

487 
XXH_PUBLIC_API
 
	$XXH32_dige¡
 (cÚ¡ 
XXH32_¡©e_t
* 
¡©e_š
)

489 
XXH_’dŸÃss
 
’dŸn_d‘eùed
 = (XXH_’dŸÃss)
XXH_CPU_LITTLE_ENDIAN
;

491 ià((
’dŸn_d‘eùed
==
XXH_l™eEndŸn
è|| 
XXH_FORCE_NATIVE_FORMAT
)

492  
	`XXH32_dige¡_’dŸn
(
¡©e_š
, 
XXH_l™eEndŸn
);

494  
	`XXH32_dige¡_’dŸn
(
¡©e_š
, 
XXH_bigEndŸn
);

495 
	}
}

506 
XXH_PUBLIC_API
 
	$XXH32_ÿnÚiÿlFromHash
(
XXH32_ÿnÚiÿl_t
* 
d¡
, 
XXH32_hash_t
 
hash
)

508 
	`XXH_STATIC_ASSERT
((
XXH32_ÿnÚiÿl_t
è=ğ(
XXH32_hash_t
));

509 ià(
XXH_CPU_LITTLE_ENDIAN
è
hash
 = 
	`XXH_sw­32
(hash);

510 
	`memıy
(
d¡
, &
hash
, (*dst));

511 
	}
}

513 
XXH_PUBLIC_API
 
XXH32_hash_t
 
	$XXH32_hashFromCªÚiÿl
(cÚ¡ 
XXH32_ÿnÚiÿl_t
* 
¤c
)

515  
	`XXH_»adBE32
(
¤c
);

516 
	}
}

519 #iâdeà
XXH_NO_LONG_LONG


527 #iâdeà
MEM_MODULE


528 
	#MEM_MODULE


	)

529 #ià!
defšed
 (
__VMS
è&& (defšed (
__ılu¥lus
è|| (defšed (
__STDC_VERSION__
) && (__STDC_VERSION__ >= 199901L) ) )

530 
	~<¡dšt.h
>

531 
ušt64_t
 
	tU64
;

533 
	tU64
;

538 #ià(
defšed
(
XXH_FORCE_MEMORY_ACCESS
) && (XXH_FORCE_MEMORY_ACCESS==2))

541 
U64
 
	$XXH_»ad64
(cÚ¡ * 
memPŒ
è{  *(cÚ¡ 
U64
*èmemPŒ; 
	}
}

543 #–ià(
defšed
(
XXH_FORCE_MEMORY_ACCESS
) && (XXH_FORCE_MEMORY_ACCESS==1))

547 uniÚ { 
U32
 
	mu32
; 
U64
 
	mu64
; } 
	t__©Œibu‹__
((
	t·cked
)è
	tuÇlign64
;

548 
U64
 
	$XXH_»ad64
(cÚ¡ * 
±r
è{  ((cÚ¡ 
uÇlign64
*íŒ)->
u64
; 
	}
}

556 
U64
 
	$XXH_»ad64
(cÚ¡ * 
memPŒ
)

558 
U64
 
v®
;

559 
	`memıy
(&
v®
, 
memPŒ
, (val));

560  
v®
;

561 
	}
}

565 #ià
defšed
(
_MSC_VER
)

566 
	#XXH_sw­64
 
_by‹sw­_ušt64


	)

567 #–ià
XXH_GCC_VERSION
 >= 403

568 
	#XXH_sw­64
 
__butš_bsw­64


	)

570 
U64
 
	$XXH_sw­64
 (
U64
 
x
)

572  ((
x
 << 56) & 0xff00000000000000ULL) |

573 ((
x
 << 40) & 0x00ff000000000000ULL) |

574 ((
x
 << 24) & 0x0000ff0000000000ULL) |

575 ((
x
 << 8) & 0x000000ff00000000ULL) |

576 ((
x
 >> 8) & 0x00000000ff000000ULL) |

577 ((
x
 >> 24) & 0x0000000000ff0000ULL) |

578 ((
x
 >> 40) & 0x000000000000ff00ULL) |

579 ((
x
 >> 56) & 0x00000000000000ffULL);

580 
	}
}

583 
FORCE_INLINE
 
U64
 
	$XXH_»adLE64_®ign
(cÚ¡ * 
±r
, 
XXH_’dŸÃss
 
’dŸn
, 
XXH_®ignm’t
 
®ign
)

585 ià(
®ign
==
XXH_uÇligÃd
)

586  
’dŸn
==
XXH_l™eEndŸn
 ? 
	`XXH_»ad64
(
±r
è: 
	`XXH_sw­64
(XXH_read64(ptr));

588  
’dŸn
==
XXH_l™eEndŸn
 ? *(cÚ¡ 
U64
*)
±r
 : 
	`XXH_sw­64
(*(const U64*)ptr);

589 
	}
}

591 
FORCE_INLINE
 
U64
 
	$XXH_»adLE64
(cÚ¡ * 
±r
, 
XXH_’dŸÃss
 
’dŸn
)

593  
	`XXH_»adLE64_®ign
(
±r
, 
’dŸn
, 
XXH_uÇligÃd
);

594 
	}
}

596 
U64
 
	$XXH_»adBE64
(cÚ¡ * 
±r
)

598  
XXH_CPU_LITTLE_ENDIAN
 ? 
	`XXH_sw­64
(
	`XXH_»ad64
(
±r
)) : XXH_read64(ptr);

599 
	}
}

604 cÚ¡ 
U64
 
	gPRIME64_1
 = 11400714785074694791ULL;

605 cÚ¡ 
U64
 
	gPRIME64_2
 = 14029467366897019727ULL;

606 cÚ¡ 
U64
 
	gPRIME64_3
 = 1609587929392839161ULL;

607 cÚ¡ 
U64
 
	gPRIME64_4
 = 9650029242287828579ULL;

608 cÚ¡ 
U64
 
	gPRIME64_5
 = 2870177450012600261ULL;

610 
U64
 
	$XXH64_round
(
U64
 
acc
, U64 
šput
)

612 
acc
 +ğ
šput
 * 
PRIME64_2
;

613 
acc
 = 
	`XXH_rÙl64
(acc, 31);

614 
acc
 *ğ
PRIME64_1
;

615  
acc
;

616 
	}
}

618 
U64
 
	$XXH64_m”geRound
(
U64
 
acc
, U64 
v®
)

620 
v®
 = 
	`XXH64_round
(0, val);

621 
acc
 ^ğ
v®
;

622 
acc
 =‡cø* 
PRIME64_1
 + 
PRIME64_4
;

623  
acc
;

624 
	}
}

626 
FORCE_INLINE
 
U64
 
	$XXH64_’dŸn_®ign
(cÚ¡ * 
šput
, 
size_t
 
Ën
, 
U64
 
£ed
, 
XXH_’dŸÃss
 
’dŸn
, 
XXH_®ignm’t
 
®ign
)

628 cÚ¡ 
BYTE
* 
p
 = (cÚ¡ BYTE*)
šput
;

629 cÚ¡ 
BYTE
* 
bEnd
 = 
p
 + 
Ën
;

630 
U64
 
h64
;

631 
	#XXH_g‘64b™s
(
p
è
	`XXH_»adLE64_®ign
Õ, 
’dŸn
, 
®ign
)

	)

633 #ifdeà
XXH_ACCEPT_NULL_INPUT_POINTER


634 ià(
p
==
NULL
) {

635 
Ën
=0;

636 
bEnd
=
p
=(cÚ¡ 
BYTE
*)(
size_t
)32;

640 ià(
Ën
>=32) {

641 cÚ¡ 
BYTE
* cÚ¡ 
lim™
 = 
bEnd
 - 32;

642 
U64
 
v1
 = 
£ed
 + 
PRIME64_1
 + 
PRIME64_2
;

643 
U64
 
v2
 = 
£ed
 + 
PRIME64_2
;

644 
U64
 
v3
 = 
£ed
 + 0;

645 
U64
 
v4
 = 
£ed
 - 
PRIME64_1
;

648 
v1
 = 
	`XXH64_round
(v1, 
	`XXH_g‘64b™s
(
p
));…+=8;

649 
v2
 = 
	`XXH64_round
(v2, 
	`XXH_g‘64b™s
(
p
));…+=8;

650 
v3
 = 
	`XXH64_round
(v3, 
	`XXH_g‘64b™s
(
p
));…+=8;

651 
v4
 = 
	`XXH64_round
(v4, 
	`XXH_g‘64b™s
(
p
));…+=8;

652 } 
p
<=
lim™
);

654 
h64
 = 
	`XXH_rÙl64
(
v1
, 1è+ XXH_rÙl64(
v2
, 7è+ XXH_rÙl64(
v3
, 12è+ XXH_rÙl64(
v4
, 18);

655 
h64
 = 
	`XXH64_m”geRound
(h64, 
v1
);

656 
h64
 = 
	`XXH64_m”geRound
(h64, 
v2
);

657 
h64
 = 
	`XXH64_m”geRound
(h64, 
v3
);

658 
h64
 = 
	`XXH64_m”geRound
(h64, 
v4
);

661 
h64
 = 
£ed
 + 
PRIME64_5
;

664 
h64
 +ğ(
U64
è
Ën
;

666 
p
+8<=
bEnd
) {

667 
U64
 cÚ¡ 
k1
 = 
	`XXH64_round
(0, 
	`XXH_g‘64b™s
(
p
));

668 
h64
 ^ğ
k1
;

669 
h64
 = 
	`XXH_rÙl64
(h64,27è* 
PRIME64_1
 + 
PRIME64_4
;

670 
p
+=8;

673 ià(
p
+4<=
bEnd
) {

674 
h64
 ^ğ(
U64
)(
	`XXH_g‘32b™s
(
p
)è* 
PRIME64_1
;

675 
h64
 = 
	`XXH_rÙl64
(h64, 23è* 
PRIME64_2
 + 
PRIME64_3
;

676 
p
+=4;

679 
p
<
bEnd
) {

680 
h64
 ^ğ(*
p
è* 
PRIME64_5
;

681 
h64
 = 
	`XXH_rÙl64
(h64, 11è* 
PRIME64_1
;

682 
p
++;

685 
h64
 ^= h64 >> 33;

686 
h64
 *ğ
PRIME64_2
;

687 
h64
 ^= h64 >> 29;

688 
h64
 *ğ
PRIME64_3
;

689 
h64
 ^= h64 >> 32;

691  
h64
;

692 
	}
}

695 
XXH_PUBLIC_API
 
	$XXH64
 (cÚ¡ * 
šput
, 
size_t
 
Ën
, 
£ed
)

699 
XXH64_¡©e_t
 
¡©e
;

700 
	`XXH64_»£t
(&
¡©e
, 
£ed
);

701 
	`XXH64_upd©e
(&
¡©e
, 
šput
, 
Ën
);

702  
	`XXH64_dige¡
(&
¡©e
);

704 
XXH_’dŸÃss
 
’dŸn_d‘eùed
 = (XXH_’dŸÃss)
XXH_CPU_LITTLE_ENDIAN
;

706 ià(
XXH_FORCE_ALIGN_CHECK
) {

707 ià((((
size_t
)
šput
) & 7)==0) {

708 ià((
’dŸn_d‘eùed
==
XXH_l™eEndŸn
è|| 
XXH_FORCE_NATIVE_FORMAT
)

709  
	`XXH64_’dŸn_®ign
(
šput
, 
Ën
, 
£ed
, 
XXH_l™eEndŸn
, 
XXH_®igÃd
);

711  
	`XXH64_’dŸn_®ign
(
šput
, 
Ën
, 
£ed
, 
XXH_bigEndŸn
, 
XXH_®igÃd
);

714 ià((
’dŸn_d‘eùed
==
XXH_l™eEndŸn
è|| 
XXH_FORCE_NATIVE_FORMAT
)

715  
	`XXH64_’dŸn_®ign
(
šput
, 
Ën
, 
£ed
, 
XXH_l™eEndŸn
, 
XXH_uÇligÃd
);

717  
	`XXH64_’dŸn_®ign
(
šput
, 
Ën
, 
£ed
, 
XXH_bigEndŸn
, 
XXH_uÇligÃd
);

719 
	}
}

723 
XXH_PUBLIC_API
 
XXH64_¡©e_t
* 
	$XXH64_ü—‹S‹
()

725  (
XXH64_¡©e_t
*)
	`XXH_m®loc
((XXH64_state_t));

726 
	}
}

727 
XXH_PUBLIC_API
 
XXH_”rÜcode
 
	$XXH64_ä“S‹
(
XXH64_¡©e_t
* 
¡©ePŒ
)

729 
	`XXH_ä“
(
¡©ePŒ
);

730  
XXH_OK
;

731 
	}
}

733 
XXH_PUBLIC_API
 
	$XXH64_cİyS‹
(
XXH64_¡©e_t
* 
d¡S‹
, cÚ¡ XXH64_¡©e_t* 
¤cS‹
)

735 
	`memıy
(
d¡S‹
, 
¤cS‹
, (*dstState));

736 
	}
}

738 
XXH_PUBLIC_API
 
XXH_”rÜcode
 
	$XXH64_»£t
(
XXH64_¡©e_t
* 
¡©ePŒ
, 
£ed
)

740 
XXH64_¡©e_t
 
¡©e
;

741 
	`mem£t
(&
¡©e
, 0, (state)-8);

742 
¡©e
.
v1
 = 
£ed
 + 
PRIME64_1
 + 
PRIME64_2
;

743 
¡©e
.
v2
 = 
£ed
 + 
PRIME64_2
;

744 
¡©e
.
v3
 = 
£ed
 + 0;

745 
¡©e
.
v4
 = 
£ed
 - 
PRIME64_1
;

746 
	`memıy
(
¡©ePŒ
, &
¡©e
, (state));

747  
XXH_OK
;

748 
	}
}

750 
FORCE_INLINE
 
XXH_”rÜcode
 
	$XXH64_upd©e_’dŸn
 (
XXH64_¡©e_t
* 
¡©e
, cÚ¡ * 
šput
, 
size_t
 
Ën
, 
XXH_’dŸÃss
 
’dŸn
)

752 cÚ¡ 
BYTE
* 
p
 = (cÚ¡ BYTE*)
šput
;

753 cÚ¡ 
BYTE
* cÚ¡ 
bEnd
 = 
p
 + 
Ën
;

755 ià(
šput
==
NULL
)

756 #ifdeà
XXH_ACCEPT_NULL_INPUT_POINTER


757  
XXH_OK
;

759  
XXH_ERROR
;

762 
¡©e
->
tÙ®_Ën
 +ğ
Ën
;

764 ià(
¡©e
->
memsize
 + 
Ën
 < 32) {

765 
	`XXH_memıy
(((
BYTE
*)
¡©e
->
mem64
è+ s‹->
memsize
, 
šput
, 
Ën
);

766 
¡©e
->
memsize
 +ğ(
U32
)
Ën
;

767  
XXH_OK
;

770 ià(
¡©e
->
memsize
) {

771 
	`XXH_memıy
(((
BYTE
*)
¡©e
->
mem64
è+ s‹->
memsize
, 
šput
, 32-state->memsize);

772 
¡©e
->
v1
 = 
	`XXH64_round
(¡©e->v1, 
	`XXH_»adLE64
(¡©e->
mem64
+0, 
’dŸn
));

773 
¡©e
->
v2
 = 
	`XXH64_round
(¡©e->v2, 
	`XXH_»adLE64
(¡©e->
mem64
+1, 
’dŸn
));

774 
¡©e
->
v3
 = 
	`XXH64_round
(¡©e->v3, 
	`XXH_»adLE64
(¡©e->
mem64
+2, 
’dŸn
));

775 
¡©e
->
v4
 = 
	`XXH64_round
(¡©e->v4, 
	`XXH_»adLE64
(¡©e->
mem64
+3, 
’dŸn
));

776 
p
 +ğ32-
¡©e
->
memsize
;

777 
¡©e
->
memsize
 = 0;

780 ià(
p
+32 <ğ
bEnd
) {

781 cÚ¡ 
BYTE
* cÚ¡ 
lim™
 = 
bEnd
 - 32;

782 
U64
 
v1
 = 
¡©e
->v1;

783 
U64
 
v2
 = 
¡©e
->v2;

784 
U64
 
v3
 = 
¡©e
->v3;

785 
U64
 
v4
 = 
¡©e
->v4;

788 
v1
 = 
	`XXH64_round
(v1, 
	`XXH_»adLE64
(
p
, 
’dŸn
));…+=8;

789 
v2
 = 
	`XXH64_round
(v2, 
	`XXH_»adLE64
(
p
, 
’dŸn
));…+=8;

790 
v3
 = 
	`XXH64_round
(v3, 
	`XXH_»adLE64
(
p
, 
’dŸn
));…+=8;

791 
v4
 = 
	`XXH64_round
(v4, 
	`XXH_»adLE64
(
p
, 
’dŸn
));…+=8;

792 } 
p
<=
lim™
);

794 
¡©e
->
v1
 = v1;

795 
¡©e
->
v2
 = v2;

796 
¡©e
->
v3
 = v3;

797 
¡©e
->
v4
 = v4;

800 ià(
p
 < 
bEnd
) {

801 
	`XXH_memıy
(
¡©e
->
mem64
, 
p
, (
size_t
)(
bEnd
-p));

802 
¡©e
->
memsize
 = ()(
bEnd
-
p
);

805  
XXH_OK
;

806 
	}
}

808 
XXH_PUBLIC_API
 
XXH_”rÜcode
 
	$XXH64_upd©e
 (
XXH64_¡©e_t
* 
¡©e_š
, cÚ¡ * 
šput
, 
size_t
 
Ën
)

810 
XXH_’dŸÃss
 
’dŸn_d‘eùed
 = (XXH_’dŸÃss)
XXH_CPU_LITTLE_ENDIAN
;

812 ià((
’dŸn_d‘eùed
==
XXH_l™eEndŸn
è|| 
XXH_FORCE_NATIVE_FORMAT
)

813  
	`XXH64_upd©e_’dŸn
(
¡©e_š
, 
šput
, 
Ën
, 
XXH_l™eEndŸn
);

815  
	`XXH64_upd©e_’dŸn
(
¡©e_š
, 
šput
, 
Ën
, 
XXH_bigEndŸn
);

816 
	}
}

818 
FORCE_INLINE
 
U64
 
	$XXH64_dige¡_’dŸn
 (cÚ¡ 
XXH64_¡©e_t
* 
¡©e
, 
XXH_’dŸÃss
 
’dŸn
)

820 cÚ¡ 
BYTE
 * 
p
 = (cÚ¡ BYTE*)
¡©e
->
mem64
;

821 cÚ¡ 
BYTE
* cÚ¡ 
bEnd
 = (cÚ¡ BYTE*)
¡©e
->
mem64
 + s‹->
memsize
;

822 
U64
 
h64
;

824 ià(
¡©e
->
tÙ®_Ën
 >= 32) {

825 
U64
 cÚ¡ 
v1
 = 
¡©e
->v1;

826 
U64
 cÚ¡ 
v2
 = 
¡©e
->v2;

827 
U64
 cÚ¡ 
v3
 = 
¡©e
->v3;

828 
U64
 cÚ¡ 
v4
 = 
¡©e
->v4;

830 
h64
 = 
	`XXH_rÙl64
(
v1
, 1è+ XXH_rÙl64(
v2
, 7è+ XXH_rÙl64(
v3
, 12è+ XXH_rÙl64(
v4
, 18);

831 
h64
 = 
	`XXH64_m”geRound
(h64, 
v1
);

832 
h64
 = 
	`XXH64_m”geRound
(h64, 
v2
);

833 
h64
 = 
	`XXH64_m”geRound
(h64, 
v3
);

834 
h64
 = 
	`XXH64_m”geRound
(h64, 
v4
);

836 
h64
 = 
¡©e
->
v3
 + 
PRIME64_5
;

839 
h64
 +ğ(
U64
è
¡©e
->
tÙ®_Ën
;

841 
p
+8<=
bEnd
) {

842 
U64
 cÚ¡ 
k1
 = 
	`XXH64_round
(0, 
	`XXH_»adLE64
(
p
, 
’dŸn
));

843 
h64
 ^ğ
k1
;

844 
h64
 = 
	`XXH_rÙl64
(h64,27è* 
PRIME64_1
 + 
PRIME64_4
;

845 
p
+=8;

848 ià(
p
+4<=
bEnd
) {

849 
h64
 ^ğ(
U64
)(
	`XXH_»adLE32
(
p
, 
’dŸn
)è* 
PRIME64_1
;

850 
h64
 = 
	`XXH_rÙl64
(h64, 23è* 
PRIME64_2
 + 
PRIME64_3
;

851 
p
+=4;

854 
p
<
bEnd
) {

855 
h64
 ^ğ(*
p
è* 
PRIME64_5
;

856 
h64
 = 
	`XXH_rÙl64
(h64, 11è* 
PRIME64_1
;

857 
p
++;

860 
h64
 ^= h64 >> 33;

861 
h64
 *ğ
PRIME64_2
;

862 
h64
 ^= h64 >> 29;

863 
h64
 *ğ
PRIME64_3
;

864 
h64
 ^= h64 >> 32;

866  
h64
;

867 
	}
}

869 
XXH_PUBLIC_API
 
	$XXH64_dige¡
 (cÚ¡ 
XXH64_¡©e_t
* 
¡©e_š
)

871 
XXH_’dŸÃss
 
’dŸn_d‘eùed
 = (XXH_’dŸÃss)
XXH_CPU_LITTLE_ENDIAN
;

873 ià((
’dŸn_d‘eùed
==
XXH_l™eEndŸn
è|| 
XXH_FORCE_NATIVE_FORMAT
)

874  
	`XXH64_dige¡_’dŸn
(
¡©e_š
, 
XXH_l™eEndŸn
);

876  
	`XXH64_dige¡_’dŸn
(
¡©e_š
, 
XXH_bigEndŸn
);

877 
	}
}

882 
XXH_PUBLIC_API
 
	$XXH64_ÿnÚiÿlFromHash
(
XXH64_ÿnÚiÿl_t
* 
d¡
, 
XXH64_hash_t
 
hash
)

884 
	`XXH_STATIC_ASSERT
((
XXH64_ÿnÚiÿl_t
è=ğ(
XXH64_hash_t
));

885 ià(
XXH_CPU_LITTLE_ENDIAN
è
hash
 = 
	`XXH_sw­64
(hash);

886 
	`memıy
(
d¡
, &
hash
, (*dst));

887 
	}
}

889 
XXH_PUBLIC_API
 
XXH64_hash_t
 
	$XXH64_hashFromCªÚiÿl
(cÚ¡ 
XXH64_ÿnÚiÿl_t
* 
¤c
)

891  
	`XXH_»adBE64
(
¤c
);

892 
	}
}

	@third-party/xxHash/xxhash.h

67 #iâdeà
XXHASH_H_5627135585666179


68 
	#XXHASH_H_5627135585666179
 1

	)

70 #ià
defšed
 (
__ılu¥lus
)

78 
	~<¡ddef.h
>

79 ’um { 
XXH_OK
=0, 
XXH_ERROR
 } 
	tXXH_”rÜcode
;

94 #ifdeà
XXH_PRIVATE_API


95 #iâdeà
XXH_STATIC_LINKING_ONLY


96 
	#XXH_STATIC_LINKING_ONLY


	)

98 #ià
defšed
(
__GNUC__
)

99 
	#XXH_PUBLIC_API
 
__šlše
 
	`__©Œibu‹__
((
unu£d
))

	)

100 #–ià
defšed
 (
__ılu¥lus
è|| (defšed (
__STDC_VERSION__
) && (__STDC_VERSION__ >= 199901L) )

101 
	#XXH_PUBLIC_API
 
šlše


	)

102 #–ià
defšed
(
_MSC_VER
)

103 
	#XXH_PUBLIC_API
 
__šlše


	)

105 
	#XXH_PUBLIC_API
 

	)

108 
	#XXH_PUBLIC_API


	)

122 #ifdeà
XXH_NAMESPACE


123 
	#XXH_CAT
(
A
,
B
èA##
	)
B

124 
	#XXH_NAME2
(
A
,
B
è
	`XXH_CAT
(A,B)

	)

125 
	#XXH_v”siÚNumb”
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH_v”siÚNumb”
)

	)

126 
	#XXH32
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH32
)

	)

127 
	#XXH32_ü—‹S‹
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH32_ü—‹S‹
)

	)

128 
	#XXH32_ä“S‹
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH32_ä“S‹
)

	)

129 
	#XXH32_»£t
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH32_»£t
)

	)

130 
	#XXH32_upd©e
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH32_upd©e
)

	)

131 
	#XXH32_dige¡
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH32_dige¡
)

	)

132 
	#XXH32_cİyS‹
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH32_cİyS‹
)

	)

133 
	#XXH32_ÿnÚiÿlFromHash
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH32_ÿnÚiÿlFromHash
)

	)

134 
	#XXH32_hashFromCªÚiÿl
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH32_hashFromCªÚiÿl
)

	)

135 
	#XXH64
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH64
)

	)

136 
	#XXH64_ü—‹S‹
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH64_ü—‹S‹
)

	)

137 
	#XXH64_ä“S‹
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH64_ä“S‹
)

	)

138 
	#XXH64_»£t
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH64_»£t
)

	)

139 
	#XXH64_upd©e
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH64_upd©e
)

	)

140 
	#XXH64_dige¡
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH64_dige¡
)

	)

141 
	#XXH64_cİyS‹
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH64_cİyS‹
)

	)

142 
	#XXH64_ÿnÚiÿlFromHash
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH64_ÿnÚiÿlFromHash
)

	)

143 
	#XXH64_hashFromCªÚiÿl
 
	`XXH_NAME2
(
XXH_NAMESPACE
, 
XXH64_hashFromCªÚiÿl
)

	)

150 
	#XXH_VERSION_MAJOR
 0

	)

151 
	#XXH_VERSION_MINOR
 6

	)

152 
	#XXH_VERSION_RELEASE
 3

	)

153 
	#XXH_VERSION_NUMBER
 (
XXH_VERSION_MAJOR
 *100*100 + 
XXH_VERSION_MINOR
 *100 + 
XXH_VERSION_RELEASE
)

	)

154 
XXH_PUBLIC_API
 
XXH_v”siÚNumb”
 ();

160 
	tXXH32_hash_t
;

167 
XXH_PUBLIC_API
 
XXH32_hash_t
 
XXH32
 (cÚ¡ * 
šput
, 
size_t
 
Ëngth
, 
£ed
);

170 
XXH32_¡©e_s
 
	tXXH32_¡©e_t
;

171 
XXH_PUBLIC_API
 
XXH32_¡©e_t
* 
XXH32_ü—‹S‹
();

172 
XXH_PUBLIC_API
 
XXH_”rÜcode
 
XXH32_ä“S‹
(
XXH32_¡©e_t
* 
¡©ePŒ
);

173 
XXH_PUBLIC_API
 
XXH32_cİyS‹
(
XXH32_¡©e_t
* 
d¡_¡©e
, cÚ¡ XXH32_¡©e_t* 
¤c_¡©e
);

175 
XXH_PUBLIC_API
 
XXH_”rÜcode
 
XXH32_»£t
 (
XXH32_¡©e_t
* 
¡©ePŒ
, 
£ed
);

176 
XXH_PUBLIC_API
 
XXH_”rÜcode
 
XXH32_upd©e
 (
XXH32_¡©e_t
* 
¡©ePŒ
, cÚ¡ * 
šput
, 
size_t
 
Ëngth
);

177 
XXH_PUBLIC_API
 
XXH32_hash_t
 
XXH32_dige¡
 (cÚ¡ 
XXH32_¡©e_t
* 
¡©ePŒ
);

203 ¡ruù { 
dige¡
[4]; } 
	tXXH32_ÿnÚiÿl_t
;

204 
XXH_PUBLIC_API
 
XXH32_ÿnÚiÿlFromHash
(
XXH32_ÿnÚiÿl_t
* 
d¡
, 
XXH32_hash_t
 
hash
);

205 
XXH_PUBLIC_API
 
XXH32_hash_t
 
XXH32_hashFromCªÚiÿl
(cÚ¡ 
XXH32_ÿnÚiÿl_t
* 
¤c
);

214 #iâdeà
XXH_NO_LONG_LONG


218 
	tXXH64_hash_t
;

225 
XXH_PUBLIC_API
 
XXH64_hash_t
 
XXH64
 (cÚ¡ * 
šput
, 
size_t
 
Ëngth
, 
£ed
);

228 
XXH64_¡©e_s
 
	tXXH64_¡©e_t
;

229 
XXH_PUBLIC_API
 
XXH64_¡©e_t
* 
XXH64_ü—‹S‹
();

230 
XXH_PUBLIC_API
 
XXH_”rÜcode
 
XXH64_ä“S‹
(
XXH64_¡©e_t
* 
¡©ePŒ
);

231 
XXH_PUBLIC_API
 
XXH64_cİyS‹
(
XXH64_¡©e_t
* 
d¡_¡©e
, cÚ¡ XXH64_¡©e_t* 
¤c_¡©e
);

233 
XXH_PUBLIC_API
 
XXH_”rÜcode
 
XXH64_»£t
 (
XXH64_¡©e_t
* 
¡©ePŒ
, 
£ed
);

234 
XXH_PUBLIC_API
 
XXH_”rÜcode
 
XXH64_upd©e
 (
XXH64_¡©e_t
* 
¡©ePŒ
, cÚ¡ * 
šput
, 
size_t
 
Ëngth
);

235 
XXH_PUBLIC_API
 
XXH64_hash_t
 
XXH64_dige¡
 (cÚ¡ 
XXH64_¡©e_t
* 
¡©ePŒ
);

238 ¡ruù { 
dige¡
[8]; } 
	tXXH64_ÿnÚiÿl_t
;

239 
XXH_PUBLIC_API
 
XXH64_ÿnÚiÿlFromHash
(
XXH64_ÿnÚiÿl_t
* 
d¡
, 
XXH64_hash_t
 
hash
);

240 
XXH_PUBLIC_API
 
XXH64_hash_t
 
XXH64_hashFromCªÚiÿl
(cÚ¡ 
XXH64_ÿnÚiÿl_t
* 
¤c
);

244 #ifdeà
XXH_STATIC_LINKING_ONLY


257 
	sXXH32_¡©e_s
 {

258 
tÙ®_Ën_32
;

259 
Ïrge_Ën
;

260 
v1
;

261 
v2
;

262 
v3
;

263 
v4
;

264 
mem32
[4];

265 
memsize
;

266 
»£rved
;

269 #iâdeà
XXH_NO_LONG_LONG


270 
	sXXH64_¡©e_s
 {

271 
tÙ®_Ën
;

272 
v1
;

273 
v2
;

274 
v3
;

275 
v4
;

276 
mem64
[4];

277 
memsize
;

278 
»£rved
[2];

282 #ifdeà
XXH_PRIVATE_API


283 
	~"xxhash.c
"

289 #ià
defšed
 (
__ılu¥lus
)

	@third-party/xxHash/xxhsum.c

31 #iâdeà
XXHASH_C_2097394837


32 
	#XXHASH_C_2097394837


	)

38 #ià
defšed
(
_MSC_VER
è|| defšed(
_WIN32
)

39 
	#_CRT_SECURE_NO_WARNINGS


	)

43 #iâdeà
_LARGEFILE64_SOURCE


44 
	#_LARGEFILE64_SOURCE


	)

51 
	~<¡dlib.h
>

52 
	~<¡dio.h
>

53 
	~<¡ršg.h
>

54 
	~<sys/ty³s.h
>

55 
	~<sys/¡©.h
>

56 
	~<time.h
>

58 
	#XXH_STATIC_LINKING_ONLY


	)

59 
	~"xxhash.h
"

65 #ià
defšed
(
MSDOS
è|| defšed(
OS2
è|| defšed(
WIN32
è|| defšed(
_WIN32
è|| defšed(
__CYGWIN__
)

66 
	~<fú.h
>

67 
	~<io.h
>

68 #ifdeà
__MINGW32__


69 
_f’o
(
FILE
 *
¡»am
);

71 
	#SET_BINARY_MODE
(
fe
è
	`_£tmode
(
	`_f’o
(fe), 
_O_BINARY
)

	)

72 
	#IS_CONSOLE
(
¡dSŒ—m
è
	`_i§‰y
(
	`_f’o
(¡dSŒ—m))

	)

74 
	~<uni¡d.h
>

75 
	#SET_BINARY_MODE
(
fe
)

	)

76 
	#IS_CONSOLE
(
¡dSŒ—m
è
	`i§‰y
(
STDIN_FILENO
)

	)

79 #ià!
defšed
(
S_ISREG
)

80 
	#S_ISREG
(
x
è(((xè& 
S_IFMT
è=ğ
S_IFREG
)

	)

87 #iâdeà
MEM_MODULE


88 
	#MEM_MODULE


	)

89 #ià
defšed
 (
__STDC_VERSION__
) && __STDC_VERSION__ >= 199901L

90 
	~<¡dšt.h
>

91 
ušt8_t
 
	tBYTE
;

92 
ušt16_t
 
	tU16
;

93 
ušt32_t
 
	tU32
;

94 
št32_t
 
	tS32
;

95 
ušt64_t
 
	tU64
;

97 
	tBYTE
;

98 
	tU16
;

99 
	tU32
;

100 sigÃd 
	tS32
;

101 
	tU64
;

105 
	$BMK_isL™eEndŸn
()

107 cÚ¡ uniÚ { 
U32
 
u
; 
BYTE
 
c
[4]; } 
Úe
 = { 1 };

108  
Úe
.
c
[0];

109 
	}
}

115 
	#LIB_VERSION
 
XXH_VERSION_MAJOR
.
XXH_VERSION_MINOR
.
XXH_VERSION_RELEASE


	)

116 
	#QUOTE
(
¡r
è#¡r

	)

117 
	#EXPAND_AND_QUOTE
(
¡r
è
	`QUOTE
(¡r)

	)

118 
	#PROGRAM_VERSION
 
	`EXPAND_AND_QUOTE
(
LIB_VERSION
)

	)

119 cÚ¡ 
	gg_nbB™s
 = ()((*)*8);

120 cÚ¡ 
	gg_ËÇme
[] = "littleƒndian";

121 cÚ¡ 
	gg_b’ame
[] = "bigƒndian";

122 
	#ENDIAN_NAME
 (
	`BMK_isL™eEndŸn
(è? 
g_ËÇme
 : 
g_b’ame
)

	)

123 cÚ¡ 
	gauthÜ
[] = "Yann Collet";

124 
	#WELCOME_MESSAGE
(
ex’ame
è"% % (%i-b™ %s), by % \n",ƒx’ame, 
PROGRAM_VERSION
, 
g_nbB™s
, 
ENDIAN_NAME
, 
authÜ


	)

126 
	#NBLOOPS
 3

	)

127 
	#TIMELOOP_S
 1

	)

128 
	#TIMELOOP
 (
TIMELOOP_S
 * 
CLOCKS_PER_SEC
è

	)

129 
	#XXHSUM32_DEFAULT_SEED
 0

	)

130 
	#XXHSUM64_DEFAULT_SEED
 0

	)

132 
	#KB
 *Ğ1<<10)

	)

133 
	#MB
 *Ğ1<<20)

	)

134 
	#GB
 *(1U<<30)

	)

136 
	#MAX_MEM
 (2 
GB
 - 64 
MB
)

	)

138 cÚ¡ 
	g¡dšName
[] = "-";

139 ’um { 
	m®go_xxh32
, 
	m®go_xxh64
 } 
	t®goTy³
;

140 cÚ¡ 
®goTy³
 
	gg_deçuÉAlgo
 = 
®go_xxh64
;

144 
	#DEFAULT_LINE_LENGTH
 ((
XXH64_hash_t
è* 2 + 2 + 4096 + 1)

	)

147 
	#MAX_LINE_LENGTH
 (32 
KB
)

	)

153 
	#DISPLAY
(...è
	`årštf
(
¡d”r
, 
__VA_ARGS__
)

	)

154 
	#DISPLAYRESULT
(...è
	`årštf
(
¡dout
, 
__VA_ARGS__
)

	)

155 
	#DISPLAYLEVEL
(
l
, ...èià(
g_di¥ÏyLev–
>öè
	`DISPLAY
(
__VA_ARGS__
);

	)

156 
U32
 
	gg_di¥ÏyLev–
 = 1;

162 
size_t
 
	gg_§m¶eSize
 = 100 
KB
;

163 
U32
 
	gg_nbI‹¿tiÚs
 = 
NBLOOPS
;

169 
şock_t
 
	$BMK_şockS·n
Ğ
şock_t
 
¡¬t
 )

171  
	`şock
(è- 
¡¬t
;

172 
	}
}

175 
size_t
 
	$BMK_fšdMaxMem
(
U64
 
»quœedMem
)

177 
size_t
 cÚ¡ 
¡•
 = 64 
MB
;

178 * 
‹¡mem
 = 
NULL
;

180 
»quœedMem
 = (((requiredMem >> 26) + 1) << 26);

181 
»quœedMem
 +ğ2*
¡•
;

182 ià(
»quœedMem
 > 
MAX_MEM
)„equiredMem = MAX_MEM;

184 !
‹¡mem
) {

185 ià(
»quœedMem
 > 
¡•
)„equiredMem -= step;

186 
»quœedMem
 >>= 1;

187 
‹¡mem
 = 
	`m®loc
 ((
size_t
)
»quœedMem
);

189 
	`ä“
 (
‹¡mem
);

192 ià(
»quœedMem
 > 
¡•
)„equiredMem -= step;

193 
»quœedMem
 >>= 1;

195  (
size_t
)
»quœedMem
;

196 
	}
}

199 
U64
 
	$BMK_G‘FeSize
(cÚ¡ * 
šf’ame
)

201 
r
;

202 #ià
	`defšed
(
_MSC_VER
)

203 
_¡©64
 
¡©buf
;

204 
r
 = 
	`_¡©64
(
šf’ame
, &
¡©buf
);

206 
¡©
 
¡©buf
;

207 
r
 = 
	`¡©
(
šf’ame
, &
¡©buf
);

209 ià(
r
 || !
	`S_ISREG
(
¡©buf
.
¡_mode
))  0;

210  (
U64
)
¡©buf
.
¡_size
;

211 
	}
}

213 
	$U32
 (*
	thashFunùiÚ
)(cÚ¡ * 
	tbufãr
, 
	tsize_t
 
	tbufãrSize
, 
	tU32
 
	t£ed
);

215 
U32
 
	$loÿlXXH32
(cÚ¡ * 
bufãr
, 
size_t
 
bufãrSize
, 
U32
 
£ed
è{  
	`XXH32
(bufãr, bufãrSize, s“d); 
	}
}

217 
U32
 
	$loÿlXXH64
(cÚ¡ * 
bufãr
, 
size_t
 
bufãrSize
, 
U32
 
£ed
è{  (U32)
	`XXH64
(bufãr, bufãrSize, s“d); 
	}
}

219 
	$BMK_b’chHash
(
hashFunùiÚ
 
h
, cÚ¡ * 
hName
, cÚ¡ * 
bufãr
, 
size_t
 
bufãrSize
)

221 cÚ¡ 
U32
 
nbh_³¾oİ
 = 100;

222 
U32
 
™”©iÚNb
;

223 
ç¡e¡H
 = 100000000.;

225 
	`DISPLAY
("\r%79s\r", "");

226 ià(
g_nbI‹¿tiÚs
<1) g_nbIterations=1;

227 
™”©iÚNb
 = 1; i‹¿tiÚNb <ğ
g_nbI‹¿tiÚs
; iterationNb++) {

228 
U32
 
nbHashes
 = 0, 
r
=0;

229 
şock_t
 
cS¹
;

231 
	`DISPLAY
("%1i-%-17.17 : %10u ->\r", 
™”©iÚNb
, 
hName
, (
U32
)
bufãrSize
);

232 
cS¹
 = 
	`şock
();

233 
	`şock
(è=ğ
cS¹
);

234 
cS¹
 = 
	`şock
();

236 
	`BMK_şockS·n
(
cS¹
è< 
TIMELOOP
) {

237 
U32
 
i
;

238 
i
=0; i<
nbh_³¾oİ
; i++)

239 
r
 +ğ
	`h
(
bufãr
, 
bufãrSize
, 
i
);

240 
nbHashes
 +ğ
nbh_³¾oİ
;

242 ià(
r
==0è
	`DISPLAY
(".\r");

243 { cÚ¡ 
timeS
 = (()
	`BMK_şockS·n
(
cS¹
è/ 
CLOCKS_PER_SEC
è/ 
nbHashes
;

244 ià(
timeS
 < 
ç¡e¡H
) fastestH =imeS;

245 
	`DISPLAY
("%1i-%-17.17 : %10u -> %7.1àMB/s\r", 
™”©iÚNb
, 
hName
, (
U32
)
bufãrSize
, (()bufãrSiz/ (1<<20)è/ 
ç¡e¡H
 );

248 
	`DISPLAY
("%-19.19 : %10u -> %7.1àMB/  \n", 
hName
, (
U32
)
bufãrSize
, (()bufãrSiz/ (1<<20)è/ 
ç¡e¡H
);

249 
	}
}

253 
	$BMK_b’chMem
(cÚ¡ * 
bufãr
, 
size_t
 
bufãrSize
)

256 
	`BMK_b’chHash
(
loÿlXXH32
, "XXH32", 
bufãr
, 
bufãrSize
);

259 
	`BMK_b’chHash
(
loÿlXXH32
, "XXH32 uÇligÃd", ((cÚ¡ *)
bufãr
)+1, 
bufãrSize
);

262 
	`BMK_b’chHash
(
loÿlXXH64
, "XXH64", 
bufãr
, 
bufãrSize
);

265 
	`BMK_b’chHash
(
loÿlXXH64
, "XXH64 uÇligÃd", ((cÚ¡ *)
bufãr
)+3, 
bufãrSize
);

266 
	}
}

269 
size_t
 
	$BMK_£ËùB’chedSize
(cÚ¡ * 
feName
)

270 { 
U64
 cÚ¡ 
šFeSize
 = 
	`BMK_G‘FeSize
(
feName
);

271 
size_t
 
b’chedSize
 = (size_tè
	`BMK_fšdMaxMem
(
šFeSize
);

272 ià((
U64
)
b’chedSize
 > 
šFeSize
èb’chedSizğ(
size_t
)inFileSize;

273 ià(
b’chedSize
 < 
šFeSize
) {

274 
	`DISPLAY
("NÙƒnough memÜy fÜ '%s' fuÎ size;e¡šg %˜MB oÆy...\n", 
feName
, ()(
b’chedSize
>>20));

276  
b’chedSize
;

277 
	}
}

280 
	$BMK_b’chFes
(cÚ¡ ** 
feNamesTabË
, 
nbFes
)

282 
feIdx
;

283 
feIdx
=0; feIdx<
nbFes
; fileIdx++) {

284 cÚ¡ * cÚ¡ 
šFeName
 = 
feNamesTabË
[
feIdx
];

285 
FILE
* cÚ¡ 
šFe
 = 
	`fİ’
Ğ
šFeName
, "rb" );

286 
size_t
 cÚ¡ 
b’chedSize
 = 
	`BMK_£ËùB’chedSize
(
šFeName
);

287 * cÚ¡ 
bufãr
 = (*)
	`ÿÎoc
(
b’chedSize
+16+3, 1);

288 * cÚ¡ 
®igÃdBufãr
 = (
bufãr
+15è- (((
size_t
)(buffer+15)) & 0xF);

291 ià((
šFe
==
NULL
è|| (
šFeName
==NULL)) {

292 
	`DISPLAY
Ğ"Pb o³nšg %s\n", 
šFeName
);

293 
	`ä“
(
bufãr
);

296 if(!
bufãr
) {

297 
	`DISPLAY
("\nError:‚otƒnough memory!\n");

298 
	`fşo£
(
šFe
);

303 
	`DISPLAY
("\rLßdšg %s... \n", 
šFeName
);

304 { 
size_t
 cÚ¡ 
»adSize
 = 
	`ä—d
(
®igÃdBufãr
, 1, 
b’chedSize
, 
šFe
);

305 
	`fşo£
(
šFe
);

306 if(
»adSize
 !ğ
b’chedSize
) {

307 
	`DISPLAY
("\nE¼Ü:…robËm„—dšg f'%s' !! \n", 
šFeName
);

308 
	`ä“
(
bufãr
);

313 
	`BMK_b’chMem
(
®igÃdBufãr
, 
b’chedSize
);

315 
	`ä“
(
bufãr
);

319 
	}
}

323 
	$BMK_b’chIÁ”Çl
()

325 
size_t
 cÚ¡ 
b’chedSize
 = 
g_§m¶eSize
;

326 * cÚ¡ 
bufãr
 = 
	`ÿÎoc
(
b’chedSize
+3, 1);

327 if(!
bufãr
) {

328 
	`DISPLAY
("\nError:‚otƒnough memory!\n");

333 
	`DISPLAY
("\rSam¶oà%u KB... \n", (
U32
)(
b’chedSize
 >> 10));

334 
	`BMK_b’chMem
(
bufãr
, 
b’chedSize
);

336 
	`ä“
(
bufãr
);

338 
	}
}

341 
	$BMK_checkResuÉ
(
U32
 
r1
, U32 
r2
)

343 
nbTe¡s
 = 1;

344 ià(
r1
==
r2
è
	`DISPLAY
("\rTe¡%3˜: %08X =ğ%08X ok ", 
nbTe¡s
,„1,„2);

346 
	`DISPLAY
("\rERROR : Te¡%3˜: %08X <> %08X !!!!! \n", 
nbTe¡s
, 
r1
, 
r2
);

347 
	`ex™
(1);

349 
nbTe¡s
++;

350 
	}
}

353 
	$BMK_checkResuÉ64
(
U64
 
r1
, U64 
r2
)

355 
nbTe¡s
 = 1;

356 ià(
r1
!=
r2
) {

357 
	`DISPLAY
("\rERROR : Te¡%3˜: 64-b™ v®ue nÚƒqu®  !!!!! \n", 
nbTe¡s
);

358 
	`DISPLAY
("\¸%08X%08X !ğ%08X%08X \n", (
U32
)(
r1
>>32), (U32ì1, (U32)(
r2
>>32), (U32)r2);

359 
	`ex™
(1);

361 
nbTe¡s
++;

362 
	}
}

365 
	$BMK_‹¡Sequ’û64
(* 
£Á’û
, 
size_t
 
Ën
, 
U64
 
£ed
, U64 
N»suÉ
)

367 
XXH64_¡©e_t
 
¡©e
;

368 
U64
 
D»suÉ
;

369 
size_t
 
pos
;

371 
D»suÉ
 = 
	`XXH64
(
£Á’û
, 
Ën
, 
£ed
);

372 
	`BMK_checkResuÉ64
(
D»suÉ
, 
N»suÉ
);

374 
	`XXH64_»£t
(&
¡©e
, 
£ed
);

375 
	`XXH64_upd©e
(&
¡©e
, 
£Á’û
, 
Ën
);

376 
D»suÉ
 = 
	`XXH64_dige¡
(&
¡©e
);

377 
	`BMK_checkResuÉ64
(
D»suÉ
, 
N»suÉ
);

379 
	`XXH64_»£t
(&
¡©e
, 
£ed
);

380 
pos
=0;…os<
Ën
;…os++è
	`XXH64_upd©e
(&
¡©e
, ((*)
£Á’û
)+pos, 1);

381 
D»suÉ
 = 
	`XXH64_dige¡
(&
¡©e
);

382 
	`BMK_checkResuÉ64
(
D»suÉ
, 
N»suÉ
);

383 
	}
}

386 
	$BMK_‹¡Sequ’û
(cÚ¡ * 
£qu’û
, 
size_t
 
Ën
, 
U32
 
£ed
, U32 
N»suÉ
)

388 
XXH32_¡©e_t
 
¡©e
;

389 
U32
 
D»suÉ
;

390 
size_t
 
pos
;

392 
D»suÉ
 = 
	`XXH32
(
£qu’û
, 
Ën
, 
£ed
);

393 
	`BMK_checkResuÉ
(
D»suÉ
, 
N»suÉ
);

395 
	`XXH32_»£t
(&
¡©e
, 
£ed
);

396 
	`XXH32_upd©e
(&
¡©e
, 
£qu’û
, 
Ën
);

397 
D»suÉ
 = 
	`XXH32_dige¡
(&
¡©e
);

398 
	`BMK_checkResuÉ
(
D»suÉ
, 
N»suÉ
);

400 
	`XXH32_»£t
(&
¡©e
, 
£ed
);

401 
pos
=0;…os<
Ën
;…os++è
	`XXH32_upd©e
(&
¡©e
, ((cÚ¡ *)
£qu’û
)+pos, 1);

402 
D»suÉ
 = 
	`XXH32_dige¡
(&
¡©e
);

403 
	`BMK_checkResuÉ
(
D»suÉ
, 
N»suÉ
);

404 
	}
}

407 
	#SANITY_BUFFER_SIZE
 101

	)

408 
	$BMK_§n™yCheck
()

410 cÚ¡ 
U32
 
´ime
 = 2654435761U;

411 
BYTE
 
§n™yBufãr
[
SANITY_BUFFER_SIZE
];

412 
U32
 
by‹G’
 = 
´ime
;

414 
i
;

415 
i
=0; i<
SANITY_BUFFER_SIZE
; i++) {

416 
§n™yBufãr
[
i
] = (
BYTE
)(
by‹G’
>>24);

417 
by‹G’
 *= byteGen;

420 
	`BMK_‹¡Sequ’û
(
NULL
, 0, 0, 0x02CC5D05);

421 
	`BMK_‹¡Sequ’û
(
NULL
, 0, 
´ime
, 0x36B78AE7);

422 
	`BMK_‹¡Sequ’û
(
§n™yBufãr
, 1, 0, 0xB85CBEE5);

423 
	`BMK_‹¡Sequ’û
(
§n™yBufãr
, 1, 
´ime
, 0xD5845D64);

424 
	`BMK_‹¡Sequ’û
(
§n™yBufãr
, 14, 0, 0xE5AA0AB4);

425 
	`BMK_‹¡Sequ’û
(
§n™yBufãr
, 14, 
´ime
, 0x4481951D);

426 
	`BMK_‹¡Sequ’û
(
§n™yBufãr
, 
SANITY_BUFFER_SIZE
, 0, 0x1F1AA412);

427 
	`BMK_‹¡Sequ’û
(
§n™yBufãr
, 
SANITY_BUFFER_SIZE
, 
´ime
, 0x498EC8E2);

429 
	`BMK_‹¡Sequ’û64
(
NULL
 , 0, 0, 0xEF46DB3751D8E999ULL);

430 
	`BMK_‹¡Sequ’û64
(
NULL
 , 0, 
´ime
, 0xAC75FDA2929B17EFULL);

431 
	`BMK_‹¡Sequ’û64
(
§n™yBufãr
, 1, 0, 0x4FCE394CC88952D8ULL);

432 
	`BMK_‹¡Sequ’û64
(
§n™yBufãr
, 1, 
´ime
, 0x739840CB819FA723ULL);

433 
	`BMK_‹¡Sequ’û64
(
§n™yBufãr
, 14, 0, 0xCFFA8DB881BC3A3DULL);

434 
	`BMK_‹¡Sequ’û64
(
§n™yBufãr
, 14, 
´ime
, 0x5B9611585EFCC9CBULL);

435 
	`BMK_‹¡Sequ’û64
(
§n™yBufãr
, 
SANITY_BUFFER_SIZE
, 0, 0x0EAB543384F878ADULL);

436 
	`BMK_‹¡Sequ’û64
(
§n™yBufãr
, 
SANITY_BUFFER_SIZE
, 
´ime
, 0xCAA65939306F1E21ULL);

438 
	`DISPLAY
("\r%79s\r", "");

439 
	`DISPLAYLEVEL
(2, "Sanity check --‡llests ok\n");

440 
	}
}

447 
	$BMK_di¥Ïy_L™eEndŸn
(cÚ¡ * 
±r
, 
size_t
 
Ëngth
)

449 cÚ¡ 
BYTE
* 
p
 = (cÚ¡ BYTE*)
±r
;

450 
size_t
 
idx
;

451 
idx
=
Ëngth
-1; idx<length; idx--)

452 
	`DISPLAYRESULT
("%02x", 
p
[
idx
]);

453 
	}
}

455 
	$BMK_di¥Ïy_BigEndŸn
(cÚ¡ * 
±r
, 
size_t
 
Ëngth
)

457 cÚ¡ 
BYTE
* 
p
 = (cÚ¡ BYTE*)
±r
;

458 
size_t
 
idx
;

459 
idx
=0; idx<
Ëngth
; idx++)

460 
	`DISPLAYRESULT
("%02x", 
p
[
idx
]);

461 
	}
}

463 
	$BMK_hashSŒ—m
(* 
xxhHashV®ue
, cÚ¡ 
®goTy³
 
hashTy³
, 
FILE
* 
šFe
, * 
bufãr
, 
size_t
 
blockSize
)

465 
XXH64_¡©e_t
 
¡©e64
;

466 
XXH32_¡©e_t
 
¡©e32
;

467 
size_t
 
»adSize
;

470 
	`XXH32_»£t
(&
¡©e32
, 
XXHSUM32_DEFAULT_SEED
);

471 
	`XXH64_»£t
(&
¡©e64
, 
XXHSUM64_DEFAULT_SEED
);

474 
»adSize
 = 1;

475 
»adSize
) {

476 
»adSize
 = 
	`ä—d
(
bufãr
, 1, 
blockSize
, 
šFe
);

477 
hashTy³
)

479 
®go_xxh32
:

480 
	`XXH32_upd©e
(&
¡©e32
, 
bufãr
, 
»adSize
);

482 
®go_xxh64
:

483 
	`XXH64_upd©e
(&
¡©e64
, 
bufãr
, 
»adSize
);

490 
hashTy³
)

492 
®go_xxh32
:

493 { 
U32
 cÚ¡ 
h32
 = 
	`XXH32_dige¡
(&
¡©e32
);

494 
	`memıy
(
xxhHashV®ue
, &
h32
, (h32));

497 
®go_xxh64
:

498 { 
U64
 cÚ¡ 
h64
 = 
	`XXH64_dige¡
(&
¡©e64
);

499 
	`memıy
(
xxhHashV®ue
, &
h64
, (h64));

505 
	}
}

508 ’um { 
	mbig_’dŸn
, 
	ml™e_’dŸn
} 
	t’dŸÃss
;

510 
	$BMK_hash
(cÚ¡ * 
feName
,

511 cÚ¡ 
®goTy³
 
hashTy³
,

512 cÚ¡ 
’dŸÃss
 
di¥ÏyEndŸÃss
)

514 
FILE
* 
šFe
;

515 
size_t
 cÚ¡ 
blockSize
 = 64 
KB
;

516 * 
bufãr
;

517 
U32
 
h32
 = 0;

518 
U64
 
h64
 = 0;

521 ià(
feName
 =ğ
¡dšName
) {

522 
šFe
 = 
¡dš
;

523 
	`SET_BINARY_MODE
(
¡dš
);

526 
šFe
 = 
	`fİ’
Ğ
feName
, "rb" );

527 ià(
šFe
==
NULL
) {

528 
	`DISPLAY
Ğ"Pb o³nšg %s\n", 
feName
);

533 
bufãr
 = 
	`m®loc
(
blockSize
);

534 if(!
bufãr
) {

535 
	`DISPLAY
("\nError:‚otƒnough memory!\n");

536 
	`fşo£
(
šFe
);

541 { cÚ¡ 
size_t
 
feNameSize
 = 
	`¡¾’
(
feName
);

542 cÚ¡ * cÚ¡ 
feNameEnd
 = 
feName
 + 
feNameSize
;

543 cÚ¡ 
size_t
 
maxInfoF’ameSize
 = 
feNameSize
 > 30 ? 30 : fileNameSize;

544 
size_t
 
šfoF’ameSize
 = 1;

545  (
šfoF’ameSize
 < 
maxInfoF’ameSize
)

546 &&(
feNameEnd
[-1-
šfoF’ameSize
] != '/')

547 &&(
feNameEnd
[-1-
šfoF’ameSize
] != '\\') )

548 
šfoF’ameSize
++;

549 
	`DISPLAY
("\rLßdšg %s... \r", 
feNameEnd
 - 
šfoF’ameSize
);

552 
hashTy³
)

554 
®go_xxh32
:

555 
	`BMK_hashSŒ—m
(&
h32
, 
®go_xxh32
, 
šFe
, 
bufãr
, 
blockSize
);

557 
®go_xxh64
:

558 
	`BMK_hashSŒ—m
(&
h64
, 
®go_xxh64
, 
šFe
, 
bufãr
, 
blockSize
);

564 
	`fşo£
(
šFe
);

565 
	`ä“
(
bufãr
);

566 
	`DISPLAY
("%  \r", 
feNameEnd
 - 
šfoF’ameSize
);

570 
hashTy³
)

572 
®go_xxh32
:

573 { 
XXH32_ÿnÚiÿl_t
 
hcbe32
;

574 
	`XXH32_ÿnÚiÿlFromHash
(&
hcbe32
, 
h32
);

575 
di¥ÏyEndŸÃss
==
big_’dŸn
 ?

576 
	`BMK_di¥Ïy_BigEndŸn
(&
hcbe32
, (hcbe32)è: 
	`BMK_di¥Ïy_L™eEndŸn
(&hcbe32, (hcbe32));

577 
	`DISPLAYRESULT
(" %s\n", 
feName
);

580 
®go_xxh64
:

581 { 
XXH64_ÿnÚiÿl_t
 
hcbe64
;

582 
	`XXH64_ÿnÚiÿlFromHash
(&
hcbe64
, 
h64
);

583 
di¥ÏyEndŸÃss
==
big_’dŸn
 ?

584 
	`BMK_di¥Ïy_BigEndŸn
(&
hcbe64
, (hcbe64)è: 
	`BMK_di¥Ïy_L™eEndŸn
(&hcbe64, (hcbe64));

585 
	`DISPLAYRESULT
(" %s\n", 
feName
);

593 
	}
}

596 
	$BMK_hashFes
(cÚ¡ ** 
âLi¡
, 
âTÙ®
,

597 
®goTy³
 
hashTy³
, 
’dŸÃss
 
di¥ÏyEndŸÃss
)

599 
âNb
;

600 
»suÉ
 = 0;

602 ià(
âTÙ®
==0)

603  
	`BMK_hash
(
¡dšName
, 
hashTy³
, 
di¥ÏyEndŸÃss
);

605 
âNb
=0; fnNb<
âTÙ®
; fnNb++)

606 
»suÉ
 +ğ
	`BMK_hash
(
âLi¡
[
âNb
], 
hashTy³
, 
di¥ÏyEndŸÃss
);

607 
	`DISPLAY
("\r%70s\r", "");

608  
»suÉ
;

609 
	}
}

613 
	mG‘Lše_ok
,

614 
	mG‘Lše_eof
,

615 
	mG‘Lše_exûedMaxLšeL’gth
,

616 
	mG‘Lše_outOfMemÜy
,

617 } 
	tG‘LšeResuÉ
;

620 
	mCªÚiÿlFromSŒšg_ok
,

621 
	mCªÚiÿlFromSŒšg_šv®idFÜm©
,

622 } 
	tCªÚiÿlFromSŒšgResuÉ
;

625 
	mP¬£Lše_ok
,

626 
	mP¬£Lše_šv®idFÜm©
,

627 } 
	tP¬£LšeResuÉ
;

630 
	mLšeStus_hashOk
,

631 
	mLšeStus_hashFaed
,

632 
	mLšeStus_çedToO³n
,

633 } 
	tLšeStus
;

636 
XXH32_ÿnÚiÿl_t
 
	mxxh32
;

637 
XXH64_ÿnÚiÿl_t
 
	mxxh64
;

638 } 
	tCªÚiÿl
;

641 
CªÚiÿl
 
	mÿnÚiÿl
;

642 cÚ¡ * 
	mf’ame
;

643 
	mxxhB™s
;

644 } 
	tP¬£dLše
;

647 
	mnPrİ”lyFÜm©‹dLšes
;

648 
	mnIm´İ”lyFÜm©‹dLšes
;

649 
	mnMism©chedChecksums
;

650 
	mnO³nOrR—dFau»s
;

651 
	mnMixedFÜm©Lšes
;

652 
	mxxhB™s
;

653 
	mqu™
;

654 } 
	tP¬£FeR•Üt
;

657 cÚ¡ * 
	mšFeName
;

658 
FILE
* 
	mšFe
;

659 
	mlšeMax
;

660 * 
	mlšeBuf
;

661 
size_t
 
	mblockSize
;

662 * 
	mblockBuf
;

663 
	m¡riùMode
;

664 
	m¡©usOÆy
;

665 
	mw¬n
;

666 
	mqu›t
;

667 
P¬£FeR•Üt
 
	m»pÜt
;

668 } 
	tP¬£FeArg
;

677 
G‘LšeResuÉ
 
	$g‘Lše
(** 
lšeBuf
, * 
lšeMax
, 
FILE
* 
šFe
)

679 
G‘LšeResuÉ
 
»suÉ
 = 
G‘Lše_ok
;

680 
Ën
 = 0;

682 ià((*
lšeBuf
 =ğ
NULL
è|| (*
lšeMax
<1)) {

683 
	`ä“
(*
lšeBuf
);

684 *
lšeMax
 = 0;

685 *
lšeBuf
 = (*)
	`m®loc
(
DEFAULT_LINE_LENGTH
);

686 if(*
lšeBuf
 =ğ
NULL
è 
G‘Lše_outOfMemÜy
;

687 *
lšeMax
 = 
DEFAULT_LINE_LENGTH
;

691 cÚ¡ 
c
 = 
	`fg‘c
(
šFe
);

692 ià(
c
 =ğ
EOF
) {

696 ià(
Ën
 =ğ0è
»suÉ
 = 
G‘Lše_eof
;

701 ià(
Ën
+1 >ğ*
lšeMax
) {

702 * 
ÃwLšeBuf
 = 
NULL
;

703 
ÃwBufSize
 = *
lšeMax
;

705 
ÃwBufSize
 += (newBufSize/2) + 1;

706 ià(
ÃwBufSize
 > 
MAX_LINE_LENGTH
)‚ewBufSize = MAX_LINE_LENGTH;

707 ià(
Ën
+1 >ğ
ÃwBufSize
è 
G‘Lše_exûedMaxLšeL’gth
;

709 
ÃwLšeBuf
 = (*è
	`»®loc
(*
lšeBuf
, 
ÃwBufSize
);

710 ià(
ÃwLšeBuf
 =ğ
NULL
è 
G‘Lše_outOfMemÜy
;

712 *
lšeBuf
 = 
ÃwLšeBuf
;

713 *
lšeMax
 = 
ÃwBufSize
;

716 ià(
c
 == '\n') ;

717 (*
lšeBuf
)[
Ën
++] = (è
c
;

720 (*
lšeBuf
)[
Ën
] = '\0';

721  
»suÉ
;

722 
	}
}

728 
	$ch¬ToHex
(
c
)

730 
»suÉ
 = -1;

731 ià(
c
 >= '0' && c <= '9') {

732 
»suÉ
 = (è(
c
 - '0');

733 } ià(
c
 >= 'A' && c <= 'F') {

734 
»suÉ
 = (è(
c
 - 'A') + 0x0a;

735 } ià(
c
 >= 'a' && c <= 'f') {

736 
»suÉ
 = (è(
c
 - 'a') + 0x0a;

738  
»suÉ
;

739 
	}
}

746 
CªÚiÿlFromSŒšgResuÉ
 
	$ÿnÚiÿlFromSŒšg
(* 
d¡
,

747 
size_t
 
d¡Size
,

748 cÚ¡ * 
hashSŒ
)

750 
size_t
 
i
;

751 
i
 = 0; i < 
d¡Size
; ++i) {

752 
h0
, 
h1
;

754 
h0
 = 
	`ch¬ToHex
(
hashSŒ
[
i
*2 + 0]);

755 ià(
h0
 < 0è 
CªÚiÿlFromSŒšg_šv®idFÜm©
;

757 
h1
 = 
	`ch¬ToHex
(
hashSŒ
[
i
*2 + 1]);

758 ià(
h1
 < 0è 
CªÚiÿlFromSŒšg_šv®idFÜm©
;

760 
d¡
[
i
] = (è((
h0
 << 4è| 
h1
);

762  
CªÚiÿlFromSŒšg_ok
;

763 
	}
}

779 
P¬£LšeResuÉ
 
	$·r£Lše
(
P¬£dLše
* 
·r£dLše
, cÚ¡ * 
lše
)

781 cÚ¡ * cÚ¡ 
fœ¡S·û
 = 
	`¡rchr
(
lše
, ' ');

782 cÚ¡ * cÚ¡ 
£cÚdS·û
 = 
fœ¡S·û
 + 1;

784 
·r£dLše
->
f’ame
 = 
NULL
;

785 
·r£dLše
->
xxhB™s
 = 0;

787 ià(
fœ¡S·û
 =ğ
NULL
 || *
£cÚdS·û
 !ğ' 'è 
P¬£Lše_šv®idFÜm©
;

789 
fœ¡S·û
 - 
lše
)

792 { 
XXH32_ÿnÚiÿl_t
* 
xxh32c
 = &
·r£dLše
->
ÿnÚiÿl
.
xxh32
;

793 ià(
	`ÿnÚiÿlFromSŒšg
(
xxh32c
->
dige¡
, (xxh32c->dige¡), 
lše
)

794 !ğ
CªÚiÿlFromSŒšg_ok
) {

795  
P¬£Lše_šv®idFÜm©
;

797 
·r£dLše
->
xxhB™s
 = 32;

802 { 
XXH64_ÿnÚiÿl_t
* 
xxh64c
 = &
·r£dLše
->
ÿnÚiÿl
.
xxh64
;

803 ià(
	`ÿnÚiÿlFromSŒšg
(
xxh64c
->
dige¡
, (xxh64c->dige¡), 
lše
)

804 !ğ
CªÚiÿlFromSŒšg_ok
) {

805  
P¬£Lše_šv®idFÜm©
;

807 
·r£dLše
->
xxhB™s
 = 64;

812  
P¬£Lše_šv®idFÜm©
;

816 
·r£dLše
->
f’ame
 = 
£cÚdS·û
 + 1;

817  
P¬£Lše_ok
;

818 
	}
}

823 
	$·r£Fe1
(
P¬£FeArg
* 
·r£FeArg
)

825 cÚ¡ * cÚ¡ 
šFeName
 = 
·r£FeArg
->inFileName;

826 
P¬£FeR•Üt
* cÚ¡ 
»pÜt
 = &
·r£FeArg
->report;

828 
lšeNumb”
 = 0;

829 
	`mem£t
(
»pÜt
, 0, (*report));

831 !
»pÜt
->
qu™
) {

832 
FILE
* 
å
 = 
NULL
;

833 
LšeStus
 
lšeStus
 = 
LšeStus_hashFaed
;

834 
G‘LšeResuÉ
 
g‘LšeResuÉ
;

835 
P¬£dLše
 
·r£dLše
;

836 
	`mem£t
(&
·r£dLše
, 0, (parsedLine));

838 
lšeNumb”
++;

839 ià(
lšeNumb”
 == 0) {

842 
	`DISPLAY
("% :oØmªy checksum†šes\n", 
šFeName
);

843 
»pÜt
->
qu™
 = 1;

847 
g‘LšeResuÉ
 = 
	`g‘Lše
(&
·r£FeArg
->
lšeBuf
, &·r£FeArg->
lšeMax
,

848 
·r£FeArg
->
šFe
);

849 ià(
g‘LšeResuÉ
 !ğ
G‘Lše_ok
) {

850 ià(
g‘LšeResuÉ
 =ğ
G‘Lše_eof
) ;

852 
g‘LšeResuÉ
)

854 
G‘Lše_ok
:

855 
G‘Lše_eof
:

861 
	`DISPLAY
("% : %lu: unknowÀ”rÜ\n", 
šFeName
, 
lšeNumb”
);

864 
G‘Lše_exûedMaxLšeL’gth
:

865 
	`DISPLAY
("% : %lu:oØlÚg†še\n", 
šFeName
, 
lšeNumb”
);

868 
G‘Lše_outOfMemÜy
:

869 
	`DISPLAY
("% : %lu: ouˆoàmemÜy\n", 
šFeName
, 
lšeNumb”
);

872 
»pÜt
->
qu™
 = 1;

876 ià(
	`·r£Lše
(&
·r£dLše
, 
·r£FeArg
->
lšeBuf
è!ğ
P¬£Lše_ok
) {

877 
»pÜt
->
nIm´İ”lyFÜm©‹dLšes
++;

878 ià(
·r£FeArg
->
w¬n
) {

879 
	`DISPLAY
("%s : %lu: improperly formatted XXHASH checksum†ine\n"

880 , 
šFeName
, 
lšeNumb”
);

885 ià(
»pÜt
->
xxhB™s
 !ğ0 &&„•Üt->xxhB™ !ğ
·r£dLše
.xxhBits) {

887 
»pÜt
->
nIm´İ”lyFÜm©‹dLšes
++;

888 
»pÜt
->
nMixedFÜm©Lšes
++;

889 ià(
·r£FeArg
->
w¬n
) {

890 
	`DISPLAY
("%s : %lu: improperly formatted XXHASH checksum†ine (XXH32/64)\n"

891 , 
šFeName
, 
lšeNumb”
);

896 
»pÜt
->
nPrİ”lyFÜm©‹dLšes
++;

897 ià(
»pÜt
->
xxhB™s
 == 0) {

898 
»pÜt
->
xxhB™s
 = 
·r£dLše
.xxhBits;

901 
å
 = 
	`fİ’
(
·r£dLše
.
f’ame
, "rb");

902 ià(
å
 =ğ
NULL
) {

903 
lšeStus
 = 
LšeStus_çedToO³n
;

905 
lšeStus
 = 
LšeStus_hashFaed
;

906 
·r£dLše
.
xxhB™s
)

909 { 
XXH32_hash_t
 
xxh
;

910 
	`BMK_hashSŒ—m
(&
xxh
, 
®go_xxh32
, 
å
, 
·r£FeArg
->
blockBuf
,…¬£FeArg->
blockSize
);

911 ià(
xxh
 =ğ
	`XXH32_hashFromCªÚiÿl
(&
·r£dLše
.
ÿnÚiÿl
.
xxh32
)) {

912 
lšeStus
 = 
LšeStus_hashOk
;

917 { 
XXH64_hash_t
 
xxh
;

918 
	`BMK_hashSŒ—m
(&
xxh
, 
®go_xxh64
, 
å
, 
·r£FeArg
->
blockBuf
,…¬£FeArg->
blockSize
);

919 ià(
xxh
 =ğ
	`XXH64_hashFromCªÚiÿl
(&
·r£dLše
.
ÿnÚiÿl
.
xxh64
)) {

920 
lšeStus
 = 
LšeStus_hashOk
;

927 
	`fşo£
(
å
);

930 
lšeStus
)

933 
	`DISPLAY
("% : unknowÀ”rÜ\n", 
šFeName
);

934 
»pÜt
->
qu™
 = 1;

937 
LšeStus_çedToO³n
:

938 
»pÜt
->
nO³nOrR—dFau»s
++;

939 ià(!
·r£FeArg
->
¡©usOÆy
) {

940 
	`DISPLAYRESULT
("%s : %lu: FAILED open or„ead %s\n"

941 , 
šFeName
, 
lšeNumb”
, 
·r£dLše
.
f’ame
);

945 
LšeStus_hashOk
:

946 
LšeStus_hashFaed
:

947 { 
b
 = 1;

948 ià(
lšeStus
 =ğ
LšeStus_hashOk
) {

950 ià(
·r£FeArg
->
qu›t
è
b
 = 0;

952 
»pÜt
->
nMism©chedChecksums
++;

955 ià(
b
 && !
·r£FeArg
->
¡©usOÆy
) {

956 
	`DISPLAYRESULT
("%s: %s\n", 
·r£dLše
.
f’ame


957 , 
lšeStus
 =ğ
LšeStus_hashOk
 ? "OK" : "FAILED");

962 
	}
}

981 
	$checkFe
(cÚ¡ * 
šFeName
,

982 cÚ¡ 
’dŸÃss
 
di¥ÏyEndŸÃss
,

983 
U32
 
¡riùMode
,

984 
U32
 
¡©usOÆy
,

985 
U32
 
w¬n
,

986 
U32
 
qu›t
)

988 
»suÉ
 = 0;

989 
FILE
* 
šFe
 = 
NULL
;

990 
P¬£FeArg
 
·r£FeArgBody
;

991 
P¬£FeArg
* cÚ¡ 
·r£FeArg
 = &
·r£FeArgBody
;

992 
P¬£FeR•Üt
* cÚ¡ 
»pÜt
 = &
·r£FeArg
->report;

994 ià(
di¥ÏyEndŸÃss
 !ğ
big_’dŸn
) {

996 
	`DISPLAY
( "Check file mode doesn't support†ittleƒndian\n" );

1001 ià(
šFeName
 =ğ
¡dšName
) {

1004 
šFe
 = 
¡dš
;

1006 
šFe
 = 
	`fİ’
Ğ
šFeName
, "rt" );

1009 ià(
šFe
 =ğ
NULL
) {

1010 
	`DISPLAY
Ğ"Pb o³nšg %s\n", 
šFeName
);

1014 
·r£FeArg
->
šFeName
 = inFileName;

1015 
·r£FeArg
->
šFe
 = inFile;

1016 
·r£FeArg
->
lšeMax
 = 
DEFAULT_LINE_LENGTH
;

1017 
·r£FeArg
->
lšeBuf
 = (*è
	`m®loc
((
size_t
è·r£FeArg->
lšeMax
);

1018 
·r£FeArg
->
blockSize
 = 64 * 1024;

1019 
·r£FeArg
->
blockBuf
 = (*è
	`m®loc
Õ¬£FeArg->
blockSize
);

1020 
·r£FeArg
->
¡riùMode
 = strictMode;

1021 
·r£FeArg
->
¡©usOÆy
 = statusOnly;

1022 
·r£FeArg
->
w¬n
 = warn;

1023 
·r£FeArg
->
qu›t
 = quiet;

1025 
	`·r£Fe1
(
·r£FeArg
);

1027 
	`ä“
(
·r£FeArg
->
blockBuf
);

1028 
	`ä“
(
·r£FeArg
->
lšeBuf
);

1030 ià(
šFe
 !ğ
¡dš
è
	`fşo£
(inFile);

1034 ià(
»pÜt
->
nPrİ”lyFÜm©‹dLšes
 == 0) {

1035 
	`DISPLAY
("%s:‚Ø´İ”ly fÜm©‹d XXHASH checksum†še found\n", 
šFeName
);

1036 } ià(!
¡©usOÆy
) {

1037 ià(
»pÜt
->
nIm´İ”lyFÜm©‹dLšes
) {

1038 
	`DISPLAYRESULT
("%lu†ines‡re improperly formatted\n"

1039 , 
»pÜt
->
nIm´İ”lyFÜm©‹dLšes
);

1041 ià(
»pÜt
->
nO³nOrR—dFau»s
) {

1042 
	`DISPLAYRESULT
("%lu†isted files could‚ot be„ead\n"

1043 , 
»pÜt
->
nO³nOrR—dFau»s
);

1045 ià(
»pÜt
->
nMism©chedChecksums
) {

1046 
	`DISPLAYRESULT
("%lu computed checksums did NOT match\n"

1047 , 
»pÜt
->
nMism©chedChecksums
);

1052 
»suÉ
 = 
»pÜt
->
nPrİ”lyFÜm©‹dLšes
 != 0

1053 && 
»pÜt
->
nMism©chedChecksums
 == 0

1054 && 
»pÜt
->
nO³nOrR—dFau»s
 == 0

1055 && (!
¡riùMode
 || 
»pÜt
->
nIm´İ”lyFÜm©‹dLšes
 == 0)

1056 && 
»pÜt
->
qu™
 == 0;

1057  
»suÉ
;

1058 
	}
}

1061 
	$checkFes
(cÚ¡ ** 
âLi¡
, 
âTÙ®
,

1062 cÚ¡ 
’dŸÃss
 
di¥ÏyEndŸÃss
,

1063 
U32
 
¡riùMode
,

1064 
U32
 
¡©usOÆy
,

1065 
U32
 
w¬n
,

1066 
U32
 
qu›t
)

1068 
ok
 = 1;

1072 ià(
âTÙ®
==0) {

1073 
ok
 &ğ
	`checkFe
(
¡dšName
, 
di¥ÏyEndŸÃss
, 
¡riùMode
, 
¡©usOÆy
, 
w¬n
, 
qu›t
);

1075 
âNb
;

1076 
âNb
=0; fnNb<
âTÙ®
; fnNb++)

1077 
ok
 &ğ
	`checkFe
(
âLi¡
[
âNb
], 
di¥ÏyEndŸÃss
, 
¡riùMode
, 
¡©usOÆy
, 
w¬n
, 
qu›t
);

1079  
ok
 ? 0 : 1;

1080 
	}
}

1087 
	$u§ge
(cÚ¡ * 
ex’ame
)

1089 
	`DISPLAY
Ğ
	`WELCOME_MESSAGE
(
ex’ame
) );

1090 
	`DISPLAY
( "Usage :\n");

1091 
	`DISPLAY
Ğ" % [¬g] [f’ames]\n", 
ex’ame
);

1092 
	`DISPLAY
( "When‚o filename…rovided, or -…rovided : use stdin‡s input\n");

1093 
	`DISPLAY
( "Arguments :\n");

1094 
	`DISPLAY
Ğ" -H# : hash s–eùiÚ : 0=32b™s, 1=64b™ (deçuÉ: %i)\n", ()
g_deçuÉAlgo
);

1095 
	`DISPLAY
( " -c :„ead xxHash sums fromhe [filenames]‡nd checkhem\n");

1096 
	`DISPLAY
( " -h : help \n");

1098 
	}
}

1101 
	$u§ge_advªûd
(cÚ¡ * 
ex’ame
)

1103 
	`u§ge
(
ex’ame
);

1104 
	`DISPLAY
( "Advanced :\n");

1105 
	`DISPLAY
( " --little-endian : hash…rinted using†ittleƒndian convention (default: bigƒndian)\n");

1106 
	`DISPLAY
( " -V, --version : display version\n");

1107 
	`DISPLAY
( " -h, --help : display†ong help‡ndƒxit\n");

1108 
	`DISPLAY
( " -b : benchmark mode \n");

1109 
	`DISPLAY
Ğ" -i# :‚umb” oà™”©iÚ (b’chm¬k mode; deçuÉ %i)\n", 
g_nbI‹¿tiÚs
);

1110 
	`DISPLAY
( "\n");

1111 
	`DISPLAY
( "The following four options‡re useful only when verifying checksums (-c):\n");

1112 
	`DISPLAY
( "--strict : don't…rint OK forƒach successfully verified file\n");

1113 
	`DISPLAY
( "--status : don't output‡nything, status code shows success\n");

1114 
	`DISPLAY
( "--quiet :ƒxit‚on-zero for improperly formatted checksum†ines\n");

1115 
	`DISPLAY
( "--warn : warn‡bout improperly formatted checksum†ines\n");

1117 
	}
}

1119 
	$badu§ge
(cÚ¡ * 
ex’ame
)

1121 
	`DISPLAY
("Wrong…arameters\n");

1122 
	`u§ge
(
ex’ame
);

1124 
	}
}

1127 
	$maš
(
¬gc
, cÚ¡ ** 
¬gv
)

1129 
i
, 
f’amesS¹
=0;

1130 cÚ¡ * cÚ¡ 
ex’ame
 = 
¬gv
[0];

1131 
U32
 
b’chm¬kMode
 = 0;

1132 
U32
 
feCheckMode
 = 0;

1133 
U32
 
¡riùMode
 = 0;

1134 
U32
 
¡©usOÆy
 = 0;

1135 
U32
 
w¬n
 = 0;

1136 
U32
 
qu›t
 = 0;

1137 
®goTy³
 
®go
 = 
g_deçuÉAlgo
;

1138 
’dŸÃss
 
di¥ÏyEndŸÃss
 = 
big_’dŸn
;

1141 ià(
	`¡r¡r
(
ex’ame
, "xxh32sum"è!ğ
NULL
è
®go
 = 
®go_xxh32
;

1143 
i
=1; i<
¬gc
; i++) {

1144 cÚ¡ * 
¬gum’t
 = 
¬gv
[
i
];

1146 if(!
¬gum’t
) ;

1148 ià(!
	`¡rcmp
(
¬gum’t
, "--l™e-’dŸn")è{ 
di¥ÏyEndŸÃss
 = 
l™e_’dŸn
; ; }

1149 ià(!
	`¡rcmp
(
¬gum’t
, "--check")è{ 
feCheckMode
 = 1; ; }

1150 ià(!
	`¡rcmp
(
¬gum’t
, "--¡riù")è{ 
¡riùMode
 = 1; ; }

1151 ià(!
	`¡rcmp
(
¬gum’t
, "--¡©us")è{ 
¡©usOÆy
 = 1; ; }

1152 ià(!
	`¡rcmp
(
¬gum’t
, "--qu›t")è{ 
qu›t
 = 1; ; }

1153 ià(!
	`¡rcmp
(
¬gum’t
, "--w¬n")è{ 
w¬n
 = 1; ; }

1154 ià(!
	`¡rcmp
(
¬gum’t
, "--h–p")è{  
	`u§ge_advªûd
(
ex’ame
); }

1155 ià(!
	`¡rcmp
(
¬gum’t
, "--v”siÚ")è{ 
	`DISPLAY
(
	`WELCOME_MESSAGE
(
ex’ame
));  0; }

1157 ià(*
¬gum’t
!='-') {

1158 ià(
f’amesS¹
==0èf’amesS¹=
i
;

1163 
¬gum’t
++;

1165 *
¬gum’t
!=0) {

1166 *
¬gum’t
)

1170 
	`DISPLAY
(
	`WELCOME_MESSAGE
(
ex’ame
));  0;

1174  
	`u§ge_advªûd
(
ex’ame
);

1178 
®go
 = (
®goTy³
)(
¬gum’t
[1] - '0');

1179 
¬gum’t
+=2;

1184 
feCheckMode
=1;

1185 
¬gum’t
++;

1190 
w¬n
=1;

1191 
¬gum’t
++;

1196 
¬gum’t
++;

1197 
b’chm¬kMode
=1;

1202 
g_nbI‹¿tiÚs
 = 
¬gum’t
[1] - '0';

1203 
¬gum’t
+=2;

1208 
¬gum’t
++;

1209 
g_§m¶eSize
 = 0;

1210 
¬gum’t
[0]>='0' &&‡rgument[0]<='9')

1211 
g_§m¶eSize
 *ğ10, g_§m¶eSiz+ğ
¬gum’t
[0]-'0',‡rgument++;

1215  
	`badu§ge
(
ex’ame
);

1221 ià(
b’chm¬kMode
) {

1222 
	`DISPLAY
Ğ
	`WELCOME_MESSAGE
(
ex’ame
) );

1223 
	`BMK_§n™yCheck
();

1224 ià(
f’amesS¹
==0è 
	`BMK_b’chIÁ”Çl
();

1225  
	`BMK_b’chFes
(
¬gv
+
f’amesS¹
, 
¬gc
-filenamesStart);

1229 iàĞ(
f’amesS¹
==0è&& 
	`IS_CONSOLE
(
¡dš
èè 
	`badu§ge
(
ex’ame
);

1231 ià(
f’amesS¹
==0èf’amesS¹ = 
¬gc
;

1232 ià(
feCheckMode
) {

1233  
	`checkFes
(
¬gv
+
f’amesS¹
, 
¬gc
-f’amesS¹, 
di¥ÏyEndŸÃss
, 
¡riùMode
, 
¡©usOÆy
, 
w¬n
, 
qu›t
);

1235  
	`BMK_hashFes
(
¬gv
+
f’amesS¹
, 
¬gc
-f’amesS¹, 
®go
, 
di¥ÏyEndŸÃss
);

1237 
	}
}

	@/usr/include/arpa/inet.h

18 #iâdeà
_ARPA_INET_H


19 
	#_ARPA_INET_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<Ãtš‘/š.h
>

25 #iâdeà
__sockËn_t_defšed


26 
__sockËn_t
 
	tsockËn_t
;

27 
	#__sockËn_t_defšed


	)

30 
__BEGIN_DECLS


34 
š_addr_t
 
	$š‘_addr
 (cÚ¡ *
__ı
è
__THROW
;

37 
š_addr_t
 
	$š‘_Êaof
 (
š_addr
 
__š
è
__THROW
;

41 
š_addr
 
	$š‘_mak—ddr
 (
š_addr_t
 
__Ãt
, in_addr_ˆ
__ho¡
)

42 
__THROW
;

45 
š_addr_t
 
	$š‘_Ãtof
 (
š_addr
 
__š
è
__THROW
;

49 
š_addr_t
 
	$š‘_ÃtwÜk
 (cÚ¡ *
__ı
è
__THROW
;

53 *
	$š‘_Áß
 (
š_addr
 
__š
è
__THROW
;

58 
	$š‘_±Ú
 (
__af
, cÚ¡ *
__»¡riù
 
__ı
,

59 *
__»¡riù
 
__buf
è
__THROW
;

64 cÚ¡ *
	$š‘_Áİ
 (
__af
, cÚ¡ *
__»¡riù
 
__ı
,

65 *
__»¡riù
 
__buf
, 
sockËn_t
 
__Ën
)

66 
__THROW
;

70 #ifdeà
__USE_MISC


73 
	$š‘_©Ú
 (cÚ¡ *
__ı
, 
š_addr
 *
__šp
è
__THROW
;

77 *
	$š‘_Ã
 (
š_addr_t
 
__Ãt
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

82 *
	$š‘_Ãt_Áİ
 (
__af
, cÚ¡ *
__ı
, 
__b™s
,

83 *
__buf
, 
size_t
 
__Ën
è
__THROW
;

88 
	$š‘_Ãt_±Ú
 (
__af
, cÚ¡ *
__ı
,

89 *
__buf
, 
size_t
 
__Ën
è
__THROW
;

94 
	$š‘_n§p_addr
 (cÚ¡ *
__ı
,

95 *
__buf
, 
__Ën
è
__THROW
;

99 *
	$š‘_n§p_Áß
 (
__Ën
, cÚ¡ *
__ı
,

100 *
__buf
è
__THROW
;

103 
__END_DECLS


	@/usr/include/asm-generic/mman.h

2 #iâdeà
__ASM_GENERIC_MMAN_H


3 
	#__ASM_GENERIC_MMAN_H


	)

5 
	~<asm-g’”ic/mmª-commÚ.h
>

7 
	#MAP_GROWSDOWN
 0x0100

	)

8 
	#MAP_DENYWRITE
 0x0800

	)

9 
	#MAP_EXECUTABLE
 0x1000

	)

10 
	#MAP_LOCKED
 0x2000

	)

11 
	#MAP_NORESERVE
 0x4000

	)

12 
	#MAP_POPULATE
 0x8000

	)

13 
	#MAP_NONBLOCK
 0x10000

	)

14 
	#MAP_STACK
 0x20000

	)

15 
	#MAP_HUGETLB
 0x40000

	)

16 
	#MAP_SYNC
 0x80000

	)

20 
	#MCL_CURRENT
 1

	)

21 
	#MCL_FUTURE
 2

	)

22 
	#MCL_ONFAULT
 4

	)

	@/usr/include/assert.h

22 #ifdef 
_ASSERT_H


24 #undeà
_ASSERT_H


25 #undeà
as£¹


26 #undeà
__ASSERT_VOID_CAST


28 #ifdef 
__USE_GNU


29 #undeà
as£¹_³¼Ü


34 
	#_ASSERT_H
 1

	)

35 
	~<ã©u»s.h
>

37 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,95)

38 
	#__ASSERT_VOID_CAST
 
¡©ic_ÿ¡
<>

	)

40 
	#__ASSERT_VOID_CAST
 ()

	)

48 #ifdef 
NDEBUG


50 
	#as£¹
(
ex´
è(
	`__ASSERT_VOID_CAST
 (0))

	)

58 #ifdef 
__USE_GNU


59 
	#as£¹_³¼Ü
(
”ºum
è(
	`__ASSERT_VOID_CAST
 (0))

	)

64 #iâdeà
_ASSERT_H_DECLS


65 
	#_ASSERT_H_DECLS


	)

66 
__BEGIN_DECLS


69 
	$__as£¹_ç
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
,

70 
__lše
, cÚ¡ *
__funùiÚ
)

71 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

74 
	$__as£¹_³¼Ü_ç
 (
__”ºum
, cÚ¡ *
__fe
,

75 
__lše
, cÚ¡ *
__funùiÚ
)

76 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

81 
	$__as£¹
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
, 
__lše
)

82 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

85 
__END_DECLS


91 #ià
defšed
 
__ılu¥lus


92 
	#as£¹
(
ex´
) \

93 (
¡©ic_ÿ¡
 <
boŞ
> (
ex´
) \

95 : 
	`__as£¹_ç
 (#ex´, 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

96 #–ià!
defšed
 
__GNUC__
 || defšed 
__STRICT_ANSI__


97 
	#as£¹
(
ex´
) \

98 ((
ex´
) \

99 ? 
	`__ASSERT_VOID_CAST
 (0) \

100 : 
	`__as£¹_ç
 (#ex´, 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

107 
	#as£¹
(
ex´
) \

108 ((è ((
ex´
è? 1 : 0), 
	`__ex‹nsiÚ__
 ({ \

109 ià(
ex´
) \

112 
	`__as£¹_ç
 (#ex´, 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
); \

113 
	}
}))

	)

116 #ifdef 
__USE_GNU


117 
	#as£¹_³¼Ü
(
”ºum
) \

118 (!(
”ºum
) \

119 ? 
	`__ASSERT_VOID_CAST
 (0) \

120 : 
	`__as£¹_³¼Ü_ç
 ((
”ºum
), 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

128 #ià
defšed
 
__ılu¥lus
 ? 
__GNUC_PREREQ
 (2, 6) : __GNUC_PREREQ (2, 4)

129 
	#__ASSERT_FUNCTION
 
__ex‹nsiÚ__
 
__PRETTY_FUNCTION__


	)

131 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

132 
	#__ASSERT_FUNCTION
 
__func__


	)

134 
	#__ASSERT_FUNCTION
 ((cÚ¡ *è0)

	)

141 #ià
defšed
 
__USE_ISOC11
 && !defšed 
__ılu¥lus


142 #undeà
¡©ic_as£¹


143 
	#¡©ic_as£¹
 
_Stic_as£¹


	)

	@/usr/include/byteswap.h

18 #iâdeà
_BYTESWAP_H


19 
	#_BYTESWAP_H
 1

	)

21 
	~<ã©u»s.h
>

24 
	~<b™s/by‹sw­.h
>

31 
	#bsw­_16
(
x
è
	`__bsw­_16
 (x)

	)

34 
	#bsw­_32
(
x
è
	`__bsw­_32
 (x)

	)

37 
	#bsw­_64
(
x
è
	`__bsw­_64
 (x)

	)

	@/usr/include/ctype.h

22 #iâdef 
_CTYPE_H


23 
	#_CTYPE_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 
	g__BEGIN_DECLS


30 #iâdeà
_ISb™


39 
	~<’dŸn.h
>

40 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


41 
	#_ISb™
(
b™
è(1 << (b™))

	)

43 
	#_ISb™
(
b™
è((b™è< 8 ? ((1 << (b™)è<< 8è: ((1 << (b™)è>> 8))

	)

48 
	m_ISuµ”
 = 
_ISb™
 (0),

49 
	m_ISlow”
 = 
_ISb™
 (1),

50 
	m_IS®pha
 = 
_ISb™
 (2),

51 
	m_ISdig™
 = 
_ISb™
 (3),

52 
	m_ISxdig™
 = 
_ISb™
 (4),

53 
	m_IS¥aû
 = 
_ISb™
 (5),

54 
	m_IS´št
 = 
_ISb™
 (6),

55 
	m_ISg¿ph
 = 
_ISb™
 (7),

56 
	m_ISbÏnk
 = 
_ISb™
 (8),

57 
	m_ISúŒl
 = 
_ISb™
 (9),

58 
	m_ISpunù
 = 
_ISb™
 (10),

59 
	m_IS®num
 = 
_ISb™
 (11)

79 cÚ¡ **
	$__ùy³_b_loc
 ()

80 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

81 cÚ¡ 
__št32_t
 **
	$__ùy³_tŞow”_loc
 ()

82 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

83 cÚ¡ 
__št32_t
 **
	$__ùy³_touµ”_loc
 ()

84 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

87 #iâdeà
__ılu¥lus


88 
	#__isùy³
(
c
, 
ty³
) \

89 ((*
	`__ùy³_b_loc
 ())[(è(
c
)] & (è
ty³
)

	)

90 #–ià
defšed
 
__USE_EXTERN_INLINES


91 
	#__isùy³_f
(
ty³
) \

92 
__ex‹º_šlše
 \

93 
is
##
	`ty³
 (
__c
è
__THROW
 \

95  (*
	`__ùy³_b_loc
 ())[(è(
__c
)] & (è
_IS
##
ty³
; \

96 
	}

	)
}

99 
	#__i§scii
(
c
è(((cè& ~0x7fè=ğ0è

	)

100 
	#__tßscii
(
c
è((cè& 0x7fè

	)

102 
	#__exùy³
(
Çme
è
	`Çme
 (è
__THROW


	)

108 
__exùy³
 (
i§Êum
);

109 
__exùy³
 (
i§Íha
);

110 
__exùy³
 (
isúŒl
);

111 
__exùy³
 (
isdig™
);

112 
__exùy³
 (
i¦ow”
);

113 
__exùy³
 (
isg¿ph
);

114 
__exùy³
 (
i¥ršt
);

115 
__exùy³
 (
i¥unù
);

116 
__exùy³
 (
is¥aû
);

117 
__exùy³
 (
isuµ”
);

118 
__exùy³
 (
isxdig™
);

122 
	$tŞow”
 (
__c
è
__THROW
;

125 
	$touµ”
 (
__c
è
__THROW
;

129 #ifdef 
__USE_ISOC99


130 
	`__exùy³
 (
isbÏnk
);

133 #ifdeà
__USE_GNU


135 
	$isùy³
 (
__c
, 
__mask
è
__THROW
;

138 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


142 
	$i§scii
 (
__c
è
__THROW
;

146 
	$tßscii
 (
__c
è
__THROW
;

150 
	`__exùy³
 (
_touµ”
);

151 
	`__exùy³
 (
_tŞow”
);

155 
	#__tobody
(
c
, 
f
, 
a
, 
¬gs
) \

156 (
__ex‹nsiÚ__
 \

157 ({ 
__»s
; \

158 ià( (
c
) > 1) \

160 ià(
	`__butš_cÚ¡ªt_p
 (
c
)) \

162 
__c
 = (
c
); \

163 
__»s
 = 
__c
 < -128 || __ø> 255 ? __ø: (
a
)[__c]; \

166 
__»s
 = 
f
 
¬gs
; \

169 
__»s
 = (
a
)[(è(
c
)]; \

170 
__»s
; 
	}
}))

	)

172 #ià!
defšed
 
__NO_CTYPE


173 #ifdeà
__isùy³_f


174 
	$__isùy³_f
 (
®num
)

175 
	$__isùy³_f
 (
®pha
)

176 
	$__isùy³_f
 (
úŒl
)

177 
	$__isùy³_f
 (
dig™
)

178 
	$__isùy³_f
 (
low”
)

179 
	$__isùy³_f
 (
g¿ph
)

180 
	$__isùy³_f
 (
´št
)

181 
	$__isùy³_f
 (
punù
)

182 
	$__isùy³_f
 (
¥aû
)

183 
	$__isùy³_f
 (
uµ”
)

184 
	$__isùy³_f
 (
xdig™
)

185 #ifdeà
__USE_ISOC99


186 
	$__isùy³_f
 (
bÏnk
)

188 #–ià
defšed
 
__isùy³


189 
	#i§Êum
(
c
è
	`__isùy³
((c), 
_IS®num
)

	)

190 
	#i§Íha
(
c
è
	`__isùy³
((c), 
_IS®pha
)

	)

191 
	#isúŒl
(
c
è
	`__isùy³
((c), 
_ISúŒl
)

	)

192 
	#isdig™
(
c
è
	`__isùy³
((c), 
_ISdig™
)

	)

193 
	#i¦ow”
(
c
è
	`__isùy³
((c), 
_ISlow”
)

	)

194 
	#isg¿ph
(
c
è
	`__isùy³
((c), 
_ISg¿ph
)

	)

195 
	#i¥ršt
(
c
è
	`__isùy³
((c), 
_IS´št
)

	)

196 
	#i¥unù
(
c
è
	`__isùy³
((c), 
_ISpunù
)

	)

197 
	#is¥aû
(
c
è
	`__isùy³
((c), 
_IS¥aû
)

	)

198 
	#isuµ”
(
c
è
	`__isùy³
((c), 
_ISuµ”
)

	)

199 
	#isxdig™
(
c
è
	`__isùy³
((c), 
_ISxdig™
)

	)

200 #ifdeà
__USE_ISOC99


201 
	#isbÏnk
(
c
è
	`__isùy³
((c), 
_ISbÏnk
)

	)

205 #ifdeà
__USE_EXTERN_INLINES


206 
__ex‹º_šlše
 

207 
	`__NTH
 (
	$tŞow”
 (
__c
))

209  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_tŞow”_loc
 ())[__c] : __c;

210 
	}
}

212 
__ex‹º_šlše
 

213 
__NTH
 (
	$touµ”
 (
__c
))

215  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_touµ”_loc
 ())[__c] : __c;

216 
	}
}

219 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


220 
	#tŞow”
(
c
è
	`__tobody
 (c, 
tŞow”
, *
	`__ùy³_tŞow”_loc
 (), (c))

	)

221 
	#touµ”
(
c
è
	`__tobody
 (c, 
touµ”
, *
	`__ùy³_touµ”_loc
 (), (c))

	)

224 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


225 
	#i§scii
(
c
è
	`__i§scii
 (c)

	)

226 
	#tßscii
(
c
è
	`__tßscii
 (c)

	)

228 
	#_tŞow”
(
c
è((è(*
	`__ùy³_tŞow”_loc
 ())[(è(c)])

	)

229 
	#_touµ”
(
c
è((è(*
	`__ùy³_touµ”_loc
 ())[(è(c)])

	)

235 #ifdeà
__USE_XOPEN2K8


237 
	~<b™s/ty³s/loÿË_t.h
>

241 
	#__isùy³_l
(
c
, 
ty³
, 
loÿË
) \

242 ((
loÿË
)->
__ùy³_b
[(è(
c
)] & (è
ty³
)

	)

244 
	#__exùy³_l
(
Çme
) \

245 
	`Çme
 (, 
loÿË_t
è
__THROW


	)

251 
__exùy³_l
 (
i§Êum_l
);

252 
__exùy³_l
 (
i§Íha_l
);

253 
__exùy³_l
 (
isúŒl_l
);

254 
__exùy³_l
 (
isdig™_l
);

255 
__exùy³_l
 (
i¦ow”_l
);

256 
__exùy³_l
 (
isg¿ph_l
);

257 
__exùy³_l
 (
i¥ršt_l
);

258 
__exùy³_l
 (
i¥unù_l
);

259 
__exùy³_l
 (
is¥aû_l
);

260 
__exùy³_l
 (
isuµ”_l
);

261 
__exùy³_l
 (
isxdig™_l
);

263 
__exùy³_l
 (
isbÏnk_l
);

267 
	$__tŞow”_l
 (
__c
, 
loÿË_t
 
__l
è
__THROW
;

268 
	$tŞow”_l
 (
__c
, 
loÿË_t
 
__l
è
__THROW
;

271 
	$__touµ”_l
 (
__c
, 
loÿË_t
 
__l
è
__THROW
;

272 
	$touµ”_l
 (
__c
, 
loÿË_t
 
__l
è
__THROW
;

274 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


275 
	#__tŞow”_l
(
c
, 
loÿË
) \

276 
	`__tobody
 (
c
, 
__tŞow”_l
, (
loÿË
)->
__ùy³_tŞow”
, (c,†oÿË))

	)

277 
	#__touµ”_l
(
c
, 
loÿË
) \

278 
	`__tobody
 (
c
, 
__touµ”_l
, (
loÿË
)->
__ùy³_touµ”
, (c,†oÿË))

	)

279 
	#tŞow”_l
(
c
, 
loÿË
è
	`__tŞow”_l
 ((c), (loÿË))

	)

280 
	#touµ”_l
(
c
, 
loÿË
è
	`__touµ”_l
 ((c), (loÿË))

	)

284 #iâdeà
__NO_CTYPE


285 
	#__i§Êum_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®num
, (l))

	)

286 
	#__i§Íha_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®pha
, (l))

	)

287 
	#__isúŒl_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISúŒl
, (l))

	)

288 
	#__isdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISdig™
, (l))

	)

289 
	#__i¦ow”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISlow”
, (l))

	)

290 
	#__isg¿ph_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISg¿ph
, (l))

	)

291 
	#__i¥ršt_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS´št
, (l))

	)

292 
	#__i¥unù_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISpunù
, (l))

	)

293 
	#__is¥aû_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS¥aû
, (l))

	)

294 
	#__isuµ”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISuµ”
, (l))

	)

295 
	#__isxdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISxdig™
, (l))

	)

297 
	#__isbÏnk_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISbÏnk
, (l))

	)

299 #ifdeà
__USE_MISC


300 
	#__i§scii_l
(
c
,
l
è(Ö), 
	`__i§scii
 (c))

	)

301 
	#__tßscii_l
(
c
,
l
è(Ö), 
	`__tßscii
 (c))

	)

304 
	#i§Êum_l
(
c
,
l
è
	`__i§Êum_l
 ((c), (l))

	)

305 
	#i§Íha_l
(
c
,
l
è
	`__i§Íha_l
 ((c), (l))

	)

306 
	#isúŒl_l
(
c
,
l
è
	`__isúŒl_l
 ((c), (l))

	)

307 
	#isdig™_l
(
c
,
l
è
	`__isdig™_l
 ((c), (l))

	)

308 
	#i¦ow”_l
(
c
,
l
è
	`__i¦ow”_l
 ((c), (l))

	)

309 
	#isg¿ph_l
(
c
,
l
è
	`__isg¿ph_l
 ((c), (l))

	)

310 
	#i¥ršt_l
(
c
,
l
è
	`__i¥ršt_l
 ((c), (l))

	)

311 
	#i¥unù_l
(
c
,
l
è
	`__i¥unù_l
 ((c), (l))

	)

312 
	#is¥aû_l
(
c
,
l
è
	`__is¥aû_l
 ((c), (l))

	)

313 
	#isuµ”_l
(
c
,
l
è
	`__isuµ”_l
 ((c), (l))

	)

314 
	#isxdig™_l
(
c
,
l
è
	`__isxdig™_l
 ((c), (l))

	)

316 
	#isbÏnk_l
(
c
,
l
è
	`__isbÏnk_l
 ((c), (l))

	)

318 #ifdeà
__USE_MISC


319 
	#i§scii_l
(
c
,
l
è
	`__i§scii_l
 ((c), (l))

	)

320 
	#tßscii_l
(
c
,
l
è
	`__tßscii_l
 ((c), (l))

	)

327 
__END_DECLS


	@/usr/include/dirent.h

22 #iâdef 
_DIRENT_H


23 
	#_DIRENT_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


29 
	~<b™s/ty³s.h
>

31 #ifdeà
__USE_XOPEN


32 #iâdeà
__šo_t_defšed


33 #iâdeà
__USE_FILE_OFFSET64


34 
__šo_t
 
	tšo_t
;

36 
__šo64_t
 
	tšo_t
;

38 
	#__šo_t_defšed


	)

40 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__šo64_t_defšed


41 
__šo64_t
 
	tšo64_t
;

42 
	#__šo64_t_defšed


	)

61 
	~<b™s/dœ’t.h
>

63 #ià
defšed
 
__USE_MISC
 && !defšed 
d_f’o


64 
	#d_šo
 
d_f’o


	)

81 #ifdeà
_DIRENT_HAVE_D_NAMLEN


82 
	#_D_EXACT_NAMLEN
(
d
è((d)->
d_ÇmËn
)

	)

83 
	#_D_ALLOC_NAMLEN
(
d
è(
	`_D_EXACT_NAMLEN
 (dè+ 1)

	)

85 
	#_D_EXACT_NAMLEN
(
d
è(
	`¡¾’
 ((d)->
d_Çme
))

	)

86 #ifdeà
_DIRENT_HAVE_D_RECLEN


87 
	#_D_ALLOC_NAMLEN
(
d
è(((*è(dè+ (d)->
d_»ş’
è- &(d)->
d_Çme
[0])

	)

89 
	#_D_ALLOC_NAMLEN
(
d
è( (d)->
d_Çme
 > 1 ?  (d)->d_name : \

90 
	`_D_EXACT_NAMLEN
 (
d
è+ 1)

	)

95 #ifdeà
__USE_MISC


99 
	mDT_UNKNOWN
 = 0,

100 
	#DT_UNKNOWN
 
DT_UNKNOWN


	)

101 
	mDT_FIFO
 = 1,

102 
	#DT_FIFO
 
DT_FIFO


	)

103 
	mDT_CHR
 = 2,

104 
	#DT_CHR
 
DT_CHR


	)

105 
	mDT_DIR
 = 4,

106 
	#DT_DIR
 
DT_DIR


	)

107 
	mDT_BLK
 = 6,

108 
	#DT_BLK
 
DT_BLK


	)

109 
	mDT_REG
 = 8,

110 
	#DT_REG
 
DT_REG


	)

111 
	mDT_LNK
 = 10,

112 
	#DT_LNK
 
DT_LNK


	)

113 
	mDT_SOCK
 = 12,

114 
	#DT_SOCK
 
DT_SOCK


	)

115 
	mDT_WHT
 = 14

116 
	#DT_WHT
 
DT_WHT


	)

120 
	#IFTODT
(
mode
è(((modeè& 0170000è>> 12)

	)

121 
	#DTTOIF
(
dœty³
è((dœty³è<< 12)

	)

127 
__dœ¡»am
 
	tDIR
;

134 
DIR
 *
	$İ’dœ
 (cÚ¡ *
__Çme
è
	`__nÚnuÎ
 ((1));

136 #ifdeà
__USE_XOPEN2K8


141 
DIR
 *
	`fdİ’dœ
 (
__fd
);

149 
	$şo£dœ
 (
DIR
 *
__dœp
è
	`__nÚnuÎ
 ((1));

161 #iâdeà
__USE_FILE_OFFSET64


162 
dœ’t
 *
	$»addœ
 (
DIR
 *
__dœp
è
	`__nÚnuÎ
 ((1));

164 #ifdeà
__REDIRECT


165 
dœ’t
 *
	`__REDIRECT
 (
»addœ
, (
DIR
 *
__dœp
), 
»addœ64
)

166 
	`__nÚnuÎ
 ((1));

168 
	#»addœ
 
»addœ64


	)

172 #ifdeà
__USE_LARGEFILE64


173 
dœ’t64
 *
	$»addœ64
 (
DIR
 *
__dœp
è
	`__nÚnuÎ
 ((1));

176 #ifdeà
__USE_POSIX


182 #iâdeà
__USE_FILE_OFFSET64


183 
	$»addœ_r
 (
DIR
 *
__»¡riù
 
__dœp
,

184 
dœ’t
 *
__»¡riù
 
__’Œy
,

185 
dœ’t
 **
__»¡riù
 
__»suÉ
)

186 
	`__nÚnuÎ
 ((1, 2, 3)è
__©Œibu‹_d•»ÿ‹d__
;

188 #ifdeà
__REDIRECT


189 
	`__REDIRECT
 (
»addœ_r
,

190 (
DIR
 *
__»¡riù
 
__dœp
,

191 
dœ’t
 *
__»¡riù
 
__’Œy
,

192 
dœ’t
 **
__»¡riù
 
__»suÉ
),

193 
»addœ64_r
)

194 
	`__nÚnuÎ
 ((1, 2, 3)è
__©Œibu‹_d•»ÿ‹d__
;

196 
	#»addœ_r
 
»addœ64_r


	)

200 #ifdeà
__USE_LARGEFILE64


201 
	$»addœ64_r
 (
DIR
 *
__»¡riù
 
__dœp
,

202 
dœ’t64
 *
__»¡riù
 
__’Œy
,

203 
dœ’t64
 **
__»¡riù
 
__»suÉ
)

204 
	`__nÚnuÎ
 ((1, 2, 3)è
__©Œibu‹_d•»ÿ‹d__
;

209 
	$»wšddœ
 (
DIR
 *
__dœp
è
__THROW
 
	`__nÚnuÎ
 ((1));

211 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


212 
	~<b™s/ty³s.h
>

215 
	$£ekdœ
 (
DIR
 *
__dœp
, 
__pos
è
__THROW
 
	`__nÚnuÎ
 ((1));

218 
	$‹Îdœ
 (
DIR
 *
__dœp
è
__THROW
 
	`__nÚnuÎ
 ((1));

221 #ifdeà
__USE_XOPEN2K8


224 
	$dœfd
 (
DIR
 *
__dœp
è
__THROW
 
	`__nÚnuÎ
 ((1));

226 #ià
defšed
 
__OPTIMIZE__
 && defšed 
_DIR_dœfd


227 
	#dœfd
(
dœp
è
	`_DIR_dœfd
 (dœp)

	)

230 #ifdeà
__USE_MISC


231 #iâdeà
MAXNAMLEN


233 
	~<b™s/posix1_lim.h
>

236 #ifdeà
NAME_MAX


237 
	#MAXNAMLEN
 
NAME_MAX


	)

239 
	#MAXNAMLEN
 255

	)

244 
	#__Ãed_size_t


	)

245 
	~<¡ddef.h
>

254 #iâdeà
__USE_FILE_OFFSET64


255 
	$sÿndœ
 (cÚ¡ *
__»¡riù
 
__dœ
,

256 
dœ’t
 ***
__»¡riù
 
__Çm–i¡
,

257 (*
__£ËùÜ
è(cÚ¡ 
dœ’t
 *),

258 (*
__cmp
è(cÚ¡ 
dœ’t
 **,

259 cÚ¡ 
dœ’t
 **))

260 
	`__nÚnuÎ
 ((1, 2));

262 #ifdeà
__REDIRECT


263 
	`__REDIRECT
 (
sÿndœ
,

264 (cÚ¡ *
__»¡riù
 
__dœ
,

265 
dœ’t
 ***
__»¡riù
 
__Çm–i¡
,

266 (*
__£ËùÜ
è(cÚ¡ 
dœ’t
 *),

267 (*
__cmp
è(cÚ¡ 
dœ’t
 **,

268 cÚ¡ 
dœ’t
 **)),

269 
sÿndœ64
è
	`__nÚnuÎ
 ((1, 2));

271 
	#sÿndœ
 
sÿndœ64


	)

275 #ià
defšed
 
__USE_GNU
 && defšed 
__USE_LARGEFILE64


278 
	$sÿndœ64
 (cÚ¡ *
__»¡riù
 
__dœ
,

279 
dœ’t64
 ***
__»¡riù
 
__Çm–i¡
,

280 (*
__£ËùÜ
è(cÚ¡ 
dœ’t64
 *),

281 (*
__cmp
è(cÚ¡ 
dœ’t64
 **,

282 cÚ¡ 
dœ’t64
 **))

283 
	`__nÚnuÎ
 ((1, 2));

286 #ifdeà
__USE_GNU


292 #iâdeà
__USE_FILE_OFFSET64


293 
	$sÿndœ©
 (
__dfd
, cÚ¡ *
__»¡riù
 
__dœ
,

294 
dœ’t
 ***
__»¡riù
 
__Çm–i¡
,

295 (*
__£ËùÜ
è(cÚ¡ 
dœ’t
 *),

296 (*
__cmp
è(cÚ¡ 
dœ’t
 **,

297 cÚ¡ 
dœ’t
 **))

298 
	`__nÚnuÎ
 ((2, 3));

300 #ifdeà
__REDIRECT


301 
	`__REDIRECT
 (
sÿndœ©
,

302 (
__dfd
, cÚ¡ *
__»¡riù
 
__dœ
,

303 
dœ’t
 ***
__»¡riù
 
__Çm–i¡
,

304 (*
__£ËùÜ
è(cÚ¡ 
dœ’t
 *),

305 (*
__cmp
è(cÚ¡ 
dœ’t
 **,

306 cÚ¡ 
dœ’t
 **)),

307 
sÿndœ©64
è
	`__nÚnuÎ
 ((2, 3));

309 
	#sÿndœ©
 
sÿndœ©64


	)

315 
	$sÿndœ©64
 (
__dfd
, cÚ¡ *
__»¡riù
 
__dœ
,

316 
dœ’t64
 ***
__»¡riù
 
__Çm–i¡
,

317 (*
__£ËùÜ
è(cÚ¡ 
dœ’t64
 *),

318 (*
__cmp
è(cÚ¡ 
dœ’t64
 **,

319 cÚ¡ 
dœ’t64
 **))

320 
	`__nÚnuÎ
 ((2, 3));

324 #iâdeà
__USE_FILE_OFFSET64


325 
	$®phasÜt
 (cÚ¡ 
dœ’t
 **
__e1
,

326 cÚ¡ 
dœ’t
 **
__e2
)

327 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

329 #ifdeà
__REDIRECT


330 
	`__REDIRECT_NTH
 (
®phasÜt
,

331 (cÚ¡ 
dœ’t
 **
__e1
,

332 cÚ¡ 
dœ’t
 **
__e2
),

333 
®phasÜt64
è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

335 
	#®phasÜt
 
®phasÜt64


	)

339 #ià
defšed
 
__USE_GNU
 && defšed 
__USE_LARGEFILE64


340 
	$®phasÜt64
 (cÚ¡ 
dœ’t64
 **
__e1
,

341 cÚ¡ 
dœ’t64
 **
__e2
)

342 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

347 #ifdeà
__USE_MISC


352 #iâdeà
__USE_FILE_OFFSET64


353 
__ssize_t
 
	$g‘dœ’Œ›s
 (
__fd
, *
__»¡riù
 
__buf
,

354 
size_t
 
__nby‹s
,

355 
__off_t
 *
__»¡riù
 
__ba£p
)

356 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

358 #ifdeà
__REDIRECT


359 
__ssize_t
 
	`__REDIRECT_NTH
 (
g‘dœ’Œ›s
,

360 (
__fd
, *
__»¡riù
 
__buf
,

361 
size_t
 
__nby‹s
,

362 
__off64_t
 *
__»¡riù
 
__ba£p
),

363 
g‘dœ’Œ›s64
è
	`__nÚnuÎ
 ((2, 4));

365 
	#g‘dœ’Œ›s
 
g‘dœ’Œ›s64


	)

369 #ifdeà
__USE_LARGEFILE64


370 
__ssize_t
 
	$g‘dœ’Œ›s64
 (
__fd
, *
__»¡riù
 
__buf
,

371 
size_t
 
__nby‹s
,

372 
__off64_t
 *
__»¡riù
 
__ba£p
)

373 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

377 #ifdeà
__USE_GNU


379 #iâdeà
__USE_FILE_OFFSET64


380 
	$v”siÚsÜt
 (cÚ¡ 
dœ’t
 **
__e1
,

381 cÚ¡ 
dœ’t
 **
__e2
)

382 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

384 #ifdeà
__REDIRECT


385 
	`__REDIRECT_NTH
 (
v”siÚsÜt
,

386 (cÚ¡ 
dœ’t
 **
__e1
,

387 cÚ¡ 
dœ’t
 **
__e2
),

388 
v”siÚsÜt64
)

389 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

391 
	#v”siÚsÜt
 
v”siÚsÜt64


	)

395 #ifdeà
__USE_LARGEFILE64


396 
	$v”siÚsÜt64
 (cÚ¡ 
dœ’t64
 **
__e1
,

397 cÚ¡ 
dœ’t64
 **
__e2
)

398 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

402 
__END_DECLS


	@/usr/include/errno.h

22 #iâdef 
_ERRNO_H


23 
	#_ERRNO_H
 1

	)

25 
	~<ã©u»s.h
>

28 
	~<b™s/”ºo.h
>

32 #iâdeà
__ASSEMBLER__


34 
__BEGIN_DECLS


37 *
	$__”ºo_loÿtiÚ
 (è
__THROW
 
__©Œibu‹_cÚ¡__
;

38 
	#”ºo
 (*
	`__”ºo_loÿtiÚ
 ())

	)

40 #ifdeà
__USE_GNU


45 *
´og¿m_švoÿtiÚ_Çme
;

46 *
´og¿m_švoÿtiÚ_shÜt_Çme
;

50 #iâdeà
__”rÜ_t_defšed


51 
	#__”rÜ_t_defšed
 1

	)

52 
	t”rÜ_t
;

57 
__END_DECLS


	@/usr/include/execinfo.h

18 #iâdeà
_EXECINFO_H


19 
	#_EXECINFO_H
 1

	)

21 
	~<ã©u»s.h
>

23 
__BEGIN_DECLS


27 
	$backŒaû
 (**
__¬¿y
, 
__size
è
	`__nÚnuÎ
 ((1));

32 **
	$backŒaû_symbŞs
 (*cÚ¡ *
__¬¿y
, 
__size
)

33 
__THROW
 
	`__nÚnuÎ
 ((1));

38 
	$backŒaû_symbŞs_fd
 (*cÚ¡ *
__¬¿y
, 
__size
, 
__fd
)

39 
__THROW
 
	`__nÚnuÎ
 ((1));

41 
__END_DECLS


	@/usr/include/fcntl.h

22 #iâdef 
_FCNTL_H


23 
	#_FCNTL_H
 1

	)

25 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


31 
	~<b™s/ty³s.h
>

35 
	~<b™s/fú.h
>

39 #ifdeà
__O_TMPFILE


40 
	#__OPEN_NEEDS_MODE
(
oæag
) \

41 (((
oæag
è& 
O_CREAT
è!ğ0 || ((oæagè& 
__O_TMPFILE
è=ğ__O_TMPFILE)

	)

43 
	#__OPEN_NEEDS_MODE
(
oæag
è(((oæagè& 
O_CREAT
è!ğ0)

	)

49 #iâdeà
__mode_t_defšed


50 
__mode_t
 
	tmode_t
;

51 
	#__mode_t_defšed


	)

54 #iâdeà
__off_t_defšed


55 #iâdeà
__USE_FILE_OFFSET64


56 
__off_t
 
	toff_t
;

58 
__off64_t
 
	toff_t
;

60 
	#__off_t_defšed


	)

63 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


64 
__off64_t
 
	toff64_t
;

65 
	#__off64_t_defšed


	)

68 #iâdeà
__pid_t_defšed


69 
__pid_t
 
	tpid_t
;

70 
	#__pid_t_defšed


	)

74 #ifdeà
__USE_XOPEN2K8


75 
	~<b™s/ty³s/¡ruù_time¥ec.h
>

77 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


78 
	~<b™s/¡©.h
>

80 
	#S_IFMT
 
__S_IFMT


	)

81 
	#S_IFDIR
 
__S_IFDIR


	)

82 
	#S_IFCHR
 
__S_IFCHR


	)

83 
	#S_IFBLK
 
__S_IFBLK


	)

84 
	#S_IFREG
 
__S_IFREG


	)

85 #ifdeà
__S_IFIFO


86 
	#S_IFIFO
 
__S_IFIFO


	)

88 #ifdeà
__S_IFLNK


89 
	#S_IFLNK
 
__S_IFLNK


	)

91 #ià(
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8
è&& defšed 
__S_IFSOCK


92 
	#S_IFSOCK
 
__S_IFSOCK


	)

97 
	#S_ISUID
 
__S_ISUID


	)

98 
	#S_ISGID
 
__S_ISGID


	)

100 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


102 
	#S_ISVTX
 
__S_ISVTX


	)

105 
	#S_IRUSR
 
__S_IREAD


	)

106 
	#S_IWUSR
 
__S_IWRITE


	)

107 
	#S_IXUSR
 
__S_IEXEC


	)

109 
	#S_IRWXU
 (
__S_IREAD
|
__S_IWRITE
|
__S_IEXEC
)

	)

111 
	#S_IRGRP
 (
S_IRUSR
 >> 3è

	)

112 
	#S_IWGRP
 (
S_IWUSR
 >> 3è

	)

113 
	#S_IXGRP
 (
S_IXUSR
 >> 3è

	)

115 
	#S_IRWXG
 (
S_IRWXU
 >> 3)

	)

117 
	#S_IROTH
 (
S_IRGRP
 >> 3è

	)

118 
	#S_IWOTH
 (
S_IWGRP
 >> 3è

	)

119 
	#S_IXOTH
 (
S_IXGRP
 >> 3è

	)

121 
	#S_IRWXO
 (
S_IRWXG
 >> 3)

	)

124 #ifdef 
__USE_MISC


125 #iâdeà
R_OK


128 
	#R_OK
 4

	)

129 
	#W_OK
 2

	)

130 
	#X_OK
 1

	)

131 
	#F_OK
 0

	)

136 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


137 
	#SEEK_SET
 0

	)

138 
	#SEEK_CUR
 1

	)

139 
	#SEEK_END
 2

	)

147 
fú
 (
__fd
, 
__cmd
, ...);

156 #iâdeà
__USE_FILE_OFFSET64


157 
	$İ’
 (cÚ¡ *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

159 #ifdeà
__REDIRECT


160 
	`__REDIRECT
 (
İ’
, (cÚ¡ *
__fe
, 
__oæag
, ...), 
İ’64
)

161 
	`__nÚnuÎ
 ((1));

163 
	#İ’
 
İ’64


	)

166 #ifdeà
__USE_LARGEFILE64


167 
	$İ’64
 (cÚ¡ *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

170 #ifdeà
__USE_ATFILE


180 #iâdeà
__USE_FILE_OFFSET64


181 
	$İ’©
 (
__fd
, cÚ¡ *
__fe
, 
__oæag
, ...)

182 
	`__nÚnuÎ
 ((2));

184 #ifdeà
__REDIRECT


185 
	`__REDIRECT
 (
İ’©
, (
__fd
, cÚ¡ *
__fe
, 
__oæag
,

186 ...), 
İ’©64
è
	`__nÚnuÎ
 ((2));

188 
	#İ’©
 
İ’©64


	)

191 #ifdeà
__USE_LARGEFILE64


192 
	$İ’©64
 (
__fd
, cÚ¡ *
__fe
, 
__oæag
, ...)

193 
	`__nÚnuÎ
 ((2));

202 #iâdeà
__USE_FILE_OFFSET64


203 
	$ü—t
 (cÚ¡ *
__fe
, 
mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

205 #ifdeà
__REDIRECT


206 
	`__REDIRECT
 (
ü—t
, (cÚ¡ *
__fe
, 
mode_t
 
__mode
),

207 
ü—t64
è
	`__nÚnuÎ
 ((1));

209 
	#ü—t
 
ü—t64


	)

212 #ifdeà
__USE_LARGEFILE64


213 
	$ü—t64
 (cÚ¡ *
__fe
, 
mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

216 #ià!
defšed
 
F_LOCK
 && (defšed 
__USE_MISC
 || (defšed 
__USE_XOPEN_EXTENDED
 \

217 && !
defšed
 
__USE_POSIX
))

226 
	#F_ULOCK
 0

	)

227 
	#F_LOCK
 1

	)

228 
	#F_TLOCK
 2

	)

229 
	#F_TEST
 3

	)

231 #iâdeà
__USE_FILE_OFFSET64


232 
	`lockf
 (
__fd
, 
__cmd
, 
off_t
 
__Ën
);

234 #ifdeà
__REDIRECT


235 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
), 
lockf64
);

237 
	#lockf
 
lockf64


	)

240 #ifdeà
__USE_LARGEFILE64


241 
	`lockf64
 (
__fd
, 
__cmd
, 
off64_t
 
__Ën
);

245 #ifdeà
__USE_XOPEN2K


248 #iâdeà
__USE_FILE_OFFSET64


249 
	$posix_çdvi£
 (
__fd
, 
off_t
 
__off£t
, off_ˆ
__Ën
,

250 
__advi£
è
__THROW
;

252 #ifdeà
__REDIRECT_NTH


253 
	`__REDIRECT_NTH
 (
posix_çdvi£
, (
__fd
, 
__off64_t
 
__off£t
,

254 
__off64_t
 
__Ën
, 
__advi£
),

255 
posix_çdvi£64
);

257 
	#posix_çdvi£
 
posix_çdvi£64


	)

260 #ifdeà
__USE_LARGEFILE64


261 
	$posix_çdvi£64
 (
__fd
, 
off64_t
 
__off£t
, off64_ˆ
__Ën
,

262 
__advi£
è
__THROW
;

270 #iâdeà
__USE_FILE_OFFSET64


271 
	`posix_çÎoÿ‹
 (
__fd
, 
off_t
 
__off£t
, off_ˆ
__Ën
);

273 #ifdeà
__REDIRECT


274 
	`__REDIRECT
 (
posix_çÎoÿ‹
, (
__fd
, 
__off64_t
 
__off£t
,

275 
__off64_t
 
__Ën
),

276 
posix_çÎoÿ‹64
);

278 
	#posix_çÎoÿ‹
 
posix_çÎoÿ‹64


	)

281 #ifdeà
__USE_LARGEFILE64


282 
	`posix_çÎoÿ‹64
 (
__fd
, 
off64_t
 
__off£t
, off64_ˆ
__Ën
);

288 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ
 \

289 && 
defšed
 
__va_¬g_·ck_Ën


290 
	~<b™s/fú2.h
>

293 
__END_DECLS


	@/usr/include/inttypes.h

22 #iâdeà
_INTTYPES_H


23 
	#_INTTYPES_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	~<¡dšt.h
>

30 #iâdeà
____gwch¬_t_defšed


31 #ifdeà
__ılu¥lus


32 
	#__gwch¬_t
 
wch¬_t


	)

33 #–ià
defšed
 
__WCHAR_TYPE__


34 
__WCHAR_TYPE__
 
	t__gwch¬_t
;

36 
	#__Ãed_wch¬_t


	)

37 
	~<¡ddef.h
>

38 
wch¬_t
 
	t__gwch¬_t
;

40 
	#____gwch¬_t_defšed
 1

	)

43 #ià
__WORDSIZE
 == 64

44 
	#__PRI64_PREFIX
 "l"

	)

45 
	#__PRIPTR_PREFIX
 "l"

	)

47 
	#__PRI64_PREFIX
 "Î"

	)

48 
	#__PRIPTR_PREFIX


	)

54 
	#PRId8
 "d"

	)

55 
	#PRId16
 "d"

	)

56 
	#PRId32
 "d"

	)

57 
	#PRId64
 
__PRI64_PREFIX
 "d"

	)

59 
	#PRIdLEAST8
 "d"

	)

60 
	#PRIdLEAST16
 "d"

	)

61 
	#PRIdLEAST32
 "d"

	)

62 
	#PRIdLEAST64
 
__PRI64_PREFIX
 "d"

	)

64 
	#PRIdFAST8
 "d"

	)

65 
	#PRIdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

66 
	#PRIdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

67 
	#PRIdFAST64
 
__PRI64_PREFIX
 "d"

	)

70 
	#PRIi8
 "i"

	)

71 
	#PRIi16
 "i"

	)

72 
	#PRIi32
 "i"

	)

73 
	#PRIi64
 
__PRI64_PREFIX
 "i"

	)

75 
	#PRIiLEAST8
 "i"

	)

76 
	#PRIiLEAST16
 "i"

	)

77 
	#PRIiLEAST32
 "i"

	)

78 
	#PRIiLEAST64
 
__PRI64_PREFIX
 "i"

	)

80 
	#PRIiFAST8
 "i"

	)

81 
	#PRIiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

82 
	#PRIiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

83 
	#PRIiFAST64
 
__PRI64_PREFIX
 "i"

	)

86 
	#PRIo8
 "o"

	)

87 
	#PRIo16
 "o"

	)

88 
	#PRIo32
 "o"

	)

89 
	#PRIo64
 
__PRI64_PREFIX
 "o"

	)

91 
	#PRIoLEAST8
 "o"

	)

92 
	#PRIoLEAST16
 "o"

	)

93 
	#PRIoLEAST32
 "o"

	)

94 
	#PRIoLEAST64
 
__PRI64_PREFIX
 "o"

	)

96 
	#PRIoFAST8
 "o"

	)

97 
	#PRIoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

98 
	#PRIoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

99 
	#PRIoFAST64
 
__PRI64_PREFIX
 "o"

	)

102 
	#PRIu8
 "u"

	)

103 
	#PRIu16
 "u"

	)

104 
	#PRIu32
 "u"

	)

105 
	#PRIu64
 
__PRI64_PREFIX
 "u"

	)

107 
	#PRIuLEAST8
 "u"

	)

108 
	#PRIuLEAST16
 "u"

	)

109 
	#PRIuLEAST32
 "u"

	)

110 
	#PRIuLEAST64
 
__PRI64_PREFIX
 "u"

	)

112 
	#PRIuFAST8
 "u"

	)

113 
	#PRIuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

114 
	#PRIuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

115 
	#PRIuFAST64
 
__PRI64_PREFIX
 "u"

	)

118 
	#PRIx8
 "x"

	)

119 
	#PRIx16
 "x"

	)

120 
	#PRIx32
 "x"

	)

121 
	#PRIx64
 
__PRI64_PREFIX
 "x"

	)

123 
	#PRIxLEAST8
 "x"

	)

124 
	#PRIxLEAST16
 "x"

	)

125 
	#PRIxLEAST32
 "x"

	)

126 
	#PRIxLEAST64
 
__PRI64_PREFIX
 "x"

	)

128 
	#PRIxFAST8
 "x"

	)

129 
	#PRIxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

130 
	#PRIxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

131 
	#PRIxFAST64
 
__PRI64_PREFIX
 "x"

	)

134 
	#PRIX8
 "X"

	)

135 
	#PRIX16
 "X"

	)

136 
	#PRIX32
 "X"

	)

137 
	#PRIX64
 
__PRI64_PREFIX
 "X"

	)

139 
	#PRIXLEAST8
 "X"

	)

140 
	#PRIXLEAST16
 "X"

	)

141 
	#PRIXLEAST32
 "X"

	)

142 
	#PRIXLEAST64
 
__PRI64_PREFIX
 "X"

	)

144 
	#PRIXFAST8
 "X"

	)

145 
	#PRIXFAST16
 
__PRIPTR_PREFIX
 "X"

	)

146 
	#PRIXFAST32
 
__PRIPTR_PREFIX
 "X"

	)

147 
	#PRIXFAST64
 
__PRI64_PREFIX
 "X"

	)

151 
	#PRIdMAX
 
__PRI64_PREFIX
 "d"

	)

152 
	#PRIiMAX
 
__PRI64_PREFIX
 "i"

	)

153 
	#PRIoMAX
 
__PRI64_PREFIX
 "o"

	)

154 
	#PRIuMAX
 
__PRI64_PREFIX
 "u"

	)

155 
	#PRIxMAX
 
__PRI64_PREFIX
 "x"

	)

156 
	#PRIXMAX
 
__PRI64_PREFIX
 "X"

	)

160 
	#PRIdPTR
 
__PRIPTR_PREFIX
 "d"

	)

161 
	#PRIiPTR
 
__PRIPTR_PREFIX
 "i"

	)

162 
	#PRIoPTR
 
__PRIPTR_PREFIX
 "o"

	)

163 
	#PRIuPTR
 
__PRIPTR_PREFIX
 "u"

	)

164 
	#PRIxPTR
 
__PRIPTR_PREFIX
 "x"

	)

165 
	#PRIXPTR
 
__PRIPTR_PREFIX
 "X"

	)

171 
	#SCNd8
 "hhd"

	)

172 
	#SCNd16
 "hd"

	)

173 
	#SCNd32
 "d"

	)

174 
	#SCNd64
 
__PRI64_PREFIX
 "d"

	)

176 
	#SCNdLEAST8
 "hhd"

	)

177 
	#SCNdLEAST16
 "hd"

	)

178 
	#SCNdLEAST32
 "d"

	)

179 
	#SCNdLEAST64
 
__PRI64_PREFIX
 "d"

	)

181 
	#SCNdFAST8
 "hhd"

	)

182 
	#SCNdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

183 
	#SCNdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

184 
	#SCNdFAST64
 
__PRI64_PREFIX
 "d"

	)

187 
	#SCNi8
 "hhi"

	)

188 
	#SCNi16
 "hi"

	)

189 
	#SCNi32
 "i"

	)

190 
	#SCNi64
 
__PRI64_PREFIX
 "i"

	)

192 
	#SCNiLEAST8
 "hhi"

	)

193 
	#SCNiLEAST16
 "hi"

	)

194 
	#SCNiLEAST32
 "i"

	)

195 
	#SCNiLEAST64
 
__PRI64_PREFIX
 "i"

	)

197 
	#SCNiFAST8
 "hhi"

	)

198 
	#SCNiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

199 
	#SCNiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

200 
	#SCNiFAST64
 
__PRI64_PREFIX
 "i"

	)

203 
	#SCNu8
 "hhu"

	)

204 
	#SCNu16
 "hu"

	)

205 
	#SCNu32
 "u"

	)

206 
	#SCNu64
 
__PRI64_PREFIX
 "u"

	)

208 
	#SCNuLEAST8
 "hhu"

	)

209 
	#SCNuLEAST16
 "hu"

	)

210 
	#SCNuLEAST32
 "u"

	)

211 
	#SCNuLEAST64
 
__PRI64_PREFIX
 "u"

	)

213 
	#SCNuFAST8
 "hhu"

	)

214 
	#SCNuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

215 
	#SCNuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

216 
	#SCNuFAST64
 
__PRI64_PREFIX
 "u"

	)

219 
	#SCNo8
 "hho"

	)

220 
	#SCNo16
 "ho"

	)

221 
	#SCNo32
 "o"

	)

222 
	#SCNo64
 
__PRI64_PREFIX
 "o"

	)

224 
	#SCNoLEAST8
 "hho"

	)

225 
	#SCNoLEAST16
 "ho"

	)

226 
	#SCNoLEAST32
 "o"

	)

227 
	#SCNoLEAST64
 
__PRI64_PREFIX
 "o"

	)

229 
	#SCNoFAST8
 "hho"

	)

230 
	#SCNoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

231 
	#SCNoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

232 
	#SCNoFAST64
 
__PRI64_PREFIX
 "o"

	)

235 
	#SCNx8
 "hhx"

	)

236 
	#SCNx16
 "hx"

	)

237 
	#SCNx32
 "x"

	)

238 
	#SCNx64
 
__PRI64_PREFIX
 "x"

	)

240 
	#SCNxLEAST8
 "hhx"

	)

241 
	#SCNxLEAST16
 "hx"

	)

242 
	#SCNxLEAST32
 "x"

	)

243 
	#SCNxLEAST64
 
__PRI64_PREFIX
 "x"

	)

245 
	#SCNxFAST8
 "hhx"

	)

246 
	#SCNxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

247 
	#SCNxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

248 
	#SCNxFAST64
 
__PRI64_PREFIX
 "x"

	)

252 
	#SCNdMAX
 
__PRI64_PREFIX
 "d"

	)

253 
	#SCNiMAX
 
__PRI64_PREFIX
 "i"

	)

254 
	#SCNoMAX
 
__PRI64_PREFIX
 "o"

	)

255 
	#SCNuMAX
 
__PRI64_PREFIX
 "u"

	)

256 
	#SCNxMAX
 
__PRI64_PREFIX
 "x"

	)

259 
	#SCNdPTR
 
__PRIPTR_PREFIX
 "d"

	)

260 
	#SCNiPTR
 
__PRIPTR_PREFIX
 "i"

	)

261 
	#SCNoPTR
 
__PRIPTR_PREFIX
 "o"

	)

262 
	#SCNuPTR
 
__PRIPTR_PREFIX
 "u"

	)

263 
	#SCNxPTR
 
__PRIPTR_PREFIX
 "x"

	)

266 
	g__BEGIN_DECLS


268 #ià
__WORDSIZE
 == 64

273 
	mquÙ
;

274 
	m»m
;

275 } 
	timaxdiv_t
;

282 
__ex‹nsiÚ__
 
	mquÙ
;

283 
__ex‹nsiÚ__
 
	m»m
;

284 } 
	timaxdiv_t
;

290 
štmax_t
 
	$imaxabs
 (
štmax_t
 
__n
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

293 
imaxdiv_t
 
	$imaxdiv
 (
štmax_t
 
__num”
, iÁmax_ˆ
__d’om
)

294 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

297 
štmax_t
 
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

298 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

301 
uštmax_t
 
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

302 ** 
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

305 
štmax_t
 
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

306 
__gwch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

307 
__THROW
;

310 
uštmax_t
 
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

311 
__gwch¬_t
 ** 
__»¡riù
 
__’d±r
, 
__ba£
)

312 
__THROW
;

314 #ifdeà
__USE_EXTERN_INLINES


316 #ià
__WORDSIZE
 == 64

318 
	$__¡¹Ş_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

319 **
__»¡riù
 
__’d±r
,

320 
__ba£
, 
__group
)

321 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

323 
__ex‹º_šlše
 
štmax_t


324 
	`__NTH
 (
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

325 
ba£
))

327  
	`__¡¹Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

328 
	}
}

330 
	$__¡¹oul_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

331 ** 
__»¡riù
 
__’d±r
,

332 
__ba£
, 
__group
)

333 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

335 
__ex‹º_šlše
 
uštmax_t


336 
	`__NTH
 (
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

337 
ba£
))

339  
	`__¡¹oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

340 
	}
}

342 
	$__wc¡Ş_š‹º®
 (cÚ¡ 
__gwch¬_t
 * 
__»¡riù
 
__ÅŒ
,

343 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

344 
__ba£
, 
__group
)

345 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

347 
__ex‹º_šlše
 
štmax_t


348 
	`__NTH
 (
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

349 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

351  
	`__wc¡Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

352 
	}
}

354 
	$__wc¡oul_š‹º®
 (cÚ¡ 
__gwch¬_t
 *

355 
__»¡riù
 
__ÅŒ
,

356 
__gwch¬_t
 **

357 
__»¡riù
 
__’d±r
,

358 
__ba£
, 
__group
)

359 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

361 
__ex‹º_šlše
 
uštmax_t


362 
	`__NTH
 (
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

363 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

365  
	`__wc¡oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

366 
	}
}

370 
__ex‹nsiÚ__


371 
	$__¡¹Şl_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

372 **
__»¡riù
 
__’d±r
,

373 
__ba£
, 
__group
)

374 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

376 
__ex‹º_šlše
 
štmax_t


377 
	`__NTH
 (
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

378 
ba£
))

380  
	`__¡¹Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

381 
	}
}

383 
__ex‹nsiÚ__


384 
	$__¡¹ouÎ_š‹º®
 (const *

385 
__»¡riù
 
__ÅŒ
,

387 
__»¡riù
 
__’d±r
,

388 
__ba£
,

389 
__group
)

390 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

392 
__ex‹º_šlše
 
uštmax_t


393 
	`__NTH
 (
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

394 
ba£
))

396  
	`__¡¹ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

397 
	}
}

399 
__ex‹nsiÚ__


400 
	$__wc¡Şl_š‹º®
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

401 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

402 
__ba£
, 
__group
)

403 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

405 
__ex‹º_šlše
 
štmax_t


406 
	`__NTH
 (
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

407 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

409  
	`__wc¡Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

410 
	}
}

413 
__ex‹nsiÚ__


414 
	$__wc¡ouÎ_š‹º®
 (cÚ¡ 
__gwch¬_t
 *

415 
__»¡riù
 
__ÅŒ
,

416 
__gwch¬_t
 **

417 
__»¡riù
 
__’d±r
,

418 
__ba£
,

419 
__group
)

420 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

422 
__ex‹º_šlše
 
uštmax_t


423 
	`__NTH
 (
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

424 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

426  
	`__wc¡ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

427 
	}
}

432 
	g__END_DECLS


	@/usr/include/limits.h

22 #iâdeà
_LIBC_LIMITS_H_


23 
	#_LIBC_LIMITS_H_
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<b™s/libc-h—d”-¡¬t.h
>

32 
	#MB_LEN_MAX
 16

	)

37 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

42 #iâdeà
_LIMITS_H


43 
	#_LIMITS_H
 1

	)

45 
	~<b™s/wÜdsize.h
>

54 
	#CHAR_BIT
 8

	)

57 
	#SCHAR_MIN
 (-128)

	)

58 
	#SCHAR_MAX
 127

	)

61 
	#UCHAR_MAX
 255

	)

64 #ifdeà
__CHAR_UNSIGNED__


65 
	#CHAR_MIN
 0

	)

66 
	#CHAR_MAX
 
UCHAR_MAX


	)

68 
	#CHAR_MIN
 
SCHAR_MIN


	)

69 
	#CHAR_MAX
 
SCHAR_MAX


	)

73 
	#SHRT_MIN
 (-32768)

	)

74 
	#SHRT_MAX
 32767

	)

77 
	#USHRT_MAX
 65535

	)

80 
	#INT_MIN
 (-
INT_MAX
 - 1)

	)

81 
	#INT_MAX
 2147483647

	)

84 
	#UINT_MAX
 4294967295U

	)

87 #ià
__WORDSIZE
 == 64

88 
	#LONG_MAX
 9223372036854775807L

	)

90 
	#LONG_MAX
 2147483647L

	)

92 
	#LONG_MIN
 (-
LONG_MAX
 - 1L)

	)

95 #ià
__WORDSIZE
 == 64

96 
	#ULONG_MAX
 18446744073709551615UL

	)

98 
	#ULONG_MAX
 4294967295UL

	)

101 #ifdeà
__USE_ISOC99


104 
	#LLONG_MAX
 9223372036854775807LL

	)

105 
	#LLONG_MIN
 (-
LLONG_MAX
 - 1LL)

	)

108 
	#ULLONG_MAX
 18446744073709551615ULL

	)

122 #ià
defšed
 
__GNUC__
 && !defšed 
_GCC_LIMITS_H_


124 #šşude_Ãxˆ<
lim™s
.
h
>

130 #ià
defšed
 
__USE_ISOC99
 && defšed 
__GNUC__


131 #iâdeà
LLONG_MIN


132 
	#LLONG_MIN
 (-
LLONG_MAX
-1)

	)

134 #iâdeà
LLONG_MAX


135 
	#LLONG_MAX
 
__LONG_LONG_MAX__


	)

137 #iâdeà
ULLONG_MAX


138 
	#ULLONG_MAX
 (
LLONG_MAX
 * 2ULL + 1)

	)

145 #ià
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

146 #iâdeà
CHAR_WIDTH


147 
	#CHAR_WIDTH
 8

	)

149 #iâdeà
SCHAR_WIDTH


150 
	#SCHAR_WIDTH
 8

	)

152 #iâdeà
UCHAR_WIDTH


153 
	#UCHAR_WIDTH
 8

	)

155 #iâdeà
SHRT_WIDTH


156 
	#SHRT_WIDTH
 16

	)

158 #iâdeà
USHRT_WIDTH


159 
	#USHRT_WIDTH
 16

	)

161 #iâdeà
INT_WIDTH


162 
	#INT_WIDTH
 32

	)

164 #iâdeà
UINT_WIDTH


165 
	#UINT_WIDTH
 32

	)

167 #iâdeà
LONG_WIDTH


168 
	#LONG_WIDTH
 
__WORDSIZE


	)

170 #iâdeà
ULONG_WIDTH


171 
	#ULONG_WIDTH
 
__WORDSIZE


	)

173 #iâdeà
LLONG_WIDTH


174 
	#LLONG_WIDTH
 64

	)

176 #iâdeà
ULLONG_WIDTH


177 
	#ULLONG_WIDTH
 64

	)

181 #ifdef 
__USE_POSIX


183 
	~<b™s/posix1_lim.h
>

186 #ifdef 
__USE_POSIX2


187 
	~<b™s/posix2_lim.h
>

190 #ifdef 
__USE_XOPEN


191 
	~<b™s/xİ’_lim.h
>

	@/usr/include/malloc.h

19 #iâdeà
_MALLOC_H


20 
	#_MALLOC_H
 1

	)

22 
	~<ã©u»s.h
>

23 
	~<¡ddef.h
>

24 
	~<¡dio.h
>

26 #ifdeà
_LIBC


27 
	#__MALLOC_HOOK_VOLATILE


	)

28 
	#__MALLOC_DEPRECATED


	)

30 
	#__MALLOC_HOOK_VOLATILE
 vŞ©e

	)

31 
	#__MALLOC_DEPRECATED
 
__©Œibu‹_d•»ÿ‹d__


	)

35 
__BEGIN_DECLS


38 *
	$m®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

41 *
	$ÿÎoc
 (
size_t
 
__nmemb
, size_ˆ
__size
)

42 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

49 *
	$»®loc
 (*
__±r
, 
size_t
 
__size
)

50 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

57 *
	$»®loÿ¼ay
 (*
__±r
, 
size_t
 
__nmemb
, size_ˆ
__size
)

58 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

61 
	$ä“
 (*
__±r
è
__THROW
;

64 *
	$mem®ign
 (
size_t
 
__®ignm’t
, size_ˆ
__size
)

65 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

68 *
	$v®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

72 *
	$pv®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

76 *(*
__mÜecÜe
è(
±rdiff_t
 
__size
);

79 *
	$__deçuÉ_mÜecÜe
 (
±rdiff_t
 
__size
)

80 
__THROW
 
__©Œibu‹_m®loc__
;

84 
	sm®lšfo


86 
¬’a
;

87 
Üdblks
;

88 
smblks
;

89 
hblks
;

90 
hblkhd
;

91 
usmblks
;

92 
fsmblks
;

93 
uÜdblks
;

94 
fÜdblks
;

95 
k“pco¡
;

99 
m®lšfo
 
	$m®lšfo
 (è
__THROW
;

102 #iâdeà
M_MXFAST


103 
	#M_MXFAST
 1

	)

105 #iâdeà
M_NLBLKS


106 
	#M_NLBLKS
 2

	)

108 #iâdeà
M_GRAIN


109 
	#M_GRAIN
 3

	)

111 #iâdeà
M_KEEP


112 
	#M_KEEP
 4

	)

116 
	#M_TRIM_THRESHOLD
 -1

	)

117 
	#M_TOP_PAD
 -2

	)

118 
	#M_MMAP_THRESHOLD
 -3

	)

119 
	#M_MMAP_MAX
 -4

	)

120 
	#M_CHECK_ACTION
 -5

	)

121 
	#M_PERTURB
 -6

	)

122 
	#M_ARENA_TEST
 -7

	)

123 
	#M_ARENA_MAX
 -8

	)

126 
	$m®lİt
 (
__·¿m
, 
__v®
è
__THROW
;

130 
	$m®loc_Œim
 (
size_t
 
__·d
è
__THROW
;

134 
size_t
 
	$m®loc_u§bË_size
 (*
__±r
è
__THROW
;

137 
	$m®loc_¡©s
 (è
__THROW
;

140 
	$m®loc_šfo
 (
__İtiÚs
, 
FILE
 *
__å
è
__THROW
;

143 (*
__MALLOC_HOOK_VOLATILE
 
__ä“_hook
è(*
__±r
,

145 
__MALLOC_DEPRECATED
;

146 *(*
__MALLOC_HOOK_VOLATILE
 
__m®loc_hook
)(
size_t
 
__size
,

148 
__MALLOC_DEPRECATED
;

149 *(*
__MALLOC_HOOK_VOLATILE
 
__»®loc_hook
)(*
__±r
,

150 
size_t
 
__size
,

152 
__MALLOC_DEPRECATED
;

153 *(*
__MALLOC_HOOK_VOLATILE
 
__mem®ign_hook
)(
size_t
 
__®ignm’t
,

154 
size_t
 
__size
,

156 
__MALLOC_DEPRECATED
;

157 (*
__MALLOC_HOOK_VOLATILE
 
__aá”_mÜecÜe_hook
) ();

160 
	$__m®loc_check_š™
 (è
__THROW
 
__MALLOC_DEPRECATED
;

163 
__END_DECLS


	@/usr/include/math.h

23 #iâdef 
_MATH_H


24 
	#_MATH_H
 1

	)

26 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

27 
	~<b™s/libc-h—d”-¡¬t.h
>

29 #ià
defšed
 
log
 && defšed 
__GNUC__


30 #w¬nšg 
A
 
maüo
 
ÿÎed
 
log
 
was
 
®»ady
 
defšed
 
wh’
 <
m©h
.
h
> wa 
šşuded
.

31 #w¬nšg 
This
 
wl
 
ÿu£
 
comp©iÚ
 
´obËms
.

34 
	g__BEGIN_DECLS


37 
	~<b™s/ty³s.h
>

40 
	~<b™s/m©h-veùÜ.h
>

43 
	~<b™s/æßŠ.h
>

47 #ià
__GNUC_PREREQ
 (3, 3)

48 
	#HUGE_VAL
 (
	`__butš_huge_v®
 ())

	)

55 
	#HUGE_VAL
 1e10000

	)

57 #ifdeà
__USE_ISOC99


58 #ià
__GNUC_PREREQ
 (3, 3)

59 
	#HUGE_VALF
 (
	`__butš_huge_v®f
 ())

	)

60 
	#HUGE_VALL
 (
	`__butš_huge_v®l
 ())

	)

62 
	#HUGE_VALF
 1e10000f

	)

63 
	#HUGE_VALL
 1e10000L

	)

66 #ià
__HAVE_FLOAT16
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

67 
	#HUGE_VAL_F16
 (
	`__butš_huge_v®f16
 ())

	)

69 #ià
__HAVE_FLOAT32
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

70 
	#HUGE_VAL_F32
 (
	`__butš_huge_v®f32
 ())

	)

72 #ià
__HAVE_FLOAT64
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

73 
	#HUGE_VAL_F64
 (
	`__butš_huge_v®f64
 ())

	)

75 #ià
__HAVE_FLOAT128
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

76 
	#HUGE_VAL_F128
 (
	`__butš_huge_v®f128
 ())

	)

78 #ià
__HAVE_FLOAT32X
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

79 
	#HUGE_VAL_F32X
 (
	`__butš_huge_v®f32x
 ())

	)

81 #ià
__HAVE_FLOAT64X
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

82 
	#HUGE_VAL_F64X
 (
	`__butš_huge_v®f64x
 ())

	)

84 #ià
__HAVE_FLOAT128X
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

85 
	#HUGE_VAL_F128X
 (
	`__butš_huge_v®f128x
 ())

	)

88 #ifdeà
__USE_ISOC99


90 #ià
__GNUC_PREREQ
 (3, 3)

91 
	#INFINITY
 (
	`__butš_šff
 ())

	)

93 
	#INFINITY
 
HUGE_VALF


	)

97 #ià
__GNUC_PREREQ
 (3, 3)

98 
	#NAN
 (
	`__butš_Çnf
 (""))

	)

103 
	#NAN
 (0.0à/ 0.0f)

	)

107 #ià
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

109 #ià
__GNUC_PREREQ
 (3, 3)

110 
	#SNANF
 (
	`__butš_Çnsf
 (""))

	)

111 
	#SNAN
 (
	`__butš_Çns
 (""))

	)

112 
	#SNANL
 (
	`__butš_Çn¦
 (""))

	)

115 #ià
__HAVE_FLOAT16
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

116 
	#SNANF16
 (
	`__butš_Çnsf16
 (""))

	)

118 #ià
__HAVE_FLOAT32
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

119 
	#SNANF32
 (
	`__butš_Çnsf32
 (""))

	)

121 #ià
__HAVE_FLOAT64
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

122 
	#SNANF64
 (
	`__butš_Çnsf64
 (""))

	)

124 #ià
__HAVE_FLOAT128
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

125 
	#SNANF128
 (
	`__butš_Çnsf128
 (""))

	)

127 #ià
__HAVE_FLOAT32X
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

128 
	#SNANF32X
 (
	`__butš_Çnsf32x
 (""))

	)

130 #ià
__HAVE_FLOAT64X
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

131 
	#SNANF64X
 (
	`__butš_Çnsf64x
 (""))

	)

133 #ià
__HAVE_FLOAT128X
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

134 
	#SNANF128X
 (
	`__butš_Çnsf128x
 (""))

	)

138 
	~<b™s/æt-ev®-m‘hod.h
>

140 #ifdeà
__USE_ISOC99


148 #ià
__GLIBC_FLT_EVAL_METHOD
 == 0 || __GLIBC_FLT_EVAL_METHOD == 16

149 
	tæßt_t
;

150 
	tdoubË_t
;

151 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 1

152 
	tæßt_t
;

153 
	tdoubË_t
;

154 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 2

155 
	tæßt_t
;

156 
	tdoubË_t
;

157 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 32

158 
_Flßt32
 
	tæßt_t
;

159 
	tdoubË_t
;

160 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 33

161 
_Flßt32x
 
	tæßt_t
;

162 
_Flßt32x
 
	tdoubË_t
;

163 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 64

164 
_Flßt64
 
	tæßt_t
;

165 
_Flßt64
 
	tdoubË_t
;

166 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 65

167 
_Flßt64x
 
	tæßt_t
;

168 
_Flßt64x
 
	tdoubË_t
;

169 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 128

170 
_Flßt128
 
	tæßt_t
;

171 
_Flßt128
 
	tdoubË_t
;

172 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 129

173 
_Flßt128x
 
	tæßt_t
;

174 
_Flßt128x
 
	tdoubË_t
;

190 
	~<b™s/å-logb.h
>

191 #ifdeà
__USE_ISOC99


192 #ià
__FP_LOGB0_IS_MIN


193 
	#FP_ILOGB0
 (-2147483647 - 1)

	)

195 
	#FP_ILOGB0
 (-2147483647)

	)

197 #ià
__FP_LOGBNAN_IS_MIN


198 
	#FP_ILOGBNAN
 (-2147483647 - 1)

	)

200 
	#FP_ILOGBNAN
 2147483647

	)

203 #ià
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

204 #ià
__WORDSIZE
 == 32

205 
	#__FP_LONG_MAX
 0x7fffffffL

	)

207 
	#__FP_LONG_MAX
 0x7fffffffffffffffL

	)

209 #ià
__FP_LOGB0_IS_MIN


210 
	#FP_LLOGB0
 (-
__FP_LONG_MAX
 - 1)

	)

212 
	#FP_LLOGB0
 (-
__FP_LONG_MAX
)

	)

214 #ià
__FP_LOGBNAN_IS_MIN


215 
	#FP_LLOGBNAN
 (-
__FP_LONG_MAX
 - 1)

	)

217 
	#FP_LLOGBNAN
 
__FP_LONG_MAX


	)

233 
	~<b™s/å-ç¡.h
>

235 #ià
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

239 
	mFP_INT_UPWARD
 =

240 
	#FP_INT_UPWARD
 0

	)

241 
FP_INT_UPWARD
,

242 
	mFP_INT_DOWNWARD
 =

243 
	#FP_INT_DOWNWARD
 1

	)

244 
FP_INT_DOWNWARD
,

245 
	mFP_INT_TOWARDZERO
 =

246 
	#FP_INT_TOWARDZERO
 2

	)

247 
FP_INT_TOWARDZERO
,

248 
	mFP_INT_TONEARESTFROMZERO
 =

249 
	#FP_INT_TONEARESTFROMZERO
 3

	)

250 
FP_INT_TONEARESTFROMZERO
,

251 
	mFP_INT_TONEAREST
 =

252 
	#FP_INT_TONEAREST
 4

	)

253 
FP_INT_TONEAREST
,

262 
	#__SIMD_DECL
(
funùiÚ
è
	`__CONCAT
 (
__DECL_SIMD_
, funùiÚ)

	)

264 
	#__MATHCALL_VEC
(
funùiÚ
, 
suffix
, 
¬gs
) \

265 
	`__SIMD_DECL
 (
	`__MATH_PRECNAME
 (
funùiÚ
, 
suffix
)) \

266 
	`__MATHCALL
 (
funùiÚ
, 
suffix
, 
¬gs
)

	)

268 
	#__MATHDECL_VEC
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

269 
	`__SIMD_DECL
 (
	`__MATH_PRECNAME
 (
funùiÚ
, 
suffix
)) \

270 
	`__MATHDECL
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
)

	)

272 
	#__MATHCALL
(
funùiÚ
,
suffix
, 
¬gs
) \

273 
	`__MATHDECL
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
)

	)

274 
	#__MATHDECL
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

275 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
); \

276 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
)

	)

277 
	#__MATHCALLX
(
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

278 
	`__MATHDECLX
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
)

	)

279 
	#__MATHDECLX
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

280 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
); \

281 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
)

	)

282 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

283 
ty³
 
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
è
¬gs
 
__THROW


	)

285 
	#_MdoubË_
 

	)

286 
	#__MATH_PRECNAME
(
Çme
,
r
è
	`__CONCAT
Òame,r)

	)

287 
	#__MATH_DECLARING_DOUBLE
 1

	)

288 
	#__MATH_DECLARING_FLOATN
 0

	)

289 
	~<b™s/m©hÿÎs-h–³r-funùiÚs.h
>

290 
	~<b™s/m©hÿÎs.h
>

291 #undeà
_MdoubË_


292 #undeà
__MATH_PRECNAME


293 #undeà
__MATH_DECLARING_DOUBLE


294 #undeà
__MATH_DECLARING_FLOATN


296 #ifdeà
__USE_ISOC99


302 
	#_MdoubË_
 

	)

303 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f
##
	)
r

304 
	#__MATH_DECLARING_DOUBLE
 0

	)

305 
	#__MATH_DECLARING_FLOATN
 0

	)

306 
	~<b™s/m©hÿÎs-h–³r-funùiÚs.h
>

307 
	~<b™s/m©hÿÎs.h
>

308 #undeà
_MdoubË_


309 #undeà
__MATH_PRECNAME


310 #undeà
__MATH_DECLARING_DOUBLE


311 #undeà
__MATH_DECLARING_FLOATN


313 #ià!(
defšed
 
__NO_LONG_DOUBLE_MATH
 && defšed 
_LIBC
) \

314 || 
defšed
 
__LDBL_COMPAT
 \

315 || 
defšed
 
_LIBC_TEST


316 #ifdeà
__LDBL_COMPAT


318 #ifdeà
__USE_ISOC99


319 
	$__Ædbl_Ãx‰ow¬df
 (
__x
, 
__y
)

320 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

321 #ifdeà
__REDIRECT_NTH


322 
	`__REDIRECT_NTH
 (
Ãx‰ow¬df
, (
__x
, 
__y
),

323 
__Ædbl_Ãx‰ow¬df
)

324 
	`__©Œibu‹__
 ((
__cÚ¡__
));

325 
	`__REDIRECT_NTH
 (
Ãx‰ow¬d
, (
__x
, 
__y
),

326 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

327 
	`__REDIRECT_NTH
 (
Ãx‰ow¬dl
,

328 (
__x
, 
__y
),

329 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

333 #undeà
__MATHDECL_1


334 
	#__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
®Ÿs
) \

335 
ty³
 
	`__REDIRECT_NTH
(
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
), \

336 
¬gs
, 
®Ÿs
)

	)

337 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

338 
	`__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
	`__CONCAT
(funùiÚ,suffix))

	)

344 
	#_MdoubË_
 

	)

345 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
l
##
	)
r

346 
	#__MATH_DECLARING_DOUBLE
 0

	)

347 
	#__MATH_DECLARING_FLOATN
 0

	)

348 
	#__MATH_DECLARE_LDOUBLE
 1

	)

349 
	~<b™s/m©hÿÎs-h–³r-funùiÚs.h
>

350 
	~<b™s/m©hÿÎs.h
>

351 #undeà
_MdoubË_


352 #undeà
__MATH_PRECNAME


353 #undeà
__MATH_DECLARING_DOUBLE


354 #undeà
__MATH_DECLARING_FLOATN


363 #ià
__HAVE_DISTINCT_FLOAT16
 || (
__HAVE_FLOAT16
 && !
defšed
 
_LIBC
)

364 
	#_MdoubË_
 
_Flßt16


	)

365 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f16
##
	)
r

366 
	#__MATH_DECLARING_DOUBLE
 0

	)

367 
	#__MATH_DECLARING_FLOATN
 1

	)

368 #ià
__HAVE_DISTINCT_FLOAT16


369 
	~<b™s/m©hÿÎs-h–³r-funùiÚs.h
>

371 #ià
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

372 
	~<b™s/m©hÿÎs.h
>

374 #undeà
_MdoubË_


375 #undeà
__MATH_PRECNAME


376 #undeà
__MATH_DECLARING_DOUBLE


377 #undeà
__MATH_DECLARING_FLOATN


380 #ià
__HAVE_DISTINCT_FLOAT32
 || (
__HAVE_FLOAT32
 && !
defšed
 
_LIBC
)

381 
	#_MdoubË_
 
_Flßt32


	)

382 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f32
##
	)
r

383 
	#__MATH_DECLARING_DOUBLE
 0

	)

384 
	#__MATH_DECLARING_FLOATN
 1

	)

385 #ià
__HAVE_DISTINCT_FLOAT32


386 
	~<b™s/m©hÿÎs-h–³r-funùiÚs.h
>

388 #ià
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

389 
	~<b™s/m©hÿÎs.h
>

391 #undeà
_MdoubË_


392 #undeà
__MATH_PRECNAME


393 #undeà
__MATH_DECLARING_DOUBLE


394 #undeà
__MATH_DECLARING_FLOATN


397 #ià
__HAVE_DISTINCT_FLOAT64
 || (
__HAVE_FLOAT64
 && !
defšed
 
_LIBC
)

398 
	#_MdoubË_
 
_Flßt64


	)

399 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f64
##
	)
r

400 
	#__MATH_DECLARING_DOUBLE
 0

	)

401 
	#__MATH_DECLARING_FLOATN
 1

	)

402 #ià
__HAVE_DISTINCT_FLOAT64


403 
	~<b™s/m©hÿÎs-h–³r-funùiÚs.h
>

405 #ià
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

406 
	~<b™s/m©hÿÎs.h
>

408 #undeà
_MdoubË_


409 #undeà
__MATH_PRECNAME


410 #undeà
__MATH_DECLARING_DOUBLE


411 #undeà
__MATH_DECLARING_FLOATN


414 #ià
__HAVE_DISTINCT_FLOAT128
 || (
__HAVE_FLOAT128
 && !
defšed
 
_LIBC
)

415 
	#_MdoubË_
 
_Flßt128


	)

416 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f128
##
	)
r

417 
	#__MATH_DECLARING_DOUBLE
 0

	)

418 
	#__MATH_DECLARING_FLOATN
 1

	)

419 #ià
__HAVE_DISTINCT_FLOAT128


420 
	~<b™s/m©hÿÎs-h–³r-funùiÚs.h
>

422 #ià
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

423 
	~<b™s/m©hÿÎs.h
>

425 #undeà
_MdoubË_


426 #undeà
__MATH_PRECNAME


427 #undeà
__MATH_DECLARING_DOUBLE


428 #undeà
__MATH_DECLARING_FLOATN


431 #ià
__HAVE_DISTINCT_FLOAT32X
 || (
__HAVE_FLOAT32X
 && !
defšed
 
_LIBC
)

432 
	#_MdoubË_
 
_Flßt32x


	)

433 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f32x
##
	)
r

434 
	#__MATH_DECLARING_DOUBLE
 0

	)

435 
	#__MATH_DECLARING_FLOATN
 1

	)

436 #ià
__HAVE_DISTINCT_FLOAT32X


437 
	~<b™s/m©hÿÎs-h–³r-funùiÚs.h
>

439 #ià
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

440 
	~<b™s/m©hÿÎs.h
>

442 #undeà
_MdoubË_


443 #undeà
__MATH_PRECNAME


444 #undeà
__MATH_DECLARING_DOUBLE


445 #undeà
__MATH_DECLARING_FLOATN


448 #ià
__HAVE_DISTINCT_FLOAT64X
 || (
__HAVE_FLOAT64X
 && !
defšed
 
_LIBC
)

449 
	#_MdoubË_
 
_Flßt64x


	)

450 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f64x
##
	)
r

451 
	#__MATH_DECLARING_DOUBLE
 0

	)

452 
	#__MATH_DECLARING_FLOATN
 1

	)

453 #ià
__HAVE_DISTINCT_FLOAT64X


454 
	~<b™s/m©hÿÎs-h–³r-funùiÚs.h
>

456 #ià
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

457 
	~<b™s/m©hÿÎs.h
>

459 #undeà
_MdoubË_


460 #undeà
__MATH_PRECNAME


461 #undeà
__MATH_DECLARING_DOUBLE


462 #undeà
__MATH_DECLARING_FLOATN


465 #ià
__HAVE_DISTINCT_FLOAT128X
 || (
__HAVE_FLOAT128X
 && !
defšed
 
_LIBC
)

466 
	#_MdoubË_
 
_Flßt128x


	)

467 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f128x
##
	)
r

468 
	#__MATH_DECLARING_DOUBLE
 0

	)

469 
	#__MATH_DECLARING_FLOATN
 1

	)

470 #ià
__HAVE_DISTINCT_FLOAT128X


471 
	~<b™s/m©hÿÎs-h–³r-funùiÚs.h
>

473 #ià
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

474 
	~<b™s/m©hÿÎs.h
>

476 #undeà
_MdoubË_


477 #undeà
__MATH_PRECNAME


478 #undeà
__MATH_DECLARING_DOUBLE


479 #undeà
__MATH_DECLARING_FLOATN


482 #undeà
__MATHDECL_1


483 #undeà
__MATHDECL


484 #undeà
__MATHCALL


487 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


489 
signgam
;

492 #ià(
__HAVE_DISTINCT_FLOAT16
 \

493 || 
__HAVE_DISTINCT_FLOAT32
 \

494 || 
__HAVE_DISTINCT_FLOAT64
 \

495 || 
__HAVE_DISTINCT_FLOAT32X
 \

496 || 
__HAVE_DISTINCT_FLOAT64X
 \

497 || 
__HAVE_DISTINCT_FLOAT128X
)

510 #ifdeà
__NO_LONG_DOUBLE_MATH


511 #ià
__HAVE_DISTINCT_FLOAT128


514 
	#__MATH_TG
(
TG_ARG
, 
FUNC
, 
ARGS
) \

515 ( (
TG_ARG
è=ğ (è? 
FUNC
 ## 
f
 
ARGS
 : FUNC ARGS)

	)

516 #–ià
__HAVE_DISTINCT_FLOAT128


517 #ià
__HAVE_GENERIC_SELECTION


518 #ià
__HAVE_FLOATN_NOT_TYPEDEF
 && 
__HAVE_FLOAT32


519 
	#__MATH_TG_F32
(
FUNC
, 
ARGS
è
_Flßt32
: FUNC ## 
f
 ARGS,

	)

521 
	#__MATH_TG_F32
(
FUNC
, 
ARGS
)

	)

523 #ià
__HAVE_FLOATN_NOT_TYPEDEF
 && 
__HAVE_FLOAT64X


524 #ià
__HAVE_FLOAT64X_LONG_DOUBLE


525 
	#__MATH_TG_F64X
(
FUNC
, 
ARGS
è
_Flßt64x
: FUNC ## 
l
 ARGS,

	)

527 
	#__MATH_TG_F64X
(
FUNC
, 
ARGS
è
_Flßt64x
: FUNC ## 
f128
 ARGS,

	)

530 
	#__MATH_TG_F64X
(
FUNC
, 
ARGS
)

	)

532 
	#__MATH_TG
(
TG_ARG
, 
FUNC
, 
ARGS
) \

533 
	`_G’”ic
 ((
TG_ARG
), \

534 : 
FUNC
 ## 
f
 
ARGS
, \

535 
	`__MATH_TG_F32
 (
FUNC
, 
ARGS
) \

536 : 
FUNC
 
ARGS
, \

537 : 
FUNC
 ## 
l
 
ARGS
, \

538 
	`__MATH_TG_F64X
 (
FUNC
, 
ARGS
) \

539 
_Flßt128
: 
FUNC
 ## 
f128
 
ARGS
)

	)

541 #ià
__HAVE_FLOATN_NOT_TYPEDEF


544 
	#__MATH_TG
(
TG_ARG
, 
FUNC
, 
ARGS
) \

545 
__butš_choo£_ex´
 \

546 (
	`__butš_ty³s_com·tibË_p
 (
	`__ty³of
 (
TG_ARG
), ), \

547 
FUNC
 ## 
f
 
ARGS
, \

548 
__butš_choo£_ex´
 \

549 (
	`__butš_ty³s_com·tibË_p
 (
	`__ty³of
 (
TG_ARG
), ), \

550 
FUNC
 
ARGS
, \

551 
__butš_choo£_ex´
 \

552 (
	`__butš_ty³s_com·tibË_p
 (
	`__ty³of
 (
TG_ARG
), ), \

553 
FUNC
 ## 
l
 
ARGS
, \

554 
FUNC
 ## 
f128
 
ARGS
)))

	)

557 
	#__MATH_TG
(
TG_ARG
, 
FUNC
, 
ARGS
) \

558 ( (
TG_ARG
) ==  () \

559 ? 
FUNC
 ## 
f
 
ARGS
 \

560 :  (
TG_ARG
) ==  () \

561 ? 
FUNC
 
ARGS
 \

562 : 
FUNC
 ## 
l
 
ARGS
)

	)

566 #ifdeà
__USE_ISOC99


571 
FP_NAN
 =

572 
	#FP_NAN
 0

	)

573 
FP_NAN
,

574 
FP_INFINITE
 =

575 
	#FP_INFINITE
 1

	)

576 
FP_INFINITE
,

577 
FP_ZERO
 =

578 
	#FP_ZERO
 2

	)

579 
FP_ZERO
,

580 
FP_SUBNORMAL
 =

581 
	#FP_SUBNORMAL
 3

	)

582 
FP_SUBNORMAL
,

583 
FP_NORMAL
 =

584 
	#FP_NORMAL
 4

	)

585 
FP_NORMAL


593 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__
 \

594 && (!
defšed
 
__OPTIMIZE_SIZE__
 || defšed 
__ılu¥lus
)

601 
	#åşassify
(
x
è
	`__butš_åşassify
 (
FP_NAN
, 
FP_INFINITE
, \

602 
FP_NORMAL
, 
FP_SUBNORMAL
, 
FP_ZERO
, 
x
)

	)

604 
	#åşassify
(
x
è
	`__MATH_TG
 ((x), 
__åşassify
, (x))

	)

608 #ià
	`__GNUC_PREREQ
 (6,0)

609 
	#signb™
(
x
è
	`__butš_signb™
 (x)

	)

610 #–ià
defšed
 
__ılu¥lus


618 
	#signb™
(
x
è
	`__butš_signb™l
 (x)

	)

619 #–ià
	`__GNUC_PREREQ
 (4,0)

620 
	#signb™
(
x
è
	`__MATH_TG
 ((x), 
__butš_signb™
, (x))

	)

622 
	#signb™
(
x
è
	`__MATH_TG
 ((x), 
__signb™
, (x))

	)

626 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


627 
	#isfš™e
(
x
è
	`__butš_isfš™e
 (x)

	)

629 
	#isfš™e
(
x
è
	`__MATH_TG
 ((x), 
__fš™e
, (x))

	)

633 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


634 
	#i¢Üm®
(
x
è
	`__butš_i¢Üm®
 (x)

	)

636 
	#i¢Üm®
(
x
è(
	`åşassify
 (xè=ğ
FP_NORMAL
)

	)

641 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


642 
	#i¢ª
(
x
è
	`__butš_i¢ª
 (x)

	)

644 
	#i¢ª
(
x
è
	`__MATH_TG
 ((x), 
__i¢ª
, (x))

	)

648 #ià
__HAVE_DISTINCT_FLOAT128
 && !
	`__GNUC_PREREQ
 (7,0) \

649 && !
defšed
 
__SUPPORT_SNAN__
 && !defšed 
__ılu¥lus


655 
	#isšf
(
x
) \

656 (
	`__butš_ty³s_com·tibË_p
 (
	`__ty³of
 (
x
), 
_Flßt128
) \

657 ? 
	`__isšff128
 (
x
è: 
	`__butš_isšf_sign
 (x))

	)

658 #–ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


659 
	#isšf
(
x
è
	`__butš_isšf_sign
 (x)

	)

661 
	#isšf
(
x
è
	`__MATH_TG
 ((x), 
__isšf
, (x))

	)

665 
	#MATH_ERRNO
 1

	)

666 
	#MATH_ERREXCEPT
 2

	)

673 #ifdeà
__FAST_MATH__


674 
	#m©h_”rhªdlšg
 0

	)

675 #–ià
defšed
 
__NO_MATH_ERRNO__


676 
	#m©h_”rhªdlšg
 (
MATH_ERREXCEPT
)

	)

678 
	#m©h_”rhªdlšg
 (
MATH_ERRNO
 | 
MATH_ERREXCEPT
)

	)

683 #ià
	`__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

684 
	~<b™s/isÿnÚiÿl.h
>

687 #iâdeà
__ılu¥lus


688 
	#issigÇlšg
(
x
è
	`__MATH_TG
 ((x), 
__issigÇlšg
, (x))

	)

697 
šlše
 
	`issigÇlšg
 (
__v®
è{  
	`__issigÇlšgf
 (__val); }

698 
šlše
 
	`issigÇlšg
 (
__v®
è{  
	`__issigÇlšg
 (__val); }

699 
šlše
 

700 
	`issigÇlšg
 (
__v®
)

702 #ifdeà
__NO_LONG_DOUBLE_MATH


703  
	`__issigÇlšg
 (
__v®
);

705  
	`__issigÇlšgl
 (
__v®
);

708 #ià
__HAVE_DISTINCT_FLOAT128


709 
šlše
 
	`issigÇlšg
 (
_Flßt128
 
__v®
è{  
	`__issigÇlšgf128
 (__val); }

711 
	}
}

715 
	#issubnÜm®
(
x
è(
	`åşassify
 (xè=ğ
FP_SUBNORMAL
)

	)

718 #iâdeà
__ılu¥lus


719 #ifdeà
__SUPPORT_SNAN__


720 
	#isz”o
(
x
è(
	`åşassify
 (xè=ğ
FP_ZERO
)

	)

722 
	#isz”o
(
x
è(((
	`__ty³of
 (x)è(x)è=ğ0)

	)

726 #ifdeà
__SUPPORT_SNAN__


727 
šlše
 

728 
isz”o
 (
__v®
)

730  
__åşassifyf
 (
__v®
è=ğ
FP_ZERO
;

732 
šlše
 

733 
isz”o
 (
__v®
)

735  
__åşassify
 (
__v®
è=ğ
FP_ZERO
;

737 
šlše
 

738 
isz”o
 (
__v®
)

740 #ifdeà
__NO_LONG_DOUBLE_MATH


741  
__åşassify
 (
__v®
è=ğ
FP_ZERO
;

743  
__åşassifyl
 (
__v®
è=ğ
FP_ZERO
;

746 #ià
__HAVE_DISTINCT_FLOAT128


747 
šlše
 

748 
isz”o
 (
_Flßt128
 
__v®
)

750  
__åşassifyf128
 (
__v®
è=ğ
FP_ZERO
;

754 
‹m¶©e
 <
şass
 
__T
> 
šlše
 
boŞ


755 
isz”o
 (
__T
 
__v®
)

757  
__v®
 == 0;

764 #ifdeà
__USE_XOPEN


766 
	#MAXFLOAT
 3.40282347e+38F

	)

771 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


772 
	#M_E
 2.7182818284590452354

	)

773 
	#M_LOG2E
 1.4426950408889634074

	)

774 
	#M_LOG10E
 0.43429448190325182765

	)

775 
	#M_LN2
 0.69314718055994530942

	)

776 
	#M_LN10
 2.30258509299404568402

	)

777 
	#M_PI
 3.14159265358979323846

	)

778 
	#M_PI_2
 1.57079632679489661923

	)

779 
	#M_PI_4
 0.78539816339744830962

	)

780 
	#M_1_PI
 0.31830988618379067154

	)

781 
	#M_2_PI
 0.63661977236758134308

	)

782 
	#M_2_SQRTPI
 1.12837916709551257390

	)

783 
	#M_SQRT2
 1.41421356237309504880

	)

784 
	#M_SQRT1_2
 0.70710678118654752440

	)

790 #ifdeà
__USE_GNU


791 
	#M_El
 2.718281828459045235360287471352662498L

	)

792 
	#M_LOG2El
 1.442695040888963407359924681001892137L

	)

793 
	#M_LOG10El
 0.434294481903251827651128918916605082L

	)

794 
	#M_LN2l
 0.693147180559945309417232121458176568L

	)

795 
	#M_LN10l
 2.302585092994045684017991454684364208L

	)

796 
	#M_PIl
 3.141592653589793238462643383279502884L

	)

797 
	#M_PI_2l
 1.570796326794896619231321691639751442L

	)

798 
	#M_PI_4l
 0.785398163397448309615660845819875721L

	)

799 
	#M_1_PIl
 0.318309886183790671537767526745028724L

	)

800 
	#M_2_PIl
 0.636619772367581343075535053490057448L

	)

801 
	#M_2_SQRTPIl
 1.128379167095512573896158903121545172L

	)

802 
	#M_SQRT2l
 1.414213562373095048801688724209698079L

	)

803 
	#M_SQRT1_2l
 0.707106781186547524400844362104849039L

	)

806 #ià
__HAVE_FLOAT16
 && 
defšed
 
__USE_GNU


807 
	#M_Ef16
 
	`__f16
 (2.718281828459045235360287471352662498è

	)

808 
	#M_LOG2Ef16
 
	`__f16
 (1.442695040888963407359924681001892137è

	)

809 
	#M_LOG10Ef16
 
	`__f16
 (0.434294481903251827651128918916605082è

	)

810 
	#M_LN2f16
 
	`__f16
 (0.693147180559945309417232121458176568è

	)

811 
	#M_LN10f16
 
	`__f16
 (2.302585092994045684017991454684364208è

	)

812 
	#M_PIf16
 
	`__f16
 (3.141592653589793238462643383279502884è

	)

813 
	#M_PI_2f16
 
	`__f16
 (1.570796326794896619231321691639751442è

	)

814 
	#M_PI_4f16
 
	`__f16
 (0.785398163397448309615660845819875721è

	)

815 
	#M_1_PIf16
 
	`__f16
 (0.318309886183790671537767526745028724è

	)

816 
	#M_2_PIf16
 
	`__f16
 (0.636619772367581343075535053490057448è

	)

817 
	#M_2_SQRTPIf16
 
	`__f16
 (1.128379167095512573896158903121545172è

	)

818 
	#M_SQRT2f16
 
	`__f16
 (1.414213562373095048801688724209698079è

	)

819 
	#M_SQRT1_2f16
 
	`__f16
 (0.707106781186547524400844362104849039è

	)

822 #ià
__HAVE_FLOAT32
 && 
defšed
 
__USE_GNU


823 
	#M_Ef32
 
	`__f32
 (2.718281828459045235360287471352662498è

	)

824 
	#M_LOG2Ef32
 
	`__f32
 (1.442695040888963407359924681001892137è

	)

825 
	#M_LOG10Ef32
 
	`__f32
 (0.434294481903251827651128918916605082è

	)

826 
	#M_LN2f32
 
	`__f32
 (0.693147180559945309417232121458176568è

	)

827 
	#M_LN10f32
 
	`__f32
 (2.302585092994045684017991454684364208è

	)

828 
	#M_PIf32
 
	`__f32
 (3.141592653589793238462643383279502884è

	)

829 
	#M_PI_2f32
 
	`__f32
 (1.570796326794896619231321691639751442è

	)

830 
	#M_PI_4f32
 
	`__f32
 (0.785398163397448309615660845819875721è

	)

831 
	#M_1_PIf32
 
	`__f32
 (0.318309886183790671537767526745028724è

	)

832 
	#M_2_PIf32
 
	`__f32
 (0.636619772367581343075535053490057448è

	)

833 
	#M_2_SQRTPIf32
 
	`__f32
 (1.128379167095512573896158903121545172è

	)

834 
	#M_SQRT2f32
 
	`__f32
 (1.414213562373095048801688724209698079è

	)

835 
	#M_SQRT1_2f32
 
	`__f32
 (0.707106781186547524400844362104849039è

	)

838 #ià
__HAVE_FLOAT64
 && 
defšed
 
__USE_GNU


839 
	#M_Ef64
 
	`__f64
 (2.718281828459045235360287471352662498è

	)

840 
	#M_LOG2Ef64
 
	`__f64
 (1.442695040888963407359924681001892137è

	)

841 
	#M_LOG10Ef64
 
	`__f64
 (0.434294481903251827651128918916605082è

	)

842 
	#M_LN2f64
 
	`__f64
 (0.693147180559945309417232121458176568è

	)

843 
	#M_LN10f64
 
	`__f64
 (2.302585092994045684017991454684364208è

	)

844 
	#M_PIf64
 
	`__f64
 (3.141592653589793238462643383279502884è

	)

845 
	#M_PI_2f64
 
	`__f64
 (1.570796326794896619231321691639751442è

	)

846 
	#M_PI_4f64
 
	`__f64
 (0.785398163397448309615660845819875721è

	)

847 
	#M_1_PIf64
 
	`__f64
 (0.318309886183790671537767526745028724è

	)

848 
	#M_2_PIf64
 
	`__f64
 (0.636619772367581343075535053490057448è

	)

849 
	#M_2_SQRTPIf64
 
	`__f64
 (1.128379167095512573896158903121545172è

	)

850 
	#M_SQRT2f64
 
	`__f64
 (1.414213562373095048801688724209698079è

	)

851 
	#M_SQRT1_2f64
 
	`__f64
 (0.707106781186547524400844362104849039è

	)

854 #ià
__HAVE_FLOAT128
 && 
defšed
 
__USE_GNU


855 
	#M_Ef128
 
	`__f128
 (2.718281828459045235360287471352662498è

	)

856 
	#M_LOG2Ef128
 
	`__f128
 (1.442695040888963407359924681001892137è

	)

857 
	#M_LOG10Ef128
 
	`__f128
 (0.434294481903251827651128918916605082è

	)

858 
	#M_LN2f128
 
	`__f128
 (0.693147180559945309417232121458176568è

	)

859 
	#M_LN10f128
 
	`__f128
 (2.302585092994045684017991454684364208è

	)

860 
	#M_PIf128
 
	`__f128
 (3.141592653589793238462643383279502884è

	)

861 
	#M_PI_2f128
 
	`__f128
 (1.570796326794896619231321691639751442è

	)

862 
	#M_PI_4f128
 
	`__f128
 (0.785398163397448309615660845819875721è

	)

863 
	#M_1_PIf128
 
	`__f128
 (0.318309886183790671537767526745028724è

	)

864 
	#M_2_PIf128
 
	`__f128
 (0.636619772367581343075535053490057448è

	)

865 
	#M_2_SQRTPIf128
 
	`__f128
 (1.128379167095512573896158903121545172è

	)

866 
	#M_SQRT2f128
 
	`__f128
 (1.414213562373095048801688724209698079è

	)

867 
	#M_SQRT1_2f128
 
	`__f128
 (0.707106781186547524400844362104849039è

	)

870 #ià
__HAVE_FLOAT32X
 && 
defšed
 
__USE_GNU


871 
	#M_Ef32x
 
	`__f32x
 (2.718281828459045235360287471352662498è

	)

872 
	#M_LOG2Ef32x
 
	`__f32x
 (1.442695040888963407359924681001892137è

	)

873 
	#M_LOG10Ef32x
 
	`__f32x
 (0.434294481903251827651128918916605082è

	)

874 
	#M_LN2f32x
 
	`__f32x
 (0.693147180559945309417232121458176568è

	)

875 
	#M_LN10f32x
 
	`__f32x
 (2.302585092994045684017991454684364208è

	)

876 
	#M_PIf32x
 
	`__f32x
 (3.141592653589793238462643383279502884è

	)

877 
	#M_PI_2f32x
 
	`__f32x
 (1.570796326794896619231321691639751442è

	)

878 
	#M_PI_4f32x
 
	`__f32x
 (0.785398163397448309615660845819875721è

	)

879 
	#M_1_PIf32x
 
	`__f32x
 (0.318309886183790671537767526745028724è

	)

880 
	#M_2_PIf32x
 
	`__f32x
 (0.636619772367581343075535053490057448è

	)

881 
	#M_2_SQRTPIf32x
 
	`__f32x
 (1.128379167095512573896158903121545172è

	)

882 
	#M_SQRT2f32x
 
	`__f32x
 (1.414213562373095048801688724209698079è

	)

883 
	#M_SQRT1_2f32x
 
	`__f32x
 (0.707106781186547524400844362104849039è

	)

886 #ià
__HAVE_FLOAT64X
 && 
defšed
 
__USE_GNU


887 
	#M_Ef64x
 
	`__f64x
 (2.718281828459045235360287471352662498è

	)

888 
	#M_LOG2Ef64x
 
	`__f64x
 (1.442695040888963407359924681001892137è

	)

889 
	#M_LOG10Ef64x
 
	`__f64x
 (0.434294481903251827651128918916605082è

	)

890 
	#M_LN2f64x
 
	`__f64x
 (0.693147180559945309417232121458176568è

	)

891 
	#M_LN10f64x
 
	`__f64x
 (2.302585092994045684017991454684364208è

	)

892 
	#M_PIf64x
 
	`__f64x
 (3.141592653589793238462643383279502884è

	)

893 
	#M_PI_2f64x
 
	`__f64x
 (1.570796326794896619231321691639751442è

	)

894 
	#M_PI_4f64x
 
	`__f64x
 (0.785398163397448309615660845819875721è

	)

895 
	#M_1_PIf64x
 
	`__f64x
 (0.318309886183790671537767526745028724è

	)

896 
	#M_2_PIf64x
 
	`__f64x
 (0.636619772367581343075535053490057448è

	)

897 
	#M_2_SQRTPIf64x
 
	`__f64x
 (1.128379167095512573896158903121545172è

	)

898 
	#M_SQRT2f64x
 
	`__f64x
 (1.414213562373095048801688724209698079è

	)

899 
	#M_SQRT1_2f64x
 
	`__f64x
 (0.707106781186547524400844362104849039è

	)

902 #ià
__HAVE_FLOAT128X
 && 
defšed
 
__USE_GNU


909 #ià
defšed
 
__STRICT_ANSI__
 && !defšed 
__NO_MATH_INLINES


910 
	#__NO_MATH_INLINES
 1

	)

913 #ifdeà
__USE_ISOC99


914 #ià
__GNUC_PREREQ
 (3, 1)

921 
	#isg»©”
(
x
, 
y
è
	`__butš_isg»©”
(x, y)

	)

922 
	#isg»©”equ®
(
x
, 
y
è
	`__butš_isg»©”equ®
(x, y)

	)

923 
	#i¦ess
(
x
, 
y
è
	`__butš_i¦ess
(x, y)

	)

924 
	#i¦es£qu®
(
x
, 
y
è
	`__butš_i¦es£qu®
(x, y)

	)

925 
	#i¦essg»©”
(
x
, 
y
è
	`__butš_i¦essg»©”
(x, y)

	)

926 
	#isunÜd”ed
(
x
, 
y
è
	`__butš_isunÜd”ed
(x, y)

	)

928 
	#isg»©”
(
x
, 
y
) \

929 (
	`__ex‹nsiÚ__
 ({ 
	`__ty³of__
 (
x
è
__x
 = (x); __ty³of__ (
y
è
__y
 = (y); \

930 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x > __y; }))

	)

931 
	#isg»©”equ®
(
x
, 
y
) \

932 (
	`__ex‹nsiÚ__
 ({ 
	`__ty³of__
 (
x
è
__x
 = (x); __ty³of__ (
y
è
__y
 = (y); \

933 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x >ğ__y; }))

	)

934 
	#i¦ess
(
x
, 
y
) \

935 (
	`__ex‹nsiÚ__
 ({ 
	`__ty³of__
 (
x
è
__x
 = (x); __ty³of__ (
y
è
__y
 = (y); \

936 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x < __y; }))

	)

937 
	#i¦es£qu®
(
x
, 
y
) \

938 (
	`__ex‹nsiÚ__
 ({ 
	`__ty³of__
 (
x
è
__x
 = (x); __ty³of__ (
y
è
__y
 = (y); \

939 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x <ğ__y; }))

	)

940 
	#i¦essg»©”
(
x
, 
y
) \

941 (
	`__ex‹nsiÚ__
 ({ 
	`__ty³of__
 (
x
è
__x
 = (x); __ty³of__ (
y
è
__y
 = (y); \

942 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x !ğ__y; }))

	)

944 
	#isunÜd”ed
(
x
, 
y
) \

945 (
	`__ex‹nsiÚ__
 ({ 
	`__ty³of__
 (
x
è
__u
 = (x); __ty³of__ (
y
è
__v
 = (y); \

946 
__u
 !ğ
__v
 && (__u !ğ__u || __v !ğ__v); }))

	)

951 #ifdeà
__USE_EXTERN_INLINES


952 
	~<b™s/m©hšlše.h
>

957 #ià
defšed
 
__FINITE_MATH_ONLY__
 && __FINITE_MATH_ONLY__ > 0

960 
	#_MdoubË_
 

	)

961 
	#__MATH_DECLARING_DOUBLE
 1

	)

962 
	#__MATH_DECLARING_FLOATN
 0

	)

963 
	#__REDIRFROM_X
(
funùiÚ
, 
»’Œªt
) \

964 
funùiÚ
 ## 
»’Œªt


	)

965 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

966 
__
 ## 
funùiÚ
 ## 
»’Œªt
 ## 
_fš™e


	)

967 
	~<b™s/m©h-fš™e.h
>

968 #undeà
_MdoubË_


969 #undeà
__MATH_DECLARING_DOUBLE


970 #undeà
__MATH_DECLARING_FLOATN


971 #undeà
__REDIRFROM_X


972 #undeà
__REDIRTO_X


976 #ifdeà
__USE_ISOC99


979 
	#_MdoubË_
 

	)

980 
	#__MATH_DECLARING_DOUBLE
 0

	)

981 
	#__MATH_DECLARING_FLOATN
 0

	)

982 
	#__REDIRFROM_X
(
funùiÚ
, 
»’Œªt
) \

983 
funùiÚ
 ## 
f
 ## 
»’Œªt


	)

984 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

985 
__
 ## 
funùiÚ
 ## 
f
 ## 
»’Œªt
 ## 
_fš™e


	)

986 
	~<b™s/m©h-fš™e.h
>

987 #undeà
_MdoubË_


988 #undeà
__MATH_DECLARING_DOUBLE


989 #undeà
__MATH_DECLARING_FLOATN


990 #undeà
__REDIRFROM_X


991 #undeà
__REDIRTO_X


994 #ifdeà
__MATH_DECLARE_LDOUBLE


995 
	#_MdoubË_
 

	)

996 
	#__MATH_DECLARING_DOUBLE
 0

	)

997 
	#__MATH_DECLARING_FLOATN
 0

	)

998 
	#__REDIRFROM_X
(
funùiÚ
, 
»’Œªt
) \

999 
funùiÚ
 ## 
l
 ## 
»’Œªt


	)

1000 #ifdeà
__NO_LONG_DOUBLE_MATH


1001 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1002 
__
 ## 
funùiÚ
 ## 
»’Œªt
 ## 
_fš™e


	)

1004 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1005 
__
 ## 
funùiÚ
 ## 
l
 ## 
»’Œªt
 ## 
_fš™e


	)

1007 
	~<b™s/m©h-fš™e.h
>

1008 #undeà
_MdoubË_


1009 #undeà
__MATH_DECLARING_DOUBLE


1010 #undeà
__MATH_DECLARING_FLOATN


1011 #undeà
__REDIRFROM_X


1012 #undeà
__REDIRTO_X


1019 #ià(
__HAVE_DISTINCT_FLOAT16
 || (
__HAVE_FLOAT16
 && !
defšed
 
_LIBC
)) \

1020 && 
	$__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

1021 
	#_MdoubË_
 
_Flßt16


	)

1022 
	#__MATH_DECLARING_DOUBLE
 0

	)

1023 
	#__MATH_DECLARING_FLOATN
 1

	)

1024 
	#__REDIRFROM_X
(
funùiÚ
, 
»’Œªt
) \

1025 
funùiÚ
 ## 
f16
 ## 
»’Œªt


	)

1026 #ià
__HAVE_DISTINCT_FLOAT16


1027 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1028 
__
 ## 
funùiÚ
 ## 
f16
 ## 
»’Œªt
 ## 
_fš™e


	)

1032 
	~<b™s/m©h-fš™e.h
>

1033 #undeà
_MdoubË_


1034 #undeà
__MATH_DECLARING_DOUBLE


1035 #undeà
__MATH_DECLARING_FLOATN


1036 #undeà
__REDIRFROM_X


1037 #undeà
__REDIRTO_X


1040 #ià(
__HAVE_DISTINCT_FLOAT32
 || (
__HAVE_FLOAT32
 && !
defšed
 
_LIBC
)) \

1041 && 
	$__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

1042 
	#_MdoubË_
 
_Flßt32


	)

1043 
	#__MATH_DECLARING_DOUBLE
 0

	)

1044 
	#__MATH_DECLARING_FLOATN
 1

	)

1045 
	#__REDIRFROM_X
(
funùiÚ
, 
»’Œªt
) \

1046 
funùiÚ
 ## 
f32
 ## 
»’Œªt


	)

1047 #ià
__HAVE_DISTINCT_FLOAT32


1048 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1049 
__
 ## 
funùiÚ
 ## 
f32
 ## 
»’Œªt
 ## 
_fš™e


	)

1051 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1052 
__
 ## 
funùiÚ
 ## 
f
 ## 
»’Œªt
 ## 
_fš™e


	)

1054 
	~<b™s/m©h-fš™e.h
>

1055 #undeà
_MdoubË_


1056 #undeà
__MATH_DECLARING_DOUBLE


1057 #undeà
__MATH_DECLARING_FLOATN


1058 #undeà
__REDIRFROM_X


1059 #undeà
__REDIRTO_X


1062 #ià(
__HAVE_DISTINCT_FLOAT64
 || (
__HAVE_FLOAT64
 && !
defšed
 
_LIBC
)) \

1063 && 
	$__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

1064 
	#_MdoubË_
 
_Flßt64


	)

1065 
	#__MATH_DECLARING_DOUBLE
 0

	)

1066 
	#__MATH_DECLARING_FLOATN
 1

	)

1067 
	#__REDIRFROM_X
(
funùiÚ
, 
»’Œªt
) \

1068 
funùiÚ
 ## 
f64
 ## 
»’Œªt


	)

1069 #ià
__HAVE_DISTINCT_FLOAT64


1070 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1071 
__
 ## 
funùiÚ
 ## 
f64
 ## 
»’Œªt
 ## 
_fš™e


	)

1073 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1074 
__
 ## 
funùiÚ
 ## 
»’Œªt
 ## 
_fš™e


	)

1076 
	~<b™s/m©h-fš™e.h
>

1077 #undeà
_MdoubË_


1078 #undeà
__MATH_DECLARING_DOUBLE


1079 #undeà
__MATH_DECLARING_FLOATN


1080 #undeà
__REDIRFROM_X


1081 #undeà
__REDIRTO_X


1084 #ià(
__HAVE_DISTINCT_FLOAT128
 || (
__HAVE_FLOAT128
 && !
defšed
 
_LIBC
)) \

1085 && 
	$__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

1086 
	#_MdoubË_
 
_Flßt128


	)

1087 
	#__MATH_DECLARING_DOUBLE
 0

	)

1088 
	#__MATH_DECLARING_FLOATN
 1

	)

1089 
	#__REDIRFROM_X
(
funùiÚ
, 
»’Œªt
) \

1090 
funùiÚ
 ## 
f128
 ## 
»’Œªt


	)

1091 #ià
__HAVE_DISTINCT_FLOAT128


1092 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1093 
__
 ## 
funùiÚ
 ## 
f128
 ## 
»’Œªt
 ## 
_fš™e


	)

1095 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1096 
__
 ## 
funùiÚ
 ## 
l
 ## 
»’Œªt
 ## 
_fš™e


	)

1098 
	~<b™s/m©h-fš™e.h
>

1099 #undeà
_MdoubË_


1100 #undeà
__MATH_DECLARING_DOUBLE


1101 #undeà
__MATH_DECLARING_FLOATN


1102 #undeà
__REDIRFROM_X


1103 #undeà
__REDIRTO_X


1106 #ià(
__HAVE_DISTINCT_FLOAT32X
 || (
__HAVE_FLOAT32X
 && !
defšed
 
_LIBC
)) \

1107 && 
	$__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

1108 
	#_MdoubË_
 
_Flßt32x


	)

1109 
	#__MATH_DECLARING_DOUBLE
 0

	)

1110 
	#__MATH_DECLARING_FLOATN
 1

	)

1111 
	#__REDIRFROM_X
(
funùiÚ
, 
»’Œªt
) \

1112 
funùiÚ
 ## 
f32x
 ## 
»’Œªt


	)

1113 #ià
__HAVE_DISTINCT_FLOAT32X


1114 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1115 
__
 ## 
funùiÚ
 ## 
f32x
 ## 
»’Œªt
 ## 
_fš™e


	)

1117 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1118 
__
 ## 
funùiÚ
 ## 
»’Œªt
 ## 
_fš™e


	)

1120 
	~<b™s/m©h-fš™e.h
>

1121 #undeà
_MdoubË_


1122 #undeà
__MATH_DECLARING_DOUBLE


1123 #undeà
__MATH_DECLARING_FLOATN


1124 #undeà
__REDIRFROM_X


1125 #undeà
__REDIRTO_X


1128 #ià(
__HAVE_DISTINCT_FLOAT64X
 || (
__HAVE_FLOAT64X
 && !
defšed
 
_LIBC
)) \

1129 && 
	$__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

1130 
	#_MdoubË_
 
_Flßt64x


	)

1131 
	#__MATH_DECLARING_DOUBLE
 0

	)

1132 
	#__MATH_DECLARING_FLOATN
 1

	)

1133 
	#__REDIRFROM_X
(
funùiÚ
, 
»’Œªt
) \

1134 
funùiÚ
 ## 
f64x
 ## 
»’Œªt


	)

1135 #ià
__HAVE_DISTINCT_FLOAT64X


1136 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1137 
__
 ## 
funùiÚ
 ## 
f64x
 ## 
»’Œªt
 ## 
_fš™e


	)

1138 #–ià
__HAVE_FLOAT64X_LONG_DOUBLE


1139 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1140 
__
 ## 
funùiÚ
 ## 
l
 ## 
»’Œªt
 ## 
_fš™e


	)

1142 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1143 
__
 ## 
funùiÚ
 ## 
f128
 ## 
»’Œªt
 ## 
_fš™e


	)

1145 
	~<b™s/m©h-fš™e.h
>

1146 #undeà
_MdoubË_


1147 #undeà
__MATH_DECLARING_DOUBLE


1148 #undeà
__MATH_DECLARING_FLOATN


1149 #undeà
__REDIRFROM_X


1150 #undeà
__REDIRTO_X


1153 #ià(
__HAVE_DISTINCT_FLOAT128X
 || (
__HAVE_FLOAT128X
 && !
defšed
 
_LIBC
)) \

1154 && 
	$__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

1155 
	#_MdoubË_
 
_Flßt128x


	)

1156 
	#__MATH_DECLARING_DOUBLE
 0

	)

1157 
	#__MATH_DECLARING_FLOATN
 1

	)

1158 
	#__REDIRFROM_X
(
funùiÚ
, 
»’Œªt
) \

1159 
funùiÚ
 ## 
f128x
 ## 
»’Œªt


	)

1160 #ià
__HAVE_DISTINCT_FLOAT128X


1161 
	#__REDIRTO_X
(
funùiÚ
, 
»’Œªt
) \

1162 
__
 ## 
funùiÚ
 ## 
f128x
 ## 
»’Œªt
 ## 
_fš™e


	)

1166 
	~<b™s/m©h-fš™e.h
>

1167 #undeà
_MdoubË_


1168 #undeà
__MATH_DECLARING_DOUBLE


1169 #undeà
__MATH_DECLARING_FLOATN


1170 #undeà
__REDIRFROM_X


1171 #undeà
__REDIRTO_X


1176 #ià
	`__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

1179 #ià
__FLT_EVAL_METHOD__
 == 2 || __FLT_EVAL_METHOD__ > 64

1180 
	#__MATH_EVAL_FMT2
(
x
, 
y
è((xè+ (yè+ 0.0L)

	)

1181 #–ià
__FLT_EVAL_METHOD__
 == 1 || __FLT_EVAL_METHOD__ > 32

1182 
	#__MATH_EVAL_FMT2
(
x
, 
y
è((xè+ (yè+ 0.0)

	)

1183 #–ià
__FLT_EVAL_METHOD__
 == 0 || __FLT_EVAL_METHOD__ == 32

1184 
	#__MATH_EVAL_FMT2
(
x
, 
y
è((xè+ (yè+ 0.0f)

	)

1186 
	#__MATH_EVAL_FMT2
(
x
, 
y
è((xè+ (y))

	)

1191 #ià!
defšed
 
__ılu¥lus
 || (__ılu¥lu < 201103L && !defšed 
__GNUC__
)

1192 
	#i£qsig
(
x
, 
y
) \

1193 
	`__MATH_TG
 (
	`__MATH_EVAL_FMT2
 (
x
, 
y
), 
__i£qsig
, ((x), (y)))

	)

1206 
‹m¶©e
<
ty³Çme
> 
__i£qsig_ty³
;

1208 
‹m¶©e
<> 
__i£qsig_ty³
<>

1210 
	`__ÿÎ
 (
__x
, 
__y
è
	`throw
 ()

1212  
	`__i£qsigf
 (
__x
, 
__y
);

1216 
‹m¶©e
<> 
__i£qsig_ty³
<>

1218 
	`__ÿÎ
 (
__x
, 
__y
è
	`throw
 ()

1220  
	`__i£qsig
 (
__x
, 
__y
);

1224 
‹m¶©e
<> 
__i£qsig_ty³
<>

1226 
	`__ÿÎ
 (
__x
, 
__y
è
	`throw
 ()

1228 #iâdeà
__NO_LONG_DOUBLE_MATH


1229  
	`__i£qsigl
 (
__x
, 
__y
);

1231  
	`__i£qsig
 (
__x
, 
__y
);

1236 #ià
__HAVE_DISTINCT_FLOAT128


1237 
‹m¶©e
<> 
__i£qsig_ty³
<
_Flßt128
>

1239 
	`__ÿÎ
 (
_Flßt128
 
__x
, _Flßt128 
__y
è
	`throw
 ()

1241  
	`__i£qsigf128
 (
__x
, 
__y
);

1246 
‹m¶©e
<
ty³Çme
 
_T1
,y³Çm
_T2
>

1247 
šlše
 

1248 
	`i£qsig
 (
_T1
 
__x
, 
_T2
 
__y
è
	`throw
 ()

1250 #ià
__ılu¥lus
 >= 201103L

1251 
	`deşty³
 (
	t__MATH_EVAL_FMT2
 (
	t__x
, 
	t__y
)è
	t_T3
;

1253 
	`__ty³of
 (
	t__MATH_EVAL_FMT2
 (
	t__x
, 
	t__y
)è
	t_T3
;

1255  
__i£qsig_ty³
<
_T3
>::
	`__ÿÎ
 (
__x
, 
__y
);

1258 
	}
}

1263 
__END_DECLS


	@/usr/include/netdb.h

22 #iâdef 
_NETDB_H


23 
	#_NETDB_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	~<Ãtš‘/š.h
>

28 
	~<b™s/¡dšt-ušŠ.h
>

29 #ifdeà
__USE_MISC


32 
	~<½c/Ãtdb.h
>

35 #ifdeà
__USE_GNU


36 
	~<b™s/ty³s/sigev’t_t.h
>

37 
	~<b™s/ty³s/¡ruù_time¥ec.h
>

40 
	~<b™s/Ãtdb.h
>

43 
	#_PATH_HEQUIV
 "/‘c/ho¡s.equiv"

	)

44 
	#_PATH_HOSTS
 "/‘c/ho¡s"

	)

45 
	#_PATH_NETWORKS
 "/‘c/ÃtwÜks"

	)

46 
	#_PATH_NSSWITCH_CONF
 "/‘c/nssw™ch.cÚf"

	)

47 
	#_PATH_PROTOCOLS
 "/‘c/´ÙocŞs"

	)

48 
	#_PATH_SERVICES
 "/‘c/£rviûs"

	)

51 
	g__BEGIN_DECLS


53 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


56 
	#h_”ºo
 (*
	`__h_”ºo_loÿtiÚ
 ())

	)

59 *
	$__h_”ºo_loÿtiÚ
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

63 
	#HOST_NOT_FOUND
 1

	)

64 
	#TRY_AGAIN
 2

	)

66 
	#NO_RECOVERY
 3

	)

68 
	#NO_DATA
 4

	)

71 #ifdeà
__USE_MISC


72 
	#NETDB_INTERNAL
 -1

	)

73 
	#NETDB_SUCCESS
 0

	)

74 
	#NO_ADDRESS
 
NO_DATA


	)

77 #ià
defšed
 
__USE_XOPEN2K
 || defšed 
__USE_XOPEN_EXTENDED


79 
	#IPPORT_RESERVED
 1024

	)

82 #ifdeà
__USE_GNU


84 
	#SCOPE_DELIMITER
 '%'

	)

87 #ifdeà
__USE_MISC


90 
	$h”rÜ
 (cÚ¡ *
__¡r
è
__THROW
;

93 cÚ¡ *
	$h¡»¼Ü
 (
__”r_num
è
__THROW
;

98 
	sho¡’t


100 *
h_Çme
;

101 **
h_®Ÿ£s
;

102 
h_add¹y³
;

103 
h_Ëngth
;

104 **
h_addr_li¡
;

105 #ifdeà
__USE_MISC


106 
	#h_addr
 
h_addr_li¡
[0]

	)

115 
	`£tho¡’t
 (
__¡ay_İ’
);

121 
	`’dho¡’t
 ();

128 
ho¡’t
 *
	`g‘ho¡’t
 ();

135 
ho¡’t
 *
	`g‘ho¡byaddr
 (cÚ¡ *
__addr
, 
__sockËn_t
 
__Ën
,

136 
__ty³
);

142 
ho¡’t
 *
	`g‘ho¡byÇme
 (cÚ¡ *
__Çme
);

144 #ifdeà
__USE_MISC


153 
ho¡’t
 *
	`g‘ho¡byÇme2
 (cÚ¡ *
__Çme
, 
__af
);

165 
	`g‘ho¡’t_r
 (
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

166 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

167 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

168 *
__»¡riù
 
__h_”ºİ
);

170 
	`g‘ho¡byaddr_r
 (cÚ¡ *
__»¡riù
 
__addr
, 
__sockËn_t
 
__Ën
,

171 
__ty³
,

172 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

173 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

174 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

175 *
__»¡riù
 
__h_”ºİ
);

177 
	`g‘ho¡byÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

178 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

179 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

180 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

181 *
__»¡riù
 
__h_”ºİ
);

183 
	`g‘ho¡byÇme2_r
 (cÚ¡ *
__»¡riù
 
__Çme
, 
__af
,

184 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

185 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

186 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

187 *
__»¡riù
 
__h_”ºİ
);

196 
	`£Š‘’t
 (
__¡ay_İ’
);

202 
	`’dÃ‹Á
 ();

209 
Ã‹Á
 *
	`g‘Ã‹Á
 ();

216 
Ã‹Á
 *
	`g‘Ãtbyaddr
 (
ušt32_t
 
__Ãt
, 
__ty³
);

222 
Ã‹Á
 *
	`g‘ÃtbyÇme
 (cÚ¡ *
__Çme
);

224 #ifdef 
__USE_MISC


235 
	`g‘Ã‹Á_r
 (
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

236 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

237 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

238 *
__»¡riù
 
__h_”ºİ
);

240 
	`g‘Ãtbyaddr_r
 (
ušt32_t
 
__Ãt
, 
__ty³
,

241 
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

242 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

243 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

244 *
__»¡riù
 
__h_”ºİ
);

246 
	`g‘ÃtbyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

247 
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

248 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

249 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

250 *
__»¡riù
 
__h_”ºİ
);

255 
	s£rv’t


257 *
s_Çme
;

258 **
s_®Ÿ£s
;

259 
s_pÜt
;

260 *
s_´Ùo
;

268 
	`£t£rv’t
 (
__¡ay_İ’
);

274 
	`’d£rv’t
 ();

281 
£rv’t
 *
	`g‘£rv’t
 ();

288 
£rv’t
 *
	`g‘£rvbyÇme
 (cÚ¡ *
__Çme
, cÚ¡ *
__´Ùo
);

295 
£rv’t
 *
	`g‘£rvbypÜt
 (
__pÜt
, cÚ¡ *
__´Ùo
);

298 #ifdef 
__USE_MISC


306 
	`g‘£rv’t_r
 (
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

307 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

308 
£rv’t
 **
__»¡riù
 
__»suÉ
);

310 
	`g‘£rvbyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

311 cÚ¡ *
__»¡riù
 
__´Ùo
,

312 
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

313 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

314 
£rv’t
 **
__»¡riù
 
__»suÉ
);

316 
	`g‘£rvbypÜt_r
 (
__pÜt
, cÚ¡ *
__»¡riù
 
__´Ùo
,

317 
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

318 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

319 
£rv’t
 **
__»¡riù
 
__»suÉ
);

324 
	s´ÙÛÁ


326 *
p_Çme
;

327 **
p_®Ÿ£s
;

328 
p_´Ùo
;

336 
	`£rÙÛÁ
 (
__¡ay_İ’
);

342 
	`’d´ÙÛÁ
 ();

349 
´ÙÛÁ
 *
	`g‘´ÙÛÁ
 ();

355 
´ÙÛÁ
 *
	`g‘´ÙobyÇme
 (cÚ¡ *
__Çme
);

361 
´ÙÛÁ
 *
	`g‘´Ùobynumb”
 (
__´Ùo
);

364 #ifdef 
__USE_MISC


372 
	`g‘´ÙÛÁ_r
 (
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

373 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

374 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

376 
	`g‘´ÙobyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

377 
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

378 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

379 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

381 
	`g‘´Ùobynumb”_r
 (
__´Ùo
,

382 
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

383 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

384 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

393 
	`£Š‘g»Á
 (cÚ¡ *
__Ãtgroup
);

401 
	`’dÃtg»Á
 ();

410 
	`g‘Ãtg»Á
 (**
__»¡riù
 
__ho¡p
,

411 **
__»¡riù
 
__u£½
,

412 **
__»¡riù
 
__domašp
);

421 
	`šÃtgr
 (cÚ¡ *
__Ãtgroup
, cÚ¡ *
__ho¡
,

422 cÚ¡ *
__u£r
, cÚ¡ *
__domaš
);

430 
	`g‘Ãtg»Á_r
 (**
__»¡riù
 
__ho¡p
,

431 **
__»¡riù
 
__u£½
,

432 **
__»¡riù
 
__domašp
,

433 *
__»¡riù
 
__bufãr
, 
size_t
 
__buæ’
);

437 #ifdeà
__USE_MISC


449 
	`rcmd
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

450 cÚ¡ *
__»¡riù
 
__locu£r
,

451 cÚ¡ *
__»¡riù
 
__»mu£r
,

452 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
);

461 
	`rcmd_af
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

462 cÚ¡ *
__»¡riù
 
__locu£r
,

463 cÚ¡ *
__»¡riù
 
__»mu£r
,

464 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
,

465 
§_çmy_t
 
__af
);

477 
	`»xec
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

478 cÚ¡ *
__»¡riù
 
__Çme
,

479 cÚ¡ *
__»¡riù
 
__·ss
,

480 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
);

489 
	`»xec_af
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

490 cÚ¡ *
__»¡riù
 
__Çme
,

491 cÚ¡ *
__»¡riù
 
__·ss
,

492 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
,

493 
§_çmy_t
 
__af
);

503 
	`ru£rok
 (cÚ¡ *
__rho¡
, 
__su£r
,

504 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
);

513 
	`ru£rok_af
 (cÚ¡ *
__rho¡
, 
__su£r
,

514 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
,

515 
§_çmy_t
 
__af
);

526 
	`œu£rok
 (
ušt32_t
 
__¿ddr
, 
__su£r
,

527 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
);

537 
	`œu£rok_af
 (cÚ¡ *
__¿ddr
, 
__su£r
,

538 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
,

539 
§_çmy_t
 
__af
);

549 
	`¼esvpÜt
 (*
__®pÜt
);

558 
	`¼esvpÜt_af
 (*
__®pÜt
, 
§_çmy_t
 
__af
);

563 #ifdeà
__USE_XOPEN2K


565 
	saddršfo


567 
ai_æags
;

568 
ai_çmy
;

569 
ai_sockty³
;

570 
ai_´ÙocŞ
;

571 
sockËn_t
 
ai_add¾’
;

572 
sockaddr
 *
ai_addr
;

573 *
ai_ÿnÚÇme
;

574 
addršfo
 *
ai_Ãxt
;

577 #ifdeà
__USE_GNU


579 
	sgaicb


581 cÚ¡ *
¬_Çme
;

582 cÚ¡ *
¬_£rviû
;

583 cÚ¡ 
addršfo
 *
¬_»que¡
;

584 
addršfo
 *
¬_»suÉ
;

586 
__»tuº
;

587 
__glibc_»£rved
[5];

591 
	#GAI_WAIT
 0

	)

592 
	#GAI_NOWAIT
 1

	)

596 
	#AI_PASSIVE
 0x0001

	)

597 
	#AI_CANONNAME
 0x0002

	)

598 
	#AI_NUMERICHOST
 0x0004

	)

599 
	#AI_V4MAPPED
 0x0008

	)

600 
	#AI_ALL
 0x0010

	)

601 
	#AI_ADDRCONFIG
 0x0020

	)

603 #ifdeà
__USE_GNU


604 
	#AI_IDN
 0x0040

	)

607 
	#AI_CANONIDN
 0x0080

	)

608 
	#AI_IDN_ALLOW_UNASSIGNED
 0x0100

	)

610 
	#AI_IDN_USE_STD3_ASCII_RULES
 0x0200

	)

613 
	#AI_NUMERICSERV
 0x0400

	)

616 
	#EAI_BADFLAGS
 -1

	)

617 
	#EAI_NONAME
 -2

	)

618 
	#EAI_AGAIN
 -3

	)

619 
	#EAI_FAIL
 -4

	)

620 
	#EAI_FAMILY
 -6

	)

621 
	#EAI_SOCKTYPE
 -7

	)

622 
	#EAI_SERVICE
 -8

	)

623 
	#EAI_MEMORY
 -10

	)

624 
	#EAI_SYSTEM
 -11

	)

625 
	#EAI_OVERFLOW
 -12

	)

626 #ifdeà
__USE_GNU


627 
	#EAI_NODATA
 -5

	)

628 
	#EAI_ADDRFAMILY
 -9

	)

629 
	#EAI_INPROGRESS
 -100

	)

630 
	#EAI_CANCELED
 -101

	)

631 
	#EAI_NOTCANCELED
 -102

	)

632 
	#EAI_ALLDONE
 -103

	)

633 
	#EAI_INTR
 -104

	)

634 
	#EAI_IDN_ENCODE
 -105

	)

637 #ifdeà
__USE_MISC


638 
	#NI_MAXHOST
 1025

	)

639 
	#NI_MAXSERV
 32

	)

642 
	#NI_NUMERICHOST
 1

	)

643 
	#NI_NUMERICSERV
 2

	)

644 
	#NI_NOFQDN
 4

	)

645 
	#NI_NAMEREQD
 8

	)

646 
	#NI_DGRAM
 16

	)

647 #ifdeà
__USE_GNU


648 
	#NI_IDN
 32

	)

649 
	#NI_IDN_ALLOW_UNASSIGNED
 64

	)

651 
	#NI_IDN_USE_STD3_ASCII_RULES
 128

	)

660 
	`g‘addršfo
 (cÚ¡ *
__»¡riù
 
__Çme
,

661 cÚ¡ *
__»¡riù
 
__£rviû
,

662 cÚ¡ 
addršfo
 *
__»¡riù
 
__»q
,

663 
addršfo
 **
__»¡riù
 
__·i
);

666 
	$ä“addršfo
 (
addršfo
 *
__ai
è
__THROW
;

669 cÚ¡ *
	$gai_¡»¼Ü
 (
__ecode
è
__THROW
;

675 
	`g‘Çmešfo
 (cÚ¡ 
sockaddr
 *
__»¡riù
 
__§
,

676 
sockËn_t
 
__§Ën
, *
__»¡riù
 
__ho¡
,

677 
sockËn_t
 
__ho¡Ën
, *
__»¡riù
 
__£rv
,

678 
sockËn_t
 
__£rvËn
, 
__æags
);

681 #ifdeà
__USE_GNU


690 
	`g‘addršfo_a
 (
__mode
, 
gaicb
 *
__li¡
[
__»¡riù_¬r
],

691 
__’t
, 
sigev’t
 *
__»¡riù
 
__sig
);

701 
	`gai_su¥’d
 (cÚ¡ 
gaicb
 *cÚ¡ 
__li¡
[], 
__’t
,

702 cÚ¡ 
time¥ec
 *
__timeout
);

705 
	$gai_”rÜ
 (
gaicb
 *
__»q
è
__THROW
;

708 
	$gai_ÿnûl
 (
gaicb
 *
__gaicbp
è
__THROW
;

711 
__END_DECLS


	@/usr/include/netinet/in.h

18 #iâdef 
_NETINET_IN_H


19 
	#_NETINET_IN_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<b™s/¡dšt-ušŠ.h
>

23 
	~<sys/sock‘.h
>

24 
	~<b™s/ty³s.h
>

27 
__BEGIN_DECLS


30 
ušt32_t
 
	tš_addr_t
;

31 
	sš_addr


33 
š_addr_t
 
	ms_addr
;

37 
	~<b™s/š.h
>

42 
	mIPPROTO_IP
 = 0,

43 
	#IPPROTO_IP
 
IPPROTO_IP


	)

44 
	mIPPROTO_ICMP
 = 1,

45 
	#IPPROTO_ICMP
 
IPPROTO_ICMP


	)

46 
	mIPPROTO_IGMP
 = 2,

47 
	#IPPROTO_IGMP
 
IPPROTO_IGMP


	)

48 
	mIPPROTO_IPIP
 = 4,

49 
	#IPPROTO_IPIP
 
IPPROTO_IPIP


	)

50 
	mIPPROTO_TCP
 = 6,

51 
	#IPPROTO_TCP
 
IPPROTO_TCP


	)

52 
	mIPPROTO_EGP
 = 8,

53 
	#IPPROTO_EGP
 
IPPROTO_EGP


	)

54 
	mIPPROTO_PUP
 = 12,

55 
	#IPPROTO_PUP
 
IPPROTO_PUP


	)

56 
	mIPPROTO_UDP
 = 17,

57 
	#IPPROTO_UDP
 
IPPROTO_UDP


	)

58 
	mIPPROTO_IDP
 = 22,

59 
	#IPPROTO_IDP
 
IPPROTO_IDP


	)

60 
	mIPPROTO_TP
 = 29,

61 
	#IPPROTO_TP
 
IPPROTO_TP


	)

62 
	mIPPROTO_DCCP
 = 33,

63 
	#IPPROTO_DCCP
 
IPPROTO_DCCP


	)

64 
	mIPPROTO_IPV6
 = 41,

65 
	#IPPROTO_IPV6
 
IPPROTO_IPV6


	)

66 
	mIPPROTO_RSVP
 = 46,

67 
	#IPPROTO_RSVP
 
IPPROTO_RSVP


	)

68 
	mIPPROTO_GRE
 = 47,

69 
	#IPPROTO_GRE
 
IPPROTO_GRE


	)

70 
	mIPPROTO_ESP
 = 50,

71 
	#IPPROTO_ESP
 
IPPROTO_ESP


	)

72 
	mIPPROTO_AH
 = 51,

73 
	#IPPROTO_AH
 
IPPROTO_AH


	)

74 
	mIPPROTO_MTP
 = 92,

75 
	#IPPROTO_MTP
 
IPPROTO_MTP


	)

76 
	mIPPROTO_BEETPH
 = 94,

77 
	#IPPROTO_BEETPH
 
IPPROTO_BEETPH


	)

78 
	mIPPROTO_ENCAP
 = 98,

79 
	#IPPROTO_ENCAP
 
IPPROTO_ENCAP


	)

80 
	mIPPROTO_PIM
 = 103,

81 
	#IPPROTO_PIM
 
IPPROTO_PIM


	)

82 
	mIPPROTO_COMP
 = 108,

83 
	#IPPROTO_COMP
 
IPPROTO_COMP


	)

84 
	mIPPROTO_SCTP
 = 132,

85 
	#IPPROTO_SCTP
 
IPPROTO_SCTP


	)

86 
	mIPPROTO_UDPLITE
 = 136,

87 
	#IPPROTO_UDPLITE
 
IPPROTO_UDPLITE


	)

88 
	mIPPROTO_MPLS
 = 137,

89 
	#IPPROTO_MPLS
 
IPPROTO_MPLS


	)

90 
	mIPPROTO_RAW
 = 255,

91 
	#IPPROTO_RAW
 
IPPROTO_RAW


	)

92 
	mIPPROTO_MAX


98 #ià!
__USE_KERNEL_IPV6_DEFS


101 
	mIPPROTO_HOPOPTS
 = 0,

102 
	#IPPROTO_HOPOPTS
 
IPPROTO_HOPOPTS


	)

103 
	mIPPROTO_ROUTING
 = 43,

104 
	#IPPROTO_ROUTING
 
IPPROTO_ROUTING


	)

105 
	mIPPROTO_FRAGMENT
 = 44,

106 
	#IPPROTO_FRAGMENT
 
IPPROTO_FRAGMENT


	)

107 
	mIPPROTO_ICMPV6
 = 58,

108 
	#IPPROTO_ICMPV6
 
IPPROTO_ICMPV6


	)

109 
	mIPPROTO_NONE
 = 59,

110 
	#IPPROTO_NONE
 
IPPROTO_NONE


	)

111 
	mIPPROTO_DSTOPTS
 = 60,

112 
	#IPPROTO_DSTOPTS
 
IPPROTO_DSTOPTS


	)

113 
	mIPPROTO_MH
 = 135

114 
	#IPPROTO_MH
 
IPPROTO_MH


	)

119 
ušt16_t
 
	tš_pÜt_t
;

124 
	mIPPORT_ECHO
 = 7,

125 
	mIPPORT_DISCARD
 = 9,

126 
	mIPPORT_SYSTAT
 = 11,

127 
	mIPPORT_DAYTIME
 = 13,

128 
	mIPPORT_NETSTAT
 = 15,

129 
	mIPPORT_FTP
 = 21,

130 
	mIPPORT_TELNET
 = 23,

131 
	mIPPORT_SMTP
 = 25,

132 
	mIPPORT_TIMESERVER
 = 37,

133 
	mIPPORT_NAMESERVER
 = 42,

134 
	mIPPORT_WHOIS
 = 43,

135 
	mIPPORT_MTP
 = 57,

137 
	mIPPORT_TFTP
 = 69,

138 
	mIPPORT_RJE
 = 77,

139 
	mIPPORT_FINGER
 = 79,

140 
	mIPPORT_TTYLINK
 = 87,

141 
	mIPPORT_SUPDUP
 = 95,

144 
	mIPPORT_EXECSERVER
 = 512,

145 
	mIPPORT_LOGINSERVER
 = 513,

146 
	mIPPORT_CMDSERVER
 = 514,

147 
	mIPPORT_EFSSERVER
 = 520,

150 
	mIPPORT_BIFFUDP
 = 512,

151 
	mIPPORT_WHOSERVER
 = 513,

152 
	mIPPORT_ROUTESERVER
 = 520,

155 
	mIPPORT_RESERVED
 = 1024,

158 
	mIPPORT_USERRESERVED
 = 5000

166 
	#IN_CLASSA
(
a
è((((
š_addr_t
)×)è& 0x80000000è=ğ0)

	)

167 
	#IN_CLASSA_NET
 0xff000000

	)

168 
	#IN_CLASSA_NSHIFT
 24

	)

169 
	#IN_CLASSA_HOST
 (0xfffffffà& ~
IN_CLASSA_NET
)

	)

170 
	#IN_CLASSA_MAX
 128

	)

172 
	#IN_CLASSB
(
a
è((((
š_addr_t
)×)è& 0xc0000000è=ğ0x80000000)

	)

173 
	#IN_CLASSB_NET
 0xffff0000

	)

174 
	#IN_CLASSB_NSHIFT
 16

	)

175 
	#IN_CLASSB_HOST
 (0xfffffffà& ~
IN_CLASSB_NET
)

	)

176 
	#IN_CLASSB_MAX
 65536

	)

178 
	#IN_CLASSC
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xc0000000)

	)

179 
	#IN_CLASSC_NET
 0xffffff00

	)

180 
	#IN_CLASSC_NSHIFT
 8

	)

181 
	#IN_CLASSC_HOST
 (0xfffffffà& ~
IN_CLASSC_NET
)

	)

183 
	#IN_CLASSD
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xe0000000)

	)

184 
	#IN_MULTICAST
(
a
è
	`IN_CLASSD
×)

	)

186 
	#IN_EXPERIMENTAL
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xe0000000)

	)

187 
	#IN_BADCLASS
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xf0000000)

	)

190 
	#INADDR_ANY
 ((
š_addr_t
è0x00000000)

	)

192 
	#INADDR_BROADCAST
 ((
š_addr_t
è0xffffffff)

	)

194 
	#INADDR_NONE
 ((
š_addr_t
è0xffffffff)

	)

197 
	#IN_LOOPBACKNET
 127

	)

199 #iâdeà
INADDR_LOOPBACK


200 
	#INADDR_LOOPBACK
 ((
š_addr_t
è0x7f000001è

	)

204 
	#INADDR_UNSPEC_GROUP
 ((
š_addr_t
è0xe0000000è

	)

205 
	#INADDR_ALLHOSTS_GROUP
 ((
š_addr_t
è0xe0000001è

	)

206 
	#INADDR_ALLRTRS_GROUP
 ((
š_addr_t
è0xe0000002è

	)

207 
	#INADDR_MAX_LOCAL_GROUP
 ((
š_addr_t
è0xe00000ffè

	)

209 #ià!
__USE_KERNEL_IPV6_DEFS


211 
	sš6_addr


215 
ušt8_t
 
	m__u6_addr8
[16];

216 
ušt16_t
 
	m__u6_addr16
[8];

217 
ušt32_t
 
	m__u6_addr32
[4];

218 } 
	m__š6_u
;

219 
	#s6_addr
 
__š6_u
.
__u6_addr8


	)

220 #ifdeà
__USE_MISC


221 
	#s6_addr16
 
__š6_u
.
__u6_addr16


	)

222 
	#s6_addr32
 
__š6_u
.
__u6_addr32


	)

227 cÚ¡ 
š6_addr
 
š6addr_ªy
;

228 cÚ¡ 
š6_addr
 
š6addr_loİback
;

229 
	#IN6ADDR_ANY_INIT
 { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 } } }

	)

230 
	#IN6ADDR_LOOPBACK_INIT
 { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1 } } }

	)

232 
	#INET_ADDRSTRLEN
 16

	)

233 
	#INET6_ADDRSTRLEN
 46

	)

237 
	ssockaddr_š


239 
__SOCKADDR_COMMON
 (
sš_
);

240 
š_pÜt_t
 
	msš_pÜt
;

241 
š_addr
 
	msš_addr
;

244 
	msš_z”o
[ (
sockaddr
) -

245 
__SOCKADDR_COMMON_SIZE
 -

246  (
š_pÜt_t
) -

247  (
š_addr
)];

250 #ià!
__USE_KERNEL_IPV6_DEFS


252 
	ssockaddr_š6


254 
__SOCKADDR_COMMON
 (
sš6_
);

255 
š_pÜt_t
 
	msš6_pÜt
;

256 
ušt32_t
 
	msš6_æowšfo
;

257 
š6_addr
 
	msš6_addr
;

258 
ušt32_t
 
	msš6_scİe_id
;

262 #ifdeà
__USE_MISC


264 
	s_m»q


267 
š_addr
 
	mimr_muÉŸddr
;

270 
š_addr
 
	mimr_š‹rçû
;

273 
	s_m»q_sourû


276 
š_addr
 
	mimr_muÉŸddr
;

279 
š_addr
 
	mimr_š‹rçû
;

282 
š_addr
 
	mimr_sourûaddr
;

286 #ià!
__USE_KERNEL_IPV6_DEFS


288 
	sv6_m»q


291 
š6_addr
 
	mv6mr_muÉŸddr
;

294 
	mv6mr_š‹rçû
;

298 #ifdeà
__USE_MISC


300 
	sgroup_»q


303 
ušt32_t
 
	mgr_š‹rçû
;

306 
sockaddr_¡Üage
 
	mgr_group
;

309 
	sgroup_sourû_»q


312 
ušt32_t
 
	mg¤_š‹rçû
;

315 
sockaddr_¡Üage
 
	mg¤_group
;

318 
sockaddr_¡Üage
 
	mg¤_sourû
;

323 
	s_msf‹r


326 
š_addr
 
	mimsf_muÉŸddr
;

329 
š_addr
 
	mimsf_š‹rçû
;

332 
ušt32_t
 
	mimsf_fmode
;

335 
ušt32_t
 
	mimsf_num¤c
;

337 
š_addr
 
	mimsf_¦i¡
[1];

340 
	#IP_MSFILTER_SIZE
(
num¤c
è( (
_msf‹r
) \

341 -  (
š_addr
) \

342 + (
num¤c
è*  (
š_addr
))

	)

344 
	sgroup_f‹r


347 
ušt32_t
 
	mgf_š‹rçû
;

350 
sockaddr_¡Üage
 
	mgf_group
;

353 
ušt32_t
 
	mgf_fmode
;

356 
ušt32_t
 
	mgf_num¤c
;

358 
sockaddr_¡Üage
 
	mgf_¦i¡
[1];

361 
	#GROUP_FILTER_SIZE
(
num¤c
è( (
group_f‹r
) \

362 -  (
sockaddr_¡Üage
) \

363 + ((
num¤c
) \

364 *  (
sockaddr_¡Üage
)))

	)

374 
ušt32_t
 
	$Áohl
 (
ušt32_t
 
__ÃÚg
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

375 
ušt16_t
 
	$Áohs
 (
ušt16_t
 
__ÃtshÜt
)

376 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

377 
ušt32_t
 
	$htÚl
 (
ušt32_t
 
__ho¡lÚg
)

378 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

379 
ušt16_t
 
	$htÚs
 (
ušt16_t
 
__ho¡shÜt
)

380 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

382 
	~<’dŸn.h
>

385 
	~<b™s/by‹sw­.h
>

386 
	~<b™s/ušŠ-id’t™y.h
>

388 #ifdeà
__OPTIMIZE__


392 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


395 
	#Áohl
(
x
è
	`__ušt32_id’t™y
 (x)

	)

396 
	#Áohs
(
x
è
	`__ušt16_id’t™y
 (x)

	)

397 
	#htÚl
(
x
è
	`__ušt32_id’t™y
 (x)

	)

398 
	#htÚs
(
x
è
	`__ušt16_id’t™y
 (x)

	)

400 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


401 
	#Áohl
(
x
è
	`__bsw­_32
 (x)

	)

402 
	#Áohs
(
x
è
	`__bsw­_16
 (x)

	)

403 
	#htÚl
(
x
è
	`__bsw­_32
 (x)

	)

404 
	#htÚs
(
x
è
	`__bsw­_16
 (x)

	)

409 #ifdeà
__GNUC__


410 
	#IN6_IS_ADDR_UNSPECIFIED
(
a
) \

411 (
__ex‹nsiÚ__
 \

412 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

413 
__a
->
__š6_u
.
__u6_addr32
[0] == 0 \

414 && 
__a
->
__š6_u
.
__u6_addr32
[1] == 0 \

415 && 
__a
->
__š6_u
.
__u6_addr32
[2] == 0 \

416 && 
__a
->
__š6_u
.
__u6_addr32
[3] =ğ0; 
	}
}))

	)

418 
	#IN6_IS_ADDR_LOOPBACK
(
a
) \

419 (
__ex‹nsiÚ__
 \

420 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

421 
__a
->
__š6_u
.
__u6_addr32
[0] == 0 \

422 && 
__a
->
__š6_u
.
__u6_addr32
[1] == 0 \

423 && 
__a
->
__š6_u
.
__u6_addr32
[2] == 0 \

424 && 
__a
->
__š6_u
.
__u6_addr32
[3] =ğ
	`htÚl
 (1); }))

	)

426 
	#IN6_IS_ADDR_LINKLOCAL
(
a
) \

427 (
__ex‹nsiÚ__
 \

428 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

429 (
__a
->
__š6_u
.
__u6_addr32
[0] & 
	`htÚl
 (0xffc00000)è=ğhtÚÈ(0xã800000); }))

	)

431 
	#IN6_IS_ADDR_SITELOCAL
(
a
) \

432 (
__ex‹nsiÚ__
 \

433 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

434 (
__a
->
__š6_u
.
__u6_addr32
[0] & 
	`htÚl
 (0xffc00000)è=ğhtÚÈ(0xãc00000); }))

	)

436 
	#IN6_IS_ADDR_V4MAPPED
(
a
) \

437 (
__ex‹nsiÚ__
 \

438 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

439 
__a
->
__š6_u
.
__u6_addr32
[0] == 0 \

440 && 
__a
->
__š6_u
.
__u6_addr32
[1] == 0 \

441 && 
__a
->
__š6_u
.
__u6_addr32
[2] =ğ
	`htÚl
 (0xffff); }))

	)

443 
	#IN6_IS_ADDR_V4COMPAT
(
a
) \

444 (
__ex‹nsiÚ__
 \

445 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

446 
__a
->
__š6_u
.
__u6_addr32
[0] == 0 \

447 && 
__a
->
__š6_u
.
__u6_addr32
[1] == 0 \

448 && 
__a
->
__š6_u
.
__u6_addr32
[2] == 0 \

449 && 
	`Áohl
 (
__a
->
__š6_u
.
__u6_addr32
[3]è> 1; }))

	)

451 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

452 (
__ex‹nsiÚ__
 \

453 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

454 cÚ¡ 
š6_addr
 *
__b
 = (cÚ¡ š6_add¸*è(
b
); \

455 
__a
->
__š6_u
.
__u6_addr32
[0] =ğ
__b
->__in6_u.__u6_addr32[0] \

456 && 
__a
->
__š6_u
.
__u6_addr32
[1] =ğ
__b
->__in6_u.__u6_addr32[1] \

457 && 
__a
->
__š6_u
.
__u6_addr32
[2] =ğ
__b
->__in6_u.__u6_addr32[2] \

458 && 
__a
->
__š6_u
.
__u6_addr32
[3] =ğ
__b
->__š6_u.__u6_addr32[3]; }))

	)

460 
	#IN6_IS_ADDR_UNSPECIFIED
(
a
) \

461 (((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0 \

462 && ((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0 \

463 && ((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0 \

464 && ((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ0)

	)

466 
	#IN6_IS_ADDR_LOOPBACK
(
a
) \

467 (((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0 \

468 && ((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0 \

469 && ((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0 \

470 && ((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ
	`htÚl
 (1))

	)

472 
	#IN6_IS_ADDR_LINKLOCAL
(
a
) \

473 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] & 
	`htÚl
 (0xffc00000)) \

474 =ğ
	`htÚl
 (0xã800000))

	)

476 
	#IN6_IS_ADDR_SITELOCAL
(
a
) \

477 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] & 
	`htÚl
 (0xffc00000)) \

478 =ğ
	`htÚl
 (0xãc00000))

	)

480 
	#IN6_IS_ADDR_V4MAPPED
(
a
) \

481 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0) \

482 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0) \

483 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] =ğ
	`htÚl
 (0xffff)))

	)

485 
	#IN6_IS_ADDR_V4COMPAT
(
a
) \

486 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0) \

487 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0) \

488 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0) \

489 && (
	`Áohl
 (((cÚ¡ 
ušt32_t
 *è(
a
))[3]è> 1))

	)

491 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

492 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[0]) \

493 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[1]) \

494 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[2]) \

495 && (((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[3]))

	)

498 
	#IN6_IS_ADDR_MULTICAST
(
a
è(((cÚ¡ 
ušt8_t
 *è×))[0] =ğ0xff)

	)

500 #ifdeà
__USE_MISC


502 
	$bšd»svpÜt
 (
__sockfd
, 
sockaddr_š
 *
__sock_š
è
__THROW
;

505 
	$bšd»svpÜt6
 (
__sockfd
, 
sockaddr_š6
 *
__sock_š
)

506 
__THROW
;

510 
	#IN6_IS_ADDR_MC_NODELOCAL
(
a
) \

511 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

512 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x1))

	)

514 
	#IN6_IS_ADDR_MC_LINKLOCAL
(
a
) \

515 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

516 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x2))

	)

518 
	#IN6_IS_ADDR_MC_SITELOCAL
(
a
) \

519 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

520 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x5))

	)

522 
	#IN6_IS_ADDR_MC_ORGLOCAL
(
a
) \

523 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

524 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x8))

	)

526 
	#IN6_IS_ADDR_MC_GLOBAL
(
a
) \

527 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

528 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0xe))

	)

531 #ifdeà
__USE_GNU


532 
cmsghdr
;

534 #ià!
__USE_KERNEL_IPV6_DEFS


536 
	sš6_pktšfo


538 
š6_addr
 
i6_addr
;

539 
i6_ifšdex
;

543 
	s6_mtušfo


545 
sockaddr_š6
 
6m_addr
;

546 
ušt32_t
 
6m_mtu
;

551 
	$š‘6_İtiÚ_¥aû
 (
__nby‹s
)

552 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

553 
	$š‘6_İtiÚ_š™
 (*
__bp
, 
cmsghdr
 **
__cmsgp
,

554 
__ty³
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

555 
	$š‘6_İtiÚ_­³nd
 (
cmsghdr
 *
__cmsg
,

556 cÚ¡ 
ušt8_t
 *
__ty³p
, 
__muÉx
,

557 
__¶usy
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

558 
ušt8_t
 *
	$š‘6_İtiÚ_®loc
 (
cmsghdr
 *
__cmsg
, 
__d©®’
,

559 
__muÉx
, 
__¶usy
)

560 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

561 
	$š‘6_İtiÚ_Ãxt
 (cÚ¡ 
cmsghdr
 *
__cmsg
,

562 
ušt8_t
 **
__Œp
)

563 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

564 
	$š‘6_İtiÚ_fšd
 (cÚ¡ 
cmsghdr
 *
__cmsg
,

565 
ušt8_t
 **
__Œp
, 
__ty³
)

566 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

570 
	$š‘6_İt_š™
 (*
__extbuf
, 
sockËn_t
 
__ex’
è
__THROW
;

571 
	$š‘6_İt_­³nd
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

572 
ušt8_t
 
__ty³
, 
sockËn_t
 
__Ën
, ušt8_ˆ
__®ign
,

573 **
__d©abuå
è
__THROW
;

574 
	$š‘6_İt_fšish
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
)

575 
__THROW
;

576 
	$š‘6_İt_£t_v®
 (*
__d©abuf
, 
__off£t
, *
__v®
,

577 
sockËn_t
 
__v®Ën
è
__THROW
;

578 
	$š‘6_İt_Ãxt
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

579 
ušt8_t
 *
__ty³p
, 
sockËn_t
 *
__ËÅ
,

580 **
__d©abuå
è
__THROW
;

581 
	$š‘6_İt_fšd
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

582 
ušt8_t
 
__ty³
, 
sockËn_t
 *
__ËÅ
,

583 **
__d©abuå
è
__THROW
;

584 
	$š‘6_İt_g‘_v®
 (*
__d©abuf
, 
__off£t
, *
__v®
,

585 
sockËn_t
 
__v®Ën
è
__THROW
;

589 
sockËn_t
 
	$š‘6_¹h_¥aû
 (
__ty³
, 
__£gm’ts
è
__THROW
;

590 *
	$š‘6_¹h_š™
 (*
__bp
, 
sockËn_t
 
__bp_Ën
, 
__ty³
,

591 
__£gm’ts
è
__THROW
;

592 
	$š‘6_¹h_add
 (*
__bp
, cÚ¡ 
š6_addr
 *
__addr
è
__THROW
;

593 
	$š‘6_¹h_»v”£
 (cÚ¡ *
__š
, *
__out
è
__THROW
;

594 
	$š‘6_¹h_£gm’ts
 (cÚ¡ *
__bp
è
__THROW
;

595 
š6_addr
 *
	$š‘6_¹h_g‘addr
 (cÚ¡ *
__bp
, 
__šdex
)

596 
__THROW
;

602 
	$g‘v4sourûf‹r
 (
__s
, 
š_addr
 
__š‹rçû_addr
,

603 
š_addr
 
__group
, 
ušt32_t
 *
__fmode
,

604 
ušt32_t
 *
__num¤c
, 
š_addr
 *
__¦i¡
)

605 
__THROW
;

608 
	$£tv4sourûf‹r
 (
__s
, 
š_addr
 
__š‹rçû_addr
,

609 
š_addr
 
__group
, 
ušt32_t
 
__fmode
,

610 
ušt32_t
 
__num¤c
,

611 cÚ¡ 
š_addr
 *
__¦i¡
)

612 
__THROW
;

616 
	$g‘sourûf‹r
 (
__s
, 
ušt32_t
 
__š‹rçû_addr
,

617 cÚ¡ 
sockaddr
 *
__group
,

618 
sockËn_t
 
__grou¶’
, 
ušt32_t
 *
__fmode
,

619 
ušt32_t
 *
__num¤c
,

620 
sockaddr_¡Üage
 *
__¦i¡
è
__THROW
;

623 
	$£tsourûf‹r
 (
__s
, 
ušt32_t
 
__š‹rçû_addr
,

624 cÚ¡ 
sockaddr
 *
__group
,

625 
sockËn_t
 
__grou¶’
, 
ušt32_t
 
__fmode
,

626 
ušt32_t
 
__num¤c
,

627 cÚ¡ 
sockaddr_¡Üage
 *
__¦i¡
è
__THROW
;

630 
__END_DECLS


	@/usr/include/netinet/tcp.h

32 #iâdeà
_NETINET_TCP_H


33 
	#_NETINET_TCP_H
 1

	)

35 
	~<ã©u»s.h
>

40 
	#TCP_NODELAY
 1

	)

41 
	#TCP_MAXSEG
 2

	)

42 
	#TCP_CORK
 3

	)

43 
	#TCP_KEEPIDLE
 4

	)

44 
	#TCP_KEEPINTVL
 5

	)

45 
	#TCP_KEEPCNT
 6

	)

46 
	#TCP_SYNCNT
 7

	)

47 
	#TCP_LINGER2
 8

	)

48 
	#TCP_DEFER_ACCEPT
 9

	)

49 
	#TCP_WINDOW_CLAMP
 10

	)

50 
	#TCP_INFO
 11

	)

51 
	#TCP_QUICKACK
 12

	)

52 
	#TCP_CONGESTION
 13

	)

53 
	#TCP_MD5SIG
 14

	)

54 
	#TCP_COOKIE_TRANSACTIONS
 15

	)

55 
	#TCP_THIN_LINEAR_TIMEOUTS
 16

	)

56 
	#TCP_THIN_DUPACK
 17

	)

57 
	#TCP_USER_TIMEOUT
 18

	)

58 
	#TCP_REPAIR
 19

	)

59 
	#TCP_REPAIR_QUEUE
 20

	)

60 
	#TCP_QUEUE_SEQ
 21

	)

61 
	#TCP_REPAIR_OPTIONS
 22

	)

62 
	#TCP_FASTOPEN
 23

	)

63 
	#TCP_TIMESTAMP
 24

	)

64 
	#TCP_NOTSENT_LOWAT
 25

	)

66 
	#TCP_CC_INFO
 26

	)

68 
	#TCP_SAVE_SYN
 27

	)

70 
	#TCP_SAVED_SYN
 28

	)

72 
	#TCP_REPAIR_WINDOW
 29

	)

73 
	#TCP_FASTOPEN_CONNECT
 30

	)

74 
	#TCP_ULP
 31

	)

75 
	#TCP_MD5SIG_EXT
 32

	)

77 #ifdeà
__USE_MISC


78 
	~<sys/ty³s.h
>

79 
	~<sys/sock‘.h
>

80 
	~<¡dšt.h
>

82 
ušt32_t
 
	ttı_£q
;

87 
	stıhdr


89 
__ex‹nsiÚ__
 union

93 
ušt16_t
 
	mth_¥Üt
;

94 
ušt16_t
 
	mth_dpÜt
;

95 
tı_£q
 
	mth_£q
;

96 
tı_£q
 
	mth_ack
;

97 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


98 
ušt8_t
 
	mth_x2
:4;

99 
ušt8_t
 
	mth_off
:4;

101 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


102 
ušt8_t
 
	mth_off
:4;

103 
ušt8_t
 
	mth_x2
:4;

105 
ušt8_t
 
	mth_æags
;

106 
	#TH_FIN
 0x01

	)

107 
	#TH_SYN
 0x02

	)

108 
	#TH_RST
 0x04

	)

109 
	#TH_PUSH
 0x08

	)

110 
	#TH_ACK
 0x10

	)

111 
	#TH_URG
 0x20

	)

112 
ušt16_t
 
	mth_wš
;

113 
ušt16_t
 
	mth_sum
;

114 
ušt16_t
 
	mth_u½
;

118 
ušt16_t
 
	msourû
;

119 
ušt16_t
 
	mde¡
;

120 
ušt32_t
 
	m£q
;

121 
ušt32_t
 
	mack_£q
;

122 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


123 
ušt16_t
 
	m»s1
:4;

124 
ušt16_t
 
	mdoff
:4;

125 
ušt16_t
 
	mfš
:1;

126 
ušt16_t
 
	msyn
:1;

127 
ušt16_t
 
	mr¡
:1;

128 
ušt16_t
 
	mpsh
:1;

129 
ušt16_t
 
	mack
:1;

130 
ušt16_t
 
	murg
:1;

131 
ušt16_t
 
	m»s2
:2;

132 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


133 
ušt16_t
 
	mdoff
:4;

134 
ušt16_t
 
	m»s1
:4;

135 
ušt16_t
 
	m»s2
:2;

136 
ušt16_t
 
	murg
:1;

137 
ušt16_t
 
	mack
:1;

138 
ušt16_t
 
	mpsh
:1;

139 
ušt16_t
 
	mr¡
:1;

140 
ušt16_t
 
	msyn
:1;

141 
ušt16_t
 
	mfš
:1;

145 
ušt16_t
 
	mwšdow
;

146 
ušt16_t
 
	mcheck
;

147 
ušt16_t
 
	murg_±r
;

154 
	mTCP_ESTABLISHED
 = 1,

155 
	mTCP_SYN_SENT
,

156 
	mTCP_SYN_RECV
,

157 
	mTCP_FIN_WAIT1
,

158 
	mTCP_FIN_WAIT2
,

159 
	mTCP_TIME_WAIT
,

160 
	mTCP_CLOSE
,

161 
	mTCP_CLOSE_WAIT
,

162 
	mTCP_LAST_ACK
,

163 
	mTCP_LISTEN
,

164 
	mTCP_CLOSING


167 
	#TCPOPT_EOL
 0

	)

168 
	#TCPOPT_NOP
 1

	)

169 
	#TCPOPT_MAXSEG
 2

	)

170 
	#TCPOLEN_MAXSEG
 4

	)

171 
	#TCPOPT_WINDOW
 3

	)

172 
	#TCPOLEN_WINDOW
 3

	)

173 
	#TCPOPT_SACK_PERMITTED
 4

	)

174 
	#TCPOLEN_SACK_PERMITTED
 2

	)

175 
	#TCPOPT_SACK
 5

	)

176 
	#TCPOPT_TIMESTAMP
 8

	)

177 
	#TCPOLEN_TIMESTAMP
 10

	)

178 
	#TCPOLEN_TSTAMP_APPA
 (
TCPOLEN_TIMESTAMP
+2è

	)

180 
	#TCPOPT_TSTAMP_HDR
 \

181 (
TCPOPT_NOP
<<24|TCPOPT_NOP<<16|
TCPOPT_TIMESTAMP
<<8|
TCPOLEN_TIMESTAMP
)

	)

189 
	#TCP_MSS
 512

	)

191 
	#TCP_MAXWIN
 65535

	)

193 
	#TCP_MAX_WINSHIFT
 14

	)

195 
	#SOL_TCP
 6

	)

198 
	#TCPI_OPT_TIMESTAMPS
 1

	)

199 
	#TCPI_OPT_SACK
 2

	)

200 
	#TCPI_OPT_WSCALE
 4

	)

201 
	#TCPI_OPT_ECN
 8

	)

202 
	#TCPI_OPT_ECN_SEEN
 16

	)

203 
	#TCPI_OPT_SYN_DATA
 32

	)

206 
	etı_ÿ_¡©e


208 
	mTCP_CA_O³n
 = 0,

209 
	mTCP_CA_DisÜd”
 = 1,

210 
	mTCP_CA_CWR
 = 2,

211 
	mTCP_CA_Recov”y
 = 3,

212 
	mTCP_CA_Loss
 = 4

215 
	stı_šfo


217 
ušt8_t
 
	mtıi_¡©e
;

218 
ušt8_t
 
	mtıi_ÿ_¡©e
;

219 
ušt8_t
 
	mtıi_»Œªsm™s
;

220 
ušt8_t
 
	mtıi_´obes
;

221 
ušt8_t
 
	mtıi_backoff
;

222 
ušt8_t
 
	mtıi_İtiÚs
;

223 
ušt8_t
 
	mtıi_¢d_wsÿË
 : 4, 
	mtıi_rcv_wsÿË
 : 4;

225 
ušt32_t
 
	mtıi_¹o
;

226 
ušt32_t
 
	mtıi_©o
;

227 
ušt32_t
 
	mtıi_¢d_mss
;

228 
ušt32_t
 
	mtıi_rcv_mss
;

230 
ušt32_t
 
	mtıi_uÇcked
;

231 
ušt32_t
 
	mtıi_§cked
;

232 
ušt32_t
 
	mtıi_lo¡
;

233 
ušt32_t
 
	mtıi_»Œªs
;

234 
ušt32_t
 
	mtıi_çck‘s
;

237 
ušt32_t
 
	mtıi_Ï¡_d©a_£Á
;

238 
ušt32_t
 
	mtıi_Ï¡_ack_£Á
;

239 
ušt32_t
 
	mtıi_Ï¡_d©a_»cv
;

240 
ušt32_t
 
	mtıi_Ï¡_ack_»cv
;

243 
ušt32_t
 
	mtıi_pmtu
;

244 
ušt32_t
 
	mtıi_rcv_s¡h»sh
;

245 
ušt32_t
 
	mtıi_¹t
;

246 
ušt32_t
 
	mtıi_¹tv¬
;

247 
ušt32_t
 
	mtıi_¢d_s¡h»sh
;

248 
ušt32_t
 
	mtıi_¢d_cwnd
;

249 
ušt32_t
 
	mtıi_advmss
;

250 
ušt32_t
 
	mtıi_»Üd”šg
;

252 
ušt32_t
 
	mtıi_rcv_¹t
;

253 
ušt32_t
 
	mtıi_rcv_¥aû
;

255 
ušt32_t
 
	mtıi_tÙ®_»Œªs
;

260 
	#TCP_MD5SIG_MAXKEYLEN
 80

	)

263 
	#TCP_MD5SIG_FLAG_PREFIX
 1

	)

265 
	stı_md5sig


267 
sockaddr_¡Üage
 
	mtım_addr
;

268 
ušt8_t
 
	mtım_æags
;

269 
ušt8_t
 
	mtım_´efixËn
;

270 
ušt16_t
 
	mtım_keyËn
;

271 
ušt32_t
 
	m__tım_·d
;

272 
ušt8_t
 
	mtım_key
[
TCP_MD5SIG_MAXKEYLEN
];

276 
	stı_»·œ_İt


278 
ušt32_t
 
	mİt_code
;

279 
ušt32_t
 
	mİt_v®
;

285 
	mTCP_NO_QUEUE
,

286 
	mTCP_RECV_QUEUE
,

287 
	mTCP_SEND_QUEUE
,

288 
	mTCP_QUEUES_NR
,

292 
	#TCP_COOKIE_MIN
 8

	)

293 
	#TCP_COOKIE_MAX
 16

	)

294 
	#TCP_COOKIE_PAIR_SIZE
 (2*
TCP_COOKIE_MAX
)

	)

297 
	#TCP_COOKIE_IN_ALWAYS
 (1 << 0è

	)

298 
	#TCP_COOKIE_OUT_NEVER
 (1 << 1è

	)

302 
	#TCP_S_DATA_IN
 (1 << 2è

	)

303 
	#TCP_S_DATA_OUT
 (1 << 3è

	)

305 
	#TCP_MSS_DEFAULT
 536U

	)

306 
	#TCP_MSS_DESIRED
 1220U

	)

308 
	stı_cook›_Œª§ùiÚs


310 
ušt16_t
 
	mtıù_æags
;

311 
ušt8_t
 
	m__tıù_·d1
;

312 
ušt8_t
 
	mtıù_cook›_desœed
;

313 
ušt16_t
 
	mtıù_s_d©a_desœed
;

314 
ušt16_t
 
	mtıù_u£d
;

315 
ušt8_t
 
	mtıù_v®ue
[
TCP_MSS_DEFAULT
];

319 
	stı_»·œ_wšdow


321 
ušt32_t
 
	m¢d_wl1
;

322 
ušt32_t
 
	m¢d_wnd
;

323 
ušt32_t
 
	mmax_wšdow
;

324 
ušt32_t
 
	mrcv_wnd
;

325 
ušt32_t
 
	mrcv_wup
;

	@/usr/include/pthread.h

18 #iâdeà
_PTHREAD_H


19 
	#_PTHREAD_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<’dŸn.h
>

23 
	~<sched.h
>

24 
	~<time.h
>

26 
	~<b™s/±h»adty³s.h
>

27 
	~<b™s/£tjmp.h
>

28 
	~<b™s/wÜdsize.h
>

29 
	~<b™s/ty³s/¡ruù_time¥ec.h
>

35 
	mPTHREAD_CREATE_JOINABLE
,

36 
	#PTHREAD_CREATE_JOINABLE
 
PTHREAD_CREATE_JOINABLE


	)

37 
	mPTHREAD_CREATE_DETACHED


38 
	#PTHREAD_CREATE_DETACHED
 
PTHREAD_CREATE_DETACHED


	)

45 
	mPTHREAD_MUTEX_TIMED_NP
,

46 
	mPTHREAD_MUTEX_RECURSIVE_NP
,

47 
	mPTHREAD_MUTEX_ERRORCHECK_NP
,

48 
	mPTHREAD_MUTEX_ADAPTIVE_NP


49 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


51 
	mPTHREAD_MUTEX_NORMAL
 = 
PTHREAD_MUTEX_TIMED_NP
,

52 
	mPTHREAD_MUTEX_RECURSIVE
 = 
PTHREAD_MUTEX_RECURSIVE_NP
,

53 
	mPTHREAD_MUTEX_ERRORCHECK
 = 
PTHREAD_MUTEX_ERRORCHECK_NP
,

54 
	mPTHREAD_MUTEX_DEFAULT
 = 
PTHREAD_MUTEX_NORMAL


56 #ifdeà
__USE_GNU


58 , 
	mPTHREAD_MUTEX_FAST_NP
 = 
PTHREAD_MUTEX_TIMED_NP


63 #ifdeà
__USE_XOPEN2K


67 
	mPTHREAD_MUTEX_STALLED
,

68 
	mPTHREAD_MUTEX_STALLED_NP
 = 
PTHREAD_MUTEX_STALLED
,

69 
	mPTHREAD_MUTEX_ROBUST
,

70 
	mPTHREAD_MUTEX_ROBUST_NP
 = 
PTHREAD_MUTEX_ROBUST


75 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


79 
	mPTHREAD_PRIO_NONE
,

80 
	mPTHREAD_PRIO_INHERIT
,

81 
	mPTHREAD_PRIO_PROTECT


86 #ià
__PTHREAD_MUTEX_HAVE_PREV


87 
	#PTHREAD_MUTEX_INITIALIZER
 \

88 { { 0, 0, 0, 0, 0, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

89 #ifdeà
__USE_GNU


90 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

91 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

92 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

93 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

94 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

95 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

99 
	#PTHREAD_MUTEX_INITIALIZER
 \

100 { { 0, 0, 0, 0, 0, { 
__PTHREAD_SPINS
 } } }

	)

101 #ifdeà
__USE_GNU


102 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

103 { { 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

104 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

105 { { 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

106 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

107 { { 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

114 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


117 
	mPTHREAD_RWLOCK_PREFER_READER_NP
,

118 
	mPTHREAD_RWLOCK_PREFER_WRITER_NP
,

119 
	mPTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,

120 
	mPTHREAD_RWLOCK_DEFAULT_NP
 = 
PTHREAD_RWLOCK_PREFER_READER_NP


126 #iâdeà
__PTHREAD_RWLOCK_INT_FLAGS_SHARED


127 #ià
__WORDSIZE
 == 64

128 
	#__PTHREAD_RWLOCK_INT_FLAGS_SHARED
 1

	)

133 
	#PTHREAD_RWLOCK_INITIALIZER
 \

134 { { 0, 0, 0, 0, 0, 0, 0, 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, 0 } }

	)

135 #ifdeà
__USE_GNU


136 #ifdeà
__PTHREAD_RWLOCK_INT_FLAGS_SHARED


137 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

138 { { 0, 0, 0, 0, 0, 0, 0, 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, \

139 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
 } }

	)

141 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


142 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

143 { { 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
, \

144 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, 0 } }

	)

146 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

147 { { 0, 0, 0, 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,\

148 0 } }

	)

158 
	mPTHREAD_INHERIT_SCHED
,

159 
	#PTHREAD_INHERIT_SCHED
 
PTHREAD_INHERIT_SCHED


	)

160 
	mPTHREAD_EXPLICIT_SCHED


161 
	#PTHREAD_EXPLICIT_SCHED
 
PTHREAD_EXPLICIT_SCHED


	)

168 
	mPTHREAD_SCOPE_SYSTEM
,

169 
	#PTHREAD_SCOPE_SYSTEM
 
PTHREAD_SCOPE_SYSTEM


	)

170 
	mPTHREAD_SCOPE_PROCESS


171 
	#PTHREAD_SCOPE_PROCESS
 
PTHREAD_SCOPE_PROCESS


	)

178 
	mPTHREAD_PROCESS_PRIVATE
,

179 
	#PTHREAD_PROCESS_PRIVATE
 
PTHREAD_PROCESS_PRIVATE


	)

180 
	mPTHREAD_PROCESS_SHARED


181 
	#PTHREAD_PROCESS_SHARED
 
PTHREAD_PROCESS_SHARED


	)

187 
	#PTHREAD_COND_INITIALIZER
 { { {0}, {0}, {0, 0}, {0, 0}, 0, 0, {0, 0} } }

	)

191 
	s_±h»ad_ş—nup_bufãr


193 (*
	m__routše
) (*);

194 *
	m__¬g
;

195 
	m__ÿnûÉy³
;

196 
_±h»ad_ş—nup_bufãr
 *
	m__´ev
;

202 
	mPTHREAD_CANCEL_ENABLE
,

203 
	#PTHREAD_CANCEL_ENABLE
 
PTHREAD_CANCEL_ENABLE


	)

204 
	mPTHREAD_CANCEL_DISABLE


205 
	#PTHREAD_CANCEL_DISABLE
 
PTHREAD_CANCEL_DISABLE


	)

209 
	mPTHREAD_CANCEL_DEFERRED
,

210 
	#PTHREAD_CANCEL_DEFERRED
 
PTHREAD_CANCEL_DEFERRED


	)

211 
	mPTHREAD_CANCEL_ASYNCHRONOUS


212 
	#PTHREAD_CANCEL_ASYNCHRONOUS
 
PTHREAD_CANCEL_ASYNCHRONOUS


	)

214 
	#PTHREAD_CANCELED
 ((*è-1)

	)

218 
	#PTHREAD_ONCE_INIT
 0

	)

221 #ifdeà
__USE_XOPEN2K


225 
	#PTHREAD_BARRIER_SERIAL_THREAD
 -1

	)

229 
__BEGIN_DECLS


234 
	$±h»ad_ü—‹
 (
±h»ad_t
 *
__»¡riù
 
__Ãwth»ad
,

235 cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

236 *(*
__¡¬t_routše
) (*),

237 *
__»¡riù
 
__¬g
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 3));

243 
	$±h»ad_ex™
 (*
__»tv®
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

251 
	`±h»ad_još
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
);

253 #ifdeà
__USE_GNU


256 
	$±h»ad_Œyjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
è
__THROW
;

264 
	`±h»ad_timedjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
,

265 cÚ¡ 
time¥ec
 *
__ab¡ime
);

272 
	$±h»ad_d‘ach
 (
±h»ad_t
 
__th
è
__THROW
;

276 
±h»ad_t
 
	$±h»ad_£lf
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

279 
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
)

280 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

288 
	$±h»ad_©Œ_š™
 (
±h»ad_©Œ_t
 *
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

291 
	$±h»ad_©Œ_de¡roy
 (
±h»ad_©Œ_t
 *
__©Œ
)

292 
__THROW
 
	`__nÚnuÎ
 ((1));

295 
	$±h»ad_©Œ_g‘d‘ach¡©e
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

296 *
__d‘ach¡©e
)

297 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

300 
	$±h»ad_©Œ_£td‘ach¡©e
 (
±h»ad_©Œ_t
 *
__©Œ
,

301 
__d‘ach¡©e
)

302 
__THROW
 
	`__nÚnuÎ
 ((1));

306 
	$±h»ad_©Œ_g‘gu¬dsize
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

307 
size_t
 *
__gu¬dsize
)

308 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

311 
	$±h»ad_©Œ_£tgu¬dsize
 (
±h»ad_©Œ_t
 *
__©Œ
,

312 
size_t
 
__gu¬dsize
)

313 
__THROW
 
	`__nÚnuÎ
 ((1));

317 
	$±h»ad_©Œ_g‘sched·¿m
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

318 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

319 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

322 
	$±h»ad_©Œ_£tsched·¿m
 (
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

323 cÚ¡ 
sched_·¿m
 *
__»¡riù


324 
__·¿m
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

327 
	$±h»ad_©Œ_g‘schedpŞicy
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


328 
__©Œ
, *
__»¡riù
 
__pŞicy
)

329 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

332 
	$±h»ad_©Œ_£tschedpŞicy
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__pŞicy
)

333 
__THROW
 
	`__nÚnuÎ
 ((1));

336 
	$±h»ad_©Œ_g‘šh”™sched
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


337 
__©Œ
, *
__»¡riù
 
__šh”™
)

338 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

341 
	$±h»ad_©Œ_£tšh”™sched
 (
±h»ad_©Œ_t
 *
__©Œ
,

342 
__šh”™
)

343 
__THROW
 
	`__nÚnuÎ
 ((1));

347 
	$±h»ad_©Œ_g‘scİe
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

348 *
__»¡riù
 
__scİe
)

349 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

352 
	$±h»ad_©Œ_£tscİe
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__scİe
)

353 
__THROW
 
	`__nÚnuÎ
 ((1));

356 
	$±h»ad_©Œ_g‘¡ackaddr
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


357 
__©Œ
, **
__»¡riù
 
__¡ackaddr
)

358 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__©Œibu‹_d•»ÿ‹d__
;

364 
	$±h»ad_©Œ_£t¡ackaddr
 (
±h»ad_©Œ_t
 *
__©Œ
,

365 *
__¡ackaddr
)

366 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
;

369 
	$±h»ad_©Œ_g‘¡acksize
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


370 
__©Œ
, 
size_t
 *
__»¡riù
 
__¡acksize
)

371 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

376 
	$±h»ad_©Œ_£t¡acksize
 (
±h»ad_©Œ_t
 *
__©Œ
,

377 
size_t
 
__¡acksize
)

378 
__THROW
 
	`__nÚnuÎ
 ((1));

380 #ifdeà
__USE_XOPEN2K


382 
	$±h»ad_©Œ_g‘¡ack
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

383 **
__»¡riù
 
__¡ackaddr
,

384 
size_t
 *
__»¡riù
 
__¡acksize
)

385 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

390 
	$±h»ad_©Œ_£t¡ack
 (
±h»ad_©Œ_t
 *
__©Œ
, *
__¡ackaddr
,

391 
size_t
 
__¡acksize
è
__THROW
 
	`__nÚnuÎ
 ((1));

394 #ifdeà
__USE_GNU


397 
	$±h»ad_©Œ_£ffš™y_Å
 (
±h»ad_©Œ_t
 *
__©Œ
,

398 
size_t
 
__ıu£tsize
,

399 cÚ¡ 
ıu_£t_t
 *
__ıu£t
)

400 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

404 
	$±h»ad_©Œ_g‘affš™y_Å
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

405 
size_t
 
__ıu£tsize
,

406 
ıu_£t_t
 *
__ıu£t
)

407 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

410 
	$±h»ad_g‘©Œ_deçuÉ_Å
 (
±h»ad_©Œ_t
 *
__©Œ
)

411 
__THROW
 
	`__nÚnuÎ
 ((1));

415 
	$±h»ad_£‰r_deçuÉ_Å
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
)

416 
__THROW
 
	`__nÚnuÎ
 ((1));

421 
	$±h»ad_g‘©Œ_Å
 (
±h»ad_t
 
__th
, 
±h»ad_©Œ_t
 *
__©Œ
)

422 
__THROW
 
	`__nÚnuÎ
 ((2));

430 
	$±h»ad_£tsched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
, 
__pŞicy
,

431 cÚ¡ 
sched_·¿m
 *
__·¿m
)

432 
__THROW
 
	`__nÚnuÎ
 ((3));

435 
	$±h»ad_g‘sched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
,

436 *
__»¡riù
 
__pŞicy
,

437 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

438 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

441 
	$±h»ad_£tsched´io
 (
±h»ad_t
 
__rg‘_th»ad
, 
__´io
)

442 
__THROW
;

445 #ifdeà
__USE_GNU


447 
	$±h»ad_g‘Çme_Å
 (
±h»ad_t
 
__rg‘_th»ad
, *
__buf
,

448 
size_t
 
__buæ’
)

449 
__THROW
 
	`__nÚnuÎ
 ((2));

452 
	$±h»ad_£Šame_Å
 (
±h»ad_t
 
__rg‘_th»ad
, cÚ¡ *
__Çme
)

453 
__THROW
 
	`__nÚnuÎ
 ((2));

457 #ifdeà
__USE_UNIX98


459 
	$±h»ad_g‘cÚcu¼’cy
 (è
__THROW
;

462 
	$±h»ad_£tcÚcu¼’cy
 (
__Ëv–
è
__THROW
;

465 #ifdeà
__USE_GNU


470 
	$±h»ad_y›ld
 (è
__THROW
;

475 
	$±h»ad_£ffš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

476 cÚ¡ 
ıu_£t_t
 *
__ıu£t
)

477 
__THROW
 
	`__nÚnuÎ
 ((3));

480 
	$±h»ad_g‘affš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

481 
ıu_£t_t
 *
__ıu£t
)

482 
__THROW
 
	`__nÚnuÎ
 ((3));

495 
	$±h»ad_Úû
 (
±h»ad_Úû_t
 *
__Úû_cÚŒŞ
,

496 (*
__š™_routše
è()è
	`__nÚnuÎ
 ((1, 2));

507 
	`±h»ad_£tÿnûl¡©e
 (
__¡©e
, *
__Şd¡©e
);

511 
	`±h»ad_£tÿnûÉy³
 (
__ty³
, *
__Şdty³
);

514 
	`±h»ad_ÿnûl
 (
±h»ad_t
 
__th
);

519 
	`±h»ad_‹¡ÿnûl
 ();

528 
__jmp_buf
 
__ÿnûl_jmp_buf
;

529 
__mask_was_§ved
;

530 } 
__ÿnûl_jmp_buf
[1];

531 *
__·d
[4];

532 } 
	t__±h»ad_unwšd_buf_t
 
	t__©Œibu‹__
 ((
	t__®igÃd__
));

535 #iâdeà
__ş—nup_fù_©Œibu‹


536 
	#__ş—nup_fù_©Œibu‹


	)

541 
	s__±h»ad_ş—nup_äame


543 (*
__ÿnûl_routše
) (*);

544 *
__ÿnûl_¬g
;

545 
__do_™
;

546 
__ÿnûl_ty³
;

549 #ià
defšed
 
__GNUC__
 && defšed 
__EXCEPTIONS


550 #ifdeà
__ılu¥lus


552 şas 
	c__±h»ad_ş—nup_şass


554 (*
__ÿnûl_routše
) (*);

555 *
__ÿnûl_¬g
;

556 
__do_™
;

557 
__ÿnûl_ty³
;

559 
public
:

560 
	$__±h»ad_ş—nup_şass
 ((*
__fù
è(*), *
__¬g
)

561 : 
	`__ÿnûl_routše
 (
__fù
), 
	`__ÿnûl_¬g
 (
__¬g
), 
	$__do_™
 (1) { }

562 ~
	$__±h»ad_ş—nup_şass
 (è{ ià(
__do_™
è
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); 
	}
}

563 
	$__£tdo™
 (
__Ãwv®
è{ 
__do_™
 = __Ãwv®; 
	}
}

564 
	$__deãr
 (è{ 
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
,

565 &
__ÿnûl_ty³
); 
	}
}

566 
	$__»¡Üe
 (ècÚ¡ { 
	`±h»ad_£tÿnûÉy³
 (
__ÿnûl_ty³
, 0); 
	}
}

576 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

578 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
)

	)

582 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

583 
__şäame
.
	`__£tdo™
 (
execu‹
); \

584 } 0)

	)

586 #ifdeà
__USE_GNU


590 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

592 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
); \

593 
__şäame
.
	`__deãr
 ()

	)

598 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

599 
__şäame
.
	`__»¡Üe
 (); \

600 
__şäame
.
	`__£tdo™
 (
execu‹
); \

601 } 0)

	)

608 
__ex‹º_šlše
 

609 
	$__±h»ad_ş—nup_routše
 (
__±h»ad_ş—nup_äame
 *
__äame
)

611 ià(
__äame
->
__do_™
)

612 
__äame
->
	`__ÿnûl_routše
 (__äame->
__ÿnûl_¬g
);

613 
	}
}

622 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

624 
__±h»ad_ş—nup_äame
 
__şäame
 \

625 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

626 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

627 .
__do_™
 = 1 };

	)

631 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

632 
__şäame
.
__do_™
 = (
execu‹
); \

633 } 0)

	)

635 #ifdeà
__USE_GNU


639 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

641 
__±h»ad_ş—nup_äame
 
__şäame
 \

642 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

643 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

644 .
__do_™
 = 1 }; \

645 (è
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
, \

646 &
__şäame
.
__ÿnûl_ty³
)

	)

651 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

652 (è
	`±h»ad_£tÿnûÉy³
 (
__şäame
.
__ÿnûl_ty³
, 
NULL
); \

653 
__şäame
.
__do_™
 = (
execu‹
); \

654 } 0)

	)

665 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

667 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

668 (*
__ÿnûl_routše
è(*èğ(
routše
); \

669 *
__ÿnûl_¬g
 = (
¬g
); \

670 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

671 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

672 ià(
	`__glibc_uÆik–y
 (
__nÙ_fœ¡_ÿÎ
)) \

674 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

675 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

679 
	`__±h»ad_»gi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

680 dØ{

	)

681 
__±h»ad_»gi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

682 
__ş—nup_fù_©Œibu‹
;

686 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

689 
	`__±h»ad_uÄegi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

690 ià(
execu‹
) \

691 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

692 } 0)

	)

693 
	$__±h»ad_uÄegi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

694 
__ş—nup_fù_©Œibu‹
;

696 #ifdeà
__USE_GNU


700 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

702 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

703 (*
__ÿnûl_routše
è(*èğ(
routše
); \

704 *
__ÿnûl_¬g
 = (
¬g
); \

705 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

706 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

707 ià(
	`__glibc_uÆik–y
 (
__nÙ_fœ¡_ÿÎ
)) \

709 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

710 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

714 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (&
__ÿnûl_buf
); \

715 dØ{

	)

716 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

717 
__ş—nup_fù_©Œibu‹
;

722 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

725 
	`__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (&
__ÿnûl_buf
); \

726 ià(
execu‹
) \

727 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

728 
	}
} 0)

	)

729 
	$__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

730 
__ş—nup_fù_©Œibu‹
;

734 
	$__±h»ad_unwšd_Ãxt
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

735 
__ş—nup_fù_©Œibu‹
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
))

736 #iâdeà
SHARED


737 
	`__©Œibu‹__
 ((
__w—k__
))

743 
__jmp_buf_g
;

744 
	$__sig£tjmp
 (
__jmp_buf_g
 *
__’v
, 
__§vemask
è
__THROWNL
;

750 
	$±h»ad_mu‹x_š™
 (
±h»ad_mu‹x_t
 *
__mu‹x
,

751 cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__mu‹x©Œ
)

752 
__THROW
 
	`__nÚnuÎ
 ((1));

755 
	$±h»ad_mu‹x_de¡roy
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

756 
__THROW
 
	`__nÚnuÎ
 ((1));

759 
	$±h»ad_mu‹x_Œylock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

760 
__THROWNL
 
	`__nÚnuÎ
 ((1));

763 
	$±h»ad_mu‹x_lock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

764 
__THROWNL
 
	`__nÚnuÎ
 ((1));

766 #ifdeà
__USE_XOPEN2K


768 
	$±h»ad_mu‹x_timedlock
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

769 cÚ¡ 
time¥ec
 *
__»¡riù


770 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

774 
	$±h»ad_mu‹x_uÆock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

775 
__THROWNL
 
	`__nÚnuÎ
 ((1));

779 
	$±h»ad_mu‹x_g‘´ioûšg
 (cÚ¡ 
±h»ad_mu‹x_t
 *

780 
__»¡riù
 
__mu‹x
,

781 *
__»¡riù
 
__´ioûšg
)

782 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

786 
	$±h»ad_mu‹x_£rioûšg
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

787 
__´ioûšg
,

788 *
__»¡riù
 
__Şd_ûšg
)

789 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

792 #ifdeà
__USE_XOPEN2K8


794 
	$±h»ad_mu‹x_cÚsi¡’t
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

795 
__THROW
 
	`__nÚnuÎ
 ((1));

796 #ifdeà
__USE_GNU


797 
	$±h»ad_mu‹x_cÚsi¡’t_Å
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

798 
__THROW
 
	`__nÚnuÎ
 ((1));

807 
	$±h»ad_mu‹x©Œ_š™
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

808 
__THROW
 
	`__nÚnuÎ
 ((1));

811 
	$±h»ad_mu‹x©Œ_de¡roy
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

812 
__THROW
 
	`__nÚnuÎ
 ((1));

815 
	$±h»ad_mu‹x©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

816 
__»¡riù
 
__©Œ
,

817 *
__»¡riù
 
__psh¬ed
)

818 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

821 
	$±h»ad_mu‹x©Œ_£sh¬ed
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

822 
__psh¬ed
)

823 
__THROW
 
	`__nÚnuÎ
 ((1));

825 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


827 
	$±h»ad_mu‹x©Œ_g‘ty³
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__»¡riù


828 
__©Œ
, *
__»¡riù
 
__kšd
)

829 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

834 
	$±h»ad_mu‹x©Œ_£‰y³
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
, 
__kšd
)

835 
__THROW
 
	`__nÚnuÎ
 ((1));

839 
	$±h»ad_mu‹x©Œ_g‘´ÙocŞ
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

840 
__»¡riù
 
__©Œ
,

841 *
__»¡riù
 
__´ÙocŞ
)

842 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

846 
	$±h»ad_mu‹x©Œ_£rÙocŞ
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

847 
__´ÙocŞ
)

848 
__THROW
 
	`__nÚnuÎ
 ((1));

851 
	$±h»ad_mu‹x©Œ_g‘´ioûšg
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

852 
__»¡riù
 
__©Œ
,

853 *
__»¡riù
 
__´ioûšg
)

854 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

857 
	$±h»ad_mu‹x©Œ_£rioûšg
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

858 
__´ioûšg
)

859 
__THROW
 
	`__nÚnuÎ
 ((1));

861 #ifdeà
__USE_XOPEN2K


863 
	$±h»ad_mu‹x©Œ_g‘robu¡
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

864 *
__robu¡Ãss
)

865 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

866 #ifdeà
__USE_GNU


867 
	$±h»ad_mu‹x©Œ_g‘robu¡_Å
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

868 *
__robu¡Ãss
)

869 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

873 
	$±h»ad_mu‹x©Œ_£Œobu¡
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

874 
__robu¡Ãss
)

875 
__THROW
 
	`__nÚnuÎ
 ((1));

876 #ifdeà
__USE_GNU


877 
	$±h»ad_mu‹x©Œ_£Œobu¡_Å
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

878 
__robu¡Ãss
)

879 
__THROW
 
	`__nÚnuÎ
 ((1));

884 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


889 
	$±h»ad_rwlock_š™
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

890 cÚ¡ 
±h»ad_rwlock©Œ_t
 *
__»¡riù


891 
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

894 
	$±h»ad_rwlock_de¡roy
 (
±h»ad_rwlock_t
 *
__rwlock
)

895 
__THROW
 
	`__nÚnuÎ
 ((1));

898 
	$±h»ad_rwlock_rdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

899 
__THROWNL
 
	`__nÚnuÎ
 ((1));

902 
	$±h»ad_rwlock_Œyrdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

903 
__THROWNL
 
	`__nÚnuÎ
 ((1));

905 #ifdeà
__USE_XOPEN2K


907 
	$±h»ad_rwlock_timedrdlock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

908 cÚ¡ 
time¥ec
 *
__»¡riù


909 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

913 
	$±h»ad_rwlock_w¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

914 
__THROWNL
 
	`__nÚnuÎ
 ((1));

917 
	$±h»ad_rwlock_Œyw¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

918 
__THROWNL
 
	`__nÚnuÎ
 ((1));

920 #ifdeà
__USE_XOPEN2K


922 
	$±h»ad_rwlock_timedw¾ock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

923 cÚ¡ 
time¥ec
 *
__»¡riù


924 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

928 
	$±h»ad_rwlock_uÆock
 (
±h»ad_rwlock_t
 *
__rwlock
)

929 
__THROWNL
 
	`__nÚnuÎ
 ((1));

935 
	$±h»ad_rwlock©Œ_š™
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

936 
__THROW
 
	`__nÚnuÎ
 ((1));

939 
	$±h»ad_rwlock©Œ_de¡roy
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

940 
__THROW
 
	`__nÚnuÎ
 ((1));

943 
	$±h»ad_rwlock©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_rwlock©Œ_t
 *

944 
__»¡riù
 
__©Œ
,

945 *
__»¡riù
 
__psh¬ed
)

946 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

949 
	$±h»ad_rwlock©Œ_£sh¬ed
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

950 
__psh¬ed
)

951 
__THROW
 
	`__nÚnuÎ
 ((1));

954 
	$±h»ad_rwlock©Œ_g‘kšd_Å
 (cÚ¡ 
±h»ad_rwlock©Œ_t
 *

955 
__»¡riù
 
__©Œ
,

956 *
__»¡riù
 
__´ef
)

957 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

960 
	$±h»ad_rwlock©Œ_£tkšd_Å
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

961 
__´ef
è
__THROW
 
	`__nÚnuÎ
 ((1));

969 
	$±h»ad_cÚd_š™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

970 cÚ¡ 
±h»ad_cÚd©Œ_t
 *
__»¡riù
 
__cÚd_©Œ
)

971 
__THROW
 
	`__nÚnuÎ
 ((1));

974 
	$±h»ad_cÚd_de¡roy
 (
±h»ad_cÚd_t
 *
__cÚd
)

975 
__THROW
 
	`__nÚnuÎ
 ((1));

978 
	$±h»ad_cÚd_sigÇl
 (
±h»ad_cÚd_t
 *
__cÚd
)

979 
__THROWNL
 
	`__nÚnuÎ
 ((1));

982 
	$±h»ad_cÚd_brßdÿ¡
 (
±h»ad_cÚd_t
 *
__cÚd
)

983 
__THROWNL
 
	`__nÚnuÎ
 ((1));

990 
	$±h»ad_cÚd_wa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

991 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
)

992 
	`__nÚnuÎ
 ((1, 2));

1001 
	$±h»ad_cÚd_timedwa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

1002 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

1003 cÚ¡ 
time¥ec
 *
__»¡riù
 
__ab¡ime
)

1004 
	`__nÚnuÎ
 ((1, 2, 3));

1009 
	$±h»ad_cÚd©Œ_š™
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

1010 
__THROW
 
	`__nÚnuÎ
 ((1));

1013 
	$±h»ad_cÚd©Œ_de¡roy
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

1014 
__THROW
 
	`__nÚnuÎ
 ((1));

1017 
	$±h»ad_cÚd©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_cÚd©Œ_t
 *

1018 
__»¡riù
 
__©Œ
,

1019 *
__»¡riù
 
__psh¬ed
)

1020 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1023 
	$±h»ad_cÚd©Œ_£sh¬ed
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1024 
__psh¬ed
è
__THROW
 
	`__nÚnuÎ
 ((1));

1026 #ifdeà
__USE_XOPEN2K


1028 
	$±h»ad_cÚd©Œ_g‘şock
 (cÚ¡ 
±h»ad_cÚd©Œ_t
 *

1029 
__»¡riù
 
__©Œ
,

1030 
__şockid_t
 *
__»¡riù
 
__şock_id
)

1031 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1034 
	$±h»ad_cÚd©Œ_£tşock
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1035 
__şockid_t
 
__şock_id
)

1036 
__THROW
 
	`__nÚnuÎ
 ((1));

1040 #ifdeà
__USE_XOPEN2K


1045 
	$±h»ad_¥š_š™
 (
±h»ad_¥šlock_t
 *
__lock
, 
__psh¬ed
)

1046 
__THROW
 
	`__nÚnuÎ
 ((1));

1049 
	$±h»ad_¥š_de¡roy
 (
±h»ad_¥šlock_t
 *
__lock
)

1050 
__THROW
 
	`__nÚnuÎ
 ((1));

1053 
	$±h»ad_¥š_lock
 (
±h»ad_¥šlock_t
 *
__lock
)

1054 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1057 
	$±h»ad_¥š_Œylock
 (
±h»ad_¥šlock_t
 *
__lock
)

1058 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1061 
	$±h»ad_¥š_uÆock
 (
±h»ad_¥šlock_t
 *
__lock
)

1062 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1069 
	$±h»ad_b¬r›r_š™
 (
±h»ad_b¬r›r_t
 *
__»¡riù
 
__b¬r›r
,

1070 cÚ¡ 
±h»ad_b¬r›¿‰r_t
 *
__»¡riù


1071 
__©Œ
, 
__couÁ
)

1072 
__THROW
 
	`__nÚnuÎ
 ((1));

1075 
	$±h»ad_b¬r›r_de¡roy
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1076 
__THROW
 
	`__nÚnuÎ
 ((1));

1079 
	$±h»ad_b¬r›r_wa™
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1080 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1084 
	$±h»ad_b¬r›¿‰r_š™
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1085 
__THROW
 
	`__nÚnuÎ
 ((1));

1088 
	$±h»ad_b¬r›¿‰r_de¡roy
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1089 
__THROW
 
	`__nÚnuÎ
 ((1));

1092 
	$±h»ad_b¬r›¿‰r_g‘psh¬ed
 (cÚ¡ 
±h»ad_b¬r›¿‰r_t
 *

1093 
__»¡riù
 
__©Œ
,

1094 *
__»¡riù
 
__psh¬ed
)

1095 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1098 
	$±h»ad_b¬r›¿‰r_£sh¬ed
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
,

1099 
__psh¬ed
)

1100 
__THROW
 
	`__nÚnuÎ
 ((1));

1112 
	$±h»ad_key_ü—‹
 (
±h»ad_key_t
 *
__key
,

1113 (*
__de¡r_funùiÚ
) (*))

1114 
__THROW
 
	`__nÚnuÎ
 ((1));

1117 
	$±h»ad_key_d–‘e
 (
±h»ad_key_t
 
__key
è
__THROW
;

1120 *
	$±h»ad_g‘¥ecific
 (
±h»ad_key_t
 
__key
è
__THROW
;

1123 
	$±h»ad_£t¥ecific
 (
±h»ad_key_t
 
__key
,

1124 cÚ¡ *
__poš‹r
è
__THROW
 ;

1127 #ifdeà
__USE_XOPEN2K


1129 
	$±h»ad_g‘ıuşockid
 (
±h»ad_t
 
__th»ad_id
,

1130 
__şockid_t
 *
__şock_id
)

1131 
__THROW
 
	`__nÚnuÎ
 ((2));

1146 
	$±h»ad_©fÜk
 ((*
__´•¬e
) (),

1147 (*
__·»Á
) (),

1148 (*
__chd
è()è
__THROW
;

1151 #ifdeà
__USE_EXTERN_INLINES


1153 
__ex‹º_šlše
 

1154 
	`__NTH
 (
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
))

1156  
__th»ad1
 =ğ
__th»ad2
;

1157 
	}
}

1160 
	g__END_DECLS


	@/usr/include/signal.h

22 #iâdef 
_SIGNAL_H


23 
	#_SIGNAL_H


	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


29 
	~<b™s/ty³s.h
>

30 
	~<b™s/signum.h
>

32 
	~<b™s/ty³s/sig_©omic_t.h
>

34 #ià
defšed
 
__USE_POSIX


35 
	~<b™s/ty³s/sig£t_t.h
>

38 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


39 #iâdeà
__pid_t_defšed


40 
__pid_t
 
	tpid_t
;

41 
	#__pid_t_defšed


	)

43 #ifdeà
__USE_XOPEN


45 #iâdeà
__uid_t_defšed


46 
__uid_t
 
	tuid_t
;

47 
	#__uid_t_defšed


	)

51 #ifdeà
__USE_POSIX199309


53 
	~<b™s/ty³s/¡ruù_time¥ec.h
>

56 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_XOPEN_EXTENDED


57 
	~<b™s/ty³s/sigšfo_t.h
>

58 
	~<b™s/sigšfo-cÚ¡s.h
>

61 #ifdeà
__USE_MISC


62 
	~<b™s/ty³s/sigv®_t.h
>

65 #ifdeà
__USE_POSIX199309


66 
	~<b™s/ty³s/sigev’t_t.h
>

67 
	~<b™s/sigev’t-cÚ¡s.h
>

72 (*
	t__sighªdËr_t
) ();

77 
__sighªdËr_t
 
	$__sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

78 
__THROW
;

79 #ifdeà
__USE_GNU


80 
__sighªdËr_t
 
	$sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

81 
__THROW
;

87 #ifdeà
__USE_MISC


88 
__sighªdËr_t
 
	$sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

89 
__THROW
;

92 #ifdeà
__REDIRECT_NTH


93 
__sighªdËr_t
 
	`__REDIRECT_NTH
 (
sigÇl
,

94 (
__sig
, 
__sighªdËr_t
 
__hªdËr
),

95 
__sysv_sigÇl
);

97 
	#sigÇl
 
__sysv_sigÇl


	)

101 #ià
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8


104 
__sighªdËr_t
 
	$bsd_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

105 
__THROW
;

111 #ifdeà
__USE_POSIX


112 
	$kl
 (
__pid_t
 
__pid
, 
__sig
è
__THROW
;

115 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


119 
	$kÍg
 (
__pid_t
 
__pg½
, 
__sig
è
__THROW
;

123 
	$¿i£
 (
__sig
è
__THROW
;

125 #ifdeà
__USE_MISC


127 
__sighªdËr_t
 
	$ssigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

128 
__THROW
;

129 
	$gsigÇl
 (
__sig
è
__THROW
;

132 #ifdeà
__USE_XOPEN2K8


134 
	`psigÇl
 (
__sig
, cÚ¡ *
__s
);

137 
	`psigšfo
 (cÚ¡ 
sigšfo_t
 *
__pšfo
, cÚ¡ *
__s
);

149 #ifdeà
__USE_XOPEN_EXTENDED


150 #ifdeà
__GNUC__


151 
	$sig·u£
 (
__sig
è
	`__asm__
 ("__xpg_sigpause");

153 
	`__sig·u£
 (
__sig_Ü_mask
, 
__is_sig
);

155 
	#sig·u£
(
sig
è
	`__sig·u£
 ((sig), 1)

	)

160 #ifdeà
__USE_MISC


167 
	#sigmask
(
sig
è(()(1u << ((sigè- 1)))

	)

170 
	$sigblock
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

173 
	$sig£tmask
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

176 
	$sigg‘mask
 (è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

180 #ifdeà
__USE_MISC


181 
	#NSIG
 
_NSIG


	)

184 #ifdeà
__USE_GNU


185 
__sighªdËr_t
 
	tsighªdËr_t
;

189 #ifdeà
__USE_MISC


190 
__sighªdËr_t
 
	tsig_t
;

193 #ifdeà
__USE_POSIX


196 
	$sigem±y£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

199 
	$sigfl£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

202 
	$sigadd£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

205 
	$sigd–£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

208 
	$sigismemb”
 (cÚ¡ 
sig£t_t
 *
__£t
, 
__signo
)

209 
__THROW
 
	`__nÚnuÎ
 ((1));

211 #ifdeà
__USE_GNU


213 
	$sigi£m±y£t
 (cÚ¡ 
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

216 
	$sigªd£t
 (
sig£t_t
 *
__£t
, cÚ¡ sig£t_ˆ*
__Ëá
,

217 cÚ¡ 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

220 
	$sigÜ£t
 (
sig£t_t
 *
__£t
, cÚ¡ sig£t_ˆ*
__Ëá
,

221 cÚ¡ 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

226 
	~<b™s/sigaùiÚ.h
>

229 
	$sig´ocmask
 (
__how
, cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

230 
sig£t_t
 *
__»¡riù
 
__o£t
è
__THROW
;

237 
	$sigsu¥’d
 (cÚ¡ 
sig£t_t
 *
__£t
è
	`__nÚnuÎ
 ((1));

240 
	$sigaùiÚ
 (
__sig
, cÚ¡ 
sigaùiÚ
 *
__»¡riù
 
__aù
,

241 
sigaùiÚ
 *
__»¡riù
 
__ßù
è
__THROW
;

244 
	$sig³ndšg
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

247 #ifdeà
__USE_POSIX199506


252 
	$sigwa™
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
, *__»¡riù 
__sig
)

253 
	`__nÚnuÎ
 ((1, 2));

256 #ifdeà
__USE_POSIX199309


261 
	$sigwa™šfo
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

262 
sigšfo_t
 *
__»¡riù
 
__šfo
è
	`__nÚnuÎ
 ((1));

269 
	$sigtimedwa™
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

270 
sigšfo_t
 *
__»¡riù
 
__šfo
,

271 cÚ¡ 
time¥ec
 *
__»¡riù
 
__timeout
)

272 
	`__nÚnuÎ
 ((1));

276 
	$sigqueue
 (
__pid_t
 
__pid
, 
__sig
, cÚ¡ 
sigv®
 
__v®
)

277 
__THROW
;

282 #ifdeà
__USE_MISC


286 cÚ¡ *cÚ¡ 
_sys_sigli¡
[
_NSIG
];

287 cÚ¡ *cÚ¡ 
sys_sigli¡
[
_NSIG
];

291 
	~<b™s/sigcÚ‹xt.h
>

294 
	$sig»tuº
 (
sigcÚ‹xt
 *
__sı
è
__THROW
;

299 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


300 
	#__Ãed_size_t


	)

301 
	~<¡ddef.h
>

303 
	~<b™s/ty³s/¡ack_t.h
>

304 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


306 
	~<sys/ucÚ‹xt.h
>

310 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_MISC


314 
	$sigš‹¼u±
 (
__sig
, 
__š‹¼u±
è
__THROW
;

316 
	~<b™s/sig¡ack.h
>

317 
	~<b™s/ss_æags.h
>

321 
	$sig®t¡ack
 (cÚ¡ 
¡ack_t
 *
__»¡riù
 
__ss
,

322 
¡ack_t
 *
__»¡riù
 
__oss
è
__THROW
;

325 #ià((
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

326 || 
defšed
 
__USE_MISC
)

327 
	~<b™s/ty³s/¡ruù_sig¡ack.h
>

330 #ià((
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

331 || 
defšed
 
__USE_MISC
)

335 
	$sig¡ack
 (
sig¡ack
 *
__ss
, sig¡ack *
__oss
)

336 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

339 #ifdeà
__USE_XOPEN_EXTENDED


343 
	$sighŞd
 (
__sig
è
__THROW
;

346 
	$sig»l£
 (
__sig
è
__THROW
;

349 
	$sigignÜe
 (
__sig
è
__THROW
;

352 
__sighªdËr_t
 
	$sig£t
 (
__sig
, 
__sighªdËr_t
 
__di¥
è
__THROW
;

355 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


358 
	~<b™s/±h»adty³s.h
>

359 
	~<b™s/sigth»ad.h
>

366 
	$__libc_cu¼’t_sig¹mš
 (è
__THROW
;

368 
	$__libc_cu¼’t_sig¹max
 (è
__THROW
;

370 
	#SIGRTMIN
 (
	`__libc_cu¼’t_sig¹mš
 ())

	)

371 
	#SIGRTMAX
 (
	`__libc_cu¼’t_sig¹max
 ())

	)

373 
__END_DECLS


	@/usr/include/stdint.h

22 #iâdeà
_STDINT_H


23 
	#_STDINT_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<b™s/libc-h—d”-¡¬t.h
>

27 
	~<b™s/ty³s.h
>

28 
	~<b™s/wch¬.h
>

29 
	~<b™s/wÜdsize.h
>

34 
	~<b™s/¡dšt-šŠ.h
>

37 
	~<b™s/¡dšt-ušŠ.h
>

43 sigÃd 
	tšt_Ëa¡8_t
;

44 
	tšt_Ëa¡16_t
;

45 
	tšt_Ëa¡32_t
;

46 #ià
__WORDSIZE
 == 64

47 
	tšt_Ëa¡64_t
;

49 
__ex‹nsiÚ__


50 
	tšt_Ëa¡64_t
;

54 
	tušt_Ëa¡8_t
;

55 
	tušt_Ëa¡16_t
;

56 
	tušt_Ëa¡32_t
;

57 #ià
__WORDSIZE
 == 64

58 
	tušt_Ëa¡64_t
;

60 
__ex‹nsiÚ__


61 
	tušt_Ëa¡64_t
;

68 sigÃd 
	tšt_ç¡8_t
;

69 #ià
__WORDSIZE
 == 64

70 
	tšt_ç¡16_t
;

71 
	tšt_ç¡32_t
;

72 
	tšt_ç¡64_t
;

74 
	tšt_ç¡16_t
;

75 
	tšt_ç¡32_t
;

76 
__ex‹nsiÚ__


77 
	tšt_ç¡64_t
;

81 
	tušt_ç¡8_t
;

82 #ià
__WORDSIZE
 == 64

83 
	tušt_ç¡16_t
;

84 
	tušt_ç¡32_t
;

85 
	tušt_ç¡64_t
;

87 
	tušt_ç¡16_t
;

88 
	tušt_ç¡32_t
;

89 
__ex‹nsiÚ__


90 
	tušt_ç¡64_t
;

95 #ià
__WORDSIZE
 == 64

96 #iâdeà
__šŒ_t_defšed


97 
	tšŒ_t
;

98 
	#__šŒ_t_defšed


	)

100 
	tušŒ_t
;

102 #iâdeà
__šŒ_t_defšed


103 
	tšŒ_t
;

104 
	#__šŒ_t_defšed


	)

106 
	tušŒ_t
;

111 
__štmax_t
 
	tštmax_t
;

112 
__uštmax_t
 
	tuštmax_t
;

115 #ià
__WORDSIZE
 == 64

116 
	#__INT64_C
(
c
èø## 
L


	)

117 
	#__UINT64_C
(
c
èø## 
UL


	)

119 
	#__INT64_C
(
c
èø## 
LL


	)

120 
	#__UINT64_C
(
c
èø## 
ULL


	)

126 
	#INT8_MIN
 (-128)

	)

127 
	#INT16_MIN
 (-32767-1)

	)

128 
	#INT32_MIN
 (-2147483647-1)

	)

129 
	#INT64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

131 
	#INT8_MAX
 (127)

	)

132 
	#INT16_MAX
 (32767)

	)

133 
	#INT32_MAX
 (2147483647)

	)

134 
	#INT64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

137 
	#UINT8_MAX
 (255)

	)

138 
	#UINT16_MAX
 (65535)

	)

139 
	#UINT32_MAX
 (4294967295U)

	)

140 
	#UINT64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

144 
	#INT_LEAST8_MIN
 (-128)

	)

145 
	#INT_LEAST16_MIN
 (-32767-1)

	)

146 
	#INT_LEAST32_MIN
 (-2147483647-1)

	)

147 
	#INT_LEAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

149 
	#INT_LEAST8_MAX
 (127)

	)

150 
	#INT_LEAST16_MAX
 (32767)

	)

151 
	#INT_LEAST32_MAX
 (2147483647)

	)

152 
	#INT_LEAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

155 
	#UINT_LEAST8_MAX
 (255)

	)

156 
	#UINT_LEAST16_MAX
 (65535)

	)

157 
	#UINT_LEAST32_MAX
 (4294967295U)

	)

158 
	#UINT_LEAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

162 
	#INT_FAST8_MIN
 (-128)

	)

163 #ià
__WORDSIZE
 == 64

164 
	#INT_FAST16_MIN
 (-9223372036854775807L-1)

	)

165 
	#INT_FAST32_MIN
 (-9223372036854775807L-1)

	)

167 
	#INT_FAST16_MIN
 (-2147483647-1)

	)

168 
	#INT_FAST32_MIN
 (-2147483647-1)

	)

170 
	#INT_FAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

172 
	#INT_FAST8_MAX
 (127)

	)

173 #ià
__WORDSIZE
 == 64

174 
	#INT_FAST16_MAX
 (9223372036854775807L)

	)

175 
	#INT_FAST32_MAX
 (9223372036854775807L)

	)

177 
	#INT_FAST16_MAX
 (2147483647)

	)

178 
	#INT_FAST32_MAX
 (2147483647)

	)

180 
	#INT_FAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

183 
	#UINT_FAST8_MAX
 (255)

	)

184 #ià
__WORDSIZE
 == 64

185 
	#UINT_FAST16_MAX
 (18446744073709551615UL)

	)

186 
	#UINT_FAST32_MAX
 (18446744073709551615UL)

	)

188 
	#UINT_FAST16_MAX
 (4294967295U)

	)

189 
	#UINT_FAST32_MAX
 (4294967295U)

	)

191 
	#UINT_FAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

195 #ià
__WORDSIZE
 == 64

196 
	#INTPTR_MIN
 (-9223372036854775807L-1)

	)

197 
	#INTPTR_MAX
 (9223372036854775807L)

	)

198 
	#UINTPTR_MAX
 (18446744073709551615UL)

	)

200 
	#INTPTR_MIN
 (-2147483647-1)

	)

201 
	#INTPTR_MAX
 (2147483647)

	)

202 
	#UINTPTR_MAX
 (4294967295U)

	)

207 
	#INTMAX_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

209 
	#INTMAX_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

212 
	#UINTMAX_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

218 #ià
__WORDSIZE
 == 64

219 
	#PTRDIFF_MIN
 (-9223372036854775807L-1)

	)

220 
	#PTRDIFF_MAX
 (9223372036854775807L)

	)

222 #ià
__WORDSIZE32_PTRDIFF_LONG


223 
	#PTRDIFF_MIN
 (-2147483647L-1)

	)

224 
	#PTRDIFF_MAX
 (2147483647L)

	)

226 
	#PTRDIFF_MIN
 (-2147483647-1)

	)

227 
	#PTRDIFF_MAX
 (2147483647)

	)

232 
	#SIG_ATOMIC_MIN
 (-2147483647-1)

	)

233 
	#SIG_ATOMIC_MAX
 (2147483647)

	)

236 #ià
__WORDSIZE
 == 64

237 
	#SIZE_MAX
 (18446744073709551615UL)

	)

239 #ià
__WORDSIZE32_SIZE_ULONG


240 
	#SIZE_MAX
 (4294967295UL)

	)

242 
	#SIZE_MAX
 (4294967295U)

	)

247 #iâdeà
WCHAR_MIN


249 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

250 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

254 
	#WINT_MIN
 (0u)

	)

255 
	#WINT_MAX
 (4294967295u)

	)

258 
	#INT8_C
(
c
è
	)
c

259 
	#INT16_C
(
c
è
	)
c

260 
	#INT32_C
(
c
è
	)
c

261 #ià
__WORDSIZE
 == 64

262 
	#INT64_C
(
c
èø## 
L


	)

264 
	#INT64_C
(
c
èø## 
LL


	)

268 
	#UINT8_C
(
c
è
	)
c

269 
	#UINT16_C
(
c
è
	)
c

270 
	#UINT32_C
(
c
èø## 
U


	)

271 #ià
__WORDSIZE
 == 64

272 
	#UINT64_C
(
c
èø## 
UL


	)

274 
	#UINT64_C
(
c
èø## 
ULL


	)

278 #ià
__WORDSIZE
 == 64

279 
	#INTMAX_C
(
c
èø## 
L


	)

280 
	#UINTMAX_C
(
c
èø## 
UL


	)

282 
	#INTMAX_C
(
c
èø## 
LL


	)

283 
	#UINTMAX_C
(
c
èø## 
ULL


	)

286 #ià
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

288 
	#INT8_WIDTH
 8

	)

289 
	#UINT8_WIDTH
 8

	)

290 
	#INT16_WIDTH
 16

	)

291 
	#UINT16_WIDTH
 16

	)

292 
	#INT32_WIDTH
 32

	)

293 
	#UINT32_WIDTH
 32

	)

294 
	#INT64_WIDTH
 64

	)

295 
	#UINT64_WIDTH
 64

	)

297 
	#INT_LEAST8_WIDTH
 8

	)

298 
	#UINT_LEAST8_WIDTH
 8

	)

299 
	#INT_LEAST16_WIDTH
 16

	)

300 
	#UINT_LEAST16_WIDTH
 16

	)

301 
	#INT_LEAST32_WIDTH
 32

	)

302 
	#UINT_LEAST32_WIDTH
 32

	)

303 
	#INT_LEAST64_WIDTH
 64

	)

304 
	#UINT_LEAST64_WIDTH
 64

	)

306 
	#INT_FAST8_WIDTH
 8

	)

307 
	#UINT_FAST8_WIDTH
 8

	)

308 
	#INT_FAST16_WIDTH
 
__WORDSIZE


	)

309 
	#UINT_FAST16_WIDTH
 
__WORDSIZE


	)

310 
	#INT_FAST32_WIDTH
 
__WORDSIZE


	)

311 
	#UINT_FAST32_WIDTH
 
__WORDSIZE


	)

312 
	#INT_FAST64_WIDTH
 64

	)

313 
	#UINT_FAST64_WIDTH
 64

	)

315 
	#INTPTR_WIDTH
 
__WORDSIZE


	)

316 
	#UINTPTR_WIDTH
 
__WORDSIZE


	)

318 
	#INTMAX_WIDTH
 64

	)

319 
	#UINTMAX_WIDTH
 64

	)

321 
	#PTRDIFF_WIDTH
 
__WORDSIZE


	)

322 
	#SIG_ATOMIC_WIDTH
 32

	)

323 
	#SIZE_WIDTH
 
__WORDSIZE


	)

324 
	#WCHAR_WIDTH
 32

	)

325 
	#WINT_WIDTH
 32

	)

	@/usr/include/stdio.h

23 #iâdeà
_STDIO_H


24 
	#_STDIO_H
 1

	)

26 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

27 
	~<b™s/libc-h—d”-¡¬t.h
>

29 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

35 
	~<b™s/ty³s.h
>

36 
	~<b™s/ty³s/__FILE.h
>

37 
	~<b™s/ty³s/FILE.h
>

39 
	#_STDIO_USES_IOSTREAM


	)

41 
	~<b™s/libio.h
>

43 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


44 #ifdeà
__GNUC__


45 #iâdeà
_VA_LIST_DEFINED


46 
_G_va_li¡
 
	tva_li¡
;

47 
	#_VA_LIST_DEFINED


	)

50 
	~<¡d¬g.h
>

54 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


55 #iâdeà
__off_t_defšed


56 #iâdeà
__USE_FILE_OFFSET64


57 
__off_t
 
	toff_t
;

59 
__off64_t
 
	toff_t
;

61 
	#__off_t_defšed


	)

63 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


64 
__off64_t
 
	toff64_t
;

65 
	#__off64_t_defšed


	)

69 #ifdeà
__USE_XOPEN2K8


70 #iâdeà
__ssize_t_defšed


71 
__ssize_t
 
	tssize_t
;

72 
	#__ssize_t_defšed


	)

77 #iâdeà
__USE_FILE_OFFSET64


78 
_G_åos_t
 
	tåos_t
;

80 
_G_åos64_t
 
	tåos_t
;

82 #ifdeà
__USE_LARGEFILE64


83 
_G_åos64_t
 
	tåos64_t
;

87 
	#_IOFBF
 0

	)

88 
	#_IOLBF
 1

	)

89 
	#_IONBF
 2

	)

93 #iâdeà
BUFSIZ


94 
	#BUFSIZ
 
_IO_BUFSIZ


	)

100 #iâdeà
EOF


101 
	#EOF
 (-1)

	)

107 
	#SEEK_SET
 0

	)

108 
	#SEEK_CUR
 1

	)

109 
	#SEEK_END
 2

	)

110 #ifdeà
__USE_GNU


111 
	#SEEK_DATA
 3

	)

112 
	#SEEK_HOLE
 4

	)

116 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


118 
	#P_tmpdœ
 "/tmp"

	)

131 
	~<b™s/¡dio_lim.h
>

135 
_IO_FILE
 *
¡dš
;

136 
_IO_FILE
 *
¡dout
;

137 
_IO_FILE
 *
¡d”r
;

139 
	#¡dš
 
¡dš


	)

140 
	#¡dout
 
¡dout


	)

141 
	#¡d”r
 
¡d”r


	)

144 
	$»move
 (cÚ¡ *
__f’ame
è
__THROW
;

146 
	$»Çme
 (cÚ¡ *
__Şd
, cÚ¡ *
__Ãw
è
__THROW
;

148 #ifdeà
__USE_ATFILE


150 
	$»Çm—t
 (
__Şdfd
, cÚ¡ *
__Şd
, 
__Ãwfd
,

151 cÚ¡ *
__Ãw
è
__THROW
;

158 #iâdeà
__USE_FILE_OFFSET64


159 
FILE
 *
	$tmpfe
 (è
__wur
;

161 #ifdeà
__REDIRECT


162 
FILE
 *
	`__REDIRECT
 (
tmpfe
, (), 
tmpfe64
è
__wur
;

164 
	#tmpfe
 
tmpfe64


	)

168 #ifdeà
__USE_LARGEFILE64


169 
FILE
 *
	$tmpfe64
 (è
__wur
;

173 *
	$tm²am
 (*
__s
è
__THROW
 
__wur
;

175 #ifdeà
__USE_MISC


178 *
	$tm²am_r
 (*
__s
è
__THROW
 
__wur
;

182 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


190 *
	$‹m²am
 (cÚ¡ *
__dœ
, cÚ¡ *
__pfx
)

191 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

199 
	`fşo£
 (
FILE
 *
__¡»am
);

204 
	`fæush
 (
FILE
 *
__¡»am
);

206 #ifdeà
__USE_MISC


213 
	`fæush_uÆocked
 (
FILE
 *
__¡»am
);

216 #ifdeà
__USE_GNU


223 
	`fşo£®l
 ();

227 #iâdeà
__USE_FILE_OFFSET64


232 
FILE
 *
	$fİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

233 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

238 
FILE
 *
	$äeİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

239 cÚ¡ *
__»¡riù
 
__modes
,

240 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

242 #ifdeà
__REDIRECT


243 
FILE
 *
	`__REDIRECT
 (
fİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

244 cÚ¡ *
__»¡riù
 
__modes
), 
fİ’64
)

245 
__wur
;

246 
FILE
 *
	`__REDIRECT
 (
äeİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

247 cÚ¡ *
__»¡riù
 
__modes
,

248 
FILE
 *
__»¡riù
 
__¡»am
), 
äeİ’64
)

249 
__wur
;

251 
	#fİ’
 
fİ’64


	)

252 
	#äeİ’
 
äeİ’64


	)

255 #ifdeà
__USE_LARGEFILE64


256 
FILE
 *
	$fİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

257 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

258 
FILE
 *
	$äeİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

259 cÚ¡ *
__»¡riù
 
__modes
,

260 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

263 #ifdef 
__USE_POSIX


265 
FILE
 *
	$fdİ’
 (
__fd
, cÚ¡ *
__modes
è
__THROW
 
__wur
;

268 #ifdef 
__USE_GNU


271 
FILE
 *
	$fİ’cook›
 (*
__»¡riù
 
__magic_cook›
,

272 cÚ¡ *
__»¡riù
 
__modes
,

273 
_IO_cook›_io_funùiÚs_t
 
__io_funcs
è
__THROW
 
__wur
;

276 #ià
defšed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

278 
FILE
 *
	$fmemİ’
 (*
__s
, 
size_t
 
__Ën
, cÚ¡ *
__modes
)

279 
__THROW
 
__wur
;

284 
FILE
 *
	$İ’_mem¡»am
 (**
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
 
__wur
;

290 
	$£tbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
è
__THROW
;

294 
	$£tvbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

295 
__modes
, 
size_t
 
__n
è
__THROW
;

297 #ifdef 
__USE_MISC


300 
	$£tbufãr
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

301 
size_t
 
__size
è
__THROW
;

304 
	$£šebuf
 (
FILE
 *
__¡»am
è
__THROW
;

312 
	`årštf
 (
FILE
 *
__»¡riù
 
__¡»am
,

313 cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

318 
	`´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

320 
	$¥rštf
 (*
__»¡riù
 
__s
,

321 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROWNL
;

327 
	`vårštf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

328 
_G_va_li¡
 
__¬g
);

333 
	`v´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
);

335 
	$v¥rštf
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

336 
_G_va_li¡
 
__¬g
è
__THROWNL
;

338 #ià
defšed
 
__USE_ISOC99
 || defšed 
__USE_UNIX98


340 
	$¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

341 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

342 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 4)));

344 
	$v¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

345 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

346 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 0)));

349 #ià
	`__GLIBC_USE
 (
LIB_EXT2
)

352 
	$va¥rštf
 (**
__»¡riù
 
__±r
, cÚ¡ *__»¡riù 
__f
,

353 
_G_va_li¡
 
__¬g
)

354 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 0))è
__wur
;

355 
	$__a¥rštf
 (**
__»¡riù
 
__±r
,

356 cÚ¡ *
__»¡riù
 
__fmt
, ...)

357 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

358 
	$a¥rštf
 (**
__»¡riù
 
__±r
,

359 cÚ¡ *
__»¡riù
 
__fmt
, ...)

360 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

363 #ifdeà
__USE_XOPEN2K8


365 
	$vd´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
,

366 
_G_va_li¡
 
__¬g
)

367 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

368 
	$d´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
, ...)

369 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

377 
	$fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

378 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

383 
	$sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

385 
	$ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

386 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

388 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

389 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

390 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

391 #ifdeà
__REDIRECT


395 
	`__REDIRECT
 (
fsÿnf
, (
FILE
 *
__»¡riù
 
__¡»am
,

396 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

397 
__isoc99_fsÿnf
è
__wur
;

398 
	`__REDIRECT
 (
sÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

399 
__isoc99_sÿnf
è
__wur
;

400 
	`__REDIRECT_NTH
 (
ssÿnf
, (cÚ¡ *
__»¡riù
 
__s
,

401 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

402 
__isoc99_ssÿnf
);

404 
	$__isoc99_fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

405 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

406 
	$__isoc99_sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

407 
	$__isoc99_ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

408 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

409 
	#fsÿnf
 
__isoc99_fsÿnf


	)

410 
	#sÿnf
 
__isoc99_sÿnf


	)

411 
	#ssÿnf
 
__isoc99_ssÿnf


	)

415 #ifdef 
__USE_ISOC99


420 
	$vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

421 
_G_va_li¡
 
__¬g
)

422 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

428 
	$vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

429 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

432 
	$vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

433 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

434 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

436 #ià!
defšed
 
__USE_GNU
 \

437 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

438 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

439 #ifdeà
__REDIRECT


443 
	`__REDIRECT
 (
vfsÿnf
,

444 (
FILE
 *
__»¡riù
 
__s
,

445 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
),

446 
__isoc99_vfsÿnf
)

447 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

448 
	`__REDIRECT
 (
vsÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
,

449 
_G_va_li¡
 
__¬g
), 
__isoc99_vsÿnf
)

450 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

451 
	`__REDIRECT_NTH
 (
vssÿnf
,

452 (cÚ¡ *
__»¡riù
 
__s
,

453 cÚ¡ *
__»¡riù
 
__fÜm©
,

454 
_G_va_li¡
 
__¬g
), 
__isoc99_vssÿnf
)

455 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

457 
	$__isoc99_vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
,

458 cÚ¡ *
__»¡riù
 
__fÜm©
,

459 
_G_va_li¡
 
__¬g
è
__wur
;

460 
	$__isoc99_vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
,

461 
_G_va_li¡
 
__¬g
è
__wur
;

462 
	$__isoc99_vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

463 cÚ¡ *
__»¡riù
 
__fÜm©
,

464 
_G_va_li¡
 
__¬g
è
__THROW
;

465 
	#vfsÿnf
 
__isoc99_vfsÿnf


	)

466 
	#vsÿnf
 
__isoc99_vsÿnf


	)

467 
	#vssÿnf
 
__isoc99_vssÿnf


	)

477 
	`fg‘c
 (
FILE
 *
__¡»am
);

478 
	`g‘c
 (
FILE
 *
__¡»am
);

484 
	`g‘ch¬
 ();

488 
	#g‘c
(
_å
è
	`_IO_g‘c
 (_å)

	)

490 #ifdeà
__USE_POSIX199506


495 
	`g‘c_uÆocked
 (
FILE
 *
__¡»am
);

496 
	`g‘ch¬_uÆocked
 ();

499 #ifdeà
__USE_MISC


506 
	`fg‘c_uÆocked
 (
FILE
 *
__¡»am
);

517 
	`åutc
 (
__c
, 
FILE
 *
__¡»am
);

518 
	`putc
 (
__c
, 
FILE
 *
__¡»am
);

524 
	`putch¬
 (
__c
);

528 
	#putc
(
_ch
, 
_å
è
	`_IO_putc
 (_ch, _å)

	)

530 #ifdeà
__USE_MISC


537 
	`åutc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

540 #ifdeà
__USE_POSIX199506


545 
	`putc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

546 
	`putch¬_uÆocked
 (
__c
);

550 #ià
defšed
 
__USE_MISC
 \

551 || (
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

553 
	`g‘w
 (
FILE
 *
__¡»am
);

556 
	`putw
 (
__w
, 
FILE
 *
__¡»am
);

564 *
	$fg‘s
 (*
__»¡riù
 
__s
, 
__n
, 
FILE
 *__»¡riù 
__¡»am
)

565 
__wur
;

567 #ià
	`__GLIBC_USE
 (
DEPRECATED_GETS
)

577 *
	$g‘s
 (*
__s
è
__wur
 
__©Œibu‹_d•»ÿ‹d__
;

580 #ifdeà
__USE_GNU


587 *
	$fg‘s_uÆocked
 (*
__»¡riù
 
__s
, 
__n
,

588 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

592 #ià
defšed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

603 
_IO_ssize_t
 
	$__g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

604 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

605 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

606 
_IO_ssize_t
 
	$g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

607 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

608 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

616 
_IO_ssize_t
 
	$g‘lše
 (**
__»¡riù
 
__lš•Œ
,

617 
size_t
 *
__»¡riù
 
__n
,

618 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

626 
	`åuts
 (cÚ¡ *
__»¡riù
 
__s
, 
FILE
 *__»¡riù 
__¡»am
);

632 
	`puts
 (cÚ¡ *
__s
);

639 
	`ung‘c
 (
__c
, 
FILE
 *
__¡»am
);

646 
size_t
 
	$ä—d
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

647 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

652 
size_t
 
	`fwr™e
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

653 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__s
);

655 #ifdeà
__USE_GNU


662 
	`åuts_uÆocked
 (cÚ¡ *
__»¡riù
 
__s
,

663 
FILE
 *
__»¡riù
 
__¡»am
);

666 #ifdeà
__USE_MISC


673 
size_t
 
	$ä—d_uÆocked
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

674 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

675 
size_t
 
	`fwr™e_uÆocked
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

676 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
);

684 
	`f£ek
 (
FILE
 *
__¡»am
, 
__off
, 
__wh’û
);

689 
	$á–l
 (
FILE
 *
__¡»am
è
__wur
;

694 
	`»wšd
 (
FILE
 *
__¡»am
);

701 #ià
defšed
 
__USE_LARGEFILE
 || defšed 
__USE_XOPEN2K


702 #iâdeà
__USE_FILE_OFFSET64


707 
	`f£eko
 (
FILE
 *
__¡»am
, 
__off_t
 
__off
, 
__wh’û
);

712 
__off_t
 
	$á–lo
 (
FILE
 *
__¡»am
è
__wur
;

714 #ifdeà
__REDIRECT


715 
	`__REDIRECT
 (
f£eko
,

716 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
),

717 
f£eko64
);

718 
__off64_t
 
	`__REDIRECT
 (
á–lo
, (
FILE
 *
__¡»am
), 
á–lo64
);

720 
	#f£eko
 
f£eko64


	)

721 
	#á–lo
 
á–lo64


	)

726 #iâdeà
__USE_FILE_OFFSET64


731 
	`fg‘pos
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos_t
 *__»¡riù 
__pos
);

736 
	`f£os
 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
);

738 #ifdeà
__REDIRECT


739 
	`__REDIRECT
 (
fg‘pos
, (
FILE
 *
__»¡riù
 
__¡»am
,

740 
åos_t
 *
__»¡riù
 
__pos
), 
fg‘pos64
);

741 
	`__REDIRECT
 (
f£os
,

742 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
), 
f£os64
);

744 
	#fg‘pos
 
fg‘pos64


	)

745 
	#f£os
 
f£os64


	)

749 #ifdeà
__USE_LARGEFILE64


750 
	`f£eko64
 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
);

751 
__off64_t
 
	$á–lo64
 (
FILE
 *
__¡»am
è
__wur
;

752 
	`fg‘pos64
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos64_t
 *__»¡riù 
__pos
);

753 
	`f£os64
 (
FILE
 *
__¡»am
, cÚ¡ 
åos64_t
 *
__pos
);

757 
	$ş—»¼
 (
FILE
 *
__¡»am
è
__THROW
;

759 
	$ãof
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

761 
	$ã¼Ü
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

763 #ifdeà
__USE_MISC


765 
	$ş—»¼_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
;

766 
	$ãof_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

767 
	$ã¼Ü_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

775 
	`³¼Ü
 (cÚ¡ *
__s
);

781 
	~<b™s/sys_”¾i¡.h
>

784 #ifdef 
__USE_POSIX


786 
	$f’o
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

789 #ifdeà
__USE_MISC


791 
	$f’o_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

795 #ifdeà
__USE_POSIX2


800 
FILE
 *
	$pİ’
 (cÚ¡ *
__commªd
, cÚ¡ *
__modes
è
__wur
;

806 
	`pşo£
 (
FILE
 *
__¡»am
);

810 #ifdef 
__USE_POSIX


812 *
	$ù”mid
 (*
__s
è
__THROW
;

816 #ià(
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
è|| defšed 
__USE_GNU


818 *
	`cu£rid
 (*
__s
);

822 #ifdef 
__USE_GNU


823 
ob¡ack
;

826 
	$ob¡ack_´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

827 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

828 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

829 
	$ob¡ack_v´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

830 cÚ¡ *
__»¡riù
 
__fÜm©
,

831 
_G_va_li¡
 
__¬gs
)

832 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

836 #ifdeà
__USE_POSIX199506


840 
	$æockfe
 (
FILE
 *
__¡»am
è
__THROW
;

844 
	$árylockfe
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

847 
	$fuÆockfe
 (
FILE
 *
__¡»am
è
__THROW
;

850 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


853 
	~<b™s/g‘İt_posix.h
>

858 #ifdeà
__USE_EXTERN_INLINES


859 
	~<b™s/¡dio.h
>

861 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


862 
	~<b™s/¡dio2.h
>

864 #ifdeà
__LDBL_COMPAT


865 
	~<b™s/¡dio-ldbl.h
>

868 
__END_DECLS


	@/usr/include/stdlib.h

22 #iâdef 
_STDLIB_H


24 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

25 
	~<b™s/libc-h—d”-¡¬t.h
>

28 
	#__Ãed_size_t


	)

29 
	#__Ãed_wch¬_t


	)

30 
	#__Ãed_NULL


	)

31 
	~<¡ddef.h
>

33 
	g__BEGIN_DECLS


35 
	#_STDLIB_H
 1

	)

37 #ià(
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8
è&& !defšed 
_SYS_WAIT_H


39 
	~<b™s/wa™æags.h
>

40 
	~<b™s/wa™¡©us.h
>

43 
	#WEXITSTATUS
(
¡©us
è
	`__WEXITSTATUS
 (¡©us)

	)

44 
	#WTERMSIG
(
¡©us
è
	`__WTERMSIG
 (¡©us)

	)

45 
	#WSTOPSIG
(
¡©us
è
	`__WSTOPSIG
 (¡©us)

	)

46 
	#WIFEXITED
(
¡©us
è
	`__WIFEXITED
 (¡©us)

	)

47 
	#WIFSIGNALED
(
¡©us
è
	`__WIFSIGNALED
 (¡©us)

	)

48 
	#WIFSTOPPED
(
¡©us
è
	`__WIFSTOPPED
 (¡©us)

	)

49 #ifdeà
__WIFCONTINUED


50 
	#WIFCONTINUED
(
¡©us
è
	`__WIFCONTINUED
 (¡©us)

	)

55 
	~<b™s/æßŠ.h
>

60 
	mquÙ
;

61 
	m»m
;

62 } 
	tdiv_t
;

65 #iâdeà
__ldiv_t_defšed


68 
	mquÙ
;

69 
	m»m
;

70 } 
	tldiv_t
;

71 
	#__ldiv_t_defšed
 1

	)

74 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__Îdiv_t_defšed


76 
__ex‹nsiÚ__
 struct

78 
	mquÙ
;

79 
	m»m
;

80 } 
	tÎdiv_t
;

81 
	#__Îdiv_t_defšed
 1

	)

86 
	#RAND_MAX
 2147483647

	)

91 
	#EXIT_FAILURE
 1

	)

92 
	#EXIT_SUCCESS
 0

	)

96 
	#MB_CUR_MAX
 (
	`__ùy³_g‘_mb_cur_max
 ())

	)

97 
size_t
 
	$__ùy³_g‘_mb_cur_max
 (è
__THROW
 
__wur
;

101 
	$©of
 (cÚ¡ *
__ÅŒ
)

102 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

104 
	$©oi
 (cÚ¡ *
__ÅŒ
)

105 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

107 
	$©Ş
 (cÚ¡ *
__ÅŒ
)

108 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

110 #ifdeà
__USE_ISOC99


112 
__ex‹nsiÚ__
 
	$©Şl
 (cÚ¡ *
__ÅŒ
)

113 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

117 
	$¡¹od
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

118 **
__»¡riù
 
__’d±r
)

119 
__THROW
 
	`__nÚnuÎ
 ((1));

121 #ifdef 
__USE_ISOC99


123 
	$¡¹of
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

124 **
__»¡riù
 
__’d±r
è
__THROW
 
	`__nÚnuÎ
 ((1));

126 
	$¡¹Şd
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

127 **
__»¡riù
 
__’d±r
)

128 
__THROW
 
	`__nÚnuÎ
 ((1));

133 #ià
__HAVE_FLOAT16
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

134 
_Flßt16
 
	$¡¹of16
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

135 **
__»¡riù
 
__’d±r
)

136 
__THROW
 
	`__nÚnuÎ
 ((1));

139 #ià
__HAVE_FLOAT32
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

140 
_Flßt32
 
	$¡¹of32
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

141 **
__»¡riù
 
__’d±r
)

142 
__THROW
 
	`__nÚnuÎ
 ((1));

145 #ià
__HAVE_FLOAT64
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

146 
_Flßt64
 
	$¡¹of64
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

147 **
__»¡riù
 
__’d±r
)

148 
__THROW
 
	`__nÚnuÎ
 ((1));

151 #ià
__HAVE_FLOAT128
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

152 
_Flßt128
 
	$¡¹of128
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

153 **
__»¡riù
 
__’d±r
)

154 
__THROW
 
	`__nÚnuÎ
 ((1));

157 #ià
__HAVE_FLOAT32X
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

158 
_Flßt32x
 
	$¡¹of32x
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

159 **
__»¡riù
 
__’d±r
)

160 
__THROW
 
	`__nÚnuÎ
 ((1));

163 #ià
__HAVE_FLOAT64X
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

164 
_Flßt64x
 
	$¡¹of64x
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

165 **
__»¡riù
 
__’d±r
)

166 
__THROW
 
	`__nÚnuÎ
 ((1));

169 #ià
__HAVE_FLOAT128X
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

170 
_Flßt128x
 
	$¡¹of128x
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

171 **
__»¡riù
 
__’d±r
)

172 
__THROW
 
	`__nÚnuÎ
 ((1));

176 
	$¡¹Ş
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

177 **
__»¡riù
 
__’d±r
, 
__ba£
)

178 
__THROW
 
	`__nÚnuÎ
 ((1));

180 
	$¡¹oul
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

181 **
__»¡riù
 
__’d±r
, 
__ba£
)

182 
__THROW
 
	`__nÚnuÎ
 ((1));

184 #ifdeà
__USE_MISC


186 
__ex‹nsiÚ__


187 
	$¡¹oq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

188 **
__»¡riù
 
__’d±r
, 
__ba£
)

189 
__THROW
 
	`__nÚnuÎ
 ((1));

191 
__ex‹nsiÚ__


192 
	$¡¹ouq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

193 **
__»¡riù
 
__’d±r
, 
__ba£
)

194 
__THROW
 
	`__nÚnuÎ
 ((1));

197 #ifdeà
__USE_ISOC99


199 
__ex‹nsiÚ__


200 
	$¡¹Şl
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

201 **
__»¡riù
 
__’d±r
, 
__ba£
)

202 
__THROW
 
	`__nÚnuÎ
 ((1));

204 
__ex‹nsiÚ__


205 
	$¡¹ouÎ
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

206 **
__»¡riù
 
__’d±r
, 
__ba£
)

207 
__THROW
 
	`__nÚnuÎ
 ((1));

211 #ià
	`__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

212 
	$¡räomd
 (*
__de¡
, 
size_t
 
__size
, cÚ¡ *
__fÜm©
,

213 
__f
)

214 
__THROW
 
	`__nÚnuÎ
 ((3));

216 
	$¡räomf
 (*
__de¡
, 
size_t
 
__size
, cÚ¡ *
__fÜm©
,

217 
__f
)

218 
__THROW
 
	`__nÚnuÎ
 ((3));

220 
	$¡räoml
 (*
__de¡
, 
size_t
 
__size
, cÚ¡ *
__fÜm©
,

221 
__f
)

222 
__THROW
 
	`__nÚnuÎ
 ((3));

225 #ià
__HAVE_FLOAT16
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

226 
	$¡räomf16
 (*
__de¡
, 
size_t
 
__size
, cÚ¡ * 
__fÜm©
,

227 
_Flßt16
 
__f
)

228 
__THROW
 
	`__nÚnuÎ
 ((3));

231 #ià
__HAVE_FLOAT32
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

232 
	$¡räomf32
 (*
__de¡
, 
size_t
 
__size
, cÚ¡ * 
__fÜm©
,

233 
_Flßt32
 
__f
)

234 
__THROW
 
	`__nÚnuÎ
 ((3));

237 #ià
__HAVE_FLOAT64
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

238 
	$¡räomf64
 (*
__de¡
, 
size_t
 
__size
, cÚ¡ * 
__fÜm©
,

239 
_Flßt64
 
__f
)

240 
__THROW
 
	`__nÚnuÎ
 ((3));

243 #ià
__HAVE_FLOAT128
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

244 
	$¡räomf128
 (*
__de¡
, 
size_t
 
__size
, cÚ¡ * 
__fÜm©
,

245 
_Flßt128
 
__f
)

246 
__THROW
 
	`__nÚnuÎ
 ((3));

249 #ià
__HAVE_FLOAT32X
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

250 
	$¡räomf32x
 (*
__de¡
, 
size_t
 
__size
, cÚ¡ * 
__fÜm©
,

251 
_Flßt32x
 
__f
)

252 
__THROW
 
	`__nÚnuÎ
 ((3));

255 #ià
__HAVE_FLOAT64X
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

256 
	$¡räomf64x
 (*
__de¡
, 
size_t
 
__size
, cÚ¡ * 
__fÜm©
,

257 
_Flßt64x
 
__f
)

258 
__THROW
 
	`__nÚnuÎ
 ((3));

261 #ià
__HAVE_FLOAT128X
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

262 
	$¡räomf128x
 (*
__de¡
, 
size_t
 
__size
, cÚ¡ * 
__fÜm©
,

263 
_Flßt128x
 
__f
)

264 
__THROW
 
	`__nÚnuÎ
 ((3));

268 #ifdeà
__USE_GNU


272 
	~<b™s/ty³s/loÿË_t.h
>

274 
	$¡¹Ş_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

275 **
__»¡riù
 
__’d±r
, 
__ba£
,

276 
loÿË_t
 
__loc
è
__THROW
 
	`__nÚnuÎ
 ((1, 4));

278 
	$¡¹oul_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

279 **
__»¡riù
 
__’d±r
,

280 
__ba£
, 
loÿË_t
 
__loc
)

281 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

283 
__ex‹nsiÚ__


284 
	$¡¹Şl_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

285 **
__»¡riù
 
__’d±r
, 
__ba£
,

286 
loÿË_t
 
__loc
)

287 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

289 
__ex‹nsiÚ__


290 
	$¡¹ouÎ_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

291 **
__»¡riù
 
__’d±r
,

292 
__ba£
, 
loÿË_t
 
__loc
)

293 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

295 
	$¡¹od_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

296 **
__»¡riù
 
__’d±r
, 
loÿË_t
 
__loc
)

297 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

299 
	$¡¹of_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

300 **
__»¡riù
 
__’d±r
, 
loÿË_t
 
__loc
)

301 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

303 
	$¡¹Şd_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

304 **
__»¡riù
 
__’d±r
,

305 
loÿË_t
 
__loc
)

306 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

308 #ià
__HAVE_FLOAT16


309 
_Flßt16
 
	$¡¹of16_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

310 **
__»¡riù
 
__’d±r
,

311 
loÿË_t
 
__loc
)

312 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

315 #ià
__HAVE_FLOAT32


316 
_Flßt32
 
	$¡¹of32_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

317 **
__»¡riù
 
__’d±r
,

318 
loÿË_t
 
__loc
)

319 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

322 #ià
__HAVE_FLOAT64


323 
_Flßt64
 
	$¡¹of64_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

324 **
__»¡riù
 
__’d±r
,

325 
loÿË_t
 
__loc
)

326 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

329 #ià
__HAVE_FLOAT128


330 
_Flßt128
 
	$¡¹of128_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

331 **
__»¡riù
 
__’d±r
,

332 
loÿË_t
 
__loc
)

333 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

336 #ià
__HAVE_FLOAT32X


337 
_Flßt32x
 
	$¡¹of32x_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

338 **
__»¡riù
 
__’d±r
,

339 
loÿË_t
 
__loc
)

340 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

343 #ià
__HAVE_FLOAT64X


344 
_Flßt64x
 
	$¡¹of64x_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

345 **
__»¡riù
 
__’d±r
,

346 
loÿË_t
 
__loc
)

347 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

350 #ià
__HAVE_FLOAT128X


351 
_Flßt128x
 
	$¡¹of128x_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

352 **
__»¡riù
 
__’d±r
,

353 
loÿË_t
 
__loc
)

354 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

359 #ifdeà
__USE_EXTERN_INLINES


360 
__ex‹º_šlše
 

361 
	`__NTH
 (
	$©oi
 (cÚ¡ *
__ÅŒ
))

363  (è
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

364 
	}
}

365 
__ex‹º_šlše
 

366 
__NTH
 (
	$©Ş
 (cÚ¡ *
__ÅŒ
))

368  
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

369 
	}
}

371 #ifdeà
__USE_ISOC99


372 
__ex‹nsiÚ__
 
__ex‹º_šlše
 

373 
__NTH
 (
	$©Şl
 (cÚ¡ *
__ÅŒ
))

375  
	`¡¹Şl
 (
__ÅŒ
, (**è
NULL
, 10);

376 
	}
}

381 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


385 *
	$l64a
 (
__n
è
__THROW
 
__wur
;

388 
	$a64l
 (cÚ¡ *
__s
)

389 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

393 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


394 
	~<sys/ty³s.h
>

401 
	$¿ndom
 (è
__THROW
;

404 
	$¤ªdom
 (
__£ed
è
__THROW
;

410 *
	$š™¡©e
 (
__£ed
, *
__¡©ebuf
,

411 
size_t
 
__¡©–’
è
__THROW
 
	`__nÚnuÎ
 ((2));

415 *
	$£t¡©e
 (*
__¡©ebuf
è
__THROW
 
	`__nÚnuÎ
 ((1));

418 #ifdeà
__USE_MISC


423 
	s¿ndom_d©a


425 
št32_t
 *
åŒ
;

426 
št32_t
 *
½Œ
;

427 
št32_t
 *
¡©e
;

428 
¿nd_ty³
;

429 
¿nd_deg
;

430 
¿nd_£p
;

431 
št32_t
 *
’d_±r
;

434 
	$¿ndom_r
 (
¿ndom_d©a
 *
__»¡riù
 
__buf
,

435 
št32_t
 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

437 
	$¤ªdom_r
 (
__£ed
, 
¿ndom_d©a
 *
__buf
)

438 
__THROW
 
	`__nÚnuÎ
 ((2));

440 
	$š™¡©e_r
 (
__£ed
, *
__»¡riù
 
__¡©ebuf
,

441 
size_t
 
__¡©–’
,

442 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

443 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

445 
	$£t¡©e_r
 (*
__»¡riù
 
__¡©ebuf
,

446 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

447 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

453 
	$¿nd
 (è
__THROW
;

455 
	$¤ªd
 (
__£ed
è
__THROW
;

457 #ifdeà
__USE_POSIX199506


459 
	$¿nd_r
 (*
__£ed
è
__THROW
;

463 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


467 
	$d¿nd48
 (è
__THROW
;

468 
	$”ªd48
 (
__xsubi
[3]è
__THROW
 
	`__nÚnuÎ
 ((1));

471 
	$Ìªd48
 (è
__THROW
;

472 
	$Äªd48
 (
__xsubi
[3])

473 
__THROW
 
	`__nÚnuÎ
 ((1));

476 
	$m¿nd48
 (è
__THROW
;

477 
	$j¿nd48
 (
__xsubi
[3])

478 
__THROW
 
	`__nÚnuÎ
 ((1));

481 
	$¤ªd48
 (
__£edv®
è
__THROW
;

482 *
	$£ed48
 (
__£ed16v
[3])

483 
__THROW
 
	`__nÚnuÎ
 ((1));

484 
	$lcÚg48
 (
__·¿m
[7]è
__THROW
 
	`__nÚnuÎ
 ((1));

486 #ifdeà
__USE_MISC


490 
	sd¿nd48_d©a


492 
__x
[3];

493 
__Şd_x
[3];

494 
__c
;

495 
__š™
;

496 
__ex‹nsiÚ__
 
__a
;

501 
	$d¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

502 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

503 
	$”ªd48_r
 (
__xsubi
[3],

504 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

505 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

508 
	$Ìªd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

509 *
__»¡riù
 
__»suÉ
)

510 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

511 
	$Äªd48_r
 (
__xsubi
[3],

512 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

513 *
__»¡riù
 
__»suÉ
)

514 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

517 
	$m¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

518 *
__»¡riù
 
__»suÉ
)

519 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

520 
	$j¿nd48_r
 (
__xsubi
[3],

521 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

522 *
__»¡riù
 
__»suÉ
)

523 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

526 
	$¤ªd48_r
 (
__£edv®
, 
d¿nd48_d©a
 *
__bufãr
)

527 
__THROW
 
	`__nÚnuÎ
 ((2));

529 
	$£ed48_r
 (
__£ed16v
[3],

530 
d¿nd48_d©a
 *
__bufãr
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

532 
	$lcÚg48_r
 (
__·¿m
[7],

533 
d¿nd48_d©a
 *
__bufãr
)

534 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

539 *
	$m®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

541 *
	$ÿÎoc
 (
size_t
 
__nmemb
, size_ˆ
__size
)

542 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

549 *
	$»®loc
 (*
__±r
, 
size_t
 
__size
)

550 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

552 #ifdeà
__USE_GNU


558 *
	$»®loÿ¼ay
 (*
__±r
, 
size_t
 
__nmemb
, size_ˆ
__size
)

559 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

563 
	$ä“
 (*
__±r
è
__THROW
;

565 #ifdeà
__USE_MISC


566 
	~<®loÿ.h
>

569 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

570 || 
defšed
 
__USE_MISC


572 *
	$v®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

575 #ifdeà
__USE_XOPEN2K


577 
	$posix_mem®ign
 (**
__mem±r
, 
size_t
 
__®ignm’t
, size_ˆ
__size
)

578 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

581 #ifdeà
__USE_ISOC11


583 *
	$®igÃd_®loc
 (
size_t
 
__®ignm’t
, size_ˆ
__size
)

584 
__THROW
 
__©Œibu‹_m®loc__
 
	`__©Œibu‹_®loc_size__
 ((2)è
__wur
;

588 
	$abÜt
 (è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

592 
	$©ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

594 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


596 #ifdeà
__ılu¥lus


597 "C++" 
	$©_quick_ex™
 ((*
__func
) ())

598 
__THROW
 
	`__asm
 ("©_quick_ex™"è
	`__nÚnuÎ
 ((1));

600 
	$©_quick_ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

604 #ifdef 
__USE_MISC


607 
	$Ú_ex™
 ((*
__func
è(
__¡©us
, *
__¬g
), *__arg)

608 
__THROW
 
	`__nÚnuÎ
 ((1));

614 
	$ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

616 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


620 
	$quick_ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

623 #ifdeà
__USE_ISOC99


626 
	$_Ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

631 *
	$g‘’v
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

633 #ifdeà
__USE_GNU


636 *
	$£cu»_g‘’v
 (cÚ¡ *
__Çme
)

637 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

640 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


644 
	$pu‹nv
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

647 #ifdeà
__USE_XOPEN2K


650 
	$£‹nv
 (cÚ¡ *
__Çme
, cÚ¡ *
__v®ue
, 
__»¶aû
)

651 
__THROW
 
	`__nÚnuÎ
 ((2));

654 
	$un£‹nv
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

657 #ifdef 
__USE_MISC


661 
	$ş—»nv
 (è
__THROW
;

665 #ià
defšed
 
__USE_MISC
 \

666 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
)

672 *
	$mk‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1));

675 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


684 #iâdeà
__USE_FILE_OFFSET64


685 
	$mk¡emp
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

687 #ifdeà
__REDIRECT


688 
	`__REDIRECT
 (
mk¡emp
, (*
__‹m¶©e
), 
mk¡emp64
)

689 
	`__nÚnuÎ
 ((1)è
__wur
;

691 
	#mk¡emp
 
mk¡emp64


	)

694 #ifdeà
__USE_LARGEFILE64


695 
	$mk¡emp64
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

699 #ifdeà
__USE_MISC


706 #iâdeà
__USE_FILE_OFFSET64


707 
	$mk¡emps
 (*
__‹m¶©e
, 
__suffixËn
è
	`__nÚnuÎ
 ((1)è
__wur
;

709 #ifdeà
__REDIRECT


710 
	`__REDIRECT
 (
mk¡emps
, (*
__‹m¶©e
, 
__suffixËn
),

711 
mk¡emps64
è
	`__nÚnuÎ
 ((1)è
__wur
;

713 
	#mk¡emps
 
mk¡emps64


	)

716 #ifdeà
__USE_LARGEFILE64


717 
	$mk¡emps64
 (*
__‹m¶©e
, 
__suffixËn
)

718 
	`__nÚnuÎ
 ((1)è
__wur
;

722 #ifdeà
__USE_XOPEN2K8


728 *
	$mkd‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

731 #ifdeà
__USE_GNU


738 #iâdeà
__USE_FILE_OFFSET64


739 
	$mko¡emp
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

741 #ifdeà
__REDIRECT


742 
	`__REDIRECT
 (
mko¡emp
, (*
__‹m¶©e
, 
__æags
), 
mko¡emp64
)

743 
	`__nÚnuÎ
 ((1)è
__wur
;

745 
	#mko¡emp
 
mko¡emp64


	)

748 #ifdeà
__USE_LARGEFILE64


749 
	$mko¡emp64
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

758 #iâdeà
__USE_FILE_OFFSET64


759 
	$mko¡emps
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

760 
	`__nÚnuÎ
 ((1)è
__wur
;

762 #ifdeà
__REDIRECT


763 
	`__REDIRECT
 (
mko¡emps
, (*
__‹m¶©e
, 
__suffixËn
,

764 
__æags
), 
mko¡emps64
)

765 
	`__nÚnuÎ
 ((1)è
__wur
;

767 
	#mko¡emps
 
mko¡emps64


	)

770 #ifdeà
__USE_LARGEFILE64


771 
	$mko¡emps64
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

772 
	`__nÚnuÎ
 ((1)è
__wur
;

781 
	$sy¡em
 (cÚ¡ *
__commªd
è
__wur
;

784 #ifdef 
__USE_GNU


787 *
	$ÿnÚiÿlize_fe_Çme
 (cÚ¡ *
__Çme
)

788 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

791 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


797 *
	$»®·th
 (cÚ¡ *
__»¡riù
 
__Çme
,

798 *
__»¡riù
 
__»sŞved
è
__THROW
 
__wur
;

803 #iâdeà
__COMPAR_FN_T


804 
	#__COMPAR_FN_T


	)

805 (*
	t__com·r_â_t
) (const *, const *);

807 #ifdef 
__USE_GNU


808 
__com·r_â_t
 
	tcom·risÚ_â_t
;

811 #ifdeà
__USE_GNU


812 (*
	t__com·r_d_â_t
) (const *, const *, *);

817 *
	$b£¬ch
 (cÚ¡ *
__key
, cÚ¡ *
__ba£
,

818 
size_t
 
__nmemb
, size_ˆ
__size
, 
__com·r_â_t
 
__com·r
)

819 
	`__nÚnuÎ
 ((1, 2, 5)è
__wur
;

821 #ifdeà
__USE_EXTERN_INLINES


822 
	~<b™s/¡dlib-b£¬ch.h
>

827 
	$qsÜt
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

828 
__com·r_â_t
 
__com·r
è
	`__nÚnuÎ
 ((1, 4));

829 #ifdeà
__USE_GNU


830 
	$qsÜt_r
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

831 
__com·r_d_â_t
 
__com·r
, *
__¬g
)

832 
	`__nÚnuÎ
 ((1, 4));

837 
	$abs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

838 
	$Ïbs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

840 #ifdeà
__USE_ISOC99


841 
__ex‹nsiÚ__
 
	$Îabs
 (
__x
)

842 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

849 
div_t
 
	$div
 (
__num”
, 
__d’om
)

850 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

851 
ldiv_t
 
	$ldiv
 (
__num”
, 
__d’om
)

852 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

854 #ifdeà
__USE_ISOC99


855 
__ex‹nsiÚ__
 
Îdiv_t
 
	$Îdiv
 (
__num”
,

856 
__d’om
)

857 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

861 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

862 || 
defšed
 
__USE_MISC


869 *
	$ecvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

870 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

875 *
	$fcvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

876 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

881 *
	$gcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

882 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

885 #ifdeà
__USE_MISC


887 *
	$qecvt
 (
__v®ue
, 
__ndig™
,

888 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

889 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

890 *
	$qfcvt
 (
__v®ue
, 
__ndig™
,

891 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

892 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

893 *
	$qgcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

894 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

899 
	$ecvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

900 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

901 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

902 
	$fcvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

903 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

904 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

906 
	$qecvt_r
 (
__v®ue
, 
__ndig™
,

907 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

908 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

909 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

910 
	$qfcvt_r
 (
__v®ue
, 
__ndig™
,

911 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

912 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

913 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

919 
	$mbËn
 (cÚ¡ *
__s
, 
size_t
 
__n
è
__THROW
;

922 
	$mbtowc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

923 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

926 
	$wùomb
 (*
__s
, 
wch¬_t
 
__wch¬
è
__THROW
;

930 
size_t
 
	$mb¡owcs
 (
wch¬_t
 *
__»¡riù
 
__pwcs
,

931 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

933 
size_t
 
	$wc¡ombs
 (*
__»¡riù
 
__s
,

934 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__pwcs
, 
size_t
 
__n
)

935 
__THROW
;

938 #ifdeà
__USE_MISC


943 
	$½m©ch
 (cÚ¡ *
__»¥Ú£
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

947 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


954 
	$g‘subİt
 (**
__»¡riù
 
__İtiÚp
,

955 *cÚ¡ *
__»¡riù
 
__tok’s
,

956 **
__»¡riù
 
__v®u•
)

957 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3)è
__wur
;

961 #ifdeà
__USE_XOPEN


963 
	$£tkey
 (cÚ¡ *
__key
è
__THROW
 
	`__nÚnuÎ
 ((1));

969 #ifdeà
__USE_XOPEN2KXSI


971 
	$posix_İ’±
 (
__oæag
è
__wur
;

974 #ifdeà
__USE_XOPEN_EXTENDED


979 
	$g¿Á±
 (
__fd
è
__THROW
;

983 
	$uÆock±
 (
__fd
è
__THROW
;

988 *
	$±¢ame
 (
__fd
è
__THROW
 
__wur
;

991 #ifdeà
__USE_GNU


995 
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

996 
__THROW
 
	`__nÚnuÎ
 ((2));

999 
	`g‘±
 ();

1002 #ifdeà
__USE_MISC


1006 
	$g‘lßdavg
 (
__lßdavg
[], 
__ÃËm
)

1007 
__THROW
 
	`__nÚnuÎ
 ((1));

1010 #ià
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K


1013 
	$‰y¦Ù
 (è
__THROW
;

1016 
	~<b™s/¡dlib-æßt.h
>

1019 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


1020 
	~<b™s/¡dlib.h
>

1022 #ifdeà
__LDBL_COMPAT


1023 
	~<b™s/¡dlib-ldbl.h
>

1026 
__END_DECLS


	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<b™s/libc-h—d”-¡¬t.h
>

28 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

36 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

37 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

42 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

43 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

46 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

47 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

52 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


53 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

54 
__c
, 
size_t
 
__n
)

55 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

60 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

63 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

64 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

67 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


70 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

71 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

72 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

75 #ifdeà
__OPTIMIZE__


76 
__ex‹º_®ways_šlše
 *

77 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


79  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

82 
__ex‹º_®ways_šlše
 const *

83 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


85  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

88 
	}
}

90 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

91 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

94 #ifdeà
__USE_GNU


97 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


98 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

99 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

100 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

101 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

103 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

104 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

108 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


109 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

110 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

111 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

112 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

114 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

121 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

122 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

124 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

125 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

126 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

129 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

130 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

132 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

133 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

136 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

137 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

139 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

140 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

143 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

144 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

146 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

147 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

148 
__THROW
 
	`__nÚnuÎ
 ((2));

150 #ifdeà
__USE_XOPEN2K8


152 
	~<b™s/ty³s/loÿË_t.h
>

155 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__l
)

156 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

159 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

160 
loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

163 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8
 \

164 || 
	$__GLIBC_USE
 (
LIB_EXT2
))

166 *
	$¡rdup
 (cÚ¡ *
__s
)

167 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

173 #ià
defšed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

174 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

175 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

178 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


180 
	#¡rdu·
(
s
) \

181 (
__ex‹nsiÚ__
 \

183 cÚ¡ *
__Şd
 = (
s
); \

184 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

185 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

186 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

187 
	}
}))

	)

190 
	#¡ºdu·
(
s
, 
n
) \

191 (
__ex‹nsiÚ__
 \

193 cÚ¡ *
__Şd
 = (
s
); \

194 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

195 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

196 
__Ãw
[
__Ën
] = '\0'; \

197 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

198 }))

	)

202 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


205 *
¡rchr
 (*
__s
, 
__c
)

206 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

207 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

208 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

210 #ifdeà
__OPTIMIZE__


211 
__ex‹º_®ways_šlše
 *

212 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


214  
__butš_¡rchr
 (
__s
, 
__c
);

217 
__ex‹º_®ways_šlše
 const *

218 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


220  
__butš_¡rchr
 (
__s
, 
__c
);

225 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

226 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

229 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


232 *
	`¡¼chr
 (*
__s
, 
__c
)

233 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

234 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

235 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

237 #ifdeà
__OPTIMIZE__


238 
__ex‹º_®ways_šlše
 *

239 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


241  
	`__butš_¡¼chr
 (
__s
, 
__c
);

244 
__ex‹º_®ways_šlše
 const *

245 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


247  
	`__butš_¡¼chr
 (
__s
, 
__c
);

250 
	}
}

252 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

253 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

256 #ifdeà
__USE_GNU


259 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


260 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

261 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

262 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

263 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

265 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

266 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

272 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

273 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

276 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

277 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

279 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


282 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

283 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

284 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

285 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

287 #ifdeà
__OPTIMIZE__


288 
__ex‹º_®ways_šlše
 *

289 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


291  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

294 
__ex‹º_®ways_šlše
 const *

295 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


297  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

300 
	}
}

302 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

303 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

306 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


309 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

310 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

311 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

312 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

314 #ifdeà
__OPTIMIZE__


315 
__ex‹º_®ways_šlše
 *

316 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


318  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

321 
__ex‹º_®ways_šlše
 const *

322 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


324  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

327 
	}
}

329 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

330 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

335 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

336 
__THROW
 
	`__nÚnuÎ
 ((2));

340 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

341 cÚ¡ *
__»¡riù
 
__d–im
,

342 **
__»¡riù
 
__§ve_±r
)

343 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

344 #ifdeà
__USE_POSIX


345 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

346 **
__»¡riù
 
__§ve_±r
)

347 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

350 #ifdeà
__USE_GNU


352 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


353 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

354 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

355 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

356 cÚ¡ *
__ÃedË
)

357 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

359 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

360 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

364 #ifdeà
__USE_GNU


368 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

369 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

370 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

374 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

375 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

376 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

377 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

378 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

379 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

384 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

385 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

387 #ifdef 
__USE_XOPEN2K8


390 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

391 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

396 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

397 #ifdeà
__USE_XOPEN2K


405 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


408 #ifdeà
__REDIRECT_NTH


409 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

410 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

411 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

413 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

414 
__THROW
 
	`__nÚnuÎ
 ((2));

415 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

420 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

421 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

425 #ifdeà
__USE_XOPEN2K8


427 *
	$¡»¼Ü_l
 (
__”ºum
, 
loÿË_t
 
__l
è
__THROW
;

430 #ifdeà
__USE_MISC


431 
	~<¡ršgs.h
>

435 
	$ex¶ic™_bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

439 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

440 cÚ¡ *
__»¡riù
 
__d–im
)

441 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

444 #ifdef 
__USE_XOPEN2K8


446 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

449 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

450 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

451 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

452 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

456 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

457 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

458 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

459 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

460 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

461 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

464 #ifdef 
__USE_GNU


466 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

467 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

470 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

473 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

475 #iâdeà
ba£Çme


480 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


481 "C++" *
	$ba£Çme
 (*
__f’ame
)

482 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

483 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

484 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

486 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

491 #ià
	`__GNUC_PREREQ
 (3,4)

492 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


494 
	~<b™s/¡ršg_fÜtif›d.h
>

498 
__END_DECLS


	@/usr/include/strings.h

18 #iâdef 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	#__Ãed_size_t


	)

23 
	~<¡ddef.h
>

26 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


34 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

38 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

39 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

42 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

45 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`šdex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

50 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

53 #ià
defšed
 
__OPTIMIZE__


54 
__ex‹º_®ways_šlše
 *

55 
	`šdex
 (*
__s
, 
__c
è
__THROW


57  
	`__butš_šdex
 (
__s
, 
__c
);

60 
__ex‹º_®ways_šlše
 const *

61 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


63  
	`__butš_šdex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

69 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

73 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`ršdex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

78 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

81 #ià
defšed
 
__OPTIMIZE__


82 
__ex‹º_®ways_šlše
 *

83 
	`ršdex
 (*
__s
, 
__c
è
__THROW


85  
	`__butš_ršdex
 (
__s
, 
__c
);

88 
__ex‹º_®ways_šlše
 const *

89 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


91  
	`__butš_ršdex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

97 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

101 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8
 || defšed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
è
__THROW
 
__©Œibu‹_cÚ¡__
;

109 #ifdef 
__USE_MISC


110 
	$ff¦
 (
__l
è
__THROW
 
__©Œibu‹_cÚ¡__
;

111 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

112 
__THROW
 
__©Œibu‹_cÚ¡__
;

116 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

117 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

120 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<b™s/ty³s/loÿË_t.h
>

128 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__loc
)

129 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

133 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

134 
size_t
 
__n
, 
loÿË_t
 
__loc
)

135 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

138 
__END_DECLS


140 #ià
	`__GNUC_PREREQ
 (3,4è&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
defšed
 
__fÜtify_funùiÚ


143 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


144 
	~<b™s/¡ršgs_fÜtif›d.h
>

	@/usr/include/time.h

22 #iâdef 
_TIME_H


23 
	#_TIME_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	#__Ãed_size_t


	)

28 
	#__Ãed_NULL


	)

29 
	~<¡ddef.h
>

33 
	~<b™s/time.h
>

37 
	~<b™s/ty³s/şock_t.h
>

38 
	~<b™s/ty³s/time_t.h
>

39 
	~<b™s/ty³s/¡ruù_tm.h
>

41 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_ISOC11


42 
	~<b™s/ty³s/¡ruù_time¥ec.h
>

45 #ifdeà
__USE_POSIX199309


46 
	~<b™s/ty³s/şockid_t.h
>

47 
	~<b™s/ty³s/tim”_t.h
>

48 
	~<b™s/ty³s/¡ruù_™im”¥ec.h
>

49 
	gsigev’t
;

52 #ifdeà
__USE_XOPEN2K


53 #iâdeà
__pid_t_defšed


54 
__pid_t
 
	tpid_t
;

55 
	#__pid_t_defšed


	)

59 #ifdeà
__USE_XOPEN2K8


60 
	~<b™s/ty³s/loÿË_t.h
>

63 #ifdeà
__USE_ISOC11


65 
	#TIME_UTC
 1

	)

68 
__BEGIN_DECLS


72 
şock_t
 
	$şock
 (è
__THROW
;

75 
time_t
 
	$time
 (
time_t
 *
__tim”
è
__THROW
;

78 
	$difáime
 (
time_t
 
__time1
,ime_ˆ
__time0
)

79 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

82 
time_t
 
	$mktime
 (
tm
 *
__
è
__THROW
;

88 
size_t
 
	$¡ráime
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

89 cÚ¡ *
__»¡riù
 
__fÜm©
,

90 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

92 #ifdeà
__USE_XOPEN


95 *
	$¡½time
 (cÚ¡ *
__»¡riù
 
__s
,

96 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
)

97 
__THROW
;

100 #ifdeà
__USE_XOPEN2K8


104 
size_t
 
	$¡ráime_l
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

105 cÚ¡ *
__»¡riù
 
__fÜm©
,

106 cÚ¡ 
tm
 *
__»¡riù
 
__
,

107 
loÿË_t
 
__loc
è
__THROW
;

110 #ifdeà
__USE_GNU


111 *
	$¡½time_l
 (cÚ¡ *
__»¡riù
 
__s
,

112 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
,

113 
loÿË_t
 
__loc
è
__THROW
;

119 
tm
 *
	$gmtime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

123 
tm
 *
	$loÿÉime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

125 #ifdeà
__USE_POSIX


128 
tm
 *
	$gmtime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

129 
tm
 *
__»¡riù
 
__
è
__THROW
;

133 
tm
 *
	$loÿÉime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

134 
tm
 *
__»¡riù
 
__
è
__THROW
;

139 *
	$asùime
 (cÚ¡ 
tm
 *
__
è
__THROW
;

142 *
	$ùime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

144 #ifdeà
__USE_POSIX


149 *
	$asùime_r
 (cÚ¡ 
tm
 *
__»¡riù
 
__
,

150 *
__»¡riù
 
__buf
è
__THROW
;

153 *
	$ùime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

154 *
__»¡riù
 
__buf
è
__THROW
;

159 *
__tzÇme
[2];

160 
__daylight
;

161 
__timezÚe
;

164 #ifdef 
__USE_POSIX


166 *
tzÇme
[2];

170 
	$tz£t
 (è
__THROW
;

173 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


174 
daylight
;

175 
timezÚe
;

178 #ifdeà
__USE_MISC


181 
	$¡ime
 (cÚ¡ 
time_t
 *
__wh’
è
__THROW
;

187 
	#__i¦—p
(
y—r
) \

188 ((
y—r
è% 4 =ğ0 && ((y—rè% 100 !ğ0 || (y—rè% 400 =ğ0))

	)

191 #ifdeà
__USE_MISC


196 
time_t
 
	$timegm
 (
tm
 *
__
è
__THROW
;

199 
time_t
 
	$tim–oÿl
 (
tm
 *
__
è
__THROW
;

202 
	$dysize
 (
__y—r
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

206 #ifdeà
__USE_POSIX199309


211 
	`Çno¦“p
 (cÚ¡ 
time¥ec
 *
__»que¡ed_time
,

212 
time¥ec
 *
__»maššg
);

216 
	$şock_g‘»s
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__»s
è
__THROW
;

219 
	$şock_g‘time
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__
è
__THROW
;

222 
	$şock_£‰ime
 (
şockid_t
 
__şock_id
, cÚ¡ 
time¥ec
 *
__
)

223 
__THROW
;

225 #ifdeà
__USE_XOPEN2K


230 
	`şock_Çno¦“p
 (
şockid_t
 
__şock_id
, 
__æags
,

231 cÚ¡ 
time¥ec
 *
__»q
,

232 
time¥ec
 *
__»m
);

235 
	$şock_g‘ıuşockid
 (
pid_t
 
__pid
, 
şockid_t
 *
__şock_id
è
__THROW
;

240 
	$tim”_ü—‹
 (
şockid_t
 
__şock_id
,

241 
sigev’t
 *
__»¡riù
 
__evp
,

242 
tim”_t
 *
__»¡riù
 
__tim”id
è
__THROW
;

245 
	$tim”_d–‘e
 (
tim”_t
 
__tim”id
è
__THROW
;

248 
	$tim”_£‰ime
 (
tim”_t
 
__tim”id
, 
__æags
,

249 cÚ¡ 
™im”¥ec
 *
__»¡riù
 
__v®ue
,

250 
™im”¥ec
 *
__»¡riù
 
__ov®ue
è
__THROW
;

253 
	$tim”_g‘time
 (
tim”_t
 
__tim”id
, 
™im”¥ec
 *
__v®ue
)

254 
__THROW
;

257 
	$tim”_g‘ov”run
 (
tim”_t
 
__tim”id
è
__THROW
;

261 #ifdeà
__USE_ISOC11


263 
	$time¥ec_g‘
 (
time¥ec
 *
__ts
, 
__ba£
)

264 
__THROW
 
	`__nÚnuÎ
 ((1));

268 #ifdeà
__USE_XOPEN_EXTENDED


280 
g‘d©e_”r
;

289 
tm
 *
	`g‘d©e
 (cÚ¡ *
__¡ršg
);

292 #ifdeà
__USE_GNU


303 
	`g‘d©e_r
 (cÚ¡ *
__»¡riù
 
__¡ršg
,

304 
tm
 *
__»¡riù
 
__»sbuå
);

307 
__END_DECLS


	@/usr/include/unistd.h

22 #iâdef 
_UNISTD_H


23 
	#_UNISTD_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


32 #ifdeà
__USE_XOPEN2K8


34 
	#_POSIX_VERSION
 200809L

	)

35 #–ià
defšed
 
__USE_XOPEN2K


37 
	#_POSIX_VERSION
 200112L

	)

38 #–ià
defšed
 
__USE_POSIX199506


40 
	#_POSIX_VERSION
 199506L

	)

41 #–ià
defšed
 
__USE_POSIX199309


43 
	#_POSIX_VERSION
 199309L

	)

46 
	#_POSIX_VERSION
 199009L

	)

52 #ifdeà
__USE_XOPEN2K8


53 
	#__POSIX2_THIS_VERSION
 200809L

	)

55 #–ià
defšed
 
__USE_XOPEN2K


57 
	#__POSIX2_THIS_VERSION
 200112L

	)

58 #–ià
defšed
 
__USE_POSIX199506


60 
	#__POSIX2_THIS_VERSION
 199506L

	)

63 
	#__POSIX2_THIS_VERSION
 199209L

	)

67 
	#_POSIX2_VERSION
 
__POSIX2_THIS_VERSION


	)

70 
	#_POSIX2_C_VERSION
 
__POSIX2_THIS_VERSION


	)

74 
	#_POSIX2_C_BIND
 
__POSIX2_THIS_VERSION


	)

78 
	#_POSIX2_C_DEV
 
__POSIX2_THIS_VERSION


	)

82 
	#_POSIX2_SW_DEV
 
__POSIX2_THIS_VERSION


	)

86 
	#_POSIX2_LOCALEDEF
 
__POSIX2_THIS_VERSION


	)

89 #ifdeà
__USE_XOPEN2K8


90 
	#_XOPEN_VERSION
 700

	)

91 #–ià
defšed
 
__USE_XOPEN2K


92 
	#_XOPEN_VERSION
 600

	)

93 #–ià
defšed
 
__USE_UNIX98


94 
	#_XOPEN_VERSION
 500

	)

96 
	#_XOPEN_VERSION
 4

	)

100 
	#_XOPEN_XCU_VERSION
 4

	)

103 
	#_XOPEN_XPG2
 1

	)

104 
	#_XOPEN_XPG3
 1

	)

105 
	#_XOPEN_XPG4
 1

	)

108 
	#_XOPEN_UNIX
 1

	)

111 
	#_XOPEN_CRYPT
 1

	)

115 
	#_XOPEN_ENH_I18N
 1

	)

118 
	#_XOPEN_LEGACY
 1

	)

205 
	~<b™s/posix_İt.h
>

208 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


209 
	~<b™s/’vœÚm’ts.h
>

213 
	#STDIN_FILENO
 0

	)

214 
	#STDOUT_FILENO
 1

	)

215 
	#STDERR_FILENO
 2

	)

220 
	~<b™s/ty³s.h
>

222 #iâdef 
__ssize_t_defšed


223 
__ssize_t
 
	tssize_t
;

224 
	#__ssize_t_defšed


	)

227 
	#__Ãed_size_t


	)

228 
	#__Ãed_NULL


	)

229 
	~<¡ddef.h
>

231 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


234 #iâdeà
__gid_t_defšed


235 
__gid_t
 
	tgid_t
;

236 
	#__gid_t_defšed


	)

239 #iâdeà
__uid_t_defšed


240 
__uid_t
 
	tuid_t
;

241 
	#__uid_t_defšed


	)

244 #iâdeà
__off_t_defšed


245 #iâdeà
__USE_FILE_OFFSET64


246 
__off_t
 
	toff_t
;

248 
__off64_t
 
	toff_t
;

250 
	#__off_t_defšed


	)

252 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


253 
__off64_t
 
	toff64_t
;

254 
	#__off64_t_defšed


	)

257 #iâdeà
__u£cÚds_t_defšed


258 
__u£cÚds_t
 
	tu£cÚds_t
;

259 
	#__u£cÚds_t_defšed


	)

262 #iâdeà
__pid_t_defšed


263 
__pid_t
 
	tpid_t
;

264 
	#__pid_t_defšed


	)

268 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


269 #iâdeà
__šŒ_t_defšed


270 
__šŒ_t
 
	tšŒ_t
;

271 
	#__šŒ_t_defšed


	)

275 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


276 #iâdeà
__sockËn_t_defšed


277 
__sockËn_t
 
	tsockËn_t
;

278 
	#__sockËn_t_defšed


	)

284 
	#R_OK
 4

	)

285 
	#W_OK
 2

	)

286 
	#X_OK
 1

	)

287 
	#F_OK
 0

	)

290 
	$acûss
 (cÚ¡ *
__Çme
, 
__ty³
è
__THROW
 
	`__nÚnuÎ
 ((1));

292 #ifdeà
__USE_GNU


295 
	$euidacûss
 (cÚ¡ *
__Çme
, 
__ty³
)

296 
__THROW
 
	`__nÚnuÎ
 ((1));

299 
	$—cûss
 (cÚ¡ *
__Çme
, 
__ty³
)

300 
__THROW
 
	`__nÚnuÎ
 ((1));

303 #ifdeà
__USE_ATFILE


307 
	$çcûs§t
 (
__fd
, cÚ¡ *
__fe
, 
__ty³
, 
__æag
)

308 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

313 #iâdef 
_STDIO_H


314 
	#SEEK_SET
 0

	)

315 
	#SEEK_CUR
 1

	)

316 
	#SEEK_END
 2

	)

317 #ifdeà
__USE_GNU


318 
	#SEEK_DATA
 3

	)

319 
	#SEEK_HOLE
 4

	)

323 #ià
defšed
 
__USE_MISC
 && !defšed 
L_SET


325 
	#L_SET
 
SEEK_SET


	)

326 
	#L_INCR
 
SEEK_CUR


	)

327 
	#L_XTND
 
SEEK_END


	)

336 #iâdeà
__USE_FILE_OFFSET64


337 
__off_t
 
	$l£ek
 (
__fd
, 
__off_t
 
__off£t
, 
__wh’û
è
__THROW
;

339 #ifdeà
__REDIRECT_NTH


340 
__off64_t
 
	`__REDIRECT_NTH
 (
l£ek
,

341 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
),

342 
l£ek64
);

344 
	#l£ek
 
l£ek64


	)

347 #ifdeà
__USE_LARGEFILE64


348 
__off64_t
 
	$l£ek64
 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
)

349 
__THROW
;

356 
	`şo£
 (
__fd
);

363 
ssize_t
 
	$»ad
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
è
__wur
;

369 
ssize_t
 
	$wr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
è
__wur
;

371 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


372 #iâdeà
__USE_FILE_OFFSET64


379 
ssize_t
 
	$´—d
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

380 
__off_t
 
__off£t
è
__wur
;

387 
ssize_t
 
	$pwr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

388 
__off_t
 
__off£t
è
__wur
;

390 #ifdeà
__REDIRECT


391 
ssize_t
 
	`__REDIRECT
 (
´—d
, (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

392 
__off64_t
 
__off£t
),

393 
´—d64
è
__wur
;

394 
ssize_t
 
	`__REDIRECT
 (
pwr™e
, (
__fd
, cÚ¡ *
__buf
,

395 
size_t
 
__nby‹s
, 
__off64_t
 
__off£t
),

396 
pwr™e64
è
__wur
;

398 
	#´—d
 
´—d64


	)

399 
	#pwr™e
 
pwr™e64


	)

403 #ifdeà
__USE_LARGEFILE64


407 
ssize_t
 
	$´—d64
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

408 
__off64_t
 
__off£t
è
__wur
;

411 
ssize_t
 
	$pwr™e64
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

412 
__off64_t
 
__off£t
è
__wur
;

420 
	$pe
 (
__pedes
[2]è
__THROW
 
__wur
;

422 #ifdeà
__USE_GNU


425 
	$pe2
 (
__pedes
[2], 
__æags
è
__THROW
 
__wur
;

435 
	$®¬m
 (
__£cÚds
è
__THROW
;

447 
	`¦“p
 (
__£cÚds
);

449 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

450 || 
defšed
 
__USE_MISC


455 
__u£cÚds_t
 
	$u®¬m
 (
__u£cÚds_t
 
__v®ue
, __u£cÚds_ˆ
__š‹rv®
)

456 
__THROW
;

463 
	`u¦“p
 (
__u£cÚds_t
 
__u£cÚds
);

472 
	`·u£
 ();

476 
	$chown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

477 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

479 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


481 
	$fchown
 (
__fd
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
è
__THROW
 
__wur
;

486 
	$lchown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

487 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

491 #ifdeà
__USE_ATFILE


494 
	$fchowÇt
 (
__fd
, cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
,

495 
__gid_t
 
__group
, 
__æag
)

496 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

500 
	$chdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

502 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


504 
	$fchdœ
 (
__fd
è
__THROW
 
__wur
;

514 *
	$g‘cwd
 (*
__buf
, 
size_t
 
__size
è
__THROW
 
__wur
;

516 #ifdef 
__USE_GNU


520 *
	$g‘_cu¼’t_dœ_Çme
 (è
__THROW
;

523 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

524 || 
defšed
 
__USE_MISC


528 *
	$g‘wd
 (*
__buf
)

529 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
 
__wur
;

534 
	$dup
 (
__fd
è
__THROW
 
__wur
;

537 
	$dup2
 (
__fd
, 
__fd2
è
__THROW
;

539 #ifdeà
__USE_GNU


542 
	$dup3
 (
__fd
, 
__fd2
, 
__æags
è
__THROW
;

546 **
__’vœÚ
;

547 #ifdeà
__USE_GNU


548 **
’vœÚ
;

554 
	$execve
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[],

555 *cÚ¡ 
__’vp
[]è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

557 #ifdeà
__USE_XOPEN2K8


560 
	$ãxecve
 (
__fd
, *cÚ¡ 
__¬gv
[], *cÚ¡ 
__’vp
[])

561 
__THROW
 
	`__nÚnuÎ
 ((2));

566 
	$execv
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[])

567 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

571 
	$exeşe
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

572 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

576 
	$exeş
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

577 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

581 
	$execvp
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[])

582 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

587 
	$exeşp
 (cÚ¡ *
__fe
, cÚ¡ *
__¬g
, ...)

588 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

590 #ifdeà
__USE_GNU


593 
	$execv³
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[],

594 *cÚ¡ 
__’vp
[])

595 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

599 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


601 
	$niû
 (
__šc
è
__THROW
 
__wur
;

606 
	$_ex™
 (
__¡©us
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

612 
	~<b™s/cÚâame.h
>

615 
	$·thcÚf
 (cÚ¡ *
__·th
, 
__Çme
)

616 
__THROW
 
	`__nÚnuÎ
 ((1));

619 
	$å©hcÚf
 (
__fd
, 
__Çme
è
__THROW
;

622 
	$syscÚf
 (
__Çme
è
__THROW
;

624 #ifdef 
__USE_POSIX2


626 
size_t
 
	$cÚf¡r
 (
__Çme
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

631 
__pid_t
 
	$g‘pid
 (è
__THROW
;

634 
__pid_t
 
	$g‘µid
 (è
__THROW
;

637 
__pid_t
 
	$g‘pg½
 (è
__THROW
;

640 
__pid_t
 
	$__g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

641 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


642 
__pid_t
 
	$g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

649 
	$£gid
 (
__pid_t
 
__pid
, __pid_ˆ
__pgid
è
__THROW
;

651 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


663 
	$£g½
 (è
__THROW
;

670 
__pid_t
 
	$£tsid
 (è
__THROW
;

672 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


674 
__pid_t
 
	$g‘sid
 (
__pid_t
 
__pid
è
__THROW
;

678 
__uid_t
 
	$g‘uid
 (è
__THROW
;

681 
__uid_t
 
	$g‘euid
 (è
__THROW
;

684 
__gid_t
 
	$g‘gid
 (è
__THROW
;

687 
__gid_t
 
	$g‘egid
 (è
__THROW
;

692 
	$g‘groups
 (
__size
, 
__gid_t
 
__li¡
[]è
__THROW
 
__wur
;

694 #ifdef 
__USE_GNU


696 
	$group_memb”
 (
__gid_t
 
__gid
è
__THROW
;

703 
	$£tuid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

705 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


708 
	$£Œeuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
è
__THROW
 
__wur
;

711 #ifdeà
__USE_XOPEN2K


713 
	$£‹uid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

720 
	$£tgid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

722 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


725 
	$£Œegid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
è
__THROW
 
__wur
;

728 #ifdeà
__USE_XOPEN2K


730 
	$£‹gid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

733 #ifdeà
__USE_GNU


736 
	$g‘»suid
 (
__uid_t
 *
__ruid
, __uid_ˆ*
__euid
, __uid_ˆ*
__suid
)

737 
__THROW
;

741 
	$g‘»sgid
 (
__gid_t
 *
__rgid
, __gid_ˆ*
__egid
, __gid_ˆ*
__sgid
)

742 
__THROW
;

746 
	$£Œesuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
, __uid_ˆ
__suid
)

747 
__THROW
 
__wur
;

751 
	$£Œesgid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
, __gid_ˆ
__sgid
)

752 
__THROW
 
__wur
;

759 
__pid_t
 
	$fÜk
 (è
__THROWNL
;

761 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

762 || 
defšed
 
__USE_MISC


767 
__pid_t
 
	$vfÜk
 (è
__THROW
;

773 *
	$‰yÇme
 (
__fd
è
__THROW
;

777 
	$‰yÇme_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

778 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

782 
	$i§‰y
 (
__fd
è
__THROW
;

784 #ifdeà
__USE_MISC


787 
	$‰y¦Ù
 (è
__THROW
;

792 
	$lšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

793 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

795 #ifdeà
__USE_ATFILE


798 
	$lšk©
 (
__äomfd
, cÚ¡ *
__äom
, 
__tofd
,

799 cÚ¡ *
__to
, 
__æags
)

800 
__THROW
 
	`__nÚnuÎ
 ((2, 4)è
__wur
;

803 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


805 
	$symlšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

806 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

811 
ssize_t
 
	$»adlšk
 (cÚ¡ *
__»¡riù
 
__·th
,

812 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

813 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

816 #ifdeà
__USE_ATFILE


818 
	$symlšk©
 (cÚ¡ *
__äom
, 
__tofd
,

819 cÚ¡ *
__to
è
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

822 
ssize_t
 
	$»adlšk©
 (
__fd
, cÚ¡ *
__»¡riù
 
__·th
,

823 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

824 
__THROW
 
	`__nÚnuÎ
 ((2, 3)è
__wur
;

828 
	$uÆšk
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

830 #ifdeà
__USE_ATFILE


832 
	$uÆšk©
 (
__fd
, cÚ¡ *
__Çme
, 
__æag
)

833 
__THROW
 
	`__nÚnuÎ
 ((2));

837 
	$rmdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1));

841 
__pid_t
 
	$tcg‘pg½
 (
__fd
è
__THROW
;

844 
	$tc£g½
 (
__fd
, 
__pid_t
 
__pg½_id
è
__THROW
;

851 *
	`g‘logš
 ();

852 #ifdeà
__USE_POSIX199506


859 
	$g‘logš_r
 (*
__Çme
, 
size_t
 
__Çme_Ën
è
	`__nÚnuÎ
 ((1));

862 #ifdef 
__USE_MISC


864 
	$£ogš
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

868 #ifdef 
__USE_POSIX2


872 
	~<b™s/g‘İt_posix.h
>

876 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


880 
	$g‘ho¡Çme
 (*
__Çme
, 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((1));

884 #ià
defšed
 
__USE_MISC


887 
	$£tho¡Çme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

888 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

892 
	$£tho¡id
 (
__id
è
__THROW
 
__wur
;

898 
	$g‘domašÇme
 (*
__Çme
, 
size_t
 
__Ën
)

899 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

900 
	$£tdomašÇme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

901 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

907 
	$vhªgup
 (è
__THROW
;

910 
	$»voke
 (cÚ¡ *
__fe
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

918 
	$´of
 (*
__§m¶e_bufãr
, 
size_t
 
__size
,

919 
size_t
 
__off£t
, 
__sÿË
)

920 
__THROW
 
	`__nÚnuÎ
 ((1));

926 
	$acù
 (cÚ¡ *
__Çme
è
__THROW
;

930 *
	$g‘u£rsh–l
 (è
__THROW
;

931 
	$’du£rsh–l
 (è
__THROW
;

932 
	$£tu£rsh–l
 (è
__THROW
;

938 
	$d«mÚ
 (
__nochdœ
, 
__noşo£
è
__THROW
 
__wur
;

942 #ià
defšed
 
__USE_MISC
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

945 
	$chroÙ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

949 *
	$g‘·ss
 (cÚ¡ *
__´om±
è
	`__nÚnuÎ
 ((1));

957 
	`fsync
 (
__fd
);

960 #ifdeà
__USE_GNU


963 
	$syncfs
 (
__fd
è
__THROW
;

967 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


970 
	`g‘ho¡id
 ();

973 
	$sync
 (è
__THROW
;

976 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K


979 
	$g‘·gesize
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

984 
	$g‘dbËsize
 (è
__THROW
;

990 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


993 #iâdeà
__USE_FILE_OFFSET64


994 
	$Œunÿ‹
 (cÚ¡ *
__fe
, 
__off_t
 
__Ëngth
)

995 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

997 #ifdeà
__REDIRECT_NTH


998 
	`__REDIRECT_NTH
 (
Œunÿ‹
,

999 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
),

1000 
Œunÿ‹64
è
	`__nÚnuÎ
 ((1)è
__wur
;

1002 
	#Œunÿ‹
 
Œunÿ‹64


	)

1005 #ifdeà
__USE_LARGEFILE64


1006 
	$Œunÿ‹64
 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
)

1007 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

1012 #ià
defšed
 
__USE_POSIX199309
 \

1013 || 
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


1016 #iâdeà
__USE_FILE_OFFSET64


1017 
	$árunÿ‹
 (
__fd
, 
__off_t
 
__Ëngth
è
__THROW
 
__wur
;

1019 #ifdeà
__REDIRECT_NTH


1020 
	`__REDIRECT_NTH
 (
árunÿ‹
, (
__fd
, 
__off64_t
 
__Ëngth
),

1021 
árunÿ‹64
è
__wur
;

1023 
	#árunÿ‹
 
árunÿ‹64


	)

1026 #ifdeà
__USE_LARGEFILE64


1027 
	$árunÿ‹64
 (
__fd
, 
__off64_t
 
__Ëngth
è
__THROW
 
__wur
;

1033 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

1034 || 
defšed
 
__USE_MISC


1038 
	$brk
 (*
__addr
è
__THROW
 
__wur
;

1044 *
	$sbrk
 (
šŒ_t
 
__d–
è
__THROW
;

1048 #ifdeà
__USE_MISC


1059 
	$sysÿÎ
 (
__sy¢o
, ...è
__THROW
;

1064 #ià(
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
è&& !defšed 
F_LOCK


1076 
	#F_ULOCK
 0

	)

1077 
	#F_LOCK
 1

	)

1078 
	#F_TLOCK
 2

	)

1079 
	#F_TEST
 3

	)

1081 #iâdeà
__USE_FILE_OFFSET64


1082 
	$lockf
 (
__fd
, 
__cmd
, 
__off_t
 
__Ën
è
__wur
;

1084 #ifdeà
__REDIRECT


1085 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
),

1086 
lockf64
è
__wur
;

1088 
	#lockf
 
lockf64


	)

1091 #ifdeà
__USE_LARGEFILE64


1092 
	$lockf64
 (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
è
__wur
;

1097 #ifdeà
__USE_GNU


1102 
	#TEMP_FAILURE_RETRY
(
ex´essiÚ
) \

1103 (
__ex‹nsiÚ__
 \

1104 ({ 
__»suÉ
; \

1105 dØ
__»suÉ
 = (è(
ex´essiÚ
); \

1106 
__»suÉ
 =ğ-1L && 
”ºo
 =ğ
EINTR
); \

1107 
__»suÉ
; 
	}
}))

	)

1110 
ssize_t
 
cİy_fe_¿nge
 (
__šfd
, 
__off64_t
 *
__pšoff
,

1111 
__outfd
, 
__off64_t
 *
__poutoff
,

1112 
size_t
 
__Ëngth
, 
__æags
);

1115 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_UNIX98


1118 
fd©async
 (
__fdes
);

1124 #ifdef 
__USE_XOPEN


1126 *
	$üy±
 (cÚ¡ *
__key
, cÚ¡ *
__§É
)

1127 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1131 
	$’üy±
 (*
__glibc_block
, 
__edæag
)

1132 
__THROW
 
	`__nÚnuÎ
 ((1));

1139 
	$swab
 (cÚ¡ *
__»¡riù
 
__äom
, *__»¡riù 
__to
,

1140 
ssize_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1147 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K


1149 *
	$ù”mid
 (*
__s
è
__THROW
;

1152 *
	`cu£rid
 (*
__s
);

1158 #ià
defšed
 
__USE_UNIX98
 && !defšed 
__USE_XOPEN2K


1159 
	$±h»ad_©fÜk
 ((*
__´•¬e
) (),

1160 (*
__·»Á
) (),

1161 (*
__chd
è()è
__THROW
;

1164 #ifdeà
__USE_MISC


1167 
	$g‘’Œİy
 (*
__bufãr
, 
size_t
 
__Ëngth
è
__wur
;

1171 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


1172 
	~<b™s/uni¡d.h
>

1175 
__END_DECLS


	@/usr/include/alloca.h

18 #iâdef 
_ALLOCA_H


19 
	#_ALLOCA_H
 1

	)

21 
	~<ã©u»s.h
>

23 
	#__Ãed_size_t


	)

24 
	~<¡ddef.h
>

26 
	g__BEGIN_DECLS


29 #undeà
®loÿ


32 *
	$®loÿ
 (
size_t
 
__size
è
__THROW
;

34 #ifdef 
__GNUC__


35 
	#®loÿ
(
size
è
	`__butš_®loÿ
 (size)

	)

38 
__END_DECLS


	@/usr/include/asm-generic/mman-common.h

2 #iâdeà
__ASM_GENERIC_MMAN_COMMON_H


3 
	#__ASM_GENERIC_MMAN_COMMON_H


	)

10 
	#PROT_READ
 0x1

	)

11 
	#PROT_WRITE
 0x2

	)

12 
	#PROT_EXEC
 0x4

	)

13 
	#PROT_SEM
 0x8

	)

14 
	#PROT_NONE
 0x0

	)

15 
	#PROT_GROWSDOWN
 0x01000000

	)

16 
	#PROT_GROWSUP
 0x02000000

	)

18 
	#MAP_SHARED
 0x01

	)

19 
	#MAP_PRIVATE
 0x02

	)

20 
	#MAP_SHARED_VALIDATE
 0x03

	)

21 
	#MAP_TYPE
 0x0à

	)

22 
	#MAP_FIXED
 0x10

	)

23 
	#MAP_ANONYMOUS
 0x20

	)

24 #ifdeà
CONFIG_MMAP_ALLOW_UNINITIALIZED


25 
	#MAP_UNINITIALIZED
 0x4000000

	)

27 
	#MAP_UNINITIALIZED
 0x0

	)

33 
	#MLOCK_ONFAULT
 0x01

	)

35 
	#MS_ASYNC
 1

	)

36 
	#MS_INVALIDATE
 2

	)

37 
	#MS_SYNC
 4

	)

39 
	#MADV_NORMAL
 0

	)

40 
	#MADV_RANDOM
 1

	)

41 
	#MADV_SEQUENTIAL
 2

	)

42 
	#MADV_WILLNEED
 3

	)

43 
	#MADV_DONTNEED
 4

	)

46 
	#MADV_FREE
 8

	)

47 
	#MADV_REMOVE
 9

	)

48 
	#MADV_DONTFORK
 10

	)

49 
	#MADV_DOFORK
 11

	)

50 
	#MADV_HWPOISON
 100

	)

51 
	#MADV_SOFT_OFFLINE
 101

	)

53 
	#MADV_MERGEABLE
 12

	)

54 
	#MADV_UNMERGEABLE
 13

	)

56 
	#MADV_HUGEPAGE
 14

	)

57 
	#MADV_NOHUGEPAGE
 15

	)

59 
	#MADV_DONTDUMP
 16

	)

61 
	#MADV_DODUMP
 17

	)

63 
	#MADV_WIPEONFORK
 18

	)

64 
	#MADV_KEEPONFORK
 19

	)

67 
	#MAP_FILE
 0

	)

69 
	#PKEY_DISABLE_ACCESS
 0x1

	)

70 
	#PKEY_DISABLE_WRITE
 0x2

	)

71 
	#PKEY_ACCESS_MASK
 (
PKEY_DISABLE_ACCESS
 |\

72 
PKEY_DISABLE_WRITE
)

	)

	@/usr/include/endian.h

18 #iâdef 
_ENDIAN_H


19 
	#_ENDIAN_H
 1

	)

21 
	~<ã©u»s.h
>

31 
	#__LITTLE_ENDIAN
 1234

	)

32 
	#__BIG_ENDIAN
 4321

	)

33 
	#__PDP_ENDIAN
 3412

	)

36 
	~<b™s/’dŸn.h
>

40 #iâdeà
__FLOAT_WORD_ORDER


41 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

44 #ifdef 
__USE_MISC


45 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

46 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

47 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

48 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

51 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


52 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èLO, 
	)
HI

53 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


54 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èHI, 
	)
LO

58 #ià
defšed
 
__USE_MISC
 && !defšed 
__ASSEMBLER__


60 
	~<b™s/by‹sw­.h
>

61 
	~<b™s/ušŠ-id’t™y.h
>

63 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


64 
	#htobe16
(
x
è
	`__bsw­_16
 (x)

	)

65 
	#htŞe16
(
x
è
	`__ušt16_id’t™y
 (x)

	)

66 
	#be16toh
(
x
è
	`__bsw­_16
 (x)

	)

67 
	#Ë16toh
(
x
è
	`__ušt16_id’t™y
 (x)

	)

69 
	#htobe32
(
x
è
	`__bsw­_32
 (x)

	)

70 
	#htŞe32
(
x
è
	`__ušt32_id’t™y
 (x)

	)

71 
	#be32toh
(
x
è
	`__bsw­_32
 (x)

	)

72 
	#Ë32toh
(
x
è
	`__ušt32_id’t™y
 (x)

	)

74 
	#htobe64
(
x
è
	`__bsw­_64
 (x)

	)

75 
	#htŞe64
(
x
è
	`__ušt64_id’t™y
 (x)

	)

76 
	#be64toh
(
x
è
	`__bsw­_64
 (x)

	)

77 
	#Ë64toh
(
x
è
	`__ušt64_id’t™y
 (x)

	)

80 
	#htobe16
(
x
è
	`__ušt16_id’t™y
 (x)

	)

81 
	#htŞe16
(
x
è
	`__bsw­_16
 (x)

	)

82 
	#be16toh
(
x
è
	`__ušt16_id’t™y
 (x)

	)

83 
	#Ë16toh
(
x
è
	`__bsw­_16
 (x)

	)

85 
	#htobe32
(
x
è
	`__ušt32_id’t™y
 (x)

	)

86 
	#htŞe32
(
x
è
	`__bsw­_32
 (x)

	)

87 
	#be32toh
(
x
è
	`__ušt32_id’t™y
 (x)

	)

88 
	#Ë32toh
(
x
è
	`__bsw­_32
 (x)

	)

90 
	#htobe64
(
x
è
	`__ušt64_id’t™y
 (x)

	)

91 
	#htŞe64
(
x
è
	`__bsw­_64
 (x)

	)

92 
	#be64toh
(
x
è
	`__ušt64_id’t™y
 (x)

	)

93 
	#Ë64toh
(
x
è
	`__bsw­_64
 (x)

	)

	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

119 #undeà
__USE_ISOC11


120 #undeà
__USE_ISOC99


121 #undeà
__USE_ISOC95


122 #undeà
__USE_ISOCXX11


123 #undeà
__USE_POSIX


124 #undeà
__USE_POSIX2


125 #undeà
__USE_POSIX199309


126 #undeà
__USE_POSIX199506


127 #undeà
__USE_XOPEN


128 #undeà
__USE_XOPEN_EXTENDED


129 #undeà
__USE_UNIX98


130 #undeà
__USE_XOPEN2K


131 #undeà
__USE_XOPEN2KXSI


132 #undeà
__USE_XOPEN2K8


133 #undeà
__USE_XOPEN2K8XSI


134 #undeà
__USE_LARGEFILE


135 #undeà
__USE_LARGEFILE64


136 #undeà
__USE_FILE_OFFSET64


137 #undeà
__USE_MISC


138 #undeà
__USE_ATFILE


139 #undeà
__USE_GNU


140 #undeà
__USE_FORTIFY_LEVEL


141 #undeà
__KERNEL_STRICT_NAMES


142 #undeà
__GLIBC_USE_DEPRECATED_GETS


146 #iâdeà
_LOOSE_KERNEL_NAMES


147 
	#__KERNEL_STRICT_NAMES


	)

157 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


158 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

159 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

161 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

168 #ià
defšed
 
__şªg_majÜ__
 && defšed 
__şªg_mšÜ__


169 
	#__glibc_şªg_´”eq
(
maj
, 
mš
) \

170 ((
__şªg_majÜ__
 << 16è+ 
__şªg_mšÜ__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

172 
	#__glibc_şªg_´”eq
(
maj
, 
mš
è0

	)

176 
	#__GLIBC_USE
(
F
è
__GLIBC_USE_
 ## 
	)
F

182 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

183 && !
defšed
 
	g_DEFAULT_SOURCE


185 #undeà
_DEFAULT_SOURCE


186 
	#_DEFAULT_SOURCE
 1

	)

190 #ifdeà
_GNU_SOURCE


191 #undeà
_ISOC95_SOURCE


192 
	#_ISOC95_SOURCE
 1

	)

193 #undeà
_ISOC99_SOURCE


194 
	#_ISOC99_SOURCE
 1

	)

195 #undeà
_ISOC11_SOURCE


196 
	#_ISOC11_SOURCE
 1

	)

197 #undeà
_POSIX_SOURCE


198 
	#_POSIX_SOURCE
 1

	)

199 #undeà
_POSIX_C_SOURCE


200 
	#_POSIX_C_SOURCE
 200809L

	)

201 #undeà
_XOPEN_SOURCE


202 
	#_XOPEN_SOURCE
 700

	)

203 #undeà
_XOPEN_SOURCE_EXTENDED


204 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

205 #undeà
_LARGEFILE64_SOURCE


206 
	#_LARGEFILE64_SOURCE
 1

	)

207 #undeà
_DEFAULT_SOURCE


208 
	#_DEFAULT_SOURCE
 1

	)

209 #undeà
_ATFILE_SOURCE


210 
	#_ATFILE_SOURCE
 1

	)

215 #ià(
defšed
 
_DEFAULT_SOURCE
 \

216 || (!
defšed
 
	g__STRICT_ANSI__
 \

217 && !
defšed
 
	g_ISOC99_SOURCE
 \

218 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

219 && !
defšed
 
	g_XOPEN_SOURCE
))

220 #undeà
_DEFAULT_SOURCE


221 
	#_DEFAULT_SOURCE
 1

	)

225 #ià(
defšed
 
_ISOC11_SOURCE
 \

226 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

227 
	#__USE_ISOC11
 1

	)

231 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

232 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

233 
	#__USE_ISOC99
 1

	)

237 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

238 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

239 
	#__USE_ISOC95
 1

	)

242 #ifdeà
__ılu¥lus


244 #ià
__ılu¥lus
 >= 201703L

245 
	#__USE_ISOC11
 1

	)

249 #ià
__ılu¥lus
 >ğ201103L || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__


250 
	#__USE_ISOCXX11
 1

	)

251 
	#__USE_ISOC99
 1

	)

258 #ifdeà
_DEFAULT_SOURCE


259 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


260 
	#__USE_POSIX_IMPLICITLY
 1

	)

262 #undeà
_POSIX_SOURCE


263 
	#_POSIX_SOURCE
 1

	)

264 #undeà
_POSIX_C_SOURCE


265 
	#_POSIX_C_SOURCE
 200809L

	)

268 #ià((!
defšed
 
__STRICT_ANSI__
 \

269 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

270 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

271 
	#_POSIX_SOURCE
 1

	)

272 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

273 
	#_POSIX_C_SOURCE
 2

	)

274 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

275 
	#_POSIX_C_SOURCE
 199506L

	)

276 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

277 
	#_POSIX_C_SOURCE
 200112L

	)

279 
	#_POSIX_C_SOURCE
 200809L

	)

281 
	#__USE_POSIX_IMPLICITLY
 1

	)

290 #ià((!
defšed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

291 && (
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE
))

292 
	#_POSIX_SOURCE
 1

	)

293 #undeà
_POSIX_C_SOURCE


294 
	#_POSIX_C_SOURCE
 199506L

	)

297 #ià(
defšed
 
_POSIX_SOURCE
 \

298 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

299 || 
defšed
 
_XOPEN_SOURCE
)

300 
	#__USE_POSIX
 1

	)

303 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


304 
	#__USE_POSIX2
 1

	)

307 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

308 
	#__USE_POSIX199309
 1

	)

311 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

312 
	#__USE_POSIX199506
 1

	)

315 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

316 
	#__USE_XOPEN2K
 1

	)

317 #undeà
__USE_ISOC95


318 
	#__USE_ISOC95
 1

	)

319 #undeà
__USE_ISOC99


320 
	#__USE_ISOC99
 1

	)

323 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

324 
	#__USE_XOPEN2K8
 1

	)

325 #undeà
_ATFILE_SOURCE


326 
	#_ATFILE_SOURCE
 1

	)

329 #ifdef 
_XOPEN_SOURCE


330 
	#__USE_XOPEN
 1

	)

331 #ià(
_XOPEN_SOURCE
 - 0) >= 500

332 
	#__USE_XOPEN_EXTENDED
 1

	)

333 
	#__USE_UNIX98
 1

	)

334 #undeà
_LARGEFILE_SOURCE


335 
	#_LARGEFILE_SOURCE
 1

	)

336 #ià(
_XOPEN_SOURCE
 - 0) >= 600

337 #ià(
_XOPEN_SOURCE
 - 0) >= 700

338 
	#__USE_XOPEN2K8
 1

	)

339 
	#__USE_XOPEN2K8XSI
 1

	)

341 
	#__USE_XOPEN2K
 1

	)

342 
	#__USE_XOPEN2KXSI
 1

	)

343 #undeà
__USE_ISOC95


344 
	#__USE_ISOC95
 1

	)

345 #undeà
__USE_ISOC99


346 
	#__USE_ISOC99
 1

	)

349 #ifdeà
_XOPEN_SOURCE_EXTENDED


350 
	#__USE_XOPEN_EXTENDED
 1

	)

355 #ifdeà
_LARGEFILE_SOURCE


356 
	#__USE_LARGEFILE
 1

	)

359 #ifdeà
_LARGEFILE64_SOURCE


360 
	#__USE_LARGEFILE64
 1

	)

363 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

364 
	#__USE_FILE_OFFSET64
 1

	)

367 #ià
defšed
 
_DEFAULT_SOURCE


368 
	#__USE_MISC
 1

	)

371 #ifdef 
_ATFILE_SOURCE


372 
	#__USE_ATFILE
 1

	)

375 #ifdef 
_GNU_SOURCE


376 
	#__USE_GNU
 1

	)

379 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

380 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

381 #ià
_FORTIFY_SOURCE
 > 1

382 
	#__USE_FORTIFY_LEVEL
 2

	)

384 
	#__USE_FORTIFY_LEVEL
 1

	)

387 
	#__USE_FORTIFY_LEVEL
 0

	)

394 #ià
defšed
 
__ılu¥lus
 ? __ılu¥lu >ğ201402L : defšed 
__USE_ISOC11


395 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

397 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

402 
	~<¡dc-´edef.h
>

410 #undeà
__GNU_LIBRARY__


411 
	#__GNU_LIBRARY__
 6

	)

415 
	#__GLIBC__
 2

	)

416 
	#__GLIBC_MINOR__
 27

	)

418 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

419 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

422 #iâdeà
__ASSEMBLER__


423 #iâdeà
_SYS_CDEFS_H


424 
	~<sys/cdefs.h
>

429 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


430 
	#__USE_LARGEFILE
 1

	)

431 
	#__USE_LARGEFILE64
 1

	)

437 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

438 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

439 && 
defšed
 
	g__ex‹º_šlše


440 
	#__USE_EXTERN_INLINES
 1

	)

448 
	~<gnu/¡ubs.h
>

	@/usr/include/rpc/netdb.h

36 #iâdeà
_RPC_NETDB_H


37 
	#_RPC_NETDB_H
 1

	)

39 
	~<ã©u»s.h
>

41 
	#__Ãed_size_t


	)

42 
	~<¡ddef.h
>

44 
__BEGIN_DECLS


46 
	s½ûÁ


48 *
	mr_Çme
;

49 **
	mr_®Ÿ£s
;

50 
	mr_numb”
;

53 
	$£ŒpûÁ
 (
__¡ayİ’
è
__THROW
;

54 
	$’d½ûÁ
 (è
__THROW
;

55 
½ûÁ
 *
	$g‘½cbyÇme
 (cÚ¡ *
__Çme
è
__THROW
;

56 
½ûÁ
 *
	$g‘½cbynumb”
 (
__numb”
è
__THROW
;

57 
½ûÁ
 *
	$g‘½ûÁ
 (è
__THROW
;

59 #ifdeà
__USE_MISC


60 
	$g‘½cbyÇme_r
 (cÚ¡ *
__Çme
, 
½ûÁ
 *
__»suÉ_buf
,

61 *
__bufãr
, 
size_t
 
__buæ’
,

62 
½ûÁ
 **
__»suÉ
è
__THROW
;

64 
	$g‘½cbynumb”_r
 (
__numb”
, 
½ûÁ
 *
__»suÉ_buf
,

65 *
__bufãr
, 
size_t
 
__buæ’
,

66 
½ûÁ
 **
__»suÉ
è
__THROW
;

68 
	$g‘½ûÁ_r
 (
½ûÁ
 *
__»suÉ_buf
, *
__bufãr
,

69 
size_t
 
__buæ’
, 
½ûÁ
 **
__»suÉ
è
__THROW
;

72 
__END_DECLS


	@/usr/include/sched.h

19 #iâdef 
_SCHED_H


20 
	#_SCHED_H
 1

	)

22 
	~<ã©u»s.h
>

25 
	~<b™s/ty³s.h
>

27 
	#__Ãed_size_t


	)

28 
	#__Ãed_NULL


	)

29 
	~<¡ddef.h
>

31 
	~<b™s/ty³s/time_t.h
>

32 
	~<b™s/ty³s/¡ruù_time¥ec.h
>

33 #iâdeà
__USE_XOPEN2K


34 
	~<time.h
>

37 #iâdeà
__pid_t_defšed


38 
__pid_t
 
	tpid_t
;

39 
	#__pid_t_defšed


	)

43 
	~<b™s/sched.h
>

44 
	~<b™s/ıu-£t.h
>

47 
	#sched_´iÜ™y
 
sched_´iÜ™y


	)

48 
	#__sched_´iÜ™y
 
sched_´iÜ™y


	)

51 
__BEGIN_DECLS


54 
	$sched_£¬am
 (
__pid_t
 
__pid
, cÚ¡ 
sched_·¿m
 *
__·¿m
)

55 
__THROW
;

58 
	$sched_g‘·¿m
 (
__pid_t
 
__pid
, 
sched_·¿m
 *
__·¿m
è
__THROW
;

61 
	$sched_£tscheduËr
 (
__pid_t
 
__pid
, 
__pŞicy
,

62 cÚ¡ 
sched_·¿m
 *
__·¿m
è
__THROW
;

65 
	$sched_g‘scheduËr
 (
__pid_t
 
__pid
è
__THROW
;

68 
	$sched_y›ld
 (è
__THROW
;

71 
	$sched_g‘_´iÜ™y_max
 (
__®gÜ™hm
è
__THROW
;

74 
	$sched_g‘_´iÜ™y_mš
 (
__®gÜ™hm
è
__THROW
;

77 
	$sched_¼_g‘_š‹rv®
 (
__pid_t
 
__pid
, 
time¥ec
 *
__t
è
__THROW
;

80 #ifdeà
__USE_GNU


82 
	#CPU_SETSIZE
 
__CPU_SETSIZE


	)

83 
	#CPU_SET
(
ıu
, 
ıu£
è
	`__CPU_SET_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

84 
	#CPU_CLR
(
ıu
, 
ıu£
è
	`__CPU_CLR_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

85 
	#CPU_ISSET
(
ıu
, 
ıu£
è
	`__CPU_ISSET_S
 (ıu,  (
ıu_£t_t
), \

86 
ıu£
)

	)

87 
	#CPU_ZERO
(
ıu£
è
	`__CPU_ZERO_S
 ( (
ıu_£t_t
), cpu£)

	)

88 
	#CPU_COUNT
(
ıu£
è
	`__CPU_COUNT_S
 ( (
ıu_£t_t
), cpu£)

	)

90 
	#CPU_SET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_SET_S
 (ıu, s‘size, cpu£)

	)

91 
	#CPU_CLR_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_CLR_S
 (ıu, s‘size, cpu£)

	)

92 
	#CPU_ISSET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_ISSET_S
 (cpu, setsize, \

93 
ıu£
)

	)

94 
	#CPU_ZERO_S
(
£tsize
, 
ıu£
è
	`__CPU_ZERO_S
 (£tsize, cpu£)

	)

95 
	#CPU_COUNT_S
(
£tsize
, 
ıu£
è
	`__CPU_COUNT_S
 (£tsize, cpu£)

	)

97 
	#CPU_EQUAL
(
ıu£1
, 
ıu£2
) \

98 
	`__CPU_EQUAL_S
 ( (
ıu_£t_t
), 
ıu£1
, 
ıu£2
)

	)

99 
	#CPU_EQUAL_S
(
£tsize
, 
ıu£1
, 
ıu£2
) \

100 
	`__CPU_EQUAL_S
 (
£tsize
, 
ıu£1
, 
ıu£2
)

	)

102 
	#CPU_AND
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

103 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

104 
	#CPU_OR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

105 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

106 
	#CPU_XOR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

107 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

108 
	#CPU_AND_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

109 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

110 
	#CPU_OR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

111 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

112 
	#CPU_XOR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

113 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

115 
	#CPU_ALLOC_SIZE
(
couÁ
è
	`__CPU_ALLOC_SIZE
 (couÁ)

	)

116 
	#CPU_ALLOC
(
couÁ
è
	`__CPU_ALLOC
 (couÁ)

	)

117 
	#CPU_FREE
(
ıu£t
è
	`__CPU_FREE
 (ıu£t)

	)

121 
	$sched_£ffš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

122 cÚ¡ 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

125 
	$sched_g‘affš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

126 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

129 
__END_DECLS


	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

58 
	#__STDC_ISO_10646__
 201706L

	)

61 
	#__STDC_NO_THREADS__
 1

	)

	@
1
.
1
/usr/include
272
6536
benchmark/DB_index.cc
benchmark/DB_index.hh
benchmark/DB_params.hh
benchmark/DB_profiler.hh
benchmark/DB_structs.hh
benchmark/MicroBenchmarks.cc
benchmark/MicroBenchmarks.hh
benchmark/Micro_structs.hh
benchmark/Predicate_bench.cc
benchmark/Predicate_bench.hh
benchmark/TPCC_bench.cc
benchmark/TPCC_bench.hh
benchmark/TPCC_selectors.hh
benchmark/TPCC_structs.hh
benchmark/TPCC_txns.hh
benchmark/TPCE_structs.hh
benchmark/Voter_bench.cc
benchmark/Voter_bench.hh
benchmark/Voter_data.cc
benchmark/Voter_structs.hh
benchmark/Voter_txns.hh
benchmark/Wikipedia_bench.cc
benchmark/Wikipedia_bench.hh
benchmark/Wikipedia_data.cc
benchmark/Wikipedia_loader.hh
benchmark/Wikipedia_selectors.hh
benchmark/Wikipedia_structs.hh
benchmark/Wikipedia_txns.hh
benchmark/YCSB_bench.cc
benchmark/YCSB_bench.hh
benchmark/YCSB_structs.hh
benchmark/YCSB_txns.hh
config.h
datatype/ART.hh
datatype/Box.hh
datatype/Debug_rcu.hh
datatype/Hashtable.hh
datatype/List.hh
datatype/List1.hh
datatype/PriorityQueue.hh
datatype/PriorityQueue1.hh
datatype/Queue.hh
datatype/RBTree.hh
datatype/RBTreeInternal.hh
datatype/SingleElem.hh
datatype/SwissTArray.hh
datatype/SwissTGeneric.hh
datatype/TART.hh
datatype/TArray.hh
datatype/TArrayAdaptive.hh
datatype/TArrayProxy.hh
datatype/TBox.hh
datatype/TCounter.hh
datatype/TFlexArray.hh
datatype/TGeneric.hh
datatype/TInt.hh
datatype/TIntPredicate.hh
datatype/TIntRange.hh
datatype/TVector.hh
datatype/TVector_nopred.hh
datatype/TransAlloc.hh
datatype/TransPessimisticLocking.hh
datatype/TransUndoable.hh
datatype/Vector.hh
datatype/print_value.hh
datatype/versioned_value.hh
legacy/Boosting.cc
legacy/Boosting_common.hh
legacy/Boosting_fastset.hh
legacy/Boosting_list.hh
legacy/Boosting_lockkey.hh
legacy/Boosting_locks.hh
legacy/Boosting_map.hh
legacy/Boosting_standalone.cc
legacy/Boosting_standalone.hh
legacy/Boosting_sto.hh
legacy/Boosting_tl2.hh
legacy/local_vector.hh
lib/PlatformFeatures.hh
lib/StringWrapper.hh
lib/SystemProfiler.hh
lib/clp.c
lib/clp.h
lib/compiler.hh
lib/randgen.hh
lib/sampling.hh
lib/simple_str.hh
lib/stuffed_str.hh
masstree-beta/btree_leaflink.hh
masstree-beta/checkpoint.cc
masstree-beta/checkpoint.hh
masstree-beta/circular_int.hh
masstree-beta/clp.c
masstree-beta/clp.h
masstree-beta/compiler.cc
masstree-beta/compiler.hh
masstree-beta/config.h
masstree-beta/file.cc
masstree-beta/file.hh
masstree-beta/hashcode.hh
masstree-beta/json.cc
masstree-beta/json.hh
masstree-beta/jsontest.cc
masstree-beta/kpermuter.hh
masstree-beta/ksearch.hh
masstree-beta/kvio.cc
masstree-beta/kvio.hh
masstree-beta/kvproto.hh
masstree-beta/kvrandom.cc
masstree-beta/kvrandom.hh
masstree-beta/kvrow.hh
masstree-beta/kvstats.hh
masstree-beta/kvtest.hh
masstree-beta/kvthread.cc
masstree-beta/kvthread.hh
masstree-beta/log.cc
masstree-beta/log.hh
masstree-beta/masstree.hh
masstree-beta/masstree_get.hh
masstree-beta/masstree_insert.hh
masstree-beta/masstree_key.hh
masstree-beta/masstree_print.hh
masstree-beta/masstree_remove.hh
masstree-beta/masstree_scan.hh
masstree-beta/masstree_split.hh
masstree-beta/masstree_stats.hh
masstree-beta/masstree_struct.hh
masstree-beta/masstree_tcursor.hh
masstree-beta/memdebug.cc
masstree-beta/memdebug.hh
masstree-beta/misc.cc
masstree-beta/misc.hh
masstree-beta/msgpack.cc
masstree-beta/msgpack.hh
masstree-beta/msgpacktest.cc
masstree-beta/mtclient.cc
masstree-beta/mtclient.hh
masstree-beta/mtcounters.hh
masstree-beta/mtd.cc
masstree-beta/mttest.cc
masstree-beta/nodeversion.hh
masstree-beta/perfstat.cc
masstree-beta/perfstat.hh
masstree-beta/query_masstree.cc
masstree-beta/query_masstree.hh
masstree-beta/scantest.cc
masstree-beta/small_vector.hh
masstree-beta/str.cc
masstree-beta/str.hh
masstree-beta/straccum.cc
masstree-beta/straccum.hh
masstree-beta/string.cc
masstree-beta/string.hh
masstree-beta/string_base.hh
masstree-beta/string_slice.cc
masstree-beta/string_slice.hh
masstree-beta/stringbag.hh
masstree-beta/test_atomics.cc
masstree-beta/test_string.cc
masstree-beta/testrunner.cc
masstree-beta/testrunner.hh
masstree-beta/timestamp.hh
masstree-beta/unit-mt.cc
masstree-beta/value_array.cc
masstree-beta/value_array.hh
masstree-beta/value_bag.hh
masstree-beta/value_string.cc
masstree-beta/value_string.hh
masstree-beta/value_versioned_array.cc
masstree-beta/value_versioned_array.hh
srandomdev.c
sto-core/ConcurrencyControl.hh
sto-core/ContentionManager.cc
sto-core/ContentionManager.hh
sto-core/EagerVersions.hh
sto-core/Interface.hh
sto-core/OCCVersions.hh
sto-core/Packer.cc
sto-core/Packer.hh
sto-core/Sto.hh
sto-core/TRcu.cc
sto-core/TRcu.hh
sto-core/TThread.hh
sto-core/TWrapped.hh
sto-core/Tagged64.hh
sto-core/TaggedLow.hh
sto-core/TicTocStructs.hh
sto-core/TicTocVersions.hh
sto-core/TransItem.hh
sto-core/TransScratch.hh
sto-core/Transaction.cc
sto-core/Transaction.hh
sto-core/VersionBase.hh
sto-core/VersionSelector.hh
sto-core/codegen/driver.cpp
sto-core/codegen/driver.hpp
sto-core/codegen/lexer.l
sto-core/codegen/main.cpp
sto-core/codegen/scanner.hpp
sto-core/timing.hh
test/IntStr.hh
test/Testers.hh
test/bench-tart.cc
test/concurrent.cc
test/concurrentqueue.cc
test/ex-counter.cc
test/hashtable_nostm.cc
test/ht_mt.cc
test/iterators.cc
test/list1.cc
test/pqVsIt.cc
test/pqueue.cc
test/predicates.cc
test/rbtree.cc
test/single.cc
test/singleelems.cc
test/trans_test.cc
test/unit-dboindex.cc
test/unit-masstree.cc
test/unit-mbta.cc
test/unit-opacity.cc
test/unit-rcu.cc
test/unit-sampling.cc
test/unit-swisstarray.cc
test/unit-swisstgeneric.cc
test/unit-tarray.cc
test/unit-tart-threads.hh
test/unit-tart.cc
test/unit-tbox.cc
test/unit-tcounter.cc
test/unit-tflexarray.cc
test/unit-tgeneric.cc
test/unit-tint.cc
test/unit-tintpredicate.cc
test/unit-tvector-nopred.cc
test/unit-tvector.cc
test/vector.cc
third-party/xxHash/xxhash.c
third-party/xxHash/xxhash.h
third-party/xxHash/xxhsum.c
/usr/include/arpa/inet.h
/usr/include/asm-generic/mman.h
/usr/include/assert.h
/usr/include/byteswap.h
/usr/include/ctype.h
/usr/include/dirent.h
/usr/include/errno.h
/usr/include/execinfo.h
/usr/include/fcntl.h
/usr/include/inttypes.h
/usr/include/limits.h
/usr/include/malloc.h
/usr/include/math.h
/usr/include/netdb.h
/usr/include/netinet/in.h
/usr/include/netinet/tcp.h
/usr/include/pthread.h
/usr/include/signal.h
/usr/include/stdint.h
/usr/include/stdio.h
/usr/include/stdlib.h
/usr/include/string.h
/usr/include/strings.h
/usr/include/time.h
/usr/include/unistd.h
/usr/include/alloca.h
/usr/include/asm-generic/mman-common.h
/usr/include/endian.h
/usr/include/features.h
/usr/include/rpc/netdb.h
/usr/include/sched.h
/usr/include/stdc-predef.h
